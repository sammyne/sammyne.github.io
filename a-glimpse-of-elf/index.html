<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>学点 ELF | sammyne</title>
    <meta name="generator" content="VuePress 1.9.9">
    <link rel="icon" href="/favicon.ico">
    <meta name="description" content="Just playing around :)">
    <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no">
    
    <link rel="preload" href="/assets/css/0.styles.00c90c45.css" as="style"><link rel="preload" href="/assets/js/app.2124bf24.js" as="script"><link rel="preload" href="/assets/js/3.944fac0d.js" as="script"><link rel="preload" href="/assets/js/1.c30a1333.js" as="script"><link rel="preload" href="/assets/js/55.674ca41a.js" as="script"><link rel="prefetch" href="/assets/js/10.6feb556b.js"><link rel="prefetch" href="/assets/js/11.d238b802.js"><link rel="prefetch" href="/assets/js/12.92a89c73.js"><link rel="prefetch" href="/assets/js/13.05851956.js"><link rel="prefetch" href="/assets/js/14.34744b6c.js"><link rel="prefetch" href="/assets/js/15.fd1f282f.js"><link rel="prefetch" href="/assets/js/16.338c7efe.js"><link rel="prefetch" href="/assets/js/17.dd7e0805.js"><link rel="prefetch" href="/assets/js/18.7e4af78d.js"><link rel="prefetch" href="/assets/js/19.96894619.js"><link rel="prefetch" href="/assets/js/20.3d3adc8f.js"><link rel="prefetch" href="/assets/js/21.669510d2.js"><link rel="prefetch" href="/assets/js/22.4997fa99.js"><link rel="prefetch" href="/assets/js/23.88d0f3d2.js"><link rel="prefetch" href="/assets/js/24.688b92a8.js"><link rel="prefetch" href="/assets/js/25.42a3079a.js"><link rel="prefetch" href="/assets/js/26.6b1973cc.js"><link rel="prefetch" href="/assets/js/27.e2133f18.js"><link rel="prefetch" href="/assets/js/28.4850156d.js"><link rel="prefetch" href="/assets/js/29.f6cf5316.js"><link rel="prefetch" href="/assets/js/30.824ebab1.js"><link rel="prefetch" href="/assets/js/31.d5cda852.js"><link rel="prefetch" href="/assets/js/32.5d223b08.js"><link rel="prefetch" href="/assets/js/33.9c398239.js"><link rel="prefetch" href="/assets/js/34.1cfaa2c4.js"><link rel="prefetch" href="/assets/js/35.69f5a7fc.js"><link rel="prefetch" href="/assets/js/36.a3ad36a5.js"><link rel="prefetch" href="/assets/js/37.71d0640c.js"><link rel="prefetch" href="/assets/js/38.8e4b00cc.js"><link rel="prefetch" href="/assets/js/39.ff2dfcd8.js"><link rel="prefetch" href="/assets/js/4.908240c5.js"><link rel="prefetch" href="/assets/js/40.3262bce0.js"><link rel="prefetch" href="/assets/js/41.5eb1f517.js"><link rel="prefetch" href="/assets/js/42.efbc331e.js"><link rel="prefetch" href="/assets/js/43.d10817f1.js"><link rel="prefetch" href="/assets/js/44.5f29d6a5.js"><link rel="prefetch" href="/assets/js/45.19bf538d.js"><link rel="prefetch" href="/assets/js/46.caa3e673.js"><link rel="prefetch" href="/assets/js/47.02d2bfdd.js"><link rel="prefetch" href="/assets/js/48.8f6cdcc5.js"><link rel="prefetch" href="/assets/js/49.8874e137.js"><link rel="prefetch" href="/assets/js/5.6b0f5eca.js"><link rel="prefetch" href="/assets/js/50.c2d9cf07.js"><link rel="prefetch" href="/assets/js/51.83db0769.js"><link rel="prefetch" href="/assets/js/52.f81f5392.js"><link rel="prefetch" href="/assets/js/53.b04b70d0.js"><link rel="prefetch" href="/assets/js/54.07971080.js"><link rel="prefetch" href="/assets/js/56.862cae6b.js"><link rel="prefetch" href="/assets/js/57.3d3d7cc9.js"><link rel="prefetch" href="/assets/js/58.98ebbb9c.js"><link rel="prefetch" href="/assets/js/59.4081edac.js"><link rel="prefetch" href="/assets/js/6.81d9e9a0.js"><link rel="prefetch" href="/assets/js/60.42a820f4.js"><link rel="prefetch" href="/assets/js/61.a52bc06d.js"><link rel="prefetch" href="/assets/js/62.18da62d1.js"><link rel="prefetch" href="/assets/js/63.52f6533c.js"><link rel="prefetch" href="/assets/js/64.03c12890.js"><link rel="prefetch" href="/assets/js/65.ccfd6c32.js"><link rel="prefetch" href="/assets/js/66.a0c38aa4.js"><link rel="prefetch" href="/assets/js/67.a30f375b.js"><link rel="prefetch" href="/assets/js/68.8248dd23.js"><link rel="prefetch" href="/assets/js/69.123686ed.js"><link rel="prefetch" href="/assets/js/7.18067abc.js"><link rel="prefetch" href="/assets/js/70.a647f8ad.js"><link rel="prefetch" href="/assets/js/71.02a394bf.js"><link rel="prefetch" href="/assets/js/72.2b1e35e2.js"><link rel="prefetch" href="/assets/js/73.afa2fc7a.js"><link rel="prefetch" href="/assets/js/74.7a30b68a.js"><link rel="prefetch" href="/assets/js/75.cddbdc6c.js"><link rel="prefetch" href="/assets/js/76.7b929319.js"><link rel="prefetch" href="/assets/js/77.87e8820d.js"><link rel="prefetch" href="/assets/js/78.c68f804b.js"><link rel="prefetch" href="/assets/js/79.8b9d1881.js"><link rel="prefetch" href="/assets/js/8.8be62fa8.js"><link rel="prefetch" href="/assets/js/80.e0641939.js"><link rel="prefetch" href="/assets/js/81.2bf032f3.js"><link rel="prefetch" href="/assets/js/82.fc2e2dc0.js"><link rel="prefetch" href="/assets/js/83.eab5c475.js"><link rel="prefetch" href="/assets/js/84.48d98958.js"><link rel="prefetch" href="/assets/js/85.17986848.js"><link rel="prefetch" href="/assets/js/86.32c9a409.js"><link rel="prefetch" href="/assets/js/87.28193f1a.js"><link rel="prefetch" href="/assets/js/88.7ef5e0f3.js"><link rel="prefetch" href="/assets/js/89.e3126a19.js"><link rel="prefetch" href="/assets/js/9.49555849.js"><link rel="prefetch" href="/assets/js/90.569bbf88.js">
    <link rel="stylesheet" href="/assets/css/0.styles.00c90c45.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container no-sidebar" data-v-7dd95ae2><div data-v-7dd95ae2><div class="password-shadow password-wrapper-out" style="display:none;" data-v-59e6cb88 data-v-7dd95ae2 data-v-7dd95ae2><h3 class="title" data-v-59e6cb88>sammyne</h3> <p class="description" data-v-59e6cb88>Just playing around :)</p> <label id="box" class="inputBox" data-v-59e6cb88><input type="password" value="" data-v-59e6cb88> <span data-v-59e6cb88>Konck! Knock!</span> <button data-v-59e6cb88>OK</button></label> <div class="footer" data-v-59e6cb88><span data-v-59e6cb88><i class="iconfont reco-theme" data-v-59e6cb88></i> <a target="blank" href="https://vuepress-theme-reco.recoluan.com" data-v-59e6cb88>vuePress-theme-reco</a></span> <span data-v-59e6cb88><i class="iconfont reco-copyright" data-v-59e6cb88></i> <a data-v-59e6cb88><span data-v-59e6cb88>sammyne</span>
          
        <span data-v-59e6cb88>2020 - </span>
        2023
      </a></span></div></div> <div class="hide" data-v-7dd95ae2><header class="navbar" data-v-7dd95ae2><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/logo.svg" alt="sammyne" class="logo"> <span class="site-name">sammyne</span></a> <div class="links"><div class="color-picker"><a class="color-button"><i class="iconfont reco-color"></i></a> <div class="color-picker-menu" style="display:none;"><div class="mode-options"><h4 class="title">Choose mode</h4> <ul class="color-mode-options"><li class="dark">dark</li><li class="auto active">auto</li><li class="light">light</li></ul></div></div></div> <div class="search-box"><i class="iconfont reco-search"></i> <input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link"><i class="iconfont reco-home"></i>
  首页
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-category"></i>
      分类
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/categories/os/" class="nav-link"><i class="undefined"></i>
  os
</a></li><li class="dropdown-item"><!----> <a href="/categories/dev/" class="nav-link"><i class="undefined"></i>
  dev
</a></li><li class="dropdown-item"><!----> <a href="/categories/crypto/" class="nav-link"><i class="undefined"></i>
  crypto
</a></li><li class="dropdown-item"><!----> <a href="/categories/programming/" class="nav-link"><i class="undefined"></i>
  programming
</a></li><li class="dropdown-item"><!----> <a href="/categories/tee/" class="nav-link"><i class="undefined"></i>
  tee
</a></li><li class="dropdown-item"><!----> <a href="/categories/engineering/" class="nav-link"><i class="undefined"></i>
  engineering
</a></li><li class="dropdown-item"><!----> <a href="/categories/language/" class="nav-link"><i class="undefined"></i>
  language
</a></li><li class="dropdown-item"><!----> <a href="/categories/tool/" class="nav-link"><i class="undefined"></i>
  tool
</a></li><li class="dropdown-item"><!----> <a href="/categories/architecture/" class="nav-link"><i class="undefined"></i>
  architecture
</a></li><li class="dropdown-item"><!----> <a href="/categories/decentralization/" class="nav-link"><i class="undefined"></i>
  decentralization
</a></li><li class="dropdown-item"><!----> <a href="/categories/network/" class="nav-link"><i class="undefined"></i>
  network
</a></li><li class="dropdown-item"><!----> <a href="/categories/software engineering/" class="nav-link"><i class="undefined"></i>
  software engineering
</a></li><li class="dropdown-item"><!----> <a href="/categories/notes/" class="nav-link"><i class="undefined"></i>
  notes
</a></li></ul></div></div><div class="nav-item"><a href="/tag/" class="nav-link"><i class="iconfont reco-tag"></i>
  标签
</a></div><div class="nav-item"><a href="/timeline/" class="nav-link"><i class="iconfont reco-date"></i>
  时间轴
</a></div><div class="nav-item"><a href="https://github.com/sammyne" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="iconfont reco-github"></i>
  Github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav></div></header> <div class="sidebar-mask" data-v-7dd95ae2></div> <aside class="sidebar" data-v-7dd95ae2><div class="personal-info-wrapper" data-v-1fad0c41 data-v-7dd95ae2><img src="/avatar.png" alt="author-avatar" class="personal-img" data-v-1fad0c41> <h3 class="name" data-v-1fad0c41>
    sammyne
  </h3> <div class="num" data-v-1fad0c41><div data-v-1fad0c41><h3 data-v-1fad0c41>80</h3> <h6 data-v-1fad0c41>Articles</h6></div> <div data-v-1fad0c41><h3 data-v-1fad0c41>43</h3> <h6 data-v-1fad0c41>Tags</h6></div></div> <ul class="social-links" data-v-1fad0c41></ul> <hr data-v-1fad0c41></div> <nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link"><i class="iconfont reco-home"></i>
  首页
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-category"></i>
      分类
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/categories/os/" class="nav-link"><i class="undefined"></i>
  os
</a></li><li class="dropdown-item"><!----> <a href="/categories/dev/" class="nav-link"><i class="undefined"></i>
  dev
</a></li><li class="dropdown-item"><!----> <a href="/categories/crypto/" class="nav-link"><i class="undefined"></i>
  crypto
</a></li><li class="dropdown-item"><!----> <a href="/categories/programming/" class="nav-link"><i class="undefined"></i>
  programming
</a></li><li class="dropdown-item"><!----> <a href="/categories/tee/" class="nav-link"><i class="undefined"></i>
  tee
</a></li><li class="dropdown-item"><!----> <a href="/categories/engineering/" class="nav-link"><i class="undefined"></i>
  engineering
</a></li><li class="dropdown-item"><!----> <a href="/categories/language/" class="nav-link"><i class="undefined"></i>
  language
</a></li><li class="dropdown-item"><!----> <a href="/categories/tool/" class="nav-link"><i class="undefined"></i>
  tool
</a></li><li class="dropdown-item"><!----> <a href="/categories/architecture/" class="nav-link"><i class="undefined"></i>
  architecture
</a></li><li class="dropdown-item"><!----> <a href="/categories/decentralization/" class="nav-link"><i class="undefined"></i>
  decentralization
</a></li><li class="dropdown-item"><!----> <a href="/categories/network/" class="nav-link"><i class="undefined"></i>
  network
</a></li><li class="dropdown-item"><!----> <a href="/categories/software engineering/" class="nav-link"><i class="undefined"></i>
  software engineering
</a></li><li class="dropdown-item"><!----> <a href="/categories/notes/" class="nav-link"><i class="undefined"></i>
  notes
</a></li></ul></div></div><div class="nav-item"><a href="/tag/" class="nav-link"><i class="iconfont reco-tag"></i>
  标签
</a></div><div class="nav-item"><a href="/timeline/" class="nav-link"><i class="iconfont reco-date"></i>
  时间轴
</a></div><div class="nav-item"><a href="https://github.com/sammyne" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="iconfont reco-github"></i>
  Github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav> <!----> </aside> <div class="password-shadow password-wrapper-in" style="display:none;" data-v-59e6cb88 data-v-7dd95ae2><h3 class="title" data-v-59e6cb88>学点 ELF</h3> <!----> <label id="box" class="inputBox" data-v-59e6cb88><input type="password" value="" data-v-59e6cb88> <span data-v-59e6cb88>Konck! Knock!</span> <button data-v-59e6cb88>OK</button></label> <div class="footer" data-v-59e6cb88><span data-v-59e6cb88><i class="iconfont reco-theme" data-v-59e6cb88></i> <a target="blank" href="https://vuepress-theme-reco.recoluan.com" data-v-59e6cb88>vuePress-theme-reco</a></span> <span data-v-59e6cb88><i class="iconfont reco-copyright" data-v-59e6cb88></i> <a data-v-59e6cb88><span data-v-59e6cb88>sammyne</span>
          
        <span data-v-59e6cb88>2020 - </span>
        2023
      </a></span></div></div> <div data-v-7dd95ae2><div data-v-7dd95ae2><main class="page"><section style="display:;"><div class="page-title"><h1 class="title">学点 ELF</h1> <div data-v-8a445198><i class="iconfont reco-account" data-v-8a445198><span data-v-8a445198>sammyne</span></i> <i class="iconfont reco-date" data-v-8a445198><span data-v-8a445198>7/24/2021</span></i> <i class="iconfont reco-eye" data-v-8a445198><span id="/a-glimpse-of-elf/" data-flag-title="Your Article Title" class="leancloud-visitors" data-v-8a445198><a class="leancloud-visitors-count" style="font-size:.9rem;font-weight:normal;color:#999;"></a></span></i> <i class="tags iconfont reco-tag" data-v-8a445198><span class="tag-item" data-v-8a445198>linux</span><span class="tag-item" data-v-8a445198>compiler</span></i></div></div> <div class="theme-reco-content content__default"><h2 id="初次见面"><a href="#初次见面" class="header-anchor">#</a> 初次见面</h2> <p>ELF 全称叫 Executable and Linkable Format。经常在 Linux 系统开发的小伙伴们应该熟悉 ELF，特别是那些需要了解编译和链接的大神。</p> <p>本文介绍 Linux 系统编译、链接的基石--ELF 文件。了解这些知识有助于后继续学习编译、链接的底层过程，以及掌握可执行程序在从硬盘加载到内存、一直到 <code>main</code> 函数的执行的细节。掌握 ELF 文件的结构和内容是理解编译、链接和程序执行的基础。</p> <p>文件需要遵守一定的格式，ELF 也不例外。从宏观上看，ELF 可拆卸成以下四个部分：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>+----------------------+
|       ELF header     |  ELF 头部
+----------------------+
| Program header table |  程序头表
+----------------------+
|       Sections       |  节
+----------------------+
| Section Header table |  节头表
+----------------------+
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>暂时不理解上图的几个概念也没关系，后续部分会逐一说明。</p> <p>在 Linux 系统中，ELF 文件主要用来表示以下 3 种类型的文件：</p> <ul><li>可执行文件</li> <li>目标文件（<code>.o</code>）</li> <li>共享库文件（<code>.so</code>）</li></ul> <p>3 种类型的文件区分通过 ELF 头部的一个字段实现，各自的使用场景分别为：</p> <ul><li>可执行文件：被操作系统的加载器从硬盘读取，载入到内存去执行</li> <li>目标文件：被链接器读取，用来产生可执行文件或者共享库文件</li> <li>共享库文件：在动态链接的时候，由 ld-linux.so 读取</li></ul> <p>以链接器和加载器为例，两者看待 ELF 文件的姿势是不一样的。</p> <p>链接器只看到以下 3 部分内容：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>+----------------------+
|       ELF header     |  ELF 头部
+----------------------+
|          N/A         |  看不到
+----------------------+
|       Sections       |  节
+----------------------+
| Section Header table |  节头表
+----------------------+
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>也就是说，链接器只关心 <strong>ELF 头部</strong>（ELF header）, <strong>节</strong>（Sections） 以及<strong>节头表</strong>（Section header table） 这 3 部分内容。</p> <p>加载器则看到另外 3 部分内容：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>+----------------------+
|       ELF header     |  ELF 头部
+----------------------+
| Program header table |  程序头表
+----------------------+
|       Sections       |  节
+----------------------+
|        N/A           |  看不到
+----------------------+
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>加载器只关心 <strong>ELF 头部</strong>, <strong>程序头表</strong>（Program header table）和 <strong>节</strong> 这 3 部分内容。加载器又把中间部分的节叫做<strong>段</strong>（Segments）。可以理解为：一个段可能包含一个或者多个节，就像下面这样：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>          +----------------------+
          |       ELF header     |
          +----------------------+
+---------+ Program header table |              // 加载器看到一个 Segment
|         +----------------------+
|         | +------------------+ |
|    +------+     .text        +&lt;----------+
+---&gt;+    | +------------------+ |         |
     |    | +------------------+ |         |
     +------+     .rodata      +&lt;----------+
          | +------------------+ |         |
          | +------------------+ |         |
          | |     .data        | |         |
          | +------------------+ |         |
          | +------------------+ |         |
          | |     .bss         | |         |
          | +------------------+ |         |
          +----------------------+         |
          | Section Header table +---------+   // 连接器看到两个 Sections
          +----------------------+
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br></div></div><p>这就好比超市里的货架摆放的商品：有矿泉水、可乐、啤酒、巧克力、牛肉干、薯片。从理货员的角度看：它们属于 6 种不同的商品；但是从超市经理的角度看，它们只属于 2 类商品：饮料和零食。</p> <p>其实只要掌握到 2 点内容就可以了：</p> <ul><li>一个 ELF 文件由 4 个部分组成</li> <li>链接器和加载器使用 ELF 时，只会使用各自感兴趣的部分</li></ul> <h2 id="linux-系统描述-elf-的数据结构"><a href="#linux-系统描述-elf-的数据结构" class="header-anchor">#</a> Linux 系统描述 ELF 的数据结构</h2> <p>以下结构均源自文件 <a href="https://man7.org/linux/man-pages/man5/elf.5.html" target="_blank" rel="noopener noreferrer">elf(5) — linux manual page<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>。</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">EI_NIDENT</span> <span class="token expression"><span class="token number">16</span></span></span>

<span class="token comment">// ELF header</span>
<span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token punctuation">{</span>
  <span class="token keyword">unsigned</span> <span class="token keyword">char</span> e_ident<span class="token punctuation">[</span>EI_NIDENT<span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token class-name">uint16_t</span>      e_type<span class="token punctuation">;</span>
  <span class="token class-name">uint16_t</span>      e_machine<span class="token punctuation">;</span>
  <span class="token class-name">uint32_t</span>      e_version<span class="token punctuation">;</span>
  Elf64_Addr    e_entry<span class="token punctuation">;</span>
  Elf64_Off     e_phoff<span class="token punctuation">;</span>
  Elf64_Off     e_shoff<span class="token punctuation">;</span>
  <span class="token class-name">uint32_t</span>      e_flags<span class="token punctuation">;</span>
  <span class="token class-name">uint16_t</span>      e_ehsize<span class="token punctuation">;</span>
  <span class="token class-name">uint16_t</span>      e_phentsize<span class="token punctuation">;</span>
  <span class="token class-name">uint16_t</span>      e_phnum<span class="token punctuation">;</span>
  <span class="token class-name">uint16_t</span>      e_shentsize<span class="token punctuation">;</span>
  <span class="token class-name">uint16_t</span>      e_shnum<span class="token punctuation">;</span>
  <span class="token class-name">uint16_t</span>      e_shstrndx<span class="token punctuation">;</span>
<span class="token punctuation">}</span> Elf64_Ehdr<span class="token punctuation">;</span>

<span class="token comment">// Program header table</span>
<span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token punctuation">{</span>
  <span class="token class-name">uint32_t</span>   p_type<span class="token punctuation">;</span>
  <span class="token class-name">uint32_t</span>   p_flags<span class="token punctuation">;</span>
  Elf64_Off  p_offset<span class="token punctuation">;</span>
  Elf64_Addr p_vaddr<span class="token punctuation">;</span>
  Elf64_Addr p_paddr<span class="token punctuation">;</span>
  <span class="token class-name">uint64_t</span>   p_filesz<span class="token punctuation">;</span>
  <span class="token class-name">uint64_t</span>   p_memsz<span class="token punctuation">;</span>
  <span class="token class-name">uint64_t</span>   p_align<span class="token punctuation">;</span>
<span class="token punctuation">}</span> Elf64_Phdr<span class="token punctuation">;</span>

<span class="token comment">// Section header table</span>
<span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token punctuation">{</span>
  <span class="token class-name">uint32_t</span>   sh_name<span class="token punctuation">;</span>
  <span class="token class-name">uint32_t</span>   sh_type<span class="token punctuation">;</span>
  <span class="token class-name">uint64_t</span>   sh_flags<span class="token punctuation">;</span>
  Elf64_Addr sh_addr<span class="token punctuation">;</span>
  Elf64_Off  sh_offset<span class="token punctuation">;</span>
  <span class="token class-name">uint64_t</span>   sh_size<span class="token punctuation">;</span>
  <span class="token class-name">uint32_t</span>   sh_link<span class="token punctuation">;</span>
  <span class="token class-name">uint32_t</span>   sh_info<span class="token punctuation">;</span>
  <span class="token class-name">uint64_t</span>   sh_addralign<span class="token punctuation">;</span>
  <span class="token class-name">uint64_t</span>   sh_entsize<span class="token punctuation">;</span>
<span class="token punctuation">}</span> Elf64_Shdr<span class="token punctuation">;</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br></div></div><h2 id="elf-头部"><a href="#elf-头部" class="header-anchor">#</a> ELF 头部</h2> <p>ELF 头部相当于是一个总管，决定整个 ELF 文件内部的所有信息，比如：</p> <ul><li>标记这是 ELF 文件</li> <li>一些基本信息：版本，文件类型，机器类型</li> <li>程序头表的开始地址，在整个文件的什么地方</li> <li>节头表的开始地址，在整个文件的什么地方</li></ul> <p>到目前为止，好像没有说节（从链接器角度看）或者段（从加载器角度看）在 ELF 文件的什么地方。稍安勿躁，快到了~</p> <p>为了方便描述，后续部分把节和段全部统一称为节。</p> <p>其实是这样的：一个 ELF 文件存在很多个节，这些节的具体信息由程序头表或者节头表描述。</p> <p>以节头表为例：假如一个 ELF 文件共存在 4 个 Section--<code>.text</code>、<code>.rodata</code>、<code>.data</code> 和 <code>.bss</code>，那么 节头表将会有 4 个表项（Entry）分别描述这 4 节的具体信息（严格来说，除了 4 个表项外还存在一些其他辅助的节），就像下面这样：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>       +------------------------------+
       |       ELF header             |
       +------------------------------+
       |    Program header table      |
       +------------------------------+
       | +--------------------------+ |
       | |     .text                +&lt;--------+
       | +--------------------------+ |       |
       | +--------------------------+ |       |
       | |     .rodata              +&lt;----+   |
       | +--------------------------+ |   |   |
       | +--------------------------+ |   |   |
    +---&gt;+     .data                | |   |   |
    |  | +--------------------------+ |   |   |
    |  | +--------------------------+ |   |   |
+-------&gt;+     .bss                 | |   |   |
|   |  | +--------------------------+ |   |   |
|   |  +------------------------------+   |   |
|   |  | +--------------------------+ |   |   |
|   |  | | entry0: describe .text   +---------+
|   |  | +--------------------------+ |   |
|   |  | +--------------------------+ |   |
|   |  | | entry1: describe .rodata +-----+
|   |  | +--------------------------+ |
|   |  | +--------------------------+ |
|   +----+ entry2: describe .data   | |
|      | +--------------------------+ |
|      | +--------------------------+ |
+--------+ entry3: describe .bss    | |
       | +--------------------------+ |
       +------------------------------+
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br></div></div><h2 id="示例程序"><a href="#示例程序" class="header-anchor">#</a> 示例程序</h2> <p>为了加深理解，这里分析一个具体的代码示例，从字节码的粒度来解剖 ELF 文件结构。</p> <h3 id="环境"><a href="#环境" class="header-anchor">#</a> 环境</h3> <table><thead><tr><th style="text-align:right;">软件</th> <th style="text-align:left;">版本</th></tr></thead> <tbody><tr><td style="text-align:right;">ubuntu</td> <td style="text-align:left;">20.04</td></tr> <tr><td style="text-align:right;">gcc</td> <td style="text-align:left;">9.3.0</td></tr> <tr><td style="text-align:right;">make</td> <td style="text-align:left;">4.2.1</td></tr></tbody></table> <h3 id="演示"><a href="#演示" class="header-anchor">#</a> 演示</h3> <p>程序的功能比较简单：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>  源文件                 动态库文件
+----------+         +--------------+
| mymath.c +--------&gt;+ libmymath.so +---+
+----------+         +--------------+   |     +------+
                                        +----&gt;+ main |
+----------+         +--------------+   |     +------+
|  main.c  +--------&gt;+    main.o    +---+     可执行文件
+----------+         +--------------+
  源文件                 目标文件
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token comment">// mymath.c</span>
<span class="token keyword">int</span> <span class="token function">my_add</span><span class="token punctuation">(</span><span class="token keyword">int</span> a<span class="token punctuation">,</span> <span class="token keyword">int</span> b<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  <span class="token keyword">return</span> a <span class="token operator">+</span> b<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token comment">// main.c</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>

<span class="token keyword">extern</span> <span class="token keyword">int</span> <span class="token function">my_add</span><span class="token punctuation">(</span><span class="token keyword">int</span> a<span class="token punctuation">,</span> <span class="token keyword">int</span> b<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  <span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
  <span class="token keyword">int</span> j <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>
  <span class="token keyword">int</span> k <span class="token operator">=</span> <span class="token function">my_add</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> j<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;k = %d \n&quot;</span><span class="token punctuation">,</span> k<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><div class="language-makefile line-numbers-mode"><pre class="language-makefile"><code><span class="token comment"># makefile</span>

<span class="token builtin-target builtin">.PHONY</span><span class="token punctuation">:</span> all
<span class="token target symbol">all</span><span class="token punctuation">:</span> main libmymath.so

<span class="token target symbol">libmymath.so</span><span class="token punctuation">:</span> mymath.c
	gcc <span class="token variable">$&lt;</span> -fPIC -shared -o <span class="token variable">$@</span>

<span class="token target symbol">main.o</span><span class="token punctuation">:</span> main.c
	gcc -c <span class="token variable">$&lt;</span> -o <span class="token variable">$@</span>

<span class="token target symbol">main</span><span class="token punctuation">:</span> main.o libmymath.so
	gcc main.o -L. -lmymath -o <span class="token variable">$@</span>

<span class="token builtin-target builtin">.PHONY</span><span class="token punctuation">:</span> clean
<span class="token target symbol">clean</span><span class="token punctuation">:</span>
	rm *.o *.so main
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><p>由之前的描述可知：动态库文件 libmymath.so, 目标文件 main.o 和可执行文件 main 都是 ELF 文件，只不过属于不同的类型。</p> <p>接下来拆解一下可执行文件 main。首先编译生成可执行文件</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token function">make</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>然后用指令 <code>readelf -h main</code> 查看 main 文件的 ELF header 的信息。</p> <blockquote><p>readelf 是一个可以好好利用的工具。</p></blockquote> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>ELF Header:
  Magic:   7f <span class="token number">45</span> 4c <span class="token number">46</span> 02 01 01 00 00 00 00 00 00 00 00 00
  Class:                             ELF64
  Data:                              <span class="token number">2</span>'s complement, little endian
  Version:                           <span class="token number">1</span> <span class="token punctuation">(</span>current<span class="token punctuation">)</span>
  OS/ABI:                            UNIX - System V
  ABI Version:                       <span class="token number">0</span>
  Type:                              DYN <span class="token punctuation">(</span>Shared object <span class="token function">file</span><span class="token punctuation">)</span>
  Machine:                           Advanced Micro Devices X86-64
  Version:                           0x1
  Entry point address:               0x1080
  Start of program headers:          <span class="token number">64</span> <span class="token punctuation">(</span>bytes into <span class="token function">file</span><span class="token punctuation">)</span>
  Start of section headers:          <span class="token number">14744</span> <span class="token punctuation">(</span>bytes into <span class="token function">file</span><span class="token punctuation">)</span>
  Flags:                             0x0
  Size of this header:               <span class="token number">64</span> <span class="token punctuation">(</span>bytes<span class="token punctuation">)</span>
  Size of program headers:           <span class="token number">56</span> <span class="token punctuation">(</span>bytes<span class="token punctuation">)</span>
  Number of program headers:         <span class="token number">13</span>
  Size of section headers:           <span class="token number">64</span> <span class="token punctuation">(</span>bytes<span class="token punctuation">)</span>
  Number of section headers:         <span class="token number">31</span>
  Section header string table index: <span class="token number">30</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br></div></div><p>上图显示了 ELF 头部描述的所有内容。这个内容与结构体 <code>Elf64_Ehdr</code> 的成员变量是一一对应的！</p> <p>由图可知，第 15 行显示的内容：<code>Size of this header: 64 (bytes)</code>，表明 ELF header 部分的内容，一共是 64 字节。接下来我们看看开头的这 64 个字节码。</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>od <span class="token parameter variable">-Ax</span> <span class="token parameter variable">-t</span> x1 <span class="token parameter variable">-N</span> <span class="token number">64</span> main

000000 7f <span class="token number">45</span> 4c <span class="token number">46</span> 02 01 01 00 00 00 00 00 00 00 00 00
000010 03 00 3e 00 01 00 00 00 <span class="token number">80</span> <span class="token number">10</span> 00 00 00 00 00 00
000020 <span class="token number">40</span> 00 00 00 00 00 00 00 <span class="token number">98</span> <span class="token number">39</span> 00 00 00 00 00 00
000030 00 00 00 00 <span class="token number">40</span> 00 <span class="token number">38</span> 00 0d 00 <span class="token number">40</span> 00 1f 00 1e 00
000040
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>简单解释一下 <code>od</code> 工具的几个选项：</p> <table><thead><tr><th style="text-align:right;">选项</th> <th style="text-align:left;">说明</th></tr></thead> <tbody><tr><td style="text-align:right;"><code>-Ax</code></td> <td style="text-align:left;">显示地址的时候，用十六进制来表示。如果使用 <code>-Ad</code>，意思就是用十进制来显示地址</td></tr> <tr><td style="text-align:right;"><code>-t -x1</code></td> <td style="text-align:left;">显示字节码内容的时候，使用十六进制（<code>x</code>），每次显示一个字节（1）</td></tr> <tr><td style="text-align:right;"><code>-N 64</code></td> <td style="text-align:left;">只需要读取 64 个字节</td></tr></tbody></table> <p>这 64 字节的内容可以一一对应到结构体 <code>Elf64_Ehdr</code> 的每个字段。</p> <p>先看字段 <code>e_ident</code>,</p> <table><thead><tr><th>字节下标范围</th> <th>值</th> <th>说明</th></tr></thead> <tbody><tr><td>0</td> <td>0x7F</td> <td>文件标识，必须为 0x7F</td></tr> <tr><td>1-3</td> <td>0x45 4c 46</td> <td><code>ELF</code> 字符串对应的 ASCII 码</td></tr> <tr><td>4</td> <td>0x02</td> <td>文件类型，0 表示非法，1 表示 32 位，2 表示 64 位</td></tr> <tr><td>5</td> <td>0x01</td> <td>编码格式，0 表示非法，1 表示小端，2 表示大端</td></tr> <tr><td>6</td> <td>0x01</td> <td>文件版本，0 表示非法，1 表示当前</td></tr> <tr><td>7</td> <td>0x00</td> <td>标记对象的目标系统和 ABI，0 和 1 均表示 <code>UNIX System V ABI</code></td></tr> <tr><td>8</td> <td>0x00</td> <td>标记对象的目标 ABI 版本，具体解析方式依第 7 字节而定</td></tr> <tr><td>9-15</td> <td>0x00 00 00 00 00 00 00</td> <td>填充字节</td></tr></tbody></table> <p>详情参见 <a href="https://man7.org/linux/man-pages/man5/elf.5.html" target="_blank" rel="noopener noreferrer">官方文档<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>。</p> <p>关于大端、小端格式，这个 <code>main</code> 文件显示的是 1，代表小端格式。啥意思呢，看下面这张图就明白了：</p> <table><thead><tr><th>值</th> <th>低地址 0</th> <th>低地址 1</th> <th>低地址 2</th> <th>低地址 3</th></tr></thead> <tbody><tr><td>0x01</td> <td>0x01</td> <td></td> <td></td> <td></td></tr> <tr><td>0x0102</td> <td>0x02</td> <td>0x01</td> <td></td> <td></td></tr> <tr><td>0x010203</td> <td>0x03</td> <td>0x02</td> <td>0x01</td> <td></td></tr> <tr><td>0x01020304</td> <td>0x04</td> <td>0x03</td> <td>0x02</td> <td>0x01</td></tr></tbody></table> <p>那么再来看一下大端格式：</p> <table><thead><tr><th>值</th> <th>低地址 0</th> <th>低地址 1</th> <th>低地址 2</th> <th>低地址 3</th></tr></thead> <tbody><tr><td>0x01</td> <td>0x01</td> <td></td> <td></td> <td></td></tr> <tr><td>0x0102</td> <td>0x01</td> <td>0x02</td> <td></td> <td></td></tr> <tr><td>0x010203</td> <td>0x01</td> <td>0x02</td> <td>0x03</td> <td></td></tr> <tr><td>0x01020304</td> <td>0x01</td> <td>0x02</td> <td>0x03</td> <td>0x04</td></tr></tbody></table> <p>接下来继续把剩下的 48 字节（64 - 16 = 48），也以这样的字节码含义画出来：</p> <table><thead><tr><th>字段</th> <th>字节范围</th> <th>值</th> <th>说明</th></tr></thead> <tbody><tr><td>e_type</td> <td>16-17</td> <td>0x03 00</td> <td>3 表示共享对象文件，比 2 表示的可执行文件更加安全，因为多了 <a href="https://stackoverflow.com/questions/30555248/readelf-reports-program-is-a-shared-library-instead-of-executable" target="_blank" rel="noopener noreferrer">PIE<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></td></tr> <tr><td>e_machine</td> <td>18-19</td> <td>0x3e 00</td> <td>Advanced Micro Devices X86-64</td></tr> <tr><td>e_version</td> <td>20-23</td> <td>0x01 00 00 00</td> <td>1 表示非法版本，2 表示当前版本</td></tr> <tr><td>e_entry</td> <td>24-31</td> <td>0x80 10 00 00 00 00 00 00</td> <td>程序的入口地址</td></tr> <tr><td>e_phoff</td> <td>32-39</td> <td>0x40 00 00 00 00 00 00 00</td> <td>program header table 在 ELF 文件的偏移量。0x40=64 表示从第 64 字节开始就是程序头表</td></tr> <tr><td>e_shoff</td> <td>40-47</td> <td>0x98 39 00 00 00 00 00 00</td> <td>section header table 在 ELF 文件的偏移量。0x3998=14744 表示从第 14744 字节开始就是节头表</td></tr> <tr><td>e_flags</td> <td>48-51</td> <td>0x00 00 00 00</td> <td>处理器相关标识</td></tr> <tr><td>e_ehsize</td> <td>52-53</td> <td>0x40 00</td> <td>ELF 头部的字节数</td></tr> <tr><td>e_phentsize</td> <td>54-55</td> <td>0x38 00</td> <td>程序头表每个表项的字节长度为 0x38=56</td></tr> <tr><td>e_phnum</td> <td>56-57</td> <td>0x0d 00</td> <td>程序头表的表项总数为 0x0b=10</td></tr> <tr><td>e_shentsize</td> <td>58-59</td> <td>0x40 00</td> <td>节头表种每个表项的字节长度为 0x40=64</td></tr> <tr><td>e_shnum</td> <td>60-61</td> <td>0x1f 00</td> <td>节头表的表项总数为 0x1f=31</td></tr> <tr><td>e_shstrndx</td> <td>62-63</td> <td>0x1e 00</td> <td>字符串表项在节头表的索引为 0x1e=30</td></tr></tbody></table> <h3 id="字符串表项"><a href="#字符串表项" class="header-anchor">#</a> 字符串表项</h3> <p>在一个 ELF 文件中，存在很多字符串，例如：变量名、节名称、链接器加入的符号等等。这些字符串的长度都是不固定的，因此用一个固定的结构来表示这些字符串肯定是不现实的。于是，聪明的人类就想到：把这些字符串集中放在一起，作为一个独立的节管理。文件的其他地方如果想表示一个字符串，就在这个地方写一个数字索引：表示这个字符串位于字符串统一存储地方的某个偏移位置。经过这样的按图索骥，就可以找到具体的字符串了。</p> <p>比如说啊，下面这个空间中存储了所有的字符串：</p> <table><thead><tr><th>偏移</th> <th>00</th> <th>01</th> <th>02</th> <th>03</th> <th>04</th> <th>05</th> <th>06</th> <th>07</th> <th>08</th> <th>09</th> <th>10</th> <th>11</th> <th>12</th> <th>13</th> <th>14</th> <th>15</th></tr></thead> <tbody><tr><td>00</td> <td>\0</td> <td>.</td> <td>t</td> <td>e</td> <td>x</td> <td>t</td> <td>\0</td> <td>.</td> <td>d</td> <td>a</td> <td>t</td> <td>a</td> <td>\0</td> <td>h</td> <td>e</td> <td>l</td></tr> <tr><td>16</td> <td>l</td> <td>o</td> <td>,</td> <td>w</td> <td>o</td> <td>r</td> <td>l</td> <td>d</td> <td>!</td> <td>\0</td> <td>.</td> <td>r</td> <td>o</td> <td>d</td> <td>a</td> <td>t</td></tr> <tr><td>32</td> <td>a</td> <td>\0</td> <td>.</td> <td>b</td> <td>s</td> <td>s</td> <td>\0</td> <td></td> <td></td> <td></td> <td></td> <td></td> <td></td> <td></td> <td></td> <td></td></tr></tbody></table> <p>在程序的其他地方，如果想引用字符串 <code>hello,world!</code>，那么就只需要在那个地方标明数字 13 就可以了，表示：这个字符串从偏移 13 个字节处开始。</p> <p>那么现在，咱们再回到这个 main 文件的字符串表，</p> <p>ELF 头的最后 2 个字节是 0x1e 0x00，对应结构体的成员 <code>e_shstrndx</code>，意思是这个 ELF 文件中，字符串表是一个普通的节，存储了 ELF 文件使用到的所有字符串。既然是一个节，那么节头表就一定有一个表项来描述它，那么是哪一个表项呢？这就是第 LE(0x1e00)=30 个表项。</p> <p>可以用指令 <code>readelf -S main</code> 来看一下这个 ELF 文件的所有节信息，可见其中第 30 个节描述的正是字符串表节</p> <div class="language-bash line-numbers-mode"><div class="highlight-lines"><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><div class="highlighted"> </div><div class="highlighted"> </div><br><br><br><br><br><br></div><pre class="language-bash"><code>There are <span class="token number">31</span> section headers, starting at offset 0x3998:

Section Headers:
  <span class="token punctuation">[</span>Nr<span class="token punctuation">]</span> Name              Type             Address           Offset
       Size              EntSize          Flags  Link  Info  Align
  <span class="token punctuation">[</span> <span class="token number">0</span><span class="token punctuation">]</span>                   NULL             0000000000000000  00000000
       0000000000000000  0000000000000000           <span class="token number">0</span>     <span class="token number">0</span>     <span class="token number">0</span>
  <span class="token punctuation">[</span> <span class="token number">1</span><span class="token punctuation">]</span> .interp           PROGBITS         0000000000000318  00000318
       000000000000001c  0000000000000000   A       <span class="token number">0</span>     <span class="token number">0</span>     <span class="token number">1</span>
  <span class="token punctuation">[</span> <span class="token number">2</span><span class="token punctuation">]</span> .note.gnu.propert NOTE             0000000000000338  00000338
       0000000000000020  0000000000000000   A       <span class="token number">0</span>     <span class="token number">0</span>     <span class="token number">8</span>
  <span class="token punctuation">[</span> <span class="token number">3</span><span class="token punctuation">]</span> .note.gnu.build-i NOTE             0000000000000358  00000358
       0000000000000024  0000000000000000   A       <span class="token number">0</span>     <span class="token number">0</span>     <span class="token number">4</span>
  <span class="token punctuation">[</span> <span class="token number">4</span><span class="token punctuation">]</span> .note.ABI-tag     NOTE             000000000000037c  0000037c
       0000000000000020  0000000000000000   A       <span class="token number">0</span>     <span class="token number">0</span>     <span class="token number">4</span>
  <span class="token punctuation">[</span> <span class="token number">5</span><span class="token punctuation">]</span> .gnu.hash         GNU_HASH         00000000000003a0  000003a0
       0000000000000024  0000000000000000   A       <span class="token number">6</span>     <span class="token number">0</span>     <span class="token number">8</span>
  <span class="token punctuation">[</span> <span class="token number">6</span><span class="token punctuation">]</span> .dynsym           DYNSYM           00000000000003c8  000003c8
       00000000000000c0  0000000000000018   A       <span class="token number">7</span>     <span class="token number">1</span>     <span class="token number">8</span>
  <span class="token punctuation">[</span> <span class="token number">7</span><span class="token punctuation">]</span> .dynstr           STRTAB           0000000000000488  00000488
       0000000000000098  0000000000000000   A       <span class="token number">0</span>     <span class="token number">0</span>     <span class="token number">1</span>
  <span class="token punctuation">[</span> <span class="token number">8</span><span class="token punctuation">]</span> .gnu.version      VERSYM           0000000000000520  00000520
       0000000000000010  0000000000000002   A       <span class="token number">6</span>     <span class="token number">0</span>     <span class="token number">2</span>
  <span class="token punctuation">[</span> <span class="token number">9</span><span class="token punctuation">]</span> .gnu.version_r    VERNEED          0000000000000530  00000530
       0000000000000020  0000000000000000   A       <span class="token number">7</span>     <span class="token number">1</span>     <span class="token number">8</span>
  <span class="token punctuation">[</span><span class="token number">10</span><span class="token punctuation">]</span> .rela.dyn         RELA             0000000000000550  00000550
       00000000000000c0  0000000000000018   A       <span class="token number">6</span>     <span class="token number">0</span>     <span class="token number">8</span>
  <span class="token punctuation">[</span><span class="token number">11</span><span class="token punctuation">]</span> .rela.plt         RELA             0000000000000610  00000610
       0000000000000030  0000000000000018  AI       <span class="token number">6</span>    <span class="token number">24</span>     <span class="token number">8</span>
  <span class="token punctuation">[</span><span class="token number">12</span><span class="token punctuation">]</span> .init             PROGBITS         0000000000001000  00001000
       000000000000001b  0000000000000000  AX       <span class="token number">0</span>     <span class="token number">0</span>     <span class="token number">4</span>
  <span class="token punctuation">[</span><span class="token number">13</span><span class="token punctuation">]</span> .plt              PROGBITS         0000000000001020  00001020
       0000000000000030  0000000000000010  AX       <span class="token number">0</span>     <span class="token number">0</span>     <span class="token number">16</span>
  <span class="token punctuation">[</span><span class="token number">14</span><span class="token punctuation">]</span> .plt.got          PROGBITS         0000000000001050  00001050
       0000000000000010  0000000000000010  AX       <span class="token number">0</span>     <span class="token number">0</span>     <span class="token number">16</span>
  <span class="token punctuation">[</span><span class="token number">15</span><span class="token punctuation">]</span> .plt.sec          PROGBITS         0000000000001060  00001060
       0000000000000020  0000000000000010  AX       <span class="token number">0</span>     <span class="token number">0</span>     <span class="token number">16</span>
  <span class="token punctuation">[</span><span class="token number">16</span><span class="token punctuation">]</span> .text             PROGBITS         0000000000001080  00001080
       00000000000001b5  0000000000000000  AX       <span class="token number">0</span>     <span class="token number">0</span>     <span class="token number">16</span>
  <span class="token punctuation">[</span><span class="token number">17</span><span class="token punctuation">]</span> .fini             PROGBITS         0000000000001238  00001238
       000000000000000d  0000000000000000  AX       <span class="token number">0</span>     <span class="token number">0</span>     <span class="token number">4</span>
  <span class="token punctuation">[</span><span class="token number">18</span><span class="token punctuation">]</span> .rodata           PROGBITS         0000000000002000  00002000
       000000000000000d  0000000000000000   A       <span class="token number">0</span>     <span class="token number">0</span>     <span class="token number">4</span>
  <span class="token punctuation">[</span><span class="token number">19</span><span class="token punctuation">]</span> .eh_frame_hdr     PROGBITS         0000000000002010  00002010
       0000000000000044  0000000000000000   A       <span class="token number">0</span>     <span class="token number">0</span>     <span class="token number">4</span>
  <span class="token punctuation">[</span><span class="token number">20</span><span class="token punctuation">]</span> .eh_frame         PROGBITS         0000000000002058  00002058
       0000000000000108  0000000000000000   A       <span class="token number">0</span>     <span class="token number">0</span>     <span class="token number">8</span>
  <span class="token punctuation">[</span><span class="token number">21</span><span class="token punctuation">]</span> .init_array       INIT_ARRAY       0000000000003da0  00002da0
       0000000000000008  0000000000000008  WA       <span class="token number">0</span>     <span class="token number">0</span>     <span class="token number">8</span>
  <span class="token punctuation">[</span><span class="token number">22</span><span class="token punctuation">]</span> .fini_array       FINI_ARRAY       0000000000003da8  00002da8
       0000000000000008  0000000000000008  WA       <span class="token number">0</span>     <span class="token number">0</span>     <span class="token number">8</span>
  <span class="token punctuation">[</span><span class="token number">23</span><span class="token punctuation">]</span> .dynamic          DYNAMIC          0000000000003db0  00002db0
       0000000000000200  0000000000000010  WA       <span class="token number">7</span>     <span class="token number">0</span>     <span class="token number">8</span>
  <span class="token punctuation">[</span><span class="token number">24</span><span class="token punctuation">]</span> .got              PROGBITS         0000000000003fb0  00002fb0
       0000000000000050  0000000000000008  WA       <span class="token number">0</span>     <span class="token number">0</span>     <span class="token number">8</span>
  <span class="token punctuation">[</span><span class="token number">25</span><span class="token punctuation">]</span> .data             PROGBITS         0000000000004000  00003000
       0000000000000010  0000000000000000  WA       <span class="token number">0</span>     <span class="token number">0</span>     <span class="token number">8</span>
  <span class="token punctuation">[</span><span class="token number">26</span><span class="token punctuation">]</span> .bss              NOBITS           0000000000004010  00003010
       0000000000000008  0000000000000000  WA       <span class="token number">0</span>     <span class="token number">0</span>     <span class="token number">1</span>
  <span class="token punctuation">[</span><span class="token number">27</span><span class="token punctuation">]</span> .comment          PROGBITS         0000000000000000  00003010
       000000000000002a  0000000000000001  MS       <span class="token number">0</span>     <span class="token number">0</span>     <span class="token number">1</span>
  <span class="token punctuation">[</span><span class="token number">28</span><span class="token punctuation">]</span> .symtab           SYMTAB           0000000000000000  00003040
       0000000000000630  0000000000000018          <span class="token number">29</span>    <span class="token number">46</span>     <span class="token number">8</span>
  <span class="token punctuation">[</span><span class="token number">29</span><span class="token punctuation">]</span> .strtab           STRTAB           0000000000000000  00003670
       000000000000020b  0000000000000000           <span class="token number">0</span>     <span class="token number">0</span>     <span class="token number">1</span>
  <span class="token punctuation">[</span><span class="token number">30</span><span class="token punctuation">]</span> .shstrtab         STRTAB           0000000000000000  0000387b
       000000000000011a  0000000000000000           <span class="token number">0</span>     <span class="token number">0</span>     <span class="token number">1</span>
Key to Flags:
  W <span class="token punctuation">(</span>write<span class="token punctuation">)</span>, A <span class="token punctuation">(</span>alloc<span class="token punctuation">)</span>, X <span class="token punctuation">(</span>execute<span class="token punctuation">)</span>, M <span class="token punctuation">(</span>merge<span class="token punctuation">)</span>, S <span class="token punctuation">(</span>strings<span class="token punctuation">)</span>, I <span class="token punctuation">(</span>info<span class="token punctuation">)</span>,
  L <span class="token punctuation">(</span>link order<span class="token punctuation">)</span>, O <span class="token punctuation">(</span>extra OS processing required<span class="token punctuation">)</span>, G <span class="token punctuation">(</span>group<span class="token punctuation">)</span>, T <span class="token punctuation">(</span>TLS<span class="token punctuation">)</span>,
  C <span class="token punctuation">(</span>compressed<span class="token punctuation">)</span>, x <span class="token punctuation">(</span>unknown<span class="token punctuation">)</span>, o <span class="token punctuation">(</span>OS specific<span class="token punctuation">)</span>, E <span class="token punctuation">(</span>exclude<span class="token punctuation">)</span>,
  l <span class="token punctuation">(</span>large<span class="token punctuation">)</span>, p <span class="token punctuation">(</span>processor specific<span class="token punctuation">)</span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br></div></div><p>可以看出来：这个节在 ELF 文件的偏移地址是 0x000387b，长度是 0x000000000000011a 字节。</p> <p>下面从 ELF 头部的二进制数据解析出这些信息。</p> <h3 id="读取字符串表节的内容"><a href="#读取字符串表节的内容" class="header-anchor">#</a> 读取字符串表节的内容</h3> <p>本节演示如何借助 ELF 头部提供的信息，把字符串表这个节给找出来，然后把它的字节码打印出来看看。</p> <p>要想打印字符串表节的内容，就必须知道这个节在 ELF 文件的偏移地址。而偏移地址可从节头表的第 30 个表项的描述信息获取。要想知道第 30 个表项的地址，就必须知道节头表在 ELF 文件的开始地址，以及每一个表项的大小。</p> <p>ELF 头部给出了最后这两个需求信息，因此可反推算出 <code>shstrtab</code> 的偏移地址。ELF 头部的第 32 到 35 字节内容是：14744=LE(0x9839000000000000)（注意这里的字节序，低位在前）表示的就是节头表在 ELF 文件的开始地址 <code>e_shoff</code> 位于 ELF 文件的第 14744 字节处。知道了开始地址，再来算一下第 30 个表项的地址。ELF 头部第 58-59 字节的内容是 0x4000，表示每个表项的长度 <code>e_shentsize</code> 是 LE(0x0040)=64 字节。</p> <div class="custom-block tip"><p class="title">温馨提示</p><p>这里的计算都是从 0 开始的，因此第 30 个表项的开始地址就是：14744 + 30 * 64 = 16664，也就是说描述字符串表这个节的表项位于 ELF 文件的 16664 字节的位置。</p></div><p>既然知道了这个表项的地址，那么就扒开来看一下其中的二进制内容：</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>od <span class="token parameter variable">-Ad</span> <span class="token parameter variable">-t</span> x1 <span class="token parameter variable">-j</span> <span class="token number">16664</span> <span class="token parameter variable">-N</span> <span class="token number">64</span> main

0016664 <span class="token number">11</span> 00 00 00 03 00 00 00 00 00 00 00 00 00 00 00
0016680 00 00 00 00 00 00 00 00 7b <span class="token number">38</span> 00 00 00 00 00 00
0016696 1a 01 00 00 00 00 00 00 00 00 00 00 00 00 00 00
0016712 01 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
0016728
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>其中的 <code>-j 16664</code> 选项，表示跳过前面的 16664 个字节，也就是从 main 这个 ELF 文件的 16664 字节处开始读取，一共读 64 字节。</p> <p>这 64 个字节的内容，就对应了 <code>Elf64_Shdr</code> 结构体的每个成员变量：</p> <div class="language-c line-numbers-mode"><div class="highlight-lines"><br><div class="highlighted"> </div><div class="highlighted"> </div><br><br><div class="highlighted"> </div><div class="highlighted"> </div><br><br><br><br><br><br></div><pre class="language-c"><code><span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token punctuation">{</span>
  <span class="token class-name">uint32_t</span>   sh_name<span class="token punctuation">;</span>
  <span class="token class-name">uint32_t</span>   sh_type<span class="token punctuation">;</span>
  <span class="token class-name">uint64_t</span>   sh_flags<span class="token punctuation">;</span>
  Elf64_Addr sh_addr<span class="token punctuation">;</span>
  Elf64_Off  sh_offset<span class="token punctuation">;</span>
  <span class="token class-name">uint64_t</span>   sh_size<span class="token punctuation">;</span>
  <span class="token class-name">uint32_t</span>   sh_link<span class="token punctuation">;</span>
  <span class="token class-name">uint32_t</span>   sh_info<span class="token punctuation">;</span>
  <span class="token class-name">uint64_t</span>   sh_addralign<span class="token punctuation">;</span>
  <span class="token class-name">uint64_t</span>   sh_entsize<span class="token punctuation">;</span>
<span class="token punctuation">}</span> Elf64_Shdr<span class="token punctuation">;</span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p>这里重点讲一下以下 4 个字段:</p> <table><thead><tr><th>字段</th> <th>值</th> <th>说明</th></tr></thead> <tbody><tr><td>sh_name</td> <td>0x11 00 00 00</td> <td>暂且按住不表，马上就解释到了</td></tr> <tr><td>sh_type</td> <td>0x03 00 00 00</td> <td>类型，3 表示这是一个字符串表</td></tr> <tr><td>sh_offset</td> <td>0x7b 38 00 00 00 00 00 00</td> <td>在 ELF 文件的偏移量。LE(0x7b38000000000000) = 14459，表示字符串表这个 Section 从 ELF 文件的 14459 字节处开始</td></tr> <tr><td>sh_size</td> <td>0x1a 01 00 00 00 00 00 00</td> <td>长度为 LE(0x1a01000000000000) = 282 字节</td></tr></tbody></table> <p>还记得刚才我们使用 readelf 工具，读取到字符串表 Section 在 ELF 文件中的偏移地址是 LE(0x7b38000000000000)，长度是 LE(0x1a01000000000000) 字节吗？与我们这里的推断所得完全一致！</p> <p>既然知道了字符串表这个节在 ELF 文件的偏移量以及长度，那么就可以把它的字节码内容读取出来看看了。</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>od <span class="token parameter variable">-Ad</span> <span class="token parameter variable">-t</span> c <span class="token parameter variable">-j</span> <span class="token number">14459</span> <span class="token parameter variable">-N</span> <span class="token number">282</span> main

0014459  <span class="token punctuation">\</span><span class="token number">0</span>   <span class="token builtin class-name">.</span>   s   y   m   t   a   b  <span class="token punctuation">\</span><span class="token number">0</span>   <span class="token builtin class-name">.</span>   s   t   r   t   a   b
0014475  <span class="token punctuation">\</span><span class="token number">0</span>   <span class="token builtin class-name">.</span>   s   h   s   t   r   t   a   b  <span class="token punctuation">\</span><span class="token number">0</span>   <span class="token builtin class-name">.</span>   i   n   t   e
0014491   r   p  <span class="token punctuation">\</span><span class="token number">0</span>   <span class="token builtin class-name">.</span>   n   o   t   e   <span class="token builtin class-name">.</span>   g   n   u   <span class="token builtin class-name">.</span>   p   r   o
0014507   p   e   r   t   y  <span class="token punctuation">\</span><span class="token number">0</span>   <span class="token builtin class-name">.</span>   n   o   t   e   <span class="token builtin class-name">.</span>   g   n   u   <span class="token builtin class-name">.</span>
0014523   b   u   i   l   d   -   i   d  <span class="token punctuation">\</span><span class="token number">0</span>   <span class="token builtin class-name">.</span>   n   o   t   e   <span class="token builtin class-name">.</span>   A
0014539   B   I   -   t   a   g  <span class="token punctuation">\</span><span class="token number">0</span>   <span class="token builtin class-name">.</span>   g   n   u   <span class="token builtin class-name">.</span>   h   a   s   h
0014555  <span class="token punctuation">\</span><span class="token number">0</span>   <span class="token builtin class-name">.</span>   d   y   n   s   y   m  <span class="token punctuation">\</span><span class="token number">0</span>   <span class="token builtin class-name">.</span>   d   y   n   s   t   r
0014571  <span class="token punctuation">\</span><span class="token number">0</span>   <span class="token builtin class-name">.</span>   g   n   u   <span class="token builtin class-name">.</span>   <span class="token function">v</span>   e   r   s   i   o   n  <span class="token punctuation">\</span><span class="token number">0</span>   <span class="token builtin class-name">.</span>   g
0014587   n   u   <span class="token builtin class-name">.</span>   <span class="token function">v</span>   e   r   s   i   o   n   _   r  <span class="token punctuation">\</span><span class="token number">0</span>   <span class="token builtin class-name">.</span>   r   e
0014603   l   a   <span class="token builtin class-name">.</span>   d   y   n  <span class="token punctuation">\</span><span class="token number">0</span>   <span class="token builtin class-name">.</span>   r   e   l   a   <span class="token builtin class-name">.</span>   p   l   t
0014619  <span class="token punctuation">\</span><span class="token number">0</span>   <span class="token builtin class-name">.</span>   i   n   i   t  <span class="token punctuation">\</span><span class="token number">0</span>   <span class="token builtin class-name">.</span>   p   l   t   <span class="token builtin class-name">.</span>   g   o   t  <span class="token punctuation">\</span><span class="token number">0</span>
0014635   <span class="token builtin class-name">.</span>   p   l   t   <span class="token builtin class-name">.</span>   s   e   c  <span class="token punctuation">\</span><span class="token number">0</span>   <span class="token builtin class-name">.</span>   t   e   x   t  <span class="token punctuation">\</span><span class="token number">0</span>   <span class="token builtin class-name">.</span>
0014651   f   i   n   i  <span class="token punctuation">\</span><span class="token number">0</span>   <span class="token builtin class-name">.</span>   r   o   d   a   t   a  <span class="token punctuation">\</span><span class="token number">0</span>   <span class="token builtin class-name">.</span>   e   h
0014667   _   f   r   a   m   e   _   h   d   r  <span class="token punctuation">\</span><span class="token number">0</span>   <span class="token builtin class-name">.</span>   e   h   _   f
0014683   r   a   m   e  <span class="token punctuation">\</span><span class="token number">0</span>   <span class="token builtin class-name">.</span>   i   n   i   t   _   a   r   r   a   y
0014699  <span class="token punctuation">\</span><span class="token number">0</span>   <span class="token builtin class-name">.</span>   f   i   n   i   _   a   r   r   a   y  <span class="token punctuation">\</span><span class="token number">0</span>   <span class="token builtin class-name">.</span>   d   y
0014715   n   a   m   i   c  <span class="token punctuation">\</span><span class="token number">0</span>   <span class="token builtin class-name">.</span>   d   a   t   a  <span class="token punctuation">\</span><span class="token number">0</span>   <span class="token builtin class-name">.</span>   b   s   s
0014731  <span class="token punctuation">\</span><span class="token number">0</span>   <span class="token builtin class-name">.</span>   c   o   m   m   e   n   t  <span class="token punctuation">\</span><span class="token number">0</span>
0014741
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br></div></div><p>看一看，瞧一瞧，是不是这个节中存储的全部是字符串？</p> <p>刚才没有解释 <code>sh_name</code> 这个字段，它表示字符串表这个节本身的名字。既然是名字，那一定是个字符串。但是这个字符串不是直接存储在这里的，而是存储了一个值为 0x00000011=17 的索引。现在数一下字符串表节的第 17 个字节开始的地方，可见 <code>.shstrtab</code> 这个字符串（<code>\0</code> 是字符串的分隔符）！</p> <h3 id="读取代码段的内容"><a href="#读取代码段的内容" class="header-anchor">#</a> 读取代码段的内容</h3> <p>从下面的这张图（指令：<code>readelf -S main</code>）：</p> <div class="language-bash line-numbers-mode"><div class="highlight-lines"><br><br><br><br><br><br><br><br><div class="highlighted"> </div><div class="highlighted"> </div><br><br><br><br></div><pre class="language-bash"><code>There are <span class="token number">31</span> section headers, starting at offset 0x3998:

Section Headers:
  <span class="token punctuation">[</span>Nr<span class="token punctuation">]</span> Name              Type             Address           Offset
       Size              EntSize          Flags  Link  Info  Align
<span class="token punctuation">..</span>.
  <span class="token punctuation">[</span><span class="token number">15</span><span class="token punctuation">]</span> .plt.sec          PROGBITS         0000000000001060  00001060
       0000000000000020  0000000000000010  AX       <span class="token number">0</span>     <span class="token number">0</span>     <span class="token number">16</span>
  <span class="token punctuation">[</span><span class="token number">16</span><span class="token punctuation">]</span> .text             PROGBITS         0000000000001080  00001080
       00000000000001b5  0000000000000000  AX       <span class="token number">0</span>     <span class="token number">0</span>     <span class="token number">16</span>
  <span class="token punctuation">[</span><span class="token number">17</span><span class="token punctuation">]</span> .fini             PROGBITS         0000000000001238  00001238
       000000000000000d  0000000000000000  AX       <span class="token number">0</span>     <span class="token number">0</span>     <span class="token number">4</span>
<span class="token punctuation">..</span>.
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><p>可以看到代码段是位于第 16 个表项 <code>.text</code> 中，加载（虚拟）地址是 0x0000000000001080，它位于 ELF 文件的偏移量是 0x00001080，长度是 0x00000000000001b5 字节。</p> <p>接下来解析一下其对应的二进制内容。首先计算这个表项的地址：14744 + 16 * 64 = 15768，然后读取这个表项的头部信息</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>od <span class="token parameter variable">-Ad</span> <span class="token parameter variable">-t</span> x1 <span class="token parameter variable">-j</span> <span class="token number">15768</span> <span class="token parameter variable">-N</span> <span class="token number">64</span> main

0015768 b9 00 00 00 01 00 00 00 06 00 00 00 00 00 00 00
0015784 <span class="token number">80</span> <span class="token number">10</span> 00 00 00 00 00 00 <span class="token number">80</span> <span class="token number">10</span> 00 00 00 00 00 00
0015800 b5 01 00 00 00 00 00 00 00 00 00 00 00 00 00 00
0015816 <span class="token number">10</span> 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
0015832
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>重点关注下面这 5 个字段</p> <div class="language-c line-numbers-mode"><div class="highlight-lines"><br><div class="highlighted"> </div><div class="highlighted"> </div><br><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><br><br><br><br><br><br></div><pre class="language-c"><code><span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token punctuation">{</span>
  <span class="token class-name">uint32_t</span>   sh_name<span class="token punctuation">;</span>
  <span class="token class-name">uint32_t</span>   sh_type<span class="token punctuation">;</span>
  <span class="token class-name">uint64_t</span>   sh_flags<span class="token punctuation">;</span>
  Elf64_Addr sh_addr<span class="token punctuation">;</span>
  Elf64_Off  sh_offset<span class="token punctuation">;</span>
  <span class="token class-name">uint64_t</span>   sh_size<span class="token punctuation">;</span>
  <span class="token class-name">uint32_t</span>   sh_link<span class="token punctuation">;</span>
  <span class="token class-name">uint32_t</span>   sh_info<span class="token punctuation">;</span>
  <span class="token class-name">uint64_t</span>   sh_addralign<span class="token punctuation">;</span>
  <span class="token class-name">uint64_t</span>   sh_entsize<span class="token punctuation">;</span>
<span class="token punctuation">}</span> Elf64_Shdr<span class="token punctuation">;</span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><table><thead><tr><th>字段</th> <th>值（小端存储）</th> <th>说明</th></tr></thead> <tbody><tr><td>sh_name</td> <td>0xb9 00 00 00</td> <td>代码段名称在字符串表节的偏移位置。LE(0xb9000000)=185 字节，也就是在字符串表的第 185 字节处，存储的就是代码段的名字。回过头去找一下，看一下是不是字符串 <code>.text</code></td></tr> <tr><td>sh_type</td> <td>0x01 00 00 00</td> <td>类型，<code>SHT_PROGBITS=1</code> 表示这是代码</td></tr> <tr><td>sh_addr</td> <td>0x80 10 00 00 00 00 00 00</td> <td>加载的虚拟地址，与 ELF header 的 <code>e_entry</code> 字段的值是相同的</td></tr> <tr><td>sh_offset</td> <td>0x80 10 00 00 00 00 00 00</td> <td>在 ELF 文件的偏移量。LE(0x8010000000000000)=4224，意思是内容从 ELF 文件的 4224 字节处开始</td></tr> <tr><td>sh_size</td> <td>0xb5 01 00 00 00 00 00 00</td> <td>长度为 LE(0xb501000000000000)=437 字节</td></tr></tbody></table> <p>以上这些分析结果与指令 <code>readelf -S main</code> 读取出来的完全一样！</p> <p>根据这些信息，我们可以读取代码段的字节码 如下</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>od <span class="token parameter variable">-Ad</span> <span class="token parameter variable">-t</span> x1 <span class="token parameter variable">-j</span> <span class="token number">4224</span> <span class="token parameter variable">-N</span> <span class="token number">437</span> main
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>这里就不贴输出的黑乎乎字节码了。</p> <h2 id="程序头-program-header"><a href="#程序头-program-header" class="header-anchor">#</a> 程序头（Program header）</h2> <p>文章开头就介绍了 ELF 是一个通用的文件结构，链接器和加载器在看待 ELF 的角度是不同的。为了对程序头有更感性的认识，我们先用 readelf 工具从总体上看一下 main 文件的所有段信息。</p> <div class="language-bash line-numbers-mode"><div class="highlight-lines"><br><br><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br></div><pre class="language-bash"><code>readelf <span class="token parameter variable">-l</span> main

Elf <span class="token function">file</span> <span class="token builtin class-name">type</span> is DYN <span class="token punctuation">(</span>Shared object <span class="token function">file</span><span class="token punctuation">)</span>
Entry point 0x1080
There are <span class="token number">13</span> program headers, starting at offset <span class="token number">64</span>

Program Headers:
  Type           Offset             VirtAddr           PhysAddr
                 FileSiz            MemSiz              Flags  Align
  PHDR           0x0000000000000040 0x0000000000000040 0x0000000000000040
                 0x00000000000002d8 0x00000000000002d8  R      0x8
  INTERP         0x0000000000000318 0x0000000000000318 0x0000000000000318
                 0x000000000000001c 0x000000000000001c  R      0x1
      <span class="token punctuation">[</span>Requesting program interpreter: /lib64/ld-linux-x86-64.so.2<span class="token punctuation">]</span>
  LOAD           0x0000000000000000 0x0000000000000000 0x0000000000000000
                 0x0000000000000640 0x0000000000000640  R      0x1000
  LOAD           0x0000000000001000 0x0000000000001000 0x0000000000001000
                 0x0000000000000245 0x0000000000000245  R E    0x1000
  LOAD           0x0000000000002000 0x0000000000002000 0x0000000000002000
                 0x0000000000000160 0x0000000000000160  R      0x1000
  LOAD           0x0000000000002da0 0x0000000000003da0 0x0000000000003da0
                 0x0000000000000270 0x0000000000000278  RW     0x1000
  DYNAMIC        0x0000000000002db0 0x0000000000003db0 0x0000000000003db0
                 0x0000000000000200 0x0000000000000200  RW     0x8
  NOTE           0x0000000000000338 0x0000000000000338 0x0000000000000338
                 0x0000000000000020 0x0000000000000020  R      0x8
  NOTE           0x0000000000000358 0x0000000000000358 0x0000000000000358
                 0x0000000000000044 0x0000000000000044  R      0x4
  GNU_PROPERTY   0x0000000000000338 0x0000000000000338 0x0000000000000338
                 0x0000000000000020 0x0000000000000020  R      0x8
  GNU_EH_FRAME   0x0000000000002010 0x0000000000002010 0x0000000000002010
                 0x0000000000000044 0x0000000000000044  R      0x4
  GNU_STACK      0x0000000000000000 0x0000000000000000 0x0000000000000000
                 0x0000000000000000 0x0000000000000000  RW     0x10
  GNU_RELRO      0x0000000000002da0 0x0000000000003da0 0x0000000000003da0
                 0x0000000000000260 0x0000000000000260  R      0x1

 Section to Segment mapping:
  Segment Sections<span class="token punctuation">..</span>.
   00
   01     .interp
   02     .interp .note.gnu.property .note.gnu.build-id .note.ABI-tag .gnu.hash .dynsym .dynstr .gnu.version .gnu.version_r .rela.dyn .rela.plt
   03     .init .plt .plt.got .plt.sec .text .fini
   04     .rodata .eh_frame_hdr .eh_frame
   05     .init_array .fini_array .dynamic .got .data .bss
   06     .dynamic
   07     .note.gnu.property
   08     .note.gnu.build-id .note.ABI-tag
   09     .note.gnu.property
   <span class="token number">10</span>     .eh_frame_hdr
   <span class="token number">11</span>
   <span class="token number">12</span>     .init_array .fini_array .dynamic .got
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br></div></div><p>由输出可得以下信息</p> <ul><li>这是一个共享对象文件</li> <li>入口地址是 0x1080</li> <li>共有 13 个 Program header，从 ELF 文件的 64 字节偏移地址开始</li></ul> <p>布局如下图所示：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>+----------------------+
|    ELF header        |
+----------------------+
+----------------------+
|  +----------------+------&gt; 偏移 64 字节
|  | PHDR           |  |  每个表项 56 字节
|  +----------------+  |
|  | INTERP         |  |
|  +----------------+------&gt; 偏移 176=64+56*2
|  | LOAD           |  |
|  +----------------+  |
|  | LOAD           |  |
|  +----------------+  |
|  | LOAD           |  |
|  +----------------+  |
|  | LOAD           |  |
|  +----------------+  |
|  | DYNAMIC        |  |
|  +----------------+  |
|  | NOTE           |  |
|  +----------------+  |
|  | NOTE           |  |
|  +----------------+  |
|  | GNU_PROPERTY   |  |
|  +----------------+  |
|  | GNU_EH_FRAME   |  |
|  +----------------+  |
|  | GNU_STACK      |  |
|  +----------------+  |
|  | GNU_RELRO      |  |
|  +----------------+  |
+----------------------+
+----------------------+
|    Segments          |
+----------------------+
+----------------------+
| Section header table |
+----------------------+
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br></div></div><p>开头还说过：节与段本质上是一样的，可以理解为一个段由一个或多个节组成。</p> <p>从上图可以看到，第 2 个程序头这个段由那么多的 Section 组成。还可以看到，一共有 4 个 <code>LOAD</code> 类型的段：</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token punctuation">..</span>.
      <span class="token punctuation">[</span>Requesting program interpreter: /lib64/ld-linux-x86-64.so.2<span class="token punctuation">]</span>
  LOAD           0x0000000000000000 0x0000000000000000 0x0000000000000000
                 0x0000000000000640 0x0000000000000640  R      0x1000
  LOAD           0x0000000000001000 0x0000000000001000 0x0000000000001000
                 0x0000000000000245 0x0000000000000245  R E    0x1000
  LOAD           0x0000000000002000 0x0000000000002000 0x0000000000002000
                 0x0000000000000160 0x0000000000000160  R      0x1000
  LOAD           0x0000000000002da0 0x0000000000003da0 0x0000000000003da0
                 0x0000000000000270 0x0000000000000278  RW     0x1000
  DYNAMIC        0x0000000000002db0 0x0000000000003db0 0x0000000000003db0
                 0x0000000000000200 0x0000000000000200  RW     0x8
<span class="token punctuation">..</span>.
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><p>我们读取第一个 <code>LOAD</code> 类型的段，扒开其中的二进制字节码瞅瞅。</p> <p>第一步的工作：计算这个段表项的地址信息。从 ELF 头得知如下信息：</p> <table><thead><tr><th style="text-align:right;">字段</th> <th style="text-align:left;">说明</th></tr></thead> <tbody><tr><td style="text-align:right;">e_phoff</td> <td style="text-align:left;">程序头表位于 ELF 文件偏移 64 字节的地方</td></tr> <tr><td style="text-align:right;">e_phentsize</td> <td style="text-align:left;">每一个表项的长度是 56 字节</td></tr> <tr><td style="text-align:right;">e_phnum</td> <td style="text-align:left;">共有 10 个表项</td></tr></tbody></table> <p>通过计算，得到可读、可执行的 <code>LOAD</code> 段（第 3 个程序表项）位于偏移量 176=64+56*2 字节处。</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>od <span class="token parameter variable">-Ad</span> <span class="token parameter variable">-t</span> x1 <span class="token parameter variable">-j</span> <span class="token number">176</span> <span class="token parameter variable">-N</span> <span class="token number">56</span> main

0000176 01 00 00 00 04 00 00 00 00 00 00 00 00 00 00 00
0000192 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
0000208 <span class="token number">40</span> 06 00 00 00 00 00 00 <span class="token number">40</span> 06 00 00 00 00 00 00
0000224 00 <span class="token number">10</span> 00 00 00 00 00 00
0000232
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>按照惯例把其中几个需要关注的字段与数据结构的成员变量对照看一下：</p> <div class="language-c line-numbers-mode"><div class="highlight-lines"><br><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><br><br><br><br></div><pre class="language-c"><code><span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token punctuation">{</span>
  <span class="token class-name">uint32_t</span>   p_type<span class="token punctuation">;</span>
  <span class="token class-name">uint32_t</span>   p_flags<span class="token punctuation">;</span>
  Elf64_Off  p_offset<span class="token punctuation">;</span>
  Elf64_Addr p_vaddr<span class="token punctuation">;</span>
  Elf64_Addr p_paddr<span class="token punctuation">;</span>
  <span class="token class-name">uint64_t</span>   p_filesz<span class="token punctuation">;</span>
  <span class="token class-name">uint64_t</span>   p_memsz<span class="token punctuation">;</span>
  <span class="token class-name">uint64_t</span>   p_align<span class="token punctuation">;</span>
<span class="token punctuation">}</span> Elf64_Phdr<span class="token punctuation">;</span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><table><thead><tr><th>字段</th> <th>值（小端存储）</th> <th>说明</th></tr></thead> <tbody><tr><td>p_type</td> <td>0x01 00 00 00</td> <td>段的类型，1 表示这个段需要加载到内存</td></tr> <tr><td>p_flags</td> <td>0x04 00 00 00</td> <td>位掩码，<code>04=PF_X</code> 表示这是个可执行段</td></tr> <tr><td>p_offset</td> <td>0x00 00 00 00 00 00 00 00</td> <td>段在 ELF 文件的偏移地址，0 表示这个段从 ELF 文件的头部开始</td></tr> <tr><td>p_vaddr</td> <td>0x00 00 00 00 00 00 00 00</td> <td>段加载到内存的虚拟地址 0</td></tr> <tr><td>p_paddr</td> <td>0x00 00 00 00 00 00 00 00</td> <td>段加载的物理地址，与虚拟地址相同</td></tr> <tr><td>p_filesz</td> <td>0x40 06 00 00 00 00 00 00</td> <td>这个段在 ELF 文件占据的字节数，LE(0x0640)=1600 字节</td></tr> <tr><td>p_memsz</td> <td>0x40 06 00 00 00 00 00 00</td> <td>这个段加载到内存需要占据的字节数，LE(0x0640)=1600 字节</td></tr></tbody></table> <blockquote><p>注意：有些段是不需要加载到内存中的;</p></blockquote> <p>由上述分析可知：从 ELF 文件的 1 到 1600 字节都属于这个 <code>LOAD</code> 段的内容。被执行时，这个段需要被加载到内存中虚拟地址为 0 的地方，从这里开始，又是一个全新的故事了。</p> <h2 id="小结"><a href="#小结" class="header-anchor">#</a> 小结</h2> <p>本文两个重点：</p> <ul><li>ELF 头描述文件的总体信息，以及两个表（程序头表和节头表）的相关信息（偏移地址，表项个数，表项长度）</li> <li>每一个表包括很多个表项，每一个表项都描述一个节/段的具体信息</li></ul> <p>链接器和加载器也都是按照这样的原理来解析 ELF 文件的。</p> <h2 id="参考文献"><a href="#参考文献" class="header-anchor">#</a> 参考文献</h2> <ul><li><a href="https://man7.org/linux/man-pages/man5/elf.5.html" target="_blank" rel="noopener noreferrer">elf(5) — linux manual page<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li><a href="https://www.toutiao.com/i6982736574626660872/?tt_from=weixin&amp;utm_campaign=client_share&amp;wxshare_count=1&amp;timestamp=1625875430&amp;app=news_article&amp;utm_source=weixin&amp;utm_medium=toutiao_android&amp;use_new_style=1&amp;req_id=2021071008035001013516808335284E69&amp;share_token=b34f88c9-9107-4600-8850-bd1599e87b73&amp;group_id=6982736574626660872&amp;wid=1625992706756" target="_blank" rel="noopener noreferrer">Linux 系统中编译、链接的基石-ELF 文件：扒开它的层层外衣，从字节码的粒度来探索<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></section> <footer class="page-edit"><!----> <!----></footer> <!----> <div class="comments-wrapper"><!----></div></main></div> <!----></div> <ul class="sub-sidebar sub-sidebar-wrapper" style="width:12rem;" data-v-b57cc07c data-v-7dd95ae2><li class="level-2" data-v-b57cc07c><a href="/a-glimpse-of-elf/#初次见面" class="sidebar-link reco-side-初次见面" data-v-b57cc07c>初次见面</a></li><li class="level-2" data-v-b57cc07c><a href="/a-glimpse-of-elf/#linux-系统描述-elf-的数据结构" class="sidebar-link reco-side-linux-系统描述-elf-的数据结构" data-v-b57cc07c>Linux 系统描述 ELF 的数据结构</a></li><li class="level-2" data-v-b57cc07c><a href="/a-glimpse-of-elf/#elf-头部" class="sidebar-link reco-side-elf-头部" data-v-b57cc07c>ELF 头部</a></li><li class="level-2" data-v-b57cc07c><a href="/a-glimpse-of-elf/#示例程序" class="sidebar-link reco-side-示例程序" data-v-b57cc07c>示例程序</a></li><li class="level-3" data-v-b57cc07c><a href="/a-glimpse-of-elf/#环境" class="sidebar-link reco-side-环境" data-v-b57cc07c>环境</a></li><li class="level-3" data-v-b57cc07c><a href="/a-glimpse-of-elf/#演示" class="sidebar-link reco-side-演示" data-v-b57cc07c>演示</a></li><li class="level-3" data-v-b57cc07c><a href="/a-glimpse-of-elf/#字符串表项" class="sidebar-link reco-side-字符串表项" data-v-b57cc07c>字符串表项</a></li><li class="level-3" data-v-b57cc07c><a href="/a-glimpse-of-elf/#读取字符串表节的内容" class="sidebar-link reco-side-读取字符串表节的内容" data-v-b57cc07c>读取字符串表节的内容</a></li><li class="level-3" data-v-b57cc07c><a href="/a-glimpse-of-elf/#读取代码段的内容" class="sidebar-link reco-side-读取代码段的内容" data-v-b57cc07c>读取代码段的内容</a></li><li class="level-2" data-v-b57cc07c><a href="/a-glimpse-of-elf/#程序头-program-header" class="sidebar-link reco-side-程序头-program-header" data-v-b57cc07c>程序头（Program header）</a></li><li class="level-2" data-v-b57cc07c><a href="/a-glimpse-of-elf/#小结" class="sidebar-link reco-side-小结" data-v-b57cc07c>小结</a></li><li class="level-2" data-v-b57cc07c><a href="/a-glimpse-of-elf/#参考文献" class="sidebar-link reco-side-参考文献" data-v-b57cc07c>参考文献</a></li></ul></div></div></div><div class="global-ui"><div class="back-to-ceiling" style="right:1rem;bottom:6rem;width:2.5rem;height:2.5rem;border-radius:.25rem;line-height:2.5rem;display:none;" data-v-c6073ba8 data-v-c6073ba8><svg t="1574745035067" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="5404" class="icon" data-v-c6073ba8><path d="M526.60727968 10.90185116a27.675 27.675 0 0 0-29.21455937 0c-131.36607665 82.28402758-218.69155461 228.01873535-218.69155402 394.07834331a462.20625001 462.20625001 0 0 0 5.36959153 69.94390903c1.00431239 6.55289093-0.34802892 13.13561351-3.76865779 18.80351572-32.63518765 54.11355614-51.75690182 118.55860487-51.7569018 187.94566865a371.06718723 371.06718723 0 0 0 11.50484808 91.98906777c6.53300375 25.50556257 41.68394495 28.14064038 52.69160883 4.22606766 17.37162448-37.73630017 42.14135425-72.50938081 72.80769204-103.21549295 2.18761121 3.04276886 4.15646224 6.24463696 6.40373557 9.22774369a1871.4375 1871.4375 0 0 0 140.04691725 5.34970492 1866.36093723 1866.36093723 0 0 0 140.04691723-5.34970492c2.24727335-2.98310674 4.21612437-6.18497483 6.3937923-9.2178004 30.66633723 30.70611158 55.4360664 65.4791928 72.80769147 103.21549355 11.00766384 23.91457269 46.15860503 21.27949489 52.69160879-4.22606768a371.15156223 371.15156223 0 0 0 11.514792-91.99901164c0-69.36717486-19.13165746-133.82216804-51.75690182-187.92578088-3.42062944-5.66790279-4.76302748-12.26056868-3.76865837-18.80351632a462.20625001 462.20625001 0 0 0 5.36959269-69.943909c-0.00994388-166.08943902-87.32547796-311.81420293-218.6915546-394.09823051zM605.93803103 357.87693858a93.93749974 93.93749974 0 1 1-187.89594924 6.1e-7 93.93749974 93.93749974 0 0 1 187.89594924-6.1e-7z" p-id="5405" data-v-c6073ba8></path><path d="M429.50777625 765.63860547C429.50777625 803.39355007 466.44236686 1000.39046097 512.00932183 1000.39046097c45.56695499 0 82.4922232-197.00623328 82.5015456-234.7518555 0-37.75494459-36.9345906-68.35043303-82.4922232-68.34111062-45.57627738-0.00932239-82.52019037 30.59548842-82.51086798 68.34111062z" p-id="5406" data-v-c6073ba8></path></svg></div></div></div>
    <script src="/assets/js/app.2124bf24.js" defer></script><script src="/assets/js/3.944fac0d.js" defer></script><script src="/assets/js/1.c30a1333.js" defer></script><script src="/assets/js/55.674ca41a.js" defer></script>
  </body>
</html>
