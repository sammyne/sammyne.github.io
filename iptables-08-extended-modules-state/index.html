<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>[iptables] 08. state 扩展模块 | sammyne</title>
    <meta name="generator" content="VuePress 1.9.9">
    <link rel="icon" href="/favicon.ico">
    <meta name="description" content="Just playing around :)">
    <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no">
    
    <link rel="preload" href="/assets/css/0.styles.00c90c45.css" as="style"><link rel="preload" href="/assets/js/app.2124bf24.js" as="script"><link rel="preload" href="/assets/js/3.944fac0d.js" as="script"><link rel="preload" href="/assets/js/1.c30a1333.js" as="script"><link rel="preload" href="/assets/js/70.a647f8ad.js" as="script"><link rel="prefetch" href="/assets/js/10.6feb556b.js"><link rel="prefetch" href="/assets/js/11.d238b802.js"><link rel="prefetch" href="/assets/js/12.92a89c73.js"><link rel="prefetch" href="/assets/js/13.05851956.js"><link rel="prefetch" href="/assets/js/14.34744b6c.js"><link rel="prefetch" href="/assets/js/15.fd1f282f.js"><link rel="prefetch" href="/assets/js/16.338c7efe.js"><link rel="prefetch" href="/assets/js/17.dd7e0805.js"><link rel="prefetch" href="/assets/js/18.7e4af78d.js"><link rel="prefetch" href="/assets/js/19.96894619.js"><link rel="prefetch" href="/assets/js/20.3d3adc8f.js"><link rel="prefetch" href="/assets/js/21.669510d2.js"><link rel="prefetch" href="/assets/js/22.4997fa99.js"><link rel="prefetch" href="/assets/js/23.88d0f3d2.js"><link rel="prefetch" href="/assets/js/24.688b92a8.js"><link rel="prefetch" href="/assets/js/25.42a3079a.js"><link rel="prefetch" href="/assets/js/26.6b1973cc.js"><link rel="prefetch" href="/assets/js/27.e2133f18.js"><link rel="prefetch" href="/assets/js/28.4850156d.js"><link rel="prefetch" href="/assets/js/29.f6cf5316.js"><link rel="prefetch" href="/assets/js/30.824ebab1.js"><link rel="prefetch" href="/assets/js/31.d5cda852.js"><link rel="prefetch" href="/assets/js/32.5d223b08.js"><link rel="prefetch" href="/assets/js/33.9c398239.js"><link rel="prefetch" href="/assets/js/34.1cfaa2c4.js"><link rel="prefetch" href="/assets/js/35.69f5a7fc.js"><link rel="prefetch" href="/assets/js/36.a3ad36a5.js"><link rel="prefetch" href="/assets/js/37.71d0640c.js"><link rel="prefetch" href="/assets/js/38.8e4b00cc.js"><link rel="prefetch" href="/assets/js/39.ff2dfcd8.js"><link rel="prefetch" href="/assets/js/4.908240c5.js"><link rel="prefetch" href="/assets/js/40.3262bce0.js"><link rel="prefetch" href="/assets/js/41.5eb1f517.js"><link rel="prefetch" href="/assets/js/42.efbc331e.js"><link rel="prefetch" href="/assets/js/43.d10817f1.js"><link rel="prefetch" href="/assets/js/44.5f29d6a5.js"><link rel="prefetch" href="/assets/js/45.19bf538d.js"><link rel="prefetch" href="/assets/js/46.caa3e673.js"><link rel="prefetch" href="/assets/js/47.02d2bfdd.js"><link rel="prefetch" href="/assets/js/48.8f6cdcc5.js"><link rel="prefetch" href="/assets/js/49.8874e137.js"><link rel="prefetch" href="/assets/js/5.6b0f5eca.js"><link rel="prefetch" href="/assets/js/50.c2d9cf07.js"><link rel="prefetch" href="/assets/js/51.83db0769.js"><link rel="prefetch" href="/assets/js/52.f81f5392.js"><link rel="prefetch" href="/assets/js/53.b04b70d0.js"><link rel="prefetch" href="/assets/js/54.07971080.js"><link rel="prefetch" href="/assets/js/55.674ca41a.js"><link rel="prefetch" href="/assets/js/56.862cae6b.js"><link rel="prefetch" href="/assets/js/57.3d3d7cc9.js"><link rel="prefetch" href="/assets/js/58.98ebbb9c.js"><link rel="prefetch" href="/assets/js/59.4081edac.js"><link rel="prefetch" href="/assets/js/6.81d9e9a0.js"><link rel="prefetch" href="/assets/js/60.42a820f4.js"><link rel="prefetch" href="/assets/js/61.a52bc06d.js"><link rel="prefetch" href="/assets/js/62.18da62d1.js"><link rel="prefetch" href="/assets/js/63.52f6533c.js"><link rel="prefetch" href="/assets/js/64.03c12890.js"><link rel="prefetch" href="/assets/js/65.ccfd6c32.js"><link rel="prefetch" href="/assets/js/66.a0c38aa4.js"><link rel="prefetch" href="/assets/js/67.a30f375b.js"><link rel="prefetch" href="/assets/js/68.8248dd23.js"><link rel="prefetch" href="/assets/js/69.123686ed.js"><link rel="prefetch" href="/assets/js/7.18067abc.js"><link rel="prefetch" href="/assets/js/71.02a394bf.js"><link rel="prefetch" href="/assets/js/72.2b1e35e2.js"><link rel="prefetch" href="/assets/js/73.afa2fc7a.js"><link rel="prefetch" href="/assets/js/74.7a30b68a.js"><link rel="prefetch" href="/assets/js/75.cddbdc6c.js"><link rel="prefetch" href="/assets/js/76.7b929319.js"><link rel="prefetch" href="/assets/js/77.87e8820d.js"><link rel="prefetch" href="/assets/js/78.c68f804b.js"><link rel="prefetch" href="/assets/js/79.8b9d1881.js"><link rel="prefetch" href="/assets/js/8.8be62fa8.js"><link rel="prefetch" href="/assets/js/80.e0641939.js"><link rel="prefetch" href="/assets/js/81.2bf032f3.js"><link rel="prefetch" href="/assets/js/82.fc2e2dc0.js"><link rel="prefetch" href="/assets/js/83.eab5c475.js"><link rel="prefetch" href="/assets/js/84.48d98958.js"><link rel="prefetch" href="/assets/js/85.17986848.js"><link rel="prefetch" href="/assets/js/86.32c9a409.js"><link rel="prefetch" href="/assets/js/87.28193f1a.js"><link rel="prefetch" href="/assets/js/88.7ef5e0f3.js"><link rel="prefetch" href="/assets/js/89.e3126a19.js"><link rel="prefetch" href="/assets/js/9.49555849.js"><link rel="prefetch" href="/assets/js/90.569bbf88.js">
    <link rel="stylesheet" href="/assets/css/0.styles.00c90c45.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container no-sidebar" data-v-7dd95ae2><div data-v-7dd95ae2><div class="password-shadow password-wrapper-out" style="display:none;" data-v-59e6cb88 data-v-7dd95ae2 data-v-7dd95ae2><h3 class="title" data-v-59e6cb88>sammyne</h3> <p class="description" data-v-59e6cb88>Just playing around :)</p> <label id="box" class="inputBox" data-v-59e6cb88><input type="password" value="" data-v-59e6cb88> <span data-v-59e6cb88>Konck! Knock!</span> <button data-v-59e6cb88>OK</button></label> <div class="footer" data-v-59e6cb88><span data-v-59e6cb88><i class="iconfont reco-theme" data-v-59e6cb88></i> <a target="blank" href="https://vuepress-theme-reco.recoluan.com" data-v-59e6cb88>vuePress-theme-reco</a></span> <span data-v-59e6cb88><i class="iconfont reco-copyright" data-v-59e6cb88></i> <a data-v-59e6cb88><span data-v-59e6cb88>sammyne</span>
          
        <span data-v-59e6cb88>2020 - </span>
        2023
      </a></span></div></div> <div class="hide" data-v-7dd95ae2><header class="navbar" data-v-7dd95ae2><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/logo.svg" alt="sammyne" class="logo"> <span class="site-name">sammyne</span></a> <div class="links"><div class="color-picker"><a class="color-button"><i class="iconfont reco-color"></i></a> <div class="color-picker-menu" style="display:none;"><div class="mode-options"><h4 class="title">Choose mode</h4> <ul class="color-mode-options"><li class="dark">dark</li><li class="auto active">auto</li><li class="light">light</li></ul></div></div></div> <div class="search-box"><i class="iconfont reco-search"></i> <input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link"><i class="iconfont reco-home"></i>
  首页
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-category"></i>
      分类
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/categories/os/" class="nav-link"><i class="undefined"></i>
  os
</a></li><li class="dropdown-item"><!----> <a href="/categories/dev/" class="nav-link"><i class="undefined"></i>
  dev
</a></li><li class="dropdown-item"><!----> <a href="/categories/crypto/" class="nav-link"><i class="undefined"></i>
  crypto
</a></li><li class="dropdown-item"><!----> <a href="/categories/programming/" class="nav-link"><i class="undefined"></i>
  programming
</a></li><li class="dropdown-item"><!----> <a href="/categories/tee/" class="nav-link"><i class="undefined"></i>
  tee
</a></li><li class="dropdown-item"><!----> <a href="/categories/engineering/" class="nav-link"><i class="undefined"></i>
  engineering
</a></li><li class="dropdown-item"><!----> <a href="/categories/language/" class="nav-link"><i class="undefined"></i>
  language
</a></li><li class="dropdown-item"><!----> <a href="/categories/tool/" class="nav-link"><i class="undefined"></i>
  tool
</a></li><li class="dropdown-item"><!----> <a href="/categories/architecture/" class="nav-link"><i class="undefined"></i>
  architecture
</a></li><li class="dropdown-item"><!----> <a href="/categories/decentralization/" class="nav-link"><i class="undefined"></i>
  decentralization
</a></li><li class="dropdown-item"><!----> <a href="/categories/network/" class="nav-link"><i class="undefined"></i>
  network
</a></li><li class="dropdown-item"><!----> <a href="/categories/software engineering/" class="nav-link"><i class="undefined"></i>
  software engineering
</a></li><li class="dropdown-item"><!----> <a href="/categories/notes/" class="nav-link"><i class="undefined"></i>
  notes
</a></li></ul></div></div><div class="nav-item"><a href="/tag/" class="nav-link"><i class="iconfont reco-tag"></i>
  标签
</a></div><div class="nav-item"><a href="/timeline/" class="nav-link"><i class="iconfont reco-date"></i>
  时间轴
</a></div><div class="nav-item"><a href="https://github.com/sammyne" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="iconfont reco-github"></i>
  Github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav></div></header> <div class="sidebar-mask" data-v-7dd95ae2></div> <aside class="sidebar" data-v-7dd95ae2><div class="personal-info-wrapper" data-v-1fad0c41 data-v-7dd95ae2><img src="/avatar.png" alt="author-avatar" class="personal-img" data-v-1fad0c41> <h3 class="name" data-v-1fad0c41>
    sammyne
  </h3> <div class="num" data-v-1fad0c41><div data-v-1fad0c41><h3 data-v-1fad0c41>80</h3> <h6 data-v-1fad0c41>Articles</h6></div> <div data-v-1fad0c41><h3 data-v-1fad0c41>43</h3> <h6 data-v-1fad0c41>Tags</h6></div></div> <ul class="social-links" data-v-1fad0c41></ul> <hr data-v-1fad0c41></div> <nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link"><i class="iconfont reco-home"></i>
  首页
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-category"></i>
      分类
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/categories/os/" class="nav-link"><i class="undefined"></i>
  os
</a></li><li class="dropdown-item"><!----> <a href="/categories/dev/" class="nav-link"><i class="undefined"></i>
  dev
</a></li><li class="dropdown-item"><!----> <a href="/categories/crypto/" class="nav-link"><i class="undefined"></i>
  crypto
</a></li><li class="dropdown-item"><!----> <a href="/categories/programming/" class="nav-link"><i class="undefined"></i>
  programming
</a></li><li class="dropdown-item"><!----> <a href="/categories/tee/" class="nav-link"><i class="undefined"></i>
  tee
</a></li><li class="dropdown-item"><!----> <a href="/categories/engineering/" class="nav-link"><i class="undefined"></i>
  engineering
</a></li><li class="dropdown-item"><!----> <a href="/categories/language/" class="nav-link"><i class="undefined"></i>
  language
</a></li><li class="dropdown-item"><!----> <a href="/categories/tool/" class="nav-link"><i class="undefined"></i>
  tool
</a></li><li class="dropdown-item"><!----> <a href="/categories/architecture/" class="nav-link"><i class="undefined"></i>
  architecture
</a></li><li class="dropdown-item"><!----> <a href="/categories/decentralization/" class="nav-link"><i class="undefined"></i>
  decentralization
</a></li><li class="dropdown-item"><!----> <a href="/categories/network/" class="nav-link"><i class="undefined"></i>
  network
</a></li><li class="dropdown-item"><!----> <a href="/categories/software engineering/" class="nav-link"><i class="undefined"></i>
  software engineering
</a></li><li class="dropdown-item"><!----> <a href="/categories/notes/" class="nav-link"><i class="undefined"></i>
  notes
</a></li></ul></div></div><div class="nav-item"><a href="/tag/" class="nav-link"><i class="iconfont reco-tag"></i>
  标签
</a></div><div class="nav-item"><a href="/timeline/" class="nav-link"><i class="iconfont reco-date"></i>
  时间轴
</a></div><div class="nav-item"><a href="https://github.com/sammyne" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="iconfont reco-github"></i>
  Github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav> <!----> </aside> <div class="password-shadow password-wrapper-in" style="display:none;" data-v-59e6cb88 data-v-7dd95ae2><h3 class="title" data-v-59e6cb88>[iptables] 08. state 扩展模块</h3> <!----> <label id="box" class="inputBox" data-v-59e6cb88><input type="password" value="" data-v-59e6cb88> <span data-v-59e6cb88>Konck! Knock!</span> <button data-v-59e6cb88>OK</button></label> <div class="footer" data-v-59e6cb88><span data-v-59e6cb88><i class="iconfont reco-theme" data-v-59e6cb88></i> <a target="blank" href="https://vuepress-theme-reco.recoluan.com" data-v-59e6cb88>vuePress-theme-reco</a></span> <span data-v-59e6cb88><i class="iconfont reco-copyright" data-v-59e6cb88></i> <a data-v-59e6cb88><span data-v-59e6cb88>sammyne</span>
          
        <span data-v-59e6cb88>2020 - </span>
        2023
      </a></span></div></div> <div data-v-7dd95ae2><div data-v-7dd95ae2><main class="page"><section style="display:;"><div class="page-title"><h1 class="title">[iptables] 08. state 扩展模块</h1> <div data-v-8a445198><i class="iconfont reco-account" data-v-8a445198><span data-v-8a445198>sammyne</span></i> <i class="iconfont reco-date" data-v-8a445198><span data-v-8a445198>1/8/2021</span></i> <i class="iconfont reco-eye" data-v-8a445198><span id="/iptables-08-extended-modules-state/" data-flag-title="Your Article Title" class="leancloud-visitors" data-v-8a445198><a class="leancloud-visitors-count" style="font-size:.9rem;font-weight:normal;color:#999;"></a></span></i> <i class="tags iconfont reco-tag" data-v-8a445198><span class="tag-item" data-v-8a445198>iptables</span><span class="tag-item" data-v-8a445198>linux</span><span class="tag-item" data-v-8a445198>ops</span></i></div></div> <div class="theme-reco-content content__default"><div class="custom-block tip"><p class="title">温馨提示</p><p>本文从理论到实践，系统地介绍 iptables。如果你想要从头开始了解 iptables，可以查看 <a href="/tag/iptables/">iptables 系列文章</a>。</p></div><div class="custom-block danger"><p class="title">高能预警</p><p>在进行 iptables 实验时，请务必在测试机上进行。本文的实验操作环境为 VMware Fusion 12.0 下的 Ubuntu 20.04.1。</p></div><h2 id="背景"><a href="#背景" class="header-anchor">#</a> 背景</h2> <p>通过 HTTP 的 url 访问某个网页时，客户端向服务端的 80 端口发起请求，服务端通过 80 端口响应请求。客户端似乎理所当然地放行 80 端口，以便服务端的回应报文可以进入客户端主机。因此，客户端设置放行 80 端口。</p> <p>同理，通过 SSH 工具远程连接到某台服务器时，客户端向服务端的 22 号端口发起请求，服务端再通过 22 号端口响应请求。因此，客户端理所当然地放行了所有 22 号端口，以便远程主机的响应请求能够通过防火墙。</p> <p>但是客户端没有主动向 80 端口发起请求，也没有主动向 22 号端口发起请求的情况下，那么其他主机通过 80 端口或者 22 号端口向服务端发送数据时，服务端可以接收到吗？应该是可以的。为了收到 HTTP 与 SSH 的响应报文，服务端已经放行了 80 与 22 号端口。所以&quot;响应&quot;报文和&quot;主动发送&quot;给我们的报文都可以通过这两个端口。这样就带来了安全问题：某些坏人可以利用这些端口&quot;主动&quot;连接到服务器干坏事。一般都是我们主动请求 80 端口，80 端口回应我们，但是一般不会出现 80 端口主动请求客户端的情况。</p> <p>我们可能会这样想：已知哪些主机是安全的，只要针对这些安全的主机放行对应的端口即可，其他 IP 一律拒绝。比如，已知 IP 为 123 的主机是安全的，所以对 123 主机开放 22 号端口，以便 123 主机能够通过 22 号端口响应 SSH 请求。这样一来，随着管理的主机越来越多，每次都要为新主机配置这些规则。30 台可能还好，但是 300 台就炸了。80 端口就更别提了。每次访问一个新网址都要对这个网址添加信任的做法显然不太合理。</p> <p>我们可能还会想：针对相应端口，用 <code>--tcp-flags</code> 去匹配 TCP 报文的标志位，把外来的&quot;第一次握手&quot;的请求拒绝，是不是也可以呢？但是如果对方使用的是 UDP 协议或者 ICMP 协议就不行了。</p> <p>仔细想想造成上述问题的&quot;根源&quot;：为了让&quot;服务提供方&quot;能够正常地&quot;响应&quot;我们的请求，在主机上开放对应端口。开放这些端口的同时，也使得别人可以利用这些开放端口&quot;主动&quot;地攻击我们。他们发送过来的报文并不是为了响应我们，而是为了主动攻击我们。这正是问题所在。</p> <p>问题就是：怎样判断这些报文是为了回应我们之前发出的报文，还是主动向我们发送的报文呢？</p> <h2 id="state-拓展模块"><a href="#state-拓展模块" class="header-anchor">#</a> state 拓展模块</h2> <p>可以通过 iptables 的 state 扩展模块可解决上述问题。在这之前，需要先了解一些 state 模块的相关概念，然后再回过头来解决上述问题。</p> <p>从字面上理解，state 可以译为状态，但是也可以用一个高大上的词去解释它。state 模块可以让 iptables 实现&quot;连接追踪&quot;机制。</p> <p>既然是&quot;连接追踪&quot;，则必然要有&quot;连接&quot;。一说到连接，你可能会下意识地想到 TCP 连接。但是对于 state 模块而言的&quot;连接&quot;并不能与 TCP &quot;连接&quot;画等号。在 TCP/IP 协议簇中，UDP 和 ICMP 没有所谓的连接。但是对于 state 模块来说，TCP 报文、UDP 报文和 ICMP 报文都是有连接状态的。可以这样理解：对于 state 模块而言，只要两台机器在&quot;你来我往&quot;地通信，就算建立了连接，如下图所示</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>+---------+   +------------+   +---------+
|         |   |            |   |         |
|  host1  |   |  iptables  |   |  host2  |
|         |   |            |   |         |
|   +-------------------------------&gt;    |
|         |   |            |   |         |
|   &lt;-------------------------------+    |
|         |   |            |   |         |
|   +-------------------------------&gt;    |
|         |   |            |   |         |
+---------+   +------------+   +---------+
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>这个所谓链接中的报文状态是接下来讨论的话题。</p> <p>对于 state 模块的连接而言，&quot;连接&quot;的报文可以分为以下 5 种状态</p> <ul><li><code>NEW</code></li> <li><code>ESTABLISHED</code></li> <li><code>RELATED</code></li> <li><code>INVALID</code></li> <li><code>UNTRACKED</code></li></ul> <p>那么上述报文状态都代表什么含义呢？我们先来大概了解一下概念，然后结合示例说明。</p> <div class="custom-block warning"><p class="title">注意事项</p><p>如下报文状态都是对于 state 模块来说的。</p></div><ul><li><code>NEW</code>：连接的第一个包，状态就是 <code>NEW</code>，可以理解为新连接第一个包的状态为 <code>NEW</code>。</li> <li><code>ESTABLISHED</code>：可以把 <code>NEW</code> 状态包后面的包状态理解为 <code>ESTABLISHED</code>，表示连接已建立。</li></ul> <p>或许用图说话更容易被人理解</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>+---------+   +------------+   +---------+
|  host1  |   |  iptables  |   |  host2  |
|         |   |            |   |         |
|         |   |    NEW     |   |         |
|   +-------------------------------&gt;    |
|         |   |            |   |         |
|         |   | ESTABLISHED|   |         |
|   &lt;-------------------------------+    |
|         |   |            |   |         |
|         |   | ESTABLISHED|   |         |
|   +-------------------------------&gt;    |
+---------+   +------------+   +---------+
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><ul><li><code>RELATED</code>：从字面上理解 <code>RELATED</code> 译为关系，但是这样仍然不好理解，我们举个例子。
<ul><li><p>比如 FTP 服务</p> <ul><li>FTP 服务端会建立两个进程：<strong>命令进程</strong> 和 <strong>数据进程</strong>。
<ul><li>命令进程负责服务端与客户端之间的命令传输（可以把这个传输过程理解成 state 中所谓的一个&quot;连接&quot;，暂称为&quot;命令连接&quot;）。</li> <li>数据进程负责服务端与客户端之间的数据传输 (把这个过程暂称为&quot;数据连接&quot;)。</li></ul></li> <li>但是具体传输的数据由命令控制，所以&quot;数据连接&quot;的报文与&quot;命令连接&quot;是有&quot;关系&quot;的。</li> <li>因此，&quot;数据连接&quot;的报文可能就是 <code>RELATED</code> 状态。因为这些报文与&quot;命令连接&quot;的报文有关系。</li></ul> <div class="custom-block tip"><p class="title">温馨提示</p><p>如果想要对 FTP 进行连接追踪，需要单独加载对应的内核模块 <code>nf_conntrack_ftp</code>。如果想要自动加载，可以配置 <code>/etc/sysconfig/iptables-config</code> 文件。</p></div></li></ul></li> <li><code>INVALID</code>：一个包如果无法被识别，或者没有任何状态，它的状态就是 <code>INVALID</code>。我们可以主动屏蔽状态为 <code>INVALID</code> 的报文。</li> <li><code>UNTRACKED</code>：报文的状态为 <code>untracked</code> 时，表示报文未被追踪，此时通常表示无法找到相关的连接。</li></ul> <p>上述 5 种状态的详细解释可以参考如下文章的 <a href="http://www.iptables.info/en/connection-state.html" target="_blank" rel="noopener noreferrer">&quot;User-land states&quot;章节<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p>以上便是 state 模块所定义的 5 种状态。现在再回想一下刚才的问题：怎样判断报文是否是为了回应之前发出的报文。</p> <p>刚才举例的问题即可使用 state 扩展模块解决：放行状态为 <code>ESTABLISHED</code> 的报文。因为如果报文的状态为 <code>ESTABLISHED</code>，那么报文肯定是之前已发报文的回应。如果你还不放心，可以将状态为 <code>RELATED</code> 或 <code>ESTABLISHED</code> 的报文都放行。这样就表示只有回应我们的报文能够通过防火墙，别人主动发送过来的新报文无法通过防火墙，示例如下。</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>root@ubuntu:~<span class="token comment"># ifconfig | awk '/inet / {print $1,$2}'</span>
inet <span class="token number">192.168</span>.44.2
inet <span class="token number">127.0</span>.0.1
root@ubuntu:~<span class="token comment"># iptables -F</span>
root@ubuntu:~<span class="token comment"># iptables -I INPUT -m state --state RELATED,ESTABLISHED  -j ACCEPT</span>
root@ubuntu:~<span class="token comment"># iptables -A INPUT -j REJECT</span>
root@ubuntu:~<span class="token comment"># iptables -L INPUT</span>
Chain INPUT <span class="token punctuation">(</span>policy ACCEPT<span class="token punctuation">)</span>
target     prot opt <span class="token builtin class-name">source</span>               destination         
ACCEPT     all  --  anywhere             anywhere             state RELATED,ESTABLISHED
REJECT     all  --  anywhere             anywhere             reject-with icmp-port-unreachable
root@ubuntu:~<span class="token comment"># ssh 192.168.44.1</span>
The authenticity of <span class="token function">host</span> <span class="token string">'192.168.44.1 (192.168.44.1)'</span> can't be established.
ECDSA key fingerprint is SHA256:zNpI2HXzTZMSMnTe+BlKXoFjD/3JuTs8MWRxCyNOKgQ.
Are you sure you want to <span class="token builtin class-name">continue</span> connecting <span class="token punctuation">(</span>yes/no/<span class="token punctuation">[</span>fingerprint<span class="token punctuation">]</span><span class="token punctuation">)</span>? ^C
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><p>当前主机 IP 为 <code>192.168.44.2</code>。放行 <code>ESTABLISHED</code> 与 <code>RELATED</code> 状态的包以后，并没有影响通过本机远程 SSH 到 IP 为 <code>192.168.44.1</code> 的主机，但是无法从 <code>192.168.44.1</code> 使用 22 端口主动连接到 <code>192.168.44.2</code>。<code>192.168.44.1</code> 尝试链接时触发的错误如下</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token function">ssh</span> <span class="token number">192.168</span>.44.2
ssh: connect to <span class="token function">host</span> <span class="token number">192.168</span>.44.2 port <span class="token number">22</span>: Connection refused
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>对于其他端口与 IP 来说也是相同的。可以从 <code>192.168.44.2</code> 主动发送报文，并且能够收到响应报文，但是其他主机并不能主动向 <code>192.168.44.2</code> 发起请求。</p> <h2 id="参考文献"><a href="#参考文献" class="header-anchor">#</a> 参考文献</h2> <ul><li><a href="http://www.zsythink.net/archives/1597" target="_blank" rel="noopener noreferrer">iptables详解（8）：iptables扩展模块之state扩展<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></section> <footer class="page-edit"><!----> <!----></footer> <!----> <div class="comments-wrapper"><!----></div></main></div> <!----></div> <ul class="sub-sidebar sub-sidebar-wrapper" style="width:12rem;" data-v-b57cc07c data-v-7dd95ae2><li class="level-2" data-v-b57cc07c><a href="/iptables-08-extended-modules-state/#背景" class="sidebar-link reco-side-背景" data-v-b57cc07c>背景</a></li><li class="level-2" data-v-b57cc07c><a href="/iptables-08-extended-modules-state/#state-拓展模块" class="sidebar-link reco-side-state-拓展模块" data-v-b57cc07c>state 拓展模块</a></li><li class="level-2" data-v-b57cc07c><a href="/iptables-08-extended-modules-state/#参考文献" class="sidebar-link reco-side-参考文献" data-v-b57cc07c>参考文献</a></li></ul></div></div></div><div class="global-ui"><div class="back-to-ceiling" style="right:1rem;bottom:6rem;width:2.5rem;height:2.5rem;border-radius:.25rem;line-height:2.5rem;display:none;" data-v-c6073ba8 data-v-c6073ba8><svg t="1574745035067" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="5404" class="icon" data-v-c6073ba8><path d="M526.60727968 10.90185116a27.675 27.675 0 0 0-29.21455937 0c-131.36607665 82.28402758-218.69155461 228.01873535-218.69155402 394.07834331a462.20625001 462.20625001 0 0 0 5.36959153 69.94390903c1.00431239 6.55289093-0.34802892 13.13561351-3.76865779 18.80351572-32.63518765 54.11355614-51.75690182 118.55860487-51.7569018 187.94566865a371.06718723 371.06718723 0 0 0 11.50484808 91.98906777c6.53300375 25.50556257 41.68394495 28.14064038 52.69160883 4.22606766 17.37162448-37.73630017 42.14135425-72.50938081 72.80769204-103.21549295 2.18761121 3.04276886 4.15646224 6.24463696 6.40373557 9.22774369a1871.4375 1871.4375 0 0 0 140.04691725 5.34970492 1866.36093723 1866.36093723 0 0 0 140.04691723-5.34970492c2.24727335-2.98310674 4.21612437-6.18497483 6.3937923-9.2178004 30.66633723 30.70611158 55.4360664 65.4791928 72.80769147 103.21549355 11.00766384 23.91457269 46.15860503 21.27949489 52.69160879-4.22606768a371.15156223 371.15156223 0 0 0 11.514792-91.99901164c0-69.36717486-19.13165746-133.82216804-51.75690182-187.92578088-3.42062944-5.66790279-4.76302748-12.26056868-3.76865837-18.80351632a462.20625001 462.20625001 0 0 0 5.36959269-69.943909c-0.00994388-166.08943902-87.32547796-311.81420293-218.6915546-394.09823051zM605.93803103 357.87693858a93.93749974 93.93749974 0 1 1-187.89594924 6.1e-7 93.93749974 93.93749974 0 0 1 187.89594924-6.1e-7z" p-id="5405" data-v-c6073ba8></path><path d="M429.50777625 765.63860547C429.50777625 803.39355007 466.44236686 1000.39046097 512.00932183 1000.39046097c45.56695499 0 82.4922232-197.00623328 82.5015456-234.7518555 0-37.75494459-36.9345906-68.35043303-82.4922232-68.34111062-45.57627738-0.00932239-82.52019037 30.59548842-82.51086798 68.34111062z" p-id="5406" data-v-c6073ba8></path></svg></div></div></div>
    <script src="/assets/js/app.2124bf24.js" defer></script><script src="/assets/js/3.944fac0d.js" defer></script><script src="/assets/js/1.c30a1333.js" defer></script><script src="/assets/js/70.a647f8ad.js" defer></script>
  </body>
</html>
