<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>[blog os] 07. 硬件中断 | sammyne</title>
    <meta name="generator" content="VuePress 1.8.2">
    <link rel="icon" href="/favicon.ico">
    <meta name="description" content="Just playing around :)">
    <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no">
    
    <link rel="preload" href="/assets/css/0.styles.49bc6dee.css" as="style"><link rel="preload" href="/assets/js/app.6731dc6d.js" as="script"><link rel="preload" href="/assets/js/3.3f52b992.js" as="script"><link rel="preload" href="/assets/js/1.86295094.js" as="script"><link rel="preload" href="/assets/js/21.cbf78bb1.js" as="script"><link rel="prefetch" href="/assets/js/10.1038f603.js"><link rel="prefetch" href="/assets/js/11.96eec3c9.js"><link rel="prefetch" href="/assets/js/12.d28f2fe1.js"><link rel="prefetch" href="/assets/js/13.42ab1ca0.js"><link rel="prefetch" href="/assets/js/14.051d7969.js"><link rel="prefetch" href="/assets/js/15.4ed924b6.js"><link rel="prefetch" href="/assets/js/16.2316213b.js"><link rel="prefetch" href="/assets/js/17.8a6b7ba1.js"><link rel="prefetch" href="/assets/js/18.79ea8cf4.js"><link rel="prefetch" href="/assets/js/19.3141bf59.js"><link rel="prefetch" href="/assets/js/20.deaa9f14.js"><link rel="prefetch" href="/assets/js/22.d6a5c657.js"><link rel="prefetch" href="/assets/js/23.f04a9f25.js"><link rel="prefetch" href="/assets/js/24.aa0b9a4f.js"><link rel="prefetch" href="/assets/js/25.e9b27a2a.js"><link rel="prefetch" href="/assets/js/26.6a774f88.js"><link rel="prefetch" href="/assets/js/27.ed0fc0f9.js"><link rel="prefetch" href="/assets/js/28.a397c3d7.js"><link rel="prefetch" href="/assets/js/29.bc4b043d.js"><link rel="prefetch" href="/assets/js/30.213d982d.js"><link rel="prefetch" href="/assets/js/31.017c6b4e.js"><link rel="prefetch" href="/assets/js/32.3c39cb85.js"><link rel="prefetch" href="/assets/js/33.2d74623b.js"><link rel="prefetch" href="/assets/js/34.79a608bc.js"><link rel="prefetch" href="/assets/js/35.908be713.js"><link rel="prefetch" href="/assets/js/36.9c2eb74c.js"><link rel="prefetch" href="/assets/js/37.e2cb8a6e.js"><link rel="prefetch" href="/assets/js/38.3fccd1be.js"><link rel="prefetch" href="/assets/js/39.edd23d2d.js"><link rel="prefetch" href="/assets/js/4.427febfc.js"><link rel="prefetch" href="/assets/js/40.188ea825.js"><link rel="prefetch" href="/assets/js/41.b1c0ffa7.js"><link rel="prefetch" href="/assets/js/42.91d363cd.js"><link rel="prefetch" href="/assets/js/43.aa239f52.js"><link rel="prefetch" href="/assets/js/44.2546e0e4.js"><link rel="prefetch" href="/assets/js/45.2dbb3db7.js"><link rel="prefetch" href="/assets/js/46.3064f272.js"><link rel="prefetch" href="/assets/js/47.6ab91381.js"><link rel="prefetch" href="/assets/js/48.f58019a7.js"><link rel="prefetch" href="/assets/js/49.d9d77fae.js"><link rel="prefetch" href="/assets/js/5.3ab3e749.js"><link rel="prefetch" href="/assets/js/50.cb88fead.js"><link rel="prefetch" href="/assets/js/51.5f5eee7e.js"><link rel="prefetch" href="/assets/js/52.ae4e6334.js"><link rel="prefetch" href="/assets/js/53.17db3a12.js"><link rel="prefetch" href="/assets/js/54.a44acc29.js"><link rel="prefetch" href="/assets/js/55.aeaaad9e.js"><link rel="prefetch" href="/assets/js/56.b42ebcb9.js"><link rel="prefetch" href="/assets/js/57.b9fc672e.js"><link rel="prefetch" href="/assets/js/58.aa6443bc.js"><link rel="prefetch" href="/assets/js/59.3a8b21f1.js"><link rel="prefetch" href="/assets/js/6.905f5193.js"><link rel="prefetch" href="/assets/js/60.7e1e0d62.js"><link rel="prefetch" href="/assets/js/61.2d82fc74.js"><link rel="prefetch" href="/assets/js/62.e5817de7.js"><link rel="prefetch" href="/assets/js/63.9c45d434.js"><link rel="prefetch" href="/assets/js/64.7869c4d8.js"><link rel="prefetch" href="/assets/js/65.47ff3714.js"><link rel="prefetch" href="/assets/js/66.83077b8c.js"><link rel="prefetch" href="/assets/js/67.fa18d1cd.js"><link rel="prefetch" href="/assets/js/68.debb8be6.js"><link rel="prefetch" href="/assets/js/69.1d7114ab.js"><link rel="prefetch" href="/assets/js/7.7171cbe2.js"><link rel="prefetch" href="/assets/js/70.9b795da4.js"><link rel="prefetch" href="/assets/js/71.2a904461.js"><link rel="prefetch" href="/assets/js/72.fb1ddcda.js"><link rel="prefetch" href="/assets/js/73.00835c21.js"><link rel="prefetch" href="/assets/js/74.c6fd062a.js"><link rel="prefetch" href="/assets/js/75.9a67ecba.js"><link rel="prefetch" href="/assets/js/76.160be0b9.js"><link rel="prefetch" href="/assets/js/77.eca56bef.js"><link rel="prefetch" href="/assets/js/78.5198658f.js"><link rel="prefetch" href="/assets/js/79.0055d088.js"><link rel="prefetch" href="/assets/js/8.0b3d33ad.js"><link rel="prefetch" href="/assets/js/80.2804a168.js"><link rel="prefetch" href="/assets/js/81.0c6113a4.js"><link rel="prefetch" href="/assets/js/82.2480233f.js"><link rel="prefetch" href="/assets/js/83.d4e662be.js"><link rel="prefetch" href="/assets/js/84.806f671f.js"><link rel="prefetch" href="/assets/js/85.eab149d6.js"><link rel="prefetch" href="/assets/js/86.53eaef8b.js"><link rel="prefetch" href="/assets/js/87.939a3a36.js"><link rel="prefetch" href="/assets/js/88.1d9db98a.js"><link rel="prefetch" href="/assets/js/89.e73f74c7.js"><link rel="prefetch" href="/assets/js/9.4fb731d8.js">
    <link rel="stylesheet" href="/assets/css/0.styles.49bc6dee.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container no-sidebar" data-v-1156296a><div data-v-1156296a><div id="loader-wrapper" class="loading-wrapper" data-v-d48f4d20 data-v-1156296a data-v-1156296a><div class="loader-main" data-v-d48f4d20><div data-v-d48f4d20></div><div data-v-d48f4d20></div><div data-v-d48f4d20></div><div data-v-d48f4d20></div></div> <!----> <!----></div> <div class="password-shadow password-wrapper-out" style="display:none;" data-v-4e82dffc data-v-1156296a data-v-1156296a><h3 class="title" data-v-4e82dffc data-v-4e82dffc>sammyne</h3> <p class="description" data-v-4e82dffc data-v-4e82dffc>Just playing around :)</p> <label id="box" class="inputBox" data-v-4e82dffc data-v-4e82dffc><input type="password" value="" data-v-4e82dffc> <span data-v-4e82dffc>Konck! Knock!</span> <button data-v-4e82dffc>OK</button></label> <div class="footer" data-v-4e82dffc data-v-4e82dffc><span data-v-4e82dffc><i class="iconfont reco-theme" data-v-4e82dffc></i> <a target="blank" href="https://vuepress-theme-reco.recoluan.com" data-v-4e82dffc>vuePress-theme-reco</a></span> <span data-v-4e82dffc><i class="iconfont reco-copyright" data-v-4e82dffc></i> <a data-v-4e82dffc><span data-v-4e82dffc>sammyne</span>
            
          <span data-v-4e82dffc>2020 - </span>
          2021
        </a></span></div></div> <div class="hide" data-v-1156296a><header class="navbar" data-v-1156296a><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/logo.svg" alt="sammyne" class="logo"> <span class="site-name">sammyne</span></a> <div class="links"><div class="color-picker"><a class="color-button"><i class="iconfont reco-color"></i></a> <div class="color-picker-menu" style="display:none;"><div class="mode-options"><h4 class="title">Choose mode</h4> <ul class="color-mode-options"><li class="dark">dark</li><li class="auto active">auto</li><li class="light">light</li></ul></div></div></div> <div class="search-box"><i class="iconfont reco-search"></i> <input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link"><i class="iconfont reco-home"></i>
  首页
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-category"></i>
      分类
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/categories/dev/" class="nav-link"><i class="undefined"></i>
  dev
</a></li><li class="dropdown-item"><!----> <a href="/categories/crypto/" class="nav-link"><i class="undefined"></i>
  crypto
</a></li><li class="dropdown-item"><!----> <a href="/categories/programming/" class="nav-link"><i class="undefined"></i>
  programming
</a></li><li class="dropdown-item"><!----> <a href="/categories/tee/" class="nav-link"><i class="undefined"></i>
  tee
</a></li><li class="dropdown-item"><!----> <a href="/categories/os/" class="nav-link"><i class="undefined"></i>
  os
</a></li><li class="dropdown-item"><!----> <a href="/categories/engineering/" class="nav-link"><i class="undefined"></i>
  engineering
</a></li><li class="dropdown-item"><!----> <a href="/categories/tool/" class="nav-link"><i class="undefined"></i>
  tool
</a></li><li class="dropdown-item"><!----> <a href="/categories/language/" class="nav-link"><i class="undefined"></i>
  language
</a></li><li class="dropdown-item"><!----> <a href="/categories/decentralization/" class="nav-link"><i class="undefined"></i>
  decentralization
</a></li><li class="dropdown-item"><!----> <a href="/categories/architecture/" class="nav-link"><i class="undefined"></i>
  architecture
</a></li><li class="dropdown-item"><!----> <a href="/categories/network/" class="nav-link"><i class="undefined"></i>
  network
</a></li><li class="dropdown-item"><!----> <a href="/categories/software engineering/" class="nav-link"><i class="undefined"></i>
  software engineering
</a></li><li class="dropdown-item"><!----> <a href="/categories/notes/" class="nav-link"><i class="undefined"></i>
  notes
</a></li></ul></div></div><div class="nav-item"><a href="/tag/" class="nav-link"><i class="iconfont reco-tag"></i>
  标签
</a></div><div class="nav-item"><a href="/timeline/" class="nav-link"><i class="iconfont reco-date"></i>
  时间轴
</a></div><div class="nav-item"><a href="https://github.com/sammyne" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="iconfont reco-github"></i>
  Github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav></div></header> <div class="sidebar-mask" data-v-1156296a></div> <aside class="sidebar" data-v-1156296a><div class="personal-info-wrapper" data-v-828910c6 data-v-1156296a><img src="/avatar.png" alt="author-avatar" class="personal-img" data-v-828910c6> <h3 class="name" data-v-828910c6>
    sammyne
  </h3> <div class="num" data-v-828910c6><div data-v-828910c6><h3 data-v-828910c6>79</h3> <h6 data-v-828910c6>Articles</h6></div> <div data-v-828910c6><h3 data-v-828910c6>43</h3> <h6 data-v-828910c6>Tags</h6></div></div> <ul class="social-links" data-v-828910c6></ul> <hr data-v-828910c6></div> <nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link"><i class="iconfont reco-home"></i>
  首页
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-category"></i>
      分类
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/categories/dev/" class="nav-link"><i class="undefined"></i>
  dev
</a></li><li class="dropdown-item"><!----> <a href="/categories/crypto/" class="nav-link"><i class="undefined"></i>
  crypto
</a></li><li class="dropdown-item"><!----> <a href="/categories/programming/" class="nav-link"><i class="undefined"></i>
  programming
</a></li><li class="dropdown-item"><!----> <a href="/categories/tee/" class="nav-link"><i class="undefined"></i>
  tee
</a></li><li class="dropdown-item"><!----> <a href="/categories/os/" class="nav-link"><i class="undefined"></i>
  os
</a></li><li class="dropdown-item"><!----> <a href="/categories/engineering/" class="nav-link"><i class="undefined"></i>
  engineering
</a></li><li class="dropdown-item"><!----> <a href="/categories/tool/" class="nav-link"><i class="undefined"></i>
  tool
</a></li><li class="dropdown-item"><!----> <a href="/categories/language/" class="nav-link"><i class="undefined"></i>
  language
</a></li><li class="dropdown-item"><!----> <a href="/categories/decentralization/" class="nav-link"><i class="undefined"></i>
  decentralization
</a></li><li class="dropdown-item"><!----> <a href="/categories/architecture/" class="nav-link"><i class="undefined"></i>
  architecture
</a></li><li class="dropdown-item"><!----> <a href="/categories/network/" class="nav-link"><i class="undefined"></i>
  network
</a></li><li class="dropdown-item"><!----> <a href="/categories/software engineering/" class="nav-link"><i class="undefined"></i>
  software engineering
</a></li><li class="dropdown-item"><!----> <a href="/categories/notes/" class="nav-link"><i class="undefined"></i>
  notes
</a></li></ul></div></div><div class="nav-item"><a href="/tag/" class="nav-link"><i class="iconfont reco-tag"></i>
  标签
</a></div><div class="nav-item"><a href="/timeline/" class="nav-link"><i class="iconfont reco-date"></i>
  时间轴
</a></div><div class="nav-item"><a href="https://github.com/sammyne" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="iconfont reco-github"></i>
  Github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav> <!----> </aside> <div class="password-shadow password-wrapper-in" style="display:none;" data-v-4e82dffc data-v-1156296a><h3 class="title" data-v-4e82dffc data-v-4e82dffc>[blog os] 07. 硬件中断</h3> <!----> <label id="box" class="inputBox" data-v-4e82dffc data-v-4e82dffc><input type="password" value="" data-v-4e82dffc> <span data-v-4e82dffc>Konck! Knock!</span> <button data-v-4e82dffc>OK</button></label> <div class="footer" data-v-4e82dffc data-v-4e82dffc><span data-v-4e82dffc><i class="iconfont reco-theme" data-v-4e82dffc></i> <a target="blank" href="https://vuepress-theme-reco.recoluan.com" data-v-4e82dffc>vuePress-theme-reco</a></span> <span data-v-4e82dffc><i class="iconfont reco-copyright" data-v-4e82dffc></i> <a data-v-4e82dffc><span data-v-4e82dffc>sammyne</span>
            
          <span data-v-4e82dffc>2020 - </span>
          2021
        </a></span></div></div> <div data-v-1156296a><main class="page"><section><div class="page-title"><h1 class="title">[blog os] 07. 硬件中断</h1> <div data-v-1ff7123e><i class="iconfont reco-account" data-v-1ff7123e><span data-v-1ff7123e>sammyne</span></i> <i class="iconfont reco-date" data-v-1ff7123e><span data-v-1ff7123e>7/27/2020</span></i> <i class="iconfont reco-eye" data-v-1ff7123e><span id="/blog-os/blog-os-07-hardware-interrupts/" data-flag-title="Your Article Title" class="leancloud-visitors" data-v-1ff7123e><a class="leancloud-visitors-count" style="font-size:.9rem;font-weight:normal;color:#999;"></a></span></i> <i class="tags iconfont reco-tag" data-v-1ff7123e><span class="tag-item" data-v-1ff7123e>blog_os</span><span class="tag-item" data-v-1ff7123e>rust</span></i></div></div> <div class="theme-reco-content content__default"><blockquote><p>原文：<a href="https://os.phil-opp.com/hardware-interrupts/" target="_blank" rel="noopener noreferrer">Hardware Interrupts<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p></blockquote> <p>本文将会配置可编程的中断控制器，用于正确地将硬件中断导向 CPU。和之前的异常处理函数类似，为了处理这些中断，我们需要往中断描述符表添加新表项。我们将会学到如何获取周期性的时钟中断和从键盘获取输入。</p> <p>此博客在 <a href="https://github.com/phil-opp/blog_os" target="_blank" rel="noopener noreferrer">GitHub<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 上公开开发。如果您有任何问题或疑问，请在那边打开一个 issue。 您也可以在 <a href="#valine">底部</a> 发表评论。这篇文章的完整源代码可以在 <a href="https://github.com/sammyne/blog-os-cn/tree/master/07-hardware-interrupts" target="_blank" rel="noopener noreferrer">blog-os-cn/07-hardware-interrupts<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 找到。</p> <h2 id="概览"><a href="#概览" class="header-anchor">#</a> 概览</h2> <p>中断提供了从附带的硬件设备通知 CPU 的途径。所以与其让内核为了定期检查键盘输入的新字符（这个过程称为 <a href="https://en.wikipedia.org/wiki/Polling_(computer_science)" target="_blank" rel="noopener noreferrer"><em>轮询</em><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>），键盘可以在每次按键时通知内核。因为内核只需要在事件发生时采取行动，所以这样要高效得多。由于内核可以立即响应而不用等到下一次轮询，这也缩短了响应时间。</p> <p>将所有硬件设备直连到 CPU 是不可能的。一个独立的 <em>中断控制器</em> 从所有设备收集中断，然后通知 CPU：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>                                    ____________             _____
               Timer ------------&gt; |            |           |     |
               Keyboard ---------&gt; | Interrupt  |---------&gt; | CPU |
               Other Hardware ---&gt; | Controller |           |_____|
               Etc. -------------&gt; |____________|

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>大部分中断控制器都是可编程的，这意味着它们支持不同优先级的中断。例如，可编程使得可以赋予时钟中断比键盘中断更高的优先级，来确保准确的时钟同步。</p> <p>和异常不同的是，硬件中断是 <em>异步</em> 触发的。也就是说它们完全独立于当前执行的代码，随时触发。这样给内核引入了某种形式的并发，少不了潜在的并发相关 bug。Rust 严格的所有权模型这时就排上了用场，它禁止全局可修改的状态。然而，后续文章我们可以看到死锁还是可能的。</p> <h2 id="_8259-pic"><a href="#_8259-pic" class="header-anchor">#</a> 8259 PIC</h2> <p><a href="https://en.wikipedia.org/wiki/Intel_8259" target="_blank" rel="noopener noreferrer">Intel 8259<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 是 1976 年出现的一个可编程的中断控制器（PIC）。虽然很久之前就被新版的 <a href="https://en.wikipedia.org/wiki/Intel_APIC_Architecture" target="_blank" rel="noopener noreferrer">APIC<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 取代了，但是当代系统依然支持它的接口以保持向后兼容性。8259 PIC 的配置要比 APIC 来得简单很多，所以我们用它来入门中断，后续文章再切换到 APIC。</p> <p>8259 有 8 条中断线路，多条用于和 CPU 通信。那时的典型系统都会配备两个 8259 PIC 实例，一个主 PIC 和一个副 PIC 连接到主 PIC 的一条中断线路。</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>                     ____________                          ____________
Real Time Clock --&gt; |            |   Timer -------------&gt; |            |
ACPI -------------&gt; |            |   Keyboard-----------&gt; |            |      _____
Available --------&gt; | Secondary  |----------------------&gt; | Primary    |     |     |
Available --------&gt; | Interrupt  |   Serial Port 2 -----&gt; | Interrupt  |---&gt; | CPU |
Mouse ------------&gt; | Controller |   Serial Port 1 -----&gt; | Controller |     |_____|
Co-Processor -----&gt; |            |   Parallel Port 2/3 -&gt; |            |
Primary ATA ------&gt; |            |   Floppy disk -------&gt; |            |
Secondary ATA ----&gt; |____________|   Parallel Port 1----&gt; |____________|
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>上图显示了中断线路的典型设置。可以看到 15 条线路的大多数都有固定的映射，例如副 PIC 的 4 号线连接到鼠标。</p> <p>每个控制器都可以通过两个 <a href="/blog-os/blog-os-07-hardware-interrupts/@/second-edition/posts/04-testing/#i-o-ports">I/O 端口</a> 配置，一个“命令”端口和一个“数据”端口。对于主控制器，命名和数据端口分别为 <code>0x20</code> 和 <code>0x21</code>。对于副控制器，命令和数据端口则分别为 <code>0xa0</code> 和 <code>0xa1</code>。更多关于如何设置 PIC 的信息参见 <a href="https://wiki.osdev.org/8259_PIC" target="_blank" rel="noopener noreferrer">osdev.org 上的文章<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <h3 id="实现"><a href="#实现" class="header-anchor">#</a> 实现</h3> <p>由于会把范围在 0-15 的中断向量值传给 CPU，PIC 的默认设置用处不大。这些值已经被 CPU 异常占用了，例如 8 对应到二级异常。为了解决重叠问题，我们需要将 PIC 中断重新映射到不同的值。确切的值范围不重要，只要它们和异常的不重叠就行，但是通常会选择 32-47，因为这些是没被 32 个异常占用的首批可用值。</p> <p>配置的形式为向 PIC 的命令和数据端口写入特殊值。好在已有的 <a href="https://docs.rs/pic8259_simple/0.2.0/pic8259_simple/" target="_blank" rel="noopener noreferrer"><code>pic8259_simple</code><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 包可以排上用场，所以我们不需要手码初始化流程。如果对其原理感兴趣的话，可以阅读 <a href="https://docs.rs/crate/pic8259_simple/0.2.0/source/src/lib.rs" target="_blank" rel="noopener noreferrer">它的源码<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>。这是个相当小且文档注释良好的包。</p> <p>为了将其添加为依赖，我们往项目添加以下片段：</p> <div class="language-toml line-numbers-mode"><pre class="language-toml"><code><span class="token comment"># in Cargo.toml</span>

<span class="token punctuation">[</span><span class="token table class-name">dependencies</span><span class="token punctuation">]</span>
<span class="token key property">pic8259_simple</span> <span class="token punctuation">=</span> <span class="token string">&quot;0.2.0&quot;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>这个包提供的主要抽象接口是 <a href="https://docs.rs/pic8259_simple/0.2.0/pic8259_simple/struct.ChainedPics.html" target="_blank" rel="noopener noreferrer"><code>ChainedPics</code><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 结构体，这个结构体表示前面看到的主/副 PIC 布局。它的预期用法如下：</p> <div class="language-rust line-numbers-mode"><pre class="language-rust"><code><span class="token comment">// in src/interrupts.rs</span>

<span class="token keyword">use</span> <span class="token namespace">pic8259_simple<span class="token punctuation">::</span></span><span class="token class-name">ChainedPics</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> spin<span class="token punctuation">;</span>

<span class="token keyword">pub</span> <span class="token keyword">const</span> <span class="token constant">PIC_1_OFFSET</span><span class="token punctuation">:</span> <span class="token keyword">u8</span> <span class="token operator">=</span> <span class="token number">32</span><span class="token punctuation">;</span>
<span class="token keyword">pub</span> <span class="token keyword">const</span> <span class="token constant">PIC_2_OFFSET</span><span class="token punctuation">:</span> <span class="token keyword">u8</span> <span class="token operator">=</span> <span class="token constant">PIC_1_OFFSET</span> <span class="token operator">+</span> <span class="token number">8</span><span class="token punctuation">;</span>

<span class="token keyword">pub</span> <span class="token keyword">static</span> <span class="token constant">PICS</span><span class="token punctuation">:</span> <span class="token namespace">spin<span class="token punctuation">::</span></span><span class="token class-name">Mutex</span><span class="token operator">&lt;</span><span class="token class-name">ChainedPics</span><span class="token operator">&gt;</span> <span class="token operator">=</span>
    <span class="token namespace">spin<span class="token punctuation">::</span></span><span class="token class-name">Mutex</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token keyword">unsafe</span> <span class="token punctuation">{</span> <span class="token class-name">ChainedPics</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token constant">PIC_1_OFFSET</span><span class="token punctuation">,</span> <span class="token constant">PIC_2_OFFSET</span><span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>如前面解释的那样，我们把 PIC 的值范围设为 32-47。将 <code>ChainedPics</code> 结构体包裹在 <code>Mutex</code> 使得我们可以安全地得到修改权限（借助 <a href="https://docs.rs/spin/0.5.2/spin/struct.Mutex.html#method.lock" target="_blank" rel="noopener noreferrer"><code>lock</code> 方法<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>），这在后续步骤会用上。因为传入错误的偏移会导致未定义行为，所以 <code>ChainedPics::new</code> 函数是不安全的。</p> <p>现在就可以在 <code>init</code> 函数中初始化 8259 PIC 了：</p> <div class="language-rust line-numbers-mode"><pre class="language-rust"><code><span class="token comment">// in src/lib.rs</span>

<span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token namespace">gdt<span class="token punctuation">::</span></span><span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token namespace">interrupts<span class="token punctuation">::</span></span><span class="token function">init_idt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">unsafe</span> <span class="token punctuation">{</span> <span class="token namespace">interrupts<span class="token punctuation">::</span></span><span class="token constant">PICS</span><span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">initialize</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">;</span> <span class="token comment">// new</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>调用 <a href="https://docs.rs/pic8259_simple/0.2.0/pic8259_simple/struct.ChainedPics.html#method.initialize" target="_blank" rel="noopener noreferrer"><code>initialize</code><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 函数执行 PIC 的初始化。和 <code>ChainedPics::new</code> 函数类似，如果配置错误的 PIC 会触发未定义行为，所以这个函数也是不安全的。</p> <p>如果一切正常的话，执行 <code>cargo run</code> 后我们应该能够继续看到 &quot;It did not crash&quot; 的字样。</p> <h2 id="启用中断"><a href="#启用中断" class="header-anchor">#</a> 启用中断</h2> <p>到目前为止，由于 CPU 的配置仍然禁用中断，所以不会发生任何事。这意味着 CPU 根本不会监听中断控制器，所以没有任何中断能够到达 CPU。让我们稍作调整：</p> <div class="language-rust line-numbers-mode"><pre class="language-rust"><code><span class="token comment">// in src/lib.rs</span>

<span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token namespace">gdt<span class="token punctuation">::</span></span><span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token namespace">interrupts<span class="token punctuation">::</span></span><span class="token function">init_idt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">unsafe</span> <span class="token punctuation">{</span> <span class="token namespace">interrupts<span class="token punctuation">::</span></span><span class="token constant">PICS</span><span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">initialize</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token namespace">x86_64<span class="token punctuation">::</span>instructions<span class="token punctuation">::</span>interrupts<span class="token punctuation">::</span></span><span class="token function">enable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token comment">// new</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p><code>x86_64</code> 包的 <code>interrupts::enable</code> 函数执行特殊的 <code>sti</code> 指令（&quot;set interrupts&quot;）来启用外部中断。现在执行 <code>cargo run</code> 可以看到以下二级异常：</p> <p><img src="data:image/png;base64,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" alt="QEMU 由于硬件计时器显示 "></p> <p>二级异常触发的原因是硬件计算器（更确切地说是 <a href="https://en.wikipedia.org/wiki/Intel_8259" target="_blank" rel="noopener noreferrer">Intel 8259<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 的）默认是启用的，所以一旦启用中断，我们就会收到时钟中断。由于没有为其定义处理函数，所以二级异常被触发了。</p> <h2 id="处理时钟中断"><a href="#处理时钟中断" class="header-anchor">#</a> 处理时钟中断</h2> <p>由 <a href="#_8259-pic">上图</a> 可知，计时器使用了主 PIC 的 0 号线路。这意味着到达 CPU 时的值为 32（0 + 偏移）。我们用一个 <code>InterruptIndex</code> 枚举类型存储它，而不是硬编码这个索引 32：</p> <div class="language-rust line-numbers-mode"><pre class="language-rust"><code><span class="token comment">// in src/interrupts.rs</span>

<span class="token attribute attr-name">#[derive(Debug, Clone, Copy)]</span>
<span class="token attribute attr-name">#[repr(u8)]</span>
<span class="token keyword">pub</span> <span class="token keyword">enum</span> <span class="token type-definition class-name">InterruptIndex</span> <span class="token punctuation">{</span>
    <span class="token class-name">Timer</span> <span class="token operator">=</span> <span class="token constant">PIC_1_OFFSET</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token keyword">impl</span> <span class="token class-name">InterruptIndex</span> <span class="token punctuation">{</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">as_u8</span><span class="token punctuation">(</span><span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token keyword">u8</span> <span class="token punctuation">{</span>
        <span class="token keyword">self</span> <span class="token keyword">as</span> <span class="token keyword">u8</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">fn</span> <span class="token function-definition function">as_usize</span><span class="token punctuation">(</span><span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token keyword">usize</span> <span class="token punctuation">{</span>
        <span class="token keyword">usize</span><span class="token punctuation">::</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token keyword">self</span><span class="token punctuation">.</span><span class="token function">as_u8</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><p>这是个 <a href="https://doc.rust-lang.org/reference/items/enumerations.html#custom-discriminant-values-for-fieldless-enumerations" target="_blank" rel="noopener noreferrer">类 C 的枚举类型<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>，所以我们可以直接注明每个枚举值的索引。<code>repr(u8)</code> 属性规定每个枚举值用一个 <code>u8</code> 表示。将来我们还会为其他中断添加更多枚举值。</p> <p>现在可以为时钟中断添加处理函数了：</p> <div class="language-rust line-numbers-mode"><pre class="language-rust"><code><span class="token comment">// in src/interrupts.rs</span>

<span class="token keyword">use</span> <span class="token keyword">crate</span><span class="token module-declaration namespace"><span class="token punctuation">::</span>print</span><span class="token punctuation">;</span>

<span class="token macro property">lazy_static!</span> <span class="token punctuation">{</span>
    <span class="token keyword">static</span> <span class="token keyword">ref</span> <span class="token constant">IDT</span><span class="token punctuation">:</span> <span class="token class-name">InterruptDescriptorTable</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> <span class="token keyword">mut</span> idt <span class="token operator">=</span> <span class="token class-name">InterruptDescriptorTable</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        idt<span class="token punctuation">.</span>breakpoint<span class="token punctuation">.</span><span class="token function">set_handler_fn</span><span class="token punctuation">(</span>breakpoint_handler<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">[</span>…<span class="token punctuation">]</span>
        idt<span class="token punctuation">[</span><span class="token class-name">InterruptIndex</span><span class="token punctuation">::</span><span class="token class-name">Timer</span><span class="token punctuation">.</span><span class="token function">as_usize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
            <span class="token punctuation">.</span><span class="token function">set_handler_fn</span><span class="token punctuation">(</span>timer_interrupt_handler<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// new</span>

        idt
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">extern</span> <span class="token string">&quot;x86-interrupt&quot;</span> <span class="token keyword">fn</span> <span class="token function-definition function">timer_interrupt_handler</span><span class="token punctuation">(</span>
    _stack_frame<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token class-name">InterruptStackFrame</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token macro property">print!</span><span class="token punctuation">(</span><span class="token string">&quot;.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br></div></div><p>因为 CPU 对异常和外部中断的响应是一样的（两者的唯一区别是某些异常会压入一个错误码），所以 <code>timer_interrupt_handler</code> 的函数签名和异常处理函数一样。<a href="https://docs.rs/x86_64/0.12.1/x86_64/structures/idt/struct.InterruptDescriptorTable.html" target="_blank" rel="noopener noreferrer"><code>InterruptDescriptorTable</code><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 结构体实现了 <a href="https://doc.rust-lang.org/core/ops/trait.IndexMut.html" target="_blank" rel="noopener noreferrer"><code>IndexMut</code><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> trait，所以我们可以直接利用数组索引语法访问各个元素。</p> <p>时钟中断处理函数往屏幕打印一个点。由于时钟中断时周期性发生的，我们应该能够看到每个时钟周期会打印多一个点。然而，运行结果显示只打印了一个点：</p> <p><img src="data:image/png;base64,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" alt="QEMU 只为硬件时钟打印了一个点"></p> <h3 id="中断的结束"><a href="#中断的结束" class="header-anchor">#</a> 中断的结束</h3> <p>原因是 PIC 期望从中断处理函数得到一个明确的 “end of interrupt”（EOI）信号。这个信号告诉控制器中断已被处理，整个系统可以继续接收下一个中断了。所以 PIC 以为我们还在忙着处理第一个时钟中断，耐心地等待到 EOI 信号后再发送下一个中断。</p> <p>发送 EOI 再次用上静态的 <code>PICS</code> 结构体：</p> <div class="language-rust line-numbers-mode"><pre class="language-rust"><code><span class="token comment">// in src/interrupts.rs</span>

<span class="token keyword">extern</span> <span class="token string">&quot;x86-interrupt&quot;</span> <span class="token keyword">fn</span> <span class="token function-definition function">timer_interrupt_handler</span><span class="token punctuation">(</span>
    _stack_frame<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token class-name">InterruptStackFrame</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token macro property">print!</span><span class="token punctuation">(</span><span class="token string">&quot;.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">unsafe</span> <span class="token punctuation">{</span>
        <span class="token constant">PICS</span><span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">notify_end_of_interrupt</span><span class="token punctuation">(</span><span class="token class-name">InterruptIndex</span><span class="token punctuation">::</span><span class="token class-name">Timer</span><span class="token punctuation">.</span><span class="token function">as_u8</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p><code>notify_end_of_interrupt</code> 会确定发送中断的是主 PIC 还是副 PIC，然后使用 <code>command</code> 和 <code>data</code> 端口给相应的控制器发送 EOI 信号。如果副 PIC 发送了中断，因为它连接到主 PIC 的输入线路，所以两个 PIC 都需要被通知。</p> <p>我们需要仔细确认使用正确的中断向量值，否则有可能无意间删掉了未发送的重要中断或者导致系统卡住。这是函数为什么是不安全的原因。</p> <p>现在执行 <code>cargo run</code> 可以看到点会周期性地打印到屏幕上了：</p> <p><img src="/assets/img/qemu-hardware-timer-dots.72b8d6ff.gif" alt="QEMU 打印连续的点，显示硬件时钟"></p> <h3 id="配置计时器"><a href="#配置计时器" class="header-anchor">#</a> 配置计时器</h3> <p>我们使用的硬件计时器被称为 <em>可编程间隔计时器（Progammable Interval Timer）</em> 或者简称 PIT。如其名，我们可以设置两个中断的间隔。由于就快切换到 <a href="https://wiki.osdev.org/APIC_timer" target="_blank" rel="noopener noreferrer">APIC 计时器<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 了，所以具体细节不在此深究，但是 OSDev wiki 有关于 <a href="https://wiki.osdev.org/Programmable_Interval_Timer" target="_blank" rel="noopener noreferrer">配置 PIT<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 的大量相关文章。</p> <h2 id="死锁"><a href="#死锁" class="header-anchor">#</a> 死锁</h2> <p>我们的内核现在有了一定程度的并发：计时器会触发异步中断，所以他们可以随时中断 <code>_start</code> 函数。好在 Rust 的所有权系统在编译时就可以防止多种并发相关的 bug。死锁是其中最著名的一个。如果一个线程试图获取一个绝不会被释放的锁就会触发死锁。那时线程会一直卡住。</p> <p>我们的内核已经可以触发死锁了。如果没有忘记的话，<code>println</code> 宏调用 <code>vga_buffer::_print</code> 函数，这个函数会使用自旋锁 <a href="/blog-os/blog-os-07-hardware-interrupts/@/second-edition/posts/03-vga-text-buffer/#spinlocks">锁定一个全局的 <code>WRITER</code></a>：</p> <div class="language-rust line-numbers-mode"><pre class="language-rust"><code><span class="token comment">// in src/vga_buffer.rs</span>

<span class="token punctuation">[</span>…<span class="token punctuation">]</span>

<span class="token attribute attr-name">#[doc(hidden)]</span>
<span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">_print</span><span class="token punctuation">(</span>args<span class="token punctuation">:</span> <span class="token namespace">fmt<span class="token punctuation">::</span></span><span class="token class-name">Arguments</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">use</span> <span class="token namespace">core<span class="token punctuation">::</span>fmt<span class="token punctuation">::</span></span><span class="token class-name">Write</span><span class="token punctuation">;</span>
    <span class="token constant">WRITER</span><span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">write_fmt</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>这个函数锁定 <code>WRITER</code>，调用它的 <code>write_fmt</code>，会在函数末尾隐式地释放锁。现在假想这么个场景：<code>WRITER</code> 被锁定时，一个中断被触发了，中断处理函数也试图打印一些东西：</p> <table><thead><tr><th>时间戳</th> <th><code>_start</code></th> <th>中断处理函数</th></tr></thead> <tbody><tr><td>0</td> <td>调用 <code>println!</code></td> <td></td></tr> <tr><td>1</td> <td><code>print</code> 锁定 <code>WRITER</code></td> <td></td></tr> <tr><td>2</td> <td></td> <td><strong>中断触发</strong>，处理函数开始运行</td></tr> <tr><td>3</td> <td></td> <td>调用 <code>println!</code></td></tr> <tr><td>4</td> <td></td> <td><code>print</code> 试图锁定 <code>WRITER</code>（已上锁）</td></tr> <tr><td>4</td> <td></td> <td><code>print</code> 试图锁定 <code>WRITER</code>（已上锁）</td></tr> <tr><td>...</td> <td></td> <td>...</td></tr> <tr><td><em>绝不</em></td> <td><em>释放 <code>WRITER</code></em></td> <td></td></tr></tbody></table> <p><code>WRITER</code> 被锁定了，所以中断处理函数会一直等到锁被释放。但是这个释放绝不会发生，因为 <code>_start</code> 函数只会在中断处理函数返回后继续运行。因此，整个系统就卡住了。</p> <h3 id="触发死锁"><a href="#触发死锁" class="header-anchor">#</a> 触发死锁</h3> <p>我们可以在 <code>_start</code> 函数的末尾循环打印一些信息，从而轻易地触发这个死锁：</p> <div class="language-rust line-numbers-mode"><pre class="language-rust"><code><span class="token comment">// in src/main.rs</span>

<span class="token attribute attr-name">#[no_mangle]</span>
<span class="token keyword">pub</span> <span class="token keyword">extern</span> <span class="token string">&quot;C&quot;</span> <span class="token keyword">fn</span> <span class="token function-definition function">_start</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token operator">!</span> <span class="token punctuation">{</span>
    <span class="token punctuation">[</span>…<span class="token punctuation">]</span>
    <span class="token keyword">loop</span> <span class="token punctuation">{</span>
        <span class="token keyword">use</span> <span class="token namespace">blog_os<span class="token punctuation">::</span></span>print<span class="token punctuation">;</span>
        <span class="token macro property">print!</span><span class="token punctuation">(</span><span class="token string">&quot;-&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">// new</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>在 QEMU 里面运行可以得到以下形式的输出：</p> <p><img src="data:image/png;base64,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" alt="QEMU 输出多行横杠并没有点"></p> <p>可以看到第一个时钟中断触发前，只有有限个横杠被打印了。因为时钟中断处理函数试图打印点时被锁死，所以整个系统卡住了。这是我们为什么没有在上面的输出看到点的原因。</p> <p>因为中断是异步触发的，多次运行看到横杠的确切数目也是不定的。这种不确定性使得调试并发相关 bug 非常困难。</p> <h3 id="修复死锁"><a href="#修复死锁" class="header-anchor">#</a> 修复死锁</h3> <p>为了避免这个死锁，<code>Mutex</code> 被锁定期间禁止中断：</p> <div class="language-rust line-numbers-mode"><pre class="language-rust"><code><span class="token comment">// in src/vga_buffer.rs</span>

<span class="token comment">/// Prints the given formatted string to the VGA text buffer</span>
<span class="token comment">/// through the global `WRITER` instance.</span>
<span class="token attribute attr-name">#[doc(hidden)]</span>
<span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">_print</span><span class="token punctuation">(</span>args<span class="token punctuation">:</span> <span class="token namespace">fmt<span class="token punctuation">::</span></span><span class="token class-name">Arguments</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">use</span> <span class="token namespace">core<span class="token punctuation">::</span>fmt<span class="token punctuation">::</span></span><span class="token class-name">Write</span><span class="token punctuation">;</span>
    <span class="token keyword">use</span> <span class="token namespace">x86_64<span class="token punctuation">::</span>instructions<span class="token punctuation">::</span></span>interrupts<span class="token punctuation">;</span>   <span class="token comment">// new</span>

    <span class="token namespace">interrupts<span class="token punctuation">::</span></span><span class="token function">without_interrupts</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token closure-punctuation punctuation">|</span><span class="token closure-punctuation punctuation">|</span></span> <span class="token punctuation">{</span>     <span class="token comment">// new</span>
        <span class="token constant">WRITER</span><span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">write_fmt</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><p><a href="https://docs.rs/x86_64/0.12.1/x86_64/instructions/interrupts/fn.without_interrupts.html" target="_blank" rel="noopener noreferrer"><code>without_interrupts</code><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 函数接收一个 <a href="https://doc.rust-lang.org/book/second-edition/ch13-01-closures.html" target="_blank" rel="noopener noreferrer">闭包<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>，在无中断环境下运行这个闭包。我们使用它来确保 <code>Mutex</code> 被锁定期间不会触发任何中断。现在运行内核可以看到它会一直运行而不会卡住。（我们仍然没有看到任何点，但是这是因为他们滚动太快了。可以试试减慢打印速度，例如在循环里面添加一个 <code>for _ in 0..10000 {}</code>）</p> <p>同样的更改可以应用到串口打印函数，从而也消除那里的死锁：</p> <div class="language-rust line-numbers-mode"><pre class="language-rust"><code><span class="token comment">// in src/serial.rs</span>

<span class="token attribute attr-name">#[doc(hidden)]</span>
<span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">_print</span><span class="token punctuation">(</span>args<span class="token punctuation">:</span> <span class="token punctuation">::</span><span class="token namespace">core<span class="token punctuation">::</span>fmt<span class="token punctuation">::</span></span><span class="token class-name">Arguments</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">use</span> <span class="token namespace">core<span class="token punctuation">::</span>fmt<span class="token punctuation">::</span></span><span class="token class-name">Write</span><span class="token punctuation">;</span>
    <span class="token keyword">use</span> <span class="token namespace">x86_64<span class="token punctuation">::</span>instructions<span class="token punctuation">::</span></span>interrupts<span class="token punctuation">;</span>       <span class="token comment">// new</span>

    <span class="token namespace">interrupts<span class="token punctuation">::</span></span><span class="token function">without_interrupts</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token closure-punctuation punctuation">|</span><span class="token closure-punctuation punctuation">|</span></span> <span class="token punctuation">{</span>         <span class="token comment">// new</span>
        <span class="token constant">SERIAL1</span>
            <span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">write_fmt</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">expect</span><span class="token punctuation">(</span><span class="token string">&quot;Printing to serial failed&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><p>需要注意的是禁用中断不应该是一个通用解决方案。原因是它增大了最坏情况下的中断时延，即系统响应一个中断的时间。因此，禁用中断的时长应该非常短暂。</p> <h2 id="修复竞争条件"><a href="#修复竞争条件" class="header-anchor">#</a> 修复竞争条件</h2> <p>运行 <code>cargo test</code> 可能会看到 <code>test_println_output</code> 测试失败：</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token operator">&gt;</span> cargo <span class="token builtin class-name">test</span> --lib
<span class="token punctuation">[</span>…<span class="token punctuation">]</span>
Running <span class="token number">4</span> tests
test_breakpoint_exception<span class="token punctuation">..</span>.<span class="token punctuation">[</span>ok<span class="token punctuation">]</span>
test_println<span class="token punctuation">..</span>. <span class="token punctuation">[</span>ok<span class="token punctuation">]</span>
test_println_many<span class="token punctuation">..</span>. <span class="token punctuation">[</span>ok<span class="token punctuation">]</span>
test_println_output<span class="token punctuation">..</span>. <span class="token punctuation">[</span>failed<span class="token punctuation">]</span>

Error: panicked at <span class="token string">'assertion failed: <span class="token variable"><span class="token variable">`</span><span class="token punctuation">(</span>left <span class="token operator">==</span> right<span class="token punctuation">)</span><span class="token variable">`</span></span>
  left: <span class="token variable"><span class="token variable">`</span>'.'<span class="token variable">`</span></span>,
 right: <span class="token variable"><span class="token variable">`</span>'S'<span class="token variable">`</span></span>'</span>, src/vga_buffer.rs:205:9
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>原因是这个测试函数和时钟处理函数之间存在 <em>竞争条件</em>。这个测试函数如下：</p> <div class="language-rust line-numbers-mode"><pre class="language-rust"><code><span class="token comment">// in src/vga_buffer.rs</span>

<span class="token attribute attr-name">#[test_case]</span>
<span class="token keyword">fn</span> <span class="token function-definition function">test_println_output</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> s <span class="token operator">=</span> <span class="token string">&quot;Some test string that fits on a single line&quot;</span><span class="token punctuation">;</span>
    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">&quot;{}&quot;</span><span class="token punctuation">,</span> s<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>i<span class="token punctuation">,</span> c<span class="token punctuation">)</span> <span class="token keyword">in</span> s<span class="token punctuation">.</span><span class="token function">chars</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">enumerate</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> screen_char <span class="token operator">=</span> <span class="token constant">WRITER</span><span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>buffer<span class="token punctuation">.</span>chars<span class="token punctuation">[</span><span class="token constant">BUFFER_HEIGHT</span> <span class="token operator">-</span> <span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token macro property">assert_eq!</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token punctuation">::</span><span class="token function">from</span><span class="token punctuation">(</span>screen_char<span class="token punctuation">.</span>ascii_character<span class="token punctuation">)</span><span class="token punctuation">,</span> c<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>这个测试函数往 VGA 缓冲打印一个字符串，然后遍历 <code>buffer_chars</code> 数组人为检查输出。因为时钟中断处理函数可能在 <code>println</code> 和读取屏幕字符之间运行，所以出现了竞争条件。需要注意的是这不是 Rust 在编译时完全禁止的危险的 <em>数据竞争</em>。更多详情参见 <a href="https://doc.rust-lang.org/nomicon/races.html" target="_blank" rel="noopener noreferrer"><em>Rustonomicon</em><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>。</p> <p>为了解决这个问题，我们需要在测试期间一直锁定 <code>WRITER</code> ，这样时钟中断处理函数就无法在中间往屏幕打印 <code>.</code> 了。修复的测试代码如下：</p> <div class="language-rust line-numbers-mode"><pre class="language-rust"><code><span class="token comment">// in src/vga_buffer.rs</span>

<span class="token attribute attr-name">#[test_case]</span>
<span class="token keyword">fn</span> <span class="token function-definition function">test_println_output</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">use</span> <span class="token namespace">core<span class="token punctuation">::</span>fmt<span class="token punctuation">::</span></span><span class="token class-name">Write</span><span class="token punctuation">;</span>
    <span class="token keyword">use</span> <span class="token namespace">x86_64<span class="token punctuation">::</span>instructions<span class="token punctuation">::</span></span>interrupts<span class="token punctuation">;</span>

    <span class="token keyword">let</span> s <span class="token operator">=</span> <span class="token string">&quot;Some test string that fits on a single line&quot;</span><span class="token punctuation">;</span>
    <span class="token namespace">interrupts<span class="token punctuation">::</span></span><span class="token function">without_interrupts</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token closure-punctuation punctuation">|</span><span class="token closure-punctuation punctuation">|</span></span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> <span class="token keyword">mut</span> writer <span class="token operator">=</span> <span class="token constant">WRITER</span><span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token macro property">writeln!</span><span class="token punctuation">(</span>writer<span class="token punctuation">,</span> <span class="token string">&quot;\n{}&quot;</span><span class="token punctuation">,</span> s<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">expect</span><span class="token punctuation">(</span><span class="token string">&quot;writeln failed&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span>i<span class="token punctuation">,</span> c<span class="token punctuation">)</span> <span class="token keyword">in</span> s<span class="token punctuation">.</span><span class="token function">chars</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">enumerate</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">let</span> screen_char <span class="token operator">=</span> writer<span class="token punctuation">.</span>buffer<span class="token punctuation">.</span>chars<span class="token punctuation">[</span><span class="token constant">BUFFER_HEIGHT</span> <span class="token operator">-</span> <span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token macro property">assert_eq!</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token punctuation">::</span><span class="token function">from</span><span class="token punctuation">(</span>screen_char<span class="token punctuation">.</span>ascii_character<span class="token punctuation">)</span><span class="token punctuation">,</span> c<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><p>我们作出了以下更改：</p> <ul><li>显式调用 <code>lock()</code> 函数保持整个测试期间 writer 被锁住。使用 <a href="https://doc.rust-lang.org/core/macro.writeln.html" target="_blank" rel="noopener noreferrer"><code>writeln</code><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 宏往已锁定的 writer 打印字符，而不是 <code>println</code></li> <li>为了避免另一个死锁，整个测试期间禁止中断。否则，writer 仍被锁定期间，测试可能会被中断</li> <li>由于时钟中断处理函数仍可能在测试运行前执行，我们在打印字符串 <code>s</code> 前打印一个新的换行符 <code>\n</code>。这样可以避免时钟处理函数已经往当前行打印了一些 <code>.</code> 字符导致测试失败的问题</li></ul> <p>实施以上更改后，<code>cargo test</code> 现在会再次确定性地成功了。</p> <p>这只是个非常无害的竞争条件，只会导致测试失败。但是可以想象，由于不确定性，调试其他竞争条件要复杂得多。好在 Rust 为我们防止了数据竞争，这类竞争是竞争条件中最为严重的一类，会触发各种未定义行为，包括系统崩溃和消无声息的内存污染。</p> <h2 id="hlt-指令"><a href="#hlt-指令" class="header-anchor">#</a> <code>hlt</code> 指令</h2> <p>目前为止，我们一直在 <code>_start</code> 和 <code>panic</code> 函数的末尾使用一个简单的空循环。这使得 CPU 无限自旋，从而按预期运行。由于没有活要干时 CPU 也全速运行，所以是非常低效的。运行内核时可以在任务管理器发现这个问题：QEMU 进程一直需要将近 100% 的 CPU。</p> <p>我们真正想做的是在下次中断到达前挂起 CPU。这样允许 CPU 进入睡眠状态，消耗更少电量。<a href="https://en.wikipedia.org/wiki/HLT_(x86_instruction)" target="_blank" rel="noopener noreferrer"><code>hlt</code> 指令<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 为此而生。让我们用这个指令创建一个用电高效型无限循环吧：</p> <div class="language-rust line-numbers-mode"><pre class="language-rust"><code><span class="token comment">// in src/lib.rs</span>

<span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">hlt_loop</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token operator">!</span> <span class="token punctuation">{</span>
    <span class="token keyword">loop</span> <span class="token punctuation">{</span>
        <span class="token namespace">x86_64<span class="token punctuation">::</span>instructions<span class="token punctuation">::</span></span><span class="token function">hlt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p><code>instructions::hlt</code> 函数只是汇编指令的一层 <a href="https://github.com/rust-osdev/x86_64/blob/5e8e218381c5205f5777cb50da3ecac5d7e3b1ab/src/instructions/mod.rs#L16-L22" target="_blank" rel="noopener noreferrer">薄封装<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>。因为不会破坏内存安全，所以是安全的。</p> <p>现在我们可以在 <code>_start</code> 和 <code>panic</code> 函数里面使用 <code>hlt_loop</code> 而不是无限循环了：</p> <div class="language-rust line-numbers-mode"><pre class="language-rust"><code><span class="token comment">// in src/main.rs</span>

<span class="token attribute attr-name">#[no_mangle]</span>
<span class="token keyword">pub</span> <span class="token keyword">extern</span> <span class="token string">&quot;C&quot;</span> <span class="token keyword">fn</span> <span class="token function-definition function">_start</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token operator">!</span> <span class="token punctuation">{</span>
    <span class="token punctuation">[</span>…<span class="token punctuation">]</span>

    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">&quot;It did not crash!&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token namespace">blog_os<span class="token punctuation">::</span></span><span class="token function">hlt_loop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token comment">// new</span>
<span class="token punctuation">}</span>

<span class="token attribute attr-name">#[cfg(not(test))]</span>
<span class="token attribute attr-name">#[panic_handler]</span>
<span class="token keyword">fn</span> <span class="token function-definition function">panic</span><span class="token punctuation">(</span>info<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token class-name">PanicInfo</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token operator">!</span> <span class="token punctuation">{</span>
    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">&quot;{}&quot;</span><span class="token punctuation">,</span> info<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token namespace">blog_os<span class="token punctuation">::</span></span><span class="token function">hlt_loop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token comment">// new</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><p>同样地也更新 <code>lib.rs</code>：</p> <div class="language-rust line-numbers-mode"><pre class="language-rust"><code><span class="token comment">// in src/lib.rs</span>

<span class="token comment">/// Entry point for `cargo test`</span>
<span class="token attribute attr-name">#[cfg(test)]</span>
<span class="token attribute attr-name">#[no_mangle]</span>
<span class="token keyword">pub</span> <span class="token keyword">extern</span> <span class="token string">&quot;C&quot;</span> <span class="token keyword">fn</span> <span class="token function-definition function">_start</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token operator">!</span> <span class="token punctuation">{</span>
    <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">test_main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">hlt_loop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>         <span class="token comment">// new</span>
<span class="token punctuation">}</span>

<span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">test_panic_handler</span><span class="token punctuation">(</span>info<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token class-name">PanicInfo</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token operator">!</span> <span class="token punctuation">{</span>
    <span class="token macro property">serial_println!</span><span class="token punctuation">(</span><span class="token string">&quot;[failed]\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token macro property">serial_println!</span><span class="token punctuation">(</span><span class="token string">&quot;Error: {}\n&quot;</span><span class="token punctuation">,</span> info<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">exit_qemu</span><span class="token punctuation">(</span><span class="token class-name">QemuExitCode</span><span class="token punctuation">::</span><span class="token class-name">Failed</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">hlt_loop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>         <span class="token comment">// new</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><p>再次在 QEMU 运行内核可以看到 CPU 使用率低了很多。</p> <h2 id="键盘输入"><a href="#键盘输入" class="header-anchor">#</a> 键盘输入</h2> <p>可以处理外部设备的中断后，我们终于能够支持键盘输入了。这会让我们首次和内核进行交互。</p> <p>需要注意的是我们目前只讲解如何处理 <a href="https://en.wikipedia.org/wiki/PS/2_port" target="_blank" rel="noopener noreferrer">PS/2<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 键盘，不包括 USB 键盘，然而，主板为了支持旧版软件，会用 PS/2 设备模拟 USB 键盘，所以在内核支持 USB 之前我们可以安全地忽略 USB 键盘。</p> <p>和硬件时钟类似，键盘控制器默认也是开启的。所以按下一个按键后，键盘控制器会发送一个中断给 PIC，然后中断被导向 CPU。CPU 从 IDT 搜索相应的处理函数，但是发现对应项为空。因此触发了二级异常。</p> <p>让我们为键盘中断添加处理函数。这和为时钟中断定义处理函数非常类似，只是使用不同的中断值而已：</p> <div class="language-rust line-numbers-mode"><pre class="language-rust"><code><span class="token comment">// in src/interrupts.rs</span>

<span class="token attribute attr-name">#[derive(Debug, Clone, Copy)]</span>
<span class="token attribute attr-name">#[repr(u8)]</span>
<span class="token keyword">pub</span> <span class="token keyword">enum</span> <span class="token type-definition class-name">InterruptIndex</span> <span class="token punctuation">{</span>
    <span class="token class-name">Timer</span> <span class="token operator">=</span> <span class="token constant">PIC_1_OFFSET</span><span class="token punctuation">,</span>
    <span class="token class-name">Keyboard</span><span class="token punctuation">,</span> <span class="token comment">// new</span>
<span class="token punctuation">}</span>

<span class="token macro property">lazy_static!</span> <span class="token punctuation">{</span>
    <span class="token keyword">static</span> <span class="token keyword">ref</span> <span class="token constant">IDT</span><span class="token punctuation">:</span> <span class="token class-name">InterruptDescriptorTable</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> <span class="token keyword">mut</span> idt <span class="token operator">=</span> <span class="token class-name">InterruptDescriptorTable</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        idt<span class="token punctuation">.</span>breakpoint<span class="token punctuation">.</span><span class="token function">set_handler_fn</span><span class="token punctuation">(</span>breakpoint_handler<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">[</span>…<span class="token punctuation">]</span>
        <span class="token comment">// new</span>
        idt<span class="token punctuation">[</span><span class="token class-name">InterruptIndex</span><span class="token punctuation">::</span><span class="token class-name">Keyboard</span><span class="token punctuation">.</span><span class="token function">as_usize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
            <span class="token punctuation">.</span><span class="token function">set_handler_fn</span><span class="token punctuation">(</span>keyboard_interrupt_handler<span class="token punctuation">)</span><span class="token punctuation">;</span>

        idt
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">extern</span> <span class="token string">&quot;x86-interrupt&quot;</span> <span class="token keyword">fn</span> <span class="token function-definition function">keyboard_interrupt_handler</span><span class="token punctuation">(</span>
    _stack_frame<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token class-name">InterruptStackFrame</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token macro property">print!</span><span class="token punctuation">(</span><span class="token string">&quot;k&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">unsafe</span> <span class="token punctuation">{</span>
        <span class="token constant">PICS</span><span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">notify_end_of_interrupt</span><span class="token punctuation">(</span><span class="token class-name">InterruptIndex</span><span class="token punctuation">::</span><span class="token class-name">Keyboard</span><span class="token punctuation">.</span><span class="token function">as_u8</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br></div></div><p>由 <a href="#_8259-pic">上图</a> 可知，键盘使用了主 PIC 的 1 号线路。这意味着它到达 CPU 时的值是 33（1 + 偏移 32）。我们向 <code>InterruptIndex</code> 枚举类型添加一个新的 <code>Keyboard</code> 枚举值。由于枚举值默认为前一项的值加一，也是 33，所以我们不需要显示地设置枚举值。中断处理函数中，我们打印一个 <code>k</code>，然后把中断结束信号发送给中断控制器。</p> <p>现在按键时可以在屏幕上看到一个 <code>k</code>。然而，只有第一次按键有效，即使我们继续按键也不会在屏幕上看到更多 <code>k</code>。这是因为除非读取按键的所谓 <em>扫描码</em>（scancode），否则键盘控制器不会再次发送中断。</p> <h3 id="读取扫描码"><a href="#读取扫描码" class="header-anchor">#</a> 读取扫描码</h3> <p>为了查明 <em>具体</em> 按下的键，我们需要向键盘控制器查询。具体做法为从 PS/2 控制器的数据端口读取，一个值为 <code>0x60</code> 的 <a href="/blog-os/blog-os-07-hardware-interrupts/@/second-edition/posts/04-testing/#i-o-ports">I/O 端口</a>：</p> <div class="language-rust line-numbers-mode"><pre class="language-rust"><code><span class="token comment">// in src/interrupts.rs</span>

<span class="token keyword">extern</span> <span class="token string">&quot;x86-interrupt&quot;</span> <span class="token keyword">fn</span> <span class="token function-definition function">keyboard_interrupt_handler</span><span class="token punctuation">(</span>
    _stack_frame<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token class-name">InterruptStackFrame</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">use</span> <span class="token namespace">x86_64<span class="token punctuation">::</span>instructions<span class="token punctuation">::</span>port<span class="token punctuation">::</span></span><span class="token class-name">Port</span><span class="token punctuation">;</span>

    <span class="token keyword">let</span> <span class="token keyword">mut</span> port <span class="token operator">=</span> <span class="token class-name">Port</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token number">0x60</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> scancode<span class="token punctuation">:</span> <span class="token keyword">u8</span> <span class="token operator">=</span> <span class="token keyword">unsafe</span> <span class="token punctuation">{</span> port<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token macro property">print!</span><span class="token punctuation">(</span><span class="token string">&quot;{}&quot;</span><span class="token punctuation">,</span> scancode<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">unsafe</span> <span class="token punctuation">{</span>
        <span class="token constant">PICS</span><span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">notify_end_of_interrupt</span><span class="token punctuation">(</span><span class="token class-name">InterruptIndex</span><span class="token punctuation">::</span><span class="token class-name">Keyboard</span><span class="token punctuation">.</span><span class="token function">as_u8</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><p>我们使用 <code>x86_64</code> 包的 <a href="https://docs.rs/x86_64/0.12.1/x86_64/instructions/port/struct.Port.html" target="_blank" rel="noopener noreferrer"><code>Port</code><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 类型从键盘的数据端口读取一字节。这个字节成为 <a href="https://en.wikipedia.org/wiki/Scancode" target="_blank" rel="noopener noreferrer"><em>扫描码</em><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>，表示按下/释放的键。我们目前还不会对扫描码做任何事情，只是把它打印到屏幕：</p> <p><img src="data:image/gif;base64,R0lGODlh0AK1AfUBAP//VwAAACAkJyMnLSUqLiYqLiovMiktNi80NjI4OjM5OzY5OTQ4OjU6PDY7PTY8Pjc9Pjo+PTg+QDo+QDxBQz1DQz5DRUBFR0BGSEVKTEdLTUhNT0NMXURMXUxRUkxSU1VVVVJXWFRZWldcXVleX0VOYF9jZGBlZmNnaGZqa2htbW1xcm1ycnB0dXN3d3Z6e3h7fHt+f4CDg4CEhIKFhYWIiImMjI2QkI2QkZCTk5GUlKqqqufp5efp5u7v7P///yH/C05FVFNDQVBFMi4wAwEAAAAh+QQEBQD/ACH+EkN1dCB3aXRoIGV6Z2lmLmNvbQAsAAAAANACtQEABv9AH0+1uEQikqRyyWw6n9CodEqtWq/YrHbL7Xq/4LB4TC6bz+i0es1WRhwIwYHT4ZEyEQViz+/7/4CBgoOEhYaHiImKi4yNjo+QkZKTlJWWl5iZmpucnZ6ACg8GAxwtGA2fqaqrrK2ur7CxsrO0tbapDQYHEQy3vr/AwcLDxMXGx8iHDAIXyc7P0NHS09TV1pEJ19rb3N3e3+Dh4uPk5ebn6Onq6+zt7u/w8fLz9PX29/j5+vv8/f7/AAMKHEiwoMGDCBMqXMiwIaUEOHj08LEDQx8fGDPuQIBxI58TGFNw9NGHho8YDlOqXMnSEgWMP3b88NHDBB+aO3LuoDHSRwb/PjtCjix5sqXRo0iT9gl6g88LHz/0DPVD04eOPSGg+hCJkShKpWBTCaGwZ0LQsGipWei61EeLPWwvUuQxAcEOHjq2Tt1j8mvav5cyUngJFbBhZCZ8NO2DwircHjp3kMVYwoeNDVZz6I2LoO/hz5EuzMz44yfo07+eyvDzgSLcjBh/doUaFINmriT5eEbNO5FomBp6C5+VOAcfECtYON57k6SLjghuM6/hA8bw64IqkG6GvbuqC1CzIeAhxMeK13+6JpgpIrreHz365D3hvf5aqDN/WKjPn1PQHdlgkB8E6FGVGwYe7CFdUDwhgMFEFvV3HUwWWDCahBhaYiFtE2F0/x5HkOk0A3MK6iWCRhN5lGFvGO2HwH0rxhgJAzr0wENMItyYDWzQcVaiSAiMIBN5NRAo45FIJmkIAxEq6eSTUEYp5ZRUVmnllVhmqeWWXHbp5ZdghinmmGSWaeaZaKap5ppstunmm3DGKeec3hFg55145qnnnnz26eefgAYq6KCEFmrooYgmquiijDbq6KOQRirppJRWaumlmGZaaAGcdurpp6CGKuqopJZq6qmopqrqqqy26uqrsMYq66y01mrrrbjmquuuvPbq66+rBiDssMQWa+yxyCar7LLMNuvss9BGK+201FZr7bXYZqvtttx26+234IYr7rjklmvuueimq//uuuy26+678MYr77z01mvvvfjmq+++/Pbr778AByzwwAQXbPDBCCes8MIMN+zwwxBHLPHEFFds8cUYZ6zxxhx37PHHIIcs8sgkl2zyySinrPLKLLfs8sswxyzzzDTXbPPNOOes88489+zzz0AHLfTQRBdt9NFIJ6300kw37fTTUEct9dRUV2311VhnrfXWXHft9ddghy322GSXbfbZaKet9tpst+3223DHLffcdNdt991456333nz37fffgAcu+OCEF2744YgnrvjijDfu+OOQRy755JRXbvnlmGeu+eacd+7556CHLvropJdu+umop6766qy37vrrsMcu++y0127/++2456777rz37vvvwAcv/PDEF2/88cgnr/zyzDfv/PPQRy/99NRXb/312Gev/fbcd+/99+CHL/745Jdv/vnop6/++uy37/778Mcv//z012///fjnr//+/Pfv//8ADKAAB0jAAhrwgAhMoAIXyMAGOvCBEIygBCdIwQpa8IIYzKAGN8jBDnrwgyAMoQhHSMISmvCEKEyhClfIwha68IUwjKEMZ0jDGtrwhjjMoQ53yMMe+vCHQAyiEIdIxCIa8YhITKISl8jEJjrxiVCMohSnSMUqWvGKWMyiFrfIxS568YtgDKMYx0jGMprxjGhMoxrXyMY2uvGNcIyjHOdIxzra//GOeMyjHvfIxz768Y+ADKQgB0nIQhrykIhMpCIXychGOvKRkIykJCdJyUpa8pKYzKQmN8nJTnryk6AMpShHScpSmvKUqEylKlfJyla68pWwjKUsZ0nLWtrylrjMpS53ycte+vKXwAymMIdJzGIa85jITKYyl8nMZjrzmdCMpjSnSc1qWvOa2MymNrfJzW5685vgDKc4x0nOcprznOhMpzrXyc52uvOd8IynPOdJz3ra8574zKc+98nPfvrznwANqEAHStCCGvSgCE2oQhfK0IY69KEQjahEJ0rRilr0ohjNqEY3ytGOevSjIA2pSEdK0pKa9KQoTalKV8rSlrr0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" alt="按下键盘后 QEMU 往屏幕打印扫描码"></p> <p>上图显示缓慢敲入 &quot;123&quot; 的情形。可以看到相邻的键有邻近的扫描码，按下和释放键的扫描码是不同的。那我们得如何把扫描码翻译为确切的按键动作呢？</p> <h3 id="翻译扫描码"><a href="#翻译扫描码" class="header-anchor">#</a> 翻译扫描码</h3> <p>目前将扫描码映射到键有三种不同标准，即所谓的 <em>扫描码集</em>。三种标准都源自早期 IBM 电脑的键盘：<a href="https://en.wikipedia.org/wiki/IBM_Personal_Computer_XT" target="_blank" rel="noopener noreferrer">IBM XT<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>、<a href="https://en.wikipedia.org/wiki/IBM_3270_PC" target="_blank" rel="noopener noreferrer">IBM 3270 PC<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 和 <a href="https://en.wikipedia.org/wiki/IBM_Personal_Computer/AT" target="_blank" rel="noopener noreferrer">IBM AT<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>。好在后来的电脑都没有兴起定义新扫描集的风气，而是模拟现有集合或拓展它们。今天的大多数键盘都可以配置为模拟上述三种集合中的任何一个：</p> <p>PS/2 键盘默认模拟的是扫描码集 1（“XT”）。对于这个集合，扫描码字节的低 7 位定义键值，最高有效位定义按键动作是按下（“0”）还是释放（“1”）。<a href="https://en.wikipedia.org/wiki/IBM_Personal_Computer_XT" target="_blank" rel="noopener noreferrer">IBM XT<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 键盘没有定义的键，例如键盘的 enter 键，对应到两个连续的扫描码：一个 <code>0xe0</code> 转义字节，然后是一个表示键的字节。想要查看集合 1 的所有扫描码和相应键的话，参见 <a href="https://wiki.osdev.org/Keyboard#Scan_Code_Set_1" target="_blank" rel="noopener noreferrer">OSDev Wiki<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>。</p> <p>我们借助 <code>match</code> 语句将扫描码翻译为键：</p> <div class="language-rust line-numbers-mode"><pre class="language-rust"><code><span class="token comment">// in src/interrupts.rs</span>

<span class="token keyword">extern</span> <span class="token string">&quot;x86-interrupt&quot;</span> <span class="token keyword">fn</span> <span class="token function-definition function">keyboard_interrupt_handler</span><span class="token punctuation">(</span>
    _stack_frame<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token class-name">InterruptStackFrame</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">use</span> <span class="token namespace">x86_64<span class="token punctuation">::</span>instructions<span class="token punctuation">::</span>port<span class="token punctuation">::</span></span><span class="token class-name">Port</span><span class="token punctuation">;</span>

    <span class="token keyword">let</span> <span class="token keyword">mut</span> port <span class="token operator">=</span> <span class="token class-name">Port</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token number">0x60</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> scancode<span class="token punctuation">:</span> <span class="token keyword">u8</span> <span class="token operator">=</span> <span class="token keyword">unsafe</span> <span class="token punctuation">{</span> port<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>

    <span class="token comment">// new</span>
    <span class="token keyword">let</span> key <span class="token operator">=</span> <span class="token keyword">match</span> scancode <span class="token punctuation">{</span>
        <span class="token number">0x02</span> <span class="token operator">=&gt;</span> <span class="token class-name">Some</span><span class="token punctuation">(</span><span class="token char string">'1'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token number">0x03</span> <span class="token operator">=&gt;</span> <span class="token class-name">Some</span><span class="token punctuation">(</span><span class="token char string">'2'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token number">0x04</span> <span class="token operator">=&gt;</span> <span class="token class-name">Some</span><span class="token punctuation">(</span><span class="token char string">'3'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token number">0x05</span> <span class="token operator">=&gt;</span> <span class="token class-name">Some</span><span class="token punctuation">(</span><span class="token char string">'4'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token number">0x06</span> <span class="token operator">=&gt;</span> <span class="token class-name">Some</span><span class="token punctuation">(</span><span class="token char string">'5'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token number">0x07</span> <span class="token operator">=&gt;</span> <span class="token class-name">Some</span><span class="token punctuation">(</span><span class="token char string">'6'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token number">0x08</span> <span class="token operator">=&gt;</span> <span class="token class-name">Some</span><span class="token punctuation">(</span><span class="token char string">'7'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token number">0x09</span> <span class="token operator">=&gt;</span> <span class="token class-name">Some</span><span class="token punctuation">(</span><span class="token char string">'8'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token number">0x0a</span> <span class="token operator">=&gt;</span> <span class="token class-name">Some</span><span class="token punctuation">(</span><span class="token char string">'9'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token number">0x0b</span> <span class="token operator">=&gt;</span> <span class="token class-name">Some</span><span class="token punctuation">(</span><span class="token char string">'0'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        _ <span class="token operator">=&gt;</span> <span class="token class-name">None</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token keyword">let</span> <span class="token class-name">Some</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span> <span class="token operator">=</span> key <span class="token punctuation">{</span>
        <span class="token macro property">print!</span><span class="token punctuation">(</span><span class="token string">&quot;{}&quot;</span><span class="token punctuation">,</span> key<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">unsafe</span> <span class="token punctuation">{</span>
        <span class="token constant">PICS</span><span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">notify_end_of_interrupt</span><span class="token punctuation">(</span><span class="token class-name">InterruptIndex</span><span class="token punctuation">::</span><span class="token class-name">Keyboard</span><span class="token punctuation">.</span><span class="token function">as_u8</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br></div></div><p>上述代码翻译键值为 0-9 的按键，并忽略其他所有键。代码使用 <a href="https://doc.rust-lang.org/book/ch06-02-match.html" target="_blank" rel="noopener noreferrer">match<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 语句为每个扫描码分配一个字符或 <code>None</code>。然后使用 <a href="https://doc.rust-lang.org/book/ch18-01-all-the-places-for-patterns.html#conditional-if-let-expressions" target="_blank" rel="noopener noreferrer"><code>if let</code><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 来解构可选的 <code>key</code>。模式使用同样的变量名 <code>key</code> 会 <a href="https://doc.rust-lang.org/book/ch03-01-variables-and-mutability.html#shadowing" target="_blank" rel="noopener noreferrer">掩盖<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 之前的声明，这是 Rust 解构 <code>Option</code> 类型的一个常见模式。</p> <p>现在我们就可以写入数字了：</p> <p><img src="data:image/gif;base64,R0lGODlh0AK1AfUBAP//VwAAACAkJyMnLSUqLiYqLiovMiktNi80NjI4OjM5OzY5OTQ4OjU6PDY7PTY8Pjc9Pjo+PTg+QDo+QDxBQz1DQz5DRUBFR0BGSEVKTEdLTUhNT0NMXURMXUxRUkxSU1VVVVJXWFRZWldcXVleX0VOYF9jZGBlZmNnaGZqa2htbW1xcm1ycnB0dXN3d3Z6e3h7fHt+f4CDg4CEhIKFhYWIiImMjI2QkI2QkZCTk5GUlKqqqufp5efp5u7v7P///yH/C05FVFNDQVBFMi4wAwEAAAAh+QQECgD/ACH+EkN1dCB3aXRoIGV6Z2lmLmNvbQAsAAAAANACtQEABv9AH0+1uEQikqRyyWw6n9CodEqtWq/YrHbL7Xq/4LB4TC6bz+i0es1WRhwIwYHT4ZEyEQViz+/7/4CBgoOEhYaHiImKi4yNjo+QkZKTlJWWl5iZmpucnZ6ACg8GAxwtGA2fqaqrrK2ur7CxsrO0tbapDQYHEQy3vr/AwcLDxMXGx8iHDAIXyc7P0NHS09TV1pEJ19rb3N3e3+Dh4uPk5ebn6Onq6+zt7u/w8fLz9PX29/j5+vv8/f7/AAMKHEiwoMGDCBMqXMiwIaUEOHj08LEDQx8fGDPuQIBxI58TGFNw9NGHho8YDlOqXMnSEgWMP3b88NHDBB+aO3LuoDHSRwb/PjtCjix5sqXRo0iT9gl6g88LHz/0DPVD04eOPSGg+hCJkShKpWBTCaGwZ0LQsGipWei61EeLPWwvUuQxAcEOHjq2Tt1j8mvav5cyUngJFbBhZCZ8NO2DwircHjp3kMVYwoeNDVZz6I2LoO/hz5EuzMz44yfo07+eyvDzgSLcjBh/doUaFINmriT5eEbNO5FomBp6C5+VOAcfECtYON57k6SLjghuM6/hA8bw64IqkG6GvbuqC1CzIeAhxMeK13+6JpgpIrreHz365D3hvf5aqDN/WKjPn1PQHdlgkB8E6FGVGwYe7CFdUDwhgMFEFvV3HUwWWDCahBhaYiFtE2F0/x5HkOk0A3MK6iWCRhN5lGFvGO2HwH0rxhgJAzr0wENMItyYDWzQcVaiSAiMIBN5NRAo45FIJmkIAxEq6eSTUEYp5ZRUVmnllVhmqeWWXHbp5ZdghinmmGSWaeaZaKap5ppstunmm3DGKeec3hFg55145qnnnnz26eefgAYq6KCEFmrooYgmquiijDbq6KOQRirppJRWaumlmGZaaAGcdurpp6CGKuqopJZq6qmopqrqqqy26uqrsMYq66y01mrrrbjmquuuvPbq66+rBiDssMQWa+yxyCar7LLMNuvss9BGK+201FZr7bXYZqvtttx26+234IYr7rjklmvuueimq//uuuy26+678MYr77z01mvvvfjmq+++/Pbr778AByzwwAQXbPDBCCes8MIMN+zwwxBHLPHEFFds8cUYZ6zxxhx37PHHIIcs8sgkl2zyySinrPLKLLfs8sswxyzzzDTXbPPNOOes88489+zzz0AHLfTQRBdt9NFIJ6300kw37fTTUEct9dRUV2311VhnrfXWXHft9ddghy322GSXbfbZaKet9tpst+3223DHLffcdNdt991456333nz37fffgAcu+OCEF2744YgnrvjijDfu+OOQRy755JRXbvnlmGeu+eacd+7556CHLvropJdu+umop6766qy37vrrsMcu++y0127/++2456777rz37vvvwAcv/PDEF2/88cgnr/zyzDfv/PPQRy/99NRXb/312Gev/fbcd+/99+CHL/745Jdv/vnop6/++uy37/778Mcv//z012///fjnr//+/Pfv//8ADKAAB0jAAhrwgAhMoAIXyMAGOvCBEIygBCdIwQpa8IIYzKAGN8jBDnrwgyAMoQhHSMISmvCEKEyhClfIwha68IUwjKEMZ0jDGtrwhjjMoQ53yMMe+vCHQAyiEIdIxCIa8YhITKISl8jEJjrxiVCMohSnSMUqWvGKWMyiFrfIxS568YtgDKMYx0jGMprxjGhMoxrXyMY2uvGNcIyjHOdIxzra//GOeMyjHvfIxz768Y+ADKQgB0nIQhrykIhMpCIXychGOvKRkIykJCdJyUpa8pKYzKQmN8nJTnryk6AMpShHScpSmvKUqEylKlfJyla68pWwjKUsZ0nLWtrylrjMpS53ycte+vKXwAymMIdJzGIa85jITKYyl8nMZjrzmdCMpjSnSc1qWvOa2MymNrfJzW5685vgDKc4x0nOcprznOhMpzrXyc52uvOd8IynPOdJz3ra8574zKc+98nPfvrznwANqEAHStCCGvSgCE2oQhfK0IY69KEQjahEJ0rRilr0ohjNqEY3ytGOevSjIA2pSEdK0pKa9KQoTalKV8rSlrr0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AAAh+QQFBQABACwnAK8BAgACAAACAoRRACH5BAUFAAEALDAArwECAAIAAAIChFEAIfkEBQYAAQAsOQCvAQIAAgAAAgKEUQAh+QQFBQABACxCAK8BAgACAAACAoRRACH5BAUKAAEALEsArwELAAIAAAIGBIIZZppWACH5BAUJAAEALF0ApwEUAAoAAAIcjB+git1soJtH0mlvXPrmvoHOlwCIlC3mqY5AAQAh+QQFBAABACx4AK8BAgACAAACAoRRACH5BAUFAAEALIEArwECAAIAAAIChFEAIfkEBQUAAQAsigCvAQIAAgAAAgKEUQAh+QQFBQABACyTAK8BAgACAAACAoRRACH5BAULAAEALJwArwECAAIAAAIChFEAIfkEBQUAAQAspQCvAQIAAgAAAgKEUQAh+QQFBQABACyuAK8BCwACAAACBgSCGWaaVgAh+QQFCgABACzAAK8BAgACAAACAoRRACH5BAUKAAEALMkArwELAAIAAAIGBIIZZppWACH5BAUFAAEALNsArwECAAIAAAIChFEAIfkEBQUAAQAs5ACvAQIAAgAAAgKEUQAh+QQFBQABACztAK8BAgACAAACAoRRACH5BAUFAAEALPYArwECAAIAAAIChFEAIfkEBQUAAQAs/wCvAQIAAgAAAgKEUQAh+QQFBQABACwIAa8BAgACAAACAoRRACH5BAUFAAEALBEBrwECAAIAAAIChFEAIfkEBQQAAQAsGgGvAQIAAgAAAgKEUQAh+QQFCgABACwgAacBDgAKAAACGIwDcLup3Bw8CT1Y7bQub/0Z3jeKV8ckBQAh+QQFCQABACw1Aa8BCwACAAACBgSCGWaaVgAh+QQFBQABACxHAacBDQAKAAACFIwPqXDIDUOKcFK3brOa3+xgj8gUACH5BAUEAAEALFkBrwECAAIAAAIChFEAIfkEBQQAAQAsYgGvAQIAAgAAAgKEUQAh+QQFBQABACxrAa8BAgACAAACAoRRACH5BAUFAAEALHQBrwECAAIAAAIChFEAIfkEBQkAAQAsegGnAQ4ACgAAAhlMgKZ7wJ8ei1Kh6ySla+f5cVb4GQlWmkABACH5BAULAAEALI8BrwELAAIAAAIGBIIZZppWACH5BAUFAAEALKEBpwEQAAoAAAIRjI8JybgNo5y02gme0iY3jxQAIfkEBQUAAQAssQGnAQ0ACgAAAhWEH6kBagvTi2tS1i7Wm9v7VU3oAAUAIfkEBQUAAQAsxQGvAQIAAgAAAgKEUQAh+QQFCgABACzOAa8BAgACAAACAoRRACH5BAUFAAEALNcBpwENAAoAAAIXjB+gisf2UIwO1AaXxXNLT2UV1YWaVQAAIfkEBQUAAQAs6QGvAQIAAgAAAgKEUQAh+QQFBgABACzyAa8BAgACAAACAoRRACH5BAUFAAEALPsBrwECAAIAAAIChFEAIfkEBQUAAQAsBAKvAQIAAgAAAgKEUQAh+QQFBQABACwNAq8BAgACAAACAoRRACH5BAUFAAEALBYCrwECAAIAAAIChFEAIfkEBQUAAQAsHwKnAQ0ACgAAAhaMH6CKx/ZQjA7UBhfFyfL7Zdu1aUYBACH5BAUEAAEALDECrwECAAIAAAIChFEAIfkEBQQAAQAsOgKvAQIAAgAAAgKEUQAh+QQFBAABACxDAq8BAgACAAACAoRRACH5BAUKAAEALEwCrwECAAIAAAIChFEAIfkEBQUAAQAsVQKvAQIAAgAAAgKEUQAh+QQFBQABACxeAq8BAgACAAACAoRRACH5BAUFAAEALGcCrwECAAIAAAIChFEAIfkEBQYAAQAscAKvAQIAAgAAAgKEUQAh+QQFBQABACx5Aq8BAgACAAACAoRRACH5BAUKAAEALIICrwELAAIAAAIGBIIZZppWADs=" alt="QEMU 在屏幕上打印数字"></p> <p>其他键的翻译流程也是一样的。好在现有一个名为 <a href="https://docs.rs/pc-keyboard/0.5.0/pc_keyboard/" target="_blank" rel="noopener noreferrer"><code>pc-keyboard</code><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 的包用于翻译扫描码集 1 和 2，所以我们不需要自己造了。为了使用这个包，把它添加到 <code>Cargo.toml</code>，然后在 <code>lib.rs</code> 导入它：</p> <div class="language-toml line-numbers-mode"><pre class="language-toml"><code><span class="token comment"># in Cargo.toml</span>

<span class="token punctuation">[</span><span class="token table class-name">dependencies</span><span class="token punctuation">]</span>
<span class="token key property">pc-keyboard</span> <span class="token punctuation">=</span> <span class="token string">&quot;0.5.0&quot;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>现在使用这个包来重写 <code>keyboard_interrupt_handler</code>：</p> <div class="language-rust line-numbers-mode"><pre class="language-rust"><code><span class="token comment">// in/src/interrupts.rs</span>

<span class="token keyword">extern</span> <span class="token string">&quot;x86-interrupt&quot;</span> <span class="token keyword">fn</span> <span class="token function-definition function">keyboard_interrupt_handler</span><span class="token punctuation">(</span>
    _stack_frame<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token class-name">InterruptStackFrame</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">use</span> <span class="token namespace">pc_keyboard<span class="token punctuation">::</span></span><span class="token punctuation">{</span>layouts<span class="token punctuation">,</span> <span class="token class-name">DecodedKey</span><span class="token punctuation">,</span> <span class="token class-name">HandleControl</span><span class="token punctuation">,</span> <span class="token class-name">Keyboard</span><span class="token punctuation">,</span> <span class="token class-name">ScancodeSet1</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token keyword">use</span> <span class="token namespace">spin<span class="token punctuation">::</span></span><span class="token class-name">Mutex</span><span class="token punctuation">;</span>
    <span class="token keyword">use</span> <span class="token namespace">x86_64<span class="token punctuation">::</span>instructions<span class="token punctuation">::</span>port<span class="token punctuation">::</span></span><span class="token class-name">Port</span><span class="token punctuation">;</span>

    <span class="token macro property">lazy_static!</span> <span class="token punctuation">{</span>
        <span class="token keyword">static</span> <span class="token keyword">ref</span> <span class="token constant">KEYBOARD</span><span class="token punctuation">:</span> <span class="token class-name">Mutex</span><span class="token operator">&lt;</span><span class="token class-name">Keyboard</span><span class="token operator">&lt;</span><span class="token namespace">layouts<span class="token punctuation">::</span></span><span class="token class-name">Us104Key</span><span class="token punctuation">,</span> <span class="token class-name">ScancodeSet1</span><span class="token operator">&gt;&gt;</span> <span class="token operator">=</span>
            <span class="token class-name">Mutex</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token class-name">Keyboard</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token namespace">layouts<span class="token punctuation">::</span></span><span class="token class-name">Us104Key</span><span class="token punctuation">,</span> <span class="token class-name">ScancodeSet1</span><span class="token punctuation">,</span>
                <span class="token class-name">HandleControl</span><span class="token punctuation">::</span><span class="token class-name">Ignore</span><span class="token punctuation">)</span>
            <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">let</span> <span class="token keyword">mut</span> keyboard <span class="token operator">=</span> <span class="token constant">KEYBOARD</span><span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> port <span class="token operator">=</span> <span class="token class-name">Port</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token number">0x60</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">let</span> scancode<span class="token punctuation">:</span> <span class="token keyword">u8</span> <span class="token operator">=</span> <span class="token keyword">unsafe</span> <span class="token punctuation">{</span> port<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token keyword">let</span> <span class="token class-name">Ok</span><span class="token punctuation">(</span><span class="token class-name">Some</span><span class="token punctuation">(</span>key_event<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">=</span> keyboard<span class="token punctuation">.</span><span class="token function">add_byte</span><span class="token punctuation">(</span>scancode<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token keyword">let</span> <span class="token class-name">Some</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span> <span class="token operator">=</span> keyboard<span class="token punctuation">.</span><span class="token function">process_keyevent</span><span class="token punctuation">(</span>key_event<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">match</span> key <span class="token punctuation">{</span>
                <span class="token class-name">DecodedKey</span><span class="token punctuation">::</span><span class="token class-name">Unicode</span><span class="token punctuation">(</span>character<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token macro property">print!</span><span class="token punctuation">(</span><span class="token string">&quot;{}&quot;</span><span class="token punctuation">,</span> character<span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token class-name">DecodedKey</span><span class="token punctuation">::</span><span class="token class-name">RawKey</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token macro property">print!</span><span class="token punctuation">(</span><span class="token string">&quot;{:?}&quot;</span><span class="token punctuation">,</span> key<span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">unsafe</span> <span class="token punctuation">{</span>
        <span class="token constant">PICS</span><span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">notify_end_of_interrupt</span><span class="token punctuation">(</span><span class="token class-name">InterruptIndex</span><span class="token punctuation">::</span><span class="token class-name">Keyboard</span><span class="token punctuation">.</span><span class="token function">as_u8</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br></div></div><p>使用 <code>lazy_static</code> 宏创建用 Mutex 保护的静态 <a href="https://docs.rs/pc-keyboard/0.5.0/pc_keyboard/struct.Keyboard.html" target="_blank" rel="noopener noreferrer"><code>Keyboard</code><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 对象。我们用美式键盘布局和扫描码集 1 来初始化 <code>Keyboard</code>。<a href="https://docs.rs/pc-keyboard/0.5.0/pc_keyboard/enum.HandleControl.html" target="_blank" rel="noopener noreferrer"><code>HandleControl</code><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 参数允许将 <code>ctrl+[a-z]</code> 映射到 Unicode 字符集 <code>U+0001</code> 到 <code>U+001A</code>。我们不想这么做，所以使用 <code>Ignore</code> 选项把 <code>ctrl</code> 和常规键一样看待。</p> <p>对于每个中断，我们锁定 Mutex，从键盘控制器读取扫描码，把扫描码传给 <a href="https://docs.rs/pc-keyboard/0.5.0/pc_keyboard/struct.Keyboard.html#method.add_byte" target="_blank" rel="noopener noreferrer"><code>add_byte</code><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 方法将其翻译为一个 <code>Option&lt;KeyEvent&gt;</code>。<a href="https://docs.rs/pc-keyboard/0.5.0/pc_keyboard/struct.KeyEvent.html" target="_blank" rel="noopener noreferrer"><code>KeyEvent</code><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 包含触发事件的键和按键动作类型（按下还是释放）。</p> <p>为了翻译这个按键事件，我们将其传给 <a href="https://docs.rs/pc-keyboard/0.5.0/pc_keyboard/struct.Keyboard.html#method.process_keyevent" target="_blank" rel="noopener noreferrer"><code>process_keyevent</code><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 方法，在允许条件下将按键事件翻译为字符。例如，根据 shift 键是否按下，把 <code>A</code> 键的按键事件翻译为小写的 <code>a</code> 字符或大写的 <code>A</code> 字符。</p> <p>有了这个改版的中断处理函数后，我们就可以敲入文本了：</p> <p><img src="data:image/gif;base64,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" alt="在 QEMU 中敲入 &quot;Hello World&quot;"></p> <h3 id="配置键盘"><a href="#配置键盘" class="header-anchor">#</a> 配置键盘</h3> <p>PS/2 键盘的某些方面也可以配置的，例如应该使用的扫描码集。考虑到文章已经够长了，在此不再赘述，可见参见 OSDev wiki 对可能的 <a href="https://wiki.osdev.org/PS/2_Keyboard#Commands" target="_blank" rel="noopener noreferrer">配置命令<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 的概览。</p> <h2 id="总结"><a href="#总结" class="header-anchor">#</a> 总结</h2> <p>本文讲解如何启用和处理外部中断。我们学习了 8259 PIC 和它的主/副布局，中断数值的重新映射和“中断结束”信号。我们为硬件时钟和键盘实现了处理函数，并学到了 <code>hlt</code> 指令，这个指令会挂起 CPU 直至下一个中断到来。</p> <p>现在我们可以和内核交互，有了一些创建小型 shell 或简单游戏的基础组件。</p> <h2 id="下篇预告"><a href="#下篇预告" class="header-anchor">#</a> 下篇预告</h2> <p>时钟中断对操作系统是不可或缺的，它们提供了周期性中断运行中进程的途径，让内核可以重获控制权。然后内核可以切换到不同进程，创造出多个进程在并行运行的假象。</p> <p>但是创建进程或线程前，我们需要为他们分配内存的方法。下篇文章将会探究内存管理来实现这个基础组件。</p></div></section> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">Last Updated: </span> <span class="time">4/18/2021, 2:34:59 AM</span></div></footer> <!----> <div class="comments-wrapper"><!----></div> <ul class="side-bar sub-sidebar-wrapper" style="width:12rem;" data-v-70334359><li class="level-2" data-v-70334359><a href="/blog-os/blog-os-07-hardware-interrupts/#概览" class="sidebar-link reco-side-概览" data-v-70334359>概览</a></li><li class="level-2" data-v-70334359><a href="/blog-os/blog-os-07-hardware-interrupts/#_8259-pic" class="sidebar-link reco-side-_8259-pic" data-v-70334359>8259 PIC</a></li><li class="level-3" data-v-70334359><a href="/blog-os/blog-os-07-hardware-interrupts/#实现" class="sidebar-link reco-side-实现" data-v-70334359>实现</a></li><li class="level-2" data-v-70334359><a href="/blog-os/blog-os-07-hardware-interrupts/#启用中断" class="sidebar-link reco-side-启用中断" data-v-70334359>启用中断</a></li><li class="level-2" data-v-70334359><a href="/blog-os/blog-os-07-hardware-interrupts/#处理时钟中断" class="sidebar-link reco-side-处理时钟中断" data-v-70334359>处理时钟中断</a></li><li class="level-3" data-v-70334359><a href="/blog-os/blog-os-07-hardware-interrupts/#中断的结束" class="sidebar-link reco-side-中断的结束" data-v-70334359>中断的结束</a></li><li class="level-3" data-v-70334359><a href="/blog-os/blog-os-07-hardware-interrupts/#配置计时器" class="sidebar-link reco-side-配置计时器" data-v-70334359>配置计时器</a></li><li class="level-2" data-v-70334359><a href="/blog-os/blog-os-07-hardware-interrupts/#死锁" class="sidebar-link reco-side-死锁" data-v-70334359>死锁</a></li><li class="level-3" data-v-70334359><a href="/blog-os/blog-os-07-hardware-interrupts/#触发死锁" class="sidebar-link reco-side-触发死锁" data-v-70334359>触发死锁</a></li><li class="level-3" data-v-70334359><a href="/blog-os/blog-os-07-hardware-interrupts/#修复死锁" class="sidebar-link reco-side-修复死锁" data-v-70334359>修复死锁</a></li><li class="level-2" data-v-70334359><a href="/blog-os/blog-os-07-hardware-interrupts/#修复竞争条件" class="sidebar-link reco-side-修复竞争条件" data-v-70334359>修复竞争条件</a></li><li class="level-2" data-v-70334359><a href="/blog-os/blog-os-07-hardware-interrupts/#hlt-指令" class="sidebar-link reco-side-hlt-指令" data-v-70334359>hlt 指令</a></li><li class="level-2" data-v-70334359><a href="/blog-os/blog-os-07-hardware-interrupts/#键盘输入" class="sidebar-link reco-side-键盘输入" data-v-70334359>键盘输入</a></li><li class="level-3" data-v-70334359><a href="/blog-os/blog-os-07-hardware-interrupts/#读取扫描码" class="sidebar-link reco-side-读取扫描码" data-v-70334359>读取扫描码</a></li><li class="level-3" data-v-70334359><a href="/blog-os/blog-os-07-hardware-interrupts/#翻译扫描码" class="sidebar-link reco-side-翻译扫描码" data-v-70334359>翻译扫描码</a></li><li class="level-3" data-v-70334359><a href="/blog-os/blog-os-07-hardware-interrupts/#配置键盘" class="sidebar-link reco-side-配置键盘" data-v-70334359>配置键盘</a></li><li class="level-2" data-v-70334359><a href="/blog-os/blog-os-07-hardware-interrupts/#总结" class="sidebar-link reco-side-总结" data-v-70334359>总结</a></li><li class="level-2" data-v-70334359><a href="/blog-os/blog-os-07-hardware-interrupts/#下篇预告" class="sidebar-link reco-side-下篇预告" data-v-70334359>下篇预告</a></li></ul></main> <!----></div></div></div></div><div class="global-ui"><div class="back-to-ceiling" style="right:1rem;bottom:6rem;width:2.5rem;height:2.5rem;border-radius:.25rem;line-height:2.5rem;display:none;" data-v-c6073ba8 data-v-c6073ba8><svg t="1574745035067" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="5404" class="icon" data-v-c6073ba8><path d="M526.60727968 10.90185116a27.675 27.675 0 0 0-29.21455937 0c-131.36607665 82.28402758-218.69155461 228.01873535-218.69155402 394.07834331a462.20625001 462.20625001 0 0 0 5.36959153 69.94390903c1.00431239 6.55289093-0.34802892 13.13561351-3.76865779 18.80351572-32.63518765 54.11355614-51.75690182 118.55860487-51.7569018 187.94566865a371.06718723 371.06718723 0 0 0 11.50484808 91.98906777c6.53300375 25.50556257 41.68394495 28.14064038 52.69160883 4.22606766 17.37162448-37.73630017 42.14135425-72.50938081 72.80769204-103.21549295 2.18761121 3.04276886 4.15646224 6.24463696 6.40373557 9.22774369a1871.4375 1871.4375 0 0 0 140.04691725 5.34970492 1866.36093723 1866.36093723 0 0 0 140.04691723-5.34970492c2.24727335-2.98310674 4.21612437-6.18497483 6.3937923-9.2178004 30.66633723 30.70611158 55.4360664 65.4791928 72.80769147 103.21549355 11.00766384 23.91457269 46.15860503 21.27949489 52.69160879-4.22606768a371.15156223 371.15156223 0 0 0 11.514792-91.99901164c0-69.36717486-19.13165746-133.82216804-51.75690182-187.92578088-3.42062944-5.66790279-4.76302748-12.26056868-3.76865837-18.80351632a462.20625001 462.20625001 0 0 0 5.36959269-69.943909c-0.00994388-166.08943902-87.32547796-311.81420293-218.6915546-394.09823051zM605.93803103 357.87693858a93.93749974 93.93749974 0 1 1-187.89594924 6.1e-7 93.93749974 93.93749974 0 0 1 187.89594924-6.1e-7z" p-id="5405" data-v-c6073ba8></path><path d="M429.50777625 765.63860547C429.50777625 803.39355007 466.44236686 1000.39046097 512.00932183 1000.39046097c45.56695499 0 82.4922232-197.00623328 82.5015456-234.7518555 0-37.75494459-36.9345906-68.35043303-82.4922232-68.34111062-45.57627738-0.00932239-82.52019037 30.59548842-82.51086798 68.34111062z" p-id="5406" data-v-c6073ba8></path></svg></div></div></div>
    <script src="/assets/js/app.6731dc6d.js" defer></script><script src="/assets/js/3.3f52b992.js" defer></script><script src="/assets/js/1.86295094.js" defer></script><script src="/assets/js/21.cbf78bb1.js" defer></script>
  </body>
</html>
