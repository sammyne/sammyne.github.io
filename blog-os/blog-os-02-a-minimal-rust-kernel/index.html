<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>[blog os] 02. 最小化的 Rust 内核 | sammyne</title>
    <meta name="generator" content="VuePress 1.9.9">
    <link rel="icon" href="/favicon.ico">
    <meta name="description" content="Just playing around :)">
    <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no">
    
    <link rel="preload" href="/assets/css/0.styles.00c90c45.css" as="style"><link rel="preload" href="/assets/js/app.2124bf24.js" as="script"><link rel="preload" href="/assets/js/3.944fac0d.js" as="script"><link rel="preload" href="/assets/js/1.c30a1333.js" as="script"><link rel="preload" href="/assets/js/36.a3ad36a5.js" as="script"><link rel="prefetch" href="/assets/js/10.6feb556b.js"><link rel="prefetch" href="/assets/js/11.d238b802.js"><link rel="prefetch" href="/assets/js/12.92a89c73.js"><link rel="prefetch" href="/assets/js/13.05851956.js"><link rel="prefetch" href="/assets/js/14.34744b6c.js"><link rel="prefetch" href="/assets/js/15.fd1f282f.js"><link rel="prefetch" href="/assets/js/16.338c7efe.js"><link rel="prefetch" href="/assets/js/17.dd7e0805.js"><link rel="prefetch" href="/assets/js/18.7e4af78d.js"><link rel="prefetch" href="/assets/js/19.96894619.js"><link rel="prefetch" href="/assets/js/20.3d3adc8f.js"><link rel="prefetch" href="/assets/js/21.669510d2.js"><link rel="prefetch" href="/assets/js/22.4997fa99.js"><link rel="prefetch" href="/assets/js/23.88d0f3d2.js"><link rel="prefetch" href="/assets/js/24.688b92a8.js"><link rel="prefetch" href="/assets/js/25.42a3079a.js"><link rel="prefetch" href="/assets/js/26.6b1973cc.js"><link rel="prefetch" href="/assets/js/27.e2133f18.js"><link rel="prefetch" href="/assets/js/28.4850156d.js"><link rel="prefetch" href="/assets/js/29.f6cf5316.js"><link rel="prefetch" href="/assets/js/30.824ebab1.js"><link rel="prefetch" href="/assets/js/31.d5cda852.js"><link rel="prefetch" href="/assets/js/32.5d223b08.js"><link rel="prefetch" href="/assets/js/33.9c398239.js"><link rel="prefetch" href="/assets/js/34.1cfaa2c4.js"><link rel="prefetch" href="/assets/js/35.69f5a7fc.js"><link rel="prefetch" href="/assets/js/37.71d0640c.js"><link rel="prefetch" href="/assets/js/38.8e4b00cc.js"><link rel="prefetch" href="/assets/js/39.ff2dfcd8.js"><link rel="prefetch" href="/assets/js/4.908240c5.js"><link rel="prefetch" href="/assets/js/40.3262bce0.js"><link rel="prefetch" href="/assets/js/41.5eb1f517.js"><link rel="prefetch" href="/assets/js/42.efbc331e.js"><link rel="prefetch" href="/assets/js/43.d10817f1.js"><link rel="prefetch" href="/assets/js/44.5f29d6a5.js"><link rel="prefetch" href="/assets/js/45.19bf538d.js"><link rel="prefetch" href="/assets/js/46.caa3e673.js"><link rel="prefetch" href="/assets/js/47.02d2bfdd.js"><link rel="prefetch" href="/assets/js/48.8f6cdcc5.js"><link rel="prefetch" href="/assets/js/49.8874e137.js"><link rel="prefetch" href="/assets/js/5.6b0f5eca.js"><link rel="prefetch" href="/assets/js/50.c2d9cf07.js"><link rel="prefetch" href="/assets/js/51.83db0769.js"><link rel="prefetch" href="/assets/js/52.f81f5392.js"><link rel="prefetch" href="/assets/js/53.b04b70d0.js"><link rel="prefetch" href="/assets/js/54.07971080.js"><link rel="prefetch" href="/assets/js/55.674ca41a.js"><link rel="prefetch" href="/assets/js/56.862cae6b.js"><link rel="prefetch" href="/assets/js/57.3d3d7cc9.js"><link rel="prefetch" href="/assets/js/58.98ebbb9c.js"><link rel="prefetch" href="/assets/js/59.4081edac.js"><link rel="prefetch" href="/assets/js/6.81d9e9a0.js"><link rel="prefetch" href="/assets/js/60.42a820f4.js"><link rel="prefetch" href="/assets/js/61.a52bc06d.js"><link rel="prefetch" href="/assets/js/62.18da62d1.js"><link rel="prefetch" href="/assets/js/63.52f6533c.js"><link rel="prefetch" href="/assets/js/64.03c12890.js"><link rel="prefetch" href="/assets/js/65.ccfd6c32.js"><link rel="prefetch" href="/assets/js/66.a0c38aa4.js"><link rel="prefetch" href="/assets/js/67.a30f375b.js"><link rel="prefetch" href="/assets/js/68.8248dd23.js"><link rel="prefetch" href="/assets/js/69.123686ed.js"><link rel="prefetch" href="/assets/js/7.18067abc.js"><link rel="prefetch" href="/assets/js/70.a647f8ad.js"><link rel="prefetch" href="/assets/js/71.02a394bf.js"><link rel="prefetch" href="/assets/js/72.2b1e35e2.js"><link rel="prefetch" href="/assets/js/73.afa2fc7a.js"><link rel="prefetch" href="/assets/js/74.7a30b68a.js"><link rel="prefetch" href="/assets/js/75.cddbdc6c.js"><link rel="prefetch" href="/assets/js/76.7b929319.js"><link rel="prefetch" href="/assets/js/77.87e8820d.js"><link rel="prefetch" href="/assets/js/78.c68f804b.js"><link rel="prefetch" href="/assets/js/79.8b9d1881.js"><link rel="prefetch" href="/assets/js/8.8be62fa8.js"><link rel="prefetch" href="/assets/js/80.e0641939.js"><link rel="prefetch" href="/assets/js/81.2bf032f3.js"><link rel="prefetch" href="/assets/js/82.fc2e2dc0.js"><link rel="prefetch" href="/assets/js/83.eab5c475.js"><link rel="prefetch" href="/assets/js/84.48d98958.js"><link rel="prefetch" href="/assets/js/85.17986848.js"><link rel="prefetch" href="/assets/js/86.32c9a409.js"><link rel="prefetch" href="/assets/js/87.28193f1a.js"><link rel="prefetch" href="/assets/js/88.7ef5e0f3.js"><link rel="prefetch" href="/assets/js/89.e3126a19.js"><link rel="prefetch" href="/assets/js/9.49555849.js"><link rel="prefetch" href="/assets/js/90.569bbf88.js">
    <link rel="stylesheet" href="/assets/css/0.styles.00c90c45.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container no-sidebar" data-v-7dd95ae2><div data-v-7dd95ae2><div class="password-shadow password-wrapper-out" style="display:none;" data-v-59e6cb88 data-v-7dd95ae2 data-v-7dd95ae2><h3 class="title" data-v-59e6cb88>sammyne</h3> <p class="description" data-v-59e6cb88>Just playing around :)</p> <label id="box" class="inputBox" data-v-59e6cb88><input type="password" value="" data-v-59e6cb88> <span data-v-59e6cb88>Konck! Knock!</span> <button data-v-59e6cb88>OK</button></label> <div class="footer" data-v-59e6cb88><span data-v-59e6cb88><i class="iconfont reco-theme" data-v-59e6cb88></i> <a target="blank" href="https://vuepress-theme-reco.recoluan.com" data-v-59e6cb88>vuePress-theme-reco</a></span> <span data-v-59e6cb88><i class="iconfont reco-copyright" data-v-59e6cb88></i> <a data-v-59e6cb88><span data-v-59e6cb88>sammyne</span>
          
        <span data-v-59e6cb88>2020 - </span>
        2023
      </a></span></div></div> <div class="hide" data-v-7dd95ae2><header class="navbar" data-v-7dd95ae2><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/logo.svg" alt="sammyne" class="logo"> <span class="site-name">sammyne</span></a> <div class="links"><div class="color-picker"><a class="color-button"><i class="iconfont reco-color"></i></a> <div class="color-picker-menu" style="display:none;"><div class="mode-options"><h4 class="title">Choose mode</h4> <ul class="color-mode-options"><li class="dark">dark</li><li class="auto active">auto</li><li class="light">light</li></ul></div></div></div> <div class="search-box"><i class="iconfont reco-search"></i> <input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link"><i class="iconfont reco-home"></i>
  首页
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-category"></i>
      分类
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/categories/os/" class="nav-link"><i class="undefined"></i>
  os
</a></li><li class="dropdown-item"><!----> <a href="/categories/dev/" class="nav-link"><i class="undefined"></i>
  dev
</a></li><li class="dropdown-item"><!----> <a href="/categories/crypto/" class="nav-link"><i class="undefined"></i>
  crypto
</a></li><li class="dropdown-item"><!----> <a href="/categories/programming/" class="nav-link"><i class="undefined"></i>
  programming
</a></li><li class="dropdown-item"><!----> <a href="/categories/tee/" class="nav-link"><i class="undefined"></i>
  tee
</a></li><li class="dropdown-item"><!----> <a href="/categories/engineering/" class="nav-link"><i class="undefined"></i>
  engineering
</a></li><li class="dropdown-item"><!----> <a href="/categories/language/" class="nav-link"><i class="undefined"></i>
  language
</a></li><li class="dropdown-item"><!----> <a href="/categories/tool/" class="nav-link"><i class="undefined"></i>
  tool
</a></li><li class="dropdown-item"><!----> <a href="/categories/architecture/" class="nav-link"><i class="undefined"></i>
  architecture
</a></li><li class="dropdown-item"><!----> <a href="/categories/decentralization/" class="nav-link"><i class="undefined"></i>
  decentralization
</a></li><li class="dropdown-item"><!----> <a href="/categories/network/" class="nav-link"><i class="undefined"></i>
  network
</a></li><li class="dropdown-item"><!----> <a href="/categories/software engineering/" class="nav-link"><i class="undefined"></i>
  software engineering
</a></li><li class="dropdown-item"><!----> <a href="/categories/notes/" class="nav-link"><i class="undefined"></i>
  notes
</a></li></ul></div></div><div class="nav-item"><a href="/tag/" class="nav-link"><i class="iconfont reco-tag"></i>
  标签
</a></div><div class="nav-item"><a href="/timeline/" class="nav-link"><i class="iconfont reco-date"></i>
  时间轴
</a></div><div class="nav-item"><a href="https://github.com/sammyne" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="iconfont reco-github"></i>
  Github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav></div></header> <div class="sidebar-mask" data-v-7dd95ae2></div> <aside class="sidebar" data-v-7dd95ae2><div class="personal-info-wrapper" data-v-1fad0c41 data-v-7dd95ae2><img src="/avatar.png" alt="author-avatar" class="personal-img" data-v-1fad0c41> <h3 class="name" data-v-1fad0c41>
    sammyne
  </h3> <div class="num" data-v-1fad0c41><div data-v-1fad0c41><h3 data-v-1fad0c41>80</h3> <h6 data-v-1fad0c41>Articles</h6></div> <div data-v-1fad0c41><h3 data-v-1fad0c41>43</h3> <h6 data-v-1fad0c41>Tags</h6></div></div> <ul class="social-links" data-v-1fad0c41></ul> <hr data-v-1fad0c41></div> <nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link"><i class="iconfont reco-home"></i>
  首页
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-category"></i>
      分类
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/categories/os/" class="nav-link"><i class="undefined"></i>
  os
</a></li><li class="dropdown-item"><!----> <a href="/categories/dev/" class="nav-link"><i class="undefined"></i>
  dev
</a></li><li class="dropdown-item"><!----> <a href="/categories/crypto/" class="nav-link"><i class="undefined"></i>
  crypto
</a></li><li class="dropdown-item"><!----> <a href="/categories/programming/" class="nav-link"><i class="undefined"></i>
  programming
</a></li><li class="dropdown-item"><!----> <a href="/categories/tee/" class="nav-link"><i class="undefined"></i>
  tee
</a></li><li class="dropdown-item"><!----> <a href="/categories/engineering/" class="nav-link"><i class="undefined"></i>
  engineering
</a></li><li class="dropdown-item"><!----> <a href="/categories/language/" class="nav-link"><i class="undefined"></i>
  language
</a></li><li class="dropdown-item"><!----> <a href="/categories/tool/" class="nav-link"><i class="undefined"></i>
  tool
</a></li><li class="dropdown-item"><!----> <a href="/categories/architecture/" class="nav-link"><i class="undefined"></i>
  architecture
</a></li><li class="dropdown-item"><!----> <a href="/categories/decentralization/" class="nav-link"><i class="undefined"></i>
  decentralization
</a></li><li class="dropdown-item"><!----> <a href="/categories/network/" class="nav-link"><i class="undefined"></i>
  network
</a></li><li class="dropdown-item"><!----> <a href="/categories/software engineering/" class="nav-link"><i class="undefined"></i>
  software engineering
</a></li><li class="dropdown-item"><!----> <a href="/categories/notes/" class="nav-link"><i class="undefined"></i>
  notes
</a></li></ul></div></div><div class="nav-item"><a href="/tag/" class="nav-link"><i class="iconfont reco-tag"></i>
  标签
</a></div><div class="nav-item"><a href="/timeline/" class="nav-link"><i class="iconfont reco-date"></i>
  时间轴
</a></div><div class="nav-item"><a href="https://github.com/sammyne" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="iconfont reco-github"></i>
  Github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav> <!----> </aside> <div class="password-shadow password-wrapper-in" style="display:none;" data-v-59e6cb88 data-v-7dd95ae2><h3 class="title" data-v-59e6cb88>[blog os] 02. 最小化的 Rust 内核</h3> <!----> <label id="box" class="inputBox" data-v-59e6cb88><input type="password" value="" data-v-59e6cb88> <span data-v-59e6cb88>Konck! Knock!</span> <button data-v-59e6cb88>OK</button></label> <div class="footer" data-v-59e6cb88><span data-v-59e6cb88><i class="iconfont reco-theme" data-v-59e6cb88></i> <a target="blank" href="https://vuepress-theme-reco.recoluan.com" data-v-59e6cb88>vuePress-theme-reco</a></span> <span data-v-59e6cb88><i class="iconfont reco-copyright" data-v-59e6cb88></i> <a data-v-59e6cb88><span data-v-59e6cb88>sammyne</span>
          
        <span data-v-59e6cb88>2020 - </span>
        2023
      </a></span></div></div> <div data-v-7dd95ae2><div data-v-7dd95ae2><main class="page"><section style="display:;"><div class="page-title"><h1 class="title">[blog os] 02. 最小化的 Rust 内核</h1> <div data-v-8a445198><i class="iconfont reco-account" data-v-8a445198><span data-v-8a445198>sammyne</span></i> <i class="iconfont reco-date" data-v-8a445198><span data-v-8a445198>7/17/2020</span></i> <i class="iconfont reco-eye" data-v-8a445198><span id="/blog-os/blog-os-02-a-minimal-rust-kernel/" data-flag-title="Your Article Title" class="leancloud-visitors" data-v-8a445198><a class="leancloud-visitors-count" style="font-size:.9rem;font-weight:normal;color:#999;"></a></span></i> <i class="tags iconfont reco-tag" data-v-8a445198><span class="tag-item" data-v-8a445198>blog_os</span><span class="tag-item" data-v-8a445198>rust</span></i></div></div> <div class="theme-reco-content content__default"><blockquote><p>原文连接：<a href="https://os.phil-opp.com/minimal-rust-kernel/" target="_blank" rel="noopener noreferrer">A Minimal Rust Kernel<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p></blockquote> <p>本文将基于 x86 架构，使用 Rust 语言编写一个最小化的 64 位内核。我们将在上一篇文章的独立式可执行程序的基础上，构建一个能够引导启动的磁盘镜像，它将向显示器打印字符串。</p> <p>此博客在 <a href="https://github.com/phil-opp/blog_os" target="_blank" rel="noopener noreferrer">GitHub<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 上公开开发。如果您有任何问题或疑问，请在此处打开一个问题。 您也可以在 <a href="#valine">底部</a> 发表评论。这篇文章的完整源代码可以在 <a href="https://github.com/sammyne/blog-os-cn/tree/master/02-minimal-rust-kernel" target="_blank" rel="noopener noreferrer">blog-os-cn/02-minimal-rust-kernel<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 找到。</p> <h2 id="引导启动"><a href="#引导启动" class="header-anchor">#</a> 引导启动</h2> <p>电脑启动后，会接着运行主板 ROM 存储的固件代码。这份代码负责电脑的 <a href="https://en.wikipedia.org/wiki/Power-on_self-test" target="_blank" rel="noopener noreferrer">加电自检<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>，可用 <a href="https://en.wikipedia.org/wiki/Read-only_memory" target="_blank" rel="noopener noreferrer">内存<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 的检测，CPU 和其它硬件的预加载。然后，它将寻找一个可引导的磁盘，并开始启动其中的操作系统内核。</p> <p>x86 架构支持两种固件标准：<a href="https://en.wikipedia.org/wiki/BIOS" target="_blank" rel="noopener noreferrer">BIOS<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>（Basic Input/Output System）和 <a href="https://en.wikipedia.org/wiki/Unified_Extensible_Firmware_Interface" target="_blank" rel="noopener noreferrer">UEFI<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>（Unified Extensible Firmware Interface）。其中，BIOS 标准虽然古老和落伍了，但实现简单，并很好得到 1980 年后所有 x86 设备的支持；相反地，UEFI 更现代化，功能也更全面，但环境搭建比较复杂（至少从个人角度看是这样的）。</p> <p>我们目前只提供 BIOS 的引导启动方式，对 UEFI 的支持也在规划中。如果你乐于助人的话，请加入到这个 <a href="https://github.com/phil-opp/blog_os/issues/349" target="_blank" rel="noopener noreferrer">Github issue<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 吧。</p> <h2 id="bios-启动"><a href="#bios-启动" class="header-anchor">#</a> BIOS 启动</h2> <p>几乎所有 x86 硬件系统都支持 BIOS 启动，这也包含 UEFI 驱动的模拟 BIOS 模式的新型机器。这可以说是一件好事情，因为无论是上世纪还是现在的机器，都可以使用相同的启动逻辑；但这种兼容性同时也是 BIOS 引导启动最大的缺点，因为在系统启动前，CPU 必须先进入一个 16 位系统兼容的 <a href="https://en.wikipedia.org/wiki/Real_mode" target="_blank" rel="noopener noreferrer">实模式<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>，这样 1980 年代古老的引导固件才能够继续使用。</p> <p>让我们从头开始，梳理一遍 BIOS 启动的过程。</p> <p>当电脑启动时，主板的某些特殊闪存中存储的 BIOS 固件将被加载。BIOS 固件将会加电自检、初始化硬件，然后它将寻找一个可引导启动的磁盘。如果找到了，那电脑的控制权将被转交给<em>引导程序</em>（bootloader）：一段存储在磁盘开头的、512 字节的可执行代码片段。大多数的引导程序长度都大于 512 字节，所以通常情况下，引导程序都被切分为长度不超过 512 字节的第一阶段引导程序，和随后由第一阶段引导程序加载的第二阶段引导程序。</p> <p>引导程序必须决定内核在磁盘的位置，并将内核加载到内存。引导程序还需要将 CPU 从 16 位的 <a href="https://en.wikipedia.org/wiki/Real_mode" target="_blank" rel="noopener noreferrer">实模式<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>，先切换到 32 位的 <a href="https://en.wikipedia.org/wiki/Protected_mode" target="_blank" rel="noopener noreferrer">保护模式<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>，最终切换到 64 位的 <a href="https://en.wikipedia.org/wiki/Long_mode" target="_blank" rel="noopener noreferrer">长模式<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>：此时，所有的 64 位寄存器和整个主内存才能被访问。引导程序的第三个作用，是从 BIOS 查询特定的信息（如内存映射表），并将其传递到操作系统内核。</p> <p>编写一个引导程序并不是一个简单的任务，因为这需要使用汇编语言，而且必须经过许多晦涩的步骤--比如，把一些魔法数字（magic number）写入某个处理器寄存器。因此，这篇博文不会讲解如何创建引导程序，而是提供一个名为 bootimage 的工具--它能够自动为我们的内核添加引导程序作为前缀。</p> <h3 id="multiboot-标准"><a href="#multiboot-标准" class="header-anchor">#</a> Multiboot 标准</h3> <p>为了避免每个操作系统都实现只兼容自己单个操作系统的引导程序，<a href="https://en.wikipedia.org/wiki/Free_Software_Foundation" target="_blank" rel="noopener noreferrer">自由软件基金会<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 在 1995 年颁布了一个开源的引导程序标准--<a href="https://wiki.osdev.org/Multiboot" target="_blank" rel="noopener noreferrer">Multiboot<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>。这个标准定义了引导程序和操作系统间的接口，所以任何兼容 Multiboot 的引导程序，都能用来加载任何同样兼容了 Multiboot 的操作系统。<a href="https://en.wikipedia.org/wiki/GNU_GRUB" target="_blank" rel="noopener noreferrer">GNU GRUB<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 是一个可供参考的 Multiboot 实现，它也是最热门的 Linux 系统引导程序之一。</p> <p>要编写一款适配 Multiboot 的内核，我们只需要在内核文件开头插入被称作 <a href="https://www.gnu.org/software/grub/manual/multiboot/multiboot.html#OS-image-format" target="_blank" rel="noopener noreferrer">Multiboot 头<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 的数据片段。这让 GRUB 很轻易就能引导任何操作系统，但是GRUB 和 Multiboot 标准也有一些问题：</p> <ul><li>它们只支持 32 位的保护模式。这意味着我们依然需要配置 CPU，让它切换到 64 位的长模式</li> <li>它们被设计为精简引导程序，而不是精简内核。举个例子，内核需要连接到 <a href="https://wiki.osdev.org/Multiboot#Multiboot_2" target="_blank" rel="noopener noreferrer">调整过的默认页大小<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>，否则 GRUB 将无法找到内核的 Multiboot 头。另一个例子是传给内核的 <a href="https://www.gnu.org/software/grub/manual/multiboot/multiboot.html#Boot-information-format" target="_blank" rel="noopener noreferrer">引导信息<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>，它包含着大量与架构有关的数据结构，而没有提供一层简洁的抽象</li> <li>GRUB 和 Multiboot 标准并没有详细解释，阅读相关文档需要一定经验</li> <li>为了基于内核文件创建一个能够被引导的磁盘映像，宿主机系统必须安装 GRUB：这加大了基于 Windows 或 macOS 开发内核的难度</li></ul> <p>出于这些考虑，我们决定不使用 GRUB 或者 Multiboot 标准。然而，<a href="https://github.com/rust-osdev/bootimage" target="_blank" rel="noopener noreferrer">bootimage<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 工具支持 Multiboot 也在规划中，使得 GRUB 系统也可以加载我们的内核。如果你对编写一个 Multiboot 兼容的内核感兴趣的话，参见这个博客系列的 <a href="https://os.phil-opp.com/first-edition/" target="_blank" rel="noopener noreferrer">第一版<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>。</p> <h3 id="uefi"><a href="#uefi" class="header-anchor">#</a> UEFI</h3> <p>（目前我们尚未支持 UEFI，但是很乐于支持！如果你能帮忙的话，请在 <a href="https://github.com/phil-opp/blog_os/issues/349" target="_blank" rel="noopener noreferrer">Github issue<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 提醒我们）</p> <h2 id="最小化内核"><a href="#最小化内核" class="header-anchor">#</a> 最小化内核</h2> <p>现在基本明白电脑是如何启动的，那也是时候编写我们自己的内核了。小目标是创建一个内核的磁盘映像，它能够在启动时向屏幕输出一行“Hello World!”。我们的工作将基于上一篇博文构建的 <a href="/2020/07/09/blog-os-01-freestanding-rust-binary">独立的 Rust 二进制</a>。</p> <p>如果没忘记的话，我们使用 <code>cargo</code> 构建了一个独立的二进制程序，但是构建过程因操作系统而异，需要不同的入口函数名和编译选项。这是因为 <code>cargo</code> 默认会基于 <em>宿主系统</em> 进行构建，即当前运行的系统。这并不是我们内核想要的，运行在诸如 Windows 上的内核意义不大。确切地说，我们想要基于一个明确定义的 <em>目标系统</em> 编译我们的内核。</p> <h3 id="安装-rust-nightly"><a href="#安装-rust-nightly" class="header-anchor">#</a> 安装 Rust Nightly</h3> <p>Rust 语言有三种发行版：<em>stable</em>、<em>beta</em> 和 <em>nightly</em>。《Rust 程序设计语言》对这三种版本的区别解释得很详细，可以花点时间自行 <a href="https://doc.rust-lang.org/book/appendix-07-nightly-rust.html#choo-choo-release-channels-and-riding-the-trains" target="_blank" rel="noopener noreferrer">了解一下<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>。为了构建一个操作系统，我们需要一些只有 nightly 版提供的实验性特性，所以需要安装一个 nightly 版本的 Rust。</p> <p>为了管理 Rust 的安装，我强烈建议使用 <a href="https://www.rustup.rs/" target="_blank" rel="noopener noreferrer">rustup<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>。它允许你同时安装 nightly、beta 和 stable 版本的编译器，而且让更新它们变得容易。我们可以执行 <code>rustup override add nightly</code> 使得当前目录使用 nightly 版本的 Rust。或者，也可以在项目根目录添加一个内容为 <code>nightly</code>、名为 <code>rust-toolchain</code> 的文件。要检查你是否已经安装了一个 nightly，你可以运行 <code>rustc --version</code>：返回的版本号末尾应该包含 <code>-nightly</code>。</p> <p>Nightly 版本的编译器允许我们在源码开头插入 <em>特性标记符</em>，自由选择并使用大量实验性的特性。举个例子，要使用实验性的 <a href="https://doc.rust-lang.org/unstable-book/library-features/asm.html" target="_blank" rel="noopener noreferrer"><code>asm!</code> 宏<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 启用内联汇编，可以在 <code>main.rs</code> 的顶部添加 <code>#![feature(asm)]</code>。要注意的是，这样的实验性特性是不稳定的，意味着未来的 Rust 版本可能会在毫无预警的情况下修改或移除这些功能。因此，除非绝对必要，否则不要使用这些特性。</p> <h3 id="目标配置"><a href="#目标配置" class="header-anchor">#</a> 目标配置</h3> <p>Cargo 借助 <code>--target</code> 参数支持不同的目标系统。这个目标系统可以使用一个所谓的 <a href="https://clang.llvm.org/docs/CrossCompilation.html#target-triple" target="_blank" rel="noopener noreferrer">目标三元组（target triple）<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 来描述，内容包括 CPU 架构、平台供应商、操作系统和 <a href="https://stackoverflow.com/a/2456882" target="_blank" rel="noopener noreferrer">ABI<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>。比方说，目标三元组 <code>x86_64-unknown-linux-gnu</code> 描述一个基于 <code>x86_64</code> 架构 CPU、没有明确的平台供应商的 linux 系统，它遵循 GNU 风格的 ABI。Rust 支持 <a href="https://forge.rust-lang.org/release/platform-support.html" target="_blank" rel="noopener noreferrer">许多不同的目标三元组<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>，包括安卓系统对应的 <code>arm-linux-androideabi</code> 和 WebAssembly 使用的 <a href="https://www.hellorust.com/setup/wasm-target/" target="_blank" rel="noopener noreferrer">wasm32-unknown-unknown<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>。</p> <p>为了编写我们的目标系统，并且鉴于需要做一些特殊的配置（比如没有依赖的底层操作系统），没有现成的 <a href="https://forge.rust-lang.org/release/platform-support.html" target="_blank" rel="noopener noreferrer">目标三元组<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 满足我们的要求。好在 Rust 允许利用 JSON 文件定制 <a href="https://doc.rust-lang.org/nightly/rustc/targets/custom.html" target="_blank" rel="noopener noreferrer">自己的目标<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>。比如，一个描述 <code>x86_64-unknown-linux-gnu</code> 目标系统的配置清单大概长这样：</p> <div class="language-json line-numbers-mode"><pre class="language-json"><code><span class="token punctuation">{</span>
    <span class="token property">&quot;llvm-target&quot;</span><span class="token operator">:</span> <span class="token string">&quot;x86_64-unknown-linux-gnu&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;data-layout&quot;</span><span class="token operator">:</span> <span class="token string">&quot;e-m:e-i64:64-f80:128-n8:16:32:64-S128&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;arch&quot;</span><span class="token operator">:</span> <span class="token string">&quot;x86_64&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;target-endian&quot;</span><span class="token operator">:</span> <span class="token string">&quot;little&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;target-pointer-width&quot;</span><span class="token operator">:</span> <span class="token string">&quot;64&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;target-c-int-width&quot;</span><span class="token operator">:</span> <span class="token string">&quot;32&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;os&quot;</span><span class="token operator">:</span> <span class="token string">&quot;linux&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;executables&quot;</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    <span class="token property">&quot;linker-flavor&quot;</span><span class="token operator">:</span> <span class="token string">&quot;gcc&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;pre-link-args&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&quot;-m64&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token property">&quot;morestack&quot;</span><span class="token operator">:</span> <span class="token boolean">false</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><p>多数字段都被 LLVM 用于为这个平台生成代码。例如，<a href="https://llvm.org/docs/LangRef.html#data-layout" target="_blank" rel="noopener noreferrer">data-layout<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 配置项定义了不同的整数、浮点数和指针类型的长度。另外，还有一些 Rust 用作条件编译的配置项，如 <code>target-pointer-width</code>。还有一些类型的配置项定义了这个包该如何编译。例如，<code>pre-link-args</code> 配置项指定了应该向 <a href="https://en.wikipedia.org/wiki/Linker_(computing)" target="_blank" rel="noopener noreferrer">链接器<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 传入的参数。</p> <p>我们将基于 <code>x86_64</code> 系统构建内核，所以配置清单将和上面的例子非常相似。现在，我们创建一个内容如下的 <code>x86_64-blog_os.json</code> 文件（名字根据个人喜好调整）：</p> <div class="language-json line-numbers-mode"><pre class="language-json"><code><span class="token punctuation">{</span>
    <span class="token property">&quot;llvm-target&quot;</span><span class="token operator">:</span> <span class="token string">&quot;x86_64-unknown-none&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;data-layout&quot;</span><span class="token operator">:</span> <span class="token string">&quot;e-m:e-i64:64-f80:128-n8:16:32:64-S128&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;arch&quot;</span><span class="token operator">:</span> <span class="token string">&quot;x86_64&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;target-endian&quot;</span><span class="token operator">:</span> <span class="token string">&quot;little&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;target-pointer-width&quot;</span><span class="token operator">:</span> <span class="token string">&quot;64&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;target-c-int-width&quot;</span><span class="token operator">:</span> <span class="token string">&quot;32&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;os&quot;</span><span class="token operator">:</span> <span class="token string">&quot;none&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;executables&quot;</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>值得注意的是，因为要在裸机上运行内核，我们修改了 <code>llvm-target</code> 的内容，将 <code>os</code> 配置项的值改为 <code>none</code>。</p> <p>我们还添加以下与编译相关的配置项：</p> <div class="language-json line-numbers-mode"><pre class="language-json"><code><span class="token property">&quot;linker-flavor&quot;</span><span class="token operator">:</span> <span class="token string">&quot;ld.lld&quot;</span><span class="token punctuation">,</span>
<span class="token property">&quot;linker&quot;</span><span class="token operator">:</span> <span class="token string">&quot;rust-lld&quot;</span><span class="token punctuation">,</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>在这里，我们不使用平台的默认链接器（它可能不支持 Linux 目标系统），而是使用随 Rust 一起打包发布的跨平台的 <a href="https://lld.llvm.org/" target="_blank" rel="noopener noreferrer">LLD<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 链接器来链接内核。</p> <div class="language-json line-numbers-mode"><pre class="language-json"><code><span class="token property">&quot;panic-strategy&quot;</span><span class="token operator">:</span> <span class="token string">&quot;abort&quot;</span><span class="token punctuation">,</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>这个配置项的意思是，我们的编译目标不支持 panic 时的 <a href="https://www.bogotobogo.com/cplusplus/stackunwinding.php" target="_blank" rel="noopener noreferrer">栈展开<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>，所以我们选择在 panic 时直接退出。这和在 Cargo.toml 文件中添加 <code>panic = &quot;abort&quot;</code> 选项的作用是相同的，所以我们可以从配置清单中移除这一项（需要注意的是，与 Cargo.toml 的选项相比，这个目标选项在文章的后续部分重新编译 <code>core</code> 库时同样适用。因此，即使我们偏爱保留 Cargo.toml 中的选项，请务必添加这个选项）。</p> <div class="language-json line-numbers-mode"><pre class="language-json"><code><span class="token property">&quot;disable-redzone&quot;</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>我们正在编写一个内核，所以将来某个时候应该需要处理中断。要安全地实现这一点，我们必须禁用称为红灯区的栈指针优化，否则这个优化会污染栈。详情参见另外一篇解释 <a href="https://os.phil-opp.com/red-zone/" target="_blank" rel="noopener noreferrer">禁用红灯区<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 的博文。</p> <div class="language-json line-numbers-mode"><pre class="language-json"><code><span class="token property">&quot;features&quot;</span><span class="token operator">:</span> <span class="token string">&quot;-mmx,-sse,+soft-float&quot;</span><span class="token punctuation">,</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p><code>features</code> 字段用于启用或禁用某个目标特性。通过在它们前面添加减号，我们将 <code>mmx</code> 和 <code>sse</code> 特性禁用；添加前缀加号，启用 <code>soft-float</code> 特性。</p> <p><code>mmx</code> 和 <code>sse</code> 特性决定了是否支持 <a href="https://en.wikipedia.org/wiki/SIMD" target="_blank" rel="noopener noreferrer">单指令多数据流<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 相关指令，这些指令常常能显著地提高程序性能。然而，在内核中使用庞大的 SIMD 寄存器会造成较大的性能问题。因为继续执行每次程序中断前，内核必须还原整个庞大的 SIMD 寄存器的状态。这意味着，每次硬件中断或系统调用，完整的 SIMD 状态必须转存到主存。由于 SIMD 状态可能相当大（512~1600 个字节），而中断可能经常发生，这些额外的存储与恢复操作会显著地降低性能。为解决这个问题，我们为内核禁用 SIMD（但这不意味着禁用内核上应用程序的 SIMD 支持）。</p> <p>禁用 SIMD 产生的一个问题是，<code>x86_64</code> 架构的浮点数指针运算默认依赖 SIMD 寄存器。我们的解决方法是，启用 <code>soft-float</code> 特性，它将使用基于常规整数的软件函数模拟浮点数运算。</p> <p>更多详情参见我们关于 <a href="https://os.phil-opp.com/disable-simd/" target="_blank" rel="noopener noreferrer">禁用 SIMD<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 的博文。</p> <h3 id="串到一起"><a href="#串到一起" class="header-anchor">#</a> 串到一起</h3> <p>现在将各个配置项整合在一起。我们的目标配置清单应该长这样：</p> <div class="language-json line-numbers-mode"><pre class="language-json"><code><span class="token punctuation">{</span>
  <span class="token property">&quot;llvm-target&quot;</span><span class="token operator">:</span> <span class="token string">&quot;x86_64-unknown-none&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;data-layout&quot;</span><span class="token operator">:</span> <span class="token string">&quot;e-m:e-i64:64-f80:128-n8:16:32:64-S128&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;arch&quot;</span><span class="token operator">:</span> <span class="token string">&quot;x86_64&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;target-endian&quot;</span><span class="token operator">:</span> <span class="token string">&quot;little&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;target-pointer-width&quot;</span><span class="token operator">:</span> <span class="token string">&quot;64&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;target-c-int-width&quot;</span><span class="token operator">:</span> <span class="token string">&quot;32&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;os&quot;</span><span class="token operator">:</span> <span class="token string">&quot;none&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;executables&quot;</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
  <span class="token property">&quot;linker-flavor&quot;</span><span class="token operator">:</span> <span class="token string">&quot;ld.lld&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;linker&quot;</span><span class="token operator">:</span> <span class="token string">&quot;rust-lld&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;panic-strategy&quot;</span><span class="token operator">:</span> <span class="token string">&quot;abort&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;disable-redzone&quot;</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
  <span class="token property">&quot;features&quot;</span><span class="token operator">:</span> <span class="token string">&quot;-mmx,-sse,+soft-float&quot;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><h3 id="构建我们的内核"><a href="#构建我们的内核" class="header-anchor">#</a> 构建我们的内核</h3> <p>要编译我们的新目标环境会使用 Linux 系统的编写风格（这可能是 LLVM 的默认风格）。这意味着，我们需要 <a href="/2020/07/09/blog-os-01-freestanding-rust-binary">前一篇文章</a> 编写的名为 <code>_start</code> 的入口函数：</p> <div class="language-rust line-numbers-mode"><pre class="language-rust"><code><span class="token comment">// src/main.rs</span>

<span class="token attribute attr-name">#![no_std]</span> <span class="token comment">// 不链接 Rust 标准库</span>
<span class="token attribute attr-name">#![no_main]</span> <span class="token comment">// 禁用所有 Rust 层级的入口点</span>

<span class="token keyword">use</span> <span class="token namespace">core<span class="token punctuation">::</span>panic<span class="token punctuation">::</span></span><span class="token class-name">PanicInfo</span><span class="token punctuation">;</span>

<span class="token comment">/// 这个函数将在 panic 时被调用</span>
<span class="token attribute attr-name">#[panic_handler]</span>
<span class="token keyword">fn</span> <span class="token function-definition function">panic</span><span class="token punctuation">(</span>_info<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token class-name">PanicInfo</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token operator">!</span> <span class="token punctuation">{</span>
    <span class="token keyword">loop</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token attribute attr-name">#[no_mangle]</span> <span class="token comment">// 不重整函数名</span>
<span class="token keyword">pub</span> <span class="token keyword">extern</span> <span class="token string">&quot;C&quot;</span> <span class="token keyword">fn</span> <span class="token function-definition function">_start</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token operator">!</span> <span class="token punctuation">{</span>
    <span class="token comment">// 因为编译器会寻找一个名为 `_start` 的函数，所以这个函数就是入口点</span>
    <span class="token comment">// 默认命名为 `_start`</span>
    <span class="token keyword">loop</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><p>注意的是，无论开发时的宿主操作系统是哪种，你都需要将入口函数命名为 <code>_start</code>。</p> <p>通过把 JSON 文件名传给 <code>--target</code> 选项，我们现在可以基于新目标编译内核了。</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token operator">&gt;</span> <span class="token function">cargo</span> build <span class="token parameter variable">--target</span> x86_64-blog_os.json

error<span class="token punctuation">[</span>E0463<span class="token punctuation">]</span>: can't <span class="token function">find</span> crate <span class="token keyword">for</span> <span class="token variable"><span class="token variable">`</span>core<span class="token variable">`</span></span> 
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>哇哦，编译失败了！输出的错误提示我们，Rust 编译器找不到 <a href="https://doc.rust-lang.org/nightly/core/index.html" target="_blank" rel="noopener noreferrer">core 库<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>。而所有 <code>no_std</code> 类型的 crate 都隐式链接这个库，这个库包含基础的 Rust 类型，如 <code>Result</code>、<code>Option</code> 和迭代器等。</p> <p>问题出在，core 库以 <em>预编译</em> 库的形式与 Rust 编译器一同发布。所以，core 库只对支持的宿主系统有用（例如，<code>x86_64-unknown-linux-gnu</code>），而对我们自定义的目标系统无效。如果想为其它目标编译代码，我们需要首先为这些目标重新编译整个 core 库。</p> <h4 id="build-std-选项"><a href="#build-std-选项" class="header-anchor">#</a> <code>build-std</code> 选项</h4> <p>这时就可以用上 cargo 的 <a href="https://doc.rust-lang.org/nightly/cargo/reference/unstable.html#build-std" target="_blank" rel="noopener noreferrer"><code>build-std</code> 特性<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 了。它支持按需重新编译 <code>core</code> 和其他标准库 crate，而不是使用随 Rust 安装包一起发布的预编译版本。这个特性还非常年轻且尚未开发完成，所以被标记为 “unstable”，只在 <a href="#%E5%AE%89%E8%A3%85-rust-nightly">nightly 版的 Rust 编译器</a> 可用。</p> <p>启用这个特性需要创建包含以下内容的 <code>.cargo/config.toml</code> <a href="https://doc.rust-lang.org/cargo/reference/config.html" target="_blank" rel="noopener noreferrer">cargo 配置<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 文件</p> <div class="language-toml line-numbers-mode"><pre class="language-toml"><code><span class="token comment"># in .cargo/config.toml</span>

<span class="token punctuation">[</span><span class="token table class-name">unstable</span><span class="token punctuation">]</span>
<span class="token key property">build-std</span> <span class="token punctuation">=</span> <span class="token punctuation">[</span><span class="token string">&quot;core&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;compiler_builtins&quot;</span><span class="token punctuation">]</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>这告诉 cargo 要重新编译 <code>core</code> 和 <code>compiler_builtins</code> 库。需要后者的原因是 <code>core</code> 依赖它。为了重新编译这些库，cargo 需要访问 rust 的源码，可通过 <code>rustup component add rust-src</code> 命令安装。</p> <div class="custom-block tip"><p class="title">温馨提示</p><p><code>unstable.build-std</code> 配置要求至少 2020-07-15 后的 nightly 版 Rust。</p></div><p>设置好 <code>unstable.build-std</code> 键和安装 <code>rust-src</code> 组件后，重新运行 build 命令：</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token operator">&gt;</span> <span class="token function">cargo</span> build <span class="token parameter variable">--target</span> x86_64-blog_os.json
   Compiling core v0.0.0 <span class="token punctuation">(</span>/…/rust/src/libcore<span class="token punctuation">)</span>
   Compiling rustc-std-workspace-core v1.99.0 <span class="token punctuation">(</span>/…/rust/src/tools/rustc-std-workspace-core<span class="token punctuation">)</span>
   Compiling compiler_builtins v0.1.32
   Compiling blog_os v0.1.0 <span class="token punctuation">(</span>/…/blog_os<span class="token punctuation">)</span>
    Finished dev <span class="token punctuation">[</span>unoptimized + debuginfo<span class="token punctuation">]</span> target<span class="token punctuation">(</span>s<span class="token punctuation">)</span> <span class="token keyword">in</span> <span class="token number">0.29</span> secs
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>可以看到 <code>cargo build</code> 现在会为我们的定制目标重新编译 <code>core</code>、<code>rustc-std-workspace-core</code>（<code>compiler_builtins</code> 的依赖）和 <code>compiler_builtins</code> 库。</p> <h4 id="内存相关内部细节"><a href="#内存相关内部细节" class="header-anchor">#</a> 内存相关内部细节</h4> <p>Rust 编译器假设所有系统都有一批同样内置的函数。这些函数大多数由刚才重新编译的 <code>compiler_builtins</code> crate 提供。但是某些通常由系统 C 语言库提供的一些内存操作相关的函数默认没有被这个 crate 启用。这些函数包括把某个内存块置为特定值的 <code>memset</code>、从一个块复制值到另一个块的 <code>memcpy</code> 和比较两个内存块的 <code>memcmp</code>。虽然编译我们的内核暂时还不用不上这些函数的任何一个，但是后续添加更多代码时就会用到（例如，复制 struct 来到处传递时）。</p> <p>因为无法连接到操作系统的 C 语言库，我们那需要其他方法来为编译器提供这些函数。其中一种可行的方式就是实现我们那自己的 <code>memset</code> 等函数，并为其应用 <code>#[no_mangle]</code> 属性（为了避免编译时的自动重命名）。然而，这是很危险的--这些函数的实现稍有不当就会导致未定义行为。例如，使用 <code>for</code> 循环实现 <code>memcpy</code> 可能会导致无限递归，因为 <code>for</code> 循环会隐式调用 <a href="https://doc.rust-lang.org/stable/core/iter/trait.IntoIterator.html#tymethod.into_iter" target="_blank" rel="noopener noreferrer"><code>IntoIterator::into_iter</code><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 方法，这个方法可能会再次调用 <code>memcpy</code>。所以，复用现有经过充分测试的实现是个好方法。</p> <p>好在，<code>compiler_builtins</code> crate 已经包含了这些所需函数的实现，只是默认为了避免和 C 语言库的冲突而未启用而已。通过设置 cargo 的 <a href="https://doc.rust-lang.org/nightly/cargo/reference/unstable.html#build-std-features" target="_blank" rel="noopener noreferrer"><code>build-std-features</code><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 标识符未 <code>[&quot;compiler-builtins-mem&quot;]</code> 来启用它们。和 <code>build-std</code> 标识符类似，这个标识符可以通过命令行的 <code>-Z</code> 标识符传递或者通过 <code>.cargo/config.toml</code> 文件的 <code>unstable</code> 表格配置。由于我们的构建总要使用这个标识符，借助配置文件的方式看起来要合理一点：</p> <div class="language-toml line-numbers-mode"><pre class="language-toml"><code><span class="token comment"># in .cargo/config.toml</span>

<span class="token punctuation">[</span><span class="token table class-name">unstable</span><span class="token punctuation">]</span>
<span class="token key property">build-std-features</span> <span class="token punctuation">=</span> <span class="token punctuation">[</span><span class="token string">&quot;compiler-builtins-mem&quot;</span><span class="token punctuation">]</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>（<code>compiler-builtins-mem</code> 特性的支持是在 <a href="https://github.com/rust-lang/rust/pull/77284" target="_blank" rel="noopener noreferrer">最近才添加的<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>，所以要求的 Rust 版本至少为 <code>2020-09-30</code>。）</p> <p>内地里，这个标识符启用 <code>compiler_builtins</code> crate 的 <a href="https://github.com/rust-lang/compiler-builtins/blob/eff506cd49b637f1ab5931625a33cef7e91fbbf6/Cargo.toml#L51-L52" target="_blank" rel="noopener noreferrer"><code>mem</code> 特性<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>。这个特性的效果是 crate 的 [<code>memcpy</code> 等实现] 都有 <code>#[no_mangle]</code> 属性修饰，使得链接器能够访问到它们。值得注意的是，这些函数不会立即 <a href="https://github.com/rust-lang/compiler-builtins/issues/339" target="_blank" rel="noopener noreferrer">被优化掉<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>，他们的性能可能不会最好的，但至少是正确的。对于 <code>x86_64</code>，有个进行中的 PR <a href="https://github.com/rust-lang/compiler-builtins/pull/365" target="_blank" rel="noopener noreferrer">使用特殊的汇编指令优化这些函数<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>。</p> <p>有了这个更新后，我们的内核就有了编译器需要的所有函数实现，所以即使后续代码变得更加复杂，内核仍然能继续编译通过。</p> <h3 id="设置默认目标"><a href="#设置默认目标" class="header-anchor">#</a> 设置默认目标</h3> <p>为了避免每次执行 <code>cargo build</code> 时传递 <code>--target</code> 参数，我们可以覆写默认的编译目标。往 <a href="https://doc.rust-lang.org/cargo/reference/config.html" target="_blank" rel="noopener noreferrer">cargo 配置<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 文件 <code>.cargo/config.toml</code> 添加下面的内容即可：</p> <div class="language-toml line-numbers-mode"><pre class="language-toml"><code><span class="token comment"># in .cargo/config.toml</span>

<span class="token punctuation">[</span><span class="token table class-name">build</span><span class="token punctuation">]</span>
<span class="token key property">target</span> <span class="token punctuation">=</span> <span class="token string">&quot;x86_64-blog_os.json&quot;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>这里的配置告诉 <code>cargo</code> 在没有显式声明目标的情况下，使用我们提供的 <code>x86_64-blog_os.json</code> 作为目标配置。这意味着我们可以直接使用 <code>cargo build</code> 构建内核了。<a href="https://doc.rust-lang.org/cargo/reference/config.html" target="_blank" rel="noopener noreferrer">官方文档<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 对 cargo 配置项有更详细的说明。</p> <p>现在我们借助简单的 <code>cargo build</code> 即可为裸机目标编译内核了。然而，启动加载器调用的 <code>_start</code> 入口函数还是空的。是时候在里面往屏幕打印一些东西了。</p> <h3 id="向屏幕打印字符"><a href="#向屏幕打印字符" class="header-anchor">#</a> 向屏幕打印字符</h3> <p>目前往屏幕打印文本最简单的方式是 <a href="https://en.wikipedia.org/wiki/VGA-compatible_text_mode" target="_blank" rel="noopener noreferrer">VGA 文本缓冲区<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>。这是一段映射到 VGA 硬件的特殊内存片段，包含着显示在屏幕上的内容。通常情况下，它能够存储 25 行、80 列共 2000 个字符单元。每个字符单元能够显示一个有特定前景色和背景色的 ASCII 字符。输出到屏幕的字符大概长这样：</p> <p><img src="data:image/png;base64,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" alt="屏幕输出样例"></p> <p>我们将在下篇文章中详细讨论 VGA 字符缓冲区的内存布局，并为其编写第一个驱动程序。为了打印 “Hello World”，目前我们只需要知道这段缓冲区的地址是 <code>0xb8000</code>，且每个字符单元包含一个 ASCII 码字节和一个颜色字节。</p> <p>具体实现如下：</p> <div class="language-rust line-numbers-mode"><pre class="language-rust"><code><span class="token keyword">static</span> <span class="token constant">HELLO</span><span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token punctuation">[</span><span class="token keyword">u8</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">b&quot;Hello World!&quot;</span><span class="token punctuation">;</span>

<span class="token attribute attr-name">#[no_mangle]</span>
<span class="token keyword">pub</span> <span class="token keyword">extern</span> <span class="token string">&quot;C&quot;</span> <span class="token keyword">fn</span> <span class="token function-definition function">_start</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token operator">!</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> vga_buffer <span class="token operator">=</span> <span class="token number">0xb8000</span> <span class="token keyword">as</span> <span class="token operator">*</span><span class="token keyword">mut</span> <span class="token keyword">u8</span><span class="token punctuation">;</span>

    <span class="token keyword">for</span> <span class="token punctuation">(</span>i<span class="token punctuation">,</span> <span class="token operator">&amp;</span>byte<span class="token punctuation">)</span> <span class="token keyword">in</span> <span class="token constant">HELLO</span><span class="token punctuation">.</span><span class="token function">iter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">enumerate</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">unsafe</span> <span class="token punctuation">{</span>
            <span class="token operator">*</span>vga_buffer<span class="token punctuation">.</span><span class="token function">offset</span><span class="token punctuation">(</span>i <span class="token keyword">as</span> <span class="token keyword">isize</span> <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">=</span> byte<span class="token punctuation">;</span>
            <span class="token operator">*</span>vga_buffer<span class="token punctuation">.</span><span class="token function">offset</span><span class="token punctuation">(</span>i <span class="token keyword">as</span> <span class="token keyword">isize</span> <span class="token operator">*</span> <span class="token number">2</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">0xb</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">loop</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><p>首先，将整数 <code>0xb8000</code> 转换为一个 <a href="https://doc.rust-lang.org/stable/book/ch19-01-unsafe-rust.html#dereferencing-a-raw-pointer" target="_blank" rel="noopener noreferrer">裸指针<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>。然后 <a href="https://doc.rust-lang.org/stable/book/ch13-02-iterators.html" target="_blank" rel="noopener noreferrer">遍历<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> <a href="https://doc.rust-lang.org/book/ch10-03-lifetime-syntax.html#the-static-lifetime" target="_blank" rel="noopener noreferrer">静态<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> <a href="https://doc.rust-lang.org/reference/tokens.html#byte-string-literals" target="_blank" rel="noopener noreferrer">字符串<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> <code>HELLO</code> 的字节。我们还使用 <a href="https://doc.rust-lang.org/core/iter/trait.Iterator.html#method.enumerate" target="_blank" rel="noopener noreferrer">enumerate<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 方法获得一个额外的索引变量 <code>i</code>。在 for 循环的主体内，使用 <a href="https://doc.rust-lang.org/std/primitive.pointer.html#method.offset" target="_blank" rel="noopener noreferrer">offset<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 方法将字符串的每个字节和对应的颜色字节（<code>0xb</code> 代表淡青色）写入内存位置。</p> <p>要注意的是，所有的内存写操作都被一个 <a href="https://doc.rust-lang.org/stable/book/ch19-01-unsafe-rust.html" target="_blank" rel="noopener noreferrer">unsafe<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 语句块包围。这是因为编译器不能确保我们创建的裸指针是有效的。裸指针可能指向任意位置，引发数据污染问题。使用 <code>unsafe</code> 语句块包裹这些操作，我们其实是在告诉编译器，自己相当肯定语句块内的操作是有效的。事实上，<code>unsafe</code> 语句块并不会关闭 Rust 的安全检查机制；它只是允许我们多做 <a href="https://doc.rust-lang.org/stable/book/ch19-01-unsafe-rust.html#unsafe-superpowers" target="_blank" rel="noopener noreferrer">五件<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 事情而已。</p> <p>我想要强调的是：<strong>这不是我们使用 Rust 的正确姿势！</strong> 在 unsafe 语句块里面操弄裸指针很容易搞得一地鸡毛，例如，稍不留神我们很容易就会越过缓冲区边界进行写操作。</p> <p>因此，我们希望尽可能少地使用 <code>unsafe</code> 语句块。Rust 语言允许我们将不安全操作将包装为一个安全的抽象模块。举个例子，我们可以创建一个 VGA 缓冲区类型，把所有的不安全语句封装起来，确保从类型外部操作时，<em>不可能</em> 触发错误。通过这种方式，只需要最少 <code>unsafe</code> 语句块确保不破坏内存安全。下一篇文章将会创建这样的 VGA 缓冲区封装。</p> <h2 id="启动内核"><a href="#启动内核" class="header-anchor">#</a> 启动内核</h2> <p>既然我们已经有了一个有视觉效果的可执行程序，是时候把它运行起来试试看了。首先，将编译好的内核与引导程序链接来创建一个可引导的磁盘镜像。然后可以在 <a href="https://www.qemu.org/" target="_blank" rel="noopener noreferrer">QEMU<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 虚拟机中运行这个镜像，或者通过 U 盘在真机上运行。</p> <h3 id="创建引导映像"><a href="#创建引导映像" class="header-anchor">#</a> 创建引导映像</h3> <p>要将可执行程序转换为可引导的镜像，需要把它和引导程序链接。正如我们在 <a href="#%E5%BC%95%E5%AF%BC%E5%90%AF%E5%8A%A8">描述启动的小节</a> 所学，引导程序将负责初始化 CPU 并加载内核。</p> <p>我们在此直接使用 <a href="https://crates.io/crates/bootloader" target="_blank" rel="noopener noreferrer">bootloader<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 包，而不是手码一个可以独立成项目的引导程序。这个包实现基本的 BIOS 引导程序，不依赖 C 语言，只依赖 Rust 代码和内联汇编。为了用它启动我们的内核，需要将它添加为依赖项：</p> <div class="language-toml line-numbers-mode"><pre class="language-toml"><code><span class="token comment"># in Cargo.toml</span>

<span class="token punctuation">[</span><span class="token table class-name">dependencies</span><span class="token punctuation">]</span>
<span class="token key property">bootloader</span> <span class="token punctuation">=</span> <span class="token string">&quot;0.9.3&quot;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>只添加 <code>bootloader</code> 依赖项不足以创建一个可引导的磁盘镜像。问题出在我们需要在内核编译完成之后，将内核和引导程序组合在一起，然而 cargo 并不支持 <a href="https://github.com/rust-lang/cargo/issues/545" target="_blank" rel="noopener noreferrer">后处理脚本<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>。</p> <p>为了解决这个问题，我们创建了一个 bootimage 工具。它会先编译内核，然后将内核和引导程序组合在一起，从而创建一个可引导的磁盘镜像。在终端执行以下命令来安装这款工具：</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token function">cargo</span> <span class="token function">install</span> bootimage
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>为了运行 <code>bootimage</code> 以及编译引导程序，我们需要安装 <code>rustup</code> 组件 <code>llvm-tools-preview</code>。执行 <code>rustup component add llvm-tools-preview</code> 即可安装这个组件。</p> <p>成功安装 <code>bootimage</code> 并添加 <code>llvm-tools-preview</code> 组件后执行以下命令即可创建一个可引导的磁盘镜像：</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token operator">&gt;</span> <span class="token function">cargo</span> bootimage
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>可以看到，bootimage 工具使用 <code>cargo build</code> 编译内核，所以它将增量编译我们修改后的源码。在这之后，它会编译内核的引导程序，这可能花费一定的时间。但和所有其它依赖包相似的是，编译只会发生一次，然后产物被缓存，让后续编译明显加速。最终，<code>bootimage</code> 将内核和引导程序组合为一个可引导的磁盘镜像。</p> <p>运行上述命令之后，我们应该能在 <code>target/x86_64-blog_os/debug</code> 目录内找到可引导的映像文件 <code>bootimage-blog_os.bin</code>。这个镜像可以在虚拟机启动，也可以刻录到 U 盘上以便在真机上启动。（需要注意的是，因为文件格式不同，这里的 bin 文件并不是一个光驱镜像，所以将它刻录到光盘不会起作用）</p> <h4 id="具体是如何实现的"><a href="#具体是如何实现的" class="header-anchor">#</a> 具体是如何实现的？</h4> <p><code>bootimage</code> 工具背地里执行以下三个步骤：</p> <ul><li>编译我们的内核为一个 ELF 文件</li> <li>编译引导程序为独立的可执行文件</li> <li>将内核 ELF 文件链接到引导程序的末端</li></ul> <p>当机器启动时，引导程序将会读取并解析拼接在其后的 ELF 文件。然后将把程序片段映射到页表的虚拟地址，清零 BSS 段，初始化栈空间。最后，它将读取并跳转到程序入口地址（<code>_start</code> 函数）。</p> <h3 id="在-qemu-中启动内核"><a href="#在-qemu-中启动内核" class="header-anchor">#</a> 在 QEMU 中启动内核</h3> <p>现在我们可以在虚拟机中启动内核了。执行以下命令在 <a href="https://www.qemu.org/" target="_blank" rel="noopener noreferrer">QEMU<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 中启动内核：</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token operator">&gt;</span> qemu-system-x86_64 <span class="token parameter variable">-drive</span> <span class="token assign-left variable">format</span><span class="token operator">=</span>raw,file<span class="token operator">=</span>target/x86_64-blog_os/debug/bootimage-blog_os.bin
warning: TCG doesn't support requested feature: CPUID.01H:ECX.vmx <span class="token punctuation">[</span>bit <span class="token number">5</span><span class="token punctuation">]</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>这会打开一个类似下图的独立窗口：</p> <p><img src="data:image/png;base64,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KCCkAQCggJAGAIACQhoAAAoIaQAAKCCkAQCggJAGAIACQhoAAAoIaQAAKCCkAQCggJAGAIACQhoAAAoIaQAAKCCkAQCggJAGAIACQhoAAAoIaQAAKCCkAQCggJAGAIACQhoAAAoIaQAAKCCkAQCggJAGAIACQhoAAAoIaQAAKCCkAQCggJAGAIACQhoAAAoIaQAAKCCkAQCggJAGAIACQhoAAAoIaQAAKCCkAQCggJAGAIACQhoAAAoIaQAAKCCkAQCggJAGAIACQhoAAAoIaQAAKCCkAQCggJAGAIACQhoAAAoIaQAAKCCkAQCggJAGAIACQhoAAAoIaQAAKCCkAQCggJAGAIACQhoAAAoIaQAAKCCkAQCggJAGAIACQhoAAAoIaQAAKCCkAQCggJAGAIACQhoAAAoIaQAAKCCkAQCggJAGAIACQhoAAAoIaQAAKCCkAQCggJAGAIACQhoAAAoIaQAAKCCkAQCggJAGAIACQhoAAAoIaQAAKCCkAQCggJAGAIACQhoAAAoIaQAAKCCkAQCggJAGAIACQhoAAAoIaQAAKCCkAQCggJAGAIACQhoAAAoIaQAAKCCkAQCggJAGAIACQhoAAAoIaQAAKCCkAQCggJAGAIACQhoAAAoIaQAAKCCkAQCggJAGAIACQhoAAAoIaQAAKCCkAQCggJAGAIACQhoAAAoIaQAAKCCkAQCggJAGAIACQhoAAAoIaQAAKCCkAQCggJAGAIACQhoAAAoIaQAAKCCkAQCggJAGAIACQhoAAAoIaQAAKCCkAQCggJAGAIACQhoAAAoIaQAAKCCkAQCggJAGAIACQhoAAAoIaQAAKCCkAQCggJAGAIACQhoAAAoIaQAAKCCkAQCggJAGAIACQhoAAAoIaQAAKCCkAQCggJAGAIACQhoAAAoIaQAAKCCkAQCggJAGAIACQhoAAAoIaQAAKCCkAQCggJAGAIACQhoAAAoIaQAAKCCkAQCggJAGAIACQhoAAAoIaQAAKCCkAQCggJAGAIACQhoAAAoIaQAAKCCkAQCggJAGAIACQhoAAAoIaQAAKCCkAQCggJAGAIACQhoAAAoIaQAAKCCkAQCggJAGAIACQhoAAAoIaQAAKCCkAQCggJAGAIACQhoAAAoIaQAAKCCkAQCggJAGAIACQhoAAAoIaQAAKCCkAQCggJAGAIACQhoAAAoIaQAAKCCkAQCggJAGAIACQhoAAAoIaQAAKCCkAQCggJAGAIACQhoAAAoIaQAAKCCkAQCggJAGAIACQhoAAAoIaQAAKCCkAQCggJAGAIACQhoAAAoIaQAAKCCkAQCggJAGAIACQhoAAAoIaQAAKCCkAQCggJAGAIACQhoAAAoIaQAAKCCkAQCggJAGAIACQhoAAAoIaQAAKCCkAQCggJAGAIACQhoAAAoIaQAAKCCkAQCggJAGAIACQhoAAAoIaQAAKCCkAQCggJAGAIACQhoAAAoIaQAAKCCkAQCggJAGAIACQhoAAAoIaQAAKCCkAQCggJAGAIACQhoAAAoIaQAAKCCkAQCggJAGAIACQhoAAAoIaQAAKCCkAQCggJAGAIACQhoAAAoIaQAAKCCkAQCggJAGAIACQhoAAAoIaQAAKCCkAQCggJAGAIACQhoAAAoIaQAAKCCkAQCggJAGAIACQhoAAAoIaQAAKCCkAQCggJAGAIACQhoAAAoIaQAAKCCkAQCggJAGAIACQhoAAAoIaQAAKCCkAQCggJAGAIACQhoAAAr0k+RNr/9fD/VxAADAWeX/A+c24s12kbisAAAAAElFTkSuQmCC" alt="样例输出"></p> <p>可以看到屏幕窗口已经显示出 “Hello World!” 字符串。</p> <h3 id="在真机上运行内核"><a href="#在真机上运行内核" class="header-anchor">#</a> 在真机上运行内核</h3> <p>我们也可以镜像写入 U 盘，然后放到真机上启动：</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token operator">&gt;</span> <span class="token function">dd</span> <span class="token assign-left variable">if</span><span class="token operator">=</span>target/x86_64-blog_os/debug/bootimage-blog_os.bin <span class="token assign-left variable">of</span><span class="token operator">=</span>/dev/sdX <span class="token operator">&amp;&amp;</span> <span class="token function">sync</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>在这里，<code>sdX</code> 是 U 盘的设备名。因为目标设备上已有的数据将全部被擦除，所以请务必 <strong>仔细</strong> 选择正确的设备。</p> <p>写入到 U 盘之后，我们可以在真机上通过引导启动系统。视情况而定，可能需要使用特殊的启动菜单，或者调整 BIOS 配置中的启动顺序来实现从 U 盘启动。需要注意的是，<code>bootloader</code> 包暂不支持 UEFI，所以我们并不能在 UEFI 机器上启动。</p> <h3 id="使用-cargo-run"><a href="#使用-cargo-run" class="header-anchor">#</a> 使用 <code>cargo run</code></h3> <p>要让在 QEMU 中运行内核更轻松，我们可以设置在 cargo 配置文件中设置 <code>runner</code> 配置项：</p> <div class="language-toml line-numbers-mode"><pre class="language-toml"><code><span class="token comment"># in .cargo/config.toml</span>

<span class="token punctuation">[</span><span class="token table class-name">target.'cfg(target_os = &quot;none&quot;)'</span><span class="token punctuation">]</span>
<span class="token key property">runner</span> <span class="token punctuation">=</span> <span class="token string">&quot;bootimage runner&quot;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p><code>target.'cfg(target_os = &quot;none&quot;)'</code> 囊括了所有目标配置文件 <code>&quot;os&quot;</code> 字段设置为 <code>&quot;none&quot;</code> 的目标。这包含我们的 <code>x86_64-blog_os.json</code> 目标。另外，<code>runner</code> 的值指定运行 <code>cargo run</code> 具体执行的命令。这个命令将在成功编译后执行，而且会传递可执行文件的路径作为第一个参数。更多详情参见 <a href="https://doc.rust-lang.org/cargo/reference/config.html" target="_blank" rel="noopener noreferrer">cargo 的文档<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>。</p> <p><code>bootimage runner</code> 命令特意设计为可用作 <code>runner</code> 二进制的形式。它将给定的可执行文件与项目的引导程序依赖项链接，然后在 QEMU 中启动它。<a href="https://github.com/rust-osdev/bootimage" target="_blank" rel="noopener noreferrer"><code>bootimage</code> 的 README<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 文档提供了更多细节和可以传入的配置参数。</p> <p>现在我们可以使用 <code>cargo run</code> 来编译内核并在 QEMU 中启动了。</p> <h2 id="下篇预告"><a href="#下篇预告" class="header-anchor">#</a> 下篇预告</h2> <p>在下篇文章中，我们将更加细致地探索 VGA 文本缓冲区，并将其包装为一个安全的接口。我们还将基于它实现 <code>println!</code> 宏。</p></div></section> <footer class="page-edit"><!----> <!----></footer> <!----> <div class="comments-wrapper"><!----></div></main></div> <!----></div> <ul class="sub-sidebar sub-sidebar-wrapper" style="width:12rem;" data-v-b57cc07c data-v-7dd95ae2><li class="level-2" data-v-b57cc07c><a href="/blog-os/blog-os-02-a-minimal-rust-kernel/#引导启动" class="sidebar-link reco-side-引导启动" data-v-b57cc07c>引导启动</a></li><li class="level-2" data-v-b57cc07c><a href="/blog-os/blog-os-02-a-minimal-rust-kernel/#bios-启动" class="sidebar-link reco-side-bios-启动" data-v-b57cc07c>BIOS 启动</a></li><li class="level-3" data-v-b57cc07c><a href="/blog-os/blog-os-02-a-minimal-rust-kernel/#multiboot-标准" class="sidebar-link reco-side-multiboot-标准" data-v-b57cc07c>Multiboot 标准</a></li><li class="level-3" data-v-b57cc07c><a href="/blog-os/blog-os-02-a-minimal-rust-kernel/#uefi" class="sidebar-link reco-side-uefi" data-v-b57cc07c>UEFI</a></li><li class="level-2" data-v-b57cc07c><a href="/blog-os/blog-os-02-a-minimal-rust-kernel/#最小化内核" class="sidebar-link reco-side-最小化内核" data-v-b57cc07c>最小化内核</a></li><li class="level-3" data-v-b57cc07c><a href="/blog-os/blog-os-02-a-minimal-rust-kernel/#安装-rust-nightly" class="sidebar-link reco-side-安装-rust-nightly" data-v-b57cc07c>安装 Rust Nightly</a></li><li class="level-3" data-v-b57cc07c><a href="/blog-os/blog-os-02-a-minimal-rust-kernel/#目标配置" class="sidebar-link reco-side-目标配置" data-v-b57cc07c>目标配置</a></li><li class="level-3" data-v-b57cc07c><a href="/blog-os/blog-os-02-a-minimal-rust-kernel/#串到一起" class="sidebar-link reco-side-串到一起" data-v-b57cc07c>串到一起</a></li><li class="level-3" data-v-b57cc07c><a href="/blog-os/blog-os-02-a-minimal-rust-kernel/#构建我们的内核" class="sidebar-link reco-side-构建我们的内核" data-v-b57cc07c>构建我们的内核</a></li><li class="level-3" data-v-b57cc07c><a href="/blog-os/blog-os-02-a-minimal-rust-kernel/#设置默认目标" class="sidebar-link reco-side-设置默认目标" data-v-b57cc07c>设置默认目标</a></li><li class="level-3" data-v-b57cc07c><a href="/blog-os/blog-os-02-a-minimal-rust-kernel/#向屏幕打印字符" class="sidebar-link reco-side-向屏幕打印字符" data-v-b57cc07c>向屏幕打印字符</a></li><li class="level-2" data-v-b57cc07c><a href="/blog-os/blog-os-02-a-minimal-rust-kernel/#启动内核" class="sidebar-link reco-side-启动内核" data-v-b57cc07c>启动内核</a></li><li class="level-3" data-v-b57cc07c><a href="/blog-os/blog-os-02-a-minimal-rust-kernel/#创建引导映像" class="sidebar-link reco-side-创建引导映像" data-v-b57cc07c>创建引导映像</a></li><li class="level-3" data-v-b57cc07c><a href="/blog-os/blog-os-02-a-minimal-rust-kernel/#在-qemu-中启动内核" class="sidebar-link reco-side-在-qemu-中启动内核" data-v-b57cc07c>在 QEMU 中启动内核</a></li><li class="level-3" data-v-b57cc07c><a href="/blog-os/blog-os-02-a-minimal-rust-kernel/#在真机上运行内核" class="sidebar-link reco-side-在真机上运行内核" data-v-b57cc07c>在真机上运行内核</a></li><li class="level-3" data-v-b57cc07c><a href="/blog-os/blog-os-02-a-minimal-rust-kernel/#使用-cargo-run" class="sidebar-link reco-side-使用-cargo-run" data-v-b57cc07c>使用 cargo run</a></li><li class="level-2" data-v-b57cc07c><a href="/blog-os/blog-os-02-a-minimal-rust-kernel/#下篇预告" class="sidebar-link reco-side-下篇预告" data-v-b57cc07c>下篇预告</a></li></ul></div></div></div><div class="global-ui"><div class="back-to-ceiling" style="right:1rem;bottom:6rem;width:2.5rem;height:2.5rem;border-radius:.25rem;line-height:2.5rem;display:none;" data-v-c6073ba8 data-v-c6073ba8><svg t="1574745035067" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="5404" class="icon" data-v-c6073ba8><path d="M526.60727968 10.90185116a27.675 27.675 0 0 0-29.21455937 0c-131.36607665 82.28402758-218.69155461 228.01873535-218.69155402 394.07834331a462.20625001 462.20625001 0 0 0 5.36959153 69.94390903c1.00431239 6.55289093-0.34802892 13.13561351-3.76865779 18.80351572-32.63518765 54.11355614-51.75690182 118.55860487-51.7569018 187.94566865a371.06718723 371.06718723 0 0 0 11.50484808 91.98906777c6.53300375 25.50556257 41.68394495 28.14064038 52.69160883 4.22606766 17.37162448-37.73630017 42.14135425-72.50938081 72.80769204-103.21549295 2.18761121 3.04276886 4.15646224 6.24463696 6.40373557 9.22774369a1871.4375 1871.4375 0 0 0 140.04691725 5.34970492 1866.36093723 1866.36093723 0 0 0 140.04691723-5.34970492c2.24727335-2.98310674 4.21612437-6.18497483 6.3937923-9.2178004 30.66633723 30.70611158 55.4360664 65.4791928 72.80769147 103.21549355 11.00766384 23.91457269 46.15860503 21.27949489 52.69160879-4.22606768a371.15156223 371.15156223 0 0 0 11.514792-91.99901164c0-69.36717486-19.13165746-133.82216804-51.75690182-187.92578088-3.42062944-5.66790279-4.76302748-12.26056868-3.76865837-18.80351632a462.20625001 462.20625001 0 0 0 5.36959269-69.943909c-0.00994388-166.08943902-87.32547796-311.81420293-218.6915546-394.09823051zM605.93803103 357.87693858a93.93749974 93.93749974 0 1 1-187.89594924 6.1e-7 93.93749974 93.93749974 0 0 1 187.89594924-6.1e-7z" p-id="5405" data-v-c6073ba8></path><path d="M429.50777625 765.63860547C429.50777625 803.39355007 466.44236686 1000.39046097 512.00932183 1000.39046097c45.56695499 0 82.4922232-197.00623328 82.5015456-234.7518555 0-37.75494459-36.9345906-68.35043303-82.4922232-68.34111062-45.57627738-0.00932239-82.52019037 30.59548842-82.51086798 68.34111062z" p-id="5406" data-v-c6073ba8></path></svg></div></div></div>
    <script src="/assets/js/app.2124bf24.js" defer></script><script src="/assets/js/3.944fac0d.js" defer></script><script src="/assets/js/1.c30a1333.js" defer></script><script src="/assets/js/36.a3ad36a5.js" defer></script>
  </body>
</html>
