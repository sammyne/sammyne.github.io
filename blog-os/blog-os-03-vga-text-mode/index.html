<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>[blog os] 03. VGA 文本模式 | sammyne</title>
    <meta name="generator" content="VuePress 1.9.9">
    <link rel="icon" href="/favicon.ico">
    <meta name="description" content="Just playing around :)">
    <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no">
    
    <link rel="preload" href="/assets/css/0.styles.00c90c45.css" as="style"><link rel="preload" href="/assets/js/app.595d3845.js" as="script"><link rel="preload" href="/assets/js/3.944fac0d.js" as="script"><link rel="preload" href="/assets/js/1.c30a1333.js" as="script"><link rel="preload" href="/assets/js/32.5d223b08.js" as="script"><link rel="prefetch" href="/assets/js/10.6feb556b.js"><link rel="prefetch" href="/assets/js/11.9852a749.js"><link rel="prefetch" href="/assets/js/12.92a89c73.js"><link rel="prefetch" href="/assets/js/13.05851956.js"><link rel="prefetch" href="/assets/js/14.b5b02a48.js"><link rel="prefetch" href="/assets/js/15.fd1f282f.js"><link rel="prefetch" href="/assets/js/16.338c7efe.js"><link rel="prefetch" href="/assets/js/17.bb2a9190.js"><link rel="prefetch" href="/assets/js/18.1eb0e152.js"><link rel="prefetch" href="/assets/js/19.ccfdbedf.js"><link rel="prefetch" href="/assets/js/20.3d3adc8f.js"><link rel="prefetch" href="/assets/js/21.669510d2.js"><link rel="prefetch" href="/assets/js/22.4997fa99.js"><link rel="prefetch" href="/assets/js/23.88d0f3d2.js"><link rel="prefetch" href="/assets/js/24.688b92a8.js"><link rel="prefetch" href="/assets/js/25.42a3079a.js"><link rel="prefetch" href="/assets/js/26.6b1973cc.js"><link rel="prefetch" href="/assets/js/27.5b5e7e82.js"><link rel="prefetch" href="/assets/js/28.4850156d.js"><link rel="prefetch" href="/assets/js/29.bbeeadad.js"><link rel="prefetch" href="/assets/js/30.824ebab1.js"><link rel="prefetch" href="/assets/js/31.d5cda852.js"><link rel="prefetch" href="/assets/js/33.828464d1.js"><link rel="prefetch" href="/assets/js/34.6e9589f2.js"><link rel="prefetch" href="/assets/js/35.69f5a7fc.js"><link rel="prefetch" href="/assets/js/36.a3ad36a5.js"><link rel="prefetch" href="/assets/js/37.029b3148.js"><link rel="prefetch" href="/assets/js/38.7333eb86.js"><link rel="prefetch" href="/assets/js/39.ff2dfcd8.js"><link rel="prefetch" href="/assets/js/4.b18adb9c.js"><link rel="prefetch" href="/assets/js/40.abf44d43.js"><link rel="prefetch" href="/assets/js/41.f4f7cd86.js"><link rel="prefetch" href="/assets/js/42.efbc331e.js"><link rel="prefetch" href="/assets/js/43.d10817f1.js"><link rel="prefetch" href="/assets/js/44.5f29d6a5.js"><link rel="prefetch" href="/assets/js/45.f7151ddb.js"><link rel="prefetch" href="/assets/js/46.e7682535.js"><link rel="prefetch" href="/assets/js/47.0b77b275.js"><link rel="prefetch" href="/assets/js/48.b17405c2.js"><link rel="prefetch" href="/assets/js/49.56895153.js"><link rel="prefetch" href="/assets/js/5.6b0f5eca.js"><link rel="prefetch" href="/assets/js/50.00cd4ac7.js"><link rel="prefetch" href="/assets/js/51.33442938.js"><link rel="prefetch" href="/assets/js/52.f81f5392.js"><link rel="prefetch" href="/assets/js/53.b04b70d0.js"><link rel="prefetch" href="/assets/js/54.07971080.js"><link rel="prefetch" href="/assets/js/55.674ca41a.js"><link rel="prefetch" href="/assets/js/56.862cae6b.js"><link rel="prefetch" href="/assets/js/57.3d3d7cc9.js"><link rel="prefetch" href="/assets/js/58.98ebbb9c.js"><link rel="prefetch" href="/assets/js/59.4081edac.js"><link rel="prefetch" href="/assets/js/6.81d9e9a0.js"><link rel="prefetch" href="/assets/js/60.42a820f4.js"><link rel="prefetch" href="/assets/js/61.831e64bb.js"><link rel="prefetch" href="/assets/js/62.e88ed253.js"><link rel="prefetch" href="/assets/js/63.68ebf7ba.js"><link rel="prefetch" href="/assets/js/64.f8bca808.js"><link rel="prefetch" href="/assets/js/65.5374b454.js"><link rel="prefetch" href="/assets/js/66.a0c38aa4.js"><link rel="prefetch" href="/assets/js/67.a30f375b.js"><link rel="prefetch" href="/assets/js/68.8248dd23.js"><link rel="prefetch" href="/assets/js/69.27451ee8.js"><link rel="prefetch" href="/assets/js/7.18067abc.js"><link rel="prefetch" href="/assets/js/70.b66ad42b.js"><link rel="prefetch" href="/assets/js/71.3a3073a8.js"><link rel="prefetch" href="/assets/js/72.2b1e35e2.js"><link rel="prefetch" href="/assets/js/73.63094dc9.js"><link rel="prefetch" href="/assets/js/74.757bd7cf.js"><link rel="prefetch" href="/assets/js/75.0dd16c50.js"><link rel="prefetch" href="/assets/js/76.956ca877.js"><link rel="prefetch" href="/assets/js/77.2212d94e.js"><link rel="prefetch" href="/assets/js/78.943cb020.js"><link rel="prefetch" href="/assets/js/79.e641363b.js"><link rel="prefetch" href="/assets/js/8.dfb2c0b5.js"><link rel="prefetch" href="/assets/js/80.41b8d157.js"><link rel="prefetch" href="/assets/js/81.691d60eb.js"><link rel="prefetch" href="/assets/js/82.d135367f.js"><link rel="prefetch" href="/assets/js/83.4ec63e94.js"><link rel="prefetch" href="/assets/js/84.962e799d.js"><link rel="prefetch" href="/assets/js/85.60141dd3.js"><link rel="prefetch" href="/assets/js/86.017c849e.js"><link rel="prefetch" href="/assets/js/87.6fbbb91d.js"><link rel="prefetch" href="/assets/js/88.83496b89.js"><link rel="prefetch" href="/assets/js/89.29e94077.js"><link rel="prefetch" href="/assets/js/9.6e70986e.js"><link rel="prefetch" href="/assets/js/90.ef4ca654.js">
    <link rel="stylesheet" href="/assets/css/0.styles.00c90c45.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container no-sidebar" data-v-7dd95ae2><div data-v-7dd95ae2><div class="password-shadow password-wrapper-out" style="display:none;" data-v-59e6cb88 data-v-7dd95ae2 data-v-7dd95ae2><h3 class="title" data-v-59e6cb88>sammyne</h3> <p class="description" data-v-59e6cb88>Just playing around :)</p> <label id="box" class="inputBox" data-v-59e6cb88><input type="password" value="" data-v-59e6cb88> <span data-v-59e6cb88>Konck! Knock!</span> <button data-v-59e6cb88>OK</button></label> <div class="footer" data-v-59e6cb88><span data-v-59e6cb88><i class="iconfont reco-theme" data-v-59e6cb88></i> <a target="blank" href="https://vuepress-theme-reco.recoluan.com" data-v-59e6cb88>vuePress-theme-reco</a></span> <span data-v-59e6cb88><i class="iconfont reco-copyright" data-v-59e6cb88></i> <a data-v-59e6cb88><span data-v-59e6cb88>sammyne</span>
          
        <span data-v-59e6cb88>2020 - </span>
        2023
      </a></span></div></div> <div class="hide" data-v-7dd95ae2><header class="navbar" data-v-7dd95ae2><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/logo.svg" alt="sammyne" class="logo"> <span class="site-name">sammyne</span></a> <div class="links"><div class="color-picker"><a class="color-button"><i class="iconfont reco-color"></i></a> <div class="color-picker-menu" style="display:none;"><div class="mode-options"><h4 class="title">Choose mode</h4> <ul class="color-mode-options"><li class="dark">dark</li><li class="auto active">auto</li><li class="light">light</li></ul></div></div></div> <div class="search-box"><i class="iconfont reco-search"></i> <input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link"><i class="iconfont reco-home"></i>
  首页
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-category"></i>
      分类
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/categories/os/" class="nav-link"><i class="undefined"></i>
  os
</a></li><li class="dropdown-item"><!----> <a href="/categories/dev/" class="nav-link"><i class="undefined"></i>
  dev
</a></li><li class="dropdown-item"><!----> <a href="/categories/crypto/" class="nav-link"><i class="undefined"></i>
  crypto
</a></li><li class="dropdown-item"><!----> <a href="/categories/programming/" class="nav-link"><i class="undefined"></i>
  programming
</a></li><li class="dropdown-item"><!----> <a href="/categories/tee/" class="nav-link"><i class="undefined"></i>
  tee
</a></li><li class="dropdown-item"><!----> <a href="/categories/engineering/" class="nav-link"><i class="undefined"></i>
  engineering
</a></li><li class="dropdown-item"><!----> <a href="/categories/tool/" class="nav-link"><i class="undefined"></i>
  tool
</a></li><li class="dropdown-item"><!----> <a href="/categories/language/" class="nav-link"><i class="undefined"></i>
  language
</a></li><li class="dropdown-item"><!----> <a href="/categories/decentralization/" class="nav-link"><i class="undefined"></i>
  decentralization
</a></li><li class="dropdown-item"><!----> <a href="/categories/architecture/" class="nav-link"><i class="undefined"></i>
  architecture
</a></li><li class="dropdown-item"><!----> <a href="/categories/network/" class="nav-link"><i class="undefined"></i>
  network
</a></li><li class="dropdown-item"><!----> <a href="/categories/software engineering/" class="nav-link"><i class="undefined"></i>
  software engineering
</a></li><li class="dropdown-item"><!----> <a href="/categories/notes/" class="nav-link"><i class="undefined"></i>
  notes
</a></li></ul></div></div><div class="nav-item"><a href="/tag/" class="nav-link"><i class="iconfont reco-tag"></i>
  标签
</a></div><div class="nav-item"><a href="/timeline/" class="nav-link"><i class="iconfont reco-date"></i>
  时间轴
</a></div><div class="nav-item"><a href="https://github.com/sammyne" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="iconfont reco-github"></i>
  Github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav></div></header> <div class="sidebar-mask" data-v-7dd95ae2></div> <aside class="sidebar" data-v-7dd95ae2><div class="personal-info-wrapper" data-v-1fad0c41 data-v-7dd95ae2><img src="/avatar.png" alt="author-avatar" class="personal-img" data-v-1fad0c41> <h3 class="name" data-v-1fad0c41>
    sammyne
  </h3> <div class="num" data-v-1fad0c41><div data-v-1fad0c41><h3 data-v-1fad0c41>80</h3> <h6 data-v-1fad0c41>Articles</h6></div> <div data-v-1fad0c41><h3 data-v-1fad0c41>43</h3> <h6 data-v-1fad0c41>Tags</h6></div></div> <ul class="social-links" data-v-1fad0c41></ul> <hr data-v-1fad0c41></div> <nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link"><i class="iconfont reco-home"></i>
  首页
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-category"></i>
      分类
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/categories/os/" class="nav-link"><i class="undefined"></i>
  os
</a></li><li class="dropdown-item"><!----> <a href="/categories/dev/" class="nav-link"><i class="undefined"></i>
  dev
</a></li><li class="dropdown-item"><!----> <a href="/categories/crypto/" class="nav-link"><i class="undefined"></i>
  crypto
</a></li><li class="dropdown-item"><!----> <a href="/categories/programming/" class="nav-link"><i class="undefined"></i>
  programming
</a></li><li class="dropdown-item"><!----> <a href="/categories/tee/" class="nav-link"><i class="undefined"></i>
  tee
</a></li><li class="dropdown-item"><!----> <a href="/categories/engineering/" class="nav-link"><i class="undefined"></i>
  engineering
</a></li><li class="dropdown-item"><!----> <a href="/categories/tool/" class="nav-link"><i class="undefined"></i>
  tool
</a></li><li class="dropdown-item"><!----> <a href="/categories/language/" class="nav-link"><i class="undefined"></i>
  language
</a></li><li class="dropdown-item"><!----> <a href="/categories/decentralization/" class="nav-link"><i class="undefined"></i>
  decentralization
</a></li><li class="dropdown-item"><!----> <a href="/categories/architecture/" class="nav-link"><i class="undefined"></i>
  architecture
</a></li><li class="dropdown-item"><!----> <a href="/categories/network/" class="nav-link"><i class="undefined"></i>
  network
</a></li><li class="dropdown-item"><!----> <a href="/categories/software engineering/" class="nav-link"><i class="undefined"></i>
  software engineering
</a></li><li class="dropdown-item"><!----> <a href="/categories/notes/" class="nav-link"><i class="undefined"></i>
  notes
</a></li></ul></div></div><div class="nav-item"><a href="/tag/" class="nav-link"><i class="iconfont reco-tag"></i>
  标签
</a></div><div class="nav-item"><a href="/timeline/" class="nav-link"><i class="iconfont reco-date"></i>
  时间轴
</a></div><div class="nav-item"><a href="https://github.com/sammyne" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="iconfont reco-github"></i>
  Github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav> <!----> </aside> <div class="password-shadow password-wrapper-in" style="display:none;" data-v-59e6cb88 data-v-7dd95ae2><h3 class="title" data-v-59e6cb88>[blog os] 03. VGA 文本模式</h3> <!----> <label id="box" class="inputBox" data-v-59e6cb88><input type="password" value="" data-v-59e6cb88> <span data-v-59e6cb88>Konck! Knock!</span> <button data-v-59e6cb88>OK</button></label> <div class="footer" data-v-59e6cb88><span data-v-59e6cb88><i class="iconfont reco-theme" data-v-59e6cb88></i> <a target="blank" href="https://vuepress-theme-reco.recoluan.com" data-v-59e6cb88>vuePress-theme-reco</a></span> <span data-v-59e6cb88><i class="iconfont reco-copyright" data-v-59e6cb88></i> <a data-v-59e6cb88><span data-v-59e6cb88>sammyne</span>
          
        <span data-v-59e6cb88>2020 - </span>
        2023
      </a></span></div></div> <div data-v-7dd95ae2><div data-v-7dd95ae2><main class="page"><section style="display:;"><div class="page-title"><h1 class="title">[blog os] 03. VGA 文本模式</h1> <div data-v-8a445198><i class="iconfont reco-account" data-v-8a445198><span data-v-8a445198>sammyne</span></i> <i class="iconfont reco-date" data-v-8a445198><span data-v-8a445198>7/23/2020</span></i> <i class="iconfont reco-eye" data-v-8a445198><span id="/blog-os/blog-os-03-vga-text-mode/" data-flag-title="Your Article Title" class="leancloud-visitors" data-v-8a445198><a class="leancloud-visitors-count" style="font-size:.9rem;font-weight:normal;color:#999;"></a></span></i> <i class="tags iconfont reco-tag" data-v-8a445198><span class="tag-item" data-v-8a445198>blog_os</span><span class="tag-item" data-v-8a445198>rust</span></i></div></div> <div class="theme-reco-content content__default"><blockquote><p>原文链接：<a href="https://os.phil-opp.com/vga-text-mode/" target="_blank" rel="noopener noreferrer">VGA Text Mode<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p></blockquote> <p><a href="https://en.wikipedia.org/wiki/VGA-compatible_text_mode" target="_blank" rel="noopener noreferrer">VGA 文本模式<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 是打印字符到屏幕的一种简单方式。本文将会把它包装到一个独立的模块，为其创建被安全和便利地使用的接口。我们还会支持 Rust 语言的 <a href="https://doc.rust-lang.org/std/fmt/#related-macros" target="_blank" rel="noopener noreferrer">格式化宏<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>。</p> <p>此博客在 <a href="https://github.com/phil-opp/blog_os" target="_blank" rel="noopener noreferrer">GitHub<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 上公开开发。如果您有任何问题或疑问，请在此处打开一个问题。 您也可以在 <a href="#valine">底部</a> 发表评论。这篇文章的完整源代码可以在 <a href="https://github.com/sammyne/blog-os-cn/tree/master/03-vga-text-mode" target="_blank" rel="noopener noreferrer">blog-os-cn/03-vga-text-mode<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 找到。</p> <h2 id="vga-文本缓冲区"><a href="#vga-文本缓冲区" class="header-anchor">#</a> VGA 文本缓冲区</h2> <p>为了以 VGA 文本模式向屏幕打印字符，我们必须将字符写入 VGA 硬件的文本缓冲区。通常状况下，VGA 文本缓冲区是一个 25 行、80 列的二维数组，它的内容将被实时渲染到屏幕。每个数组元素以下面的格式描述一个屏幕字符：</p> <table><thead><tr><th style="text-align:right;">比特</th> <th style="text-align:left;">值</th></tr></thead> <tbody><tr><td style="text-align:right;">0-7</td> <td style="text-align:left;">ASCII code point</td></tr> <tr><td style="text-align:right;">8-11</td> <td style="text-align:left;">前景色</td></tr> <tr><td style="text-align:right;">12-14</td> <td style="text-align:left;">背景色</td></tr> <tr><td style="text-align:right;">15</td> <td style="text-align:left;">是否闪动</td></tr></tbody></table> <p>第一个字节代表应该以 <a href="https://en.wikipedia.org/wiki/ASCII" target="_blank" rel="noopener noreferrer">ASCII 编码<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 格式打印的字符。更准确来说，它并不是真正意义上的 ASCII 字符集，而是添加额外字符和稍作调整的、名为 <em><a href="https://en.wikipedia.org/wiki/Code_page_437" target="_blank" rel="noopener noreferrer">code page 437<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></em> 的字符集。</p> <p>第二个字节定义字符的打印方式。前 4 比特定义前景色，后 3 比特定义背景色，最后 1 比特确定字符是否应该闪动。可用的颜色如下：</p> <table><thead><tr><th>值</th> <th>颜色</th> <th>值 + 亮度位</th> <th>亮色</th></tr></thead> <tbody><tr><td>0x0</td> <td>黑</td> <td>0x8</td> <td>暗灰</td></tr> <tr><td>0x1</td> <td>蓝</td> <td>0x9</td> <td>浅蓝</td></tr> <tr><td>0x2</td> <td>绿</td> <td>0xa</td> <td>浅绿</td></tr> <tr><td>0x3</td> <td>青</td> <td>0xb</td> <td>浅浅色</td></tr> <tr><td>0x4</td> <td>红</td> <td>0xc</td> <td>浅红</td></tr> <tr><td>0x5</td> <td>紫红</td> <td>0xd</td> <td>粉红</td></tr> <tr><td>0x6</td> <td>棕色</td> <td>0xe</td> <td>黄色</td></tr> <tr><td>0x7</td> <td>浅灰</td> <td>0xf</td> <td>白色</td></tr></tbody></table> <p>每个颜色的第四位称为 <em>亮度位</em>（bright bit），能够将蓝色转成浅蓝色等。对于背景色，对应比特则用于确定是否闪动。</p> <p>通过 <a href="https://en.wikipedia.org/wiki/Memory-mapped_I/O" target="_blank" rel="noopener noreferrer">内存映射 I/O<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 到地址 <code>0xb8000</code> 可以访问 VGA 文本缓冲区。这意味着对这个地址的读写不经过 RAM，而是直接落在 VGA 硬件的文本缓冲区。这也就意味着我们可以通过常规内存操作这个地址即可写入这个硬件。</p> <p>需要注意的是，一些内存映射的硬件可能不完全支持所有的内存操作。例如，一个设备只支持逐字节读取，但在读取 <code>u64</code> 时返回无效的数据。好在字符缓冲区 <a href="https://web.stanford.edu/class/cs140/projects/pintos/specs/freevga/vga/vgamem.htm#manip" target="_blank" rel="noopener noreferrer">支持标准的读写操作<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>，所以我们不需要特殊看待它。</p> <h2 id="包装到-rust-模块"><a href="#包装到-rust-模块" class="header-anchor">#</a> 包装到 Rust 模块</h2> <p>了解 VGA 缓冲的工作原理后，我们可以创建一个 Rust 模块来处理打印问题了：</p> <div class="language-rust line-numbers-mode"><pre class="language-rust"><code><span class="token comment">// in src/main.rs</span>
<span class="token keyword">mod</span> <span class="token module-declaration namespace">vga_buffer</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>这行代码定义一个 Rust 模块，它的内容应当保存在 <code>src/vga_buffer.rs</code> 文件。除非特别说明，后续所有代码都将落在这个新模块。</p> <h3 id="颜色"><a href="#颜色" class="header-anchor">#</a> 颜色</h3> <p>首先，我们使用枚举类型来表示一种颜色：</p> <div class="language-rust line-numbers-mode"><pre class="language-rust"><code><span class="token comment">// in src/vga_buffer.rs</span>

<span class="token attribute attr-name">#[allow(dead_code)]</span>
<span class="token attribute attr-name">#[derive(Debug, Clone, Copy, PartialEq, Eq)]</span>
<span class="token attribute attr-name">#[repr(u8)]</span>
<span class="token keyword">pub</span> <span class="token keyword">enum</span> <span class="token type-definition class-name">Color</span> <span class="token punctuation">{</span>
    <span class="token class-name">Black</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span>
    <span class="token class-name">Blue</span> <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">,</span>
    <span class="token class-name">Green</span> <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">,</span>
    <span class="token class-name">Cyan</span> <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">,</span>
    <span class="token class-name">Red</span> <span class="token operator">=</span> <span class="token number">4</span><span class="token punctuation">,</span>
    <span class="token class-name">Magenta</span> <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">,</span>
    <span class="token class-name">Brown</span> <span class="token operator">=</span> <span class="token number">6</span><span class="token punctuation">,</span>
    <span class="token class-name">LightGray</span> <span class="token operator">=</span> <span class="token number">7</span><span class="token punctuation">,</span>
    <span class="token class-name">DarkGray</span> <span class="token operator">=</span> <span class="token number">8</span><span class="token punctuation">,</span>
    <span class="token class-name">LightBlue</span> <span class="token operator">=</span> <span class="token number">9</span><span class="token punctuation">,</span>
    <span class="token class-name">LightGreen</span> <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">,</span>
    <span class="token class-name">LightCyan</span> <span class="token operator">=</span> <span class="token number">11</span><span class="token punctuation">,</span>
    <span class="token class-name">LightRed</span> <span class="token operator">=</span> <span class="token number">12</span><span class="token punctuation">,</span>
    <span class="token class-name">Pink</span> <span class="token operator">=</span> <span class="token number">13</span><span class="token punctuation">,</span>
    <span class="token class-name">Yellow</span> <span class="token operator">=</span> <span class="token number">14</span><span class="token punctuation">,</span>
    <span class="token class-name">White</span> <span class="token operator">=</span> <span class="token number">15</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br></div></div><p>我们使用类似于 <a href="https://doc.rust-lang.org/rust-by-example/custom_types/enum/c_like.html" target="_blank" rel="noopener noreferrer">C 语言风格的枚举类型<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>，为每个颜色明确指定一个值。由于有 <code>repr(u8)</code> 属性修饰，每个枚举值都会以一个 <code>u8</code> 的形式存储。事实上 4 个二进制位就足够了，但 Rust 语言并不提供 <code>u4</code> 类型。</p> <p>通常来说，编译器会对每个未使用的变量发出警告。使用 <code>#[allow(dead_code)]</code> 可以为 <code>Color</code> 枚举类型禁用这个警告。</p> <p>通过为 <code>Color</code> <a href="https://doc.rust-lang.org/rust-by-example/trait/derive.html" target="_blank" rel="noopener noreferrer">实现<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 了 <a href="https://doc.rust-lang.org/nightly/core/marker/trait.Copy.html" target="_blank" rel="noopener noreferrer">Copy<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>、<a href="https://doc.rust-lang.org/nightly/core/clone/trait.Clone.html" target="_blank" rel="noopener noreferrer">Clone<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>、<a href="https://doc.rust-lang.org/nightly/core/fmt/trait.Debug.html" target="_blank" rel="noopener noreferrer">Debug<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>、<a href="https://doc.rust-lang.org/nightly/core/cmp/trait.PartialEq.html" target="_blank" rel="noopener noreferrer">PartialEq<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 和 <a href="https://doc.rust-lang.org/nightly/core/cmp/trait.Eq.html" target="_blank" rel="noopener noreferrer">Eq<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 这几个 trait 让我们的类型遵循 [复制语义][copy semantics]，也让它可以被打印和比较。</p> <p>为了描述包含前景色和背景色的完整颜色代码，我们基于 <code>u8</code> 创建一个 <a href="https://doc.rust-lang.org/rust-by-example/generics/new_types.html" target="_blank" rel="noopener noreferrer">新类型<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>：</p> <div class="language-rust line-numbers-mode"><pre class="language-rust"><code><span class="token comment">// in src/vga_buffer.rs</span>

<span class="token attribute attr-name">#[derive(Debug, Clone, Copy, PartialEq, Eq)]</span>
<span class="token attribute attr-name">#[repr(transparent)]</span>
<span class="token keyword">struct</span> <span class="token type-definition class-name">ColorCode</span><span class="token punctuation">(</span><span class="token keyword">u8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">impl</span> <span class="token class-name">ColorCode</span> <span class="token punctuation">{</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">new</span><span class="token punctuation">(</span>foreground<span class="token punctuation">:</span> <span class="token class-name">Color</span><span class="token punctuation">,</span> background<span class="token punctuation">:</span> <span class="token class-name">Color</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">ColorCode</span> <span class="token punctuation">{</span>
        <span class="token class-name">ColorCode</span><span class="token punctuation">(</span><span class="token punctuation">(</span>background <span class="token keyword">as</span> <span class="token keyword">u8</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token number">4</span> <span class="token operator">|</span> <span class="token punctuation">(</span>foreground <span class="token keyword">as</span> <span class="token keyword">u8</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>这里，<code>ColorCode</code> 类型包装了一个完整的颜色字节，它包含前景色和背景色信息。和 <code>Color</code> 类型类似，我们为它实现 <code>Copy</code> 和 <code>Debug</code> 等一系列 trait。为了确保 <code>ColorCode</code> 和 <code>u8</code> 有完全相同的内存布局，我们添加 <code>repr(transparent)</code> 标记。</p> <h3 id="文本缓冲区"><a href="#文本缓冲区" class="header-anchor">#</a> 文本缓冲区</h3> <p>我们现在可以添加一个结构体，用于描述屏幕上的字符和整个文本缓冲区：</p> <div class="language-rust line-numbers-mode"><pre class="language-rust"><code><span class="token comment">// in src/vga_buffer.rs</span>

<span class="token attribute attr-name">#[derive(Debug, Clone, Copy, PartialEq, Eq)]</span>
<span class="token attribute attr-name">#[repr(C)]</span>
<span class="token keyword">struct</span> <span class="token type-definition class-name">ScreenChar</span> <span class="token punctuation">{</span>
    ascii_character<span class="token punctuation">:</span> <span class="token keyword">u8</span><span class="token punctuation">,</span>
    color_code<span class="token punctuation">:</span> <span class="token class-name">ColorCode</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token keyword">const</span> <span class="token constant">BUFFER_HEIGHT</span><span class="token punctuation">:</span> <span class="token keyword">usize</span> <span class="token operator">=</span> <span class="token number">25</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token constant">BUFFER_WIDTH</span><span class="token punctuation">:</span> <span class="token keyword">usize</span> <span class="token operator">=</span> <span class="token number">80</span><span class="token punctuation">;</span>

<span class="token attribute attr-name">#[repr(transparent)]</span>
<span class="token keyword">struct</span> <span class="token type-definition class-name">Buffer</span> <span class="token punctuation">{</span>
    chars<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token class-name">ScreenChar</span><span class="token punctuation">;</span> <span class="token constant">BUFFER_WIDTH</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token constant">BUFFER_HEIGHT</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><p>在内存布局层面，Rust 并不保证按顺序摆放结构体字段。因此，我们需要使用 <code>#[repr(C)]</code> 标记结构体。这将完全按 C 语言约定的顺序摆放结构体字段，从而确保正确的字段顺序。对 <code>Buffer</code> 结构体，我们再次使用 <code>repr(transparent)</code>，来确保类型和它唯一的字段有相同的内存布局。</p> <p>为了输出字符到屏幕，我们来创建一个 <code>Writer</code> 类型：</p> <div class="language-rust line-numbers-mode"><pre class="language-rust"><code><span class="token comment">// in src/vga_buffer.rs</span>

<span class="token keyword">pub</span> <span class="token keyword">struct</span> <span class="token type-definition class-name">Writer</span> <span class="token punctuation">{</span>
    column_position<span class="token punctuation">:</span> <span class="token keyword">usize</span><span class="token punctuation">,</span>
    color_code<span class="token punctuation">:</span> <span class="token class-name">ColorCode</span><span class="token punctuation">,</span>
    buffer<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token lifetime-annotation symbol">'static</span> <span class="token keyword">mut</span> <span class="token class-name">Buffer</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p><code>Writer</code> 总会写入最后一行，每次行写满后将行上移（或者遇到 <code>\n</code>）。<code>column_position</code> 变量将跟踪光标在最后一行的位置。当前前景色和背景色由 <code>color_code</code> 变量指定，<code>buffer</code> 存储着 VGA 文本缓冲区的可变引用。需要注意的是，这里需要显式生命周期修饰符告知编译器引用的合法时长。<code>'static</code> 生命周期规定这个引用在程序的整个生命周期内合法（这对 VGA 文本缓冲区来说确实如此）。</p> <h3 id="打印"><a href="#打印" class="header-anchor">#</a> 打印</h3> <p>我们现在可以使用 <code>Writer</code> 类型来更改缓冲区内的字符了。首先，为了写入一个 ASCII 码字节，我们创建这样的函数：</p> <div class="language-rust line-numbers-mode"><pre class="language-rust"><code><span class="token comment">// in src/vga_buffer.rs</span>

<span class="token keyword">impl</span> <span class="token class-name">Writer</span> <span class="token punctuation">{</span>
    <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">write_byte</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">,</span> byte<span class="token punctuation">:</span> <span class="token keyword">u8</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">match</span> byte <span class="token punctuation">{</span>
            <span class="token char">b'\n'</span> <span class="token operator">=&gt;</span> <span class="token keyword">self</span><span class="token punctuation">.</span><span class="token function">new_line</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            byte <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token keyword">self</span><span class="token punctuation">.</span>column_position <span class="token operator">&gt;=</span> <span class="token constant">BUFFER_WIDTH</span> <span class="token punctuation">{</span>
                    <span class="token keyword">self</span><span class="token punctuation">.</span><span class="token function">new_line</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>

                <span class="token keyword">let</span> row <span class="token operator">=</span> <span class="token constant">BUFFER_HEIGHT</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span>
                <span class="token keyword">let</span> col <span class="token operator">=</span> <span class="token keyword">self</span><span class="token punctuation">.</span>column_position<span class="token punctuation">;</span>

                <span class="token keyword">let</span> color_code <span class="token operator">=</span> <span class="token keyword">self</span><span class="token punctuation">.</span>color_code<span class="token punctuation">;</span>
                <span class="token keyword">self</span><span class="token punctuation">.</span>buffer<span class="token punctuation">.</span>chars<span class="token punctuation">[</span>row<span class="token punctuation">]</span><span class="token punctuation">[</span>col<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token class-name">ScreenChar</span> <span class="token punctuation">{</span>
                    ascii_character<span class="token punctuation">:</span> byte<span class="token punctuation">,</span>
                    color_code<span class="token punctuation">,</span>
                <span class="token punctuation">}</span><span class="token punctuation">;</span>
                <span class="token keyword">self</span><span class="token punctuation">.</span>column_position <span class="token operator">+=</span> <span class="token number">1</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">fn</span> <span class="token function-definition function">new_line</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">/* TODO */</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br></div></div><p>如果当前字节是一个 <a href="https://en.wikipedia.org/wiki/Newline" target="_blank" rel="noopener noreferrer">换行符<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 字节 <code>\n</code>，我们的 <code>Writer</code> 不打印任何东西，而是调用稍后实现的 <code>new_line</code> 方法。其它的字节在 <code>match</code> 语句的第二个分支被打印到屏幕上。</p> <p>当打印字节时，<code>Writer</code> 将检查当前行是否已满。如果已满，它将首先调用 <code>new_line</code> 方法来将这一行字上移一行。然后将一个新的 <code>ScreenChar</code> 写入到缓冲区的当前位置。最终将当前的光标位置前进一位。</p> <p>要打印整个字符串，我们把它转换为字节并逐字节打印：</p> <div class="language-rust line-numbers-mode"><pre class="language-rust"><code><span class="token comment">// in src/vga_buffer.rs</span>

<span class="token keyword">impl</span> <span class="token class-name">Writer</span> <span class="token punctuation">{</span>
    <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">write_string</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">,</span> s<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token keyword">str</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">for</span> byte <span class="token keyword">in</span> s<span class="token punctuation">.</span><span class="token function">bytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">match</span> byte <span class="token punctuation">{</span>
                <span class="token comment">// 可以是能打印的 ASCII 码字节，也可以是换行符</span>
                <span class="token number">0x20</span><span class="token punctuation">...</span><span class="token number">0x7e</span> <span class="token operator">|</span> <span class="token char">b'\n'</span> <span class="token operator">=&gt;</span> <span class="token keyword">self</span><span class="token punctuation">.</span><span class="token function">write_byte</span><span class="token punctuation">(</span>byte<span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token comment">// 不包含在上述范围之内的字节</span>
                _ <span class="token operator">=&gt;</span> <span class="token keyword">self</span><span class="token punctuation">.</span><span class="token function">write_byte</span><span class="token punctuation">(</span><span class="token number">0xfe</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token punctuation">}</span>

        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><p>VGA 文本缓冲区只支持 ASCII 字符和 <a href="https://en.wikipedia.org/wiki/Code_page_437" target="_blank" rel="noopener noreferrer">code page 437<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 指定的额外字符。Rust 语言的字符串默认编码为 <a href="https://www.fileformat.info/info/unicode/utf8.htm" target="_blank" rel="noopener noreferrer">UTF-8<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>，所以可能包含一些 VGA 文本缓冲区不支持的字节。我们使用 match 语句来区别可打印的 ASCII 码（或换行字节和其它在空格和 <code>~</code> 之间的任何字符）。对每个不可打印的字节，我们打印一个 <code>■</code> 符号；这个符号在 VGA 硬件中被编码为十六进制的 <code>0xfe</code>。</p> <h4 id="测试一下"><a href="#测试一下" class="header-anchor">#</a> 测试一下</h4> <p>为了往屏幕打印一些字符，我们可以创建这么个函数：</p> <div class="language-rust line-numbers-mode"><pre class="language-rust"><code><span class="token comment">// in src/vga_buffer.rs</span>

<span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">print_something</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> writer <span class="token operator">=</span> <span class="token class-name">Writer</span> <span class="token punctuation">{</span>
        column_position<span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
        color_code<span class="token punctuation">:</span> <span class="token class-name">ColorCode</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token class-name">Color</span><span class="token punctuation">::</span><span class="token class-name">Yellow</span><span class="token punctuation">,</span> <span class="token class-name">Color</span><span class="token punctuation">::</span><span class="token class-name">Black</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        buffer<span class="token punctuation">:</span> <span class="token keyword">unsafe</span> <span class="token punctuation">{</span> <span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token number">0xb8000</span> <span class="token keyword">as</span> <span class="token operator">*</span><span class="token keyword">mut</span> <span class="token class-name">Buffer</span><span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>

    writer<span class="token punctuation">.</span><span class="token function">write_byte</span><span class="token punctuation">(</span><span class="token char">b'H'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    writer<span class="token punctuation">.</span><span class="token function">write_string</span><span class="token punctuation">(</span><span class="token string">&quot;ello &quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    writer<span class="token punctuation">.</span><span class="token function">write_string</span><span class="token punctuation">(</span><span class="token string">&quot;Wörld!&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><p>这个函数首先创建一个指向位于地址 <code>0xb8000</code> 的 VGA 缓冲区的 <code>Writer</code>。代码看起来有点奇怪：首先，我们把整数 <code>0xb8000</code> 强制转换为一个可变的 <a href="https://doc.rust-lang.org/book/ch19-01-unsafe-rust.html#dereferencing-a-raw-pointer" target="_blank" rel="noopener noreferrer">裸指针<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>。然后通过运算符 <code>*</code> 将这个裸指针解引用，再立即利用 <code>&amp;mut</code> 获得它的可变引用。因为编译器无法保证这个裸指针的合法性，这些转换需要 <a href="https://doc.rust-lang.org/book/ch19-01-unsafe-rust.html" target="_blank" rel="noopener noreferrer">unsafe 语句块<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>，。</p> <p>然后将字节 <code>b'H'</code> 写入缓冲区。前缀 <code>b</code> 创建了一个 <a href="https://doc.rust-lang.org/reference/tokens.html#byte-literals" target="_blank" rel="noopener noreferrer">字节常量<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>，表示单个 ASCII 码字符。通过写入 <code>&quot;ello &quot;</code> 和 <code>&quot;Wörld!&quot;</code>，我们可以测试 <code>write_string</code> 方法及其对无法打印字符的处理逻辑。为了观察输出，我们需要在 <code>_start</code> 函数中调用 <code>print_something</code> 方法：</p> <div class="language-rust line-numbers-mode"><pre class="language-rust"><code><span class="token comment">// in src/main.rs</span>
<span class="token attribute attr-name">#[no_mangle]</span>
<span class="token keyword">pub</span> <span class="token keyword">extern</span> <span class="token string">&quot;C&quot;</span> <span class="token keyword">fn</span> <span class="token function-definition function">_start</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token operator">!</span> <span class="token punctuation">{</span>
    <span class="token namespace">vga_buffer<span class="token punctuation">::</span></span><span class="token function">print_something</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">loop</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>编译运行后，黄色的 <code>Hello W■■rld!</code> 应该会被打印在屏幕的左下角：</p> <p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAtIAAAGtCAYAAAA79pMjAAAABHNCSVQICAgIfAhkiAAAABh0RVh0U29mdHdhcmUAbWF0ZS1zY3JlZW5zaG90yJbwSgAAHYlJREFUeJzt3X2QXWdh3/HfOffevbsryZYtG9myIQ52QsBgCAYMtoNpiJ1AQikhAyWQkjZNZ9KQpmmTMtO8p03bNBkmTPqSTlKaFxKG8GI6mBZIeDcEmhAICW8O5tX4Rehl9bKv955z+sfdXa1kSd59BAjZn8/MtVb3nvPcc3elma+On/OcKidx4w3XdSd7HgAAHopuf/+HqhOfO+6JtYDec+klJ7xyfw/wclKdfosH3P+4je6/9db2v/8Lm9r/NGNUD7TBpvcv23hzx1+d4f4bdzh+j63vf+JvtzzCcWMUHc0p99/CWNVWP/v9PnjJJz9urAf4q7W5UY795wz2v9+zm9//AXfZxE+o8C9xdeqXNjXWme1/kqM5w59nkqRb/0+O/2qrY2z8couj3G//U7y4iTEeeOvTbNFt9ci7+/22/EzS6nfuDE9FHdu/bKAT/jhseayT77+58boH3uS0e5Xtv3GX+/88t7b/iU+c0Z+mE54s/JN9yt228Ddtkz/P8v03Mcomxjjtn6ri/TducPotHmj/u+++N8nxQb3+xY03XNddcMHOBzoEAAB4yDp4cG49pqtkEtE7d55/do8KAADOAXNzh3L7+z9U1Wf7QAAA4FxU3XjDdd355593to8DAIBzWNd1qaoqbdum7dq0TZcu7erU5C5Jlapau96nSted/Lqftee7rlsf99jGmx/ndKqqSp0qVT0Zqyq4AOnQocPprx8gAAAU6LouXdeladu0TZPRaJy2aVajuktdVanrOnWvl8Ggl1T1ZH5xl+Mituu6yWXdXZeuazMaNZsYZ7L9KWO46zIajzNumjRNtx78vV6Vfq+XwWCQqlenruotB3W//FsGAMBD3XpEj9uMRitZXlnJFVdckcsu25Nduy7KBRfszMGDc9m/f1++/OW78/nPfz7Dqan0B/3JGeWsnVmenFruui7j8TjLyyvZs2dPrrrqyuy84ILs2L49R48ezdzcodx555256667TjrORuPxOMtLy3nuVXvylMsuzBU7d2T39pncd3Qxn587kv/35QN502fuzvT0MIPBIHW9tZiubrzhum7Hju1n9A1smiZLS8tZWFhMVVWZmZnOcDhMv987o3GP03VZWVrM/OIoo2ZyBr03GGR6Ziazw3rDClJtFg4eztHxScaopnLBrtkMqqRbOZp9h8bpetO58ILp9E/4no3nD+fAQpt6Zkd2be+l6prMHziS+baXHbt2ZGbD7PLx0cM5sNhmcN752TksWtgNAOCcsx7RTZPllVEGg0GecdNNufDCnWmaNk3Tpm3Hqet+er06vV6dAwfm8u73vCej0ShTg8FquE6mbXRdl9FolF6vzg033Jjdux+Wtj35OPv27c/73nd7VjaMszGCR6NRLp6q82tPvzp7tg/TtU3StunaNlVdJ3Wdqu7l7qPLefl7P56vLDcZDoepe5u7hPDIkaOTkN6+fVvxN3BpaTn7DxxM13Xp93pJNQnrXt3LBRfszHA4VTz2urbJ0flBvuXm5+X5z3xiHn3pttRZyt47PpZ33/bG3PbXRzKzY5A6bRYPDfMd//7X8yPfdJJxFj6YX/zxV+WufpfRVT+RV738mvTvujU/9bNvy9Htx2J6PL+Y85/zK/mN79+dQ+/41bzsD+9O1e3Kc3/jV/L8i7+Y33nZv8v7222ZqZPx0aVc+A//U37te3bmjv/6k/nljyY7xDQA8BAxXp3KMegPcsstN6fXrzJaGaVLl649Nn24qqtUqTKYGqQZd3nb296ecTNKvz9IXVerET1OXVW55ZabMzUcrI+T7thU5I3jjEdt3vrWt6XtmvVxkmQ8GmfPVJ1XPuMxmelGaVeWTnn89dR0FqtBfvydf5u9TTbE/ekdPTp/ZlM7lpaWsnfvvmzfvi0zMzMZTE2ieXl5OcvLy/nKvv25aNeFmZ4elr9J12R+8fx817/5+bz06mHSHsrnP/nxHJ3ek8d861Pygn/1pDzp1v+YX/7fd2dm+8Yz4ON86cN/kc/OH/sBtkfvyNH+IFWznG0P2zn58Jd/b17yxHfnFX/TZcd0lapdycL0k/Ky5+xOkux42HnpNXel2eT6JmabAwAPFV3XpWu6jFZWctPTb0zXjbO4MF4/U732WDtbXFVVxuNRBoOpXH/9U/KOd7w7/Xoy17lt26wsL+fvfeczUtfJ4sLiA4wzzmAwyI03PnV9nKruTaaGjFbyC0+9Kv35A1leXjz9h5g/nMH0bH7p2y/Lj77/s+n3eun1Njerovhiw9FolEOHjkwieno6P/iDL8q1j78mSfKRv/5YXv3Hf5yu7TI3dyi7dl1YOM2jS7Mwyq5n/VheevUw7Rduy6/86q35xHydXtoMr/y+/NtfeF6+9Xk/lhd+5Gfzx/dWOfYu+/OB1/yvvPG+pL8awVXdz8zMIBmNc97uHavbTeXaFzwzu//qLTk8NZ1usc3l3/+8PH4webU+/6JsT5dDJxzXZBL8ye+C5NpNAOChoGm6jJpRLrtsT6anp7OwsJi1KRpt264G8GRVjWr1QsGqqjIajTMzM5s9l+3JV+7bm6neVJpRk0suuSTbt21bHSd517vek/H4ZPN1k5tvfmZGo9H6OHv37k2v38t4PM6zLtmWh3ULGc3NJUn2Lqxk3+Ioj9l1bBbGHQcXsn3Qy57twzSLR3LJ9p151qXb82f7V1LXmzuDuhrSW//GLS2tpO26TE/P5KX/6IfymG/7lszPH02SPO7qR+eHXvKS/P4fvjoro1EWF5dSNH2ka7LQfVNe9KzLkuzNrf/tzfm7bnsuWL13TPPF/5Pfeu1T8lsvvizPfO635XWv/FSa4wdIMxqvP9ffNkyVpGl7md01k+RgPvTno1z3tJvzgsf+aV75qVHqqWvyglsuSvuFD+RvL7o+12zflW11m4MnHlp37HG/wxbSAMBDwNpFhpfuuTSLi4tpmmb1+Xb9LPKaY2eTJ5Hatm327Lk099x9TwbdZIrInj2XZGlpMs7arjff/J33G+dd73pvRqPR6jJ5bS6/bE/uufueZFhlNG5y08UzGc8fTjseJUnuW2ryig9/Kf/6CZfmMRfO5o65xfz6R+7Oy574iFwyPdlmPH84z7h4Jv/3vsUMBpv7/KtTO7Zefk3bZGrQz2DQzxOuuTqHDx1en5y9vLSUb3/cY/Oa/iBTg0GaZlz0HmmbdDuvzLfsSHLo4/nwfV2mZ46NU0/VOfCxj2Tviy/Lw77pW3NR9fHcu/7y7rzwN34nL9ww3J2//VP5+b8YZdj1c97O6SR784nb3pL6238sT/2B6/Pqn39n+rf8g1w7PJJ3vuZdOfDD1+eaC3Zltm6T9sSDO9XnUdEAwENDVSVd22T7tm1ZWVlOcv+ZDmtTMo4936SqqjTNONtmZycX/2UyzrZt27KysnLcGIuLi8eNs2bSl5Nr82bXx6nSNk0ePl2lnV9I104C7rEP25mfec5N+fU3vzvPv2Jnbv38ofzks78jj6sOpz0yOV3atk0u3zaTtmmy2Z4rntrRq+vUGxfD3viG1drbd+n3eyd88zava7tUw9kMk2TxUBbb1XUF19+nSrt4OItJMjWbqbpLtx68o3z+Q3+evzvSrv/+nnvbDOo2TbblgpkkWcrBvR/N6/90X578nGfl7z9ubwbP3pN88U/ypk/N5fHLSYY7sqOXDeOuHdzaFI7uFM8DADy4dUnarkuqrE/BqKoqH/jAh065z/XXX7d+tno43Uu72nbtaiiPRqP1cZLjO3Xj15Oz1pPfD4dr40zGne1G62GfJO3cV/KoHaP8wFMel9+7/aN5yfXX5Or2QMaHDxw7sKrKdDu635n00yme2jEYDNI0TcbjJh/7+CfzqKsemeXl5dUPM52P/s3fZjRuUte99Pv9srisqrQLc1lIkh0XZ3vVZq5L1mettG16Oy7O9iSZn8tCu/EKywP50Otefdwc6d7UVIa9Kov1dHbOJFmZz8JonC++/S359Pe+NLf8y3+eDFfy4f/5/nxllMwvJ8l0zp+p0i03WRklyTA7puu0y0lXdWnbOjM7JhdTjleatKv/itDSAMCDXbV6l8HFhaV03WRaR1XVecYznr4+L3rN2nzpxcXFtN3kLPTiwtJkm9Vtl5aWU1WTuxeurcBx4pnoNW3bpm27JF2Wl5dXx5kcz5HF5QybNt2GM6Gf+uLdeeOnDuUHn3ZN3vSXn8gVjzo/jz7/2OpyVV3n6OLS+t0SN2M1MbstP2ZnZzIY9NPrVfndV70qH/3YxzM7uy2zs9vy0b/5RH7/D/4gvV6dqal+ZmaGRe+Ruk7v0Gfysf1Jtj02T3/kIEsra683WV6sc/n1T8yuJEc+/cns6062VMmxKz3HyytZGbfpqumcP5NkZTErqdI/9Jd53Z/PJ8NBcuA9ef1fL6RfjbO40iaZyc6ZOlV3KJ+9aznJ7tz0HY9I5hdy9OhiFrZdnVueMJNkXz557yiDui37rB4eHh4eHh4e5+CjruscPDiXpmkzHo/TNOMsLCxkcXExi4uLWVpaWv96YWE+TTNOMx6nadrMzR1K3etlEs51Dh06vD7OeDyZYnHsosVjFzEmXcbjZvX92hw6dHj1Qsakrnv5uyNL6dKmbUZpm1HumFvMKz45l5945pPznEsG+ZnveVp+81Nz+cTBhfVtuq7NnUeXV49nM5/9DKZ2zMzMZOfOC3LvvfdkajDIn7z+dXnzW96SdMnC4kKmpqbStl12774ky8tLOXz48JbfI6ky1bs7b73103n2P31Ubv7Jf5LP/effy599biFtNZ0rbvrh/Mz37kpyV2677XPphnWq9RVOduX6F/3jXLJh+bt0C7njLW/In+0b5rxhkvnFjLo6veFKPn3rG/LOmcdl5fa35YsZpJ82o6UmyTA7hkkGK/nUG9+aLz3luXn4c38u//3aT+fOuUEufdQj87BBsvSRW/P2e5LBTNn3EwDgXFNVSb/fz759X8m2bTNpmiZV1aau2/R69foFhsdu3NKunklu0+/3s3fv3gx6/dSp7zfOZG3p5IMf/IuTvvd4PErbduvj9PuDVF2VqcEg79s/n6svTrrV6SazM7P5F9/1bXn0yt6MvrI/V+7YmZ/+7qdmuPdz6cYLkwF7U3nXvnGmBrNf+6kdhw4dzszMONdc84QsLi5m3IwzNZicHl8ZraRXT+5dftddX8r8/HzxvOFq0M/h9/yP/OYjX56f/s4n5Z/9hyflRxaOZmm4Pdt6SXIoH/zt/5Lb9tUZTlVZ2fDRHn7t0/Lw40ZbyfTtb8jbD8xk2yDJaCmj1W0Hc+/P777ivclgKjODpBknK4ujJFPZPl2nq6r077stv/gLR/LiF313rn/0o/L4y5Pxobvyl+99c37/DR/J0nCQfrf2bxQAgAe3tu0yGEzlwIGD2XXRRRlODdK2baq6Sq/prYZ0Vlc669K0Tbp2chb7wMG5zB08mNnZ7UmV9PvHjzNuujzhCY9Pr1evTvOY3P2wbSdnpRcWF1NXVeYXFrJ/3/7MzM6mS9IfDPKuw708+7xRLq/qtOOV7JlpkoW71+dEN3P7cmXTJFNt2oVx6sFUPny0y3uO9rJ9xyDj1XnaD6S68YbruqmpTa7xcRKzs7PZvfuSXHnVVbnoootTV3Xuu+/e3HnnZ7J3794sLMwXj31Ml5WFNjuuvinPfsa1efJ1j8ruuss9H3hjXv3Gd+TDe7vMDKtMptJ0WT66lKX7rbIxMZidyWyvyfyRlYzrfrZvG6R30pvXdGkWl3N01GUwO53Z1dseduMmSyujjMaTifFVPfkX1PSwt/r+AAAPHXXdSzNu0rRtrrzyivUz0BtvnnLcTVXqOm3T5c47P5Nev5+pwTB1XaVtJzd2absuj3zkN6eqM1mJY8M4SVanekzucJiuymc/+9kkVaamBuvrP49WRtk5OpJf3j2f87rR+jJ4Jz3+/iCHq0Fefu+OLA23paqTtjlFSG6wsjKahPRgs4vlnWXdeJzlleTi7/u5vPJFj8j4C7fnNW+6PR/5zD05uDBKtcm7DwIAcOa6JOm69AeDrKyspBlP1oKenZ095TrSCwsLueeee9Pr1RlOTx93IWHbdllZXk7TtNmz55LMzMysjrHx//dXq8vnNbnrri+nbdtMTw9Trd7sZc3y8lKGK0v50fMO59rh8mRZ5bWbgKyFed3Lh5eH+Z3D52V5aib9/ubPRo9Go/Qe8YjLf2mzd2856+o6/UGVo3f8Ve7oPTxXP/naPPVpN+a7n3VVvvzW9+UL4zrnyCcBAHhQ6LoubdNkODWVVMnBAwezvLySVF3qXp0ukzWaFxYWsn//gezfvz9Tg2GmhsP18K2qyapnVVWtX+x34MDByZJ6VVLXddo2abs2S8tLmTs4l3vvvS+9fi/DqalUqy1b5VhI93v9jKpe3nt0kC+tJMOqy7aqy7BOjrR1PjGaymuPbMvrF85Pb3o2/X5/svTeJucjt207OSNddvvus6nLeHmU5W5bdn/zFXn49sO549P3ZFzXMbsCAODra+3Mc3/QT5VeRuPR5O7Sq2eBq6pKr+6lN+hnqj9YPXs82ffEJfImvyZd12RlNM54NF6dztGmqurUdZ1+v5fB1CB1VR8f46c4ttFolNFolLZt0rZd6rpKvXo9X38wSNs0acbjdFu40m08biYh3eudayG9pkvXdGmSyZWhZ/twAAAeorpkvcV6vf7k7PL6BWTHYndtfelTrQ+99vxkjegkXXvCxI5MlgtZXWv6VOOc9lg3rCLSNOOiFdeapilf/u4bRl2ll+S4Ox4CAPB1t9Zi49Nc3Pdg0p/8IkEBAGAriteRBgCAh7Jzf2oHAACcBf0kuf39HzrbxwEAAOeMG2+4zrLLAABQQkgDAEABIQ0AAAWENAAAFBDSAABQQEgDAEABIQ0AAAWENAAAFBDSAABQQEgDAEABIQ0AAAWENAAAFBDSAABQQEgDAEABIQ0AAAWENAAAFBDSAABQQEgDAEABIQ0AAAWENAAAFBDSAABQQEgDAEABIQ0AAAWENAAAFBDSAABQQEgDAEABIQ0AAAWENAAAFBDSAABQQEgDAEABIQ0AAAWENAAAFBDSAABQQEgDAEABIQ0AAAXqXq93to8BAADOKb1eT0gDAMBWCWkAACjQ6/VS94U0AABsSd8ZaQAA2LrJ1I5+/2wfBwAAnFN6/b4z0gAAsFXmSAMAQAFzpAEAoIDl7wAAoICQBgCAAuZIAwBAgb7l7wAAYOssfwcAAAXMkQYAgALmSAMAQAHrSAMAQAFTOwAAoMAkpPtCGgAAtqLXN0caAAC2bHWOtHWkAQBgK3o960gDAMCWudgQAAAKWEcaAAAKWEcaAAAKWP4OAAAK9PrOSAMAwJb1LH8HAABb1+v1XWwIAABb5WJDAAAoYB1pAAAoIKQBAKDA5IYslr8DAIAt6Vv+DgAAts7ydwAAUKDX66c+2wcBAADnIiENAAAFhDQAABQQ0gAAUEBIAwBAASENAAAFhDQAABQQ0gAAUEBIAwBAASENAAAFhDQAABQQ0gAAUEBIAwBAASENAAAFhDQAABQQ0gAAUEBIAwBAASENAAAFhDQAABQQ0gAAUEBIAwBAASENAAAFhDQAABQQ0gAAUEBIAwBAASENAAAFhDQAABQQ0gAAUEBIAwBAASENAAAFhDQAABQQ0gAAUEBIAwBAASENAAAFhDQAABQQ0gAAUEBIAwBAASENAAAFhDQAABQQ0gAAUEBIAwBAASENAAAFhDQAABQQ0gAAUEBIAwBAASENAAAFhDQAABQQ0gAAUEBIAwBAASENAAAFhDQAABQQ0gAAUEBIAwBAASENAAAFhDQAABQQ0gAAUEBIAwBAASENAAAFhDQAABQQ0gAAUEBIAwBAASENAAAFhDQAABQQ0gAAUEBIAwBAASENAAAFhDQAABQQ0gAAUEBIAwBAASENAAAFhDQAABQQ0gAAUEBIAwBAASENAAAFhDQAABQQ0gAAUEBIAwBAASENAAAFhDQAABQQ0gAAUEBIAwBAASENAAAFhDQAABQQ0gAAUEBIAwBAASENAAAFhDQAABQQ0gAAUEBIAwBAASENAAAFhDQAABQQ0gAAUEBIAwBAASENAAAFhDQAABQQ0gAAUEBIAwBAASENAAAFhDQAABQQ0gAAUEBIAwBAASENAAAFhDQAABQQ0gAAUEBIAwBAASENAAAFhDQAABQQ0gAAUEBIAwBAASENAAAFhDQAABQQ0gAAUEBIAwBAASENAAAFhDQAABQQ0gAAUEBIAwBAASENAAAFhDQAABQQ0gAAUEBIAwBAASENAAAFhDQAABQQ0gAAUEBIAwBAASENAAAFhDQAABQQ0gAAUEBIAwBAASENAAAFhDQAABQQ0gAAUEBIAwBAASENAAAFhDQAABQQ0gAAUEBIAwBAASENAAAFhDQAABQQ0gAAUEBIAwBAASENAAAFhDQAABQQ0gAAUEBIAwBAASENAAAFhDQAABQQ0gAAUEBIAwBAASENAAAFhDQAABQQ0gAAUEBIAwBAASENAAAFhDQAABQQ0gAAUEBIAwBAASENAAAFhDQAABQQ0gAAUEBIAwBAASENAAAFhDQAABQQ0gAAUEBIAwBAASENAAAFhDQAABQQ0gAAUEBIAwBAASENAAAFhDQAABQQ0gAAUEBIAwBAASENAAAFhDQAABQQ0gAAUEBIAwBAASENAAAFhDQAABQQ0gAAUEBIAwBAASENAAAFhDQAABQQ0gAAUEBIAwBAASENAAAFhDQAABQQ0gAAUEBIAwBAASENAAAFhDQAABQQ0gAAUEBIAwBAASENAAAFhDQAABQQ0gAAUEBIAwBAASENAAAFhDQAABQQ0gAAUEBIAwBAASENAAAFhDQAABQQ0gAAUEBIAwBAASENAAAFhDQAABQQ0gAAUEBIAwBAASENAAAFhDQAABQQ0gAAUEBIAwBAASENAAAFhDQAABQQ0gAAUEBIAwBAASENAAAFhDQAABQQ0gAAUEBIAwBAASENAAAFhDQAABQQ0gAAUEBIAwBAASENAAAFhDQAABQQ0gAAUEBIAwBAASENAAAFhDQAABQQ0gAAUEBIAwBAASENAAAFhDQAABQQ0gAAUEBIAwBAASENAAAFhDQAABQQ0gAAUEBIAwBAASENAAAFhDQAABQQ0gAAUEBIAwBAASENAAAFhDQAABQQ0gAAUEBIAwBAASENAAAFhDQAABQQ0gAAUEBIAwBAASENAAAFhDQAABQQ0gAAUEBIAwBAASENAAAFhDQAABQQ0gAAUEBIAwBAASENAAAFhDQAABQQ0gAAUEBIAwBAASENAAAFhDQAABQQ0gAAUEBIAwBAASENAAAFhDQAABQQ0gAAUEBIAwBAASENAAAFhDQAABQQ0gAAUEBIAwBAASENAAAFhDQAABQQ0gAAUEBIAwBAASENAAAFhDQAABQQ0gAAUEBIAwBAASENAAAFhDQAABQQ0gAAUEBIAwBAASENAAAFhDQAABQQ0gAAUEBIAwBAASENAAAFhDQAABQQ0gAAUEBIAwBAASENAAAFhDQAABQQ0gAAUEBIAwBAASENAAAFhDQAABQQ0gAAUEBIAwBAASENAAAFhDQAABQQ0gAAUEBIAwBAASENAAAFhDQAABQQ0gAAUEBIAwBAASENAAAFhDQAABToJ0nXvTBJUlWvXX/hZM9t1tq+p9t/M9ucqVN9hjP5bF8Nm/3sW/k+nq3PAgDwUPU1OSO9mah7KIffZj/7A223MbQ3fg0AwNde/2wfwDeCk0Xoqc5in24bAAAeOrYU0l/PmDzXwnXjFIuvxrQVZ5gBAL6xHTe1o+teuP440cZQXHtsfP6r6ev5Xl8tJx7jmRzzZuc9b3z9G/kfGQAAD0bHnZE+2cWGJ/pGjtnT+XpelHcm7+HiQQCAc8OW50gLvM3zvQIAePB6SFxs+GBe3UKsAwCcHWe0/N2p5lN/ozhxDvGDcU7xN/rPAADgwWrTZ6TXVqM4MdpOFqQnngHe6jZbea+vhq/Guteb+cyb2fbEz77x9w+W+AcAeDCo3vDaP+qe/8IXn+3jAACAc8YbXvtHX5s7GwIAwIOdkAYAgAJCGgAACvSTyRwPAABg8/4/wvPadhwhA5sAAAAASUVORK5CYII=" alt="QEMU 在左下角输出一个黄色的 &quot;Hello W■■rld!&quot;"></p> <p>需要注意的是，<code>ö</code> 字符被打印为两个 <code>■</code> 字符。这是因为在 UTF-8 编码下，字符 <code>ö</code> 是由两个字节表示的，而这两个字节并不处在可打印的 ASCII 码字节范围之内。事实上，这是 UTF-8 编码的基本特点之一：如果一个字符占用多个字节，那么每个组成它的独立字节都不是有效的 ASCII 码字节。</p> <h3 id="易失操作"><a href="#易失操作" class="header-anchor">#</a> 易失操作</h3> <p>可以看到我们的信息被正确地打印到屏幕上。然而，未来 Rust 编译器更暴力的优化后，这段代码就不一定正常了。</p> <p>问题在于我们只向 <code>Buffer</code> 写入，却从不对它执行读操作。编译器不知道我们事实上操作了 VGA 缓冲区内存（而不是普通内存），也不知道产生的<strong>副作用</strong>，即会有几个字符显示在屏幕上。编译器这时可能会认为这些写入操作没有必要，是可忽略的。为了避免这些并不正确的优化，这些写入操作应当被指定为 <a href="https://en.wikipedia.org/wiki/Volatile_(computer_programming)" target="_blank" rel="noopener noreferrer"><em>易失操作</em><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>。这将告诉编译器，这些写操作有副作用，不应该被优化掉。</p> <p>为了在 VGA 缓冲区中执行易失的写入操作，我们使用 <a href="https://docs.rs/volatile" target="_blank" rel="noopener noreferrer">volatile<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 库。这个 <em>crate</em>（Rust 生态对包的称呼）提供一个名为 <code>Volatile</code> 的包装器，具有 <code>read</code>、<code>write</code> 方法。这些方法底层利用核心库的 <a href="https://doc.rust-lang.org/nightly/core/ptr/fn.read_volatile.html" target="_blank" rel="noopener noreferrer">read_volatile<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 和 <a href="https://doc.rust-lang.org/nightly/core/ptr/fn.write_volatile.html" target="_blank" rel="noopener noreferrer">write_volatile<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 函数，从而保证读操作或写操作不会被编译器优化。</p> <p>往 <code>Cargo.toml</code> 的 <code>dependencies</code> 添加 <code>volatile</code> 即可将其设置为项目依赖：</p> <div class="language-toml line-numbers-mode"><pre class="language-toml"><code><span class="token comment"># in Cargo.toml</span>

<span class="token punctuation">[</span><span class="token table class-name">dependencies</span><span class="token punctuation">]</span>
<span class="token key property">volatile</span> <span class="token punctuation">=</span> <span class="token string">&quot;0.2.6&quot;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p><code>0.2.6</code> 表示一个 <a href="https://semver.org/" target="_blank" rel="noopener noreferrer">语义化<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 版本号。更多详情参见 cargo 文档的 <a href="https://doc.crates.io/specifying-dependencies.html" target="_blank" rel="noopener noreferrer">指定依赖<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 指南。</p> <p>我们使用它来完成 VGA 缓冲区的易失写入操作。<code>Buffer</code> 类型更新如下：</p> <div class="language-rust line-numbers-mode"><pre class="language-rust"><code><span class="token comment">// in src/vga_buffer.rs</span>

<span class="token keyword">use</span> <span class="token namespace">volatile<span class="token punctuation">::</span></span><span class="token class-name">Volatile</span><span class="token punctuation">;</span>

<span class="token keyword">struct</span> <span class="token type-definition class-name">Buffer</span> <span class="token punctuation">{</span>
    chars<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token class-name">Volatile</span><span class="token operator">&lt;</span><span class="token class-name">ScreenChar</span><span class="token operator">&gt;</span><span class="token punctuation">;</span> <span class="token constant">BUFFER_WIDTH</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token constant">BUFFER_HEIGHT</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>在这里，我们不使用 <code>ScreenChar</code> ，而选择使用 <code>Volatile&lt;ScreenChar&gt;</code>。在这里，<code>Volatile</code> 类型是一个 <a href="https://doc.rust-lang.org/book/ch10-01-syntax.html" target="_blank" rel="noopener noreferrer">泛型<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>，可以包装（几乎）所有的类型。这确保我们不会无意间对其执行“普通”的写入操作。而且，现在还必须使用 <code>write</code> 方法了。</p> <p>这意味着，我们必须要修改 <code>Writer::write_byte</code> 方法如下：</p> <div class="language-rust line-numbers-mode"><pre class="language-rust"><code><span class="token comment">// in src/vga_buffer.rs</span>

<span class="token keyword">impl</span> <span class="token class-name">Writer</span> <span class="token punctuation">{</span>
    <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">write_byte</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">,</span> byte<span class="token punctuation">:</span> <span class="token keyword">u8</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">match</span> byte <span class="token punctuation">{</span>
            <span class="token char">b'\n'</span> <span class="token operator">=&gt;</span> <span class="token keyword">self</span><span class="token punctuation">.</span><span class="token function">new_line</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            byte <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
                <span class="token punctuation">...</span>

                <span class="token keyword">self</span><span class="token punctuation">.</span>buffer<span class="token punctuation">.</span>chars<span class="token punctuation">[</span>row<span class="token punctuation">]</span><span class="token punctuation">[</span>col<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token class-name">ScreenChar</span> <span class="token punctuation">{</span>
                    ascii_character<span class="token punctuation">:</span> byte<span class="token punctuation">,</span>
                    color_code<span class="token punctuation">:</span> color_code<span class="token punctuation">,</span>
                <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">...</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token punctuation">...</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><p>正如代码所示，我们不再使用普通的 <code>=</code> 赋值，而使用 <code>write</code> 方法。这能确保编译器不会再优化掉这个写操作。</p> <h3 id="格式化宏"><a href="#格式化宏" class="header-anchor">#</a> 格式化宏</h3> <p>支持 Rust 提供的格式化宏会更好。一旦实现，我们可以轻松地打印不同类型的变量，如整数或浮点数。支持这个特性需要我们实现 <a href="https://doc.rust-lang.org/nightly/core/fmt/trait.Write.html" target="_blank" rel="noopener noreferrer"><code>core::fmt::Write</code><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> trait。这个 trait 要求的唯一必须方法是 <code>write_str</code>，这个方法和我们先前编写的 <code>write_string</code> 方法差别不大，只是返回值类型变成了 <code>fmt::Result</code>：</p> <div class="language-rust line-numbers-mode"><pre class="language-rust"><code><span class="token comment">// in src/vga_buffer.rs</span>

<span class="token keyword">use</span> <span class="token namespace">core<span class="token punctuation">::</span>fmt<span class="token punctuation">::</span></span><span class="token class-name">Write</span><span class="token punctuation">;</span>

<span class="token keyword">impl</span> <span class="token namespace">fmt<span class="token punctuation">::</span></span><span class="token class-name">Write</span> <span class="token keyword">for</span> <span class="token class-name">Writer</span> <span class="token punctuation">{</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">write_str</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">,</span> s<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token keyword">str</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token namespace">fmt<span class="token punctuation">::</span></span><span class="token class-name">Result</span> <span class="token punctuation">{</span>
        <span class="token keyword">self</span><span class="token punctuation">.</span><span class="token function">write_string</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Ok</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>这里，<code>Ok(())</code> 属于 <code>Result</code> 枚举类型中的 <code>Ok</code>，包含一个值为 <code>()</code> 的变量。</p> <p>现在我们就可以使用 Rust 内置的格式化宏 <code>write!</code> 和 <code>writeln!</code> 了：</p> <div class="language-rust line-numbers-mode"><pre class="language-rust"><code><span class="token comment">// in src/vga_buffer.rs</span>

<span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">print_something</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">use</span> <span class="token namespace">core<span class="token punctuation">::</span>fmt<span class="token punctuation">::</span></span><span class="token class-name">Write</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> writer <span class="token operator">=</span> <span class="token class-name">Writer</span> <span class="token punctuation">{</span>
        column_position<span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
        color_code<span class="token punctuation">:</span> <span class="token class-name">ColorCode</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token class-name">Color</span><span class="token punctuation">::</span><span class="token class-name">Yellow</span><span class="token punctuation">,</span> <span class="token class-name">Color</span><span class="token punctuation">::</span><span class="token class-name">Black</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        buffer<span class="token punctuation">:</span> <span class="token keyword">unsafe</span> <span class="token punctuation">{</span> <span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token number">0xb8000</span> <span class="token keyword">as</span> <span class="token operator">*</span><span class="token keyword">mut</span> <span class="token class-name">Buffer</span><span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>

    writer<span class="token punctuation">.</span><span class="token function">write_byte</span><span class="token punctuation">(</span><span class="token char">b'H'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    writer<span class="token punctuation">.</span><span class="token function">write_string</span><span class="token punctuation">(</span><span class="token string">&quot;ello! &quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token macro property">write!</span><span class="token punctuation">(</span>writer<span class="token punctuation">,</span> <span class="token string">&quot;The numbers are {} and {}&quot;</span><span class="token punctuation">,</span> <span class="token number">42</span><span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token operator">/</span><span class="token number">3.0</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><p>现在，屏幕底部应该能看到一串 <code>Hello! The numbers are 42 and 0.3333333333333333</code>。<code>write!</code> 宏返回的 <code>Result</code> 类型，这个类型没有被使用的话会触发警告，所以我们调用它的 [unwrap] 方法，使得发生错误时 panic。因为 VGA 缓冲区的写入操作永不失败，我们的场景应该不会发生这个问题。</p> <h3 id="换行"><a href="#换行" class="header-anchor">#</a> 换行</h3> <p>在之前的代码中，我们忽略一行内装不下的换行符和其他字符。需要换行时，我们想要把每个字符向上移动一行（最顶行删除），然后在最后一行的起始位置继续打印。要做到这一点，我们实现 <code>Writer</code> 的 <code>new_line</code> 方法：</p> <div class="language-rust line-numbers-mode"><pre class="language-rust"><code><span class="token comment">// in src/vga_buffer.rs</span>

<span class="token keyword">impl</span> <span class="token class-name">Writer</span> <span class="token punctuation">{</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">new_line</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">for</span> row <span class="token keyword">in</span> <span class="token number">1</span><span class="token punctuation">..</span><span class="token constant">BUFFER_HEIGHT</span> <span class="token punctuation">{</span>
            <span class="token keyword">for</span> col <span class="token keyword">in</span> <span class="token number">0</span><span class="token punctuation">..</span><span class="token constant">BUFFER_WIDTH</span> <span class="token punctuation">{</span>
                <span class="token keyword">let</span> character <span class="token operator">=</span> <span class="token keyword">self</span><span class="token punctuation">.</span>buffer<span class="token punctuation">.</span>chars<span class="token punctuation">[</span>row<span class="token punctuation">]</span><span class="token punctuation">[</span>col<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">self</span><span class="token punctuation">.</span>buffer<span class="token punctuation">.</span>chars<span class="token punctuation">[</span>row <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">[</span>col<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>character<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">self</span><span class="token punctuation">.</span><span class="token function">clear_row</span><span class="token punctuation">(</span><span class="token constant">BUFFER_HEIGHT</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">self</span><span class="token punctuation">.</span>column_position <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">fn</span> <span class="token function-definition function">clear_row</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">,</span> row<span class="token punctuation">:</span> <span class="token keyword">usize</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">/* TODO */</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><p>我们遍历屏幕上的每个字符，把每个字符上移一行。这里，<code>..</code> 符号是 区间表示法（<code>..</code>） 表示左闭右开的区间，不包含它的上界。因为第 0 行应该被移出屏幕，遍历从从第 1 行开始，省略了对第 0 行的枚举过程（遍历从 <code>1</code> 开始）。</p> <p>最后 <code>clear_row</code> 方法如下：</p> <div class="language-rust line-numbers-mode"><pre class="language-rust"><code><span class="token comment">// in src/vga_buffer.rs</span>

<span class="token keyword">impl</span> <span class="token class-name">Writer</span> <span class="token punctuation">{</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">clear_row</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">,</span> row<span class="token punctuation">:</span> <span class="token keyword">usize</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> blank <span class="token operator">=</span> <span class="token class-name">ScreenChar</span> <span class="token punctuation">{</span>
            ascii_character<span class="token punctuation">:</span> <span class="token char">b' '</span><span class="token punctuation">,</span>
            color_code<span class="token punctuation">:</span> <span class="token keyword">self</span><span class="token punctuation">.</span>color_code<span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> col <span class="token keyword">in</span> <span class="token number">0</span><span class="token punctuation">..</span><span class="token constant">BUFFER_WIDTH</span> <span class="token punctuation">{</span>
            <span class="token keyword">self</span><span class="token punctuation">.</span>buffer<span class="token punctuation">.</span>chars<span class="token punctuation">[</span>row<span class="token punctuation">]</span><span class="token punctuation">[</span>col<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>blank<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><p>这个方法用空格符覆写每行字符，从而实现清空某行的效果。</p> <h2 id="全局接口"><a href="#全局接口" class="header-anchor">#</a> 全局接口</h2> <p>为了创建一个全局的 writer 用作其他模块的接口，使得不需要到处传递 <code>Writer</code> 实例的话，我们首先尝试创建如下静态的 <code>WRITER</code></p> <div class="language-rust line-numbers-mode"><pre class="language-rust"><code><span class="token comment">// in src/vga_buffer.rs</span>

<span class="token keyword">pub</span> <span class="token keyword">static</span> <span class="token constant">WRITER</span><span class="token punctuation">:</span> <span class="token class-name">Writer</span> <span class="token operator">=</span> <span class="token class-name">Writer</span> <span class="token punctuation">{</span>
    column_position<span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
    color_code<span class="token punctuation">:</span> <span class="token class-name">ColorCode</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token class-name">Color</span><span class="token punctuation">::</span><span class="token class-name">Yellow</span><span class="token punctuation">,</span> <span class="token class-name">Color</span><span class="token punctuation">::</span><span class="token class-name">Black</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    buffer<span class="token punctuation">:</span> <span class="token keyword">unsafe</span> <span class="token punctuation">{</span> <span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token number">0xb8000</span> <span class="token keyword">as</span> <span class="token operator">*</span><span class="token keyword">mut</span> <span class="token class-name">Buffer</span><span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>然后，尝试编译这些代码会触发以下错误：</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>error<span class="token punctuation">[</span>E0015<span class="token punctuation">]</span>: calls <span class="token keyword">in</span> statics are limited to constant functions, tuple structs and tuple variants
 --<span class="token operator">&gt;</span> src/vga_buffer.rs:7:17
  <span class="token operator">|</span>
<span class="token number">7</span> <span class="token operator">|</span>     color_code: ColorCode::new<span class="token punctuation">(</span>Color::Yellow, Color::Black<span class="token punctuation">)</span>,
  <span class="token operator">|</span>                 ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

error<span class="token punctuation">[</span>E0396<span class="token punctuation">]</span>: raw pointers cannot be dereferenced <span class="token keyword">in</span> statics
 --<span class="token operator">&gt;</span> src/vga_buffer.rs:8:22
  <span class="token operator">|</span>
<span class="token number">8</span> <span class="token operator">|</span>     buffer: unsafe <span class="token punctuation">{</span> <span class="token operator">&amp;</span>mut *<span class="token punctuation">(</span>0xb8000 as *mut Buffer<span class="token punctuation">)</span> <span class="token punctuation">}</span>,
  <span class="token operator">|</span>                      ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^ dereference of raw pointer <span class="token keyword">in</span> constant

error<span class="token punctuation">[</span>E0017<span class="token punctuation">]</span>: references <span class="token keyword">in</span> statics may only refer to immutable values
 --<span class="token operator">&gt;</span> src/vga_buffer.rs:8:22
  <span class="token operator">|</span>
<span class="token number">8</span> <span class="token operator">|</span>     buffer: unsafe <span class="token punctuation">{</span> <span class="token operator">&amp;</span>mut *<span class="token punctuation">(</span>0xb8000 as *mut Buffer<span class="token punctuation">)</span> <span class="token punctuation">}</span>,
  <span class="token operator">|</span>                      ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^ statics require immutable values

error<span class="token punctuation">[</span>E0017<span class="token punctuation">]</span>: references <span class="token keyword">in</span> statics may only refer to immutable values
 --<span class="token operator">&gt;</span> src/vga_buffer.rs:8:13
  <span class="token operator">|</span>
<span class="token number">8</span> <span class="token operator">|</span>     buffer: unsafe <span class="token punctuation">{</span> <span class="token operator">&amp;</span>mut *<span class="token punctuation">(</span>0xb8000 as *mut Buffer<span class="token punctuation">)</span> <span class="token punctuation">}</span>,
  <span class="token operator">|</span>             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^ statics require immutable values
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br></div></div><p>为了理解事情的起因，我们需要明确一点：常规变量在运行时初始化，而静态变量在编译时初始化。这是 Rust 编译器中名为 <a href="https://rustc-dev-guide.rust-lang.org/const-eval.html" target="_blank" rel="noopener noreferrer">&quot;常量计算器&quot;<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 的组件，这种组件在编译时确定初始化表达式的值。虽然目前组件功能有限，但对它的扩展工作进展活跃，比如一个 <a href="https://github.com/rust-lang/rfcs/pull/2345" target="_blank" rel="noopener noreferrer">RFC<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 就提议允许在常量表达式中 panic。</p> <p><code>ColorCode::new</code> 的问题应该能使用 <a href="https://doc.rust-lang.org/unstable-book/language-features/const-fn.html" target="_blank" rel="noopener noreferrer"><code>const</code> 函数<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 解决，但问题的根源在于不能在编译时直接把裸指针转变成引用。也许未来这段代码能够跑通，但在那之前，我们需要找别的法子。</p> <h3 id="延迟初始化"><a href="#延迟初始化" class="header-anchor">#</a> 延迟初始化</h3> <p>使用非 <code>const</code> 函数实现初始化静态变量只初始化一次是 Rust 的常见问题。好在有一个叫做 <a href="https://docs.rs/lazy_static/1.0.1/lazy_static/" target="_blank" rel="noopener noreferrer">lazy_static<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 的包提供了一个很棒的解决方案。它提供了名为 <code>lazy_static!</code> 的宏，能够定义一个延迟初始化的静态变量。这个 <code>static</code> 变量将在第一次使用时被初始化，而非在编译时计算。因此，变量的初始化过程发生在运行时，任意复杂程度的初始化代码都可行。</p> <p>现在，我们将 <code>lazy_static</code> 包导入到我们的项目：</p> <div class="language-toml line-numbers-mode"><pre class="language-toml"><code><span class="token comment"># in Cargo.toml</span>

<span class="token punctuation">[</span><span class="token table class-name">dependencies.lazy_static</span><span class="token punctuation">]</span>
<span class="token key property">version</span> <span class="token punctuation">=</span> <span class="token string">&quot;1.0&quot;</span>
<span class="token key property">features</span> <span class="token punctuation">=</span> <span class="token punctuation">[</span><span class="token string">&quot;spin_no_std&quot;</span><span class="token punctuation">]</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>在这里，由于程序不连接标准库，我们需要启用 <code>spin_no_std</code> 特性。</p> <p>借助 <code>lazy_static</code>，我们就可以定义以下可行的 <code>WRITER</code> 变量了：</p> <div class="language-rust line-numbers-mode"><pre class="language-rust"><code><span class="token comment">// in src/vga_buffer.rs</span>

<span class="token keyword">use</span> <span class="token namespace">lazy_static<span class="token punctuation">::</span></span>lazy_static<span class="token punctuation">;</span>

<span class="token macro property">lazy_static!</span> <span class="token punctuation">{</span>
    <span class="token keyword">pub</span> <span class="token keyword">static</span> <span class="token keyword">ref</span> <span class="token constant">WRITER</span><span class="token punctuation">:</span> <span class="token class-name">Writer</span> <span class="token operator">=</span> <span class="token class-name">Writer</span> <span class="token punctuation">{</span>
        column_position<span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
        color_code<span class="token punctuation">:</span> <span class="token class-name">ColorCode</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token class-name">Color</span><span class="token punctuation">::</span><span class="token class-name">Yellow</span><span class="token punctuation">,</span> <span class="token class-name">Color</span><span class="token punctuation">::</span><span class="token class-name">Black</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        buffer<span class="token punctuation">:</span> <span class="token keyword">unsafe</span> <span class="token punctuation">{</span> <span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token number">0xb8000</span> <span class="token keyword">as</span> <span class="token operator">*</span><span class="token keyword">mut</span> <span class="token class-name">Buffer</span><span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>然而，由于不可变，这个 <code>WRITER</code> 用处不大。这意味着我们无法向它写入任何数据（因为所有写入操作都需要实例的可变引用 <code>&amp;mut self</code>）。一种解决方案是使用 <a href="https://doc.rust-lang.org/book/ch19-01-unsafe-rust.html#accessing-or-modifying-a-mutable-static-variable" target="_blank" rel="noopener noreferrer">可变静态变量<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>。然而这么做很容引入数据竞争和其他坑，所以所有对它的读写操作都是不安全的。社区很嫌弃 <code>static mut</code> 的使用，甚至有一些提案认为 <a href="https://internals.rust-lang.org/t/pre-rfc-remove-static-mut/1437" target="_blank" rel="noopener noreferrer">应该将它删除<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>。那得咋整呢？我们可以尝试用比如 <a href="https://doc.rust-lang.org/book/ch15-05-interior-mutability.html#keeping-track-of-borrows-at-runtime-with-refcellt" target="_blank" rel="noopener noreferrer">RefCell<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 或甚至 <a href="https://doc.rust-lang.org/nightly/core/cell/struct.UnsafeCell.html" target="_blank" rel="noopener noreferrer">UnsafeCell<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 等提供的 <a href="https://doc.rust-lang.org/book/ch15-05-interior-mutability.html" target="_blank" rel="noopener noreferrer">内部可变性<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 的类型来包装一个不可变的静态变量。但这些类型都被设计为非同步类型，即不满足 <a href="https://doc.rust-lang.org/nightly/core/marker/trait.Sync.html" target="_blank" rel="noopener noreferrer">Sync<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 约束，所以我们不能在静态变量中使用它们。</p> <h3 id="自旋锁"><a href="#自旋锁" class="header-anchor">#</a> 自旋锁</h3> <p>要实现阻塞的内部可变性，我们往往使用标准库提供的互斥锁 <a href="https://doc.rust-lang.org/nightly/std/sync/struct.Mutex.html" target="_blank" rel="noopener noreferrer">Mutex<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>。它在资源被占用时阻塞线程，从而实现资源的互斥访问。但我们的内核雏形还没有线程和阻塞的概念，所以不能使用这个类。不过，计算机科学还有一种不需要任何操作系统支持的、非常基础的互斥锁——<a href="https://en.wikipedia.org/wiki/Spinlock" target="_blank" rel="noopener noreferrer">自旋锁<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>。自旋锁并不会阻塞调用逻辑，而是在一个小的无限循环中反复尝试获得这个锁，从而消耗 CPU 时间，直到互斥锁被它的占用者再次释放。</p> <p>为了使用自旋的互斥锁，我们添加 <a href="https://crates.io/crates/spin" target="_blank" rel="noopener noreferrer">spin 包<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 到项目的依赖项列表：</p> <div class="language-toml line-numbers-mode"><pre class="language-toml"><code><span class="token comment"># in Cargo.toml</span>
<span class="token punctuation">[</span><span class="token table class-name">dependencies</span><span class="token punctuation">]</span>
<span class="token key property">spin</span> <span class="token punctuation">=</span> <span class="token string">&quot;0.4.9&quot;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>现在，我们能够使用自旋的互斥锁为 <code>WRITER</code> 类实现安全的 <a href="https://doc.rust-lang.org/book/ch15-05-interior-mutability.html" target="_blank" rel="noopener noreferrer">内部可变性<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>：</p> <div class="language-rust line-numbers-mode"><pre class="language-rust"><code><span class="token comment">// in src/vga_buffer.rs</span>

<span class="token keyword">use</span> <span class="token namespace">spin<span class="token punctuation">::</span></span><span class="token class-name">Mutex</span><span class="token punctuation">;</span>
<span class="token punctuation">...</span>
<span class="token macro property">lazy_static!</span> <span class="token punctuation">{</span>
    <span class="token keyword">pub</span> <span class="token keyword">static</span> <span class="token keyword">ref</span> <span class="token constant">WRITER</span><span class="token punctuation">:</span> <span class="token class-name">Mutex</span><span class="token operator">&lt;</span><span class="token class-name">Writer</span><span class="token operator">&gt;</span> <span class="token operator">=</span> <span class="token class-name">Mutex</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token class-name">Writer</span> <span class="token punctuation">{</span>
        column_position<span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
        color_code<span class="token punctuation">:</span> <span class="token class-name">ColorCode</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token class-name">Color</span><span class="token punctuation">::</span><span class="token class-name">Yellow</span><span class="token punctuation">,</span> <span class="token class-name">Color</span><span class="token punctuation">::</span><span class="token class-name">Black</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        buffer<span class="token punctuation">:</span> <span class="token keyword">unsafe</span> <span class="token punctuation">{</span> <span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token number">0xb8000</span> <span class="token keyword">as</span> <span class="token operator">*</span><span class="token keyword">mut</span> <span class="token class-name">Buffer</span><span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>现在我们可以删除 <code>print_something</code> 函数，尝试直接在 <code>_start</code> 函数中打印字符：</p> <div class="language-rust line-numbers-mode"><pre class="language-rust"><code><span class="token comment">// in src/main.rs</span>
<span class="token attribute attr-name">#[no_mangle]</span>
<span class="token keyword">pub</span> <span class="token keyword">extern</span> <span class="token string">&quot;C&quot;</span> <span class="token keyword">fn</span> <span class="token function-definition function">_start</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token operator">!</span> <span class="token punctuation">{</span>
    <span class="token keyword">use</span> <span class="token namespace">core<span class="token punctuation">::</span>fmt<span class="token punctuation">::</span></span><span class="token class-name">Write</span><span class="token punctuation">;</span>
    <span class="token namespace">vga_buffer<span class="token punctuation">::</span></span><span class="token constant">WRITER</span><span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">write_str</span><span class="token punctuation">(</span><span class="token string">&quot;Hello again&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token macro property">write!</span><span class="token punctuation">(</span><span class="token namespace">vga_buffer<span class="token punctuation">::</span></span><span class="token constant">WRITER</span><span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;, some numbers: {} {}&quot;</span><span class="token punctuation">,</span> <span class="token number">42</span><span class="token punctuation">,</span> <span class="token number">1.337</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">loop</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>我们需要导入名为 <code>fmt::Write</code> 的 trait，来使用实现这个 trait 的类的相应方法。</p> <h3 id="安全性"><a href="#安全性" class="header-anchor">#</a> 安全性</h3> <p>可以发现，代码现在只剩一个 <code>unsafe</code> 语句块，它用于创建一个指向 <code>0xb8000</code> 地址的 <code>Buffer</code> 类型引用。经此处理，所有操作都变得安全了。Rust 默认为每个数组访问检查边界，所以我们不会在不经意间越界到缓冲区之外。因此，我们把要求的条件编码到 Rust 的类型系统，从而为外界提供的安全接口。</p> <h3 id="println-宏"><a href="#println-宏" class="header-anchor">#</a> <code>println!</code> 宏</h3> <p>现在有了一个全局的 <code>Writer</code> 实例，我们可以基于它实现可被随处使用的 <code>println!</code> 宏。Rust 提供的 <a href="https://doc.rust-lang.org/nightly/book/ch19-06-macros.html#declarative-macros-with-macro_rules-for-general-metaprogramming" target="_blank" rel="noopener noreferrer">宏语法<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 有点晦涩，所以我们不会从零开始手码这个宏。我们先看看标准库 <a href="https://doc.rust-lang.org/nightly/std/macro.println!.html" target="_blank" rel="noopener noreferrer"><code>println!</code> 宏<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 的实现源码：</p> <div class="language-rust line-numbers-mode"><pre class="language-rust"><code><span class="token attribute attr-name">#[macro_export]</span>
<span class="token macro property">macro_rules!</span> println <span class="token punctuation">{</span>
    <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">(</span><span class="token macro property">print!</span><span class="token punctuation">(</span><span class="token string">&quot;\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">(</span>$<span class="token punctuation">(</span><span class="token variable">$arg</span><span class="token punctuation">:</span><span class="token fragment-specifier punctuation">tt</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">(</span><span class="token macro property">print!</span><span class="token punctuation">(</span><span class="token string">&quot;{}\n&quot;</span><span class="token punctuation">,</span> <span class="token macro property">format_args!</span><span class="token punctuation">(</span>$<span class="token punctuation">(</span><span class="token variable">$arg</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>宏由一个或多个规则组成，类似 <code>match</code> 语句的多个分支。<code>println</code> 宏有两个规则：第一个规则不要求传入参数（例如， <code>println!()</code>），它将被扩展为 <code>print!(&quot;\n&quot;)</code>，因此只会打印一个换行符。第二个要求传入参数（例如，<code>println!(&quot;Hello&quot;)</code> 或 <code>println!(&quot;Number: {}&quot;, 3)</code>）。它将扩展成 <code>print!</code> 宏，传入所有参数，并在输出的字符串最后加入一个换行符 <code>\n</code>。</p> <p>这里，<code>#[macro_export]</code> 属性使得这个宏在整个包（不仅是定义这个宏的模块）和它的依赖包范围内可用。它还将把宏置于包的根模块下，这意味着比如我们需要通过 <code>use std::println</code> 来导入这个宏，而不是 <code>std::macros::println</code>。</p> <p><a href="https://doc.rust-lang.org/nightly/std/macro.print!.html" target="_blank" rel="noopener noreferrer"><code>print!</code> 宏<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 定义如下：</p> <div class="language-rust line-numbers-mode"><pre class="language-rust"><code><span class="token attribute attr-name">#[macro_export]</span>
<span class="token macro property">macro_rules!</span> print <span class="token punctuation">{</span>
    <span class="token punctuation">(</span>$<span class="token punctuation">(</span><span class="token variable">$arg</span><span class="token punctuation">:</span><span class="token fragment-specifier punctuation">tt</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">(</span><span class="token variable">$crate</span><span class="token punctuation">::</span><span class="token namespace">io<span class="token punctuation">::</span></span><span class="token function">_print</span><span class="token punctuation">(</span><span class="token macro property">format_args!</span><span class="token punctuation">(</span>$<span class="token punctuation">(</span><span class="token variable">$arg</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>这个宏将扩展为 <code>io</code> 模块的 <a href="https://github.com/rust-lang/rust/blob/29f5c699b11a6a148f097f82eaa05202f8799bbc/src/libstd/io/stdio.rs#L698" target="_blank" rel="noopener noreferrer"><code>_print</code> 函数<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 调用。<a href="https://doc.rust-lang.org/1.30.0/book/first-edition/macros.html#the-variable-crate" target="_blank" rel="noopener noreferrer"><code>$crate</code> 变量<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 将在 <code>std</code> 包之外被解析为 <code>std</code> 包，保证整个宏在 <code>std</code> 包之外也可以正常使用。</p> <p><a href="https://doc.rust-lang.org/nightly/std/macro.format_args.html" target="_blank" rel="noopener noreferrer"><code>format_args!</code> 宏<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 将传入的参数组织为一个 <a href="https://doc.rust-lang.org/nightly/core/fmt/struct.Arguments.html" target="_blank" rel="noopener noreferrer">fmt::Arguments<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 类型，这个类型将传给 <code>_print</code> 函数。libstd 包的 <a href="https://github.com/rust-lang/rust/blob/29f5c699b11a6a148f097f82eaa05202f8799bbc/src/libstd/io/stdio.rs#L698" target="_blank" rel="noopener noreferrer"><code>print</code> 函数<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 调用复杂的私有函数 <code>print_to</code>，来支持不同 <code>Stdout</code> 设备。因为我们只需要打印到 VGA 字符缓冲区，所以这般复杂的我们还用不上。</p> <p>为了打印到 VGA 缓冲区，我们把 <code>println!</code> 和 <code>print!</code> 两个宏复制过来，但改动这些宏使得它们调用我们定义的 <code>_print</code> 函数：</p> <div class="language-rust line-numbers-mode"><pre class="language-rust"><code><span class="token comment">// in src/vga_buffer.rs</span>

<span class="token attribute attr-name">#[macro_export]</span>
<span class="token macro property">macro_rules!</span> print <span class="token punctuation">{</span>
    <span class="token punctuation">(</span>$<span class="token punctuation">(</span><span class="token variable">$arg</span><span class="token punctuation">:</span><span class="token fragment-specifier punctuation">tt</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">(</span><span class="token variable">$crate</span><span class="token punctuation">::</span><span class="token namespace">vga_buffer<span class="token punctuation">::</span></span><span class="token function">_print</span><span class="token punctuation">(</span><span class="token macro property">format_args!</span><span class="token punctuation">(</span>$<span class="token punctuation">(</span><span class="token variable">$arg</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token attribute attr-name">#[macro_export]</span>
<span class="token macro property">macro_rules!</span> println <span class="token punctuation">{</span>
    <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">(</span><span class="token variable">$crate</span><span class="token punctuation">::</span><span class="token macro property">print!</span><span class="token punctuation">(</span><span class="token string">&quot;\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">(</span>$<span class="token punctuation">(</span><span class="token variable">$arg</span><span class="token punctuation">:</span><span class="token fragment-specifier punctuation">tt</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">(</span><span class="token variable">$crate</span><span class="token punctuation">::</span><span class="token macro property">print!</span><span class="token punctuation">(</span><span class="token string">&quot;{}\n&quot;</span><span class="token punctuation">,</span> <span class="token macro property">format_args!</span><span class="token punctuation">(</span>$<span class="token punctuation">(</span><span class="token variable">$arg</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token attribute attr-name">#[doc(hidden)]</span>
<span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">_print</span><span class="token punctuation">(</span>args<span class="token punctuation">:</span> <span class="token namespace">fmt<span class="token punctuation">::</span></span><span class="token class-name">Arguments</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">use</span> <span class="token namespace">core<span class="token punctuation">::</span>fmt<span class="token punctuation">::</span></span><span class="token class-name">Write</span><span class="token punctuation">;</span>
    <span class="token constant">WRITER</span><span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">write_fmt</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><p>一个对 <code>println!</code> 宏的改动是：在每个使用的 <code>print!</code> 宏前面添加了 <code>$crate</code> 变量。这样我们在只需要使用 <code>println!</code> 时，不必再导入 <code>print!</code> 宏。</p> <p>就像标准库做的那样，我们为两个宏都添加了 <code>#[macro_export]</code> 属性，使得包的其它地方也可以使用它们。需要注意的是，这将把这些宏置于包的根命名空间下，所以不能通过 <code>use crate::vga_buffer::println</code> 导入它们。我们只能使用 <code>use crate::println</code>。</p> <p><code>_print</code> 函数将锁定静态变量 <code>WRITER</code>，并调用它的 <code>write_fmt</code> 方法。这个方法源自名为 <code>Write</code> 的 trait，所以需要导入这个 trait。额外的 <code>unwrap()</code> 函数将在打印不成功的时候 panic。但既然我们的 <code>write_str</code> 总是返回 <code>Ok</code>，这种情况不应该发生。</p> <p>由于需要在模块外能够访问 <code>_print</code>，因此 <code>_print</code> 函数必须是公有的。然而，考虑到这是一个私有的实现细节，我们添加一个 <a href="https://doc.rust-lang.org/nightly/rustdoc/the-doc-attribute.html#dochidden" target="_blank" rel="noopener noreferrer"><code>doc(hidden)</code> 属性<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>，防止它出现在生成的文档中。</p> <h3 id="使用-println-的-hello-world"><a href="#使用-println-的-hello-world" class="header-anchor">#</a> 使用 <code>println!</code> 的 Hello World</h3> <p>我们现在可以在 <code>_start</code> 里使用 <code>println!</code> 了：</p> <div class="language-rust line-numbers-mode"><pre class="language-rust"><code><span class="token comment">// in src/main.rs</span>

<span class="token attribute attr-name">#[no_mangle]</span>
<span class="token keyword">pub</span> <span class="token keyword">extern</span> <span class="token string">&quot;C&quot;</span> <span class="token keyword">fn</span> <span class="token function-definition function">_start</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">&quot;Hello World{}&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;!&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">loop</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>要注意的是，因为 <code>println!</code> 已经被置于包的根命名空间，我们在入口函数中不需要再次导入它。</p> <p>如预期那样，一个 <em>“Hello World!”</em> 字符串被打印到了屏幕上：</p> <p><img src="data:image/png;base64,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ASENAAAFhDQAABQQ0gAAUEBIAwBAASENAAAFhDQAABQQ0gAAUEBIAwBAASENAAAFhDQAABQQ0gAAUEBIAwBAASENAAAFhDQAABQQ0gAAUEBIAwBAASENAAAFhDQAABQQ0gAAUEBIAwBAASENAAAFhDQAABQQ0gAAUEBIAwBAASENAAAFhDQAABQQ0gAAUEBIAwBAASENAAAFhDQAABQQ0gAAUEBIAwBAASENAAAFhDQAABQQ0gAAUEBIAwBAASENAAAFhDQAABQQ0gAAUEBIAwBAASENAAAFhDQAABQQ0gAAUEBIAwBAASENAAAFhDQAABQQ0gAAUEBIAwBAASENAAAFhDQAABQQ0gAAUEBIAwBAASENAAAFhDQAABQQ0gAAUEBIAwBAASENAAAFhDQAABQQ0gAAUEBIAwBAASENAAAFhDQAABQQ0gAAUEBIAwBAASENAAAFhDQAABQQ0gAAUEBIAwBAASENAAAFhDQAABQQ0gAAUEBIAwBAASENAAAFhDQAABQQ0gAAUEBIAwBAASENAAAFhDQAABQQ0gAAUEBIAwBAASENAAAFhDQAABQQ0gAAUEBIAwBAASENAAAFhDQAABQQ0gAAUEBIAwBAASENAAAFhDQAABQQ0gAAUEBIAwBAASENAAAFhDQAABQQ0gAAUEBIAwBAASENAAAFhDQAABQQ0gAAUEBIAwBAASENAAAFhDQAABQQ0gAAUEBIAwBAASENAAAFhDQAABQQ0gAAUEBIAwBAASENAAAFhDQAABQQ0gAAUEBIAwBAASENAAAFhDQAABQQ0gAAUEBIAwBAASENAAAFhDQAABQQ0gAAUEBIAwBAASENAAAFhDQAABQQ0gAAUEBIAwBAASENAAAFhDQAABQQ0gAAUEBIAwBAASENAAAFhDQAABQQ0gAAUEBIAwBAASENAAAFhDQAABQQ0gAAUEBIAwBAASENAAAFhDQAABQQ0gAAUEBIAwBAASENAAAFhDQAABQQ0gAAUEBIAwBAASENAAAFhDQAABQQ0gAAUEBIAwBAASENAAAFhDQAABQQ0gAAUEBIAwBAASENAAAFhDQAABQQ0gAAUEBIAwBAASENAAAFhDQAABQQ0gAAUEBIAwBAASENAAAFhDQAABQQ0gAAUEBIAwBAASENAAAFhDQAABQQ0gAAUEBIAwBAASENAAAFhDQAABQQ0gAAUEBIAwBAASENAAAFhDQAABQQ0gAAUEBIAwBAASENAAAF+knSdS9KklTV6za+carntmp93/vbfyvbnKnTvYczeW9bfc0HGn87n9HX6vMBAKDc1+SM9FbC76Eah1t9Xw+03ebQ3vw1AABfH0ztAACAAv3tbHyqM6Nf62kZXw+vtXmKxd/GlBRnmAEAzn4nnJHuuhdtPE62OSbXH5uf/9v09fZaJz93Jsez1XnPm7//UJ0GAwBwNjvhjPSpzsKe7Gw9m/q3deHemezv4kEAgIeObU3tSETgOp8DAMDD27ZD+mx0tq6AIdYBAL5+ndGqHaebT/314uR5xmfbvOOv988XAODhbMshvfkCu82Bd6og3coZ4PvbZjuvdaa28lrbOaO9nff1tbyIEgCAr63qja/7g+4FL3rJg30cAABw1njj6/7ADVkAAKCEkAYAgAJCGgAACghpAAAoIKQBAKCAkAYAgAJCGgAACghpAAAoIKQBAKCAkAYAgAJCGgAACghpAAAoIKQBAKCAkAYAgAJCGgAACghpAAAoIKQBAKCAkAYAgAJCGgAACvST5I2v+4MH+zgAAOCs8v8BDMPkGilSG0EAAAAASUVORK5CYII=" alt="QEMU 打印出 “Hello World!”"></p> <h3 id="打印-panic-信息"><a href="#打印-panic-信息" class="header-anchor">#</a> 打印 panic 信息</h3> <p>既然已经有了 <code>println!</code> 宏，我们可以在 panic 处理函数使用它打印 panic 信息和 panic 产生的位置：</p> <div class="language-rust line-numbers-mode"><pre class="language-rust"><code><span class="token comment">// in main.rs</span>

<span class="token comment">/// 这个函数将在 panic 发生时被调用</span>
<span class="token attribute attr-name">#[panic_handler]</span>
<span class="token keyword">fn</span> <span class="token function-definition function">panic</span><span class="token punctuation">(</span>info<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token class-name">PanicInfo</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token operator">!</span> <span class="token punctuation">{</span>
    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">&quot;{}&quot;</span><span class="token punctuation">,</span> info<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">loop</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>在 <code>_start</code> 函数中插入一行 <code>panic!(&quot;Some panic message&quot;);</code> 的话，可以得到以下输出：</p> <p><img src="data:image/png;base64,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BYQ0AAAUENIAAFBASAMAQAEhDQAABYQ0AAAUENIAAFBASAMAQAEhDQAABYQ0AAAUENIAAFBASAMAQAEhDQAABYQ0AAAUENIAAFBASAMAQAEhDQAABYQ0AAAUENIAAFBASAMAQAEhDQAABYQ0AAAUENIAAFBASAMAQAEhDQAABYQ0AAAUENIAAFBASAMAQAEhDQAABYQ0AAAUENIAAFBASAMAQAEhDQAABYQ0AAAUENIAAFBASAMAQAEhDQAABYQ0AAAUENIAAFBASAMAQAEhDQAABYQ0AAAUENIAAFBASAMAQAEhDQAABYQ0AAAUENIAAFBASAMAQAEhDQAABYQ0AAAUENIAAFBASAMAQAEhDQAABYQ0AAAUENIAAFBASAMAQAEhDQAABYQ0AAAUENIAAFBASAMAQAEhDQAABYQ0AAAUENIAAFBASAMAQAEhDQAABYQ0AAAUENIAAFBASAMAQAEhDQAABYQ0AAAUENIAAFBASAMAQAEhDQAABYQ0AAAUENIAAFBASAMAQAEhDQAABYQ0AAAUENIAAFBASAMAQAEhDQAABYQ0AAAUENIAAFBASAMAQAEhDQAABYQ0AAAUENIAAFBASAMAQAEhDQAABYQ0AAAUENIAAFBASAMAQAEhDQAABYQ0AAAUENIAAFBASAMAQAEhDQAABYQ0AAAUENIAAFBASAMAQAEhDQAABYQ0AAAUENIAAFBASAMAQAEhDQAABYQ0AAAUENIAAFBASAMAQAEhDQAABYQ0AAAUENIAAFBASAMAQAEhDQAABYQ0AAAUENIAAFBASAMAQAEhDQAABYQ0AAAUENIAAFBASAMAQAEhDQAABYQ0AAAUENIAAFBASAMAQAEhDQAABYQ0AAAUENIAAFBASAMAQAEhDQAABYQ0AAAUENIAAFBASAMAQAEhDQAABYQ0AAAUENIAAFBASAMAQAEhDQAABYQ0AAAUENIAAFBASAMAQAEhDQAABYQ0AAAUENIAAFBASAMAQAEhDQAABYQ0AAAUENIAAFBASAMAQAEhDQAABYQ0AAAUENIAAFBASAMAQAEhDQAABYQ0AAAUENIAAFBASAMAQAEhDQAABYQ0AAAUENIAAFBASAMAQAEhDQAABYQ0AAAUENIAAFBASAMAQAEhDQAABbpJ0rYvTZJU1e0rF6z1vXEtb3u67ce5zpla7z6cyX0b9zY3Gn8zx+hcHR8AAMqdkzPS44TfQzUOx71fG11vdWiv/jUAABcGUzsAAKBAdzNXXuvM6LmelnEh3NbqKRZnY0qKM8wAAFvfCWek2/alK18nWx2Ty1+rv382XWi3dfL3zmR/xp33vPryh+o0GACAreyEM9JrnYU92VY9m3q23rh3Jtt78yAAwEPHpqZ2JCJwmeMAAPDwtumQ3oq26goYYh0A4MJ1Rqt2rDef+kJx8jzjrTbv+EI/vgAAD2djh/TqN9itDry1gnScM8Cnu85mbutMjXNbmzmjvZn7dS7fRAkAwLlV3XH7G9oXv/Tl53s/AABgy7jj9jf4QBYAACghpAEAoICQBgCAAkIaAAAKCOktzPJ4bBWeqwA8FJ3XD2Q5k2XtVv9QPlvL4p2LMU93Ww/GbZxsK6yf/WDz0e1sFQ+15+o4r1Fn43XsdH+Je6gcS+D82LKfbFhVt5/1M1znYsy1PJi3cfJ62A9GwANsZJzXqLP9Oua1DzjbzmtIe1Er91A7M3U+OYbn1sPpuXqu/6K6FY/heo//ubgvD6fnGnBh6CYnvvicbnrDep/Ud/LlG41z8lgbXX666613+5sd52ycJR73+Jz8+3NxZmX5MVj9g73kOK/1OJ3JcT6dh8rzcJzbKD2G5+o64xyb0n1+MKNm3OfzZp9ja11no9sufdzXu51x9nec5/zpnMvjs5nbBtgqVj7Z8OQXsY1e1Na7fDPjjDvGON8r2WbccUqU3O9zYdwfvut9b6O/YGzm2G9mf7fS83AjZ+sYnq3rrLd/Z2Pc8xlDm93H5e+f62O4npLXhs08j8/0z+Dytmfj+Ix7mw/GX2bPZByA1e64/Q2bm9rxYMztXc/pXvDG/eFTsu1mnM/js57VP/zO5J+dT/6ButZ9fbDu/4X6PBxn2zM5huP8K8OZ/EtEqQvleT/ufV99/c2MvZ6NXkM2etwvlON3so3uz7jHeSOb/UtuyWvZemOfyWsiQLKJOdKbPVN5IXkwz/xeqMdnrR9+5+I2zrUL/TifqY2O4erHcb3rb3Sds30ML6QQGef4rLVNqbN9JvZCfD6XPMfGZToHsNU9JNaRvpB/CJ0vq3/I8dBSVbdv+Jwf5zoXorPxvH2w7vvDPQLHPc7rPabn4vh53QMebFsmpDd6gRz3B+eF9kJ7oe3P2eJ+nf3bOvn3az3nx7nOuXQ+H/dzed/XeixW38ZWcyaP04N5nM+Wh+rrEXD+nfJmwxMuXOefhJcvG+dNJxv98/I4t7XWdU73Qr7RG35K7tc4NjPOWvt/tm32vq91nbXmdp7uDUinu61zsc/n+3k4jrN5DM/FdTY6hmd6W5txtqYKrLc/Gz3emxlno30sedxP97ox7nN1o+f86S47W8dnHOOcGDlbt3U2xwFYdsftb1h/1Q44HzwPL0wPxuPisQdgK9n0qh3Aw8P5iFoBDcBWUyenzrGKkE22AAAAiElEQVSE88Hz8MKxenqAM8UAsLZu4gckFwbPwwuLxwMATm/LrNoBAAAXEiENAAAFhDQAABQQ0gAAUEBIAwBAASENAAAFhDQAABQQ0gAAUEBIAwBAASENAAAFhDQAABQQ0gAAUEBIAwBAASENAAAFhDQAABQQ0gAAUKCbJHfc/obzvR8AALCl/H9fUJOYoyJFugAAAABJRU5ErkJggg==" alt="QEMU 显示 “panicked at 'Some panic message', src/main.rs:28:5"></p> <p>所以，现在我们不仅能知道 panic 已经发生，还能够知道 panic 信息和产生 panic 的位置。</p> <h2 id="总结"><a href="#总结" class="header-anchor">#</a> 总结</h2> <p>通过这篇文章，我们学习了 VGA 文本缓冲区的结构，以及如何借助 <code>0xb8000</code> 的内存映射地址访问它。我们将所有写入这个内存映射缓冲区的不安全操作封装为一个 Rust 模块，为外界访问提供了安全和便利的接口。</p> <p>可以看到，cargo 极大地便利了添加第三方依赖包的流程。我们添加的<code>lazy_static</code> 和 <code>spin</code> 两个依赖项对操作系统开发非常有用，未来的文章将多次使用它们。</p> <h2 id="下篇预告"><a href="#下篇预告" class="header-anchor">#</a> 下篇预告</h2> <p>下一篇文章将会讲述如何配置 Rust 内置的单元测试框架。我们还将为本文编写的 VGA 缓冲区模块添加基础的单元测试项目。</p></div></section> <footer class="page-edit"><!----> <!----></footer> <!----> <div class="comments-wrapper"><!----></div></main></div> <!----></div> <ul class="sub-sidebar sub-sidebar-wrapper" style="width:12rem;" data-v-b57cc07c data-v-7dd95ae2><li class="level-2" data-v-b57cc07c><a href="/blog-os/blog-os-03-vga-text-mode/#vga-文本缓冲区" class="sidebar-link reco-side-vga-文本缓冲区" data-v-b57cc07c>VGA 文本缓冲区</a></li><li class="level-2" data-v-b57cc07c><a href="/blog-os/blog-os-03-vga-text-mode/#包装到-rust-模块" class="sidebar-link reco-side-包装到-rust-模块" data-v-b57cc07c>包装到 Rust 模块</a></li><li class="level-3" data-v-b57cc07c><a href="/blog-os/blog-os-03-vga-text-mode/#颜色" class="sidebar-link reco-side-颜色" data-v-b57cc07c>颜色</a></li><li class="level-3" data-v-b57cc07c><a href="/blog-os/blog-os-03-vga-text-mode/#文本缓冲区" class="sidebar-link reco-side-文本缓冲区" data-v-b57cc07c>文本缓冲区</a></li><li class="level-3" data-v-b57cc07c><a href="/blog-os/blog-os-03-vga-text-mode/#打印" class="sidebar-link reco-side-打印" data-v-b57cc07c>打印</a></li><li class="level-3" data-v-b57cc07c><a href="/blog-os/blog-os-03-vga-text-mode/#易失操作" class="sidebar-link reco-side-易失操作" data-v-b57cc07c>易失操作</a></li><li class="level-3" data-v-b57cc07c><a href="/blog-os/blog-os-03-vga-text-mode/#格式化宏" class="sidebar-link reco-side-格式化宏" data-v-b57cc07c>格式化宏</a></li><li class="level-3" data-v-b57cc07c><a href="/blog-os/blog-os-03-vga-text-mode/#换行" class="sidebar-link reco-side-换行" data-v-b57cc07c>换行</a></li><li class="level-2" data-v-b57cc07c><a href="/blog-os/blog-os-03-vga-text-mode/#全局接口" class="sidebar-link reco-side-全局接口" data-v-b57cc07c>全局接口</a></li><li class="level-3" data-v-b57cc07c><a href="/blog-os/blog-os-03-vga-text-mode/#延迟初始化" class="sidebar-link reco-side-延迟初始化" data-v-b57cc07c>延迟初始化</a></li><li class="level-3" data-v-b57cc07c><a href="/blog-os/blog-os-03-vga-text-mode/#自旋锁" class="sidebar-link reco-side-自旋锁" data-v-b57cc07c>自旋锁</a></li><li class="level-3" data-v-b57cc07c><a href="/blog-os/blog-os-03-vga-text-mode/#安全性" class="sidebar-link reco-side-安全性" data-v-b57cc07c>安全性</a></li><li class="level-3" data-v-b57cc07c><a href="/blog-os/blog-os-03-vga-text-mode/#println-宏" class="sidebar-link reco-side-println-宏" data-v-b57cc07c>println! 宏</a></li><li class="level-3" data-v-b57cc07c><a href="/blog-os/blog-os-03-vga-text-mode/#使用-println-的-hello-world" class="sidebar-link reco-side-使用-println-的-hello-world" data-v-b57cc07c>使用 println! 的 Hello World</a></li><li class="level-3" data-v-b57cc07c><a href="/blog-os/blog-os-03-vga-text-mode/#打印-panic-信息" class="sidebar-link reco-side-打印-panic-信息" data-v-b57cc07c>打印 panic 信息</a></li><li class="level-2" data-v-b57cc07c><a href="/blog-os/blog-os-03-vga-text-mode/#总结" class="sidebar-link reco-side-总结" data-v-b57cc07c>总结</a></li><li class="level-2" data-v-b57cc07c><a href="/blog-os/blog-os-03-vga-text-mode/#下篇预告" class="sidebar-link reco-side-下篇预告" data-v-b57cc07c>下篇预告</a></li></ul></div></div></div><div class="global-ui"><div class="back-to-ceiling" style="right:1rem;bottom:6rem;width:2.5rem;height:2.5rem;border-radius:.25rem;line-height:2.5rem;display:none;" data-v-c6073ba8 data-v-c6073ba8><svg t="1574745035067" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="5404" class="icon" data-v-c6073ba8><path d="M526.60727968 10.90185116a27.675 27.675 0 0 0-29.21455937 0c-131.36607665 82.28402758-218.69155461 228.01873535-218.69155402 394.07834331a462.20625001 462.20625001 0 0 0 5.36959153 69.94390903c1.00431239 6.55289093-0.34802892 13.13561351-3.76865779 18.80351572-32.63518765 54.11355614-51.75690182 118.55860487-51.7569018 187.94566865a371.06718723 371.06718723 0 0 0 11.50484808 91.98906777c6.53300375 25.50556257 41.68394495 28.14064038 52.69160883 4.22606766 17.37162448-37.73630017 42.14135425-72.50938081 72.80769204-103.21549295 2.18761121 3.04276886 4.15646224 6.24463696 6.40373557 9.22774369a1871.4375 1871.4375 0 0 0 140.04691725 5.34970492 1866.36093723 1866.36093723 0 0 0 140.04691723-5.34970492c2.24727335-2.98310674 4.21612437-6.18497483 6.3937923-9.2178004 30.66633723 30.70611158 55.4360664 65.4791928 72.80769147 103.21549355 11.00766384 23.91457269 46.15860503 21.27949489 52.69160879-4.22606768a371.15156223 371.15156223 0 0 0 11.514792-91.99901164c0-69.36717486-19.13165746-133.82216804-51.75690182-187.92578088-3.42062944-5.66790279-4.76302748-12.26056868-3.76865837-18.80351632a462.20625001 462.20625001 0 0 0 5.36959269-69.943909c-0.00994388-166.08943902-87.32547796-311.81420293-218.6915546-394.09823051zM605.93803103 357.87693858a93.93749974 93.93749974 0 1 1-187.89594924 6.1e-7 93.93749974 93.93749974 0 0 1 187.89594924-6.1e-7z" p-id="5405" data-v-c6073ba8></path><path d="M429.50777625 765.63860547C429.50777625 803.39355007 466.44236686 1000.39046097 512.00932183 1000.39046097c45.56695499 0 82.4922232-197.00623328 82.5015456-234.7518555 0-37.75494459-36.9345906-68.35043303-82.4922232-68.34111062-45.57627738-0.00932239-82.52019037 30.59548842-82.51086798 68.34111062z" p-id="5406" data-v-c6073ba8></path></svg></div></div></div>
    <script src="/assets/js/app.595d3845.js" defer></script><script src="/assets/js/3.944fac0d.js" defer></script><script src="/assets/js/1.c30a1333.js" defer></script><script src="/assets/js/32.5d223b08.js" defer></script>
  </body>
</html>
