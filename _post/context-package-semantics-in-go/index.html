<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Go 的 Context 包使用规则 | sammyne</title>
    <meta name="generator" content="VuePress 1.8.1">
    <link rel="icon" href="/favicon.ico">
    <meta name="description" content="Just playing around :)">
    <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no">
    
    <link rel="preload" href="/assets/css/0.styles.a1b76618.css" as="style"><link rel="preload" href="/assets/js/app.460084d6.js" as="script"><link rel="preload" href="/assets/js/3.df7e20a8.js" as="script"><link rel="preload" href="/assets/js/1.7ac9a612.js" as="script"><link rel="preload" href="/assets/js/65.18257448.js" as="script"><link rel="prefetch" href="/assets/js/10.af14b39e.js"><link rel="prefetch" href="/assets/js/11.99ba64c8.js"><link rel="prefetch" href="/assets/js/12.34332094.js"><link rel="prefetch" href="/assets/js/13.1704bbed.js"><link rel="prefetch" href="/assets/js/14.11859fd4.js"><link rel="prefetch" href="/assets/js/15.d43300c2.js"><link rel="prefetch" href="/assets/js/16.3249b7d3.js"><link rel="prefetch" href="/assets/js/17.a01809f8.js"><link rel="prefetch" href="/assets/js/18.1dfec45f.js"><link rel="prefetch" href="/assets/js/19.f412f4f3.js"><link rel="prefetch" href="/assets/js/20.55e15a5f.js"><link rel="prefetch" href="/assets/js/21.c69cd7e0.js"><link rel="prefetch" href="/assets/js/22.cbffd43e.js"><link rel="prefetch" href="/assets/js/23.8b16fdf0.js"><link rel="prefetch" href="/assets/js/24.201c83d8.js"><link rel="prefetch" href="/assets/js/25.b41a1a47.js"><link rel="prefetch" href="/assets/js/26.0ed3e66c.js"><link rel="prefetch" href="/assets/js/27.7efc701f.js"><link rel="prefetch" href="/assets/js/28.72e1cd8a.js"><link rel="prefetch" href="/assets/js/29.0dced9b2.js"><link rel="prefetch" href="/assets/js/30.ab09489f.js"><link rel="prefetch" href="/assets/js/31.8c87f1ae.js"><link rel="prefetch" href="/assets/js/32.9007a3fd.js"><link rel="prefetch" href="/assets/js/33.f5646ecf.js"><link rel="prefetch" href="/assets/js/34.30466f73.js"><link rel="prefetch" href="/assets/js/35.5f43a455.js"><link rel="prefetch" href="/assets/js/36.605c0762.js"><link rel="prefetch" href="/assets/js/37.49a6b29b.js"><link rel="prefetch" href="/assets/js/38.9c0ceed6.js"><link rel="prefetch" href="/assets/js/39.833e25b8.js"><link rel="prefetch" href="/assets/js/4.33345026.js"><link rel="prefetch" href="/assets/js/40.62164fd4.js"><link rel="prefetch" href="/assets/js/41.6780bccd.js"><link rel="prefetch" href="/assets/js/42.a299958f.js"><link rel="prefetch" href="/assets/js/43.d7eb41dd.js"><link rel="prefetch" href="/assets/js/44.d2732739.js"><link rel="prefetch" href="/assets/js/45.26690fbb.js"><link rel="prefetch" href="/assets/js/46.9bafaf20.js"><link rel="prefetch" href="/assets/js/47.a788ae84.js"><link rel="prefetch" href="/assets/js/48.53199aae.js"><link rel="prefetch" href="/assets/js/49.93080943.js"><link rel="prefetch" href="/assets/js/5.da215b11.js"><link rel="prefetch" href="/assets/js/50.e2b156f3.js"><link rel="prefetch" href="/assets/js/51.7ca05ae4.js"><link rel="prefetch" href="/assets/js/52.8459aac5.js"><link rel="prefetch" href="/assets/js/53.7d8293f9.js"><link rel="prefetch" href="/assets/js/54.0e93b6fe.js"><link rel="prefetch" href="/assets/js/55.46fc1714.js"><link rel="prefetch" href="/assets/js/56.c8f25f54.js"><link rel="prefetch" href="/assets/js/57.cd09ca2f.js"><link rel="prefetch" href="/assets/js/58.810d1d6b.js"><link rel="prefetch" href="/assets/js/59.5e1237fd.js"><link rel="prefetch" href="/assets/js/6.0f93370d.js"><link rel="prefetch" href="/assets/js/60.4176824e.js"><link rel="prefetch" href="/assets/js/61.a7fe6954.js"><link rel="prefetch" href="/assets/js/62.7f7e45b1.js"><link rel="prefetch" href="/assets/js/63.ed2ba3d1.js"><link rel="prefetch" href="/assets/js/64.752309f8.js"><link rel="prefetch" href="/assets/js/66.47af013f.js"><link rel="prefetch" href="/assets/js/67.79be0219.js"><link rel="prefetch" href="/assets/js/68.1a70d0ba.js"><link rel="prefetch" href="/assets/js/69.899d158c.js"><link rel="prefetch" href="/assets/js/7.505b693a.js"><link rel="prefetch" href="/assets/js/70.a3db0124.js"><link rel="prefetch" href="/assets/js/71.7911f9d8.js"><link rel="prefetch" href="/assets/js/72.ca1b110f.js"><link rel="prefetch" href="/assets/js/73.78e18e89.js"><link rel="prefetch" href="/assets/js/74.5ff67c9e.js"><link rel="prefetch" href="/assets/js/75.aef53f06.js"><link rel="prefetch" href="/assets/js/76.e5510aea.js"><link rel="prefetch" href="/assets/js/77.abf8082a.js"><link rel="prefetch" href="/assets/js/78.a514a13d.js"><link rel="prefetch" href="/assets/js/79.c6fa750e.js"><link rel="prefetch" href="/assets/js/8.a4375844.js"><link rel="prefetch" href="/assets/js/80.9a33cbfe.js"><link rel="prefetch" href="/assets/js/81.c11dd67c.js"><link rel="prefetch" href="/assets/js/82.8648179e.js"><link rel="prefetch" href="/assets/js/83.2085ad68.js"><link rel="prefetch" href="/assets/js/84.a3c855af.js"><link rel="prefetch" href="/assets/js/85.2be7c107.js"><link rel="prefetch" href="/assets/js/86.ae61a023.js"><link rel="prefetch" href="/assets/js/87.da256952.js"><link rel="prefetch" href="/assets/js/88.63158169.js"><link rel="prefetch" href="/assets/js/89.cd89167a.js"><link rel="prefetch" href="/assets/js/9.acef0cc1.js"><link rel="prefetch" href="/assets/js/90.44315479.js"><link rel="prefetch" href="/assets/js/91.942e3147.js"><link rel="prefetch" href="/assets/js/92.5e611347.js">
    <link rel="stylesheet" href="/assets/css/0.styles.a1b76618.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container no-sidebar" data-v-1156296a><div data-v-1156296a><div id="loader-wrapper" class="loading-wrapper" data-v-d48f4d20 data-v-1156296a data-v-1156296a><div class="loader-main" data-v-d48f4d20><div data-v-d48f4d20></div><div data-v-d48f4d20></div><div data-v-d48f4d20></div><div data-v-d48f4d20></div></div> <!----> <!----></div> <div class="password-shadow password-wrapper-out" style="display:none;" data-v-4e82dffc data-v-1156296a data-v-1156296a><h3 class="title" data-v-4e82dffc data-v-4e82dffc>sammyne</h3> <p class="description" data-v-4e82dffc data-v-4e82dffc>Just playing around :)</p> <label id="box" class="inputBox" data-v-4e82dffc data-v-4e82dffc><input type="password" value="" data-v-4e82dffc> <span data-v-4e82dffc>Konck! Knock!</span> <button data-v-4e82dffc>OK</button></label> <div class="footer" data-v-4e82dffc data-v-4e82dffc><span data-v-4e82dffc><i class="iconfont reco-theme" data-v-4e82dffc></i> <a target="blank" href="https://vuepress-theme-reco.recoluan.com" data-v-4e82dffc>vuePress-theme-reco</a></span> <span data-v-4e82dffc><i class="iconfont reco-copyright" data-v-4e82dffc></i> <a data-v-4e82dffc><span data-v-4e82dffc>sammyne</span>
            
          <span data-v-4e82dffc>2020 - </span>
          2021
        </a></span></div></div> <div class="hide" data-v-1156296a><header class="navbar" data-v-1156296a><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/logo.svg" alt="sammyne" class="logo"> <span class="site-name">sammyne</span></a> <div class="links"><div class="color-picker"><a class="color-button"><i class="iconfont reco-color"></i></a> <div class="color-picker-menu" style="display:none;"><div class="mode-options"><h4 class="title">Choose mode</h4> <ul class="color-mode-options"><li class="dark">dark</li><li class="auto active">auto</li><li class="light">light</li></ul></div></div></div> <div class="search-box"><i class="iconfont reco-search"></i> <input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link"><i class="iconfont reco-home"></i>
  首页
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-category"></i>
      分类
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/categories/dev/" class="nav-link"><i class="undefined"></i>
  dev
</a></li><li class="dropdown-item"><!----> <a href="/categories/crypto/" class="nav-link"><i class="undefined"></i>
  crypto
</a></li><li class="dropdown-item"><!----> <a href="/categories/programming/" class="nav-link"><i class="undefined"></i>
  programming
</a></li><li class="dropdown-item"><!----> <a href="/categories/tee/" class="nav-link"><i class="undefined"></i>
  tee
</a></li><li class="dropdown-item"><!----> <a href="/categories/os/" class="nav-link"><i class="undefined"></i>
  os
</a></li><li class="dropdown-item"><!----> <a href="/categories/engineering/" class="nav-link"><i class="undefined"></i>
  engineering
</a></li><li class="dropdown-item"><!----> <a href="/categories/tool/" class="nav-link"><i class="undefined"></i>
  tool
</a></li><li class="dropdown-item"><!----> <a href="/categories/language/" class="nav-link"><i class="undefined"></i>
  language
</a></li><li class="dropdown-item"><!----> <a href="/categories/decentralization/" class="nav-link"><i class="undefined"></i>
  decentralization
</a></li><li class="dropdown-item"><!----> <a href="/categories/architecture/" class="nav-link"><i class="undefined"></i>
  architecture
</a></li><li class="dropdown-item"><!----> <a href="/categories/network/" class="nav-link"><i class="undefined"></i>
  network
</a></li><li class="dropdown-item"><!----> <a href="/categories/software engineering/" class="nav-link"><i class="undefined"></i>
  software engineering
</a></li><li class="dropdown-item"><!----> <a href="/categories/notes/" class="nav-link"><i class="undefined"></i>
  notes
</a></li></ul></div></div><div class="nav-item"><a href="/tag/" class="nav-link"><i class="iconfont reco-tag"></i>
  标签
</a></div><div class="nav-item"><a href="/timeline/" class="nav-link"><i class="iconfont reco-date"></i>
  时间轴
</a></div><div class="nav-item"><a href="https://github.com/sammyne" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="iconfont reco-github"></i>
  Github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav></div></header> <div class="sidebar-mask" data-v-1156296a></div> <aside class="sidebar" data-v-1156296a><div class="personal-info-wrapper" data-v-828910c6 data-v-1156296a><img src="/avatar.png" alt="author-avatar" class="personal-img" data-v-828910c6> <h3 class="name" data-v-828910c6>
    sammyne
  </h3> <div class="num" data-v-828910c6><div data-v-828910c6><h3 data-v-828910c6>82</h3> <h6 data-v-828910c6>Articles</h6></div> <div data-v-828910c6><h3 data-v-828910c6>43</h3> <h6 data-v-828910c6>Tags</h6></div></div> <ul class="social-links" data-v-828910c6></ul> <hr data-v-828910c6></div> <nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link"><i class="iconfont reco-home"></i>
  首页
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-category"></i>
      分类
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/categories/dev/" class="nav-link"><i class="undefined"></i>
  dev
</a></li><li class="dropdown-item"><!----> <a href="/categories/crypto/" class="nav-link"><i class="undefined"></i>
  crypto
</a></li><li class="dropdown-item"><!----> <a href="/categories/programming/" class="nav-link"><i class="undefined"></i>
  programming
</a></li><li class="dropdown-item"><!----> <a href="/categories/tee/" class="nav-link"><i class="undefined"></i>
  tee
</a></li><li class="dropdown-item"><!----> <a href="/categories/os/" class="nav-link"><i class="undefined"></i>
  os
</a></li><li class="dropdown-item"><!----> <a href="/categories/engineering/" class="nav-link"><i class="undefined"></i>
  engineering
</a></li><li class="dropdown-item"><!----> <a href="/categories/tool/" class="nav-link"><i class="undefined"></i>
  tool
</a></li><li class="dropdown-item"><!----> <a href="/categories/language/" class="nav-link"><i class="undefined"></i>
  language
</a></li><li class="dropdown-item"><!----> <a href="/categories/decentralization/" class="nav-link"><i class="undefined"></i>
  decentralization
</a></li><li class="dropdown-item"><!----> <a href="/categories/architecture/" class="nav-link"><i class="undefined"></i>
  architecture
</a></li><li class="dropdown-item"><!----> <a href="/categories/network/" class="nav-link"><i class="undefined"></i>
  network
</a></li><li class="dropdown-item"><!----> <a href="/categories/software engineering/" class="nav-link"><i class="undefined"></i>
  software engineering
</a></li><li class="dropdown-item"><!----> <a href="/categories/notes/" class="nav-link"><i class="undefined"></i>
  notes
</a></li></ul></div></div><div class="nav-item"><a href="/tag/" class="nav-link"><i class="iconfont reco-tag"></i>
  标签
</a></div><div class="nav-item"><a href="/timeline/" class="nav-link"><i class="iconfont reco-date"></i>
  时间轴
</a></div><div class="nav-item"><a href="https://github.com/sammyne" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="iconfont reco-github"></i>
  Github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav> <!----> </aside> <div class="password-shadow password-wrapper-in" style="display:none;" data-v-4e82dffc data-v-1156296a><h3 class="title" data-v-4e82dffc data-v-4e82dffc>Go 的 Context 包使用规则</h3> <!----> <label id="box" class="inputBox" data-v-4e82dffc data-v-4e82dffc><input type="password" value="" data-v-4e82dffc> <span data-v-4e82dffc>Konck! Knock!</span> <button data-v-4e82dffc>OK</button></label> <div class="footer" data-v-4e82dffc data-v-4e82dffc><span data-v-4e82dffc><i class="iconfont reco-theme" data-v-4e82dffc></i> <a target="blank" href="https://vuepress-theme-reco.recoluan.com" data-v-4e82dffc>vuePress-theme-reco</a></span> <span data-v-4e82dffc><i class="iconfont reco-copyright" data-v-4e82dffc></i> <a data-v-4e82dffc><span data-v-4e82dffc>sammyne</span>
            
          <span data-v-4e82dffc>2020 - </span>
          2021
        </a></span></div></div> <div data-v-1156296a><main class="page"><section><div class="page-title"><h1 class="title">Go 的 Context 包使用规则</h1> <div data-v-1ff7123e><i class="iconfont reco-account" data-v-1ff7123e><span data-v-1ff7123e>sammyne</span></i> <i class="iconfont reco-date" data-v-1ff7123e><span data-v-1ff7123e>10/26/2019</span></i> <i class="iconfont reco-eye" data-v-1ff7123e><span id="/_post/context-package-semantics-in-go/" data-flag-title="Your Article Title" class="leancloud-visitors" data-v-1ff7123e><a class="leancloud-visitors-count" style="font-size:.9rem;font-weight:normal;color:#999;"></a></span></i> <i class="tags iconfont reco-tag" data-v-1ff7123e><span class="tag-item" data-v-1ff7123e>golang</span></i></div></div> <div class="theme-reco-content content__default"><blockquote><p>原文：<a href="https://www.ardanlabs.com/blog/2019/09/context-package-semantics-in-go.html" target="_blank" rel="noopener noreferrer">Context Package Semantics In Go<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p></blockquote> <h2 id="引言"><a href="#引言" class="header-anchor">#</a> 引言</h2> <p>Go 语言内置的 <code>go</code> 关键字可用于创建协程，但是并没有提供关键字或直接支持关闭协程。现实世界的服务程序中，超时退出协程的能力对维护服务的健康和操作至关重要。没有任何能够永远执行的请求或任务，这也就使得辨别和管理延时成为了每个程序员的责任。</p> <p>Go 开发团队为此问题提供的解决方案是 <code>context</code> 包。这个包由 <a href="https://twitter.com/Sajma" target="_blank" rel="noopener noreferrer">Sameer Ajmani<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 编写，并在 2014 年 Gotham 的 Go 大会发布出来。他也为 Go 的博客写了一篇文章。</p> <ul><li>演讲视频：<a href="https://vimeo.com/115309491" target="_blank" rel="noopener noreferrer">https://vimeo.com/115309491<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li>Slide Deck：<a href="https://talks.golang.org/2014/gotham-context.slide#1" target="_blank" rel="noopener noreferrer">https://talks.golang.org/2014/gotham-context.slide#1<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li>博客文章：<a href="https://blog.golang.org/context" target="_blank" rel="noopener noreferrer">https://blog.golang.org/context<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul> <p>上述资料发布以及个人和 Sameer 多年来的谈话之后，很多语义都有所演进。本篇博文将会阐述这些语义并尽量用代码来演示给你看。</p> <h2 id="服务器从外部收到的请求应该创建一个-context"><a href="#服务器从外部收到的请求应该创建一个-context" class="header-anchor">#</a> 服务器从外部收到的请求应该创建一个 <code>Context</code></h2> <p>创建 <code>Context</code> 的时机永远都是在处理请求或任务的尽可能早的时候。开发周期中，早期引入 <code>Context</code> 会强制你在设计 API 时把 <code>Context</code> 作为第一个参数。即使你无法 100% 确定函数是否需要 <code>Context</code> ，从少数函数移除 <code>Context</code> 要比添加来得容易。</p> <p>代码片段 1<br> <a href="https://github.com/ardanlabs/service/blob/master/internal/platform/web/web.go#L75" target="_blank" rel="noopener noreferrer">https://github.com/ardanlabs/service/blob/master/internal/platform/web/web.go#L75<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <div class="language-go line-numbers-mode"><div class="highlight-lines"><br><br><br><br><br><div class="highlighted"> </div><div class="highlighted"> </div><br><br><br><br><div class="highlighted"> </div><br><br></div><pre class="language-go"><code><span class="token comment">// Handle is our mechanism for mounting Handlers for a given HTTP verb and path</span>
<span class="token comment">// pair, this makes for really easy, convenient routing.</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>a <span class="token operator">*</span>App<span class="token punctuation">)</span> <span class="token function">Handle</span><span class="token punctuation">(</span>verb<span class="token punctuation">,</span> path <span class="token builtin">string</span><span class="token punctuation">,</span> handler Handler<span class="token punctuation">,</span> mw <span class="token operator">...</span>Middleware<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// ...</span>
    <span class="token comment">// The function to execute for each request.</span>
    h <span class="token operator">:=</span> <span class="token keyword">func</span><span class="token punctuation">(</span>w http<span class="token punctuation">.</span>ResponseWriter<span class="token punctuation">,</span> r <span class="token operator">*</span>http<span class="token punctuation">.</span>Request<span class="token punctuation">,</span> params <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        ctx<span class="token punctuation">,</span> span <span class="token operator">:=</span> trace<span class="token punctuation">.</span><span class="token function">StartSpan</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span><span class="token function">Context</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;internal.platform.web&quot;</span><span class="token punctuation">)</span>
        <span class="token keyword">defer</span> span<span class="token punctuation">.</span><span class="token function">End</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token comment">// ...</span>

    <span class="token comment">// Add this handler for the specified verb and route.</span>
    a<span class="token punctuation">.</span>TreeMux<span class="token punctuation">.</span><span class="token function">Handle</span><span class="token punctuation">(</span>verb<span class="token punctuation">,</span> path<span class="token punctuation">,</span> h<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><p>代码片段 1 展示的代码源自我们在 Ardan Labs 培训时用的 <a href="https://github.com/ardanlabs/service" target="_blank" rel="noopener noreferrer">service<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 项目。第 6 行定义了一个 handler 函数，这个函数在第 12 行绑定到所有路由。所有进来的请求都是先由这个函数处理的。第 7 行为请求创建了一个 <a href="https://opencensus.io/" target="_blank" rel="noopener noreferrer"><code>span</code><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>，第一个参数是一个<code>Context</code>。这是 service 源码里面第一次需要用到 <code>Context</code> 的地方。</p> <p>最完美的是 <code>http.Request</code> 已经包含了一个 <code>Context</code>。这是在 Go 1.7 <a href="https://golang.org/doc/go1.7#context" target="_blank" rel="noopener noreferrer">引入<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 的。这也就意味着代码不需要手动地创建一个顶层的 <code>Context</code>。如果使用的是 Go 1.7 之前的版本（这里原文应该有误），我们就要在调用 <code>StartSpan</code> 函数之前通过 <code>context.Background()</code> 函数创建一个空的 <code>Context</code>。</p> <p>代码片段 2<br> <a href="https://golang.org/pkg/context/#Background" target="_blank" rel="noopener noreferrer">https://golang.org/pkg/context/#Background<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <div class="language-go line-numbers-mode"><pre class="language-go"><code>ctx <span class="token operator">:=</span> context<span class="token punctuation">.</span><span class="token function">Background</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
ctx<span class="token punctuation">,</span> span <span class="token operator">:=</span> trace<span class="token punctuation">.</span><span class="token function">StartSpan</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> <span class="token string">&quot;internal.platform.web&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">defer</span> span<span class="token punctuation">.</span><span class="token function">End</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>代码片段 2 展示了 Go 1.7 之前的代码实现方式。这个包的文档说明是这样的，</p> <blockquote><p><code>Background</code>返回一个非 <code>nil</code>的空 <code>Context</code>。它绝不会被取消，无法携带任何值，并且没有截止日期。它通常用于 <code>main</code> 函数、初始化或测试，并且作为所接收到请求最顶层的 <code>Context</code>。</p></blockquote> <p>Go 的习惯用法是把所有 <code>Context</code> 值命名为 <code>ctx</code>。因为 <code>Context</code> 是一个接口，所以我们不应该使用它的指针。</p> <p>代码片段 3<br> <a href="https://golang.org/pkg/context/#Context" target="_blank" rel="noopener noreferrer">https://golang.org/pkg/context/#Context<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">type</span> Context <span class="token keyword">interface</span> <span class="token punctuation">{</span>
    <span class="token function">Deadline</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>deadline time<span class="token punctuation">.</span>Time<span class="token punctuation">,</span> ok <span class="token builtin">bool</span><span class="token punctuation">)</span>
    <span class="token function">Done</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;-</span><span class="token keyword">chan</span> <span class="token keyword">struct</span><span class="token punctuation">{</span><span class="token punctuation">}</span>
    <span class="token function">Err</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">error</span>
    <span class="token function">Value</span><span class="token punctuation">(</span>key <span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>每个接受 <code>Context</code> 的函数都会得到接口值的一个副本。</p> <h2 id="对服务器的调用应该接受一个-context"><a href="#对服务器的调用应该接受一个-context" class="header-anchor">#</a> 对服务器的调用应该接受一个 <code>Context</code></h2> <p>这项语义的初衷是使得顶层调用可以告知下层调用它们愿意等待的时长。一个很好的例子是 <code>http</code> 包里，1.7 版对 <code>Do</code> 方法的改动用于尊重请求的超时。</p> <p>代码片段 4<br> <a href="https://play.golang.org/p/9x4kBKO-Y6q" target="_blank" rel="noopener noreferrer">https://play.golang.org/p/9x4kBKO-Y6q<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <div class="language-go line-numbers-mode"><div class="highlight-lines"><br><br><br><br><br><br><br><br><br><br><br><br><br><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><br><br><div class="highlighted"> </div><div class="highlighted"> </div><br><br><br><br><br><br><br><br><br><br><br><br><div class="highlighted"> </div><br><br><br><br><br><br></div><pre class="language-go"><code><span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">&quot;context&quot;</span>
	<span class="token string">&quot;io&quot;</span>
	<span class="token string">&quot;log&quot;</span>
	<span class="token string">&quot;net/http&quot;</span>
	<span class="token string">&quot;os&quot;</span>
	<span class="token string">&quot;time&quot;</span>
<span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token comment">// Create a new request.</span>
	req<span class="token punctuation">,</span> err <span class="token operator">:=</span> http<span class="token punctuation">.</span><span class="token function">NewRequest</span><span class="token punctuation">(</span><span class="token string">&quot;GET&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;https://www.ardanlabs.com/blog/post/index.xml&quot;</span><span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		log<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;ERROR:&quot;</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
		<span class="token keyword">return</span>
	<span class="token punctuation">}</span>

	<span class="token comment">// Create a context with a timeout of 50 milliseconds.</span>
	ctx<span class="token punctuation">,</span> cancel <span class="token operator">:=</span> context<span class="token punctuation">.</span><span class="token function">WithTimeout</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span><span class="token function">Context</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">50</span><span class="token operator">*</span>time<span class="token punctuation">.</span>Millisecond<span class="token punctuation">)</span>
	<span class="token keyword">defer</span> <span class="token function">cancel</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

	<span class="token comment">// Bind the new context into the request.</span>
	req <span class="token operator">=</span> req<span class="token punctuation">.</span><span class="token function">WithContext</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span>

	<span class="token comment">// Make the web call and return any error. Do will handle the</span>
	<span class="token comment">// context level timeout.</span>
	resp<span class="token punctuation">,</span> err <span class="token operator">:=</span> http<span class="token punctuation">.</span>DefaultClient<span class="token punctuation">.</span><span class="token function">Do</span><span class="token punctuation">(</span>req<span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		log<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;ERROR:&quot;</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
		<span class="token keyword">return</span>
	<span class="token punctuation">}</span>

	<span class="token comment">// Close the response body on the return.</span>
	<span class="token keyword">defer</span> resp<span class="token punctuation">.</span>Body<span class="token punctuation">.</span><span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

	<span class="token comment">// Write the response to stdout.</span>
	io<span class="token punctuation">.</span><span class="token function">Copy</span><span class="token punctuation">(</span>os<span class="token punctuation">.</span>Stdout<span class="token punctuation">,</span> resp<span class="token punctuation">.</span>Body<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br></div></div><p>代码片段 4 演示的程序对 Ardan rss 博客流的请求，超时时间为 50 毫秒。14-18 行对给定的 URL 发起一次 <code>GET</code> 请求。21-22 行创建了一个超时时间为 50 毫秒的 <code>Context</code>。1.7 版后 <code>Request</code> 值引入一项新的 API -- <code>WithContext</code>。这个方法提供了更新 <code>Request</code> 的 <code>Context</code> 值的接口。</p> <p>第 35 行，真正的请求通过调用 <code>http</code> 包 <code>DefaultClient</code> 实例的 <code>Do</code> 方法发起。这个 <code>Do</code> 方法会遵守如今设置给 <code>Request</code> 的这 50 毫秒超时时间。正如你所见，这份代码（上层函数）告诉 <code>Do</code> 方法（底层函数）我们所能容忍 <code>Do</code> 完成操作的最大时长。</p> <h2 id="不要把-context-存到结构体类型-而应该显示地将-context-传给每个需要的函数"><a href="#不要把-context-存到结构体类型-而应该显示地将-context-传给每个需要的函数" class="header-anchor">#</a> 不要把 <code>Context</code> 存到结构体类型，而应该显示地将 <code>Context</code> 传给每个需要的函数</h2> <p>实际上，任何执行 I/O 的函数都应该接受一个 <code>Context</code> 值作为第一个参数，并遵守用户设定的超时或期限。对于 <code>Request</code>，我们还需要考虑后向兼容的问题。所以我们并没有改动 API，而是采用了上一节展示的实现方式。</p> <p>凡事皆有例外。对本篇博文和所有接收 <code>Context</code> 的标准库 API 来说，习惯用法是用第一个参数接收 <code>Context</code> 值。</p> <p>代码片段 5</p> <div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">type</span> Resolver
    <span class="token keyword">func</span> <span class="token punctuation">(</span>r <span class="token operator">*</span>Resolver<span class="token punctuation">)</span> <span class="token function">LookupAddr</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> addr <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>names <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">,</span> err <span class="token builtin">error</span><span class="token punctuation">)</span>
    <span class="token keyword">func</span> <span class="token punctuation">(</span>r <span class="token operator">*</span>Resolver<span class="token punctuation">)</span> <span class="token function">LookupCNAME</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> host <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>cname <span class="token builtin">string</span><span class="token punctuation">,</span> err <span class="token builtin">error</span><span class="token punctuation">)</span>
    <span class="token keyword">func</span> <span class="token punctuation">(</span>r <span class="token operator">*</span>Resolver<span class="token punctuation">)</span> <span class="token function">LookupHost</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> host <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>addrs <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">,</span> err <span class="token builtin">error</span><span class="token punctuation">)</span>
    <span class="token keyword">func</span> <span class="token punctuation">(</span>r <span class="token operator">*</span>Resolver<span class="token punctuation">)</span> <span class="token function">LookupIPAddr</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> host <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span>IPAddr<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span>
    <span class="token keyword">func</span> <span class="token punctuation">(</span>r <span class="token operator">*</span>Resolver<span class="token punctuation">)</span> <span class="token function">LookupMX</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> name <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>MX<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span>
    <span class="token keyword">func</span> <span class="token punctuation">(</span>r <span class="token operator">*</span>Resolver<span class="token punctuation">)</span> <span class="token function">LookupNS</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> name <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>NS<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span>
    <span class="token keyword">func</span> <span class="token punctuation">(</span>r <span class="token operator">*</span>Resolver<span class="token punctuation">)</span> <span class="token function">LookupPort</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> network<span class="token punctuation">,</span> service <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>port <span class="token builtin">int</span><span class="token punctuation">,</span> err <span class="token builtin">error</span><span class="token punctuation">)</span>
    <span class="token keyword">func</span> <span class="token punctuation">(</span>r <span class="token operator">*</span>Resolver<span class="token punctuation">)</span> <span class="token function">LookupSRV</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> service<span class="token punctuation">,</span> proto<span class="token punctuation">,</span> name <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>cname <span class="token builtin">string</span><span class="token punctuation">,</span> addrs <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>SRV<span class="token punctuation">,</span> err <span class="token builtin">error</span><span class="token punctuation">)</span>
    <span class="token keyword">func</span> <span class="token punctuation">(</span>r <span class="token operator">*</span>Resolver<span class="token punctuation">)</span> <span class="token function">LookupTXT</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> name <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>代码片段 5 展示 <code>net</code> 包的一个例子，所有方法的第一个参数都是 <code>Context</code> 并且采用了 <code>ctx</code> 命名风格。</p> <h2 id="函数调用链的函数之间必须传递-context"><a href="#函数调用链的函数之间必须传递-context" class="header-anchor">#</a> 函数调用链的函数之间必须传递 <code>Context</code></h2> <p>鉴于 <code>Context</code> 绑定到请求或任务，这是一条非常重要的规则。我们需要这个 <code>Context</code> 和在请求或任务处理过程的任何变更都能得到传递和遵守。</p> <p>代码片段 6</p> <p>https://github.com/ardanlabs/service/blob/master/internal/user/user.go#L34</p> <blockquote><p>对应源码的原链接已失效= =</p></blockquote> <div class="language-go line-numbers-mode"><div class="highlight-lines"><br><br><div class="highlighted"> </div><br><br><div class="highlighted"> </div><br><br><br><br><div class="highlighted"> </div><br><br></div><pre class="language-go"><code><span class="token comment">// List returns all the existing users in the system.</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>u <span class="token operator">*</span>User<span class="token punctuation">)</span> <span class="token function">List</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> w http<span class="token punctuation">.</span>ResponseWriter<span class="token punctuation">,</span> r <span class="token operator">*</span>http<span class="token punctuation">.</span>Request<span class="token punctuation">,</span> params <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>
    ctx<span class="token punctuation">,</span> span <span class="token operator">:=</span> trace<span class="token punctuation">.</span><span class="token function">StartSpan</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> <span class="token string">&quot;handlers.User.List&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">defer</span> span<span class="token punctuation">.</span><span class="token function">End</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

    users<span class="token punctuation">,</span> err <span class="token operator">:=</span> user<span class="token punctuation">.</span><span class="token function">List</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> u<span class="token punctuation">.</span>db<span class="token punctuation">)</span>
    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> err
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> web<span class="token punctuation">.</span><span class="token function">Respond</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> w<span class="token punctuation">,</span> users<span class="token punctuation">,</span> http<span class="token punctuation">.</span>StatusOK<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p>如代码片段 6 实现的是一个名为 <code>List</code> 的 handler 函数，函数处理用户发向这个端点的 HTTP 请求。由于需要是请求的一部分且执行 I/O，这个 handler 接收 <code>Context</code> 作为第一个参数。如我们所见，3、6 和 11 行都把同一个 <code>Context</code> 值沿着调用栈向下传递。</p> <p>因为这个函数不需要改变 <code>Context</code>，所以不需要创建一个新的 <code>Context</code>。如果这个函数创建一个新的顶层 <code>Context</code>，请求源自上层调用的现有全部上下文信息都会丢失。这不会是你想要的。</p> <p>代码片段 7</p> <p>https://github.com/ardanlabs/service/blob/master/internal/user/user.go#L34</p> <blockquote><p>对应源码的原链接已失效= =</p></blockquote> <div class="language-go line-numbers-mode"><div class="highlight-lines"><br><br><div class="highlighted"> </div><br><br><br><br><br><div class="highlighted"> </div><br><br><br><br><br><br></div><pre class="language-go"><code><span class="token comment">// List retrieves a list of existing users from the database.</span>
<span class="token keyword">func</span> <span class="token function">List</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> db <span class="token operator">*</span>sqlx<span class="token punctuation">.</span>DB<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span>User<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    ctx<span class="token punctuation">,</span> span <span class="token operator">:=</span> trace<span class="token punctuation">.</span><span class="token function">StartSpan</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> <span class="token string">&quot;internal.user.List&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">defer</span> span<span class="token punctuation">.</span><span class="token function">End</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

    users <span class="token operator">:=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>User<span class="token punctuation">{</span><span class="token punctuation">}</span>
    <span class="token keyword">const</span> q <span class="token operator">=</span> <span class="token string">`SELECT * FROM users`</span>

    <span class="token keyword">if</span> err <span class="token operator">:=</span> db<span class="token punctuation">.</span><span class="token function">SelectContext</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> <span class="token operator">&amp;</span>users<span class="token punctuation">,</span> q<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> errors<span class="token punctuation">.</span><span class="token function">Wrap</span><span class="token punctuation">(</span>err<span class="token punctuation">,</span> <span class="token string">&quot;selecting users&quot;</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> users<span class="token punctuation">,</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><p>代码片段 7 展示了 代码片段 6 第 6 行调用的 <code>List</code> 定义。再次可见，这个方法接收一个 <code>Context</code> 作为第一个参数。这个值再次在第 3 和 9 行往下传递。由于第 9 行是一个数据库调用，这个函数应该遵守之前调用方在 <code>Context</code> 里面设置的所有超时信息。</p> <h2 id="利用-withcancel、withdeadline、withtimeout-或-withvalue-来更新一个-context"><a href="#利用-withcancel、withdeadline、withtimeout-或-withvalue-来更新一个-context" class="header-anchor">#</a> 利用 <code>WithCancel</code>、<code>WithDeadline</code>、<code>WithTimeout</code> 或 <code>WithValue</code> 来更新一个 <code>Context</code></h2> <p>因为每个函数都可以根据它们的特定需求添加或修改 <code>Context</code> 且这些变动不应该影响到之前调用的所有函数，<code>Context</code> 通过值传递。这就意味着任何对 <code>Context</code> 值的改动都会创建一个新的 <code>Context</code>，这个新值继续向下传递。</p> <p>代码片段 8</p> <p><a href="https://play.golang.org/p/8RdBXtfDv1w" target="_blank" rel="noopener noreferrer">https://play.golang.org/p/8RdBXtfDv1w<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <div class="language-go line-numbers-mode"><div class="highlight-lines"><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><div class="highlighted"> </div><div class="highlighted"> </div><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br></div><pre class="language-go"><code><span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">&quot;context&quot;</span>
	<span class="token string">&quot;fmt&quot;</span>
	<span class="token string">&quot;time&quot;</span>
<span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

	<span class="token comment">// Set a duration.</span>
	duration <span class="token operator">:=</span> <span class="token number">150</span> <span class="token operator">*</span> time<span class="token punctuation">.</span>Millisecond

	<span class="token comment">// Create a context that is both manually cancellable and will signal</span>
	<span class="token comment">// cancel at the specified duration.</span>
	ctx<span class="token punctuation">,</span> cancel <span class="token operator">:=</span> context<span class="token punctuation">.</span><span class="token function">WithTimeout</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span><span class="token function">Background</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> duration<span class="token punctuation">)</span>
	<span class="token keyword">defer</span> <span class="token function">cancel</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

	<span class="token comment">// Create a channel to receive a signal that work is done.</span>
	ch <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> data<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>

	<span class="token comment">// Ask the goroutine to do some work for us.</span>
	<span class="token keyword">go</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

		<span class="token comment">// Simulate work.</span>
		time<span class="token punctuation">.</span><span class="token function">Sleep</span><span class="token punctuation">(</span><span class="token number">50</span> <span class="token operator">*</span> time<span class="token punctuation">.</span>Millisecond<span class="token punctuation">)</span>

		<span class="token comment">// Report the work is done.</span>
		ch <span class="token operator">&lt;-</span> data<span class="token punctuation">{</span><span class="token string">&quot;123&quot;</span><span class="token punctuation">}</span>
	<span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

	<span class="token comment">// Wait for the work to finish. If it takes too long, move on.</span>
	<span class="token keyword">select</span> <span class="token punctuation">{</span>
	<span class="token keyword">case</span> d <span class="token operator">:=</span> <span class="token operator">&lt;-</span>ch<span class="token punctuation">:</span>
		fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;work complete&quot;</span><span class="token punctuation">,</span> d<span class="token punctuation">)</span>

	<span class="token keyword">case</span> <span class="token operator">&lt;-</span>ctx<span class="token punctuation">.</span><span class="token function">Done</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
		fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;work cancelled&quot;</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br></div></div><p>代码片段 8 的小程序展示 <code>WithTimeout</code> 函数自然通过值传递 <code>Context</code> 的方式。第 16 行对 <code>WithTimeout</code> 的调用返回一个新的 <code>Context</code> 值和一个 <code>cancel</code> 函数。由于函数调用需要一个父 <code>Context</code>，代码使用 <code>Background</code> 函数创建了一个上层的空 <code>Context</code>。这正是 <code>Background</code> 函数的用法之一。</p> <p>后续流程使用的是 <code>WithTimeout</code> 函数常见的 <code>Context</code> 值。调用链后面的任何函数需要自己特定的超时或期限的话，也应该以这个新的 <code>Context</code> 为父亲调用合适的 <code>With</code> 函数。</p> <p>这里尤其需要注意的一点是：<code>With</code> 函数返回的任何 <code>cancel</code> 函数都需要在外层函数返回前执行。这也正是如第 17 行在 <code>With</code> 调用之后立即使用 <code>defer</code> 关键字的惯性用法的缘由。没有这样做会导致程序泄露内存。</p> <h2 id="一个-context-被取消后-所有从它派生的-context-也会被取消"><a href="#一个-context-被取消后-所有从它派生的-context-也会被取消" class="header-anchor">#</a> 一个 <code>Context</code> 被取消后，所有从它派生的 <code>Context</code> 也会被取消</h2> <p><code>Context</code> API 这种值传递方式意味着：每个新的 <code>Context</code> 都会获得父 <code>Context</code> 的所有信息再加上新添的更改。这意味着一旦父 <code>Context</code> 被取消了，所有从它派生的子 <code>Context</code> 也会被取消。</p> <p>代码片段 9</p> <p><a href="https://play.golang.org/p/PmhTXiCZUP1" target="_blank" rel="noopener noreferrer">https://play.golang.org/p/PmhTXiCZUP1<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <div class="language-go line-numbers-mode"><div class="highlight-lines"><br><br><br><div class="highlighted"> </div><br><br><br><br><br><br><br><br><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><br><br><div class="highlighted"> </div><div class="highlighted"> </div><br><br></div><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

	<span class="token comment">// Create a Context that can be cancelled.</span>
	ctx<span class="token punctuation">,</span> cancel <span class="token operator">:=</span> context<span class="token punctuation">.</span><span class="token function">WithCancel</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span><span class="token function">Background</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token keyword">defer</span> <span class="token function">cancel</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

	<span class="token comment">// Use the Waitgroup for orchestration.</span>
	<span class="token keyword">var</span> wg sync<span class="token punctuation">.</span>WaitGroup
	wg<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span>

	<span class="token comment">// Create ten goroutines that will derive a Context from</span>
	<span class="token comment">// the one created above.</span>
	<span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">10</span><span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">{</span>
		<span class="token keyword">go</span> <span class="token keyword">func</span><span class="token punctuation">(</span>id <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token keyword">defer</span> wg<span class="token punctuation">.</span><span class="token function">Done</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

			<span class="token comment">// Derive a new Context for this goroutine from the Context</span>
			<span class="token comment">// owned by the main function.</span>
			ctx <span class="token operator">:=</span> context<span class="token punctuation">.</span><span class="token function">WithValue</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> key<span class="token punctuation">,</span> id<span class="token punctuation">)</span>

			<span class="token comment">// Wait until the Context is cancelled.</span>
			<span class="token operator">&lt;-</span>ctx<span class="token punctuation">.</span><span class="token function">Done</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
			fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;Cancelled:&quot;</span><span class="token punctuation">,</span> id<span class="token punctuation">)</span>
		<span class="token punctuation">}</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>

	<span class="token comment">// Cancel the Context and any derived Context's as well.</span>
	<span class="token function">cancel</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	wg<span class="token punctuation">.</span><span class="token function">Wait</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br></div></div><p>代码片段 9 展示的程序在第 4 行创建了一个可取消的 <code>Context</code> 值。然后 13-25 行创建了 10 个 goroutine。每个 goroutine 在第 19 行把他们独有的 ID 放入自己的 <code>Context</code>。<code>WithValue</code> 调用时采用的父 <code>Context</code> 是 <code>main</code> 函数的 <code>Context</code>。然后第 29 行使得每个 goroutine 等待直至它们的 <code>Context</code> 被取消。</p> <p>第 28 行主 goroutine 取消它的 <code>Context</code>，然后在第 29 行等待全部 10 个 goroutine 直至收到信号，然后关掉整个程序。一旦 <code>cancel</code> 函数被调用，第 22 行的全部 10 个 goroutine 都会变成非阻塞，打印说明它们都被取消了。一个 <code>cancel</code> 调用取消了所有 <code>Context</code>。</p> <p>这也演示了同一个 <code>Context</code> 可以传给不同 goroutine 里面运行的函数。<code>Context</code> 能够安全地被多个 goroutine 同时使用。</p> <h2 id="即使函数允许-也不要传递-nil-类型的-context。无法确定要用的-context-时-传递一个-todo-类型的-context"><a href="#即使函数允许-也不要传递-nil-类型的-context。无法确定要用的-context-时-传递一个-todo-类型的-context" class="header-anchor">#</a> 即使函数允许，也不要传递 <code>nil</code> 类型的 <code>Context</code>。无法确定要用的 <code>Context</code> 时，传递一个 <code>TODO</code> 类型的 <code>Context</code></h2> <p>本人最喜欢的 <code>Context</code> 包的一部分是 <code>TODO</code> 函数。我一直坚信着程序猿总是会编写代码草稿的。这和作家为不同版本的文章打草稿没什么区别。写代码时我们永远都无法预知所有问题，但是基于足够的了解继续向前还是比较有希望的。最后结果是：我们会不断地学习、重构和测试。</p> <p>我见过很多次需要一个 <code>Context</code> 却又不确定其来源的情况。由于不用负责创建上层的 <code>Context</code>，所以使用 <code>Background</code> 函数是不合适的。我需要的是一个临时的上层 <code>Context</code> 直到我弄明白真正的 <code>Context</code> 来源。这就是使用 <code>TODO</code> 函数替代 <code>Background</code> 函数的时机。</p> <h2 id="context-的值只应用于请求作用域内跨越进程和-api-的数据-而不用于给函数传递可选参数"><a href="#context-的值只应用于请求作用域内跨越进程和-api-的数据-而不用于给函数传递可选参数" class="header-anchor">#</a> <code>Context</code> 的值只应用于请求作用域内跨越进程和 API 的数据，而不用于给函数传递可选参数</h2> <p>这可能是所有规则中最重要的一条。当函数需要数据来保证成功执行时，不要使用 <code>Context</code> 值给函数传递这份数据。也就是说，函数应该能够以一个空的 <code>Context</code> 值来运行自身逻辑。如果函数需要 <code>Context</code> 包含特定信息而这份信息缺失时，程序应该执行失败并且示意应用关闭。</p> <p>借助 <code>Context</code> 给函数传递数据的一个常见误用是处理数据库连接的场景。通常情况下，我们会遵循以下顺序在程序里转移数据。</p> <ul><li>将数据作为函数参数传递。这是在程序里转移数据不加任何掩饰的最清晰的方式</li> <li>通过接收者传递数据。如果需要数据的函数无法改变自身的方法签名，我们可以使用一个方法，而通过接收者来传递数据</li></ul> <h3 id="使用接收者的小例"><a href="#使用接收者的小例" class="header-anchor">#</a> 使用接收者的小例</h3> <p>请求处理器时第二条规则的一个经典实例。由于处理器函数绑定到特定的声明，它的函数签名无法改变。</p> <p>代码片段 10</p> <p>https://github.com/ardanlabs/service/blob/master/cmd/sales-api/internal/handlers/user.go#L24</p> <blockquote><p>对应源码的原链接已失效= =</p></blockquote> <div class="language-go line-numbers-mode"><div class="highlight-lines"><br><br><br><br><div class="highlighted"> </div><br><br><br><br><br><br><br></div><pre class="language-go"><code><span class="token keyword">func</span> <span class="token punctuation">(</span>u <span class="token operator">*</span>User<span class="token punctuation">)</span> <span class="token function">List</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> w http<span class="token punctuation">.</span>ResponseWriter<span class="token punctuation">,</span> r <span class="token operator">*</span>http<span class="token punctuation">.</span>Request<span class="token punctuation">,</span> params <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>
	ctx<span class="token punctuation">,</span> span <span class="token operator">:=</span> trace<span class="token punctuation">.</span><span class="token function">StartSpan</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> <span class="token string">&quot;handlers.User.List&quot;</span><span class="token punctuation">)</span>
	<span class="token keyword">defer</span> span<span class="token punctuation">.</span><span class="token function">End</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

	users<span class="token punctuation">,</span> err <span class="token operator">:=</span> user<span class="token punctuation">.</span><span class="token function">List</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> u<span class="token punctuation">.</span>db<span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> err
	<span class="token punctuation">}</span>

	<span class="token keyword">return</span> web<span class="token punctuation">.</span><span class="token function">Respond</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> w<span class="token punctuation">,</span> users<span class="token punctuation">,</span> http<span class="token punctuation">.</span>StatusOK<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>代码片段 10 展示了 <code>service</code> 项目的 <code>List</code> 处理器。这些方法的签名绑定到 web 框架定义的结构，无法改变。然而，执行第 5 行的逻辑调用又需要一个数据库连接。这份代码从接收者而不是传入的 <code>Context</code> 值拉取了连接池。</p> <p>代码片段 11</p> <p>https://github.com/ardanlabs/service/blob/master/cmd/sales-api/internal/handlers/user.go#L15</p> <blockquote><p>对应源码的原链接已失效= =</p></blockquote> <div class="language-go line-numbers-mode"><pre class="language-go"><code> <span class="token comment">// User represents the User API method handler set.</span>
 <span class="token keyword">type</span> User <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	db            <span class="token operator">*</span>sqlx<span class="token punctuation">.</span>DB
	authenticator <span class="token operator">*</span>auth<span class="token punctuation">.</span>Authenticator

	<span class="token comment">// ADD OTHER STATE LIKE THE LOGGER AND CONFIG HERE.</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>代码片段 11 展示了接收者的类型声明。请求处理器需要所有东西都定义为字段。这使得不用隐藏信息而业务逻辑层又能以空的 <code>Context</code> 值正常工作。</p> <p>代码片段 12</p> <p>https://github.com/ardanlabs/service/blob/master/cmd/sales-api/internal/handlers/routes.go#L14</p> <blockquote><p>对应源码的原链接已失效= =</p></blockquote> <div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token comment">// API constructs an http.Handler with all application routes defined.</span>
<span class="token keyword">func</span> <span class="token function">API</span><span class="token punctuation">(</span>shutdown <span class="token keyword">chan</span> os<span class="token punctuation">.</span>Signal<span class="token punctuation">,</span> log <span class="token operator">*</span>log<span class="token punctuation">.</span>Logger<span class="token punctuation">,</span> db <span class="token operator">*</span>sqlx<span class="token punctuation">.</span>DB<span class="token punctuation">,</span> authenticator <span class="token operator">*</span>auth<span class="token punctuation">.</span>Authenticator<span class="token punctuation">)</span> http<span class="token punctuation">.</span>Handler <span class="token punctuation">{</span>
	<span class="token comment">// ...</span>

	<span class="token comment">// Register user management and authentication endpoints.</span>
	u <span class="token operator">:=</span> User<span class="token punctuation">{</span>
		db<span class="token punctuation">:</span>            db<span class="token punctuation">,</span>
		authenticator<span class="token punctuation">:</span> authenticator<span class="token punctuation">,</span>
	<span class="token punctuation">}</span>

	app<span class="token punctuation">.</span><span class="token function">Handle</span><span class="token punctuation">(</span><span class="token string">&quot;GET&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;/v1/users&quot;</span><span class="token punctuation">,</span> u<span class="token punctuation">.</span>List<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p>代码片段 12 展示了构造一个 <code>User</code> 值，然后把 <code>List</code> 方法注册到给定路由的代码。再次可以看到，由于处理器函数的签名无法改变，借助接收者和方法是显式传递数据的其他方式中最优的。</p> <h4 id="调试或追踪数据可以通过-context-值安全传递"><a href="#调试或追踪数据可以通过-context-值安全传递" class="header-anchor">#</a> 调试或追踪数据可以通过 <code>Context</code> 值安全传递</h4> <p><code>Context</code> 能存取得值是一些调试或追踪信息。</p> <p>代码片段 13</p> <p>https://github.com/ardanlabs/service/blob/master/internal/platform/web/web.go#L23</p> <blockquote><p>对应源码的原链接已失效= =</p></blockquote> <div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token comment">// Values represent state for each request.</span>
<span class="token keyword">type</span> Values <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	TraceID    <span class="token builtin">string</span>
	Now        time<span class="token punctuation">.</span>Time
	StatusCode <span class="token builtin">int</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>代码片段 13 声明了一个为每个新请求创建并存到每个 <code>Context</code> 的类型。给定的三个字段提供追踪和调试请求的信息。这些信息在请求的逐步处理过程中被收集。</p> <p>代码片段 14</p> <p>https://github.com/ardanlabs/service/blob/master/internal/platform/web/web.go#L75</p> <blockquote><p>对应源码的原链接已失效= =</p></blockquote> <div class="language-go line-numbers-mode"><div class="highlight-lines"><br><br><br><br><br><br><br><br><br><br><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><br></div><pre class="language-go"><code><span class="token comment">// Handle is our mechanism for mounting Handlers for a given HTTP verb and path</span>
<span class="token comment">// pair, this makes for really easy, convenient routing.</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>a <span class="token operator">*</span>App<span class="token punctuation">)</span> <span class="token function">Handle</span><span class="token punctuation">(</span>verb<span class="token punctuation">,</span> path <span class="token builtin">string</span><span class="token punctuation">,</span> handler Handler<span class="token punctuation">,</span> mw <span class="token operator">...</span>Middleware<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token comment">// ...</span>

	<span class="token comment">// The function to execute for each request.</span>
	h <span class="token operator">:=</span> <span class="token keyword">func</span><span class="token punctuation">(</span>w http<span class="token punctuation">.</span>ResponseWriter<span class="token punctuation">,</span> r <span class="token operator">*</span>http<span class="token punctuation">.</span>Request<span class="token punctuation">,</span> params <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

	<span class="token comment">// Set the context with the required values to</span>
	<span class="token comment">// process the request.</span>
	v <span class="token operator">:=</span> Values<span class="token punctuation">{</span>
		TraceID<span class="token punctuation">:</span> span<span class="token punctuation">.</span><span class="token function">SpanContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>TraceID<span class="token punctuation">.</span><span class="token function">String</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
		Now<span class="token punctuation">:</span>     time<span class="token punctuation">.</span><span class="token function">Now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
	<span class="token punctuation">}</span>
	ctx <span class="token operator">=</span> context<span class="token punctuation">.</span><span class="token function">WithValue</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> KeyValues<span class="token punctuation">,</span> <span class="token operator">&amp;</span>v<span class="token punctuation">)</span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><p>代码片段 14 演示了第 11 行构造 <code>Values</code> 类型，然后在第 15 行存入 <code>Context</code>。一般是日志中间件最需要这些信息。</p> <p>代码片段 15</p> <p>https://github.com/ardanlabs/service/blob/master/internal/mid/logger.go#L20</p> <blockquote><p>对应源码的原链接已失效= =</p></blockquote> <div class="language-go line-numbers-mode"><div class="highlight-lines"><br><br><br><br><br><br><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><br><br><br><br><br><br><br></div><pre class="language-go"><code><span class="token comment">// Create the handler that will be attached in the middleware chain.</span>
h <span class="token operator">:=</span> <span class="token keyword">func</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> w http<span class="token punctuation">.</span>ResponseWriter<span class="token punctuation">,</span> r <span class="token operator">*</span>http<span class="token punctuation">.</span>Request<span class="token punctuation">,</span> params <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>
	<span class="token comment">// ...</span>

	<span class="token comment">// If the context is missing this value, request the service</span>
	<span class="token comment">// to be shutdown gracefully.</span>
	v<span class="token punctuation">,</span> ok <span class="token operator">:=</span> ctx<span class="token punctuation">.</span><span class="token function">Value</span><span class="token punctuation">(</span>web<span class="token punctuation">.</span>KeyValues<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token operator">*</span>web<span class="token punctuation">.</span>Values<span class="token punctuation">)</span>
	<span class="token keyword">if</span> <span class="token operator">!</span>ok <span class="token punctuation">{</span>
		<span class="token keyword">return</span> web<span class="token punctuation">.</span><span class="token function">NewShutdownError</span><span class="token punctuation">(</span><span class="token string">&quot;web value missing from context&quot;</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	<span class="token comment">// ...</span>
	log<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;%s : (%d) : %s %s -&gt; %s (%s)&quot;</span><span class="token punctuation">,</span>
		v<span class="token punctuation">.</span>TraceID<span class="token punctuation">,</span> v<span class="token punctuation">.</span>StatusCode<span class="token punctuation">,</span>
		r<span class="token punctuation">.</span>Method<span class="token punctuation">,</span> r<span class="token punctuation">.</span>URL<span class="token punctuation">.</span>Path<span class="token punctuation">,</span>
		r<span class="token punctuation">.</span>RemoteAddr<span class="token punctuation">,</span> time<span class="token punctuation">.</span><span class="token function">Since</span><span class="token punctuation">(</span>v<span class="token punctuation">.</span>Now<span class="token punctuation">)</span><span class="token punctuation">,</span>
	<span class="token punctuation">)</span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><p>代码片段 15 的第 7-10 行展示了通过 <code>Context</code> 传递信息的方式。这段代码试图从 <code>Context</code> 取出 <code>Values</code> 数据，并检查是否有可用数据。如果数据缺失，说明存在关键的完整性问题，这个服务需要关闭。实现方式为服务代码给应用程序回传一个特殊的错误值。</p> <p>如果通过 <code>Context</code> 给业务逻辑传递数据库连接或用户信息的话，我们会遇到两个问题：</p> <ul><li>需要检查完整性和一个快速关闭服务的机制</li> <li>测试和调试变得更加困难和更加复杂。在代码更好的清晰度和可读性方面，我们渐行渐远</li></ul> <h2 id="结论"><a href="#结论" class="header-anchor">#</a> 结论</h2> <p><code>Context</code> 包定义了一组 API，用于来支持限期、取消信号和限定请求在 API 边界或 goroutine 之间传递数据。这份 API 对我们编写的任何应用都是至关重要的。理解这些规则对我们编写可靠和完整的软件是不可或缺的。</p> <p>这篇博文尝试拆解了 Go 团队定义的规则。有幸的话，你现在对如何更加有效地利用 <code>Context</code> 有了更好的理解。你可以获取到所有示例代码。有任何疑问的话，直接给我发邮件就好。</p> <h2 id="小结"><a href="#小结" class="header-anchor">#</a> 小结</h2> <ul><li>服务器从外部收到的请求应该创建一个 <code>Context</code></li> <li>对服务器的调用应该接受一个 <code>Context</code></li> <li>不要把 <code>Context</code> 存到结构体类型，而应该显示地将 <code>Context</code> 传给每个需要的函数</li> <li>函数调用链的函数之间必须传递 <code>Context</code></li> <li>利用 <code>WithCancel</code>、<code>WithDeadline</code>、<code>WithTimeout</code> 或 <code>WithValue</code> 来更新一个 <code>Context</code></li> <li>一个 <code>Context</code> 被取消后，所有从它派生的 <code>Context</code> 也会被取消</li> <li>同一个 <code>Context</code> 可以传给不同 goroutine 里面运行的函数。<code>Context</code> 能够安全地被多个 goroutine 同时使用</li> <li>即使函数允许，也不要传递 <code>nil</code> 类型的 <code>Context</code>。无法确定要用的 <code>Context</code> 时，传递一个 <code>TODO</code> 类型的 <code>Context</code></li> <li><code>Context</code> 的值只应用于请求作用域内跨越进程和 API 的数据，而不用于给函数传递可选参数</li></ul></div></section> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">Last Updated: </span> <span class="time">4/18/2021, 1:52:33 AM</span></div></footer> <!----> <div class="comments-wrapper"><!----></div> <ul class="side-bar sub-sidebar-wrapper" style="width:12rem;" data-v-70334359><li class="level-2" data-v-70334359><a href="/_post/context-package-semantics-in-go/#引言" class="sidebar-link reco-side-引言" data-v-70334359>引言</a></li><li class="level-2" data-v-70334359><a href="/_post/context-package-semantics-in-go/#服务器从外部收到的请求应该创建一个-context" class="sidebar-link reco-side-服务器从外部收到的请求应该创建一个-context" data-v-70334359>服务器从外部收到的请求应该创建一个 Context</a></li><li class="level-2" data-v-70334359><a href="/_post/context-package-semantics-in-go/#对服务器的调用应该接受一个-context" class="sidebar-link reco-side-对服务器的调用应该接受一个-context" data-v-70334359>对服务器的调用应该接受一个 Context</a></li><li class="level-2" data-v-70334359><a href="/_post/context-package-semantics-in-go/#不要把-context-存到结构体类型-而应该显示地将-context-传给每个需要的函数" class="sidebar-link reco-side-不要把-context-存到结构体类型-而应该显示地将-context-传给每个需要的函数" data-v-70334359>不要把 Context 存到结构体类型，而应该显示地将 Context 传给每个需要的函数</a></li><li class="level-2" data-v-70334359><a href="/_post/context-package-semantics-in-go/#函数调用链的函数之间必须传递-context" class="sidebar-link reco-side-函数调用链的函数之间必须传递-context" data-v-70334359>函数调用链的函数之间必须传递 Context</a></li><li class="level-2" data-v-70334359><a href="/_post/context-package-semantics-in-go/#利用-withcancel、withdeadline、withtimeout-或-withvalue-来更新一个-context" class="sidebar-link reco-side-利用-withcancel、withdeadline、withtimeout-或-withvalue-来更新一个-context" data-v-70334359>利用 WithCancel、WithDeadline、WithTimeout 或 WithValue 来更新一个 Context</a></li><li class="level-2" data-v-70334359><a href="/_post/context-package-semantics-in-go/#一个-context-被取消后-所有从它派生的-context-也会被取消" class="sidebar-link reco-side-一个-context-被取消后-所有从它派生的-context-也会被取消" data-v-70334359>一个 Context 被取消后，所有从它派生的 Context 也会被取消</a></li><li class="level-2" data-v-70334359><a href="/_post/context-package-semantics-in-go/#即使函数允许-也不要传递-nil-类型的-context。无法确定要用的-context-时-传递一个-todo-类型的-context" class="sidebar-link reco-side-即使函数允许-也不要传递-nil-类型的-context。无法确定要用的-context-时-传递一个-todo-类型的-context" data-v-70334359>即使函数允许，也不要传递 nil 类型的 Context。无法确定要用的 Context 时，传递一个 TODO 类型的 Context</a></li><li class="level-2" data-v-70334359><a href="/_post/context-package-semantics-in-go/#context-的值只应用于请求作用域内跨越进程和-api-的数据-而不用于给函数传递可选参数" class="sidebar-link reco-side-context-的值只应用于请求作用域内跨越进程和-api-的数据-而不用于给函数传递可选参数" data-v-70334359>Context 的值只应用于请求作用域内跨越进程和 API 的数据，而不用于给函数传递可选参数</a></li><li class="level-3" data-v-70334359><a href="/_post/context-package-semantics-in-go/#使用接收者的小例" class="sidebar-link reco-side-使用接收者的小例" data-v-70334359>使用接收者的小例</a></li><li class="level-2" data-v-70334359><a href="/_post/context-package-semantics-in-go/#结论" class="sidebar-link reco-side-结论" data-v-70334359>结论</a></li><li class="level-2" data-v-70334359><a href="/_post/context-package-semantics-in-go/#小结" class="sidebar-link reco-side-小结" data-v-70334359>小结</a></li></ul></main> <!----></div></div></div></div><div class="global-ui"><div class="back-to-ceiling" style="right:1rem;bottom:6rem;width:2.5rem;height:2.5rem;border-radius:.25rem;line-height:2.5rem;display:none;" data-v-c6073ba8 data-v-c6073ba8><svg t="1574745035067" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="5404" class="icon" data-v-c6073ba8><path d="M526.60727968 10.90185116a27.675 27.675 0 0 0-29.21455937 0c-131.36607665 82.28402758-218.69155461 228.01873535-218.69155402 394.07834331a462.20625001 462.20625001 0 0 0 5.36959153 69.94390903c1.00431239 6.55289093-0.34802892 13.13561351-3.76865779 18.80351572-32.63518765 54.11355614-51.75690182 118.55860487-51.7569018 187.94566865a371.06718723 371.06718723 0 0 0 11.50484808 91.98906777c6.53300375 25.50556257 41.68394495 28.14064038 52.69160883 4.22606766 17.37162448-37.73630017 42.14135425-72.50938081 72.80769204-103.21549295 2.18761121 3.04276886 4.15646224 6.24463696 6.40373557 9.22774369a1871.4375 1871.4375 0 0 0 140.04691725 5.34970492 1866.36093723 1866.36093723 0 0 0 140.04691723-5.34970492c2.24727335-2.98310674 4.21612437-6.18497483 6.3937923-9.2178004 30.66633723 30.70611158 55.4360664 65.4791928 72.80769147 103.21549355 11.00766384 23.91457269 46.15860503 21.27949489 52.69160879-4.22606768a371.15156223 371.15156223 0 0 0 11.514792-91.99901164c0-69.36717486-19.13165746-133.82216804-51.75690182-187.92578088-3.42062944-5.66790279-4.76302748-12.26056868-3.76865837-18.80351632a462.20625001 462.20625001 0 0 0 5.36959269-69.943909c-0.00994388-166.08943902-87.32547796-311.81420293-218.6915546-394.09823051zM605.93803103 357.87693858a93.93749974 93.93749974 0 1 1-187.89594924 6.1e-7 93.93749974 93.93749974 0 0 1 187.89594924-6.1e-7z" p-id="5405" data-v-c6073ba8></path><path d="M429.50777625 765.63860547C429.50777625 803.39355007 466.44236686 1000.39046097 512.00932183 1000.39046097c45.56695499 0 82.4922232-197.00623328 82.5015456-234.7518555 0-37.75494459-36.9345906-68.35043303-82.4922232-68.34111062-45.57627738-0.00932239-82.52019037 30.59548842-82.51086798 68.34111062z" p-id="5406" data-v-c6073ba8></path></svg></div></div></div>
    <script src="/assets/js/app.460084d6.js" defer></script><script src="/assets/js/3.df7e20a8.js" defer></script><script src="/assets/js/1.7ac9a612.js" defer></script><script src="/assets/js/65.18257448.js" defer></script>
  </body>
</html>
