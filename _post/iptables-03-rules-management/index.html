<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>[iptables] 03. 规则管理 | sammyne</title>
    <meta name="generator" content="VuePress 1.8.1">
    <link rel="icon" href="/favicon.ico">
    <meta name="description" content="Just playing around :)">
    <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no">
    
    <link rel="preload" href="/assets/css/0.styles.a1b76618.css" as="style"><link rel="preload" href="/assets/js/app.460084d6.js" as="script"><link rel="preload" href="/assets/js/3.df7e20a8.js" as="script"><link rel="preload" href="/assets/js/1.7ac9a612.js" as="script"><link rel="preload" href="/assets/js/68.1a70d0ba.js" as="script"><link rel="prefetch" href="/assets/js/10.af14b39e.js"><link rel="prefetch" href="/assets/js/11.99ba64c8.js"><link rel="prefetch" href="/assets/js/12.34332094.js"><link rel="prefetch" href="/assets/js/13.1704bbed.js"><link rel="prefetch" href="/assets/js/14.11859fd4.js"><link rel="prefetch" href="/assets/js/15.d43300c2.js"><link rel="prefetch" href="/assets/js/16.3249b7d3.js"><link rel="prefetch" href="/assets/js/17.a01809f8.js"><link rel="prefetch" href="/assets/js/18.1dfec45f.js"><link rel="prefetch" href="/assets/js/19.f412f4f3.js"><link rel="prefetch" href="/assets/js/20.55e15a5f.js"><link rel="prefetch" href="/assets/js/21.c69cd7e0.js"><link rel="prefetch" href="/assets/js/22.cbffd43e.js"><link rel="prefetch" href="/assets/js/23.8b16fdf0.js"><link rel="prefetch" href="/assets/js/24.201c83d8.js"><link rel="prefetch" href="/assets/js/25.b41a1a47.js"><link rel="prefetch" href="/assets/js/26.0ed3e66c.js"><link rel="prefetch" href="/assets/js/27.7efc701f.js"><link rel="prefetch" href="/assets/js/28.72e1cd8a.js"><link rel="prefetch" href="/assets/js/29.0dced9b2.js"><link rel="prefetch" href="/assets/js/30.ab09489f.js"><link rel="prefetch" href="/assets/js/31.8c87f1ae.js"><link rel="prefetch" href="/assets/js/32.9007a3fd.js"><link rel="prefetch" href="/assets/js/33.f5646ecf.js"><link rel="prefetch" href="/assets/js/34.30466f73.js"><link rel="prefetch" href="/assets/js/35.5f43a455.js"><link rel="prefetch" href="/assets/js/36.605c0762.js"><link rel="prefetch" href="/assets/js/37.49a6b29b.js"><link rel="prefetch" href="/assets/js/38.9c0ceed6.js"><link rel="prefetch" href="/assets/js/39.833e25b8.js"><link rel="prefetch" href="/assets/js/4.33345026.js"><link rel="prefetch" href="/assets/js/40.62164fd4.js"><link rel="prefetch" href="/assets/js/41.6780bccd.js"><link rel="prefetch" href="/assets/js/42.a299958f.js"><link rel="prefetch" href="/assets/js/43.d7eb41dd.js"><link rel="prefetch" href="/assets/js/44.d2732739.js"><link rel="prefetch" href="/assets/js/45.26690fbb.js"><link rel="prefetch" href="/assets/js/46.9bafaf20.js"><link rel="prefetch" href="/assets/js/47.a788ae84.js"><link rel="prefetch" href="/assets/js/48.53199aae.js"><link rel="prefetch" href="/assets/js/49.93080943.js"><link rel="prefetch" href="/assets/js/5.da215b11.js"><link rel="prefetch" href="/assets/js/50.e2b156f3.js"><link rel="prefetch" href="/assets/js/51.7ca05ae4.js"><link rel="prefetch" href="/assets/js/52.8459aac5.js"><link rel="prefetch" href="/assets/js/53.7d8293f9.js"><link rel="prefetch" href="/assets/js/54.0e93b6fe.js"><link rel="prefetch" href="/assets/js/55.46fc1714.js"><link rel="prefetch" href="/assets/js/56.c8f25f54.js"><link rel="prefetch" href="/assets/js/57.cd09ca2f.js"><link rel="prefetch" href="/assets/js/58.810d1d6b.js"><link rel="prefetch" href="/assets/js/59.5e1237fd.js"><link rel="prefetch" href="/assets/js/6.0f93370d.js"><link rel="prefetch" href="/assets/js/60.4176824e.js"><link rel="prefetch" href="/assets/js/61.a7fe6954.js"><link rel="prefetch" href="/assets/js/62.7f7e45b1.js"><link rel="prefetch" href="/assets/js/63.ed2ba3d1.js"><link rel="prefetch" href="/assets/js/64.752309f8.js"><link rel="prefetch" href="/assets/js/65.18257448.js"><link rel="prefetch" href="/assets/js/66.47af013f.js"><link rel="prefetch" href="/assets/js/67.79be0219.js"><link rel="prefetch" href="/assets/js/69.899d158c.js"><link rel="prefetch" href="/assets/js/7.505b693a.js"><link rel="prefetch" href="/assets/js/70.a3db0124.js"><link rel="prefetch" href="/assets/js/71.7911f9d8.js"><link rel="prefetch" href="/assets/js/72.ca1b110f.js"><link rel="prefetch" href="/assets/js/73.78e18e89.js"><link rel="prefetch" href="/assets/js/74.5ff67c9e.js"><link rel="prefetch" href="/assets/js/75.aef53f06.js"><link rel="prefetch" href="/assets/js/76.e5510aea.js"><link rel="prefetch" href="/assets/js/77.abf8082a.js"><link rel="prefetch" href="/assets/js/78.a514a13d.js"><link rel="prefetch" href="/assets/js/79.c6fa750e.js"><link rel="prefetch" href="/assets/js/8.a4375844.js"><link rel="prefetch" href="/assets/js/80.9a33cbfe.js"><link rel="prefetch" href="/assets/js/81.c11dd67c.js"><link rel="prefetch" href="/assets/js/82.8648179e.js"><link rel="prefetch" href="/assets/js/83.2085ad68.js"><link rel="prefetch" href="/assets/js/84.a3c855af.js"><link rel="prefetch" href="/assets/js/85.2be7c107.js"><link rel="prefetch" href="/assets/js/86.ae61a023.js"><link rel="prefetch" href="/assets/js/87.da256952.js"><link rel="prefetch" href="/assets/js/88.63158169.js"><link rel="prefetch" href="/assets/js/89.cd89167a.js"><link rel="prefetch" href="/assets/js/9.acef0cc1.js"><link rel="prefetch" href="/assets/js/90.44315479.js"><link rel="prefetch" href="/assets/js/91.942e3147.js"><link rel="prefetch" href="/assets/js/92.5e611347.js">
    <link rel="stylesheet" href="/assets/css/0.styles.a1b76618.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container no-sidebar" data-v-1156296a><div data-v-1156296a><div id="loader-wrapper" class="loading-wrapper" data-v-d48f4d20 data-v-1156296a data-v-1156296a><div class="loader-main" data-v-d48f4d20><div data-v-d48f4d20></div><div data-v-d48f4d20></div><div data-v-d48f4d20></div><div data-v-d48f4d20></div></div> <!----> <!----></div> <div class="password-shadow password-wrapper-out" style="display:none;" data-v-4e82dffc data-v-1156296a data-v-1156296a><h3 class="title" data-v-4e82dffc data-v-4e82dffc>sammyne</h3> <p class="description" data-v-4e82dffc data-v-4e82dffc>Just playing around :)</p> <label id="box" class="inputBox" data-v-4e82dffc data-v-4e82dffc><input type="password" value="" data-v-4e82dffc> <span data-v-4e82dffc>Konck! Knock!</span> <button data-v-4e82dffc>OK</button></label> <div class="footer" data-v-4e82dffc data-v-4e82dffc><span data-v-4e82dffc><i class="iconfont reco-theme" data-v-4e82dffc></i> <a target="blank" href="https://vuepress-theme-reco.recoluan.com" data-v-4e82dffc>vuePress-theme-reco</a></span> <span data-v-4e82dffc><i class="iconfont reco-copyright" data-v-4e82dffc></i> <a data-v-4e82dffc><span data-v-4e82dffc>sammyne</span>
            
          <span data-v-4e82dffc>2020 - </span>
          2021
        </a></span></div></div> <div class="hide" data-v-1156296a><header class="navbar" data-v-1156296a><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/logo.svg" alt="sammyne" class="logo"> <span class="site-name">sammyne</span></a> <div class="links"><div class="color-picker"><a class="color-button"><i class="iconfont reco-color"></i></a> <div class="color-picker-menu" style="display:none;"><div class="mode-options"><h4 class="title">Choose mode</h4> <ul class="color-mode-options"><li class="dark">dark</li><li class="auto active">auto</li><li class="light">light</li></ul></div></div></div> <div class="search-box"><i class="iconfont reco-search"></i> <input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link"><i class="iconfont reco-home"></i>
  首页
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-category"></i>
      分类
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/categories/dev/" class="nav-link"><i class="undefined"></i>
  dev
</a></li><li class="dropdown-item"><!----> <a href="/categories/crypto/" class="nav-link"><i class="undefined"></i>
  crypto
</a></li><li class="dropdown-item"><!----> <a href="/categories/programming/" class="nav-link"><i class="undefined"></i>
  programming
</a></li><li class="dropdown-item"><!----> <a href="/categories/tee/" class="nav-link"><i class="undefined"></i>
  tee
</a></li><li class="dropdown-item"><!----> <a href="/categories/os/" class="nav-link"><i class="undefined"></i>
  os
</a></li><li class="dropdown-item"><!----> <a href="/categories/engineering/" class="nav-link"><i class="undefined"></i>
  engineering
</a></li><li class="dropdown-item"><!----> <a href="/categories/tool/" class="nav-link"><i class="undefined"></i>
  tool
</a></li><li class="dropdown-item"><!----> <a href="/categories/language/" class="nav-link"><i class="undefined"></i>
  language
</a></li><li class="dropdown-item"><!----> <a href="/categories/decentralization/" class="nav-link"><i class="undefined"></i>
  decentralization
</a></li><li class="dropdown-item"><!----> <a href="/categories/architecture/" class="nav-link"><i class="undefined"></i>
  architecture
</a></li><li class="dropdown-item"><!----> <a href="/categories/network/" class="nav-link"><i class="undefined"></i>
  network
</a></li><li class="dropdown-item"><!----> <a href="/categories/software engineering/" class="nav-link"><i class="undefined"></i>
  software engineering
</a></li><li class="dropdown-item"><!----> <a href="/categories/notes/" class="nav-link"><i class="undefined"></i>
  notes
</a></li></ul></div></div><div class="nav-item"><a href="/tag/" class="nav-link"><i class="iconfont reco-tag"></i>
  标签
</a></div><div class="nav-item"><a href="/timeline/" class="nav-link"><i class="iconfont reco-date"></i>
  时间轴
</a></div><div class="nav-item"><a href="https://github.com/sammyne" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="iconfont reco-github"></i>
  Github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav></div></header> <div class="sidebar-mask" data-v-1156296a></div> <aside class="sidebar" data-v-1156296a><div class="personal-info-wrapper" data-v-828910c6 data-v-1156296a><img src="/avatar.png" alt="author-avatar" class="personal-img" data-v-828910c6> <h3 class="name" data-v-828910c6>
    sammyne
  </h3> <div class="num" data-v-828910c6><div data-v-828910c6><h3 data-v-828910c6>82</h3> <h6 data-v-828910c6>Articles</h6></div> <div data-v-828910c6><h3 data-v-828910c6>43</h3> <h6 data-v-828910c6>Tags</h6></div></div> <ul class="social-links" data-v-828910c6></ul> <hr data-v-828910c6></div> <nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link"><i class="iconfont reco-home"></i>
  首页
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-category"></i>
      分类
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/categories/dev/" class="nav-link"><i class="undefined"></i>
  dev
</a></li><li class="dropdown-item"><!----> <a href="/categories/crypto/" class="nav-link"><i class="undefined"></i>
  crypto
</a></li><li class="dropdown-item"><!----> <a href="/categories/programming/" class="nav-link"><i class="undefined"></i>
  programming
</a></li><li class="dropdown-item"><!----> <a href="/categories/tee/" class="nav-link"><i class="undefined"></i>
  tee
</a></li><li class="dropdown-item"><!----> <a href="/categories/os/" class="nav-link"><i class="undefined"></i>
  os
</a></li><li class="dropdown-item"><!----> <a href="/categories/engineering/" class="nav-link"><i class="undefined"></i>
  engineering
</a></li><li class="dropdown-item"><!----> <a href="/categories/tool/" class="nav-link"><i class="undefined"></i>
  tool
</a></li><li class="dropdown-item"><!----> <a href="/categories/language/" class="nav-link"><i class="undefined"></i>
  language
</a></li><li class="dropdown-item"><!----> <a href="/categories/decentralization/" class="nav-link"><i class="undefined"></i>
  decentralization
</a></li><li class="dropdown-item"><!----> <a href="/categories/architecture/" class="nav-link"><i class="undefined"></i>
  architecture
</a></li><li class="dropdown-item"><!----> <a href="/categories/network/" class="nav-link"><i class="undefined"></i>
  network
</a></li><li class="dropdown-item"><!----> <a href="/categories/software engineering/" class="nav-link"><i class="undefined"></i>
  software engineering
</a></li><li class="dropdown-item"><!----> <a href="/categories/notes/" class="nav-link"><i class="undefined"></i>
  notes
</a></li></ul></div></div><div class="nav-item"><a href="/tag/" class="nav-link"><i class="iconfont reco-tag"></i>
  标签
</a></div><div class="nav-item"><a href="/timeline/" class="nav-link"><i class="iconfont reco-date"></i>
  时间轴
</a></div><div class="nav-item"><a href="https://github.com/sammyne" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="iconfont reco-github"></i>
  Github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav> <!----> </aside> <div class="password-shadow password-wrapper-in" style="display:none;" data-v-4e82dffc data-v-1156296a><h3 class="title" data-v-4e82dffc data-v-4e82dffc>[iptables] 03. 规则管理</h3> <!----> <label id="box" class="inputBox" data-v-4e82dffc data-v-4e82dffc><input type="password" value="" data-v-4e82dffc> <span data-v-4e82dffc>Konck! Knock!</span> <button data-v-4e82dffc>OK</button></label> <div class="footer" data-v-4e82dffc data-v-4e82dffc><span data-v-4e82dffc><i class="iconfont reco-theme" data-v-4e82dffc></i> <a target="blank" href="https://vuepress-theme-reco.recoluan.com" data-v-4e82dffc>vuePress-theme-reco</a></span> <span data-v-4e82dffc><i class="iconfont reco-copyright" data-v-4e82dffc></i> <a data-v-4e82dffc><span data-v-4e82dffc>sammyne</span>
            
          <span data-v-4e82dffc>2020 - </span>
          2021
        </a></span></div></div> <div data-v-1156296a><main class="page"><section><div class="page-title"><h1 class="title">[iptables] 03. 规则管理</h1> <div data-v-1ff7123e><i class="iconfont reco-account" data-v-1ff7123e><span data-v-1ff7123e>sammyne</span></i> <i class="iconfont reco-date" data-v-1ff7123e><span data-v-1ff7123e>1/3/2021</span></i> <i class="iconfont reco-eye" data-v-1ff7123e><span id="/_post/iptables-03-rules-management/" data-flag-title="Your Article Title" class="leancloud-visitors" data-v-1ff7123e><a class="leancloud-visitors-count" style="font-size:.9rem;font-weight:normal;color:#999;"></a></span></i> <i class="tags iconfont reco-tag" data-v-1ff7123e><span class="tag-item" data-v-1ff7123e>iptables</span><span class="tag-item" data-v-1ff7123e>linux</span><span class="tag-item" data-v-1ff7123e>ops</span></i></div></div> <div class="theme-reco-content content__default"><div class="custom-block tip"><p class="title">温馨提示</p><p>本文从理论到实践，系统地介绍 iptables。如果你想要从头开始了解 iptables，可以查看 <a href="/tag/iptables/">iptables 系列文章</a>。</p></div><p><a href="/2021/01/03/iptables-02-exercise-listing-rules/">上一篇文章</a> 中，我们已经学会怎样使用 iptables 命令查看规则，那么这篇文章就来总结一下如何管理规则。</p> <p>之前我们把查看 iptables 规则的操作比作&quot;增删改查&quot;当中的&quot;查&quot;。那么这篇文章就聊聊怎样对 iptables 进行&quot;增、删、改&quot;操作。</p> <div class="custom-block danger"><p class="title">高能预警</p><p>在参照本文进行 iptables 实验时，请务必在个人的测试机上进行，因为如果 iptables 规则设置不当，有可能使你无法连接到远程主机。</p></div><h2 id="规则"><a href="#规则" class="header-anchor">#</a> 规则</h2> <p>首先回顾一下什么是 iptables 的规则。</p> <p>之前打过一个比方，每条&quot;链&quot;都是一个&quot;关卡&quot;，每个通过这个&quot;关卡&quot;的报文都要匹配这个关卡上的规则：如果匹配，则对报文进行对应的处理。比如说，你我二人此刻就好像两个&quot;报文&quot;，你我二人此刻都要入关。可是城主有命，只有器宇轩昂的人才能入关，不符合此条件的人不能入关。于是守关将士按照城主制定的&quot;规则&quot;，开始打量你我二人。最终，你顺利入关了，而我已被拒之门外。因为你符合&quot;器宇轩昂&quot;的标准，所以把你&quot;放行&quot;，而我不符合标准，所以没有被放行。其实，&quot;器宇轩昂&quot;就是一种 <strong>匹配条件</strong>，&quot;放行&quot;就是一种 <strong>动作</strong>，<strong>匹配条件</strong> 与 <strong>动作</strong> 组成规则。</p> <p>只不过 iptables 最常用的匹配条件并不是&quot;器宇轩昂&quot;，而是报文的&quot;源地址&quot;、&quot;目标地址&quot;、&quot;源端口&quot; 和 &quot;目标端口&quot;等。在 iptables 的世界中，最常用的动作有 <code>ACCEPT</code>（接受）、<code>DROP</code>（丢弃）、<code>REJECT</code>（拒绝）。其中 <code>ACCEPT</code> 就与我们举例的&quot;放行&quot;类似。但是刚才提到的这些并不是全部的匹配条件与动作，只是最常用的一些罢了。具体的匹配条件与动作不是今天讨论的重点，会在后续文章再做总结。</p> <p>规则的概念回顾完毕：规则大致由两个逻辑单元组成--<strong>匹配条件</strong> 与 <strong>动作</strong>。那么多说无益，我们来动手定义一条规则。此处仍然以 filter 表的 <code>INPUT</code> 链为例。因为 filter 表具有&quot;过滤&quot;功能，而所有发往本机的报文如果需要被过滤，首先会经过 <code>INPUT</code> 链（<code>PREROUTING</code> 链没有过滤功能），这与我们所比喻的&quot;入关&quot;场景非常相似，所以使用 filter 表的 <code>INPUT</code> 链为例有助于理解。</p> <p>首先，查看一下 filter 表的 <code>INPUT</code> 链的规则。查看规则的相关命令在 <a href="/2021/01/03/iptables-02-exercise-listing-rules/">前文</a> 已经总结，此处不再赘述。如果有遗忘，请回顾 <a href="/2021/01/03/iptables-02-exercise-listing-rules/">前文</a>。</p> <p>使用如下命令查看 filter 表 <code>INPUT</code> 链的规则，可见 ubuntu 默认为其设置没有任何规则。</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>root@ubuntu:/home/sammy<span class="token comment"># iptables -L</span>
Chain INPUT <span class="token punctuation">(</span>policy ACCEPT<span class="token punctuation">)</span>
target     prot opt <span class="token builtin class-name">source</span>               destination

Chain FORWARD <span class="token punctuation">(</span>policy ACCEPT<span class="token punctuation">)</span>
target     prot opt <span class="token builtin class-name">source</span>               destination

Chain OUTPUT <span class="token punctuation">(</span>policy ACCEPT<span class="token punctuation">)</span>
target     prot opt <span class="token builtin class-name">source</span>               destination
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><div class="custom-block danger"><p class="title">高能预警</p><p>在进行 iptables 实验时，请务必在测试机上进行。本文的实验操作环境为 VMware Fusion 12.0 下的 Ubuntu 20.04.1。</p></div><p>如果测试机器已有一些规则，则为了准备一个从零开始的环境，我们清空默认提供的规则，以便实验。使用 <code>iptables -F INPUT</code> 命令可清空 filter 表 <code>INPUT</code> 链的规则。后面会单独对清除规则的相关命令进行总结，此处暂且不深究此命令。</p> <p>清空 <code>INPUT</code> 链后，filter 表的 <code>INPUT</code> 链已经不存在任何规则。但是可以看到，<code>INPUT</code> 链的默认策略为 <code>ACCEPT</code>，也就是说，<code>INPUT</code> 链默认&quot;放行&quot;所有发往本机的报文：当没有任何规则时，会接受所有报文；当报文没有被任何规则匹配到时，也会默认放行报文。</p> <p>那么此刻，我们就在另外一台机器上，使用 <code>ping</code> 命令，向当前机器发送报文。如下所示，<code>ping</code> 命令可以得到回应，证明 <code>ping</code> 命令发送的报文已经正常的发送到防火墙所在的主机。其中，<code>ping</code> 命令所在机器 IP 地址为 <code>172.16.39.1</code>，当前测试防火墙主机的 IP 地址为 <code>172.16.39.2</code>。我们就用这样的环境对 iptables 进行操作演示。</p> <p>在 <code>172.16.39.1</code> 执行 <code>ping</code> 如下</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token function">ping</span> <span class="token number">172.16</span>.39.2
PING <span class="token number">172.16</span>.39.2 <span class="token punctuation">(</span><span class="token number">172.16</span>.39.2<span class="token punctuation">)</span>: <span class="token number">56</span> data bytes
<span class="token number">64</span> bytes from <span class="token number">172.16</span>.39.2: <span class="token assign-left variable">icmp_seq</span><span class="token operator">=</span><span class="token number">0</span> <span class="token assign-left variable">ttl</span><span class="token operator">=</span><span class="token number">64</span> <span class="token assign-left variable">time</span><span class="token operator">=</span><span class="token number">0.402</span> ms
<span class="token number">64</span> bytes from <span class="token number">172.16</span>.39.2: <span class="token assign-left variable">icmp_seq</span><span class="token operator">=</span><span class="token number">1</span> <span class="token assign-left variable">ttl</span><span class="token operator">=</span><span class="token number">64</span> <span class="token assign-left variable">time</span><span class="token operator">=</span><span class="token number">0.718</span> ms
<span class="token number">64</span> bytes from <span class="token number">172.16</span>.39.2: <span class="token assign-left variable">icmp_seq</span><span class="token operator">=</span><span class="token number">2</span> <span class="token assign-left variable">ttl</span><span class="token operator">=</span><span class="token number">64</span> <span class="token assign-left variable">time</span><span class="token operator">=</span><span class="token number">0.485</span> ms
<span class="token number">64</span> bytes from <span class="token number">172.16</span>.39.2: <span class="token assign-left variable">icmp_seq</span><span class="token operator">=</span><span class="token number">3</span> <span class="token assign-left variable">ttl</span><span class="token operator">=</span><span class="token number">64</span> <span class="token assign-left variable">time</span><span class="token operator">=</span><span class="token number">0.648</span> ms
^C
--- <span class="token number">172.16</span>.39.2 <span class="token function">ping</span> statistics ---
<span class="token number">4</span> packets transmitted, <span class="token number">4</span> packets received, <span class="token number">0.0</span>% packet loss
round-trip min/avg/max/stddev <span class="token operator">=</span> <span class="token number">0.402</span>/0.563/0.718/0.126 ms
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p><code>172.16.39.2</code> 在 <code>ping</code> 前后的数据统计如下</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token comment"># ping 之前</span>
root@ubuntu:/home/sammy<span class="token comment"># iptables -vL INPUT</span>
Chain INPUT <span class="token punctuation">(</span>policy ACCEPT <span class="token number">8</span> packets, <span class="token number">648</span> bytes<span class="token punctuation">)</span>
 pkts bytes target     prot opt <span class="token keyword">in</span>     out     <span class="token builtin class-name">source</span>               destination

<span class="token comment"># ping 之后</span>
root@ubuntu:/home/sammy<span class="token comment"># iptables -vL INPUT</span>
Chain INPUT <span class="token punctuation">(</span>policy ACCEPT <span class="token number">12</span> packets, <span class="token number">984</span> bytes<span class="token punctuation">)</span>
 pkts bytes target     prot opt <span class="token keyword">in</span>     out     <span class="token builtin class-name">source</span>               destination
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><h2 id="增加规则"><a href="#增加规则" class="header-anchor">#</a> 增加规则</h2> <p>那么此处，我们就在 <code>172.16.39.2</code> 的机器上配置一条规则，拒绝源自 <code>172.16.39.1</code> 的所有报文访问当前机器。之前一直说规则由 <strong>匹配条件</strong> 与 <strong>动作</strong> 组成，那么&quot;拒绝 <code>172.16.39.1</code> 的所有报文访问当前机器&quot;这条规则中，报文的&quot;源地址为 <code>172.16.39.1</code>&quot;则属于匹配条件。如果报文来自 <code>172.16.39.1</code>，则满足匹配条件，而&quot;拒绝&quot;这个报文就属于对应的动作。定义这条规则的命令如下</p> <div class="language-bash line-numbers-mode"><div class="highlight-lines"><div class="highlighted"> </div><br><br><br><br><br></div><pre class="language-bash"><code>root@ubuntu:/home/sammy<span class="token comment"># iptables -t filter -I INPUT -s 172.16.39.1 -j DROP</span>
root@ubuntu:/home/sammy<span class="token comment"># iptables -vL INPUT</span>
Chain INPUT <span class="token punctuation">(</span>policy ACCEPT <span class="token number">2</span> packets, <span class="token number">414</span> bytes<span class="token punctuation">)</span>
 pkts bytes target     prot opt <span class="token keyword">in</span>     out     <span class="token builtin class-name">source</span>               destination
    <span class="token number">0</span>     <span class="token number">0</span> DROP       all  --  any    any     xiangmins-mbp        anywhere
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>上述命令各个选项说明如下</p> <ul><li><code>-t</code> 指定了要操作的表。此处指定操作 filter 表，与之前的查看命令一样，不使用 <code>-t</code> 选项指定表时，默认为操作 filter 表。</li> <li><code>-I</code> 指明将&quot;规则&quot;插入至哪条链。<code>-I</code> 表示 insert，即插入的意思，所以 <code>-I INPUT</code> 表示将规则插入 <code>INPUT</code> 链，即添加规则之意。</li> <li><code>-s</code> 指明&quot;匹配条件&quot;中的&quot;源地址&quot;，即如果报文的源地址属于 <code>-s</code> 对应的地址，那么报文则满足匹配条件。<code>-s</code> 为 source 之意，表示源地址。</li> <li><code>-j</code> 指明满足&quot;匹配条件&quot;时，采取的对应动作。上例指定的动作为 <code>DROP</code>，当报文的源地址为 <code>172.16.39.1</code> 时，报文则被 <code>DROP</code>（丢弃）。</li></ul> <div class="custom-block tip"><p class="title">关于 destination 下的 anywhere</p><p>上面目标地址 <code>destination</code> 显示为 <code>anywhere</code> 是因为 iptables 默认进行了名称解析。在规则非常多的情况下进行名称解析，效率会比较低。所以，在没有此需求的情况下，我们可以使用 <code>-n</code> 选项，表示不对 IP 地址进行名称反解，直接显示 IP 地址，示例如下</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>root@ubuntu:/home/sammy<span class="token comment"># iptables -nvL INPUT</span>
Chain INPUT <span class="token punctuation">(</span>policy ACCEPT <span class="token number">7</span> packets, <span class="token number">1125</span> bytes<span class="token punctuation">)</span>
 pkts bytes target     prot opt <span class="token keyword">in</span>     out     <span class="token builtin class-name">source</span>               destination
    <span class="token number">0</span>     <span class="token number">0</span> DROP       all  --  *      *       <span class="token number">172.16</span>.39.1          <span class="token number">0.0</span>.0.0/0
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div></div><p>再次查看 filter 表的 <code>INPUT</code> 链，会发现规则已经被添加。在 iptables 中，动作被称为&quot;target&quot;，所以上面 <code>target</code> 字段对应的动作为 <code>DROP</code>。</p> <p>那么此时，我们再通过 <code>172.16.39.1</code> 去 <code>ping</code> 主机 <code>172.16.39.2</code>，看看能否 <code>ping</code> 通。</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token function">ping</span> <span class="token number">172.16</span>.39.2
PING <span class="token number">172.16</span>.39.2 <span class="token punctuation">(</span><span class="token number">172.16</span>.39.2<span class="token punctuation">)</span>: <span class="token number">56</span> data bytes
Request <span class="token function">timeout</span> <span class="token keyword">for</span> icmp_seq <span class="token number">0</span>
Request <span class="token function">timeout</span> <span class="token keyword">for</span> icmp_seq <span class="token number">1</span>
Request <span class="token function">timeout</span> <span class="token keyword">for</span> icmp_seq <span class="token number">2</span>
Request <span class="token function">timeout</span> <span class="token keyword">for</span> icmp_seq <span class="token number">3</span>
Request <span class="token function">timeout</span> <span class="token keyword">for</span> icmp_seq <span class="token number">4</span>
Request <span class="token function">timeout</span> <span class="token keyword">for</span> icmp_seq <span class="token number">5</span>
Request <span class="token function">timeout</span> <span class="token keyword">for</span> icmp_seq <span class="token number">6</span>
Request <span class="token function">timeout</span> <span class="token keyword">for</span> icmp_seq <span class="token number">7</span>
Request <span class="token function">timeout</span> <span class="token keyword">for</span> icmp_seq <span class="token number">8</span>
^C
--- <span class="token number">172.16</span>.39.2 <span class="token function">ping</span> statistics ---
<span class="token number">10</span> packets transmitted, <span class="token number">0</span> packets received, <span class="token number">100.0</span>% packet loss
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><p>由上可知，<code>ping 172.16.39.2</code> 主机时，<code>ping</code> 命令一直没有得到回应，看来我们的 iptables 规则已经生效，使得 <code>ping</code> 发送的报文压根没有被 <code>172.16.39.2</code> 主机接受，而是被丢弃了，所以更不要说什么回应了。至此，我们成功地配置了一条 iptables 规则，总算入门 ：）</p> <p>还记得 <a href="/2021/01/03/iptables-02-exercise-listing-rules/">前文</a> 说过的&quot;计数器&quot;吗？此时再次查看 iptables 的规则，会发现：已经有 10 个包被对应的规则匹配到，总计大小 840 bytes。</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>root@ubuntu:/home/sammy<span class="token comment"># iptables -vL INPUT</span>
Chain INPUT <span class="token punctuation">(</span>policy ACCEPT <span class="token number">5</span> packets, <span class="token number">416</span> bytes<span class="token punctuation">)</span>
 pkts bytes target     prot opt <span class="token keyword">in</span>     out     <span class="token builtin class-name">source</span>               destination
   <span class="token number">10</span>   <span class="token number">840</span> DROP       all  --  any    any     <span class="token number">172.16</span>.39.1          anywhere
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>此刻，我们来做一个实验。</p> <p>现在 <code>INPUT</code> 链已经存在一条规则，它拒绝所有来自 <code>172.16.39.1</code> 主机的报文。如果此时在这条规则之后再配置这样一条规则：接受所有来自 <code>172.16.39.1</code> 主机的报文。那么，iptables 是否会接受来自 <code>172.16.39.1</code> 主机的报文呢？动手试试。</p> <p>使用如下命令在 filter 表的 <code>INPUT</code> 链追加一条规则，这条规则表示接受所有来自 <code>172.16.39.1</code> 的发往本机的报文。</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>root@ubuntu:/home/sammy<span class="token comment"># iptables -A INPUT -s 172.16.39.1 -j ACCEPT</span>
root@ubuntu:/home/sammy<span class="token comment"># iptables -vL INPUT</span>
Chain INPUT <span class="token punctuation">(</span>policy ACCEPT <span class="token number">0</span> packets, <span class="token number">0</span> bytes<span class="token punctuation">)</span>
 pkts bytes target     prot opt <span class="token keyword">in</span>     out     <span class="token builtin class-name">source</span>               destination
   <span class="token number">11</span>   <span class="token number">946</span> DROP       all  --  any    any     <span class="token number">172.16</span>.39.1          anywhere
    <span class="token number">0</span>     <span class="token number">0</span> ACCEPT     all  --  any    any     <span class="token number">172.16</span>.39.1          anywhere
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>上述命令没有使用 <code>-t</code> 选项指定表，所以默认操作 filter 表。相关选项说明如下</p> <ul><li><code>-A</code> 表示在对应的链&quot;追加规则&quot;。<code>-A</code> 为 append 之意。<code>-A INPUT</code> 则表示在 <code>INPUT</code> 链追加规则
<ul><li>之前示例使用的 <code>-I</code> 选项则表示往链&quot;插入规则&quot;。两者本意都是添加一条规则，只是 <code>-A</code> 表示在链的 <strong>尾部</strong> 追加规则，<code>-I</code> 表示在链的 <strong>首部</strong> 插入规则而已。</li></ul></li> <li><code>-j</code> 指定当前规则对应的动作为 <code>ACCEPT</code>。</li></ul> <p>执行完添加规则的命令后，再次查看 <code>INPUT</code> 链，发现规则已经成功&quot;追加&quot;至 <code>INPUT</code> 链的末尾。现在第一条规则指明丢弃所有来自 <code>172.16.39.1</code> 的报文，第二条规则指明接受所有来自 <code>172.16.39.1</code> 的报文，那么结果到底是怎样的呢？实践出真知，在 <code>172.16.39.1</code> 主机上再次使用 <code>ping</code> 命令向 <code>172.16.39.2</code> 主机发送报文，发现仍然 <code>ping</code> 不通，看来第二条规则并没有生效。</p> <ul><li><p><code>172.16.39.1</code> 上的终端输出</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token function">ping</span> <span class="token number">172.16</span>.39.2
PING <span class="token number">172.16</span>.39.2 <span class="token punctuation">(</span><span class="token number">172.16</span>.39.2<span class="token punctuation">)</span>: <span class="token number">56</span> data bytes
Request <span class="token function">timeout</span> <span class="token keyword">for</span> icmp_seq <span class="token number">0</span>
Request <span class="token function">timeout</span> <span class="token keyword">for</span> icmp_seq <span class="token number">1</span>
Request <span class="token function">timeout</span> <span class="token keyword">for</span> icmp_seq <span class="token number">2</span>
^C
--- <span class="token number">172.16</span>.39.2 <span class="token function">ping</span> statistics ---
<span class="token number">4</span> packets transmitted, <span class="token number">0</span> packets received, <span class="token number">100.0</span>% packet loss
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div></li> <li><p><code>172.16.39.2</code> 的情况如下</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>root@ubuntu:/home/sammy<span class="token comment"># iptables -vL INPUT</span>
Chain INPUT <span class="token punctuation">(</span>policy ACCEPT <span class="token number">4</span> packets, <span class="token number">374</span> bytes<span class="token punctuation">)</span>
pkts bytes target     prot opt <span class="token keyword">in</span>     out     <span class="token builtin class-name">source</span>               destination
  <span class="token number">15</span>  <span class="token number">1282</span> DROP       all  --  any    any     <span class="token number">172.16</span>.39.1          anywhere
    <span class="token number">0</span>     <span class="token number">0</span> ACCEPT     all  --  any    any     <span class="token number">172.16</span>.39.1          anywhere
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div></li></ul> <p>而且从以上输出的第二条规则的计数器可以看到，其根本没有任何报文被第二条规则匹配到。</p> <p>聪明如你一定在猜想，发生上述情况，会不会与规则的先后顺序有关呢？测试一下：再添加一条规则，新规则仍然规定接受所有来自 <code>172.16.39.1</code> 主机的报文。只是这一次将新规则添加至 <code>INPUT</code> 链的最前面。</p> <p>在添加这条规则之前，我们先把 <code>172.16.39.1</code> 上的 <code>ping</code> 命令强制停止，然后使用如下命令，在 filter 表的 <code>INPUT</code> 链前端添加新规则。</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>root@ubuntu:/home/sammy<span class="token comment"># iptables -I INPUT -s 172.16.39.1 -j ACCEPT</span>
root@ubuntu:/home/sammy<span class="token comment"># iptables -vL INPUT</span>
Chain INPUT <span class="token punctuation">(</span>policy ACCEPT <span class="token number">0</span> packets, <span class="token number">0</span> bytes<span class="token punctuation">)</span>
 pkts bytes target     prot opt <span class="token keyword">in</span>     out     <span class="token builtin class-name">source</span>               destination
    <span class="token number">0</span>     <span class="token number">0</span> ACCEPT     all  --  any    any     <span class="token number">172.16</span>.39.1          anywhere
   <span class="token number">15</span>  <span class="token number">1282</span> DROP       all  --  any    any     <span class="token number">172.16</span>.39.1          anywhere
    <span class="token number">0</span>     <span class="token number">0</span> ACCEPT     all  --  any    any     <span class="token number">172.16</span>.39.1          anywhere
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>好了，现在第一条规则就是接受所有来自 <code>172.16.39.1</code> 的报文，而且此时计数是 0。此刻，我们再从 <code>172.16.39.1</code> 上向 <code>172.16.39.2</code> 发起 <code>ping</code> 请求。</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token function">ping</span> <span class="token number">172.16</span>.39.2
PING <span class="token number">172.16</span>.39.2 <span class="token punctuation">(</span><span class="token number">172.16</span>.39.2<span class="token punctuation">)</span>: <span class="token number">56</span> data bytes
<span class="token number">64</span> bytes from <span class="token number">172.16</span>.39.2: <span class="token assign-left variable">icmp_seq</span><span class="token operator">=</span><span class="token number">0</span> <span class="token assign-left variable">ttl</span><span class="token operator">=</span><span class="token number">64</span> <span class="token assign-left variable">time</span><span class="token operator">=</span><span class="token number">0.438</span> ms
<span class="token number">64</span> bytes from <span class="token number">172.16</span>.39.2: <span class="token assign-left variable">icmp_seq</span><span class="token operator">=</span><span class="token number">1</span> <span class="token assign-left variable">ttl</span><span class="token operator">=</span><span class="token number">64</span> <span class="token assign-left variable">time</span><span class="token operator">=</span><span class="token number">0.698</span> ms
<span class="token number">64</span> bytes from <span class="token number">172.16</span>.39.2: <span class="token assign-left variable">icmp_seq</span><span class="token operator">=</span><span class="token number">2</span> <span class="token assign-left variable">ttl</span><span class="token operator">=</span><span class="token number">64</span> <span class="token assign-left variable">time</span><span class="token operator">=</span><span class="token number">0.724</span> ms
^C
--- <span class="token number">172.16</span>.39.2 <span class="token function">ping</span> statistics ---
<span class="token number">3</span> packets transmitted, <span class="token number">3</span> packets received, <span class="token number">0.0</span>% packet loss
round-trip min/avg/max/stddev <span class="token operator">=</span> <span class="token number">0.438</span>/0.620/0.724/0.129 ms
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>可见 <code>172.16.39.1</code> 上已经可以正常地收到响应报文。那么回到 <code>172.16.39.2</code> 查看 <code>INPUT</code> 链的规则，第一条规则的计数器已经显示出匹配到的报文数量。</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>root@ubuntu:/home/sammy<span class="token comment"># iptables -vL INPUT</span>
Chain INPUT <span class="token punctuation">(</span>policy ACCEPT <span class="token number">6</span> packets, <span class="token number">561</span> bytes<span class="token punctuation">)</span>
 pkts bytes target     prot opt <span class="token keyword">in</span>     out     <span class="token builtin class-name">source</span>               destination
   <span class="token number">10</span>  <span class="token number">1314</span> ACCEPT     all  --  any    any     <span class="token number">172.16</span>.39.1          anywhere
   <span class="token number">15</span>  <span class="token number">1282</span> DROP       all  --  any    any     <span class="token number">172.16</span>.39.1          anywhere
    <span class="token number">0</span>     <span class="token number">0</span> ACCEPT     all  --  any    any     <span class="token number">172.16</span>.39.1          anywhere
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>可见，<strong>规则的顺序很重要</strong>：如果报文已经被前面的规则匹配到，iptables 则会对报文执行对应的动作。即使后面的规则也能匹配到当前报文，很有可能也没有机会再对报文执行相应的动作。以上为例，报文先被第一条规则匹配到，于是当前报文被&quot;放行&quot;。因为报文被放行，所以即使第二条规则能够匹配到刚才&quot;放行&quot;的报文，也没有机会再对刚才的报文进行丢弃操作。这就是 iptables 的工作机制。</p> <p>使用 <code>--line-number</code>（可简写为 <code>--line</code>）选项可以列出规则的序号，如下所示</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>iptables --line -vL INPUT
Chain INPUT <span class="token punctuation">(</span>policy ACCEPT <span class="token number">20</span> packets, <span class="token number">1855</span> bytes<span class="token punctuation">)</span>
num   pkts bytes target     prot opt <span class="token keyword">in</span>     out     <span class="token builtin class-name">source</span>               destination
<span class="token number">1</span>       <span class="token number">10</span>  <span class="token number">1314</span> ACCEPT     all  --  any    any     <span class="token number">172.16</span>.39.1          anywhere
<span class="token number">2</span>       <span class="token number">15</span>  <span class="token number">1282</span> DROP       all  --  any    any     <span class="token number">172.16</span>.39.1          anywhere
<span class="token number">3</span>        <span class="token number">0</span>     <span class="token number">0</span> ACCEPT     all  --  any    any     <span class="token number">172.16</span>.39.1          anywhere
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>我们也可以在添加规则时，指定新增规则的编号，这样能在任意位置插入规则。只要把刚才的命令稍作修改如下即可</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>root@ubuntu:/home/sammy<span class="token comment"># iptables -I INPUT 2 -s 172.16.39.1 -j DROP</span>
root@ubuntu:/home/sammy<span class="token comment"># iptables --line -vL INPUT</span>
Chain INPUT <span class="token punctuation">(</span>policy ACCEPT <span class="token number">0</span> packets, <span class="token number">0</span> bytes<span class="token punctuation">)</span>
num   pkts bytes target     prot opt <span class="token keyword">in</span>     out     <span class="token builtin class-name">source</span>               destination
<span class="token number">1</span>       <span class="token number">13</span>  <span class="token number">1548</span> ACCEPT     all  --  any    any     <span class="token number">172.16</span>.39.1          anywhere
<span class="token number">2</span>        <span class="token number">0</span>     <span class="token number">0</span> DROP       all  --  any    any     <span class="token number">172.16</span>.39.1          anywhere
<span class="token number">3</span>       <span class="token number">15</span>  <span class="token number">1282</span> DROP       all  --  any    any     <span class="token number">172.16</span>.39.1          anywhere
<span class="token number">4</span>        <span class="token number">0</span>     <span class="token number">0</span> ACCEPT     all  --  any    any     <span class="token number">172.16</span>.39.1          anywhere
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><ul><li><code>-I</code> 选项进行插入规则操作。<code>-I INPUT 2</code> 表示往 <code>INPUT</code> 链新增规则，新增规则的编号为 2。</li></ul> <h2 id="删除规则"><a href="#删除规则" class="header-anchor">#</a> 删除规则</h2> <div class="custom-block danger"><p class="title">高能预警</p><p>在进行 iptables 实验时，请务必在测试机上进行。本文的实验操作环境为 VMware Fusion 12.0 下的 Ubuntu 20.04.1。</p></div><p>如果此刻想要删除 filter 表中 <code>INPUT</code> 链的一条规则，该怎么做呢？</p> <p>有两种办法</p> <ul><li>根据规则的编号去删除规则</li> <li>根据具体的匹配条件与动作删除规则</li></ul> <p>先看看方法一，先查看一下 filter 表 <code>INPUT</code> 链的规则</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>root@ubuntu:/home/sammy<span class="token comment"># iptables --line -vL INPUT</span>
Chain INPUT <span class="token punctuation">(</span>policy ACCEPT <span class="token number">21</span> packets, <span class="token number">1912</span> bytes<span class="token punctuation">)</span>
num   pkts bytes target     prot opt <span class="token keyword">in</span>     out     <span class="token builtin class-name">source</span>               destination
<span class="token number">1</span>       <span class="token number">13</span>  <span class="token number">1548</span> ACCEPT     all  --  any    any     <span class="token number">172.16</span>.39.1          anywhere
<span class="token number">2</span>        <span class="token number">0</span>     <span class="token number">0</span> DROP       all  --  any    any     <span class="token number">172.16</span>.39.1          anywhere
<span class="token number">3</span>       <span class="token number">15</span>  <span class="token number">1282</span> DROP       all  --  any    any     <span class="token number">172.16</span>.39.1          anywhere
<span class="token number">4</span>        <span class="token number">0</span>     <span class="token number">0</span> ACCEPT     all  --  any    any     <span class="token number">172.16</span>.39.1          anywhere
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>假如想要删除第 4 条规则，可以使用如下命令。</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>root@ubuntu:/home/sammy<span class="token comment"># iptables -t filter -D INPUT 4</span>
root@ubuntu:/home/sammy<span class="token comment"># iptables --line -vL INPUT</span>
Chain INPUT <span class="token punctuation">(</span>policy ACCEPT <span class="token number">0</span> packets, <span class="token number">0</span> bytes<span class="token punctuation">)</span>
num   pkts bytes target     prot opt <span class="token keyword">in</span>     out     <span class="token builtin class-name">source</span>               destination
<span class="token number">1</span>       <span class="token number">13</span>  <span class="token number">1548</span> ACCEPT     all  --  any    any     <span class="token number">172.16</span>.39.1          anywhere
<span class="token number">2</span>        <span class="token number">0</span>     <span class="token number">0</span> DROP       all  --  any    any     <span class="token number">172.16</span>.39.1          anywhere
<span class="token number">3</span>       <span class="token number">15</span>  <span class="token number">1282</span> DROP       all  --  any    any     <span class="token number">172.16</span>.39.1          anywhere
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>上例各个选项说明如下</p> <ul><li><code>-t</code> 选项指定要操作的表（没错，省略 <code>-t</code> 默认表示操作 filter 表）</li> <li><code>-D</code> 选项表示删除指定链的某条规则。<code>-D INPUT 4</code> 表示删除 <code>INPUT</code> 链的第 4 条规则。</li></ul> <p>当然也可以根据具体的匹配条件与动作去删除规则。比如，删除源地址为 <code>172.16.39.1</code>，动作为 <code>ACCEPT</code> 的规则，对应命令如下</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>root@ubuntu:/home/sammy<span class="token comment"># iptables -D INPUT -s 172.16.39.1 -j ACCEPT</span>
root@ubuntu:/home/sammy<span class="token comment"># iptables --line -vL INPUT</span>
Chain INPUT <span class="token punctuation">(</span>policy ACCEPT <span class="token number">0</span> packets, <span class="token number">0</span> bytes<span class="token punctuation">)</span>
num   pkts bytes target     prot opt <span class="token keyword">in</span>     out     <span class="token builtin class-name">source</span>               destination
<span class="token number">1</span>        <span class="token number">0</span>     <span class="token number">0</span> DROP       all  --  any    any     <span class="token number">172.16</span>.39.1          anywhere
<span class="token number">2</span>       <span class="token number">15</span>  <span class="token number">1282</span> DROP       all  --  any    any     <span class="token number">172.16</span>.39.1          anywhere
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>上述命令的相关选项说明如下</p> <ul><li><code>-D</code> 选项表示删除指定链的某条规则。<code>-D INPUT</code> 表示删除 <code>INPUT</code> 链的规则。</li> <li><code>-s</code> 表示以对应的源地址作为匹配条件。</li> <li><code>-j ACCEPT</code> 表示对应的动作为接受。</li></ul> <p>综上，以上命令表示删除 <code>INPUT</code> 链中源地址为 <code>172.16.39.1</code>，动作为 <code>ACCEPT</code> 的规则。</p> <p>而删除指定表中某条链所有规则的命令在一开始就用到了：<code>iptables -t 表名 -F 链名</code>，其相关选项说明如下</p> <ul><li><code>-F</code> 选项为 flush 之意，即冲刷指定的链，删除指定链的所有规则
<ul><li><strong>注意</strong>：此操作相当于删除操作，没有保存 iptables 规则的情况下，请慎用。</li></ul></li></ul> <p>其实，<code>-F</code> 选项不仅仅能清空指定链的规则，还能清空整个表的所有链规则：不指定链名，只指定表名即可删除表的所有规则。命令如下</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>iptables -t 表名 -F
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><div class="custom-block warning"><p class="title">再次强调</p><p>在没有保存 iptables 规则时，请勿随便清空链或者表的规则，除非我们很清楚自己的所作所为。</p></div><h2 id="修改规则"><a href="#修改规则" class="header-anchor">#</a> 修改规则</h2> <div class="custom-block danger"><p class="title">高能预警</p><p>在进行 iptables 实验时，请务必在测试机上进行。本文的实验操作环境为 VMware Fusion 12.0 下的 Ubuntu 20.04.1。</p></div><p>怎样修改某条规则中的动作呢？比如，如何把如下规则的动作从 <code>DROP</code> 改为 <code>REJECT</code>？</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>root@ubuntu:/home/sammy<span class="token comment"># iptables --line -vL INPUT</span>
Chain INPUT <span class="token punctuation">(</span>policy ACCEPT <span class="token number">0</span> packets, <span class="token number">0</span> bytes<span class="token punctuation">)</span>
num   pkts bytes target     prot opt <span class="token keyword">in</span>     out     <span class="token builtin class-name">source</span>               destination
<span class="token number">1</span>        <span class="token number">0</span>     <span class="token number">0</span> DROP       all  --  any    any     <span class="token number">172.16</span>.39.1          anywhere
<span class="token number">2</span>       <span class="token number">15</span>  <span class="token number">1282</span> DROP       all  --  any    any     <span class="token number">172.16</span>.39.1          anywhere
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>使用 <code>-R</code> 选项可以修改指定链的规则。修改规则时指定规则对应的编号即可(<strong>有坑，慎行</strong>)，示例命令如下</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>root@ubuntu:/home/sammy<span class="token comment"># iptables -t filter -R INPUT 1 -s 172.16.39.1 -j REJECT</span>
root@ubuntu:/home/sammy<span class="token comment"># iptables --line -vL INPUT</span>
Chain INPUT <span class="token punctuation">(</span>policy ACCEPT <span class="token number">0</span> packets, <span class="token number">0</span> bytes<span class="token punctuation">)</span>
num   pkts bytes target     prot opt <span class="token keyword">in</span>     out     <span class="token builtin class-name">source</span>               destination
<span class="token number">1</span>        <span class="token number">0</span>     <span class="token number">0</span> REJECT     all  --  any    any     <span class="token number">172.16</span>.39.1          anywhere             reject-with icmp-port-unreachable
<span class="token number">2</span>       <span class="token number">15</span>  <span class="token number">1282</span> DROP       all  --  any    any     <span class="token number">172.16</span>.39.1          anywhere
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>相关选项说明如下</p> <ul><li><code>-R</code> 选项表示修改指定链。使用 <code>-R INPUT 1</code> 表示修改 <code>INPUT</code> 链的第 1 条规则</li> <li><code>-j REJECT</code> 表示将 <code>INPUT</code> 链第一条规则的动作修改为 <code>REJECT</code>。
<ul><li><strong>注意</strong>：<code>-s</code> 选项以及对应的源地址不可省略。即使我们已经指定规则对应的编号，但是在使用 <code>-R</code> 选项修改某个规则时，必须指定规则对应的原本匹配条件（如果有多个匹配条件，则需全部指定）。</li></ul></li></ul> <p>如果以上命令没有使用 <code>-s</code> 指定对应规则原本的源地址，那么在修改完成后，所修改规则的源地址会自动变为 <code>anywhere</code>（此 IP 表示匹配所有网段的 IP 地址）。而此时 <code>-j</code> 对应的动作又为 <code>REJECT</code>，所以在执行上述命令时没有指明规则原本的源地址的话，那么所有 IP 的请求都被拒绝（因为没有指定原本的源地址，当前规则的源地址自动变为 <code>anywhere</code>）。如果正在使用 ssh 远程到服务器上进行 iptables 设置，那么你的 ssh 请求也将会被阻断。</p> <p>既然使用 <code>-R</code> 选项修改规则时，必须指明规则原本的匹配条件，那么我们可以理解为：只能通过 <code>-R</code> 选项修改规则对应的动作了。所以个人觉得，如果想要修改某条规则，还不如先将这条规则删除，然后在同样位置再插入一条新规则。当然，如果只是为了修改某条规则的动作，那么使用 <code>-R</code> 选项时，千万不要忘了指明规则原本对应的匹配条件。</p> <p>上面已经将规则的动作从 <code>DROP</code> 改为 <code>REJECT</code>。那么 <code>DROP</code> 与 <code>REJECT</code> 有什么不同呢？从字面上理解，<code>DROP</code> 表示丢弃，而 <code>REJECT</code> 表示拒绝，意思好像更坚决一点。我们再次从 <code>172.16.39.1</code> 主机向 <code>172.16.39.2</code> 主机发起 <code>ping</code> 请求，看看与之前动作为 <code>DROP</code> 时有什么不同。</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token function">ping</span> <span class="token number">172.16</span>.39.2
PING <span class="token number">172.16</span>.39.2 <span class="token punctuation">(</span><span class="token number">172.16</span>.39.2<span class="token punctuation">)</span>: <span class="token number">56</span> data bytes
<span class="token number">92</span> bytes from <span class="token number">172.16</span>.39.2 <span class="token punctuation">(</span><span class="token number">172.16</span>.39.2<span class="token punctuation">)</span>: Destination Port Unreachable
Vr HL TOS  Len   ID Flg  off TTL Pro  cks      Src      Dst
 <span class="token number">4</span>  <span class="token number">5</span>  00 <span class="token number">5400</span> 942b   <span class="token number">0</span> 0000  <span class="token number">40</span>  01 405a <span class="token number">172.16</span>.39.1  <span class="token number">172.16</span>.39.2

Request <span class="token function">timeout</span> <span class="token keyword">for</span> icmp_seq <span class="token number">0</span>
<span class="token number">92</span> bytes from <span class="token number">172.16</span>.39.2 <span class="token punctuation">(</span><span class="token number">172.16</span>.39.2<span class="token punctuation">)</span>: Destination Port Unreachable
Vr HL TOS  Len   ID Flg  off TTL Pro  cks      Src      Dst
 <span class="token number">4</span>  <span class="token number">5</span>  00 <span class="token number">5400</span> b578   <span class="token number">0</span> 0000  <span class="token number">40</span>  01 1f0d <span class="token number">172.16</span>.39.1  <span class="token number">172.16</span>.39.2

Request <span class="token function">timeout</span> <span class="token keyword">for</span> icmp_seq <span class="token number">1</span>
<span class="token number">92</span> bytes from <span class="token number">172.16</span>.39.2 <span class="token punctuation">(</span><span class="token number">172.16</span>.39.2<span class="token punctuation">)</span>: Destination Port Unreachable
Vr HL TOS  Len   ID Flg  off TTL Pro  cks      Src      Dst
 <span class="token number">4</span>  <span class="token number">5</span>  00 <span class="token number">5400</span> 4f49   <span class="token number">0</span> 0000  <span class="token number">40</span>  01 853c <span class="token number">172.16</span>.39.1  <span class="token number">172.16</span>.39.2

^C
--- <span class="token number">172.16</span>.39.2 <span class="token function">ping</span> statistics ---
<span class="token number">3</span> packets transmitted, <span class="token number">0</span> packets received, <span class="token number">100.0</span>% packet loss
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><p>如上所示，当 <code>172.16.39.2</code> 主机的 iptables 规则对应的动作为 <code>REJECT</code>，从 <code>172.16.39.1</code> 上进行 <code>ping</code> 操作时，直接就提示 <code>Destination Port Unreachable</code>，并没有像之前那样超时。看来，<code>REJECT</code> 比 <code>DROP</code> 更加&quot;干脆&quot;。</p> <p>我们还可以修改指定链的&quot;默认策略&quot;。没错，就是下面第 2 行 <code>policy</code> 标注的默认策略。</p> <div class="language-bash line-numbers-mode"><div class="highlight-lines"><br><div class="highlighted"> </div><br><br><br><br><div class="highlighted"> </div><br><br><div class="highlighted"> </div><br><br></div><pre class="language-bash"><code>root@ubuntu:/home/sammy<span class="token comment"># iptables -vL</span>
Chain INPUT <span class="token punctuation">(</span>policy ACCEPT <span class="token number">6</span> packets, <span class="token number">546</span> bytes<span class="token punctuation">)</span>
 pkts bytes target     prot opt <span class="token keyword">in</span>     out     <span class="token builtin class-name">source</span>               destination
    <span class="token number">3</span>   <span class="token number">252</span> REJECT     all  --  any    any     <span class="token number">172.16</span>.39.1          anywhere             reject-with icmp-port-unreachable
   <span class="token number">15</span>  <span class="token number">1282</span> DROP       all  --  any    any     <span class="token number">172.16</span>.39.1          anywhere

Chain FORWARD <span class="token punctuation">(</span>policy ACCEPT <span class="token number">0</span> packets, <span class="token number">0</span> bytes<span class="token punctuation">)</span>
 pkts bytes target     prot opt <span class="token keyword">in</span>     out     <span class="token builtin class-name">source</span>               destination

Chain OUTPUT <span class="token punctuation">(</span>policy ACCEPT <span class="token number">9</span> packets, <span class="token number">882</span> bytes<span class="token punctuation">)</span>
 pkts bytes target     prot opt <span class="token keyword">in</span>     out     <span class="token builtin class-name">source</span>               destination
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>每张表的每条链都有自己的默认策略，也可以理解为默认&quot;动作&quot;。</p> <p>当报文没有被链的任何规则匹配到时，或者链没有任何规则时，防火墙会按照默认动作处理报文。指定链的默认策略可以使用如下命令修改</p> <div class="language-bash line-numbers-mode"><div class="highlight-lines"><br><br><br><br><br><br><br><div class="highlighted"> </div><br><br><br><br><br></div><pre class="language-bash"><code>root@ubuntu:/home/sammy<span class="token comment"># iptables -t filter -P FORWARD DROP</span>
root@ubuntu:/home/sammy<span class="token comment"># iptables -vL</span>
Chain INPUT <span class="token punctuation">(</span>policy ACCEPT <span class="token number">3</span> packets, <span class="token number">324</span> bytes<span class="token punctuation">)</span>
 pkts bytes target     prot opt <span class="token keyword">in</span>     out     <span class="token builtin class-name">source</span>               destination
    <span class="token number">4</span>   <span class="token number">330</span> REJECT     all  --  any    any     <span class="token number">172.16</span>.39.1          anywhere             reject-with icmp-port-unreachable
   <span class="token number">15</span>  <span class="token number">1282</span> DROP       all  --  any    any     <span class="token number">172.16</span>.39.1          anywhere

Chain FORWARD <span class="token punctuation">(</span>policy DROP <span class="token number">0</span> packets, <span class="token number">0</span> bytes<span class="token punctuation">)</span>
 pkts bytes target     prot opt <span class="token keyword">in</span>     out     <span class="token builtin class-name">source</span>               destination

Chain OUTPUT <span class="token punctuation">(</span>policy ACCEPT <span class="token number">5</span> packets, <span class="token number">442</span> bytes<span class="token punctuation">)</span>
 pkts bytes target     prot opt <span class="token keyword">in</span>     out     <span class="token builtin class-name">source</span>               destination
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p>相关选项说明如下</p> <ul><li><code>-t</code> 指定要操作的表</li> <li><code>-P</code> 选项指定要修改的链。<code>-P FORWARD DROP</code> 表示将表中 <code>FORWRD</code> 链的默认策略改为 <code>DROP</code>。</li></ul> <h2 id="保存规则"><a href="#保存规则" class="header-anchor">#</a> 保存规则</h2> <p>默认的情况下，对&quot;防火墙&quot;所做的修改都是&quot;临时的&quot;。换句话说，重启 iptables 服务或者重启服务器以后，平常添加的规则或者对规则所做出的修改都将消失。为了防止发生这种情况，需要将规则&quot;保存&quot;。</p> <p>CentOS 6 可使用 <code>service iptables save</code> 命令保存规则到 <code>/etc/sysconfig/iptables</code> 文件，但是 ubuntu 貌似和 CentOS 7 一样不再使用 init 风格的脚本启动服务，所以不行。听说想办法安装 iptables 与 iptables-services 即可（iptables 一般会预装，但是 ubuntu 一般不会预装 iptables-services）。既然系统升级后抛弃了 init 风格的脚本，那我们就跟着时代走，另寻其他通用的方法吧。</p> <h3 id="其他通用方法"><a href="#其他通用方法" class="header-anchor">#</a> 其他通用方法</h3> <p>使用 <code>iptables-save</code> 命令也能帮助保存 iptables 规则。它不能直接保存当前的 iptables 规则，但是可以将当前的 iptables 规则以&quot;保存后的格式&quot;输出到屏幕。</p> <p>所以，使用 <code>iptables-save</code> 命令配合重定向，将规则重定向到 <code>iptables.txt</code> 文件即可。</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>iptables-save <span class="token operator">&gt;</span> iptables.txt
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>我们也可以将 <code>iptables.txt</code> 的规则重新载入为当前的 iptables 规则。但是 <strong>注意</strong>：未保存入 <code>iptables.txt</code> 文件的修改将会丢失或者被覆盖。</p> <p>使用 <code>iptables-restore</code> 命令可以从指定文件重载规则，示例如下</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>iptables-restore <span class="token operator">&lt;</span> iptables.txt
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><div class="custom-block warning"><p class="title">再次提醒</p><p>重载规则时，现有规则将会被覆盖。</p></div><h2 id="命令小结"><a href="#命令小结" class="header-anchor">#</a> 命令小结</h2> <p>上文已经详细地举例并描述怎样进行 iptables 规则管理。为了便于以后速查，本文的相关命令总结一下。</p> <h3 id="添加规则"><a href="#添加规则" class="header-anchor">#</a> 添加规则</h3> <div class="custom-block tip"><p class="title">温馨提示</p><p>添加规则时，规则的顺序非常重要</p></div><ul><li><p>在指定表指定链的尾部添加一条规则</p> <ul><li><code>-A</code> 选项表示在对应链的末尾添加规则</li> <li>省略 <code>-t</code> 选项时，表示默认操作 filter 表的规则</li></ul> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>iptables -t 表名 -A 链名 匹配条件 -j 动作

<span class="token comment"># 示例</span>
<span class="token comment"># iptables -t filter -A INPUT -s 172.16.39.1 -j DROP</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div></li> <li><p>在指定表指定链的首部添加一条规则</p> <ul><li><code>-I</code> 选项表示在对应链的开头添加规则</li></ul> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>iptables -t 表名 -I 链名 匹配条件 -j 动作

<span class="token comment"># 示例</span>
<span class="token comment"># iptables -t filter -I INPUT -s 192.168.1.`172.16.39.1` -j ACCEPT</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div></li> <li><p>在指定表指定链的指定位置添加一条规则</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>iptables -t 表名 -I 链名 规则序号 匹配条件 -j 动作

<span class="token comment"># 示例</span>
<span class="token comment"># iptables -t filter -I INPUT 5 -s 192.168.1.`172.16.39.1` -j REJECT</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div></li> <li><p>设置指定表指定链的默认策略（默认动作），并非添加规则</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>iptables -t 表名 -P 链名 动作

<span class="token comment"># 示例：iptables -t filter -P FORWARD ACCEPT</span>
<span class="token comment"># 上例表示将 filter 表中 FORWARD 链的默认策略设置为 ACCEPT</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div></li></ul> <h3 id="删除规则-2"><a href="#删除规则-2" class="header-anchor">#</a> 删除规则</h3> <div class="custom-block danger"><p class="title">高能警告</p><p>如果没有保存规则，删除规则时请慎重</p></div><ul><li><p>按序号删除规则，删除指定表指定链的指定规则</p> <ul><li><code>-D</code> 选项表示删除对应链的规则。</li></ul> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>iptables -t 表名 -D 链名 规则序号

<span class="token comment"># 示例</span>
<span class="token comment"># iptables -t filter -D INPUT 3</span>
<span class="token comment"># 上述示例表示删除 filter 表中 INPUT 链中序号为 3 的规则。</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div></li> <li><p>按照具体的匹配条件与动作删除规则，删除指定表指定链的指定规则</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>iptables -t 表名 -D 链名 匹配条件 -j 动作

<span class="token comment"># 示例</span>
<span class="token comment"># iptables -t filter -D INPUT -s 192.168.1.`172.16.39.1` -j DROP</span>
<span class="token comment"># 上述示例表示删除 filter 表中 INPUT 链中源地址为 192.168.1.`172.16.39.1` 并且动作为 DROP 的规则。</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div></li> <li><p>删除指定表指定链的所有规则</p> <ul><li><code>-F</code> 选项表示清空对应链的规则，三思而后行</li></ul> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>iptables -t 表名 -F 链名

<span class="token comment"># 示例</span>
<span class="token comment"># iptables -t filter -F INPUT</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div></li> <li><p>删除指定表的所有规则，三思而后行</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>iptables -t 表名 -F

<span class="token comment"># 示例</span>
<span class="token comment"># iptables -t filter -F</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div></li></ul> <h3 id="修改规则-2"><a href="#修改规则-2" class="header-anchor">#</a> 修改规则</h3> <div class="custom-block tip"><p class="title">温馨提示</p><p>如果使用 <code>-R</code> 选项修改规则的动作，那么必须指明原规则的原匹配条件，例如源 IP，目标 IP 等。</p></div><ul><li><p>修改指定表中指定链的指定规则</p> <ul><li><code>-R</code> 选项表示修改对应链中的规则。使用 <code>-R</code> 选项时要同时指定对应的链以及规则对应的序号，并且规则原本的匹配条件不可省略。</li></ul> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>iptables -t 表名 -R 链名 规则序号 规则原本的匹配条件 -j 动作

<span class="token comment"># 示例</span>
<span class="token comment"># iptables -t filter -R INPUT 3 -s 172.16.39.1 -j ACCEPT</span>
<span class="token comment"># 上述示例表示修改 filter 表中 INPUT 链的第 3 条规则，将这条规则的动作修改为 ACCEPT， -s 192.168.1.`172.16.39.1` 为这条规则中原本的匹配条件，如果省略此匹配条件，修改后的规则中的源地址可能会变为 0.0.0.0/0。</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div></li> <li><p>其他修改规则的方法</p> <ul><li>先通过编号删除规则，再在原编号位置添加一条规则。</li></ul></li> <li><p>修改指定表指定链的默认策略（默认动作），并非修改规则，可以使用如下命令。</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>iptables -t 表名 -P 链名 动作

<span class="token comment"># 示例</span>
<span class="token comment"># iptables -t filter -P FORWARD ACCEPT</span>
<span class="token comment"># 上例表示将 filter 表中 FORWARD 链的默认策略修改为 ACCEPT</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div></li></ul> <h3 id="保存规则-2"><a href="#保存规则-2" class="header-anchor">#</a> 保存规则</h3> <p>保存规则命令如下，表示将 iptables 规则保存至 /etc/sysconfig/iptables 文件</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token function">service</span> iptables save
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>注意点：ubuntu 20.04.1 如果想要使用上述命令保存规则，需要安装 <code>iptables-services</code>，具体配置过程自救。</p> <p>或者使用如下 <strong>通用</strong> 方法保存规则</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>iptables-save <span class="token operator">&gt;</span> /etc/sysconfig/iptables
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>可以使用如下命令从指定的文件载入规则。注意：重载规则时，文件的规则将会覆盖现有规则。</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>iptables-restore <span class="token operator">&lt;</span> /etc/sysconfig/iptables
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>至此，本文已经总结如何添加、删除、修改 iptables 规则。与 <a href="/2021/01/03/iptables-02-exercise-listing-rules/">前文</a> 结合起来，我们已经掌握了对 iptables 规则的&quot;增删改查&quot;。同时，本文也总结了如何设置链的默认策略，以及怎样保存 iptables 规则。</p> <h2 id="参考文献"><a href="#参考文献" class="header-anchor">#</a> 参考文献</h2> <ul><li><a href="http://www.zsythink.net/archives/1517" target="_blank" rel="noopener noreferrer">iptables 详解（3）：iptables 规则管理<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></section> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">Last Updated: </span> <span class="time">4/18/2021, 1:52:33 AM</span></div></footer> <!----> <div class="comments-wrapper"><!----></div> <ul class="side-bar sub-sidebar-wrapper" style="width:12rem;" data-v-70334359><li class="level-2" data-v-70334359><a href="/_post/iptables-03-rules-management/#规则" class="sidebar-link reco-side-规则" data-v-70334359>规则</a></li><li class="level-2" data-v-70334359><a href="/_post/iptables-03-rules-management/#增加规则" class="sidebar-link reco-side-增加规则" data-v-70334359>增加规则</a></li><li class="level-2" data-v-70334359><a href="/_post/iptables-03-rules-management/#删除规则" class="sidebar-link reco-side-删除规则" data-v-70334359>删除规则</a></li><li class="level-2" data-v-70334359><a href="/_post/iptables-03-rules-management/#修改规则" class="sidebar-link reco-side-修改规则" data-v-70334359>修改规则</a></li><li class="level-2" data-v-70334359><a href="/_post/iptables-03-rules-management/#保存规则" class="sidebar-link reco-side-保存规则" data-v-70334359>保存规则</a></li><li class="level-3" data-v-70334359><a href="/_post/iptables-03-rules-management/#其他通用方法" class="sidebar-link reco-side-其他通用方法" data-v-70334359>其他通用方法</a></li><li class="level-2" data-v-70334359><a href="/_post/iptables-03-rules-management/#命令小结" class="sidebar-link reco-side-命令小结" data-v-70334359>命令小结</a></li><li class="level-3" data-v-70334359><a href="/_post/iptables-03-rules-management/#添加规则" class="sidebar-link reco-side-添加规则" data-v-70334359>添加规则</a></li><li class="level-3" data-v-70334359><a href="/_post/iptables-03-rules-management/#删除规则-2" class="sidebar-link reco-side-删除规则-2" data-v-70334359>删除规则</a></li><li class="level-3" data-v-70334359><a href="/_post/iptables-03-rules-management/#修改规则-2" class="sidebar-link reco-side-修改规则-2" data-v-70334359>修改规则</a></li><li class="level-3" data-v-70334359><a href="/_post/iptables-03-rules-management/#保存规则-2" class="sidebar-link reco-side-保存规则-2" data-v-70334359>保存规则</a></li><li class="level-2" data-v-70334359><a href="/_post/iptables-03-rules-management/#参考文献" class="sidebar-link reco-side-参考文献" data-v-70334359>参考文献</a></li></ul></main> <!----></div></div></div></div><div class="global-ui"><div class="back-to-ceiling" style="right:1rem;bottom:6rem;width:2.5rem;height:2.5rem;border-radius:.25rem;line-height:2.5rem;display:none;" data-v-c6073ba8 data-v-c6073ba8><svg t="1574745035067" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="5404" class="icon" data-v-c6073ba8><path d="M526.60727968 10.90185116a27.675 27.675 0 0 0-29.21455937 0c-131.36607665 82.28402758-218.69155461 228.01873535-218.69155402 394.07834331a462.20625001 462.20625001 0 0 0 5.36959153 69.94390903c1.00431239 6.55289093-0.34802892 13.13561351-3.76865779 18.80351572-32.63518765 54.11355614-51.75690182 118.55860487-51.7569018 187.94566865a371.06718723 371.06718723 0 0 0 11.50484808 91.98906777c6.53300375 25.50556257 41.68394495 28.14064038 52.69160883 4.22606766 17.37162448-37.73630017 42.14135425-72.50938081 72.80769204-103.21549295 2.18761121 3.04276886 4.15646224 6.24463696 6.40373557 9.22774369a1871.4375 1871.4375 0 0 0 140.04691725 5.34970492 1866.36093723 1866.36093723 0 0 0 140.04691723-5.34970492c2.24727335-2.98310674 4.21612437-6.18497483 6.3937923-9.2178004 30.66633723 30.70611158 55.4360664 65.4791928 72.80769147 103.21549355 11.00766384 23.91457269 46.15860503 21.27949489 52.69160879-4.22606768a371.15156223 371.15156223 0 0 0 11.514792-91.99901164c0-69.36717486-19.13165746-133.82216804-51.75690182-187.92578088-3.42062944-5.66790279-4.76302748-12.26056868-3.76865837-18.80351632a462.20625001 462.20625001 0 0 0 5.36959269-69.943909c-0.00994388-166.08943902-87.32547796-311.81420293-218.6915546-394.09823051zM605.93803103 357.87693858a93.93749974 93.93749974 0 1 1-187.89594924 6.1e-7 93.93749974 93.93749974 0 0 1 187.89594924-6.1e-7z" p-id="5405" data-v-c6073ba8></path><path d="M429.50777625 765.63860547C429.50777625 803.39355007 466.44236686 1000.39046097 512.00932183 1000.39046097c45.56695499 0 82.4922232-197.00623328 82.5015456-234.7518555 0-37.75494459-36.9345906-68.35043303-82.4922232-68.34111062-45.57627738-0.00932239-82.52019037 30.59548842-82.51086798 68.34111062z" p-id="5406" data-v-c6073ba8></path></svg></div></div></div>
    <script src="/assets/js/app.460084d6.js" defer></script><script src="/assets/js/3.df7e20a8.js" defer></script><script src="/assets/js/1.7ac9a612.js" defer></script><script src="/assets/js/68.1a70d0ba.js" defer></script>
  </body>
</html>
