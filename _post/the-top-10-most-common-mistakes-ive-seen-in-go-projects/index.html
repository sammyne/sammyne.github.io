<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>我在Go项目遇到的10大最常见误用 | sammyne</title>
    <meta name="generator" content="VuePress 1.8.1">
    <link rel="icon" href="/favicon.ico">
    <meta name="description" content="Just playing around :)">
    <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no">
    
    <link rel="preload" href="/assets/css/0.styles.a1b76618.css" as="style"><link rel="preload" href="/assets/js/app.460084d6.js" as="script"><link rel="preload" href="/assets/js/3.df7e20a8.js" as="script"><link rel="preload" href="/assets/js/1.7ac9a612.js" as="script"><link rel="preload" href="/assets/js/90.44315479.js" as="script"><link rel="prefetch" href="/assets/js/10.af14b39e.js"><link rel="prefetch" href="/assets/js/11.99ba64c8.js"><link rel="prefetch" href="/assets/js/12.34332094.js"><link rel="prefetch" href="/assets/js/13.1704bbed.js"><link rel="prefetch" href="/assets/js/14.11859fd4.js"><link rel="prefetch" href="/assets/js/15.d43300c2.js"><link rel="prefetch" href="/assets/js/16.3249b7d3.js"><link rel="prefetch" href="/assets/js/17.a01809f8.js"><link rel="prefetch" href="/assets/js/18.1dfec45f.js"><link rel="prefetch" href="/assets/js/19.f412f4f3.js"><link rel="prefetch" href="/assets/js/20.55e15a5f.js"><link rel="prefetch" href="/assets/js/21.c69cd7e0.js"><link rel="prefetch" href="/assets/js/22.cbffd43e.js"><link rel="prefetch" href="/assets/js/23.8b16fdf0.js"><link rel="prefetch" href="/assets/js/24.201c83d8.js"><link rel="prefetch" href="/assets/js/25.b41a1a47.js"><link rel="prefetch" href="/assets/js/26.0ed3e66c.js"><link rel="prefetch" href="/assets/js/27.7efc701f.js"><link rel="prefetch" href="/assets/js/28.72e1cd8a.js"><link rel="prefetch" href="/assets/js/29.0dced9b2.js"><link rel="prefetch" href="/assets/js/30.ab09489f.js"><link rel="prefetch" href="/assets/js/31.8c87f1ae.js"><link rel="prefetch" href="/assets/js/32.9007a3fd.js"><link rel="prefetch" href="/assets/js/33.f5646ecf.js"><link rel="prefetch" href="/assets/js/34.30466f73.js"><link rel="prefetch" href="/assets/js/35.5f43a455.js"><link rel="prefetch" href="/assets/js/36.605c0762.js"><link rel="prefetch" href="/assets/js/37.49a6b29b.js"><link rel="prefetch" href="/assets/js/38.9c0ceed6.js"><link rel="prefetch" href="/assets/js/39.833e25b8.js"><link rel="prefetch" href="/assets/js/4.33345026.js"><link rel="prefetch" href="/assets/js/40.62164fd4.js"><link rel="prefetch" href="/assets/js/41.6780bccd.js"><link rel="prefetch" href="/assets/js/42.a299958f.js"><link rel="prefetch" href="/assets/js/43.d7eb41dd.js"><link rel="prefetch" href="/assets/js/44.d2732739.js"><link rel="prefetch" href="/assets/js/45.26690fbb.js"><link rel="prefetch" href="/assets/js/46.9bafaf20.js"><link rel="prefetch" href="/assets/js/47.a788ae84.js"><link rel="prefetch" href="/assets/js/48.53199aae.js"><link rel="prefetch" href="/assets/js/49.93080943.js"><link rel="prefetch" href="/assets/js/5.da215b11.js"><link rel="prefetch" href="/assets/js/50.e2b156f3.js"><link rel="prefetch" href="/assets/js/51.7ca05ae4.js"><link rel="prefetch" href="/assets/js/52.8459aac5.js"><link rel="prefetch" href="/assets/js/53.7d8293f9.js"><link rel="prefetch" href="/assets/js/54.0e93b6fe.js"><link rel="prefetch" href="/assets/js/55.46fc1714.js"><link rel="prefetch" href="/assets/js/56.c8f25f54.js"><link rel="prefetch" href="/assets/js/57.cd09ca2f.js"><link rel="prefetch" href="/assets/js/58.810d1d6b.js"><link rel="prefetch" href="/assets/js/59.5e1237fd.js"><link rel="prefetch" href="/assets/js/6.0f93370d.js"><link rel="prefetch" href="/assets/js/60.4176824e.js"><link rel="prefetch" href="/assets/js/61.a7fe6954.js"><link rel="prefetch" href="/assets/js/62.7f7e45b1.js"><link rel="prefetch" href="/assets/js/63.ed2ba3d1.js"><link rel="prefetch" href="/assets/js/64.752309f8.js"><link rel="prefetch" href="/assets/js/65.18257448.js"><link rel="prefetch" href="/assets/js/66.47af013f.js"><link rel="prefetch" href="/assets/js/67.79be0219.js"><link rel="prefetch" href="/assets/js/68.1a70d0ba.js"><link rel="prefetch" href="/assets/js/69.899d158c.js"><link rel="prefetch" href="/assets/js/7.505b693a.js"><link rel="prefetch" href="/assets/js/70.a3db0124.js"><link rel="prefetch" href="/assets/js/71.7911f9d8.js"><link rel="prefetch" href="/assets/js/72.ca1b110f.js"><link rel="prefetch" href="/assets/js/73.78e18e89.js"><link rel="prefetch" href="/assets/js/74.5ff67c9e.js"><link rel="prefetch" href="/assets/js/75.aef53f06.js"><link rel="prefetch" href="/assets/js/76.e5510aea.js"><link rel="prefetch" href="/assets/js/77.abf8082a.js"><link rel="prefetch" href="/assets/js/78.a514a13d.js"><link rel="prefetch" href="/assets/js/79.c6fa750e.js"><link rel="prefetch" href="/assets/js/8.a4375844.js"><link rel="prefetch" href="/assets/js/80.9a33cbfe.js"><link rel="prefetch" href="/assets/js/81.c11dd67c.js"><link rel="prefetch" href="/assets/js/82.8648179e.js"><link rel="prefetch" href="/assets/js/83.2085ad68.js"><link rel="prefetch" href="/assets/js/84.a3c855af.js"><link rel="prefetch" href="/assets/js/85.2be7c107.js"><link rel="prefetch" href="/assets/js/86.ae61a023.js"><link rel="prefetch" href="/assets/js/87.da256952.js"><link rel="prefetch" href="/assets/js/88.63158169.js"><link rel="prefetch" href="/assets/js/89.cd89167a.js"><link rel="prefetch" href="/assets/js/9.acef0cc1.js"><link rel="prefetch" href="/assets/js/91.942e3147.js"><link rel="prefetch" href="/assets/js/92.5e611347.js">
    <link rel="stylesheet" href="/assets/css/0.styles.a1b76618.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container no-sidebar" data-v-1156296a><div data-v-1156296a><div id="loader-wrapper" class="loading-wrapper" data-v-d48f4d20 data-v-1156296a data-v-1156296a><div class="loader-main" data-v-d48f4d20><div data-v-d48f4d20></div><div data-v-d48f4d20></div><div data-v-d48f4d20></div><div data-v-d48f4d20></div></div> <!----> <!----></div> <div class="password-shadow password-wrapper-out" style="display:none;" data-v-4e82dffc data-v-1156296a data-v-1156296a><h3 class="title" data-v-4e82dffc data-v-4e82dffc>sammyne</h3> <p class="description" data-v-4e82dffc data-v-4e82dffc>Just playing around :)</p> <label id="box" class="inputBox" data-v-4e82dffc data-v-4e82dffc><input type="password" value="" data-v-4e82dffc> <span data-v-4e82dffc>Konck! Knock!</span> <button data-v-4e82dffc>OK</button></label> <div class="footer" data-v-4e82dffc data-v-4e82dffc><span data-v-4e82dffc><i class="iconfont reco-theme" data-v-4e82dffc></i> <a target="blank" href="https://vuepress-theme-reco.recoluan.com" data-v-4e82dffc>vuePress-theme-reco</a></span> <span data-v-4e82dffc><i class="iconfont reco-copyright" data-v-4e82dffc></i> <a data-v-4e82dffc><span data-v-4e82dffc>sammyne</span>
            
          <span data-v-4e82dffc>2020 - </span>
          2021
        </a></span></div></div> <div class="hide" data-v-1156296a><header class="navbar" data-v-1156296a><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/logo.svg" alt="sammyne" class="logo"> <span class="site-name">sammyne</span></a> <div class="links"><div class="color-picker"><a class="color-button"><i class="iconfont reco-color"></i></a> <div class="color-picker-menu" style="display:none;"><div class="mode-options"><h4 class="title">Choose mode</h4> <ul class="color-mode-options"><li class="dark">dark</li><li class="auto active">auto</li><li class="light">light</li></ul></div></div></div> <div class="search-box"><i class="iconfont reco-search"></i> <input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link"><i class="iconfont reco-home"></i>
  首页
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-category"></i>
      分类
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/categories/dev/" class="nav-link"><i class="undefined"></i>
  dev
</a></li><li class="dropdown-item"><!----> <a href="/categories/crypto/" class="nav-link"><i class="undefined"></i>
  crypto
</a></li><li class="dropdown-item"><!----> <a href="/categories/programming/" class="nav-link"><i class="undefined"></i>
  programming
</a></li><li class="dropdown-item"><!----> <a href="/categories/tee/" class="nav-link"><i class="undefined"></i>
  tee
</a></li><li class="dropdown-item"><!----> <a href="/categories/os/" class="nav-link"><i class="undefined"></i>
  os
</a></li><li class="dropdown-item"><!----> <a href="/categories/engineering/" class="nav-link"><i class="undefined"></i>
  engineering
</a></li><li class="dropdown-item"><!----> <a href="/categories/tool/" class="nav-link"><i class="undefined"></i>
  tool
</a></li><li class="dropdown-item"><!----> <a href="/categories/language/" class="nav-link"><i class="undefined"></i>
  language
</a></li><li class="dropdown-item"><!----> <a href="/categories/decentralization/" class="nav-link"><i class="undefined"></i>
  decentralization
</a></li><li class="dropdown-item"><!----> <a href="/categories/architecture/" class="nav-link"><i class="undefined"></i>
  architecture
</a></li><li class="dropdown-item"><!----> <a href="/categories/network/" class="nav-link"><i class="undefined"></i>
  network
</a></li><li class="dropdown-item"><!----> <a href="/categories/software engineering/" class="nav-link"><i class="undefined"></i>
  software engineering
</a></li><li class="dropdown-item"><!----> <a href="/categories/notes/" class="nav-link"><i class="undefined"></i>
  notes
</a></li></ul></div></div><div class="nav-item"><a href="/tag/" class="nav-link"><i class="iconfont reco-tag"></i>
  标签
</a></div><div class="nav-item"><a href="/timeline/" class="nav-link"><i class="iconfont reco-date"></i>
  时间轴
</a></div><div class="nav-item"><a href="https://github.com/sammyne" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="iconfont reco-github"></i>
  Github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav></div></header> <div class="sidebar-mask" data-v-1156296a></div> <aside class="sidebar" data-v-1156296a><div class="personal-info-wrapper" data-v-828910c6 data-v-1156296a><img src="/avatar.png" alt="author-avatar" class="personal-img" data-v-828910c6> <h3 class="name" data-v-828910c6>
    sammyne
  </h3> <div class="num" data-v-828910c6><div data-v-828910c6><h3 data-v-828910c6>82</h3> <h6 data-v-828910c6>Articles</h6></div> <div data-v-828910c6><h3 data-v-828910c6>43</h3> <h6 data-v-828910c6>Tags</h6></div></div> <ul class="social-links" data-v-828910c6></ul> <hr data-v-828910c6></div> <nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link"><i class="iconfont reco-home"></i>
  首页
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-category"></i>
      分类
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/categories/dev/" class="nav-link"><i class="undefined"></i>
  dev
</a></li><li class="dropdown-item"><!----> <a href="/categories/crypto/" class="nav-link"><i class="undefined"></i>
  crypto
</a></li><li class="dropdown-item"><!----> <a href="/categories/programming/" class="nav-link"><i class="undefined"></i>
  programming
</a></li><li class="dropdown-item"><!----> <a href="/categories/tee/" class="nav-link"><i class="undefined"></i>
  tee
</a></li><li class="dropdown-item"><!----> <a href="/categories/os/" class="nav-link"><i class="undefined"></i>
  os
</a></li><li class="dropdown-item"><!----> <a href="/categories/engineering/" class="nav-link"><i class="undefined"></i>
  engineering
</a></li><li class="dropdown-item"><!----> <a href="/categories/tool/" class="nav-link"><i class="undefined"></i>
  tool
</a></li><li class="dropdown-item"><!----> <a href="/categories/language/" class="nav-link"><i class="undefined"></i>
  language
</a></li><li class="dropdown-item"><!----> <a href="/categories/decentralization/" class="nav-link"><i class="undefined"></i>
  decentralization
</a></li><li class="dropdown-item"><!----> <a href="/categories/architecture/" class="nav-link"><i class="undefined"></i>
  architecture
</a></li><li class="dropdown-item"><!----> <a href="/categories/network/" class="nav-link"><i class="undefined"></i>
  network
</a></li><li class="dropdown-item"><!----> <a href="/categories/software engineering/" class="nav-link"><i class="undefined"></i>
  software engineering
</a></li><li class="dropdown-item"><!----> <a href="/categories/notes/" class="nav-link"><i class="undefined"></i>
  notes
</a></li></ul></div></div><div class="nav-item"><a href="/tag/" class="nav-link"><i class="iconfont reco-tag"></i>
  标签
</a></div><div class="nav-item"><a href="/timeline/" class="nav-link"><i class="iconfont reco-date"></i>
  时间轴
</a></div><div class="nav-item"><a href="https://github.com/sammyne" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="iconfont reco-github"></i>
  Github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav> <!----> </aside> <div class="password-shadow password-wrapper-in" style="display:none;" data-v-4e82dffc data-v-1156296a><h3 class="title" data-v-4e82dffc data-v-4e82dffc>我在Go项目遇到的10大最常见误用</h3> <!----> <label id="box" class="inputBox" data-v-4e82dffc data-v-4e82dffc><input type="password" value="" data-v-4e82dffc> <span data-v-4e82dffc>Konck! Knock!</span> <button data-v-4e82dffc>OK</button></label> <div class="footer" data-v-4e82dffc data-v-4e82dffc><span data-v-4e82dffc><i class="iconfont reco-theme" data-v-4e82dffc></i> <a target="blank" href="https://vuepress-theme-reco.recoluan.com" data-v-4e82dffc>vuePress-theme-reco</a></span> <span data-v-4e82dffc><i class="iconfont reco-copyright" data-v-4e82dffc></i> <a data-v-4e82dffc><span data-v-4e82dffc>sammyne</span>
            
          <span data-v-4e82dffc>2020 - </span>
          2021
        </a></span></div></div> <div data-v-1156296a><main class="page"><section><div class="page-title"><h1 class="title">我在Go项目遇到的10大最常见误用</h1> <div data-v-1ff7123e><i class="iconfont reco-account" data-v-1ff7123e><span data-v-1ff7123e>sammyne</span></i> <i class="iconfont reco-date" data-v-1ff7123e><span data-v-1ff7123e>7/20/2019</span></i> <i class="iconfont reco-eye" data-v-1ff7123e><span id="/_post/the-top-10-most-common-mistakes-ive-seen-in-go-projects/" data-flag-title="Your Article Title" class="leancloud-visitors" data-v-1ff7123e><a class="leancloud-visitors-count" style="font-size:.9rem;font-weight:normal;color:#999;"></a></span></i> <i class="tags iconfont reco-tag" data-v-1ff7123e><span class="tag-item" data-v-1ff7123e>golang</span></i></div></div> <div class="theme-reco-content content__default"><blockquote><p>原文：<a href="https://itnext.io/the-top-10-most-common-mistakes-ive-seen-in-go-projects-4b79d4f6cd65" target="_blank" rel="noopener noreferrer">The Top 10 Most Common Mistakes I’ve Seen in Go Projects<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p></blockquote> <p>这篇博文列举我在 go 项目中遇到的最常见误用。描述顺序和主次无关。</p> <h2 id="表示-未知-的枚举值"><a href="#表示-未知-的枚举值" class="header-anchor">#</a> 表示&quot;未知&quot;的枚举值</h2> <p>看个简单例子：</p> <div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">type</span> Status <span class="token builtin">uint32</span>

<span class="token keyword">const</span> <span class="token punctuation">(</span>
	StatusOpen Status <span class="token operator">=</span> <span class="token boolean">iota</span>
	StatusClosed
	StatusUnknown
<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>这里用<code>iota</code>创建了一种枚举类型，产生以下效果：</p> <div class="language-go line-numbers-mode"><pre class="language-go"><code>StatusOpen <span class="token operator">=</span> <span class="token number">0</span>
StatusClosed <span class="token operator">=</span> <span class="token number">1</span>
StatusUnknown <span class="token operator">=</span> <span class="token number">2</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>设想<code>Status</code>类型作为JSON请求的一部分，会被序列化/反序列化的情况。我们可以为此设计以下数据结构：</p> <div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">type</span> Request <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	ID        <span class="token builtin">int</span>    <span class="token string">`json:&quot;Id&quot;`</span>
	Timestamp <span class="token builtin">int</span>    <span class="token string">`json:&quot;Timestamp&quot;`</span>
	Status    Status <span class="token string">`json:&quot;Status&quot;`</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>从而得到类似如下形式的请求：</p> <div class="language-json line-numbers-mode"><pre class="language-json"><code><span class="token punctuation">{</span>
  <span class="token property">&quot;Id&quot;</span><span class="token operator">:</span> <span class="token number">1234</span><span class="token punctuation">,</span>
  <span class="token property">&quot;Timestamp&quot;</span><span class="token operator">:</span> <span class="token number">1563362390</span><span class="token punctuation">,</span>
  <span class="token property">&quot;Status&quot;</span><span class="token operator">:</span> <span class="token number">0</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>目前为止，一次寻常，<code>status</code>会被反序列化为<code>StatusOpen</code>。</p> <p>那么，再看这样一个请求，它的<code>status</code>留空（因为某某原因）：</p> <div class="language-json line-numbers-mode"><pre class="language-json"><code><span class="token punctuation">{</span>
  <span class="token property">&quot;Id&quot;</span><span class="token operator">:</span> <span class="token number">1235</span><span class="token punctuation">,</span>
  <span class="token property">&quot;Timestamp&quot;</span><span class="token operator">:</span> <span class="token number">1563362390</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>这种情况下，<code>Request</code>的<code>Status</code>字段会被初始化为<strong>零值</strong>（<code>uint32</code>的零值为<code>0</code>），即被设置为<code>StatusOpen</code>而不是<code>StatusUnknown</code>。</p> <p>最佳实践往往是将表示“未知”状态的值设为<code>0</code>对应的枚举值：</p> <div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">type</span> Status <span class="token builtin">uint32</span>

<span class="token keyword">const</span> <span class="token punctuation">(</span>
	StatusUnknown Status <span class="token operator">=</span> <span class="token boolean">iota</span>
	StatusOpen
	StatusClosed
<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>此时，如果<code>status</code>不是 JSON 请求的一部分，它会按预期被初始化为<code>StatusUnknown</code>。</p> <h2 id="性能测试"><a href="#性能测试" class="header-anchor">#</a> 性能测试</h2> <p>正确地测试性能难度挺大的。影响给定结果的因素多种多样。</p> <p>常见错误之一来自某些编译器优化作怪。以 <a href="https://github.com/teivah/bitvector/?source=post_page---------------------------" target="_blank" rel="noopener noreferrer">teivah/bitvector<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 的实例来看：</p> <div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">clear</span><span class="token punctuation">(</span>n <span class="token builtin">uint64</span><span class="token punctuation">,</span> i<span class="token punctuation">,</span> j <span class="token builtin">uint8</span><span class="token punctuation">)</span> <span class="token builtin">uint64</span> <span class="token punctuation">{</span>
	<span class="token keyword">return</span> <span class="token punctuation">(</span>math<span class="token punctuation">.</span>MaxUint64<span class="token operator">&lt;&lt;</span>j <span class="token operator">|</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">&lt;&lt;</span> i<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> n
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>这个函数将特定范围内的比特置 0。为了测试它的性能，我们的代码可能如下：</p> <div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">BenchmarkWrong</span><span class="token punctuation">(</span>b <span class="token operator">*</span>testing<span class="token punctuation">.</span>B<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> b<span class="token punctuation">.</span>N<span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">{</span>
		<span class="token function">clear</span><span class="token punctuation">(</span><span class="token number">1221892080809121</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">63</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>这个性能测试中，编译器发现<code>clear</code>是个叶子函数（没有调用其他函数）后会内联它。一旦这个函数被内联，编译器进一步发现不会产生<strong>副作用</strong>。因此，<code>clear</code>就会被移除而产生不准确的结果。</p> <p>一个应对方法是将结果赋给某个全局变量：</p> <div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">var</span> result <span class="token builtin">uint64</span>

<span class="token keyword">func</span> <span class="token function">BenchmarkCorrect</span><span class="token punctuation">(</span>b <span class="token operator">*</span>testing<span class="token punctuation">.</span>B<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">var</span> r <span class="token builtin">uint64</span>
	<span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> b<span class="token punctuation">.</span>N<span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">{</span>
		r <span class="token operator">=</span> <span class="token function">clear</span><span class="token punctuation">(</span><span class="token number">1221892080809121</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">63</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	result <span class="token operator">=</span> r
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>此时，编译器无法推断这个调用是否会产生副作用，使得性能测试变得准确的。</p> <h3 id="延伸阅读"><a href="#延伸阅读" class="header-anchor">#</a> 延伸阅读</h3> <blockquote><p><a href="https://dave.cheney.net/high-performance-go-workshop/dotgo-paris.html?source=post_page---------------------------#watch_out_for_compiler_optimisations" target="_blank" rel="noopener noreferrer">High Performance Go Workshop<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a><br>
Watch out for compiler optimisations.<br>
-- dave.cheney.net</p></blockquote> <h2 id="遍地指针"><a href="#遍地指针" class="header-anchor">#</a> 遍地指针</h2> <p>值传递会创建这个变量的一个副本，而指针传递则只会拷贝相应的内存地址。</p> <p>因此，指针传递总是更快的，对吧？</p> <p>如果你是这么认为的，请看看<a href="https://gist.github.com/teivah/a32a8e9039314a48f03538f3f9535537?source=post_page---------------------------" target="_blank" rel="noopener noreferrer">这个例子<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>。这项性能测试对比对一个 0.3KB 的数据结构传指针和传值得对比。0.3KB 不大，但和我们大多数日常所见的数据结构类型差不多。</p> <p>个人本地机器运行这些性能测试后，发现值传递比指针传递要快 <strong>4 倍多</strong>。是否觉得有点反常的样子？</p> <p>对结果的原因分析涉及到 Go 管理内存的方式。我做不到 <a href="https://www.ardanlabs.com/blog/2017/05/language-mechanics-on-stacks-and-pointers.html?source=post_page---------------------------" target="_blank" rel="noopener noreferrer">William Kennedy<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>大 神那般精彩绝伦的讲解，但是姑且归纳如下。</p> <p>变量会被分配在<strong>堆</strong>或<strong>栈</strong>上。可简略地总结为：</p> <ul><li>栈存储特定<strong>协程</strong>执行过程<strong>实时所需</strong>的变量。函数一旦返回（译者注：应该是指变量涉及的步骤执行完），变量就会被出栈</li> <li>堆存储<strong>共享</strong>变量（全局变量等）</li></ul> <p>看到返回值的简单例子：</p> <div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">getFooValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span> foo <span class="token punctuation">{</span>
	<span class="token keyword">var</span> result foo
	<span class="token comment">// Do something</span>
	<span class="token keyword">return</span> result
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>这里，<code>result</code>变量在当前协程中创建。变量会被压入协程的栈空间。一旦函数返回，客户端会收到这个值的一个副本。变量本身会出栈。它会一直存在内存直至被其它值覆盖，但是<strong>已经无法被访问了</strong>。</p> <p>对应地，返回指针的例子：</p> <div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">getFooPointer</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span>foo <span class="token punctuation">{</span>
	<span class="token keyword">var</span> result foo
	<span class="token comment">// Do something</span>
	<span class="token keyword">return</span> <span class="token operator">&amp;</span>result
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p><code>result</code>变量仍然是在当前协程中创建，但是客户端会收到一个指针（变量地址的副本）。<code>result</code>变量出栈的话，就<strong>无法</strong>再被客户端<strong>访问</strong>。</p> <p>对于这种情形，Go 编译器会为<code>result</code>变量执行逃逸操作，把它放到共享变量区：<strong>堆</strong>。</p> <p>指针传递还有一种情形如下：</p> <div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token punctuation">{</span>
	p <span class="token operator">:=</span> <span class="token operator">&amp;</span>foo<span class="token punctuation">{</span><span class="token punctuation">}</span>
	<span class="token function">f</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>由于<code>f</code>在同一协程内调用，<code>p</code>变量无须逃逸操作。<code>p</code>只需压入栈以供后续函数访问即可。</p> <p>那为啥栈会如此<strong>快</strong>呢？理由主要有二：</p> <ul><li>栈不依赖<strong>垃圾回收器</strong>。如我们所见，变量在创建时入栈，在函数返回后出栈，不会涉及复杂的流程用于重新获取无用的变量等</li> <li>栈只属于一个协程，所以和堆对比，存储变量时不用进行同步。这也有助性能提升</li></ul> <p>综上，创建函数时，默认选项应该是<strong>值而不是指针</strong>。指针只有在需要共享变量时使用。</p> <p>遇到性能问题时，一个备选项是分析某些特定情形下指针能否派上用场。通过<code>go build -gcflags &quot;-m -m&quot;</code>命令可以查看编译器何时会对变量进行逃逸操作。</p> <p>但是，对于日常使用，值基本够了。</p> <h3 id="延伸阅读-2"><a href="#延伸阅读-2" class="header-anchor">#</a> 延伸阅读</h3> <blockquote><p><a href="https://www.ardanlabs.com/blog/2017/05/language-mechanics-on-stacks-and-pointers.html?source=post_page---------------------------" target="_blank" rel="noopener noreferrer">Language Mechanics On Stacks And Pointers<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a><br>
Prelude This is the first post in a four part series that will provide an understanding of the mechanics and design...
-- www.ardanlabs.com</p></blockquote> <blockquote><p><a href="https://youtu.be/ZMZpH4yT7M0" target="_blank" rel="noopener noreferrer">Understanding Allocations: the Stack and the Heap - GopherCon SG 2019<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p></blockquote> <h2 id="breaking-a-for-switch-or-a-for-select"><a href="#breaking-a-for-switch-or-a-for-select" class="header-anchor">#</a> Breaking a <code>for</code>/<code>switch</code> or a <code>for</code>/<code>select</code></h2> <p><code>f()</code>返回<code>true</code>时下面的程序会如何执行：</p> <div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">for</span> <span class="token punctuation">{</span>
  <span class="token keyword">switch</span> <span class="token function">f</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">case</span> <span class="token boolean">true</span><span class="token punctuation">:</span>
    <span class="token keyword">break</span>
  <span class="token keyword">case</span> <span class="token boolean">false</span><span class="token punctuation">:</span>
    <span class="token comment">// Do something</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p><code>break</code>会执行，然后跳出<code>switch</code>语句，但<strong>不是 <code>for</code> 循环</strong>。</p> <p>类似问题代码：</p> <div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">for</span> <span class="token punctuation">{</span>
  <span class="token keyword">select</span> <span class="token punctuation">{</span>
  <span class="token keyword">case</span> <span class="token operator">&lt;-</span>ch<span class="token punctuation">:</span>
  <span class="token comment">// Do something</span>
  <span class="token keyword">case</span> <span class="token operator">&lt;-</span>ctx<span class="token punctuation">.</span><span class="token function">Done</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">break</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p><code>break</code>只会跳出<code>select</code>语句，而不是for循环。</p> <p>应对这种<code>for</code>/<code>switch</code>或<code>for</code>/<code>select</code>的方法之一是采用 <strong>标记型 <code>break</code></strong> 如下：</p> <div class="language-go line-numbers-mode"><pre class="language-go"><code>loop<span class="token punctuation">:</span>
	<span class="token keyword">for</span> <span class="token punctuation">{</span>
		<span class="token keyword">select</span> <span class="token punctuation">{</span>
		<span class="token keyword">case</span> <span class="token operator">&lt;-</span>ch<span class="token punctuation">:</span>
		<span class="token comment">// Do something</span>
		<span class="token keyword">case</span> <span class="token operator">&lt;-</span>ctx<span class="token punctuation">.</span><span class="token function">Done</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
			<span class="token keyword">break</span> loop
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><h2 id="错误处理"><a href="#错误处理" class="header-anchor">#</a> 错误处理</h2> <p>Go 在错误处理方面的经验还是比较少的。因此错误处理成为 Go 2 最让人期待的特性是有道理的。</p> <p>当前标准库（Go 1.13 之前）只提供用于构造错误的函数。如果还不够用的话，建议瞅瞅 <a href="https://github.com/pkg/errors?source=post_page---------------------------" target="_blank" rel="noopener noreferrer">pkg/errors<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>。</p> <p>这个库推行以下没能得到一致遵循的好规范：</p> <blockquote><p>错误应该仅被处理<strong>一次</strong>。打印错误也<strong>是</strong>处理错误。因此，一个错误要么打印出来，要么向上传递。</p></blockquote> <p>当前标准库想要支持这个规范是比较困难的，它无法为错误添加上下文信息以形成某种层级结构。</p> <p>看个预期会触发 DB 错误的 REST 调用例子：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>unable to server HTTP POST request for customer 1234
 |_ unable to insert customer contract abcd
     |_ unable to commit transaction
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p><code>pkg/errors</code>在手的话，我们可以操作如下：</p> <div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">postHandler</span><span class="token punctuation">(</span>customer Customer<span class="token punctuation">)</span> Status <span class="token punctuation">{</span>
	err <span class="token operator">:=</span> <span class="token function">insert</span><span class="token punctuation">(</span>customer<span class="token punctuation">.</span>Contract<span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		log<span class="token punctuation">.</span><span class="token function">WithError</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;unable to server HTTP POST request for customer %s&quot;</span><span class="token punctuation">,</span> customer<span class="token punctuation">.</span>ID<span class="token punctuation">)</span>
		<span class="token keyword">return</span> Status<span class="token punctuation">{</span>ok<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> Status<span class="token punctuation">{</span>ok<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">insert</span><span class="token punctuation">(</span>contract Contract<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>
	err <span class="token operator">:=</span> <span class="token function">dbQuery</span><span class="token punctuation">(</span>contract<span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> errors<span class="token punctuation">.</span><span class="token function">Wrapf</span><span class="token punctuation">(</span>err<span class="token punctuation">,</span> <span class="token string">&quot;unable to insert customer contract %s&quot;</span><span class="token punctuation">,</span> contract<span class="token punctuation">.</span>ID<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">dbQuery</span><span class="token punctuation">(</span>contract Contract<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>
	<span class="token comment">// Do something then fail</span>
	<span class="token keyword">return</span> errors<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token string">&quot;unable to commit transaction&quot;</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br></div></div><p>最初的错误（不是第三方库返回的）可以通过<code>errors.New</code>创建。中间层，<code>insert</code>加入更多上下文包装一下它。然后，顶级函数打印出错误。每层要么返回错误，要么处理错误。</p> <p>我们可能遇到需要查看错误的根源以实现重试的场景。假设我们依赖第三方的<code>db</code>包处理数据库访问。这个库可能会返回一个称为<code>db.DBError</code>的临时错误。为了确定是否需要重试，我们必须检查错误根源如下：</p> <div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">postHandler</span><span class="token punctuation">(</span>customer Customer<span class="token punctuation">)</span> Status <span class="token punctuation">{</span>
	err <span class="token operator">:=</span> <span class="token function">insert</span><span class="token punctuation">(</span>customer<span class="token punctuation">.</span>Contract<span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		<span class="token keyword">switch</span> errors<span class="token punctuation">.</span><span class="token function">Cause</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token keyword">type</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">default</span><span class="token punctuation">:</span>
			log<span class="token punctuation">.</span><span class="token function">WithError</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;unable to server HTTP POST request for customer %s&quot;</span><span class="token punctuation">,</span> customer<span class="token punctuation">.</span>ID<span class="token punctuation">)</span>
			<span class="token keyword">return</span> Status<span class="token punctuation">{</span>ok<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">}</span>
		<span class="token keyword">case</span> <span class="token operator">*</span>db<span class="token punctuation">.</span>DBError<span class="token punctuation">:</span>
			<span class="token keyword">return</span> <span class="token function">retry</span><span class="token punctuation">(</span>customer<span class="token punctuation">)</span>
		<span class="token punctuation">}</span>

	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> Status<span class="token punctuation">{</span>ok<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">insert</span><span class="token punctuation">(</span>contract Contract<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>
	err <span class="token operator">:=</span> db<span class="token punctuation">.</span><span class="token function">dbQuery</span><span class="token punctuation">(</span>contract<span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> errors<span class="token punctuation">.</span><span class="token function">Wrapf</span><span class="token punctuation">(</span>err<span class="token punctuation">,</span> <span class="token string">&quot;unable to insert customer contract %s&quot;</span><span class="token punctuation">,</span> contract<span class="token punctuation">.</span>ID<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br></div></div><p>查看错误根源通过<code>errors.Cause</code>实现，由 pkg/errors 包提供。</p> <p>我遇到的常见错误是以半吊子的方式使用 pkg/errors，天真地检查错误如下：</p> <div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">switch</span> err<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token keyword">type</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token keyword">default</span><span class="token punctuation">:</span>
  log<span class="token punctuation">.</span><span class="token function">WithError</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;unable to server HTTP POST request for customer %s&quot;</span><span class="token punctuation">,</span> customer<span class="token punctuation">.</span>ID<span class="token punctuation">)</span>
  <span class="token keyword">return</span> Status<span class="token punctuation">{</span>ok<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">}</span>
<span class="token keyword">case</span> <span class="token operator">*</span>db<span class="token punctuation">.</span>DBError<span class="token punctuation">:</span>
  <span class="token keyword">return</span> <span class="token function">retry</span><span class="token punctuation">(</span>customer<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>上述例子中，如果<code>db.DBError</code>被包装了，重试就永不会触发。</p> <blockquote><p><a href="https://dave.cheney.net/2016/04/27/dont-just-check-errors-handle-them-gracefully?source=post_page---------------------------" target="_blank" rel="noopener noreferrer">Don’t just check errors, handle them gracefully<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a><br>
This post is an extract from my presentation at the recent GoCon spring conference in Tokyo, Japan. I've spent a lot of ...<br>
-- dave.cheney.net</p></blockquote> <h2 id="切片初始化"><a href="#切片初始化" class="header-anchor">#</a> 切片初始化</h2> <p>某些情形下，我们其实能够预知切片的最终长度。例如，将<code>Foo</code>切片转换为<code>Bar</code>切片，两个切片的长度是相等的。</p> <p>我经常看到如下初始切片的方式：</p> <div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">var</span> bars <span class="token punctuation">[</span><span class="token punctuation">]</span>Bar
bars <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span>Bar<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>切片不是什么神奇结构。它的底层实现了在空间不足时的容量增长策略。那种情况下，它会创建一个新数组（容量更大）然后把元素逐一拷贝过去。</p> <p>现在请脑补一下由于<code>[]Foo</code>包含大量元素需要多次重复这种增长操作的情形。插入操作的平摊复杂度（平均情况下）为<code>O(1)</code>，但是现实操作总是附带<strong>性能代价</strong>的。</p> <p>因此，如果预知最终长度，我们可以：</p> <ul><li>初始为特定长度：<div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">convert</span><span class="token punctuation">(</span>foos <span class="token punctuation">[</span><span class="token punctuation">]</span>Foo<span class="token punctuation">)</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>Bar <span class="token punctuation">{</span>
    bars <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span>Bar<span class="token punctuation">,</span> <span class="token function">len</span><span class="token punctuation">(</span>foos<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">for</span> i<span class="token punctuation">,</span> foo <span class="token operator">:=</span> <span class="token keyword">range</span> foos <span class="token punctuation">{</span>
        bars<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">fooToBar</span><span class="token punctuation">(</span>foo<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> bars
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div></li> <li>或者初始化长度为 0 但容量特定：<div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">convert</span><span class="token punctuation">(</span>foos <span class="token punctuation">[</span><span class="token punctuation">]</span>Foo<span class="token punctuation">)</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>Bar <span class="token punctuation">{</span>
    bars <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span>Bar<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token function">len</span><span class="token punctuation">(</span>foos<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> foo <span class="token operator">:=</span> <span class="token keyword">range</span> foos <span class="token punctuation">{</span>
        bars <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>bars<span class="token punctuation">,</span> <span class="token function">fooToBar</span><span class="token punctuation">(</span>foo<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> bars
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div></li></ul> <p>最佳选项是啥？选项 1 会稍微快一点。但你可能更喜欢第二个，因为它使代码风格一致：无论是否预知长度，总是通过<code>append</code>在切片最后添加元素。</p> <h2 id="上下文管理"><a href="#上下文管理" class="header-anchor">#</a> 上下文管理</h2> <p>开发者时常不理解<code>context.Context</code>。据官方文档：</p> <blockquote><p>上下文在 API 边界之间传递截止时间、取消信号和其他值</p></blockquote> <p>如果泛化的描述使得一些人没能理解<code>context.Context</code>的来源和使用姿势。</p> <p>让我们尝试深入分解它。上下文能够携带：</p> <ul><li><strong>截止日期</strong>：表现为时间段（例如，250 毫秒）或时间点（例如，2019-01-08 01:00:00），一旦超过了，我们必须取消当前活动（和 I/O 请求，等待通道输入等）</li> <li><strong>取消信号</strong>（基本表现为<code>&lt;-chan struct{}</code>）：行为也是类似的。一旦收到信号，必须停止当前活动。例如，假设我们收到两个请求。一个是插入数据而另一个是取消前一个请求（因为它不再有效之类的）。这种行为可用通过对第一个调用使用可取消的上下文，这个取消信号会在我们收到第二个请求时触发</li> <li>一组键/值（都是<code>interface{}</code>类型）</li></ul> <p>还有两点想说的：其一，上下文是<strong>可组合的</strong>，所以上下文是可以同时携带截止日期和一组键/值对的。其二，多个协程可以<strong>共享</strong>同一上下文使得取消信号可以停止<strong>多个操作</strong>。</p> <p>回归主题，我遇到的一个误用如下：</p> <p>某个基于 <a href="https://github.com/urfave/cli" target="_blank" rel="noopener noreferrer">urfave/cli<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>（如果不了解的话，只需知道这是个创建命令行程序的优秀库就行）的 Go 程序。一旦启动，开发者从应用程序上下文派生自己的上下文。这意味着一旦程序停止，urfave/cli 库关联的上下文会触发取消信号。</p> <p>我曾遇到的例子是调用 gRPC 端点是直接将这个上下文传给了调用函数。这其实<strong>不是</strong>我们想要的。</p> <p>我们其实是想要告诉 gRPC 库：例如，<em>当程序停止或 100 毫秒后请取消当前请求</em>。</p> <p>这么做只需简单地创建一个组合式上下文。如果<code>parent</code>是程序级上下文（由 urfave/cli 创建），可以简单操作如下：</p> <div class="language-go line-numbers-mode"><pre class="language-go"><code>ctx<span class="token punctuation">,</span> cancel <span class="token operator">:=</span> context<span class="token punctuation">.</span><span class="token function">WithTimeout</span><span class="token punctuation">(</span>parent<span class="token punctuation">,</span> <span class="token number">100</span> <span class="token operator">*</span> time<span class="token punctuation">.</span>Millisecond<span class="token punctuation">)</span>
response<span class="token punctuation">,</span> err <span class="token operator">:=</span> grpcClient<span class="token punctuation">.</span><span class="token function">Send</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> request<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>上下文理解起来并不是很难，而且是个人觉得 Go 语言提供最好特性之一。</p> <h3 id="延伸阅读-3"><a href="#延伸阅读-3" class="header-anchor">#</a> 延伸阅读</h3> <blockquote><p><a href="http://p.agnihotry.com/post/understanding_the_context_package_in_golang/?source=post_page---------------------------" target="_blank" rel="noopener noreferrer">Understanding the context package in golang<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a><br>
The context package in go can come in handy while interacting with APIs and slow processes, especially in ...<br>
-- p.agnihotry.com</p></blockquote> <blockquote><p><a href="https://grpc.io/blog/deadlines/?source=post_page---------------------------" target="_blank" rel="noopener noreferrer">gRPC and Deadlines<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a><br>
When you use gRPC, the gRPC library takes care of communication, marshalling, unmarshalling, and deadline enforcement ...<br>
-- grpc.io</p></blockquote> <h2 id="没有启用-race选项"><a href="#没有启用-race选项" class="header-anchor">#</a> 没有启用<code>-race</code>选项</h2> <p>我经常看到的错误是测试 Go 程序时没有启用<code>-race</code>选项。</p> <p>据<a href="https://blog.acolyer.org/2019/05/17/understanding-real-world-concurrency-bugs-in-go/" target="_blank" rel="noopener noreferrer">报告<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>分析，尽管 Go 目标是“为实现并发编程更简单和更少错误而设计”，我们依然在并发问题上受苦受难。</p> <p>显然，Go 的竞态检测器不可能查出每个并发问题。但是，它是个非常有用的工具，理应在测试程序时被一直启用。</p> <h3 id="延伸阅读-4"><a href="#延伸阅读-4" class="header-anchor">#</a> 延伸阅读</h3> <blockquote><p><a href="https://medium.com/@val_deleplace/does-the-race-detector-catch-all-data-races-1afed51d57fb?source=post_page---------------------------" target="_blank" rel="noopener noreferrer">Does the Go race detector catch all data race bugs?<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a><br>
TL;DR: it detects the data race conditions when they occur.<br>
-- medium.com</p></blockquote> <h2 id="用文件名作为输入"><a href="#用文件名作为输入" class="header-anchor">#</a> 用文件名作为输入</h2> <p>另一个常见错误是以文件名为函数输入。
假设我们需要实现一个函数用于计算文件的空行数目。最自然的实现一般如下：</p> <div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">count</span><span class="token punctuation">(</span>filename <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token builtin">int</span><span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	file<span class="token punctuation">,</span> err <span class="token operator">:=</span> os<span class="token punctuation">.</span><span class="token function">Open</span><span class="token punctuation">(</span>filename<span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">,</span> errors<span class="token punctuation">.</span><span class="token function">Wrapf</span><span class="token punctuation">(</span>err<span class="token punctuation">,</span> <span class="token string">&quot;unable to open %s&quot;</span><span class="token punctuation">,</span> filename<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">defer</span> file<span class="token punctuation">.</span><span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

	scanner <span class="token operator">:=</span> bufio<span class="token punctuation">.</span><span class="token function">NewScanner</span><span class="token punctuation">(</span>file<span class="token punctuation">)</span>
	count <span class="token operator">:=</span> <span class="token number">0</span>
	<span class="token keyword">for</span> scanner<span class="token punctuation">.</span><span class="token function">Scan</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">if</span> scanner<span class="token punctuation">.</span><span class="token function">Text</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token string">&quot;&quot;</span> <span class="token punctuation">{</span>
			count<span class="token operator">++</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> count<span class="token punctuation">,</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><p><code>filename</code>用作输入，然后我们打开文件，实现相关逻辑，感觉没问题吧？</p> <p>那么，现在我们想要对这个函数进行<strong>单元测试</strong>，覆盖正常文件、空文件、不同编码类型的问题等。复杂度猛然飙升。</p> <p>Go 引入了两个精妙的抽象类型：<code>io.Reader</code>和<code>io.Writer</code>。传入<code>io.Reader</code>而不是文件名即可抽象掉数据源。</p> <p>文件？HTTP 载荷？字节缓冲区？都无所谓，只需通过统一的<code>Read</code>方法读取数据即可。</p> <p>对于我们的情形，甚至可以通过缓存输入的方式来一行行地读取数据，采用<code>bufio.Reader</code>和它的<code>ReadLine</code>方法：</p> <div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">count</span><span class="token punctuation">(</span>reader <span class="token operator">*</span>bufio<span class="token punctuation">.</span>Reader<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token builtin">int</span><span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	count <span class="token operator">:=</span> <span class="token number">0</span>
	<span class="token keyword">for</span> <span class="token punctuation">{</span>
		line<span class="token punctuation">,</span> <span class="token boolean">_</span><span class="token punctuation">,</span> err <span class="token operator">:=</span> reader<span class="token punctuation">.</span><span class="token function">ReadLine</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
			<span class="token keyword">switch</span> err <span class="token punctuation">{</span>
			<span class="token keyword">default</span><span class="token punctuation">:</span>
				<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">,</span> errors<span class="token punctuation">.</span><span class="token function">Wrapf</span><span class="token punctuation">(</span>err<span class="token punctuation">,</span> <span class="token string">&quot;unable to read&quot;</span><span class="token punctuation">)</span>
			<span class="token keyword">case</span> io<span class="token punctuation">.</span>EOF<span class="token punctuation">:</span>
				<span class="token keyword">return</span> count<span class="token punctuation">,</span> <span class="token boolean">nil</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>line<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">{</span>
			count<span class="token operator">++</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><p>打开文件的责任分发到<code>count</code>客户端程序：</p> <div class="language-go line-numbers-mode"><pre class="language-go"><code>file<span class="token punctuation">,</span> err <span class="token operator">:=</span> os<span class="token punctuation">.</span><span class="token function">Open</span><span class="token punctuation">(</span>filename<span class="token punctuation">)</span>
<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> errors<span class="token punctuation">.</span><span class="token function">Wrapf</span><span class="token punctuation">(</span>err<span class="token punctuation">,</span> <span class="token string">&quot;unable to open %s&quot;</span><span class="token punctuation">,</span> filename<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token keyword">defer</span> file<span class="token punctuation">.</span><span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
count<span class="token punctuation">,</span> err <span class="token operator">:=</span> <span class="token function">count</span><span class="token punctuation">(</span>bufio<span class="token punctuation">.</span><span class="token function">NewReader</span><span class="token punctuation">(</span>file<span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>第二种实现使得函数能够处理任意类型的数据源，也使得可以通过<code>string</code>伪造<code>bufio.Reader</code>以<strong>便于</strong>单元测试：</p> <div class="language-go line-numbers-mode"><pre class="language-go"><code>count<span class="token punctuation">,</span> err <span class="token operator">:=</span> <span class="token function">count</span><span class="token punctuation">(</span>bufio<span class="token punctuation">.</span><span class="token function">NewReader</span><span class="token punctuation">(</span>strings<span class="token punctuation">.</span><span class="token function">NewReader</span><span class="token punctuation">(</span><span class="token string">&quot;input&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h2 id="协程与循环计数器"><a href="#协程与循环计数器" class="header-anchor">#</a> 协程与循环计数器</h2> <p>最后一个常见错误出现在协程使用循环计算器的场景。</p> <p>以下例子的输入是啥？</p> <div class="language-go line-numbers-mode"><pre class="language-go"><code>ints <span class="token operator">:=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">int</span><span class="token punctuation">{</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">}</span>
<span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> i <span class="token operator">:=</span> <span class="token keyword">range</span> ints <span class="token punctuation">{</span>
  <span class="token keyword">go</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;%v\n&quot;</span><span class="token punctuation">,</span> i<span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>会是顺序不定的<code>1 2 3</code>吗？不是哟。</p> <p>这个例子中，每个协程共享同一变量实例，因此它很有可能是输出<code>3 3 3</code>。</p> <p>这个问题由两种解决方法。第一种是将<code>i</code>的值传给闭包（里层的那个函数）：</p> <div class="language-go line-numbers-mode"><pre class="language-go"><code>ints <span class="token operator">:=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">int</span><span class="token punctuation">{</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">}</span>
<span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> i <span class="token operator">:=</span> <span class="token keyword">range</span> ints <span class="token punctuation">{</span>
  <span class="token keyword">go</span> <span class="token keyword">func</span><span class="token punctuation">(</span>i <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;%v\n&quot;</span><span class="token punctuation">,</span> i<span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>另一种是在 for 循环作用域内创建另一个变量：</p> <div class="language-go line-numbers-mode"><pre class="language-go"><code>ints <span class="token operator">:=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">int</span><span class="token punctuation">{</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">}</span>
<span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> i <span class="token operator">:=</span> <span class="token keyword">range</span> ints <span class="token punctuation">{</span>
  i <span class="token operator">:=</span> i
  <span class="token keyword">go</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;%v\n&quot;</span><span class="token punctuation">,</span> i<span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>执行<code>i := i</code>看起来有点怪，但是完全合法的。在一次循环里意味着另一个作用域。因此，<code>i := i</code>创建另一个名为<code>i</code>的变量。当然，我们想要为<code>i</code>赋予其他名字以提高可读性也是可以的。</p> <h3 id="延伸阅读-5"><a href="#延伸阅读-5" class="header-anchor">#</a> 延伸阅读</h3> <blockquote><p><a href="https://github.com/golang/go/wiki/CommonMistakes?source=post_page---------------------------#using-goroutines-on-loop-iterator-variables" target="_blank" rel="noopener noreferrer">Common Mistakes: Using goroutines on loop iterator variables<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a><br>
The Go programming language. Contribute to golang/go development by creating an account on GitHub.<br>
-- github.com</p></blockquote> <p>还有其他更多想要提及的错误吗？欢迎追加 😃</p></div></section> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">Last Updated: </span> <span class="time">4/18/2021, 1:52:33 AM</span></div></footer> <!----> <div class="comments-wrapper"><!----></div> <ul class="side-bar sub-sidebar-wrapper" style="width:12rem;" data-v-70334359><li class="level-2" data-v-70334359><a href="/_post/the-top-10-most-common-mistakes-ive-seen-in-go-projects/#表示-未知-的枚举值" class="sidebar-link reco-side-表示-未知-的枚举值" data-v-70334359>表示&quot;未知&quot;的枚举值</a></li><li class="level-2" data-v-70334359><a href="/_post/the-top-10-most-common-mistakes-ive-seen-in-go-projects/#性能测试" class="sidebar-link reco-side-性能测试" data-v-70334359>性能测试</a></li><li class="level-3" data-v-70334359><a href="/_post/the-top-10-most-common-mistakes-ive-seen-in-go-projects/#延伸阅读" class="sidebar-link reco-side-延伸阅读" data-v-70334359>延伸阅读</a></li><li class="level-2" data-v-70334359><a href="/_post/the-top-10-most-common-mistakes-ive-seen-in-go-projects/#遍地指针" class="sidebar-link reco-side-遍地指针" data-v-70334359>遍地指针</a></li><li class="level-3" data-v-70334359><a href="/_post/the-top-10-most-common-mistakes-ive-seen-in-go-projects/#延伸阅读-2" class="sidebar-link reco-side-延伸阅读-2" data-v-70334359>延伸阅读</a></li><li class="level-2" data-v-70334359><a href="/_post/the-top-10-most-common-mistakes-ive-seen-in-go-projects/#breaking-a-for-switch-or-a-for-select" class="sidebar-link reco-side-breaking-a-for-switch-or-a-for-select" data-v-70334359>Breaking a for/switch or a for/select</a></li><li class="level-2" data-v-70334359><a href="/_post/the-top-10-most-common-mistakes-ive-seen-in-go-projects/#错误处理" class="sidebar-link reco-side-错误处理" data-v-70334359>错误处理</a></li><li class="level-2" data-v-70334359><a href="/_post/the-top-10-most-common-mistakes-ive-seen-in-go-projects/#切片初始化" class="sidebar-link reco-side-切片初始化" data-v-70334359>切片初始化</a></li><li class="level-2" data-v-70334359><a href="/_post/the-top-10-most-common-mistakes-ive-seen-in-go-projects/#上下文管理" class="sidebar-link reco-side-上下文管理" data-v-70334359>上下文管理</a></li><li class="level-3" data-v-70334359><a href="/_post/the-top-10-most-common-mistakes-ive-seen-in-go-projects/#延伸阅读-3" class="sidebar-link reco-side-延伸阅读-3" data-v-70334359>延伸阅读</a></li><li class="level-2" data-v-70334359><a href="/_post/the-top-10-most-common-mistakes-ive-seen-in-go-projects/#没有启用-race选项" class="sidebar-link reco-side-没有启用-race选项" data-v-70334359>没有启用-race选项</a></li><li class="level-3" data-v-70334359><a href="/_post/the-top-10-most-common-mistakes-ive-seen-in-go-projects/#延伸阅读-4" class="sidebar-link reco-side-延伸阅读-4" data-v-70334359>延伸阅读</a></li><li class="level-2" data-v-70334359><a href="/_post/the-top-10-most-common-mistakes-ive-seen-in-go-projects/#用文件名作为输入" class="sidebar-link reco-side-用文件名作为输入" data-v-70334359>用文件名作为输入</a></li><li class="level-2" data-v-70334359><a href="/_post/the-top-10-most-common-mistakes-ive-seen-in-go-projects/#协程与循环计数器" class="sidebar-link reco-side-协程与循环计数器" data-v-70334359>协程与循环计数器</a></li><li class="level-3" data-v-70334359><a href="/_post/the-top-10-most-common-mistakes-ive-seen-in-go-projects/#延伸阅读-5" class="sidebar-link reco-side-延伸阅读-5" data-v-70334359>延伸阅读</a></li></ul></main> <!----></div></div></div></div><div class="global-ui"><div class="back-to-ceiling" style="right:1rem;bottom:6rem;width:2.5rem;height:2.5rem;border-radius:.25rem;line-height:2.5rem;display:none;" data-v-c6073ba8 data-v-c6073ba8><svg t="1574745035067" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="5404" class="icon" data-v-c6073ba8><path d="M526.60727968 10.90185116a27.675 27.675 0 0 0-29.21455937 0c-131.36607665 82.28402758-218.69155461 228.01873535-218.69155402 394.07834331a462.20625001 462.20625001 0 0 0 5.36959153 69.94390903c1.00431239 6.55289093-0.34802892 13.13561351-3.76865779 18.80351572-32.63518765 54.11355614-51.75690182 118.55860487-51.7569018 187.94566865a371.06718723 371.06718723 0 0 0 11.50484808 91.98906777c6.53300375 25.50556257 41.68394495 28.14064038 52.69160883 4.22606766 17.37162448-37.73630017 42.14135425-72.50938081 72.80769204-103.21549295 2.18761121 3.04276886 4.15646224 6.24463696 6.40373557 9.22774369a1871.4375 1871.4375 0 0 0 140.04691725 5.34970492 1866.36093723 1866.36093723 0 0 0 140.04691723-5.34970492c2.24727335-2.98310674 4.21612437-6.18497483 6.3937923-9.2178004 30.66633723 30.70611158 55.4360664 65.4791928 72.80769147 103.21549355 11.00766384 23.91457269 46.15860503 21.27949489 52.69160879-4.22606768a371.15156223 371.15156223 0 0 0 11.514792-91.99901164c0-69.36717486-19.13165746-133.82216804-51.75690182-187.92578088-3.42062944-5.66790279-4.76302748-12.26056868-3.76865837-18.80351632a462.20625001 462.20625001 0 0 0 5.36959269-69.943909c-0.00994388-166.08943902-87.32547796-311.81420293-218.6915546-394.09823051zM605.93803103 357.87693858a93.93749974 93.93749974 0 1 1-187.89594924 6.1e-7 93.93749974 93.93749974 0 0 1 187.89594924-6.1e-7z" p-id="5405" data-v-c6073ba8></path><path d="M429.50777625 765.63860547C429.50777625 803.39355007 466.44236686 1000.39046097 512.00932183 1000.39046097c45.56695499 0 82.4922232-197.00623328 82.5015456-234.7518555 0-37.75494459-36.9345906-68.35043303-82.4922232-68.34111062-45.57627738-0.00932239-82.52019037 30.59548842-82.51086798 68.34111062z" p-id="5406" data-v-c6073ba8></path></svg></div></div></div>
    <script src="/assets/js/app.460084d6.js" defer></script><script src="/assets/js/3.df7e20a8.js" defer></script><script src="/assets/js/1.7ac9a612.js" defer></script><script src="/assets/js/90.44315479.js" defer></script>
  </body>
</html>
