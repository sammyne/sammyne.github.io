<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>[iptables] 05. 匹配条件总结 2 | sammyne</title>
    <meta name="generator" content="VuePress 1.8.2">
    <link rel="icon" href="/favicon.ico">
    <meta name="description" content="Just playing around :)">
    <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no">
    
    <link rel="preload" href="/assets/css/0.styles.49bc6dee.css" as="style"><link rel="preload" href="/assets/js/app.dd9aac12.js" as="script"><link rel="preload" href="/assets/js/3.3f52b992.js" as="script"><link rel="preload" href="/assets/js/1.86295094.js" as="script"><link rel="preload" href="/assets/js/67.fa18d1cd.js" as="script"><link rel="prefetch" href="/assets/js/10.1038f603.js"><link rel="prefetch" href="/assets/js/11.96eec3c9.js"><link rel="prefetch" href="/assets/js/12.d28f2fe1.js"><link rel="prefetch" href="/assets/js/13.d7ab6196.js"><link rel="prefetch" href="/assets/js/14.051d7969.js"><link rel="prefetch" href="/assets/js/15.4ed924b6.js"><link rel="prefetch" href="/assets/js/16.677fbaaa.js"><link rel="prefetch" href="/assets/js/17.8a6b7ba1.js"><link rel="prefetch" href="/assets/js/18.79ea8cf4.js"><link rel="prefetch" href="/assets/js/19.3141bf59.js"><link rel="prefetch" href="/assets/js/20.deaa9f14.js"><link rel="prefetch" href="/assets/js/21.cbf78bb1.js"><link rel="prefetch" href="/assets/js/22.d6a5c657.js"><link rel="prefetch" href="/assets/js/23.f04a9f25.js"><link rel="prefetch" href="/assets/js/24.aa0b9a4f.js"><link rel="prefetch" href="/assets/js/25.e9b27a2a.js"><link rel="prefetch" href="/assets/js/26.6a774f88.js"><link rel="prefetch" href="/assets/js/27.ed0fc0f9.js"><link rel="prefetch" href="/assets/js/28.a397c3d7.js"><link rel="prefetch" href="/assets/js/29.bc4b043d.js"><link rel="prefetch" href="/assets/js/30.213d982d.js"><link rel="prefetch" href="/assets/js/31.017c6b4e.js"><link rel="prefetch" href="/assets/js/32.3c39cb85.js"><link rel="prefetch" href="/assets/js/33.2e35cafb.js"><link rel="prefetch" href="/assets/js/34.79a608bc.js"><link rel="prefetch" href="/assets/js/35.908be713.js"><link rel="prefetch" href="/assets/js/36.9c2eb74c.js"><link rel="prefetch" href="/assets/js/37.e2cb8a6e.js"><link rel="prefetch" href="/assets/js/38.3fccd1be.js"><link rel="prefetch" href="/assets/js/39.b9030e8d.js"><link rel="prefetch" href="/assets/js/4.427febfc.js"><link rel="prefetch" href="/assets/js/40.0f104398.js"><link rel="prefetch" href="/assets/js/41.b1c0ffa7.js"><link rel="prefetch" href="/assets/js/42.91d363cd.js"><link rel="prefetch" href="/assets/js/43.aa239f52.js"><link rel="prefetch" href="/assets/js/44.2546e0e4.js"><link rel="prefetch" href="/assets/js/45.10782dd7.js"><link rel="prefetch" href="/assets/js/46.3064f272.js"><link rel="prefetch" href="/assets/js/47.cf2d5859.js"><link rel="prefetch" href="/assets/js/48.b9824382.js"><link rel="prefetch" href="/assets/js/49.cb939463.js"><link rel="prefetch" href="/assets/js/5.3ab3e749.js"><link rel="prefetch" href="/assets/js/50.56958abe.js"><link rel="prefetch" href="/assets/js/51.d109678d.js"><link rel="prefetch" href="/assets/js/52.ae4e6334.js"><link rel="prefetch" href="/assets/js/53.17db3a12.js"><link rel="prefetch" href="/assets/js/54.a44acc29.js"><link rel="prefetch" href="/assets/js/55.aeaaad9e.js"><link rel="prefetch" href="/assets/js/56.b42ebcb9.js"><link rel="prefetch" href="/assets/js/57.6a9e7d29.js"><link rel="prefetch" href="/assets/js/58.aa6443bc.js"><link rel="prefetch" href="/assets/js/59.3a8b21f1.js"><link rel="prefetch" href="/assets/js/6.78df9723.js"><link rel="prefetch" href="/assets/js/60.44967c94.js"><link rel="prefetch" href="/assets/js/61.d74cd6a2.js"><link rel="prefetch" href="/assets/js/62.e5817de7.js"><link rel="prefetch" href="/assets/js/63.9c45d434.js"><link rel="prefetch" href="/assets/js/64.7869c4d8.js"><link rel="prefetch" href="/assets/js/65.47ff3714.js"><link rel="prefetch" href="/assets/js/66.83077b8c.js"><link rel="prefetch" href="/assets/js/68.debb8be6.js"><link rel="prefetch" href="/assets/js/69.1d7114ab.js"><link rel="prefetch" href="/assets/js/7.42dd3861.js"><link rel="prefetch" href="/assets/js/70.9b795da4.js"><link rel="prefetch" href="/assets/js/71.2a904461.js"><link rel="prefetch" href="/assets/js/72.2aded41b.js"><link rel="prefetch" href="/assets/js/73.00835c21.js"><link rel="prefetch" href="/assets/js/74.4cb5389a.js"><link rel="prefetch" href="/assets/js/75.c76883ea.js"><link rel="prefetch" href="/assets/js/76.32345452.js"><link rel="prefetch" href="/assets/js/77.1b44d4ff.js"><link rel="prefetch" href="/assets/js/78.9f45beb3.js"><link rel="prefetch" href="/assets/js/79.703fe700.js"><link rel="prefetch" href="/assets/js/8.0b3d33ad.js"><link rel="prefetch" href="/assets/js/80.8a87e52f.js"><link rel="prefetch" href="/assets/js/81.8eee7c5f.js"><link rel="prefetch" href="/assets/js/82.cc434b65.js"><link rel="prefetch" href="/assets/js/83.14ef117a.js"><link rel="prefetch" href="/assets/js/84.ec74ac63.js"><link rel="prefetch" href="/assets/js/85.642fc847.js"><link rel="prefetch" href="/assets/js/86.d39032ec.js"><link rel="prefetch" href="/assets/js/87.b8ed6509.js"><link rel="prefetch" href="/assets/js/88.dc2dc95f.js"><link rel="prefetch" href="/assets/js/89.11a73f3f.js"><link rel="prefetch" href="/assets/js/9.4fb731d8.js">
    <link rel="stylesheet" href="/assets/css/0.styles.49bc6dee.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container no-sidebar" data-v-1156296a><div data-v-1156296a><div id="loader-wrapper" class="loading-wrapper" data-v-d48f4d20 data-v-1156296a data-v-1156296a><div class="loader-main" data-v-d48f4d20><div data-v-d48f4d20></div><div data-v-d48f4d20></div><div data-v-d48f4d20></div><div data-v-d48f4d20></div></div> <!----> <!----></div> <div class="password-shadow password-wrapper-out" style="display:none;" data-v-4e82dffc data-v-1156296a data-v-1156296a><h3 class="title" data-v-4e82dffc data-v-4e82dffc>sammyne</h3> <p class="description" data-v-4e82dffc data-v-4e82dffc>Just playing around :)</p> <label id="box" class="inputBox" data-v-4e82dffc data-v-4e82dffc><input type="password" value="" data-v-4e82dffc> <span data-v-4e82dffc>Konck! Knock!</span> <button data-v-4e82dffc>OK</button></label> <div class="footer" data-v-4e82dffc data-v-4e82dffc><span data-v-4e82dffc><i class="iconfont reco-theme" data-v-4e82dffc></i> <a target="blank" href="https://vuepress-theme-reco.recoluan.com" data-v-4e82dffc>vuePress-theme-reco</a></span> <span data-v-4e82dffc><i class="iconfont reco-copyright" data-v-4e82dffc></i> <a data-v-4e82dffc><span data-v-4e82dffc>sammyne</span>
            
          <span data-v-4e82dffc>2020 - </span>
          2021
        </a></span></div></div> <div class="hide" data-v-1156296a><header class="navbar" data-v-1156296a><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/logo.svg" alt="sammyne" class="logo"> <span class="site-name">sammyne</span></a> <div class="links"><div class="color-picker"><a class="color-button"><i class="iconfont reco-color"></i></a> <div class="color-picker-menu" style="display:none;"><div class="mode-options"><h4 class="title">Choose mode</h4> <ul class="color-mode-options"><li class="dark">dark</li><li class="auto active">auto</li><li class="light">light</li></ul></div></div></div> <div class="search-box"><i class="iconfont reco-search"></i> <input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link"><i class="iconfont reco-home"></i>
  首页
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-category"></i>
      分类
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/categories/dev/" class="nav-link"><i class="undefined"></i>
  dev
</a></li><li class="dropdown-item"><!----> <a href="/categories/crypto/" class="nav-link"><i class="undefined"></i>
  crypto
</a></li><li class="dropdown-item"><!----> <a href="/categories/programming/" class="nav-link"><i class="undefined"></i>
  programming
</a></li><li class="dropdown-item"><!----> <a href="/categories/tee/" class="nav-link"><i class="undefined"></i>
  tee
</a></li><li class="dropdown-item"><!----> <a href="/categories/os/" class="nav-link"><i class="undefined"></i>
  os
</a></li><li class="dropdown-item"><!----> <a href="/categories/engineering/" class="nav-link"><i class="undefined"></i>
  engineering
</a></li><li class="dropdown-item"><!----> <a href="/categories/tool/" class="nav-link"><i class="undefined"></i>
  tool
</a></li><li class="dropdown-item"><!----> <a href="/categories/language/" class="nav-link"><i class="undefined"></i>
  language
</a></li><li class="dropdown-item"><!----> <a href="/categories/decentralization/" class="nav-link"><i class="undefined"></i>
  decentralization
</a></li><li class="dropdown-item"><!----> <a href="/categories/architecture/" class="nav-link"><i class="undefined"></i>
  architecture
</a></li><li class="dropdown-item"><!----> <a href="/categories/network/" class="nav-link"><i class="undefined"></i>
  network
</a></li><li class="dropdown-item"><!----> <a href="/categories/software engineering/" class="nav-link"><i class="undefined"></i>
  software engineering
</a></li><li class="dropdown-item"><!----> <a href="/categories/notes/" class="nav-link"><i class="undefined"></i>
  notes
</a></li></ul></div></div><div class="nav-item"><a href="/tag/" class="nav-link"><i class="iconfont reco-tag"></i>
  标签
</a></div><div class="nav-item"><a href="/timeline/" class="nav-link"><i class="iconfont reco-date"></i>
  时间轴
</a></div><div class="nav-item"><a href="https://github.com/sammyne" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="iconfont reco-github"></i>
  Github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav></div></header> <div class="sidebar-mask" data-v-1156296a></div> <aside class="sidebar" data-v-1156296a><div class="personal-info-wrapper" data-v-828910c6 data-v-1156296a><img src="/avatar.png" alt="author-avatar" class="personal-img" data-v-828910c6> <h3 class="name" data-v-828910c6>
    sammyne
  </h3> <div class="num" data-v-828910c6><div data-v-828910c6><h3 data-v-828910c6>79</h3> <h6 data-v-828910c6>Articles</h6></div> <div data-v-828910c6><h3 data-v-828910c6>43</h3> <h6 data-v-828910c6>Tags</h6></div></div> <ul class="social-links" data-v-828910c6></ul> <hr data-v-828910c6></div> <nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link"><i class="iconfont reco-home"></i>
  首页
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-category"></i>
      分类
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/categories/dev/" class="nav-link"><i class="undefined"></i>
  dev
</a></li><li class="dropdown-item"><!----> <a href="/categories/crypto/" class="nav-link"><i class="undefined"></i>
  crypto
</a></li><li class="dropdown-item"><!----> <a href="/categories/programming/" class="nav-link"><i class="undefined"></i>
  programming
</a></li><li class="dropdown-item"><!----> <a href="/categories/tee/" class="nav-link"><i class="undefined"></i>
  tee
</a></li><li class="dropdown-item"><!----> <a href="/categories/os/" class="nav-link"><i class="undefined"></i>
  os
</a></li><li class="dropdown-item"><!----> <a href="/categories/engineering/" class="nav-link"><i class="undefined"></i>
  engineering
</a></li><li class="dropdown-item"><!----> <a href="/categories/tool/" class="nav-link"><i class="undefined"></i>
  tool
</a></li><li class="dropdown-item"><!----> <a href="/categories/language/" class="nav-link"><i class="undefined"></i>
  language
</a></li><li class="dropdown-item"><!----> <a href="/categories/decentralization/" class="nav-link"><i class="undefined"></i>
  decentralization
</a></li><li class="dropdown-item"><!----> <a href="/categories/architecture/" class="nav-link"><i class="undefined"></i>
  architecture
</a></li><li class="dropdown-item"><!----> <a href="/categories/network/" class="nav-link"><i class="undefined"></i>
  network
</a></li><li class="dropdown-item"><!----> <a href="/categories/software engineering/" class="nav-link"><i class="undefined"></i>
  software engineering
</a></li><li class="dropdown-item"><!----> <a href="/categories/notes/" class="nav-link"><i class="undefined"></i>
  notes
</a></li></ul></div></div><div class="nav-item"><a href="/tag/" class="nav-link"><i class="iconfont reco-tag"></i>
  标签
</a></div><div class="nav-item"><a href="/timeline/" class="nav-link"><i class="iconfont reco-date"></i>
  时间轴
</a></div><div class="nav-item"><a href="https://github.com/sammyne" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="iconfont reco-github"></i>
  Github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav> <!----> </aside> <div class="password-shadow password-wrapper-in" style="display:none;" data-v-4e82dffc data-v-1156296a><h3 class="title" data-v-4e82dffc data-v-4e82dffc>[iptables] 05. 匹配条件总结 2</h3> <!----> <label id="box" class="inputBox" data-v-4e82dffc data-v-4e82dffc><input type="password" value="" data-v-4e82dffc> <span data-v-4e82dffc>Konck! Knock!</span> <button data-v-4e82dffc>OK</button></label> <div class="footer" data-v-4e82dffc data-v-4e82dffc><span data-v-4e82dffc><i class="iconfont reco-theme" data-v-4e82dffc></i> <a target="blank" href="https://vuepress-theme-reco.recoluan.com" data-v-4e82dffc>vuePress-theme-reco</a></span> <span data-v-4e82dffc><i class="iconfont reco-copyright" data-v-4e82dffc></i> <a data-v-4e82dffc><span data-v-4e82dffc>sammyne</span>
            
          <span data-v-4e82dffc>2020 - </span>
          2021
        </a></span></div></div> <div data-v-1156296a><main class="page"><section><div class="page-title"><h1 class="title">[iptables] 05. 匹配条件总结 2</h1> <div data-v-1ff7123e><i class="iconfont reco-account" data-v-1ff7123e><span data-v-1ff7123e>sammyne</span></i> <i class="iconfont reco-date" data-v-1ff7123e><span data-v-1ff7123e>1/7/2021</span></i> <i class="iconfont reco-eye" data-v-1ff7123e><span id="/iptables-05-rules-summary-02/" data-flag-title="Your Article Title" class="leancloud-visitors" data-v-1ff7123e><a class="leancloud-visitors-count" style="font-size:.9rem;font-weight:normal;color:#999;"></a></span></i> <i class="tags iconfont reco-tag" data-v-1ff7123e><span class="tag-item" data-v-1ff7123e>iptables</span><span class="tag-item" data-v-1ff7123e>linux</span><span class="tag-item" data-v-1ff7123e>ops</span></i></div></div> <div class="theme-reco-content content__default"><div class="custom-block tip"><p class="title">温馨提示</p><p>本文从理论到实践，系统地介绍 iptables。如果你想要从头开始了解 iptables，可以查看 <a href="/tag/iptables/">iptables 系列文章</a>。</p></div><div class="custom-block danger"><p class="title">高能预警</p><p>在进行 iptables 实验时，请务必在测试机上进行。本文的实验操作环境为 VMware Fusion 12.0 下的 Ubuntu 20.04.1。</p></div><p><a href="/2021/01/03/iptables-04-rules-summary-01/">前文</a> 总结了 iptables 的基本匹配条件以及简单的扩展匹配条件。本文介绍一些新的扩展模块。</p> <h2 id="iprange-扩展模块"><a href="#iprange-扩展模块" class="header-anchor">#</a> iprange 扩展模块</h2> <p>之前总结过：在不使用任何扩展模块的情况下，使用 <code>-s</code> 选项或者 <code>-d</code> 选项即可匹配报文的源地址与目标地址，而且在指定 IP 地址时，可以同时指定多个 IP 地址，每个 IP 用 <code>,</code> 隔开。但是，<code>-s</code> 选项与 <code>-d</code> 选项不能一次性指定一段连续的 IP 地址范围。如果需要指定一段连续的 IP 地址范围，可以使用 iprange 扩展模块。</p> <p>使用 iprange 扩展模块可以指定 <strong>一段连续的 IP 地址范围</strong>，用于匹配报文的源地址或者目标地址。</p> <p>iprange 扩展模块有两个扩展匹配条件可以使用</p> <ul><li><code>--src-range</code></li> <li><code>--dst-range</code></li></ul> <p>见名知意，上述两个选项分别用于匹配报文的源地址所在范围与目标地址所在范围。</p> <p>示例如下：</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>root@ubuntu:/home/sammy<span class="token comment"># iptables -F INPUT</span>
root@ubuntu:/home/sammy<span class="token comment"># iptables -I INPUT -m iprange --src-range 192.168.1.127-192.168.1.146 -j DROP</span>
root@ubuntu:/home/sammy<span class="token comment"># iptables -vL INPUT</span>
Chain INPUT <span class="token punctuation">(</span>policy ACCEPT <span class="token number">0</span> packets, <span class="token number">0</span> bytes<span class="token punctuation">)</span>
 pkts bytes target     prot opt <span class="token keyword">in</span>     out     <span class="token builtin class-name">source</span>               destination
    <span class="token number">0</span>     <span class="token number">0</span> DROP       all  --  any    any     anywhere             anywhere             <span class="token builtin class-name">source</span> IP range <span class="token number">192.168</span>.1.127-192.168.1.146
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>上例表示如果报文的源 IP 地址如果在 <code>192.168.1.127</code> 到 <code>192.168.1.146</code> 之间，则丢弃报文。IP 段的始末 IP 使用 <code>-</code> 连接，<code>--src-range</code> 与 <code>--dst-range</code> 和其他匹配条件一样，能够使用 <code>!</code> 取反。有了 <a href="/2021/01/03/iptables-04-rules-summary-01/">前文</a> 的知识作为基础，此处不再赘述。</p> <h2 id="string-扩展模块"><a href="#string-扩展模块" class="header-anchor">#</a> string 扩展模块</h2> <p>使用 string 扩展模块可以指定要匹配的字符串。如果报文中包含对应的字符串，则符合匹配条件。</p> <p>比如，如果报文中包含字符 &quot;Hello&quot; 就丢弃当前报文。</p> <p>对于 IP 为 <code>172.16.39.1</code> 的主机上</p> <ol><li>在当前工作目录添加两个页面，页面内容分别为 &quot;Hello&quot; 和 &quot;World&quot;</li></ol> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token builtin class-name">echo</span> <span class="token string">&quot;Hello&quot;</span> <span class="token operator">&gt;</span> index.html
<span class="token builtin class-name">echo</span> <span class="token string">&quot;World&quot;</span> <span class="token operator">&gt;</span> index2.html
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><ol start="2"><li>启动 http 服务</li></ol> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>docker run -it --rm -v <span class="token variable">${<span class="token environment constant">PWD</span>}</span>:/usr/share/nginx/html -p <span class="token number">8080</span>:80 nginx:1.19.6-alpine
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>对于 IP 为 <code>172.16.39.2</code> 的主机</p> <ol><li>访问 <code>172.16.39.1</code> 的主机的页面</li></ol> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>root@ubuntu:/home/sammy<span class="token comment"># iptables -F INPUT</span>
root@ubuntu:/home/sammy<span class="token comment"># curl 172.16.39.1:8080</span>
Hello
root@ubuntu:/home/sammy<span class="token comment"># curl 172.16.39.1:8080/index2.html</span>
World
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>可见，在没有配置任何规则时，<code>172.16.39.2</code> 主机可以正常访问 <code>172.16.39.1</code> 主机的两个页面。</p> <p>我们想要达到的目的是，如果报文包含 &quot;Hello&quot; 字符就拒绝报文进入本机。所以，可以在 <code>172.16.39.2</code> 上进行如下配置。</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>root@ubuntu:/home/sammy<span class="token comment"># iptables -F INPUT</span>
root@ubuntu:/home/sammy<span class="token comment"># iptables -I INPUT -m string --algo bm --string &quot;Hello&quot; -j REJECT</span>
root@ubuntu:/home/sammy<span class="token comment"># curl 172.16.39.1:8080</span>
^C
root@ubuntu:/home/sammy<span class="token comment"># curl 172.16.39.1:8080/index2.html</span>
World
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>相关选项说明如下</p> <ul><li><code>-m string</code> 表示使用 string 模块</li> <li><code>--algo bm</code> 表示使用 bm 算法去匹配指定的字符串</li> <li><code>--string &quot;Hello&quot;</code> 表示想要匹配的字符串为 &quot;Hello&quot;</li></ul> <p>设置完以上规则后，因为 index.html 包含 &quot;Hello&quot; 字符串，所以 <code>172.16.39.1</code> 的回应报文无法通过 <code>172.16.39.2</code> 的 <code>INPUT</code> 链，所以无法获取到页面对应的内容。</p> <p>那么，我们来总结一下 string 模块的常用选项</p> <table><thead><tr><th style="text-align:right;">选项</th> <th style="text-align:left;">说明</th></tr></thead> <tbody><tr><td style="text-align:right;"><code>--algo</code></td> <td style="text-align:left;">指定匹配算法，可选的算法有 bm 与 kmp。此选项为必须选项。不用纠结于选择哪个算法，但必须指定一个。</td></tr> <tr><td style="text-align:right;"><code>--string</code></td> <td style="text-align:left;">指定需要匹配的字符串。</td></tr></tbody></table> <h2 id="time-扩展模块"><a href="#time-扩展模块" class="header-anchor">#</a> time 扩展模块</h2> <p>通过 time 扩展模块可以实现根据时间段区匹配报文。如果报文到达的时间在指定时间范围以内，则符合匹配条件。</p> <p>比如，&quot;我想要自我约束，每天早上 9 点到下午 6 点不能看网页&quot;。多么残忍的规定。如果你想要这样定义，可以尝试设置规则如下</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>root@ubuntu:~<span class="token comment"># iptables -F INPUT</span>
root@ubuntu:~<span class="token comment"># iptables -I OUTPUT -p tcp --dport 80 -m time --timestart 09:00:00 --timestop 18:00:00 -j REJECT</span>
root@ubuntu:~<span class="token comment"># iptables -I OUTPUT -p tcp --dport 443 -m time --timestart 09:00:00 --timestop 18:00:00 -j REJECT</span>
root@ubuntu:~<span class="token comment"># iptables -vL OUTPUT</span>
Chain OUTPUT <span class="token punctuation">(</span>policy ACCEPT <span class="token number">1</span> packets, <span class="token number">76</span> bytes<span class="token punctuation">)</span>
 pkts bytes target     prot opt <span class="token keyword">in</span>     out     <span class="token builtin class-name">source</span>               destination
    <span class="token number">0</span>     <span class="token number">0</span> REJECT     tcp  --  any    any     anywhere             anywhere             tcp dpt:https TIME from 09:00:00 to <span class="token number">18</span>:00:00 UTC reject-with icmp-port-unreachable
    <span class="token number">0</span>     <span class="token number">0</span> REJECT     tcp  --  any    any     anywhere             anywhere             tcp dpt:http TIME from 09:00:00 to <span class="token number">18</span>:00:00 UTC reject-with icmp-port-unreachable
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>相关选项说明如下</p> <ul><li><code>-m time</code> 表示使用 time 扩展模块</li> <li><code>--timestart</code> 选项用于指定起始时间</li> <li><code>--timestop</code> 选项用于指定结束时间</li></ul> <p>如果你想要换一种约束方法，只有周六日不能看网页，那么可以使用如下规则。</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>root@ubuntu:~<span class="token comment"># iptables -F OUTPUT</span>
root@ubuntu:~<span class="token comment"># iptables -I OUTPUT -p tcp --dport 80 -m time --weekdays 6,7 -j REJECT</span>
root@ubuntu:~<span class="token comment"># iptables -vL OUTPUT</span>
Chain OUTPUT <span class="token punctuation">(</span>policy ACCEPT <span class="token number">0</span> packets, <span class="token number">0</span> bytes<span class="token punctuation">)</span>
 pkts bytes target     prot opt <span class="token keyword">in</span>     out     <span class="token builtin class-name">source</span>               destination
    <span class="token number">0</span>     <span class="token number">0</span> REJECT     tcp  --  any    any     anywhere             anywhere             tcp dpt:http TIME on Sat,Sun UTC reject-with icmp-port-unreachable
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>使用 <code>--weekdays</code> 选项可以指定每个星期的具体哪一天，可同时指定多个，用逗号隔开。除了能够数字表示&quot;星期几&quot;，还能用缩写表示。例如：Mon，Tue，Wed，Thu，Fri，Sat 或 Sun。</p> <p>当然，你也可以将上述几个选项结合起来使用，比如指定只有周六日的早上 9 点到下午 6 点不能浏览网页。</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>root@ubuntu:~<span class="token comment"># iptables -F OUTPUT</span>
root@ubuntu:~<span class="token comment"># iptables -I OUTPUT -p tcp --dport 80 -m time --timestart 09:00:00 --timestop 18:00:00 --weekdays 6,7 -j REJECT</span>
root@ubuntu:~<span class="token comment"># iptables -vL OUTPUT</span>
Chain OUTPUT <span class="token punctuation">(</span>policy ACCEPT <span class="token number">1</span> packets, <span class="token number">76</span> bytes<span class="token punctuation">)</span>
 pkts bytes target     prot opt <span class="token keyword">in</span>     out     <span class="token builtin class-name">source</span>               destination
    <span class="token number">0</span>     <span class="token number">0</span> REJECT     tcp  --  any    any     anywhere             anywhere             tcp dpt:http TIME from 09:00:00 to <span class="token number">18</span>:00:00 on Sat,Sun UTC reject-with icmp-port-unreachable
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>依此类推，既然有 <code>--weekdays</code> 选项，也有 <code>--monthdays</code> 选项。</p> <p>使用 <code>--monthdays</code> 选项可以具体指定每个月的哪一天。比如如下设置表示每月的 22 号和 23 号。</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>root@ubuntu:~<span class="token comment"># iptables -F OUTPUT</span>
root@ubuntu:~<span class="token comment"># iptables -I OUTPUT -p tcp --dport 80 -m time --monthdays 22,23 -j REJECT</span>
root@ubuntu:~<span class="token comment"># iptables -vL OUTPUT</span>
Chain OUTPUT <span class="token punctuation">(</span>policy ACCEPT <span class="token number">0</span> packets, <span class="token number">0</span> bytes<span class="token punctuation">)</span>
 pkts bytes target     prot opt <span class="token keyword">in</span>     out     <span class="token builtin class-name">source</span>               destination
    <span class="token number">0</span>     <span class="token number">0</span> REJECT     tcp  --  any    any     anywhere             anywhere             tcp dpt:http TIME on 22nd,23rd UTC reject-with icmp-port-unreachable
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p><a href="/2021/01/03/iptables-04-rules-summary-01/">前文</a> 总结过：当一条规则同时存在多个条件时，条件之间默认存在&quot;与&quot;的关系。因此，以下设置的匹配时间必须为星期 5，并且这个&quot;星期 5&quot;同时还需要是每个月的 22 号到 28 号之间的一天，即此设置表示每月第 4 个星期 5。</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>root@ubuntu:~<span class="token comment"># iptables -F OUTPUT</span>
root@ubuntu:~<span class="token comment"># iptables -I OUTPUT -p tcp --dport 80 -m time --weekdays 5 --monthdays 22,23,24,25,26,27,28 -j REJECT</span>
root@ubuntu:~<span class="token comment"># iptables -vL OUTPUT</span>
Chain OUTPUT <span class="token punctuation">(</span>policy ACCEPT <span class="token number">0</span> packets, <span class="token number">0</span> bytes<span class="token punctuation">)</span>
 pkts bytes target     prot opt <span class="token keyword">in</span>     out     <span class="token builtin class-name">source</span>               destination
    <span class="token number">0</span>     <span class="token number">0</span> REJECT     tcp  --  any    any     anywhere             anywhere             tcp dpt:http TIME on Fri on 22nd,23rd,24th,25th,26th,27th,28th UTC reject-with icmp-port-unreachable
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>除了使用 <code>--weekdays</code> 与 <code>--monthdays</code> 选项，还可以使用 <code>--datestart</code> 与 <code>-datestop</code> 选项，指定具体的日期范围如下。</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>root@ubuntu:~<span class="token comment"># iptables -F OUTPUT</span>
root@ubuntu:~<span class="token comment"># iptables -I OUTPUT -p tcp -m time --datestart 2021-01-07 --datestop 2021-01-31 -j REJECT</span>
root@ubuntu:~<span class="token comment"># iptables -vL OUTPUT</span>
Chain OUTPUT <span class="token punctuation">(</span>policy ACCEPT <span class="token number">0</span> packets, <span class="token number">0</span> bytes<span class="token punctuation">)</span>
 pkts bytes target     prot opt <span class="token keyword">in</span>     out     <span class="token builtin class-name">source</span>               destination
    <span class="token number">0</span>     <span class="token number">0</span> REJECT     tcp  --  any    any     anywhere             anywhere             TIME starting from <span class="token number">2021</span>-01-07 00:00:00 <span class="token keyword">until</span> <span class="token function">date</span> <span class="token number">2021</span>-01-31 00:00:00 UTC reject-with icmp-port-unreachable
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>上面指定的日期范围为 2021 年 01 月 07 日到 2021 年 01 月 31 日。</p> <p>上述选项中，<code>--monthdays</code> 与 <code>--weekdays</code> 可以使用 <code>!</code> 取反，其他选项不能取反。</p> <h2 id="connlimit-扩展模块"><a href="#connlimit-扩展模块" class="header-anchor">#</a> connlimit 扩展模块</h2> <p>使用 connlimit 扩展模块，可以限制每个 IP 地址同时到 server 端的链接数量。注意：我们不用指定 IP，其默认就是针对&quot;每个客户端 IP&quot;，即对单 IP 的并发连接数限制。</p> <p>比如，限制每个 IP 地址最多只能占用两个 ssh 链接远程到 server 端，可以进行如下限制。</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>root@ubuntu:~<span class="token comment"># iptables -F INPUT</span>
root@ubuntu:~<span class="token comment"># iptables -I INPUT -p tcp --dport 22 -m connlimit --connlimit-above 2 -j REJECT</span>
root@ubuntu:~<span class="token comment"># iptables -vL INPUT</span>
Chain INPUT <span class="token punctuation">(</span>policy ACCEPT <span class="token number">0</span> packets, <span class="token number">0</span> bytes<span class="token punctuation">)</span>
 pkts bytes target     prot opt <span class="token keyword">in</span>     out     <span class="token builtin class-name">source</span>               destination
    <span class="token number">0</span>     <span class="token number">0</span> REJECT     tcp  --  any    any     anywhere             anywhere             tcp dpt:ssh <span class="token comment">#conn src/32 &gt; 2 reject-with icmp-port-unreachable</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>相关选项说明如下</p> <ul><li><code>-m connlimit</code> 指定使用 connlimit 扩展。</li> <li><code>--connlimit-above 2</code> 表示限制每个 IP 的链接数量上限为 2，再配合 <code>-p tcp --dport 22</code> 即表示限制每个客户端 IP 的 ssh 并发链接数量不能高于 2。</li></ul> <p>同时打开 3 个终端，执行以下命令链接到测试机器 <code>172.16.39.2</code>。</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token function">ssh</span> sammy@172.16.39.2
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>可见，第 3 条链接会触发如下错误</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>ssh: connect to <span class="token function">host</span> <span class="token number">172.16</span>.39.2 port <span class="token number">22</span>: Connection refused
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>可以使用 <code>!</code> 对 <code>--connlimit-above</code> 选项进行取反，示例如下</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>root@ubuntu:~<span class="token comment"># iptables -F INPUT</span>
root@ubuntu:~<span class="token comment"># iptables -I INPUT -p tcp --dport 22 -m connlimit ! --connlimit-above 2 -j ACCEPT</span>
root@ubuntu:~<span class="token comment"># iptables -vL INPUT</span>
Chain INPUT <span class="token punctuation">(</span>policy ACCEPT <span class="token number">0</span> packets, <span class="token number">0</span> bytes<span class="token punctuation">)</span>
 pkts bytes target     prot opt <span class="token keyword">in</span>     out     <span class="token builtin class-name">source</span>               destination
    <span class="token number">0</span>     <span class="token number">0</span> ACCEPT     tcp  --  any    any     anywhere             anywhere             tcp dpt:ssh <span class="token comment">#conn src/32 &lt;= 2</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>上例表示每个客户端 IP 的 ssh 链接数量只要不超过两个，则允许链接。</p> <p>但是以上规则并<strong>不能表示</strong>：每个客户端 IP 的 ssh 链接数量超过两个则拒绝链接（与 <a href="/2021/01/03/iptables-04-rules-summary-01/">前文</a> 的举例原理相同，此处不再赘述）。也就是说，以上规则不能达到&quot;限制&quot;的目的，所以通常并不会对此选项取反。因为既然使用此选项，目的通常就是&quot;限制&quot;连接数量。</p> <p>Ubuntu 20.04.1/CentOS 7 的 iptables 还提供了一个新的选项-- <code>--connlimit-upto</code>。这个选项的含义与 <code>! --commlimit-above</code> 的含义相同，即链接数量未达到指定的连接数量之意。综上所述，<code>--connlimit-upto</code> 选项也不常用。</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>root@ubuntu:~<span class="token comment"># iptables -F INPUT</span>
root@ubuntu:~<span class="token comment"># iptables -I INPUT -p tcp --dport 22 -m connlimit --connlimit-upto 2 -j ACCEPT</span>
root@ubuntu:~<span class="token comment"># iptables -vL INPUT</span>
Chain INPUT <span class="token punctuation">(</span>policy ACCEPT <span class="token number">0</span> packets, <span class="token number">0</span> bytes<span class="token punctuation">)</span>
 pkts bytes target     prot opt <span class="token keyword">in</span>     out     <span class="token builtin class-name">source</span>               destination
    <span class="token number">0</span>     <span class="token number">0</span> ACCEPT     tcp  --  any    any     anywhere             anywhere             tcp dpt:ssh <span class="token comment">#conn src/32 &lt;= 2</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>刚才说过，<code>--connlimit-above</code> 默认表示限制&quot;每个 IP&quot;的链接数量。还可以配合 <code>--connlimit-mask</code> 选项，去限制&quot;某类网段&quot;的链接数量，示例如下</p> <div class="custom-block warning"><p class="title">注意事项</p><p>下例需要一定的网络知识基础。如果你还不了解它们，可以选择先跳过此选项或者先去学习部分的网络知识</p></div><div class="language-bash line-numbers-mode"><pre class="language-bash"><code>root@ubuntu:~<span class="token comment"># iptables -F INPUT</span>
root@ubuntu:~<span class="token comment"># iptables -I INPUT -p tcp -m connlimit --connlimit-above 2 --connlimit-mask 24 -j REJECT</span>
root@ubuntu:~<span class="token comment"># iptables -vL INPUT</span>
Chain INPUT <span class="token punctuation">(</span>policy ACCEPT <span class="token number">0</span> packets, <span class="token number">0</span> bytes<span class="token punctuation">)</span>
 pkts bytes target     prot opt <span class="token keyword">in</span>     out     <span class="token builtin class-name">source</span>               destination
    <span class="token number">0</span>     <span class="token number">0</span> REJECT     tcp  --  any    any     anywhere             anywhere             <span class="token comment">#conn src/24 &gt; 2 reject-with icmp-port-unreachable</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>上例中 <code>--connlimit-mask 24</code> 表示某个 C 类网段。mask 为掩码之意，将 24 转换成点分十进制就表示 <code>255.255.255.0</code>。以上示例规则表示：一个最多包含 254 个 IP 的 C 类网络中，同时最多只能有 2 个 ssh 客户端可连接到当前服务器，看来资源很紧俏啊！254 个 IP 才有 2 个名额。如果一个 IP 同时把两个连接名额都占用了，那么剩下的 253 个 IP 连一个连接名额都没有。那么，我们再看看下例，是不是就好多了。</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>root@ubuntu:~<span class="token comment"># iptables -F INPUT</span>
root@ubuntu:~<span class="token comment"># iptables -I INPUT -p tcp -m connlimit --connlimit-above 10 --connlimit-mask 27 -j REJECT</span>
root@ubuntu:~<span class="token comment"># iptables -vL INPUT</span>
Chain INPUT <span class="token punctuation">(</span>policy ACCEPT <span class="token number">0</span> packets, <span class="token number">0</span> bytes<span class="token punctuation">)</span>
 pkts bytes target     prot opt <span class="token keyword">in</span>     out     <span class="token builtin class-name">source</span>               destination
    <span class="token number">0</span>     <span class="token number">0</span> REJECT     tcp  --  any    any     anywhere             anywhere             <span class="token comment">#conn src/27 &gt; 10 reject-with icmp-port-unreachable</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>上例中 <code>--connlimit-mask 27</code> 表示某个 C 类网段。通过计算后可以得知，这个网段最多只能有 30 台机器（30 个 IP）。这 30 个 IP 地址最多只能有 10 个 ssh 连接可同时连接到服务器端，比刚才的设置大方多了。当然，这样并不能避免某个 IP 占用所有连接的情况发生。假设报文来自 <code>192.168.1.40</code> 这个 IP，按照掩码为 27 进行计算，这个 IP 属于 <code>192.168.1.32/27</code> 网段。如果 <code>192.168.1.40</code> 同时占用了 10 个 ssh 连接，那么当 <code>192.168.1.51</code> 这个 IP 向服务端发起 ssh 连接请求时，同样会被拒绝。因为 <code>192.168.1.51</code> 这个 IP 按照掩码为 27 进行计算，也是属于 <code>192.168.1.32/27</code> 网段，所以他们共享这 10 个连接名额。</p> <p>因此，在不使用 <code>--connlimit-mask</code> 的情况下，连接数量的限制是针对&quot;每个 IP&quot;而言的；使用了 <code>--connlimit-mask</code> 选项后，则可以针对&quot;某类 IP 段内一定数量的 IP&quot;进行连接数量的限制，这样灵活许多。</p> <h2 id="limit-扩展模块"><a href="#limit-扩展模块" class="header-anchor">#</a> limit 扩展模块</h2> <p>connlimit 模块限制连接数量，limit 模块则限制&quot;报文到达速率&quot;。</p> <p>用大白话说就是，如果想要限制单位时间内流入的包数量，就能用 limit 模块。</p> <p>可以以秒为单位进行限制，也可以以分钟、小时、天作为单位进行限制。</p> <p>比如，限制每秒最多流入 3 个包，或者限制每分钟最多流入 30 个包。</p> <p>举个栗子：假设想要限制外部主机对本机进行 <code>ping</code> 操作时，本机最多每 6 秒放行一个 <code>ping</code> 包。可以进行如下设置</p> <blockquote><p>注意：只进行如下设置有可能无法实现限制功能，请看完后面的内容。</p></blockquote> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>root@ubuntu:~<span class="token comment"># iptables -F INPUT</span>
root@ubuntu:~<span class="token comment"># iptables -I INPUT -p icmp -m limit --limit 10/minute -j ACCEPT</span>
root@ubuntu:~<span class="token comment"># iptables -vL INPUT</span>
Chain INPUT <span class="token punctuation">(</span>policy ACCEPT <span class="token number">0</span> packets, <span class="token number">0</span> bytes<span class="token punctuation">)</span>
 pkts bytes target     prot opt <span class="token keyword">in</span>     out     <span class="token builtin class-name">source</span>               destination
    <span class="token number">0</span>     <span class="token number">0</span> ACCEPT     icmp --  any    any     anywhere             anywhere             limit: avg <span class="token number">10</span>/min burst <span class="token number">5</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>相关选项说明如下</p> <ul><li><code>-p icmp</code> 表示针对 <code>ping</code> 请求添加一条规则（ping 使用 ICMP 协议）</li> <li><code>-m limit</code> 表示使用 limit 模块</li> <li><code>--limit 10/minute -j ACCEPT</code> 表示每分钟最多放行 10 个包，就相当于每 6 秒钟最多放行一个包。换句话说，每过 6 秒钟放行一个包</li></ul> <p>配置完上述规则后，在另外一台机器上对当前机器 <code>172.16.39.2</code> 进行 <code>ping</code> 操作，看看是否能够达到限制的目的，如下所示</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token function">ping</span> <span class="token number">172.16</span>.39.2
PING <span class="token number">172.16</span>.39.2 <span class="token punctuation">(</span><span class="token number">172.16</span>.39.2<span class="token punctuation">)</span>: <span class="token number">56</span> data bytes
<span class="token number">64</span> bytes from <span class="token number">172.16</span>.39.2: <span class="token assign-left variable">icmp_seq</span><span class="token operator">=</span><span class="token number">0</span> <span class="token assign-left variable">ttl</span><span class="token operator">=</span><span class="token number">64</span> <span class="token assign-left variable">time</span><span class="token operator">=</span><span class="token number">0.401</span> ms
<span class="token number">64</span> bytes from <span class="token number">172.16</span>.39.2: <span class="token assign-left variable">icmp_seq</span><span class="token operator">=</span><span class="token number">1</span> <span class="token assign-left variable">ttl</span><span class="token operator">=</span><span class="token number">64</span> <span class="token assign-left variable">time</span><span class="token operator">=</span><span class="token number">0.786</span> ms
<span class="token number">64</span> bytes from <span class="token number">172.16</span>.39.2: <span class="token assign-left variable">icmp_seq</span><span class="token operator">=</span><span class="token number">2</span> <span class="token assign-left variable">ttl</span><span class="token operator">=</span><span class="token number">64</span> <span class="token assign-left variable">time</span><span class="token operator">=</span><span class="token number">0.709</span> ms
<span class="token number">64</span> bytes from <span class="token number">172.16</span>.39.2: <span class="token assign-left variable">icmp_seq</span><span class="token operator">=</span><span class="token number">3</span> <span class="token assign-left variable">ttl</span><span class="token operator">=</span><span class="token number">64</span> <span class="token assign-left variable">time</span><span class="token operator">=</span><span class="token number">0.842</span> ms
<span class="token number">64</span> bytes from <span class="token number">172.16</span>.39.2: <span class="token assign-left variable">icmp_seq</span><span class="token operator">=</span><span class="token number">4</span> <span class="token assign-left variable">ttl</span><span class="token operator">=</span><span class="token number">64</span> <span class="token assign-left variable">time</span><span class="token operator">=</span><span class="token number">0.746</span> ms
<span class="token number">64</span> bytes from <span class="token number">172.16</span>.39.2: <span class="token assign-left variable">icmp_seq</span><span class="token operator">=</span><span class="token number">5</span> <span class="token assign-left variable">ttl</span><span class="token operator">=</span><span class="token number">64</span> <span class="token assign-left variable">time</span><span class="token operator">=</span><span class="token number">0.665</span> ms
<span class="token number">64</span> bytes from <span class="token number">172.16</span>.39.2: <span class="token assign-left variable">icmp_seq</span><span class="token operator">=</span><span class="token number">6</span> <span class="token assign-left variable">ttl</span><span class="token operator">=</span><span class="token number">64</span> <span class="token assign-left variable">time</span><span class="token operator">=</span><span class="token number">0.728</span> ms
<span class="token number">64</span> bytes from <span class="token number">172.16</span>.39.2: <span class="token assign-left variable">icmp_seq</span><span class="token operator">=</span><span class="token number">7</span> <span class="token assign-left variable">ttl</span><span class="token operator">=</span><span class="token number">64</span> <span class="token assign-left variable">time</span><span class="token operator">=</span><span class="token number">0.474</span> ms
<span class="token number">64</span> bytes from <span class="token number">172.16</span>.39.2: <span class="token assign-left variable">icmp_seq</span><span class="token operator">=</span><span class="token number">8</span> <span class="token assign-left variable">ttl</span><span class="token operator">=</span><span class="token number">64</span> <span class="token assign-left variable">time</span><span class="token operator">=</span><span class="token number">0.741</span> ms
<span class="token number">64</span> bytes from <span class="token number">172.16</span>.39.2: <span class="token assign-left variable">icmp_seq</span><span class="token operator">=</span><span class="token number">9</span> <span class="token assign-left variable">ttl</span><span class="token operator">=</span><span class="token number">64</span> <span class="token assign-left variable">time</span><span class="token operator">=</span><span class="token number">0.733</span> ms
<span class="token number">64</span> bytes from <span class="token number">172.16</span>.39.2: <span class="token assign-left variable">icmp_seq</span><span class="token operator">=</span><span class="token number">10</span> <span class="token assign-left variable">ttl</span><span class="token operator">=</span><span class="token number">64</span> <span class="token assign-left variable">time</span><span class="token operator">=</span><span class="token number">0.689</span> ms
<span class="token number">64</span> bytes from <span class="token number">172.16</span>.39.2: <span class="token assign-left variable">icmp_seq</span><span class="token operator">=</span><span class="token number">11</span> <span class="token assign-left variable">ttl</span><span class="token operator">=</span><span class="token number">64</span> <span class="token assign-left variable">time</span><span class="token operator">=</span><span class="token number">0.740</span> ms
^C
--- <span class="token number">172.16</span>.39.2 <span class="token function">ping</span> statistics ---
<span class="token number">12</span> packets transmitted, <span class="token number">12</span> packets received, <span class="token number">0.0</span>% packet loss
round-trip min/avg/max/stddev <span class="token operator">=</span> <span class="token number">0.401</span>/0.688/0.842/0.121 ms
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><p>可见刚才配置的规则并没有如想象一般，<code>ping</code> 请求的响应速率完全没有发生任何变化。为什么呢？我们一起来分析一下。</p> <p>回顾一下刚才配置的规则。</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>root@ubuntu:~<span class="token comment"># iptables -I INPUT -p icmp -m limit --limit 10/minute -j ACCEPT</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>其实，可以把以上规则理解为如下含义。</p> <p>每 6 秒放行一个包，那么 iptables 就会计时，每 6 秒一个轮次。到第 6 秒时，到达的报文就会匹配到对应的规则，执行对应的动作。而动作是 <code>ACCEPT</code>。<strong>那么在第 6 秒之前到达的包，则无法被上述规则匹配到。</strong></p> <p>之前总结过：报文会匹配链的每一条规则。如果没有任何一条规则能够匹配到，则匹配默认动作（链的默认策略）。</p> <p>既然第 6 秒之前的包没有被上述规则匹配到，而我们又没有在 INPUT 链配置其他规则。因此，第 6 秒之前的包肯定会被默认策略匹配到，先看看默认策略是什么。</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>root@ubuntu:~<span class="token comment"># iptables -L INPUT</span>
Chain INPUT <span class="token punctuation">(</span>policy ACCEPT<span class="token punctuation">)</span>
target     prot opt <span class="token builtin class-name">source</span>               destination
ACCEPT     icmp --  anywhere             anywhere             limit: avg <span class="token number">10</span>/min burst <span class="token number">5</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>现在再想想，应该明白为什么刚才的 <code>ping</code> 的响应速率没有变化了。</p> <p>因为第 6 秒的报文的确被对应的规则匹配到了。于是执行&quot;放行&quot;操作，第 6 秒之前的报文没有被配置的规则匹配到，但是被默认策略匹配到，而恰巧默认动作也是 <code>ACCEPT</code>。所以所有 <code>ping</code> 报文都被放行。怪不得与没有配置规则时的速率一模一样。</p> <p>因此，我们可以修改 <code>INPUT</code> 链的默认策略，或者在以上限制规则的后面再加入一条规则，将&quot;漏网之鱼&quot;匹配到即可，示例如下</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>root@ubuntu:~<span class="token comment"># iptables -F INPUT</span>
root@ubuntu:~<span class="token comment"># iptables -I INPUT -p icmp -m limit --limit 10/minute -j ACCEPT</span>
root@ubuntu:~<span class="token comment"># iptables -A INPUT -p icmp -j REJECT</span>
root@ubuntu:~<span class="token comment"># iptables -L INPUT</span>
Chain INPUT <span class="token punctuation">(</span>policy ACCEPT<span class="token punctuation">)</span>
target     prot opt <span class="token builtin class-name">source</span>               destination
ACCEPT     icmp --  anywhere             anywhere             limit: avg <span class="token number">10</span>/min burst <span class="token number">5</span>
REJECT     icmp --  anywhere             anywhere             reject-with icmp-port-unreachable
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>如上所示，第一条规则表示每分钟最多放行 10 个 ICMP 包，也就是 6 秒放行一个。第 6 秒的 ICMP 包会被以上第一条规则匹配到，第 6 秒之前的包则不会被第一条规则匹配到，而被后面的拒绝规则匹配到。此时再试试，看看 <code>ping</code> 的报文放行速率有没有发生改变。</p> <div class="language-bash line-numbers-mode"><div class="highlight-lines"><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><div class="highlighted"> </div><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br></div><pre class="language-bash"><code><span class="token function">ping</span> <span class="token number">172.16</span>.39.2
PING <span class="token number">172.16</span>.39.2 <span class="token punctuation">(</span><span class="token number">172.16</span>.39.2<span class="token punctuation">)</span>: <span class="token number">56</span> data bytes
<span class="token number">64</span> bytes from <span class="token number">172.16</span>.39.2: <span class="token assign-left variable">icmp_seq</span><span class="token operator">=</span><span class="token number">0</span> <span class="token assign-left variable">ttl</span><span class="token operator">=</span><span class="token number">64</span> <span class="token assign-left variable">time</span><span class="token operator">=</span><span class="token number">0.378</span> ms
<span class="token number">64</span> bytes from <span class="token number">172.16</span>.39.2: <span class="token assign-left variable">icmp_seq</span><span class="token operator">=</span><span class="token number">1</span> <span class="token assign-left variable">ttl</span><span class="token operator">=</span><span class="token number">64</span> <span class="token assign-left variable">time</span><span class="token operator">=</span><span class="token number">0.710</span> ms
<span class="token number">64</span> bytes from <span class="token number">172.16</span>.39.2: <span class="token assign-left variable">icmp_seq</span><span class="token operator">=</span><span class="token number">2</span> <span class="token assign-left variable">ttl</span><span class="token operator">=</span><span class="token number">64</span> <span class="token assign-left variable">time</span><span class="token operator">=</span><span class="token number">0.497</span> ms
<span class="token number">64</span> bytes from <span class="token number">172.16</span>.39.2: <span class="token assign-left variable">icmp_seq</span><span class="token operator">=</span><span class="token number">3</span> <span class="token assign-left variable">ttl</span><span class="token operator">=</span><span class="token number">64</span> <span class="token assign-left variable">time</span><span class="token operator">=</span><span class="token number">0.654</span> ms
<span class="token number">64</span> bytes from <span class="token number">172.16</span>.39.2: <span class="token assign-left variable">icmp_seq</span><span class="token operator">=</span><span class="token number">4</span> <span class="token assign-left variable">ttl</span><span class="token operator">=</span><span class="token number">64</span> <span class="token assign-left variable">time</span><span class="token operator">=</span><span class="token number">0.693</span> ms
<span class="token number">92</span> bytes from <span class="token number">172.16</span>.39.2 <span class="token punctuation">(</span><span class="token number">172.16</span>.39.2<span class="token punctuation">)</span>: Destination Port Unreachable
Vr HL TOS  Len   ID Flg  off TTL Pro  cks      Src      Dst
 <span class="token number">4</span>  <span class="token number">5</span>  00 <span class="token number">5400</span> 59b1   <span class="token number">0</span> 0000  <span class="token number">40</span>  01 7ad4 <span class="token number">172.16</span>.39.1  <span class="token number">172.16</span>.39.2

Request <span class="token function">timeout</span> <span class="token keyword">for</span> icmp_seq <span class="token number">5</span>
<span class="token number">92</span> bytes from <span class="token number">172.16</span>.39.2 <span class="token punctuation">(</span><span class="token number">172.16</span>.39.2<span class="token punctuation">)</span>: Destination Port Unreachable
Vr HL TOS  Len   ID Flg  off TTL Pro  cks      Src      Dst
 <span class="token number">4</span>  <span class="token number">5</span>  00 <span class="token number">5400</span> 5fff   <span class="token number">0</span> 0000  <span class="token number">40</span>  01 <span class="token number">7486</span> <span class="token number">172.16</span>.39.1  <span class="token number">172.16</span>.39.2

Request <span class="token function">timeout</span> <span class="token keyword">for</span> icmp_seq <span class="token number">6</span>
<span class="token number">64</span> bytes from <span class="token number">172.16</span>.39.2: <span class="token assign-left variable">icmp_seq</span><span class="token operator">=</span><span class="token number">7</span> <span class="token assign-left variable">ttl</span><span class="token operator">=</span><span class="token number">64</span> <span class="token assign-left variable">time</span><span class="token operator">=</span><span class="token number">0.742</span> ms
<span class="token number">92</span> bytes from <span class="token number">172.16</span>.39.2 <span class="token punctuation">(</span><span class="token number">172.16</span>.39.2<span class="token punctuation">)</span>: Destination Port Unreachable
Vr HL TOS  Len   ID Flg  off TTL Pro  cks      Src      Dst
 <span class="token number">4</span>  <span class="token number">5</span>  00 <span class="token number">5400</span> f2a5   <span class="token number">0</span> 0000  <span class="token number">40</span>  01 e1df <span class="token number">172.16</span>.39.1  <span class="token number">172.16</span>.39.2

Request <span class="token function">timeout</span> <span class="token keyword">for</span> icmp_seq <span class="token number">8</span>
<span class="token number">92</span> bytes from <span class="token number">172.16</span>.39.2 <span class="token punctuation">(</span><span class="token number">172.16</span>.39.2<span class="token punctuation">)</span>: Destination Port Unreachable
Vr HL TOS  Len   ID Flg  off TTL Pro  cks      Src      Dst
 <span class="token number">4</span>  <span class="token number">5</span>  00 <span class="token number">5400</span> 64e1   <span class="token number">0</span> 0000  <span class="token number">40</span>  01 6fa4 <span class="token number">172.16</span>.39.1  <span class="token number">172.16</span>.39.2

Request <span class="token function">timeout</span> <span class="token keyword">for</span> icmp_seq <span class="token number">9</span>
<span class="token number">92</span> bytes from <span class="token number">172.16</span>.39.2 <span class="token punctuation">(</span><span class="token number">172.16</span>.39.2<span class="token punctuation">)</span>: Destination Port Unreachable
Vr HL TOS  Len   ID Flg  off TTL Pro  cks      Src      Dst
 <span class="token number">4</span>  <span class="token number">5</span>  00 <span class="token number">5400</span> <span class="token number">8178</span>   <span class="token number">0</span> 0000  <span class="token number">40</span>  01 530d <span class="token number">172.16</span>.39.1  <span class="token number">172.16</span>.39.2

Request <span class="token function">timeout</span> <span class="token keyword">for</span> icmp_seq <span class="token number">10</span>
<span class="token number">92</span> bytes from <span class="token number">172.16</span>.39.2 <span class="token punctuation">(</span><span class="token number">172.16</span>.39.2<span class="token punctuation">)</span>: Destination Port Unreachable
Vr HL TOS  Len   ID Flg  off TTL Pro  cks      Src      Dst
 <span class="token number">4</span>  <span class="token number">5</span>  00 <span class="token number">5400</span> c4c4   <span class="token number">0</span> 0000  <span class="token number">40</span>  01 0fc1 <span class="token number">172.16</span>.39.1  <span class="token number">172.16</span>.39.2

Request <span class="token function">timeout</span> <span class="token keyword">for</span> icmp_seq <span class="token number">11</span>
<span class="token number">92</span> bytes from <span class="token number">172.16</span>.39.2 <span class="token punctuation">(</span><span class="token number">172.16</span>.39.2<span class="token punctuation">)</span>: Destination Port Unreachable
Vr HL TOS  Len   ID Flg  off TTL Pro  cks      Src      Dst
 <span class="token number">4</span>  <span class="token number">5</span>  00 <span class="token number">5400</span> 3f58   <span class="token number">0</span> 0000  <span class="token number">40</span>  01 952d <span class="token number">172.16</span>.39.1  <span class="token number">172.16</span>.39.2

Request <span class="token function">timeout</span> <span class="token keyword">for</span> icmp_seq <span class="token number">12</span>
<span class="token number">64</span> bytes from <span class="token number">172.16</span>.39.2: <span class="token assign-left variable">icmp_seq</span><span class="token operator">=</span><span class="token number">13</span> <span class="token assign-left variable">ttl</span><span class="token operator">=</span><span class="token number">64</span> <span class="token assign-left variable">time</span><span class="token operator">=</span><span class="token number">0.674</span> ms
<span class="token number">92</span> bytes from <span class="token number">172.16</span>.39.2 <span class="token punctuation">(</span><span class="token number">172.16</span>.39.2<span class="token punctuation">)</span>: Destination Port Unreachable
Vr HL TOS  Len   ID Flg  off TTL Pro  cks      Src      Dst
 <span class="token number">4</span>  <span class="token number">5</span>  00 <span class="token number">5400</span> f9cf   <span class="token number">0</span> 0000  <span class="token number">40</span>  01 dab5 <span class="token number">172.16</span>.39.1  <span class="token number">172.16</span>.39.2

Request <span class="token function">timeout</span> <span class="token keyword">for</span> icmp_seq <span class="token number">14</span>
<span class="token number">92</span> bytes from <span class="token number">172.16</span>.39.2 <span class="token punctuation">(</span><span class="token number">172.16</span>.39.2<span class="token punctuation">)</span>: Destination Port Unreachable
Vr HL TOS  Len   ID Flg  off TTL Pro  cks      Src      Dst
 <span class="token number">4</span>  <span class="token number">5</span>  00 <span class="token number">5400</span> <span class="token number">6043</span>   <span class="token number">0</span> 0000  <span class="token number">40</span>  01 <span class="token number">7442</span> <span class="token number">172.16</span>.39.1  <span class="token number">172.16</span>.39.2

Request <span class="token function">timeout</span> <span class="token keyword">for</span> icmp_seq <span class="token number">15</span>
<span class="token number">92</span> bytes from <span class="token number">172.16</span>.39.2 <span class="token punctuation">(</span><span class="token number">172.16</span>.39.2<span class="token punctuation">)</span>: Destination Port Unreachable
Vr HL TOS  Len   ID Flg  off TTL Pro  cks      Src      Dst
 <span class="token number">4</span>  <span class="token number">5</span>  00 <span class="token number">5400</span> 58ce   <span class="token number">0</span> 0000  <span class="token number">40</span>  01 7bb7 <span class="token number">172.16</span>.39.1  <span class="token number">172.16</span>.39.2

^C
--- <span class="token number">172.16</span>.39.2 <span class="token function">ping</span> statistics ---
<span class="token number">17</span> packets transmitted, <span class="token number">7</span> packets received, <span class="token number">58.8</span>% packet loss
round-trip min/avg/max/stddev <span class="token operator">=</span> <span class="token number">0.378</span>/0.621/0.742/0.123 ms
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br></div></div><p>刚开始还真吓我一跳，难道配置的规则还是有问题？</p> <p>结果发现：只有前 5 个 <code>ping</code> 包没有受到限制，之后的 <code>ping</code> 包已经开始受到了规则限制。</p> <p>由上可知：除了前 5 个 <code>ping</code> 包以外，之后的 <code>ping</code> 包差不多每 6 秒才能 <code>ping</code> 通一次。看来之后的 <code>ping</code> 包已经受到规则控制，被限制流入防火墙的速率。前 5 个 <code>ping</code> 包是什么鬼？为什么它们不受规则限制呢？这个现象正好引出另一个选项 <code>--limit-burst</code>。</p> <p><code>--limit-burst</code> 选项是干什么用的呢？先用不准确的大白话描述一遍：<code>--limit-burst</code> 可以指定&quot;空闲时可放行的包数量&quot;。其实，这样说并不准确，但是可以先这样大概的理解。在不使用 <code>--limit-burst</code> 选项明确指定放行包的数量时，默认值为 5。所以才会出现以上情况，前 5 个 <code>ping</code> 包并没有受到任何速率限制，之后的包才受到规则限制。</p> <p>想要彻底了解 limit 模块的工作原理需要先了解一下其使用的&quot;令牌桶&quot;算法。</p> <p>可以这样想象：有一个木桶，木桶里面放了 5 块令牌，而且这个木桶最多也只能放下 5 块令牌。所有报文如果想要出入关，都必须要持有木桶的令牌才行。这个木桶有一个神奇的功能，就是每隔 6 秒钟会生成一块新的令牌。如果此时，木桶的令牌不足 5 块，那么新生成的令牌就存放在木桶。如果木桶中已经存在 5 块令牌，新生成的令牌就无处安放了，只能溢出木桶（令牌被丢弃）。如果此时有 5 个报文想要入关，那么这 5 个报文就去木桶里找令牌，正好一人一个。于是他们 5 个手持令牌，快乐地入关了。此时木桶空了。再有报文想要入关，已经没有对应的令牌可以使用。但过了 6 秒钟，新的令牌生成了。此刻，正好来了一个报文想要入关。这个报文拿起这个令牌，就入关了。在这个报文之后，如果很长一段时间内没有新的报文想要入关，木桶中的令牌又会慢慢的积攒起来，直到达到 5 个令牌，并且一直保持着 5 个令牌，直到有人需要使用这些令牌。这就是令牌桶算法的大致逻辑。</p> <p>就拿刚才的&quot;令牌桶&quot;理论类比命令</p> <ul><li><code>--limit</code> 选项指定&quot;多长时间生成一个新令牌的&quot;</li> <li><code>--limit-burst</code>选项指定&quot;木桶最多存放几个令牌的&quot;</li></ul> <p>现在，你明白了吗？？示例如下</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>root@ubuntu:~<span class="token comment"># iptables -F INPUT</span>
root@ubuntu:~<span class="token comment"># iptables -I INPUT -p icmp -m limit --limit-burst 3 --limit 10/minute -j ACCEPT</span>
root@ubuntu:~<span class="token comment"># iptables -A INPUT -p icmp -j REJECT</span>
root@ubuntu:~<span class="token comment"># iptables -L INPUT</span>
Chain INPUT <span class="token punctuation">(</span>policy ACCEPT<span class="token punctuation">)</span>
target     prot opt <span class="token builtin class-name">source</span>               destination
ACCEPT     icmp --  anywhere             anywhere             limit: avg <span class="token number">10</span>/min burst <span class="token number">3</span>
REJECT     icmp --  anywhere             anywhere             reject-with icmp-port-unreachable
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>以上命令表示令牌桶最多能存放 3 个令牌，每分钟生成 10 个令牌（即 6 秒钟生成一个令牌）。</p> <p>之前说过，使用 <code>--limit</code> 选项时，可以选择的时间单位有多种，如下</p> <ul><li><code>/second</code></li> <li><code>/minute</code></li> <li><code>/hour</code></li> <li><code>/day</code></li></ul> <p>比如，<code>3/second</code> 表示每秒生成 3 个&quot;令牌&quot;，<code>30/minute</code> 表示每分钟生成 30 个&quot;令牌&quot;。</p> <h2 id="小结"><a href="#小结" class="header-anchor">#</a> 小结</h2> <p>老规矩，为了便于以后速查，上文提到的命令总结如下。</p> <h3 id="iprange-模块"><a href="#iprange-模块" class="header-anchor">#</a> iprange 模块</h3> <p>包含的扩展匹配条件如下</p> <table><thead><tr><th style="text-align:right;">条件</th> <th style="text-align:left;">说明</th></tr></thead> <tbody><tr><td style="text-align:right;"><code>--src-range</code></td> <td style="text-align:left;">指定连续的源地址范围</td></tr> <tr><td style="text-align:right;"><code>--dst-range</code></td> <td style="text-align:left;">指定连续的目标地址范围</td></tr></tbody></table> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token comment">#示例</span>
iptables -t filter -I INPUT -m iprange --src-range <span class="token number">192.168</span>.1.127-192.168.1.146 -j DROP
iptables -t filter -I OUTPUT -m iprange --dst-range <span class="token number">192.168</span>.1.127-192.168.1.146 -j DROP
iptables -t filter -I INPUT -m iprange <span class="token operator">!</span> --src-range <span class="token number">192.168</span>.1.127-192.168.1.146 -j DROP
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><h3 id="string-模块"><a href="#string-模块" class="header-anchor">#</a> string 模块</h3> <p>常用扩展匹配条件如下</p> <table><thead><tr><th style="text-align:right;">条件</th> <th style="text-align:left;">说明</th></tr></thead> <tbody><tr><td style="text-align:right;"><code>--algo</code></td> <td style="text-align:left;">指定对应的匹配算法，可用算法为 bm 和 kmp，此选项为必需选项</td></tr> <tr><td style="text-align:right;"><code>--string</code></td> <td style="text-align:left;">指定需要匹配的字符串</td></tr></tbody></table> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token comment">#示例</span>
iptables -t filter -I INPUT -p tcp --sport <span class="token number">80</span> -m string --algo bm --string <span class="token string">&quot;OOXX&quot;</span> -j REJECT
iptables -t filter -I INPUT -p tcp --sport <span class="token number">80</span> -m string --algo bm --string <span class="token string">&quot;OOXX&quot;</span> -j REJECT
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><h3 id="time-模块"><a href="#time-模块" class="header-anchor">#</a> time 模块</h3> <p>常用扩展匹配条件如下</p> <table><thead><tr><th style="text-align:right;">条件</th> <th style="text-align:left;">说明</th></tr></thead> <tbody><tr><td style="text-align:right;"><code>--timestart</code></td> <td style="text-align:left;">指定时间范围的开始时间，不可取反</td></tr> <tr><td style="text-align:right;"><code>--timestop</code></td> <td style="text-align:left;">指定时间范围的结束时间，不可取反</td></tr> <tr><td style="text-align:right;"><code>--weekdays</code></td> <td style="text-align:left;">指定&quot;星期几&quot;，可取反</td></tr> <tr><td style="text-align:right;"><code>--monthdays</code></td> <td style="text-align:left;">指定&quot;几号&quot;，可取反</td></tr> <tr><td style="text-align:right;"><code>--datestart</code></td> <td style="text-align:left;">指定日期范围的开始日期，不可取反</td></tr> <tr><td style="text-align:right;"><code>--datestop</code></td> <td style="text-align:left;">指定日期范围的结束时间，不可取反</td></tr></tbody></table> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token comment">#示例</span>
iptables -t filter -I OUTPUT -p tcp --dport <span class="token number">80</span> -m <span class="token function">time</span> --timestart 09:00:00 --timestop <span class="token number">19</span>:00:00 -j REJECT
iptables -t filter -I OUTPUT -p tcp --dport <span class="token number">443</span> -m <span class="token function">time</span> --timestart 09:00:00 --timestop <span class="token number">19</span>:00:00 -j REJECT
iptables -t filter -I OUTPUT -p tcp --dport <span class="token number">80</span> -m <span class="token function">time</span> --weekdays <span class="token number">6,7</span> -j REJECT
iptables -t filter -I OUTPUT -p tcp --dport <span class="token number">80</span> -m <span class="token function">time</span> --monthdays <span class="token number">22,23</span> -j REJECT
iptables -t filter -I OUTPUT -p tcp --dport <span class="token number">80</span> -m <span class="token function">time</span> <span class="token operator">!</span> --monthdays <span class="token number">22,23</span> -j REJECT
iptables -t filter -I OUTPUT -p tcp --dport <span class="token number">80</span> -m <span class="token function">time</span> --timestart 09:00:00 --timestop <span class="token number">18</span>:00:00 --weekdays <span class="token number">6,7</span> -j REJECT
iptables -t filter -I OUTPUT -p tcp --dport <span class="token number">80</span> -m <span class="token function">time</span> --weekdays <span class="token number">5</span> --monthdays <span class="token number">22,23</span>,24,25,26,27,28 -j REJECT
iptables -t filter -I OUTPUT -p tcp --dport <span class="token number">80</span> -m <span class="token function">time</span> --datestart <span class="token number">2017</span>-12-24 --datestop <span class="token number">2017</span>-12-27 -j REJECT
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><h3 id="connlimit-模块"><a href="#connlimit-模块" class="header-anchor">#</a> connlimit 模块</h3> <p>常用的扩展匹配条件如下</p> <table><thead><tr><th style="text-align:right;">条件</th> <th style="text-align:left;">说明</th></tr></thead> <tbody><tr><td style="text-align:right;"><code>--connlimit-above</code></td> <td style="text-align:left;">单独使用此选项时，表示限制每个 IP 的链接数量</td></tr> <tr><td style="text-align:right;"><code>--connlimit-mask</code></td> <td style="text-align:left;">此选项不能单独使用。在使用<code>--connlimit-above</code> 选项时，配合此选项，则可以针对&quot;某类 IP 段内的一定数量 IP&quot;进行连接数量的限制</td></tr></tbody></table> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token comment">#示例</span>
iptables -I INPUT -p tcp --dport <span class="token number">22</span> -m connlimit --connlimit-above <span class="token number">2</span> -j REJECT
iptables -I INPUT -p tcp --dport <span class="token number">22</span> -m connlimit --connlimit-above <span class="token number">20</span> --connlimit-mask <span class="token number">24</span> -j REJECT
iptables -I INPUT -p tcp --dport <span class="token number">22</span> -m connlimit --connlimit-above <span class="token number">10</span> --connlimit-mask <span class="token number">27</span> -j REJECT
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><h3 id="limit-模块"><a href="#limit-模块" class="header-anchor">#</a> limit 模块</h3> <p>常用的扩展匹配条件如下</p> <table><thead><tr><th style="text-align:right;">条件</th> <th style="text-align:left;">说明</th></tr></thead> <tbody><tr><td style="text-align:right;"><code>--limit-burst</code></td> <td style="text-align:left;">类比&quot;令牌桶&quot;算法，此选项用于指定令牌桶中令牌的最大数量，上文已经详细地描述了&quot;令牌桶&quot;的概念，方便回顾。</td></tr> <tr><td style="text-align:right;"><code>--limit</code></td> <td style="text-align:left;">类比&quot;令牌桶&quot;算法，此选项用于指定令牌桶中生成新令牌的频率，可用时间单位有 <code>second</code>、<code>minute</code>、<code>hour</code> 和 <code>day</code></td></tr></tbody></table> <h2 id="参考文献"><a href="#参考文献" class="header-anchor">#</a> 参考文献</h2> <ul><li><a href="http://www.zsythink.net/archives/1564" target="_blank" rel="noopener noreferrer">iptables 详解（5）：iptables 匹配条件总结之二（常用扩展模块）<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></section> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">Last Updated: </span> <span class="time">4/26/2021, 5:43:25 AM</span></div></footer> <!----> <div class="comments-wrapper"><!----></div> <ul class="side-bar sub-sidebar-wrapper" style="width:12rem;" data-v-70334359><li class="level-2" data-v-70334359><a href="/iptables-05-rules-summary-02/#iprange-扩展模块" class="sidebar-link reco-side-iprange-扩展模块" data-v-70334359>iprange 扩展模块</a></li><li class="level-2" data-v-70334359><a href="/iptables-05-rules-summary-02/#string-扩展模块" class="sidebar-link reco-side-string-扩展模块" data-v-70334359>string 扩展模块</a></li><li class="level-2" data-v-70334359><a href="/iptables-05-rules-summary-02/#time-扩展模块" class="sidebar-link reco-side-time-扩展模块" data-v-70334359>time 扩展模块</a></li><li class="level-2" data-v-70334359><a href="/iptables-05-rules-summary-02/#connlimit-扩展模块" class="sidebar-link reco-side-connlimit-扩展模块" data-v-70334359>connlimit 扩展模块</a></li><li class="level-2" data-v-70334359><a href="/iptables-05-rules-summary-02/#limit-扩展模块" class="sidebar-link reco-side-limit-扩展模块" data-v-70334359>limit 扩展模块</a></li><li class="level-2" data-v-70334359><a href="/iptables-05-rules-summary-02/#小结" class="sidebar-link reco-side-小结" data-v-70334359>小结</a></li><li class="level-3" data-v-70334359><a href="/iptables-05-rules-summary-02/#iprange-模块" class="sidebar-link reco-side-iprange-模块" data-v-70334359>iprange 模块</a></li><li class="level-3" data-v-70334359><a href="/iptables-05-rules-summary-02/#string-模块" class="sidebar-link reco-side-string-模块" data-v-70334359>string 模块</a></li><li class="level-3" data-v-70334359><a href="/iptables-05-rules-summary-02/#time-模块" class="sidebar-link reco-side-time-模块" data-v-70334359>time 模块</a></li><li class="level-3" data-v-70334359><a href="/iptables-05-rules-summary-02/#connlimit-模块" class="sidebar-link reco-side-connlimit-模块" data-v-70334359>connlimit 模块</a></li><li class="level-3" data-v-70334359><a href="/iptables-05-rules-summary-02/#limit-模块" class="sidebar-link reco-side-limit-模块" data-v-70334359>limit 模块</a></li><li class="level-2" data-v-70334359><a href="/iptables-05-rules-summary-02/#参考文献" class="sidebar-link reco-side-参考文献" data-v-70334359>参考文献</a></li></ul></main> <!----></div></div></div></div><div class="global-ui"><div class="back-to-ceiling" style="right:1rem;bottom:6rem;width:2.5rem;height:2.5rem;border-radius:.25rem;line-height:2.5rem;display:none;" data-v-c6073ba8 data-v-c6073ba8><svg t="1574745035067" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="5404" class="icon" data-v-c6073ba8><path d="M526.60727968 10.90185116a27.675 27.675 0 0 0-29.21455937 0c-131.36607665 82.28402758-218.69155461 228.01873535-218.69155402 394.07834331a462.20625001 462.20625001 0 0 0 5.36959153 69.94390903c1.00431239 6.55289093-0.34802892 13.13561351-3.76865779 18.80351572-32.63518765 54.11355614-51.75690182 118.55860487-51.7569018 187.94566865a371.06718723 371.06718723 0 0 0 11.50484808 91.98906777c6.53300375 25.50556257 41.68394495 28.14064038 52.69160883 4.22606766 17.37162448-37.73630017 42.14135425-72.50938081 72.80769204-103.21549295 2.18761121 3.04276886 4.15646224 6.24463696 6.40373557 9.22774369a1871.4375 1871.4375 0 0 0 140.04691725 5.34970492 1866.36093723 1866.36093723 0 0 0 140.04691723-5.34970492c2.24727335-2.98310674 4.21612437-6.18497483 6.3937923-9.2178004 30.66633723 30.70611158 55.4360664 65.4791928 72.80769147 103.21549355 11.00766384 23.91457269 46.15860503 21.27949489 52.69160879-4.22606768a371.15156223 371.15156223 0 0 0 11.514792-91.99901164c0-69.36717486-19.13165746-133.82216804-51.75690182-187.92578088-3.42062944-5.66790279-4.76302748-12.26056868-3.76865837-18.80351632a462.20625001 462.20625001 0 0 0 5.36959269-69.943909c-0.00994388-166.08943902-87.32547796-311.81420293-218.6915546-394.09823051zM605.93803103 357.87693858a93.93749974 93.93749974 0 1 1-187.89594924 6.1e-7 93.93749974 93.93749974 0 0 1 187.89594924-6.1e-7z" p-id="5405" data-v-c6073ba8></path><path d="M429.50777625 765.63860547C429.50777625 803.39355007 466.44236686 1000.39046097 512.00932183 1000.39046097c45.56695499 0 82.4922232-197.00623328 82.5015456-234.7518555 0-37.75494459-36.9345906-68.35043303-82.4922232-68.34111062-45.57627738-0.00932239-82.52019037 30.59548842-82.51086798 68.34111062z" p-id="5406" data-v-c6073ba8></path></svg></div></div></div>
    <script src="/assets/js/app.dd9aac12.js" defer></script><script src="/assets/js/3.3f52b992.js" defer></script><script src="/assets/js/1.86295094.js" defer></script><script src="/assets/js/67.fa18d1cd.js" defer></script>
  </body>
</html>
