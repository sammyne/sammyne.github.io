(window.webpackJsonp=window.webpackJsonp||[]).push([[64],{769:function(s,t,a){"use strict";a.r(t);var n=a(6),e=Object(n.a)({},(function(){var s=this,t=s.$createElement,a=s._self._c||t;return a("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[a("div",{staticClass:"custom-block tip"},[a("p",{staticClass:"title"},[s._v("温馨提示")]),a("p",[s._v("本文从理论到实践，系统地介绍 iptables。如果你想要从头开始了解 iptables，可以查看 "),a("RouterLink",{attrs:{to:"/tag/iptables/"}},[s._v("iptables 系列文章")]),s._v("。")],1)]),a("div",{staticClass:"custom-block danger"},[a("p",{staticClass:"title"},[s._v("高能预警")]),a("p",[s._v("在参照本文进行 iptables 实验时，请务必在个人的测试机进行。iptables 规则设置不当有可能使你无法连接到远程主机。")])]),a("p",[s._v("前面的文章一直在定义规则，准确地讲是一直在 iptables 的默认链定义规则。本文介绍一下 "),a("strong",[s._v("自定义链")]),s._v("。")]),s._v(" "),a("p",[s._v("iptables 的默认链就已经能够满足需求了，为什么还需要自定义链呢？")]),s._v(" "),a("p",[s._v("原因：当默认链的规则非常多时，管理不便。")]),s._v(" "),a("p",[s._v("想象一下，如果 "),a("code",[s._v("INPUT")]),s._v(" 链存放了 200 条规则。这 200 条规则有针对 httpd 服务的，有针对 sshd 服务的，有针对私网 IP 的，有针对公网 IP 的。假如突然想要修改针对 httpd 服务的相关规则，从头看一遍这 200 条规则，找出哪些规则是针对 httpd 的做法显然不合理。")]),s._v(" "),a("p",[s._v("因此，iptables 支持借助自定义链解决上述问题。")]),s._v(" "),a("p",[s._v("自定义一条名为 "),a("code",[s._v("IN_WEB")]),s._v(" 的链，我们可以将所有针对 80 端口的入站规则都写入到这条自定义链。以后想要修改针对 web 服务的入站规则时，直接修改 "),a("code",[s._v("IN_WEB")]),s._v(" 链的规则即可。即使默认链有再多的规则也不怕，因为我们知道所有针对 80 端口的入站规则都存放在 "),a("code",[s._v("IN_WEB")]),s._v(" 链。同理可以将针对 sshd 的出站规则放入到 "),a("code",[s._v("OUT_SSH")]),s._v(" 自定义链，针对 Nginx 的入站规则放入到 "),a("code",[s._v("IN_NGINX")]),s._v(" 自定义链。这样就能实现想改哪里改哪里，再也不同担心找不到规则在哪里了。")]),s._v(" "),a("p",[s._v("但是需要注意的是，自定义链并不能直接使用，而是需要被默认链引用才能够使用。空口白话说不明白，等到演示过后我们自然会明白。")]),s._v(" "),a("h2",{attrs:{id:"自定义链"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#自定义链"}},[s._v("#")]),s._v(" 自定义链")]),s._v(" "),a("p",[s._v("多说无益，我们来动手创建一条自定义链玩一下。使用 "),a("code",[s._v("-N")]),s._v(" 选项可以创建自定义链如下")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[s._v("root@ubuntu:~"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# iptables -F ")]),s._v("\nroot@ubuntu:~"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# iptables -t filter -N IN_WEB")]),s._v("\nroot@ubuntu:~"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# iptables -L")]),s._v("\nChain INPUT "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("policy ACCEPT"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\ntarget     prot opt "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("source")]),s._v("               destination         \n\nChain FORWARD "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("policy ACCEPT"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\ntarget     prot opt "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("source")]),s._v("               destination         \n\nChain OUTPUT "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("policy ACCEPT"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\ntarget     prot opt "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("source")]),s._v("               destination         \n\nChain IN_WEB "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" references"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\ntarget     prot opt "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("source")]),s._v("               destination\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br")])]),a("p",[s._v("相关选项说明如下")]),s._v(" "),a("ul",[a("li",[a("code",[s._v("-t filter")]),s._v(" 表示操作对象为 filter 表。与之前的示例相同，省略 "),a("code",[s._v("-t")]),s._v(" 选项时，默认操作的就是 filter 表。")]),s._v(" "),a("li",[a("code",[s._v("-N IN_WEB")]),s._v(" 表示创建一条自定义链，名称为 "),a("code",[s._v("IN_WEB")]),s._v("。")])]),s._v(" "),a("p",[s._v("自定义链创建完成后，查看 filter 表的链。如上所示，自定义链已经被创建，而且可以看到这条自定义链的引用计数为 0 (0 references)。也就是说，这条自定义链还没有被任何默认链所引用，所以即使 "),a("code",[s._v("IN_WEB")]),s._v(" 配置了规则，也不会生效。暂且把这问题放一边，继续学习自定义链。")]),s._v(" "),a("p",[s._v("自定义链已经创建完毕。现在就可以直接在自定义链上配置规则了。以下是一些示例规则")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[s._v("oot@ubuntu:~"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# iptables -I IN_WEB -s 192.168.44.1 -j REJECT")]),s._v("\nroot@ubuntu:~"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# iptables -t filter -I IN_WEB -s 192.168.44.3 -j REJECT")]),s._v("\nroot@ubuntu:~"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# iptables -nL IN_WEB")]),s._v("\nChain IN_WEB "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" references"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\ntarget     prot opt "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("source")]),s._v("               destination         \nREJECT     all  --  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),s._v(".44.3         "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.0")]),s._v(".0.0/0            reject-with icmp-port-unreachable\nREJECT     all  --  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),s._v(".44.1         "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.0")]),s._v(".0.0/0            reject-with icmp-port-unreachable\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br")])]),a("p",[s._v("如上所示，对自定义链的操作与对默认链的操作并没有什么不同，一切按照操作默认链的方法操作自定义链即可。")]),s._v(" "),a("p",[s._v("自定义链现在已经有了一些规则。但是目前这些规则无法匹配到任何报文，因为并没有在任何默认链引用它。")]),s._v(" "),a("p",[s._v("既然 "),a("code",[s._v("IN_WEB")]),s._v(" 链是为了针对 web 服务的入站规则而创建的，这些规则应该去匹配入站的报文，所以应该用 "),a("code",[s._v("INPUT")]),s._v(" 链去引用它。")]),s._v(" "),a("p",[s._v("现在测试机（IP 为 "),a("code",[s._v("192.168.44.2")]),s._v("）上启动 HTTP 服务")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[s._v("root@ubuntu:~"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# apt install -y mini-httpd curl")]),s._v("\nroot@ubuntu:~"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v('# echo "hello world" > index.html')]),s._v("\nroot@ubuntu:~"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# mini_httpd -h 0.0.0.0")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br")])]),a("p",[s._v("客户端访问测试机可正常获取报文如下")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token function"}},[s._v("curl")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),s._v(".44.2\nhello world\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br")])]),a("p",[s._v("接下来我们测试自定义链。自定义链在哪里创建，应该被哪条默认链引用，取决于实际的工作场景。因为此处示例的规则是匹配入站报文，所以在 "),a("code",[s._v("INPUT")]),s._v(" 链引用自定义链如下")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("div",{staticClass:"highlight-lines"},[a("br"),a("br"),a("br"),a("br"),a("div",{staticClass:"highlighted"},[s._v(" ")]),a("br"),a("br"),a("br"),a("br"),a("br"),a("br"),a("br"),a("div",{staticClass:"highlighted"},[s._v(" ")]),a("br"),a("br"),a("br"),a("br")]),a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[s._v("root@ubuntu:~"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# iptables -I INPUT -p tcp --dport 80 -j IN_WEB")]),s._v("\nroot@ubuntu:~"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# iptables -vL")]),s._v("\nChain INPUT "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("policy ACCEPT "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" packets, "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" bytes"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n pkts bytes target     prot opt "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("in")]),s._v("     out     "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("source")]),s._v("               destination         \n    "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("     "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" IN_WEB     tcp  --  any    any     anywhere             anywhere             tcp dpt:http\n\nChain FORWARD "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("policy ACCEPT "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" packets, "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" bytes"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n pkts bytes target     prot opt "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("in")]),s._v("     out     "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("source")]),s._v("               destination         \n\nChain OUTPUT "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("policy ACCEPT "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" packets, "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" bytes"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n pkts bytes target     prot opt "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("in")]),s._v("     out     "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("source")]),s._v("               destination         \n\nChain IN_WEB "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" references"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n pkts bytes target     prot opt "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("in")]),s._v("     out     "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("source")]),s._v("               destination         \n    "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("     "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" REJECT     all  --  any    any     "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),s._v(".44.3         anywhere             reject-with icmp-port-unreachable\n    "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("     "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" REJECT     all  --  any    any     _gateway             anywhere             reject-with icmp-port-unreachable\n")])]),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br")])]),a("p",[s._v("上述操作在 "),a("code",[s._v("INPUT")]),s._v(" 链添加一条规则，能够匹配访问本机 80 端口的 TCP 报文。")]),s._v(" "),a("p",[s._v("而上述规则中的 "),a("code",[s._v("-j IN_WEB")]),s._v(" 表示：访问 80 端口的 TCP 报文将由自定义链 "),a("code",[s._v("IN_WEB")]),s._v(" 的规则进行处理。之前示例使用 "),a("code",[s._v("-j")]),s._v(' 选项指定动作，而此处将"动作"替换为"自定义链"。当 '),a("code",[s._v("-j")]),s._v(" 对应的值为一个自定义链时，被当前规则匹配到的报文将交由对应的自定义链处理。具体怎样处理，取决于自定义链的规则。"),a("code",[s._v("IN_WEB")]),s._v("  自定义链被 "),a("code",[s._v("INPUT")]),s._v(" 链引用以后，可以发现 "),a("code",[s._v("IN_WEB")]),s._v(" 链的引用计数已经变为 1，表示这条自定义链已经被引用了 1 次。自定义链还可以引用其他的自定义链。感兴趣的话，自己动手吧。")]),s._v(" "),a("p",[s._v('之前的文章说过：iptables 将“动作”称为"target"。这样描述并不准确，因为 target 为目标之意，报文被规则匹配到以后，target 能是一个"动作"，也能是一个"自定义链"。target 为一个动作时，报文按照指定的动作处理；target 为自定义链时，报文由自定义链的规则处理。现在回过头再理解之前的术语，似乎更加明了了。')]),s._v(" "),a("p",[s._v("在 "),a("code",[s._v("192.168.44.1")]),s._v(" 主机尝试访问本机的 80 端口，已经被拒绝访问。证明刚才自定义链的规则已经生效。")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token function"}},[s._v("curl")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),s._v(".44.2\ncurl: "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("7")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" Failed to connect to "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),s._v(".44.2 port "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("80")]),s._v(": Connection refused\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br")])]),a("p",[s._v("过了一段时间，我们觉得 "),a("code",[s._v("IN_WEB")]),s._v(" 这个名字不太合适，可将这条自定义链重命名为 "),a("code",[s._v("WEB")]),s._v(" 如下")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("div",{staticClass:"highlight-lines"},[a("br"),a("br"),a("br"),a("br"),a("div",{staticClass:"highlighted"},[s._v(" ")]),a("br"),a("br"),a("br"),a("br"),a("br"),a("br"),a("br"),a("div",{staticClass:"highlighted"},[s._v(" ")]),a("br"),a("br"),a("br"),a("br")]),a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[s._v("root@ubuntu:~"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# iptables -E IN_WEB WEB")]),s._v("\nroot@ubuntu:~"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# iptables -vL")]),s._v("\nChain INPUT "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("policy ACCEPT "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" packets, "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" bytes"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n pkts bytes target     prot opt "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("in")]),s._v("     out     "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("source")]),s._v("               destination         \n    "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("    "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("64")]),s._v(" WEB        tcp  --  any    any     anywhere             anywhere             tcp dpt:http\n\nChain FORWARD "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("policy ACCEPT "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" packets, "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" bytes"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n pkts bytes target     prot opt "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("in")]),s._v("     out     "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("source")]),s._v("               destination         \n\nChain OUTPUT "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("policy ACCEPT "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" packets, "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" bytes"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n pkts bytes target     prot opt "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("in")]),s._v("     out     "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("source")]),s._v("               destination         \n\nChain WEB "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" references"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n pkts bytes target     prot opt "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("in")]),s._v("     out     "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("source")]),s._v("               destination         \n    "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("     "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" REJECT     all  --  any    any     "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),s._v(".44.3         anywhere             reject-with icmp-port-unreachable\n    "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v("   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("128")]),s._v(" REJECT     all  --  any    any     _gateway             anywhere             reject-with icmp-port-unreachable\n")])]),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br")])]),a("p",[s._v("如上所示，使用 "),a("code",[s._v("-E")]),s._v(" 选项可以修改自定义链名。修改后，引用自定义链处的名称会自动随之更新。")]),s._v(" "),a("p",[s._v("至此，我们已经能够创建自定义链了，那么怎样删除自定义链呢？")]),s._v(" "),a("p",[s._v("使用 "),a("code",[s._v("-X")]),s._v(" 选项可以删除自定义链。但是删除自定义链时，需要满足两个条件：")]),s._v(" "),a("ol",[a("li",[s._v("自定义链没有被任何默认链引用，即自定义链的引用计数为 0。")]),s._v(" "),a("li",[s._v("自定义链没有任何规则，即自定义链为空。")])]),s._v(" "),a("p",[s._v("我们来删除自定义链 "),a("code",[s._v("WEB")]),s._v(" 试试。")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[s._v("root@ubuntu:~"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# iptables -X WEB")]),s._v("\niptables: Too many links.\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br")])]),a("p",[s._v("上述命令使用 "),a("code",[s._v("-X")]),s._v(" 选项删除对应的自定义链，但是没能成功删除自定义链 "),a("code",[s._v("WEB")]),s._v("，提示 "),a("code",[s._v("Too many links")]),s._v("。原因是 "),a("code",[s._v("WEB")]),s._v(" 链已经被默认链所引用，不满足上述条件 1，所以还需要删除对应的引用规则如下")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[s._v("root@ubuntu:~"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# iptables -vL INPUT")]),s._v("\nChain INPUT "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("policy ACCEPT "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("21")]),s._v(" packets, "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2185")]),s._v(" bytes"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n pkts bytes target     prot opt "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("in")]),s._v("     out     "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("source")]),s._v("               destination         \n    "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("    "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("64")]),s._v(" WEB        tcp  --  any    any     anywhere             anywhere             tcp dpt:http\nroot@ubuntu:~"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# iptables -D INPUT 1")]),s._v("\nroot@ubuntu:~"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# iptables -X WEB")]),s._v("\niptables: Directory not empty.\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br")])]),a("p",[s._v("上述命令删除引用自定义链的规则后，再次尝试删除自定义链，提示 "),a("code",[s._v("Directory not empty")]),s._v("。原因是 "),a("code",[s._v("WEB")]),s._v(" 链还有规则，不满足上述条件 2，所以还需要清空对应的自定义链如下")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[s._v("root@ubuntu:~"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# iptables -F WEB")]),s._v("\nroot@ubuntu:~"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# iptables -X WEB")]),s._v("\nroot@ubuntu:~"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# iptables -L")]),s._v("\nChain INPUT "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("policy ACCEPT"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\ntarget     prot opt "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("source")]),s._v("               destination         \n\nChain FORWARD "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("policy ACCEPT"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\ntarget     prot opt "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("source")]),s._v("               destination         \n\nChain OUTPUT "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("policy ACCEPT"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\ntarget     prot opt "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("source")]),s._v("               destination\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br")])]),a("p",[s._v("以上命令使用 "),a("code",[s._v("-X")]),s._v(" 选项可以删除一个引用计数为 0、空的自定义链。")]),s._v(" "),a("h2",{attrs:{id:"小结"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#小结"}},[s._v("#")]),s._v(" 小结")]),s._v(" "),a("p",[s._v("为了便于以后速查，上述命令总结如下。")]),s._v(" "),a("h3",{attrs:{id:"创建自定义链"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#创建自定义链"}},[s._v("#")]),s._v(" 创建自定义链")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#示例：在 filter 表中创建IN_WEB自定义链")]),s._v("\niptables -t filter -N IN_WEB\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br")])]),a("h3",{attrs:{id:"引用自定义链"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#引用自定义链"}},[s._v("#")]),s._v(" 引用自定义链")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#示例：在INPUT链中引用刚才创建的自定义链")]),s._v("\niptables -t filter -I INPUT -p tcp --dport "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("80")]),s._v(" -j IN_WEB\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br")])]),a("h3",{attrs:{id:"重命名自定义链"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#重命名自定义链"}},[s._v("#")]),s._v(" 重命名自定义链")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#示例：将IN_WEB自定义链重命名为WEB")]),s._v("\niptables -E IN_WEB WEB\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br")])]),a("h3",{attrs:{id:"删除自定义链"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#删除自定义链"}},[s._v("#")]),s._v(" 删除自定义链")]),s._v(" "),a("p",[s._v("需要满足两个条件")]),s._v(" "),a("ol",[a("li",[s._v("自定义链没有被引用")]),s._v(" "),a("li",[s._v("自定义链没有任何规则")])]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#示例：删除引用计数为0并且不包含任何规则的WEB链")]),s._v("\niptables -X WEB\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br")])]),a("h2",{attrs:{id:"参考文献"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#参考文献"}},[s._v("#")]),s._v(" 参考文献")]),s._v(" "),a("ul",[a("li",[a("a",{attrs:{href:"http://www.zsythink.net/archives/1625",target:"_blank",rel:"noopener noreferrer"}},[s._v("iptables详解（10）：iptables自定义链"),a("OutboundLink")],1)])])])}),[],!1,null,null,null);t.default=e.exports}}]);