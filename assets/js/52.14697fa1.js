(window.webpackJsonp=window.webpackJsonp||[]).push([[52],{719:function(t,s,a){"use strict";a.r(s);var e=a(6),n=Object(e.a)({},(function(){var t=this,s=t.$createElement,a=t._self._c||s;return a("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[a("div",{staticClass:"custom-block tip"},[a("p",{staticClass:"title"},[t._v("温馨提示")]),a("p",[t._v("本文从理论到实践，系统地介绍 iptables。如果你想要从头开始了解 iptables，可以查看 "),a("RouterLink",{attrs:{to:"/tag/iptables/"}},[t._v("iptables 系列文章")]),t._v("。")],1)]),a("div",{staticClass:"custom-block danger"},[a("p",{staticClass:"title"},[t._v("高能预警")]),a("p",[t._v("在进行 iptables 实验时，请务必在测试机上进行。本文的实验操作环境为 VMware Fusion 12.0 下的 Ubuntu 20.04.1。")])]),a("p",[a("RouterLink",{attrs:{to:"/2021/01/07/iptables-06-extended-rules-tcp-flags/"}},[t._v("前文")]),t._v(" 总结了 iptables 的 tcp 扩展模块。本文总结一下另外两个跟协议有关的常用的扩展模块--udp 扩展与 icmp 扩展。")],1),t._v(" "),a("h2",{attrs:{id:"udp-扩展"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#udp-扩展"}},[t._v("#")]),t._v(" udp 扩展")]),t._v(" "),a("p",[t._v("先来说说 udp 扩展模块。这个扩展模块能用的匹配条件只有两个："),a("code",[t._v("--sport")]),t._v(" 与 "),a("code",[t._v("--dport")]),t._v("，即匹配报文的源端口与目标端口。")]),t._v(" "),a("p",[t._v("tcp 模块也有同名的两个选项。")]),t._v(" "),a("p",[t._v("只不过 udp 扩展模块的 "),a("code",[t._v("--sport")]),t._v(" 与 "),a("code",[t._v("--dport")]),t._v(" 是用于匹配 UDP 协议报文的源端口与目标端口。比如，放行 samba 服务的 137 与 138 这两个 UDP 端口，示例如下")]),t._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[t._v("root@ubuntu:~"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# iptables -I INPUT -p udp -m udp --dport 137 -j ACCEPT")]),t._v("\nroot@ubuntu:~"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# iptables -I INPUT -p udp -m udp --dport 138 -j ACCEPT")]),t._v("\nroot@ubuntu:~"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# iptables -nvL INPUT")]),t._v("\nChain INPUT "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("policy ACCEPT "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v(" packets, "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("285")]),t._v(" bytes"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n pkts bytes target     prot opt "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("in")]),t._v("     out     "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("source")]),t._v("               destination         \n    "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v("     "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v(" ACCEPT     udp  --  *      *       "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0.0")]),t._v(".0.0/0            "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0.0")]),t._v(".0.0/0            udp dpt:138\n    "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v("     "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v(" ACCEPT     udp  --  *      *       "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0.0")]),t._v(".0.0/0            "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0.0")]),t._v(".0.0/0            udp dpt:137\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br"),a("span",{staticClass:"line-number"},[t._v("2")]),a("br"),a("span",{staticClass:"line-number"},[t._v("3")]),a("br"),a("span",{staticClass:"line-number"},[t._v("4")]),a("br"),a("span",{staticClass:"line-number"},[t._v("5")]),a("br"),a("span",{staticClass:"line-number"},[t._v("6")]),a("br"),a("span",{staticClass:"line-number"},[t._v("7")]),a("br")])]),a("p",[t._v("前面的文章说明过：使用扩展匹配条件时，如果未指定扩展模块，iptables 会默认调用与 "),a("code",[t._v("-p")]),t._v(" 对应的协议名称相同的模块。所以使用 "),a("code",[t._v("-p udp")]),t._v(" 时，可以省略 "),a("code",[t._v("-m udp")]),t._v("，示例如下")]),t._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[t._v("root@ubuntu:~"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# iptables -F INPUT")]),t._v("\nroot@ubuntu:~"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# iptables -I INPUT -p udp --dport 137 -j ACCEPT")]),t._v("\nroot@ubuntu:~"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# iptables -I INPUT -p udp --dport 138 -j ACCEPT")]),t._v("\nroot@ubuntu:~"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# iptables -nvL INPUT")]),t._v("\nChain INPUT "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("policy ACCEPT "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v(" packets, "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("76")]),t._v(" bytes"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n pkts bytes target     prot opt "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("in")]),t._v("     out     "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("source")]),t._v("               destination         \n    "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v("     "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v(" ACCEPT     udp  --  *      *       "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0.0")]),t._v(".0.0/0            "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0.0")]),t._v(".0.0/0            udp dpt:138\n    "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v("     "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v(" ACCEPT     udp  --  *      *       "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0.0")]),t._v(".0.0/0            "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0.0")]),t._v(".0.0/0            udp dpt:137\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br"),a("span",{staticClass:"line-number"},[t._v("2")]),a("br"),a("span",{staticClass:"line-number"},[t._v("3")]),a("br"),a("span",{staticClass:"line-number"},[t._v("4")]),a("br"),a("span",{staticClass:"line-number"},[t._v("5")]),a("br"),a("span",{staticClass:"line-number"},[t._v("6")]),a("br"),a("span",{staticClass:"line-number"},[t._v("7")]),a("br"),a("span",{staticClass:"line-number"},[t._v("8")]),a("br")])]),a("p",[t._v("udp 扩展的 "),a("code",[t._v("--sport")]),t._v(" 与 "),a("code",[t._v("--dport")]),t._v(" 同样支持指定一个连续的端口范围，示例如下")]),t._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[t._v("root@ubuntu:~"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# iptables -F INPUT")]),t._v("\nroot@ubuntu:~"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# iptables -I INPUT -p udp --dport 137:157 -j ACCEPT")]),t._v("\nroot@ubuntu:~"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# iptables -nvL INPUT")]),t._v("\nChain INPUT "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("policy ACCEPT "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v(" packets, "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v(" bytes"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n pkts bytes target     prot opt "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("in")]),t._v("     out     "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("source")]),t._v("               destination         \n    "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v("     "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v(" ACCEPT     udp  --  *      *       "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0.0")]),t._v(".0.0/0            "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0.0")]),t._v(".0.0/0            udp dpts:137:157\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br"),a("span",{staticClass:"line-number"},[t._v("2")]),a("br"),a("span",{staticClass:"line-number"},[t._v("3")]),a("br"),a("span",{staticClass:"line-number"},[t._v("4")]),a("br"),a("span",{staticClass:"line-number"},[t._v("5")]),a("br"),a("span",{staticClass:"line-number"},[t._v("6")]),a("br")])]),a("p",[t._v("上述配置表示 137 到 157 之间的所有 UDP 端口全部对外开放，与 tcp 扩展的使用方法相同。")]),t._v(" "),a("p",[t._v("但是** udp 的 "),a("code",[t._v("--sport")]),t._v("与 "),a("code",[t._v("--dport")]),t._v(" 也只能指定连续的端口范围，并不能一次性指定多个离散的端口**。使用之前总结过的 multiport 扩展模块即可指定多个离散的 UDP 端口，具体参见前面文章的 "),a("RouterLink",{attrs:{to:"/2021/01/03/iptables-04-rules-summary-01/#multiport-模块"}},[t._v("multiport 模块")]),t._v("。")],1),t._v(" "),a("p",[t._v("在前文的基础，再理解上述示例就容易多了。此处不再对 udp 模块的 "),a("code",[t._v("--sport")]),t._v(" 与 "),a("code",[t._v("--dport")]),t._v(" 进行赘述。")]),t._v(" "),a("h2",{attrs:{id:"icmp-扩展"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#icmp-扩展"}},[t._v("#")]),t._v(" icmp 扩展")]),t._v(" "),a("p",[t._v("看到 icmp，我们通常会想到 "),a("code",[t._v("ping")]),t._v(" 命令。因为 "),a("code",[t._v("ping")]),t._v(" 命令使用 ICMP 协议。")]),t._v(" "),a("p",[t._v("ICMP 协议的全称为 Internet Control Message Protocol，翻译为互联网控制报文协议。它主要用于探测网络主机是否可用、目标是否可达、网络是否通畅或路由是否可用等。")]),t._v(" "),a("p",[t._v("平常 "),a("code",[t._v("ping")]),t._v(" 某主机时，如果主机可达，对应主机会对 "),a("code",[t._v("ping")]),t._v(" 请求做出回应（此处不考虑禁 "),a("code",[t._v("ping")]),t._v("等情况）。也就是说，发出 "),a("code",[t._v("ping")]),t._v(" 请求，对方回应 "),a("code",[t._v("ping")]),t._v(" 请求。虽然 "),a("code",[t._v("ping")]),t._v(" 请求报文与 "),a("code",[t._v("ping")]),t._v(" 回应报文都属于 ICMP 类型的报文，但是在概念上细分的话，它们所属的类型还是不同的：发出的 "),a("code",[t._v("ping")]),t._v(" 请求属于类型 8 的 ICMP 报文，而对方主机的 "),a("code",[t._v("ping")]),t._v(" 回应报文则属于类型 0 的 ICMP 报文。根据应用场景的不同，ICMP 报文被细分为如下各种类型。")]),t._v(" "),a("table",[a("thead",[a("tr",[a("th",[t._v("TYPE")]),t._v(" "),a("th",[t._v("CODE")]),t._v(" "),a("th",[t._v("Description")]),t._v(" "),a("th",[t._v("Query")]),t._v(" "),a("th",[t._v("Error")])])]),t._v(" "),a("tbody",[a("tr",[a("td",[t._v("0")]),t._v(" "),a("td",[t._v("0")]),t._v(" "),a("td",[t._v("Echo Reply——回显应答（Ping 应答）")]),t._v(" "),a("td",[t._v("x")]),t._v(" "),a("td")]),t._v(" "),a("tr",[a("td",[t._v("3")]),t._v(" "),a("td",[t._v("0")]),t._v(" "),a("td",[t._v("Network Unreachable——网络不可达")]),t._v(" "),a("td"),t._v(" "),a("td",[t._v("x")])]),t._v(" "),a("tr",[a("td",[t._v("3")]),t._v(" "),a("td",[t._v("1")]),t._v(" "),a("td",[t._v("Host Unreachable——主机不可达")]),t._v(" "),a("td"),t._v(" "),a("td",[t._v("x")])]),t._v(" "),a("tr",[a("td",[t._v("3")]),t._v(" "),a("td",[t._v("2")]),t._v(" "),a("td",[t._v("Protocol Unreachable——协议不可达")]),t._v(" "),a("td"),t._v(" "),a("td",[t._v("x")])]),t._v(" "),a("tr",[a("td",[t._v("3")]),t._v(" "),a("td",[t._v("3")]),t._v(" "),a("td",[t._v("Port Unreachable——端口不可达")]),t._v(" "),a("td"),t._v(" "),a("td",[t._v("x")])]),t._v(" "),a("tr",[a("td",[t._v("3")]),t._v(" "),a("td",[t._v("4")]),t._v(" "),a("td",[t._v("Fragmentation needed but no frag. bit set——需要进行分片但设置不分片比特")]),t._v(" "),a("td"),t._v(" "),a("td",[t._v("x")])]),t._v(" "),a("tr",[a("td",[t._v("3")]),t._v(" "),a("td",[t._v("5")]),t._v(" "),a("td",[t._v("Source routing failed——源站选路失败")]),t._v(" "),a("td"),t._v(" "),a("td",[t._v("x")])]),t._v(" "),a("tr",[a("td",[t._v("3")]),t._v(" "),a("td",[t._v("6")]),t._v(" "),a("td",[t._v("Destination network unknown——目的网络未知")]),t._v(" "),a("td"),t._v(" "),a("td",[t._v("x")])]),t._v(" "),a("tr",[a("td",[t._v("3")]),t._v(" "),a("td",[t._v("7")]),t._v(" "),a("td",[t._v("Destination host unknown——目的主机未知")]),t._v(" "),a("td"),t._v(" "),a("td",[t._v("x")])]),t._v(" "),a("tr",[a("td",[t._v("3")]),t._v(" "),a("td",[t._v("8")]),t._v(" "),a("td",[t._v("Source host isolated (obsolete)——源主机被隔离（作废不用）")]),t._v(" "),a("td"),t._v(" "),a("td",[t._v("x")])]),t._v(" "),a("tr",[a("td",[t._v("3")]),t._v(" "),a("td",[t._v("9")]),t._v(" "),a("td",[t._v("Destination network administratively prohibited——目的网络被强制禁止")]),t._v(" "),a("td"),t._v(" "),a("td",[t._v("x")])]),t._v(" "),a("tr",[a("td",[t._v("3")]),t._v(" "),a("td",[t._v("10")]),t._v(" "),a("td",[t._v("0\tDestination host administratively prohibited——目的主机被强制禁止")]),t._v(" "),a("td"),t._v(" "),a("td",[t._v("x")])]),t._v(" "),a("tr",[a("td",[t._v("3")]),t._v(" "),a("td",[t._v("11")]),t._v(" "),a("td",[t._v("1\tNetwork unreachable for TOS——由于服务类型TOS，网络不可达")]),t._v(" "),a("td"),t._v(" "),a("td",[t._v("x")])]),t._v(" "),a("tr",[a("td",[t._v("3")]),t._v(" "),a("td",[t._v("12")]),t._v(" "),a("td",[t._v("2\tHost unreachable for TOS——由于服务类型TOS，主机不可达")]),t._v(" "),a("td"),t._v(" "),a("td",[t._v("x")])]),t._v(" "),a("tr",[a("td",[t._v("3")]),t._v(" "),a("td",[t._v("13")]),t._v(" "),a("td",[t._v("3\tCommunication administratively prohibited by filtering——由于过滤，通信被强制禁止")]),t._v(" "),a("td"),t._v(" "),a("td",[t._v("x")])]),t._v(" "),a("tr",[a("td",[t._v("3")]),t._v(" "),a("td",[t._v("14")]),t._v(" "),a("td",[t._v("4\tHost precedence violation——主机越权")]),t._v(" "),a("td"),t._v(" "),a("td",[t._v("x")])]),t._v(" "),a("tr",[a("td",[t._v("3")]),t._v(" "),a("td",[t._v("15")]),t._v(" "),a("td",[t._v("5\tPrecedence cutoff in effect——优先中止生效")]),t._v(" "),a("td"),t._v(" "),a("td",[t._v("x")])]),t._v(" "),a("tr",[a("td",[t._v("4")]),t._v(" "),a("td",[t._v("0")]),t._v(" "),a("td",[t._v("Source quench——源端被关闭（基本流控制）")]),t._v(" "),a("td"),t._v(" "),a("td",[t._v("x")])]),t._v(" "),a("tr",[a("td",[t._v("5")]),t._v(" "),a("td",[t._v("0")]),t._v(" "),a("td",[t._v("Redirect for network——对网络重定向")]),t._v(" "),a("td"),t._v(" "),a("td",[t._v("x")])]),t._v(" "),a("tr",[a("td",[t._v("5")]),t._v(" "),a("td",[t._v("1")]),t._v(" "),a("td",[t._v("Redirect for host——对主机重定向")]),t._v(" "),a("td"),t._v(" "),a("td",[t._v("x")])]),t._v(" "),a("tr",[a("td",[t._v("5")]),t._v(" "),a("td",[t._v("2")]),t._v(" "),a("td",[t._v("Redirect for TOS and network——对服务类型和网络重定向")]),t._v(" "),a("td"),t._v(" "),a("td",[t._v("x")])]),t._v(" "),a("tr",[a("td",[t._v("5")]),t._v(" "),a("td",[t._v("3")]),t._v(" "),a("td",[t._v("Redirect for TOS and host——对服务类型和主机重定向")]),t._v(" "),a("td"),t._v(" "),a("td",[t._v("x")])]),t._v(" "),a("tr",[a("td",[t._v("8")]),t._v(" "),a("td",[t._v("0")]),t._v(" "),a("td",[t._v("Echo request——回显请求（Ping 请求）")]),t._v(" "),a("td",[t._v("x")]),t._v(" "),a("td")]),t._v(" "),a("tr",[a("td",[t._v("9")]),t._v(" "),a("td",[t._v("0")]),t._v(" "),a("td",[t._v("Router advertisement——路由器通告")]),t._v(" "),a("td",[t._v("x")]),t._v(" "),a("td")]),t._v(" "),a("tr",[a("td",[t._v("10")]),t._v(" "),a("td",[t._v("0")]),t._v(" "),a("td",[t._v("Route solicitation——路由器请求")]),t._v(" "),a("td",[t._v("x")]),t._v(" "),a("td")]),t._v(" "),a("tr",[a("td",[t._v("11")]),t._v(" "),a("td",[t._v("0")]),t._v(" "),a("td",[t._v("TTL equals 0 during transit——传输期间生存时间为0")]),t._v(" "),a("td"),t._v(" "),a("td",[t._v("x")])]),t._v(" "),a("tr",[a("td",[t._v("11")]),t._v(" "),a("td",[t._v("1")]),t._v(" "),a("td",[t._v("TTL equals 0 during reassembly——在数据报组装期间生存时间为0")]),t._v(" "),a("td"),t._v(" "),a("td",[t._v("x")])]),t._v(" "),a("tr",[a("td",[t._v("12")]),t._v(" "),a("td",[t._v("0")]),t._v(" "),a("td",[t._v("IP header bad (catchall error)——坏的 IP 首部（包括各种差错）")]),t._v(" "),a("td"),t._v(" "),a("td",[t._v("x")])]),t._v(" "),a("tr",[a("td",[t._v("12")]),t._v(" "),a("td",[t._v("1")]),t._v(" "),a("td",[t._v("Required options missing——缺少必需的选项")]),t._v(" "),a("td"),t._v(" "),a("td",[t._v("x")])]),t._v(" "),a("tr",[a("td",[t._v("13")]),t._v(" "),a("td",[t._v("0")]),t._v(" "),a("td",[t._v("Timestamp request (obsolete)——时间戳请求（作废不用）")]),t._v(" "),a("td",[t._v("x")]),t._v(" "),a("td")]),t._v(" "),a("tr",[a("td",[t._v("14")]),t._v(" "),a("td",[t._v("0")]),t._v(" "),a("td",[t._v("Timestamp reply (obsolete)——时间戳应答（作废不用）")]),t._v(" "),a("td",[t._v("x")]),t._v(" "),a("td")]),t._v(" "),a("tr",[a("td",[t._v("15")]),t._v(" "),a("td",[t._v("0")]),t._v(" "),a("td",[t._v("Information request (obsolete)——信息请求（作废不用）")]),t._v(" "),a("td",[t._v("x")]),t._v(" "),a("td")]),t._v(" "),a("tr",[a("td",[t._v("16")]),t._v(" "),a("td",[t._v("0")]),t._v(" "),a("td",[t._v("Information reply (obsolete)——信息应答（作废不用）")]),t._v(" "),a("td",[t._v("x")]),t._v(" "),a("td")]),t._v(" "),a("tr",[a("td",[t._v("17")]),t._v(" "),a("td",[t._v("0")]),t._v(" "),a("td",[t._v("Address mask request——地址掩码请求")]),t._v(" "),a("td",[t._v("x")]),t._v(" "),a("td")]),t._v(" "),a("tr",[a("td",[t._v("18")]),t._v(" "),a("td",[t._v("0")]),t._v(" "),a("td",[t._v("Address mask reply——地址掩码应答")]),t._v(" "),a("td",[t._v("x")]),t._v(" "),a("td")])])]),t._v(" "),a("p",[t._v('由上表可知，所有表示"目标不可达"的 ICMP 报文的类型码 '),a("code",[t._v("type")]),t._v(' 为 3，而"目标不可达"又可以细分为以下多种情况')]),t._v(" "),a("ul",[a("li",[t._v("网络不可达")]),t._v(" "),a("li",[t._v("主机不可达")]),t._v(" "),a("li",[t._v("端口不可达")])]),t._v(" "),a("p",[t._v("所以为了细分它们，ICMP 将每种 "),a("code",[t._v("type")]),t._v(" 又细分为对应 "),a("code",[t._v("code")]),t._v("。用不同的 "),a("code",[t._v("code")]),t._v(" 对应具体场景。因此可以使用 "),a("code",[t._v("type/code")]),t._v(" 去匹配具体类型的 ICMP 报文。比如可以使用 "),a("code",[t._v("3/1")]),t._v(" 表示主机不可达的 ICMP 报文。")]),t._v(" "),a("p",[t._v("上表的第一行就表示 "),a("code",[t._v("ping")]),t._v(" 回应报文，它的 "),a("code",[t._v("type")]),t._v(" 为 0，"),a("code",[t._v("code")]),t._v(" 也为 0。由图可知，"),a("code",[t._v("ping")]),t._v(" 回应报文属于查询类（query）的 ICMP 报文。从大类上分，ICMP 报文还能分为 "),a("strong",[t._v("查询类")]),t._v(" 与 "),a("strong",[t._v("错误类")]),t._v(" 两大类。目标不可达类的 ICMP 报文则属于错误类报文。")]),t._v(" "),a("p",[a("code",[t._v("ping")]),t._v(" 请求报文对应的 "),a("code",[t._v("type")]),t._v(" 为 8，"),a("code",[t._v("code")]),t._v(" 为 0。")]),t._v(" "),a("p",[t._v("了解完上述概念，我们来看一些应用场景。")]),t._v(" "),a("p",[t._v("为了禁止所有 ICMP 类型的报文进入本机，可以进行如下设置")]),t._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[t._v("root@ubuntu:~"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# iptables -F INPUT")]),t._v("\nroot@ubuntu:~"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# iptables -I INPUT -p icmp -j REJECT")]),t._v("\nroot@ubuntu:~"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# iptables -L INPUT")]),t._v("\nChain INPUT "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("policy ACCEPT"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\ntarget     prot opt "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("source")]),t._v("               destination         \nREJECT     icmp --  anywhere             anywhere             reject-with icmp-port-unreachable\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br"),a("span",{staticClass:"line-number"},[t._v("2")]),a("br"),a("span",{staticClass:"line-number"},[t._v("3")]),a("br"),a("span",{staticClass:"line-number"},[t._v("4")]),a("br"),a("span",{staticClass:"line-number"},[t._v("5")]),a("br"),a("span",{staticClass:"line-number"},[t._v("6")]),a("br")])]),a("p",[t._v("上述命令没有使用任何扩展匹配条件，只是使用 "),a("code",[t._v("-p icmp")]),t._v(" 匹配所有 ICMP 协议类型的报文。")]),t._v(" "),a("p",[t._v("进行上述设置后，别的主机（"),a("code",[t._v("192.168.44.1")]),t._v("）向我们（"),a("code",[t._v("192.168.44.2")]),t._v("）发送的 "),a("code",[t._v("ping")]),t._v(" 请求报文无法进入 "),a("strong",[t._v("防火墙")]),t._v("。我们向别人发送的 "),a("code",[t._v("ping")]),t._v(" 请求对应的回应报文也无法进入防火墙。因此，")]),t._v(" "),a("p",[t._v("我们无法 "),a("code",[t._v("ping")]),t._v(" 通别人，")]),t._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[t._v("root@ubuntu:~"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# ping 192.168.44.1")]),t._v("\nPING "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("192.168")]),t._v(".44.1 "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("192.168")]),t._v(".44.1"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("56")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("84")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" bytes of data.\n^C\n--- "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("192.168")]),t._v(".44.1 "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("ping")]),t._v(" statistics ---\n"),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("13")]),t._v(" packets transmitted, "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v(" received, "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("100")]),t._v("% packet loss, "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("time")]),t._v(" 12294ms\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br"),a("span",{staticClass:"line-number"},[t._v("2")]),a("br"),a("span",{staticClass:"line-number"},[t._v("3")]),a("br"),a("span",{staticClass:"line-number"},[t._v("4")]),a("br"),a("span",{staticClass:"line-number"},[t._v("5")]),a("br")])]),a("p",[t._v("别人也无法 "),a("code",[t._v("ping")]),t._v(" 通我们。")]),t._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token function"}},[t._v("ping")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("192.168")]),t._v(".44.2\nPING "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("192.168")]),t._v(".44.2 "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("192.168")]),t._v(".44.2"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(": "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("56")]),t._v(" data bytes\n"),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("92")]),t._v(" bytes from "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("192.168")]),t._v(".44.2: Destination Port Unreachable\nVr HL TOS  Len   ID Flg  off TTL Pro  cks      Src      Dst\n "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("4")]),t._v("  "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("5")]),t._v("  00 "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("5400")]),t._v(" 07f2   "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v(" 0000  "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("40")]),t._v("  01 "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("9963")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("192.168")]),t._v(".44.1  "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("192.168")]),t._v(".44.2 \n\nRequest "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("timeout")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("for")]),t._v(" icmp_seq "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("92")]),t._v(" bytes from "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("192.168")]),t._v(".44.2: Destination Port Unreachable\nVr HL TOS  Len   ID Flg  off TTL Pro  cks      Src      Dst\n "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("4")]),t._v("  "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("5")]),t._v("  00 "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("5400")]),t._v(" 0dfc   "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v(" 0000  "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("40")]),t._v("  01 "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("9359")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("192.168")]),t._v(".44.1  "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("192.168")]),t._v(".44.2 \n\nRequest "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("timeout")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("for")]),t._v(" icmp_seq "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("92")]),t._v(" bytes from "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("192.168")]),t._v(".44.2: Destination Port Unreachable\nVr HL TOS  Len   ID Flg  off TTL Pro  cks      Src      Dst\n "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("4")]),t._v("  "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("5")]),t._v("  00 "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("5400")]),t._v(" cb9a   "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v(" 0000  "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("40")]),t._v("  01 d5ba "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("192.168")]),t._v(".44.1  "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("192.168")]),t._v(".44.2 \n\n^C\n--- "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("192.168")]),t._v(".44.2 "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("ping")]),t._v(" statistics ---\n"),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("3")]),t._v(" packets transmitted, "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v(" packets received, "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("100.0")]),t._v("% packet loss\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br"),a("span",{staticClass:"line-number"},[t._v("2")]),a("br"),a("span",{staticClass:"line-number"},[t._v("3")]),a("br"),a("span",{staticClass:"line-number"},[t._v("4")]),a("br"),a("span",{staticClass:"line-number"},[t._v("5")]),a("br"),a("span",{staticClass:"line-number"},[t._v("6")]),a("br"),a("span",{staticClass:"line-number"},[t._v("7")]),a("br"),a("span",{staticClass:"line-number"},[t._v("8")]),a("br"),a("span",{staticClass:"line-number"},[t._v("9")]),a("br"),a("span",{staticClass:"line-number"},[t._v("10")]),a("br"),a("span",{staticClass:"line-number"},[t._v("11")]),a("br"),a("span",{staticClass:"line-number"},[t._v("12")]),a("br"),a("span",{staticClass:"line-number"},[t._v("13")]),a("br"),a("span",{staticClass:"line-number"},[t._v("14")]),a("br"),a("span",{staticClass:"line-number"},[t._v("15")]),a("br"),a("span",{staticClass:"line-number"},[t._v("16")]),a("br"),a("span",{staticClass:"line-number"},[t._v("17")]),a("br"),a("span",{staticClass:"line-number"},[t._v("18")]),a("br"),a("span",{staticClass:"line-number"},[t._v("19")]),a("br")])]),a("p",[t._v("假设此刻需求有变，要 "),a("code",[t._v("ping")]),t._v(" 通别人，但是不想让别人 "),a("code",[t._v("ping")]),t._v(" 通我们。刚才的配置就不行了。可以进行如下设置（此处不考虑禁 "),a("code",[t._v("ping")]),t._v(" 的情况）")]),t._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[t._v("root@ubuntu:~"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# iptables -F")]),t._v("\nroot@ubuntu:~"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# iptables -I INPUT -p icmp -m icmp --icmp-type 8/0 -j REJECT")]),t._v("\nroot@ubuntu:~"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# iptables -L INPUT")]),t._v("\nChain INPUT "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("policy ACCEPT"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\ntarget     prot opt "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("source")]),t._v("               destination         \nREJECT     icmp --  anywhere             anywhere             icmptype "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("8")]),t._v(" code "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v(" reject-with icmp-port-unreachable\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br"),a("span",{staticClass:"line-number"},[t._v("2")]),a("br"),a("span",{staticClass:"line-number"},[t._v("3")]),a("br"),a("span",{staticClass:"line-number"},[t._v("4")]),a("br"),a("span",{staticClass:"line-number"},[t._v("5")]),a("br"),a("span",{staticClass:"line-number"},[t._v("6")]),a("br")])]),a("p",[t._v("相关选项说明如下")]),t._v(" "),a("ul",[a("li",[a("code",[t._v("-m icmp")]),t._v(" 表示使用 icmp 扩展。因为上例使用 "),a("code",[t._v("-p icmp")]),t._v("，所以 "),a("code",[t._v("-m icmp")]),t._v(" 可以省略。")]),t._v(" "),a("li",[a("code",[t._v("--icmp-type")]),t._v(" 选项表示根据具体的 "),a("code",[t._v("type")]),t._v(" 与 "),a("code",[t._v("code")]),t._v(" 去匹配对应的 ICMP 报文。\n"),a("ul",[a("li",[t._v("此处的 "),a("code",[t._v("--icmp-type 8/0")]),t._v(" 表示 ICMP 报文的 "),a("code",[t._v("type")]),t._v(" 为 8，"),a("code",[t._v("code")]),t._v(" 为 0 才会被匹配到，也就是只有 "),a("code",[t._v("ping")]),t._v(" 请求类型的报文才能被匹配到。所以别人对我们发起的 "),a("code",[t._v("ping")]),t._v(" 请求将会被拒绝通过防火墙。而我们能够 "),a("code",[t._v("ping")]),t._v(" 通别人，是因为别人回应的 ICMP 报文的 "),a("code",[t._v("type")]),t._v(" 为 0，"),a("code",[t._v("code")]),t._v(" 也为 0，无法被上述规则匹配到，所以我们可以看到别人回应的信息。")])])])]),t._v(" "),a("p",[t._v("配置之后，我们 "),a("code",[t._v("ping")]),t._v(" 别人的结果如下")]),t._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[t._v("root@ubuntu:~"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# ping 192.168.44.1")]),t._v("\nPING "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("192.168")]),t._v(".44.1 "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("192.168")]),t._v(".44.1"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("56")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("84")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" bytes of data.\n"),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("64")]),t._v(" bytes from "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("192.168")]),t._v(".44.1: "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("icmp_seq")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("ttl")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("64")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("time")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0.336")]),t._v(" ms\n"),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("64")]),t._v(" bytes from "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("192.168")]),t._v(".44.1: "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("icmp_seq")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("2")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("ttl")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("64")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("time")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0.385")]),t._v(" ms\n"),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("64")]),t._v(" bytes from "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("192.168")]),t._v(".44.1: "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("icmp_seq")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("3")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("ttl")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("64")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("time")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0.310")]),t._v(" ms\n^C\n--- "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("192.168")]),t._v(".44.1 "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("ping")]),t._v(" statistics ---\n"),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("3")]),t._v(" packets transmitted, "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("3")]),t._v(" received, "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v("% packet loss, "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("time")]),t._v(" 2017ms\nrtt min/avg/max/mdev "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0.310")]),t._v("/0.343/0.385/0.031 ms\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br"),a("span",{staticClass:"line-number"},[t._v("2")]),a("br"),a("span",{staticClass:"line-number"},[t._v("3")]),a("br"),a("span",{staticClass:"line-number"},[t._v("4")]),a("br"),a("span",{staticClass:"line-number"},[t._v("5")]),a("br"),a("span",{staticClass:"line-number"},[t._v("6")]),a("br"),a("span",{staticClass:"line-number"},[t._v("7")]),a("br"),a("span",{staticClass:"line-number"},[t._v("8")]),a("br"),a("span",{staticClass:"line-number"},[t._v("9")]),a("br")])]),a("p",[t._v("别人 "),a("code",[t._v("ping")]),t._v(" 我们的结果如下")]),t._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token function"}},[t._v("ping")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("192.168")]),t._v(".44.2\nPING "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("192.168")]),t._v(".44.2 "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("192.168")]),t._v(".44.2"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(": "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("56")]),t._v(" data bytes\n"),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("92")]),t._v(" bytes from "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("192.168")]),t._v(".44.2: Destination Port Unreachable\nVr HL TOS  Len   ID Flg  off TTL Pro  cks      Src      Dst\n "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("4")]),t._v("  "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("5")]),t._v("  00 "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("5400")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("4592")]),t._v("   "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v(" 0000  "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("40")]),t._v("  01 5bc3 "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("192.168")]),t._v(".44.1  "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("192.168")]),t._v(".44.2 \n\nRequest "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("timeout")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("for")]),t._v(" icmp_seq "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("92")]),t._v(" bytes from "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("192.168")]),t._v(".44.2: Destination Port Unreachable\nVr HL TOS  Len   ID Flg  off TTL Pro  cks      Src      Dst\n "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("4")]),t._v("  "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("5")]),t._v("  00 "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("5400")]),t._v(" cf7d   "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v(" 0000  "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("40")]),t._v("  01 d1d7 "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("192.168")]),t._v(".44.1  "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("192.168")]),t._v(".44.2 \n\n^C\n--- "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("192.168")]),t._v(".44.2 "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("ping")]),t._v(" statistics ---\n"),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("2")]),t._v(" packets transmitted, "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v(" packets received, "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("100.0")]),t._v("% packet loss\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br"),a("span",{staticClass:"line-number"},[t._v("2")]),a("br"),a("span",{staticClass:"line-number"},[t._v("3")]),a("br"),a("span",{staticClass:"line-number"},[t._v("4")]),a("br"),a("span",{staticClass:"line-number"},[t._v("5")]),a("br"),a("span",{staticClass:"line-number"},[t._v("6")]),a("br"),a("span",{staticClass:"line-number"},[t._v("7")]),a("br"),a("span",{staticClass:"line-number"},[t._v("8")]),a("br"),a("span",{staticClass:"line-number"},[t._v("9")]),a("br"),a("span",{staticClass:"line-number"},[t._v("10")]),a("br"),a("span",{staticClass:"line-number"},[t._v("11")]),a("br"),a("span",{staticClass:"line-number"},[t._v("12")]),a("br"),a("span",{staticClass:"line-number"},[t._v("13")]),a("br"),a("span",{staticClass:"line-number"},[t._v("14")]),a("br")])]),a("p",[t._v("因为 "),a("code",[t._v("type")]),t._v(" 为 8 的类型下只有一个 "),a("code",[t._v("code")]),t._v(" 为 0 的类型，所以可以省略对应的 "),a("code",[t._v("code")]),t._v(" 如下")]),t._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[t._v("root@ubuntu:~"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# iptables -F")]),t._v("\nroot@ubuntu:~"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# iptables -I INPUT -p icmp --icmp-type 8 -j REJECT")]),t._v("\nroot@ubuntu:~"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# iptables -L INPUT")]),t._v("\nChain INPUT "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("policy ACCEPT"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\ntarget     prot opt "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("source")]),t._v("               destination         \nREJECT     icmp --  anywhere             anywhere             icmp echo-request reject-with icmp-port-unreachable\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br"),a("span",{staticClass:"line-number"},[t._v("2")]),a("br"),a("span",{staticClass:"line-number"},[t._v("3")]),a("br"),a("span",{staticClass:"line-number"},[t._v("4")]),a("br"),a("span",{staticClass:"line-number"},[t._v("5")]),a("br"),a("span",{staticClass:"line-number"},[t._v("6")]),a("br")])]),a("p",[t._v("除了能够使用对应 "),a("code",[t._v("type/code")]),t._v(" 匹配到具体类型的 ICMP 报文以外，还能用 ICMP 报文的描述名称去匹配对应类型的报文如下")]),t._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[t._v("root@ubuntu:~"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# iptables -F")]),t._v("\nroot@ubuntu:~"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v('# iptables -I INPUT -p icmp --icmp-type "echo-request" -j REJECT')]),t._v("\nroot@ubuntu:~"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v('# iptables -I INPUT -p icmp --icmp-type "ip-header-bad" -j REJECT')]),t._v("\nroot@ubuntu:~"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# iptables -L INPUT")]),t._v("\nChain INPUT "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("policy ACCEPT"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\ntarget     prot opt "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("source")]),t._v("               destination         \nREJECT     icmp --  anywhere             anywhere             icmp ip-header-bad reject-with icmp-port-unreachable\nREJECT     icmp --  anywhere             anywhere             icmp echo-request reject-with icmp-port-unreachable\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br"),a("span",{staticClass:"line-number"},[t._v("2")]),a("br"),a("span",{staticClass:"line-number"},[t._v("3")]),a("br"),a("span",{staticClass:"line-number"},[t._v("4")]),a("br"),a("span",{staticClass:"line-number"},[t._v("5")]),a("br"),a("span",{staticClass:"line-number"},[t._v("6")]),a("br"),a("span",{staticClass:"line-number"},[t._v("7")]),a("br"),a("span",{staticClass:"line-number"},[t._v("8")]),a("br")])]),a("p",[t._v("上述命令使用的 "),a("code",[t._v('--icmp-type "echo-request"')]),t._v(" 与 "),a("code",[t._v("--icmp-type 8/0")]),t._v(" 的效果完全相同。参考本文最上方的表格即可获取对应的 ICMP 类型描述名称。")]),t._v(" "),a("p",[t._v('注意：名称中的"空格"需要替换为 '),a("code",[t._v("-")]),t._v("。")]),t._v(" "),a("h2",{attrs:{id:"小结"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#小结"}},[t._v("#")]),t._v(" 小结")]),t._v(" "),a("h3",{attrs:{id:"udp-扩展-2"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#udp-扩展-2"}},[t._v("#")]),t._v(" udp 扩展")]),t._v(" "),a("p",[t._v("常用的扩展匹配条件")]),t._v(" "),a("ul",[a("li",[a("code",[t._v("--sport")]),t._v("：匹配 udp 报文的源地址")]),t._v(" "),a("li",[a("code",[t._v("--dport")]),t._v("：匹配 udp 报文的目标地址")])]),t._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#示例")]),t._v("\niptables -t filter -I INPUT -p udp -m udp --dport "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("137")]),t._v(" -j ACCEPT\niptables -t filter -I INPUT -p udp -m udp --dport "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("137")]),t._v(":157 -j ACCEPT\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#可以结合multiport模块指定多个离散的端口")]),t._v("\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br"),a("span",{staticClass:"line-number"},[t._v("2")]),a("br"),a("span",{staticClass:"line-number"},[t._v("3")]),a("br"),a("span",{staticClass:"line-number"},[t._v("4")]),a("br")])]),a("h3",{attrs:{id:"icmp-扩展-2"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#icmp-扩展-2"}},[t._v("#")]),t._v(" icmp 扩展")]),t._v(" "),a("p",[t._v("常用的扩展匹配条件")]),t._v(" "),a("ul",[a("li",[a("code",[t._v("--icmp-type")]),t._v("：匹配 ICMP 报文的具体类型")])]),t._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#示例")]),t._v("\niptables -t filter -I INPUT -p icmp -m icmp --icmp-type "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("8")]),t._v("/0 -j REJECT\niptables -t filter -I INPUT -p icmp --icmp-type "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("8")]),t._v(" -j REJECT\niptables -t filter -I OUTPUT -p icmp -m icmp --icmp-type "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v("/0 -j REJECT\niptables -t filter -I OUTPUT -p icmp --icmp-type "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v(" -j REJECT\niptables -t filter -I INPUT -p icmp --icmp-type "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"echo-request"')]),t._v(" -j REJECT\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br"),a("span",{staticClass:"line-number"},[t._v("2")]),a("br"),a("span",{staticClass:"line-number"},[t._v("3")]),a("br"),a("span",{staticClass:"line-number"},[t._v("4")]),a("br"),a("span",{staticClass:"line-number"},[t._v("5")]),a("br"),a("span",{staticClass:"line-number"},[t._v("6")]),a("br")])]),a("h2",{attrs:{id:"参考文献"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#参考文献"}},[t._v("#")]),t._v(" 参考文献")]),t._v(" "),a("ul",[a("li",[a("a",{attrs:{href:"http://www.zsythink.net/archives/1588",target:"_blank",rel:"noopener noreferrer"}},[t._v("iptables 详解（7）：iptables 扩展之 udp 扩展与 icmp 扩展"),a("OutboundLink")],1)])])])}),[],!1,null,null,null);s.default=n.exports}}]);