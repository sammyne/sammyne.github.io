(window.webpackJsonp=window.webpackJsonp||[]).push([[80],{816:function(e,n,r){"use strict";r.r(n);var s=r(6),t=Object(s.a)({},(function(){var e=this,n=e.$createElement,r=e._self._c||n;return r("ContentSlotsDistributor",{attrs:{"slot-key":e.$parent.slotKey}},[r("blockquote",[r("p",[e._v("本教程是用的是 3.12.0 版本的 "),r("a",{attrs:{href:"https://github.com/OP-TEE/optee_os/tree/3.12.0",target:"_blank",rel:"noopener noreferrer"}},[e._v("optee"),r("OutboundLink")],1),e._v("，运行环境为 QEMU 虚拟的 ARMv8 架构。")])]),e._v(" "),r("p",[e._v("如果系统有 ATF（ARM Trusted Frimware）（ATF 知识请参考 ATF 相关文档），OP-TEE OS 在 bl32 阶段启动，通过 bl31 阶段调用 "),r("a",{attrs:{href:"https://github.com/sammyne/trusted-firmware-a/blob/v2.3/services/spd/opteed/opteed_helpers.S#L21",target:"_blank",rel:"noopener noreferrer"}},[e._v("opteed_enter_sp"),r("OutboundLink")],1),e._v(" 函数跳转到 OP-TEE OS 执行启动操作。")]),e._v(" "),r("p",[e._v("以 QEMU+OP-TEE 的方式运行 TEE 时，OP-TEE image 的链接文件是 optee_os/core/arch/arm/kernel/kern.ld.S，由文件可知 TEE image 启动的入口函数是 "),r("a",{attrs:{href:"https://github.com/OP-TEE/optee_os/blob/3.12.0/core/arch/arm/kernel/kern.ld.S#L74",target:"_blank",rel:"noopener noreferrer"}},[e._v("_start"),r("OutboundLink")],1),e._v(" 函数。")]),e._v(" "),r("p",[r("code",[e._v("_start")]),e._v(" 函数定义在 optee_os/core/arch/arm 目录的不同文件，不同的板子拥有不同的 .S 文件。本文教程是用 QEMU 模拟 ARMv8，故使用 QEMU+OPTEE 运行 TEE 时，入口函数定义在 "),r("a",{attrs:{href:"https://github.com/OP-TEE/optee_os/blob/3.12.0/core/arch/arm/kernel/entry_a64.S#L57",target:"_blank",rel:"noopener noreferrer"}},[e._v("core/arch/arm/kernel/entry_a64.S"),r("OutboundLink")],1),e._v(" 文件。整个启动的大致流程图如下（只考虑主 CPU 的启动）：")]),e._v(" "),r("div",{staticClass:"language- line-numbers-mode"},[r("pre",{pre:!0,attrs:{class:"language-text"}},[r("code",[e._v("+-------------------------------+               +-------------------------+\n|            _start             |               | thread_clr_boot_thread  |\n+---------------+---------------+               +-------------+-----------+\n                |                                             ^\n                |                                             |\n                v                                             |\n+---------------+---------------+               +-------------+-----------+\n|          set_sctlr_el1        |               |     boot_init_primary   |\n+---------------+---------------+               +-------------+-----------+\n                |                                             ^\n                |                                             |\n                v                                             |\n+---------------+---------------+               +-------------+-----------+\n|           copy_init           |               |        enable_mmu       |\n+---------------+---------------+               +-------------+-----------+\n                |                                             ^\n                |                                             |\n                v                                             |\n+---------------+---------------+               +-------------+-----------+\n|            set_sp             |               |     core_init_mmu_map   |\n+---------------+---------------+               +-------------+-----------+\n                |                                             ^\n                |                                             |\n                v                                             |\n+---------------+---------------+               +-------------+-----------+\n| thread_init_thread_core_local +--------------\x3e+ dcache_cleaninv_range   |\n+-------------------------------+               +-------------------------+\n")])]),e._v(" "),r("div",{staticClass:"line-numbers-wrapper"},[r("span",{staticClass:"line-number"},[e._v("1")]),r("br"),r("span",{staticClass:"line-number"},[e._v("2")]),r("br"),r("span",{staticClass:"line-number"},[e._v("3")]),r("br"),r("span",{staticClass:"line-number"},[e._v("4")]),r("br"),r("span",{staticClass:"line-number"},[e._v("5")]),r("br"),r("span",{staticClass:"line-number"},[e._v("6")]),r("br"),r("span",{staticClass:"line-number"},[e._v("7")]),r("br"),r("span",{staticClass:"line-number"},[e._v("8")]),r("br"),r("span",{staticClass:"line-number"},[e._v("9")]),r("br"),r("span",{staticClass:"line-number"},[e._v("10")]),r("br"),r("span",{staticClass:"line-number"},[e._v("11")]),r("br"),r("span",{staticClass:"line-number"},[e._v("12")]),r("br"),r("span",{staticClass:"line-number"},[e._v("13")]),r("br"),r("span",{staticClass:"line-number"},[e._v("14")]),r("br"),r("span",{staticClass:"line-number"},[e._v("15")]),r("br"),r("span",{staticClass:"line-number"},[e._v("16")]),r("br"),r("span",{staticClass:"line-number"},[e._v("17")]),r("br"),r("span",{staticClass:"line-number"},[e._v("18")]),r("br"),r("span",{staticClass:"line-number"},[e._v("19")]),r("br"),r("span",{staticClass:"line-number"},[e._v("20")]),r("br"),r("span",{staticClass:"line-number"},[e._v("21")]),r("br"),r("span",{staticClass:"line-number"},[e._v("22")]),r("br"),r("span",{staticClass:"line-number"},[e._v("23")]),r("br"),r("span",{staticClass:"line-number"},[e._v("24")]),r("br"),r("span",{staticClass:"line-number"},[e._v("25")]),r("br"),r("span",{staticClass:"line-number"},[e._v("26")]),r("br"),r("span",{staticClass:"line-number"},[e._v("27")]),r("br")])]),r("h2",{attrs:{id:"参考文献"}},[r("a",{staticClass:"header-anchor",attrs:{href:"#参考文献"}},[e._v("#")]),e._v(" 参考文献")]),e._v(" "),r("ul",[r("li",[r("a",{attrs:{href:"https://icyshuai.blog.csdn.net/article/details/72638193",target:"_blank",rel:"noopener noreferrer"}},[e._v("OP-TEE OS启动（一）"),r("OutboundLink")],1)])])])}),[],!1,null,null,null);n.default=t.exports}}]);