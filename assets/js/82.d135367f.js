(window.webpackJsonp=window.webpackJsonp||[]).push([[82],{748:function(t,s,a){"use strict";a.r(s);var n=a(2),e=Object(n.a)({},(function(){var t=this,s=t._self._c;return s("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[s("h2",{attrs:{id:"å¯åŠ¨æµç¨‹"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#å¯åŠ¨æµç¨‹"}},[t._v("#")]),t._v(" å¯åŠ¨æµç¨‹")]),t._v(" "),s("p",[t._v("å¦‚æœç³»ç»Ÿæœ‰ ATFï¼ˆARM Trusted Frimwareï¼‰ï¼ˆATF çŸ¥è¯†è¯·å‚è€ƒ ATF ç›¸å…³æ–‡æ¡£ï¼‰ï¼ŒOP-TEE OS åœ¨ bl32 é˜¶æ®µå¯åŠ¨ï¼Œé€šè¿‡ bl31 é˜¶æ®µè°ƒç”¨ "),s("a",{attrs:{href:"https://github.com/sammyne/trusted-firmware-a/blob/v2.3/services/spd/opteed/opteed_helpers.S#L21",target:"_blank",rel:"noopener noreferrer"}},[t._v("opteed_enter_sp"),s("OutboundLink")],1),t._v(" å‡½æ•°è·³è½¬åˆ° OP-TEE OS æ‰§è¡Œå¯åŠ¨æ“ä½œã€‚")]),t._v(" "),s("p",[t._v("ä»¥ QEMU+OP-TEE çš„æ–¹å¼è¿è¡Œ TEE æ—¶ï¼ŒOP-TEE image çš„é“¾æ¥æ–‡ä»¶æ˜¯ optee_os/core/arch/arm/kernel/kern.ld.Sï¼Œç”±æ–‡ä»¶å¯çŸ¥ TEE image å¯åŠ¨çš„å…¥å£å‡½æ•°æ˜¯ "),s("a",{attrs:{href:"https://github.com/OP-TEE/optee_os/blob/3.12.0/core/arch/arm/kernel/kern.ld.S#L74",target:"_blank",rel:"noopener noreferrer"}},[t._v("_start"),s("OutboundLink")],1),t._v(" å‡½æ•°ã€‚")]),t._v(" "),s("p",[s("code",[t._v("_start")]),t._v(" å‡½æ•°å®šä¹‰åœ¨ optee_os/core/arch/arm ç›®å½•çš„ä¸åŒæ–‡ä»¶ï¼Œä¸åŒçš„æ¿å­æ‹¥æœ‰ä¸åŒçš„ .S æ–‡ä»¶ã€‚æœ¬æ–‡æ•™ç¨‹æ˜¯ç”¨ QEMU æ¨¡æ‹Ÿ ARMv8ï¼Œæ•…ä½¿ç”¨ QEMU+OPTEE è¿è¡Œ TEE æ—¶ï¼Œå…¥å£å‡½æ•°å®šä¹‰åœ¨ "),s("a",{attrs:{href:"https://github.com/OP-TEE/optee_os/blob/3.12.0/core/arch/arm/kernel/entry_a64.S#L57",target:"_blank",rel:"noopener noreferrer"}},[t._v("core/arch/arm/kernel/entry_a64.S"),s("OutboundLink")],1),t._v(" æ–‡ä»¶ã€‚æ•´ä¸ªå¯åŠ¨çš„å¤§è‡´æµç¨‹å›¾å¦‚ä¸‹ï¼ˆåªè€ƒè™‘ä¸» CPU çš„å¯åŠ¨ï¼‰ï¼š")]),t._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[t._v("+-------------------------------+               +-------------------------+\n|            _start             |               | thread_clr_boot_thread  |\n+---------------+---------------+               +-------------+-----------+\n                |                                             ^\n                |                                             |\n                v                                             |\n+---------------+---------------+               +-------------+-----------+\n|          set_sctlr_el1        |               |     boot_init_primary   |\n+---------------+---------------+               +-------------+-----------+\n                |                                             ^\n                |                                             |\n                v                                             |\n+---------------+---------------+               +-------------+-----------+\n|           copy_init           |               |        enable_mmu       |\n+---------------+---------------+               +-------------+-----------+\n                |                                             ^\n                |                                             |\n                v                                             |\n+---------------+---------------+               +-------------+-----------+\n|            set_sp             |               |     core_init_mmu_map   |\n+---------------+---------------+               +-------------+-----------+\n                |                                             ^\n                |                                             |\n                v                                             |\n+---------------+---------------+               +-------------+-----------+\n| thread_init_thread_core_local +--------------\x3e+ dcache_cleaninv_range   |\n+-------------------------------+               +-------------------------+\n")])]),t._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[t._v("1")]),s("br"),s("span",{staticClass:"line-number"},[t._v("2")]),s("br"),s("span",{staticClass:"line-number"},[t._v("3")]),s("br"),s("span",{staticClass:"line-number"},[t._v("4")]),s("br"),s("span",{staticClass:"line-number"},[t._v("5")]),s("br"),s("span",{staticClass:"line-number"},[t._v("6")]),s("br"),s("span",{staticClass:"line-number"},[t._v("7")]),s("br"),s("span",{staticClass:"line-number"},[t._v("8")]),s("br"),s("span",{staticClass:"line-number"},[t._v("9")]),s("br"),s("span",{staticClass:"line-number"},[t._v("10")]),s("br"),s("span",{staticClass:"line-number"},[t._v("11")]),s("br"),s("span",{staticClass:"line-number"},[t._v("12")]),s("br"),s("span",{staticClass:"line-number"},[t._v("13")]),s("br"),s("span",{staticClass:"line-number"},[t._v("14")]),s("br"),s("span",{staticClass:"line-number"},[t._v("15")]),s("br"),s("span",{staticClass:"line-number"},[t._v("16")]),s("br"),s("span",{staticClass:"line-number"},[t._v("17")]),s("br"),s("span",{staticClass:"line-number"},[t._v("18")]),s("br"),s("span",{staticClass:"line-number"},[t._v("19")]),s("br"),s("span",{staticClass:"line-number"},[t._v("20")]),s("br"),s("span",{staticClass:"line-number"},[t._v("21")]),s("br"),s("span",{staticClass:"line-number"},[t._v("22")]),s("br"),s("span",{staticClass:"line-number"},[t._v("23")]),s("br"),s("span",{staticClass:"line-number"},[t._v("24")]),s("br"),s("span",{staticClass:"line-number"},[t._v("25")]),s("br"),s("span",{staticClass:"line-number"},[t._v("26")]),s("br"),s("span",{staticClass:"line-number"},[t._v("27")]),s("br")])]),s("p",[t._v("å¦‚æœç³»ç»Ÿæœ‰ ATFï¼Œ"),s("a",{attrs:{href:"https://github.com/OP-TEE/optee_os/blob/3.12.0/core/arch/arm/kernel/boot.c#L1185",target:"_blank",rel:"noopener noreferrer"}},[t._v("boot_init_primary"),s("OutboundLink")],1),t._v(" å‡½æ•°æ‰§è¡Œå®Œæˆä¹‹åè¿”å› OP-TEE çš„å‘é‡è¡¨ï¼Œå¦åˆ™ä¸è¿”å›å‘é‡è¡¨ã€‚OP-TEE å¯åŠ¨è¿‡ç¨‹ä¸­ä¸»ä½“åˆå§‹åŒ–æ“ä½œéƒ½æ˜¯åœ¨ "),s("code",[t._v("boot_init_primary")]),t._v(" å‡½æ•°æ‰§è¡Œçš„ã€‚è¯¥å‡½æ•°çš„ç›¸å…³å‡½æ•°é›†ä¸­åœ¨ "),s("a",{attrs:{href:"https://github.com/OP-TEE/optee_os/blob/3.12.0/core/arch/arm/kernel/boot.c",target:"_blank",rel:"noopener noreferrer"}},[t._v("optee_os/core/arch/arm/kernel/boot.c"),s("OutboundLink")],1),t._v(" æ–‡ä»¶ï¼Œå…·ä½“å¦‚ä¸‹")]),t._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[t._v("|-boot_init_primary\n  |-init_primary\n    |-thread_set_exceptions // è®¾ç½®å¼‚å¸¸å¤„ç†å‡½æ•°\n    |-init_vfp_sec // åˆå§‹åŒ– VFP--æµ®ç‚¹æ•°è¿ç®—å•å…ƒ \n    |-init_runtime  // åˆå§‹åŒ–å’Œé…ç½® TEE è¿è¡Œæ—¶ç”¨åˆ°çš„å„ç§å†…å­˜ï¼Œä¾‹å¦‚ï¼šæ¸…ç©º BSSï¼Œåˆå§‹åŒ–çº¿ç¨‹å†…å­˜ï¼Œåˆ†é… TA è¿è¡Œæ—¶æ‰€éœ€å†…å­˜ç­‰\n    |-thread_init_primary // åˆå§‹åŒ– TEE æ”¯æŒçš„çº¿ç¨‹æ ˆç©ºé—´ã€å¼‚å¸¸å¤„ç†ã€é¡µè¡¨ç­‰\n    |-thread_init_per_cpu // å¦‚æœæ²¡æœ‰ ATFï¼Œåˆå§‹åŒ–æ¯ä¸ª CPU çš„ monitor æ€çš„å¤„ç†æ–¹å¼\n    |-init_sec_mon        // å¦‚æœä¸æ”¯æŒ ATFï¼Œé…ç½®å†…æ ¸æ€ CPU çš„ Monitor å¤„ç†æ–¹å¼\n  |-paged_init_primary\n    |-init_external_dt    // åˆå§‹åŒ–è®¾å¤‡æ ‘\n    |-main_init_gic       // åˆå§‹åŒ–ä¸­æ–­æ§åˆ¶å™¨\n    |-init_vfp_nsec       // åˆå§‹åŒ–å¸¸è§„ä¸–ç•Œçš„ VFP--æµ®ç‚¹æ•°è¿ç®—å•å…ƒ\n    |-init_tee_runtime    // åˆå§‹åŒ–å…±äº«å†…å­˜ç­‰\n      |-call_initcalls    // å®šä¹‰åœ¨ initcall.c \n    |-call_finalcalls\n")])]),t._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[t._v("1")]),s("br"),s("span",{staticClass:"line-number"},[t._v("2")]),s("br"),s("span",{staticClass:"line-number"},[t._v("3")]),s("br"),s("span",{staticClass:"line-number"},[t._v("4")]),s("br"),s("span",{staticClass:"line-number"},[t._v("5")]),s("br"),s("span",{staticClass:"line-number"},[t._v("6")]),s("br"),s("span",{staticClass:"line-number"},[t._v("7")]),s("br"),s("span",{staticClass:"line-number"},[t._v("8")]),s("br"),s("span",{staticClass:"line-number"},[t._v("9")]),s("br"),s("span",{staticClass:"line-number"},[t._v("10")]),s("br"),s("span",{staticClass:"line-number"},[t._v("11")]),s("br"),s("span",{staticClass:"line-number"},[t._v("12")]),s("br"),s("span",{staticClass:"line-number"},[t._v("13")]),s("br"),s("span",{staticClass:"line-number"},[t._v("14")]),s("br"),s("span",{staticClass:"line-number"},[t._v("15")]),s("br")])]),s("h3",{attrs:{id:"call-initcalls"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#call-initcalls"}},[t._v("#")]),t._v(" call_initcalls")]),t._v(" "),s("p",[t._v("åˆå§‹åŒ–å†…å­˜ã€CPU ç›¸å…³è®¾ç½®ã€ä¸­æ–­æ§åˆ¶å™¨ã€å…±äº«å†…å­˜ã€çº¿ç¨‹å †æ ˆã€TA æ‰§è¡Œå†…å­˜åˆ†é…ç­‰æ“ä½œä¹‹åï¼Œ"),s("code",[t._v("init_tee_runtime")]),t._v(" å‡½æ•°è°ƒç”¨ "),s("code",[t._v("call_initcalls")]),t._v(" å‡½æ•°å¯åŠ¨ OP-TEE OS çš„å„ç§ serviceã€‚"),s("code",[t._v("call_initcalls")]),t._v(" ä»£ç å¦‚ä¸‹ï¼š")]),t._v(" "),s("div",{staticClass:"language-c line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-c"}},[s("code",[s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// optee_os/core/kernel/initcall.c")]),t._v("\n\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("void")]),t._v(" __weak "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("call_initcalls")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("void")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\t"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("struct")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("initcall")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v("call "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token constant"}},[t._v("NULL")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\tTEE_Result ret "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" TEE_SUCCESS"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n\t"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("for")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("call "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" initcall_begin"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" call "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v(" initcall_end"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" call"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("++")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\t\t"),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("DMSG")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"level %d %s()"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" call"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("->")]),t._v("level"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" call"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("->")]),t._v("func_name"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\t\tret "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" call"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("->")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("func")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\t\t"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("ret "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!=")]),t._v(" TEE_SUCCESS"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\t\t\t"),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("EMSG")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"Initcall __text_start + 0x%08"')]),t._v(" PRIxVA\n\t\t\t     "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('" failed"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("vaddr_t")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("call "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v(" VCORE_START_VA"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\t\t"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\t"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])]),t._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[t._v("1")]),s("br"),s("span",{staticClass:"line-number"},[t._v("2")]),s("br"),s("span",{staticClass:"line-number"},[t._v("3")]),s("br"),s("span",{staticClass:"line-number"},[t._v("4")]),s("br"),s("span",{staticClass:"line-number"},[t._v("5")]),s("br"),s("span",{staticClass:"line-number"},[t._v("6")]),s("br"),s("span",{staticClass:"line-number"},[t._v("7")]),s("br"),s("span",{staticClass:"line-number"},[t._v("8")]),s("br"),s("span",{staticClass:"line-number"},[t._v("9")]),s("br"),s("span",{staticClass:"line-number"},[t._v("10")]),s("br"),s("span",{staticClass:"line-number"},[t._v("11")]),s("br"),s("span",{staticClass:"line-number"},[t._v("12")]),s("br"),s("span",{staticClass:"line-number"},[t._v("13")]),s("br"),s("span",{staticClass:"line-number"},[t._v("14")]),s("br"),s("span",{staticClass:"line-number"},[t._v("15")]),s("br"),s("span",{staticClass:"line-number"},[t._v("16")]),s("br")])]),s("p",[t._v("è¯¥å‡½æ•°ä¼šä¾æ¬¡æ‰§è¡Œ "),s("code",[t._v("initcall_begin")]),t._v(" åˆ° "),s("code",[t._v("initcall_end")]),t._v(" ä¹‹é—´çš„æ‰€æœ‰å‡½æ•°ã€‚ï¼ˆTODOï¼š"),s("code",[t._v("initcall_begin")]),t._v(" å’Œ "),s("code",[t._v("initcall_end")]),t._v(" çš„å…·ä½“å®šä¹‰å°šæœªçœ‹æ‡‚ ğŸ˜¦ï¼‰")]),t._v(" "),s("p",[s("code",[t._v("initcall_begin")]),t._v(" å’Œ "),s("code",[t._v("initcall_end")]),t._v(" ä¹‹é—´çš„å‡½æ•°ä»£ç é€šè¿‡ "),s("a",{attrs:{href:"https://github.com/OP-TEE/optee_os/blob/3.12.0/core/include/initcall.h#L22",target:"_blank",rel:"noopener noreferrer"}},[t._v("__define_initcall"),s("OutboundLink")],1),t._v(" å®æ”¾åˆ°å¯¹åº”æ®µï¼Œå…·ä½“å†…å®¹å¦‚ä¸‹")]),t._v(" "),s("div",{staticClass:"language-c line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-c"}},[s("code",[s("span",{pre:!0,attrs:{class:"token macro property"}},[s("span",{pre:!0,attrs:{class:"token directive-hash"}},[t._v("#")]),s("span",{pre:!0,attrs:{class:"token directive keyword"}},[t._v("define")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token macro-name function"}},[t._v("early_init")]),s("span",{pre:!0,attrs:{class:"token expression"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("fn"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\t\t\t"),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("__define_initcall")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("init"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" fn"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")])])]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token macro property"}},[s("span",{pre:!0,attrs:{class:"token directive-hash"}},[t._v("#")]),s("span",{pre:!0,attrs:{class:"token directive keyword"}},[t._v("define")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token macro-name function"}},[t._v("early_init_late")]),s("span",{pre:!0,attrs:{class:"token expression"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("fn"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\t\t"),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("__define_initcall")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("init"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("2")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" fn"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")])])]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token macro property"}},[s("span",{pre:!0,attrs:{class:"token directive-hash"}},[t._v("#")]),s("span",{pre:!0,attrs:{class:"token directive keyword"}},[t._v("define")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token macro-name function"}},[t._v("service_init")]),s("span",{pre:!0,attrs:{class:"token expression"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("fn"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\t\t"),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("__define_initcall")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("init"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("3")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" fn"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")])])]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token macro property"}},[s("span",{pre:!0,attrs:{class:"token directive-hash"}},[t._v("#")]),s("span",{pre:!0,attrs:{class:"token directive keyword"}},[t._v("define")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token macro-name function"}},[t._v("service_init_late")]),s("span",{pre:!0,attrs:{class:"token expression"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("fn"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\t\t"),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("__define_initcall")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("init"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("4")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" fn"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")])])]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token macro property"}},[s("span",{pre:!0,attrs:{class:"token directive-hash"}},[t._v("#")]),s("span",{pre:!0,attrs:{class:"token directive keyword"}},[t._v("define")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token macro-name function"}},[t._v("driver_init")]),s("span",{pre:!0,attrs:{class:"token expression"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("fn"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\t\t\t"),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("__define_initcall")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("init"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("5")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" fn"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")])])]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token macro property"}},[s("span",{pre:!0,attrs:{class:"token directive-hash"}},[t._v("#")]),s("span",{pre:!0,attrs:{class:"token directive keyword"}},[t._v("define")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token macro-name function"}},[t._v("driver_init_late")]),s("span",{pre:!0,attrs:{class:"token expression"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("fn"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\t\t"),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("__define_initcall")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("init"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("6")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" fn"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")])])]),t._v("\n")])]),t._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[t._v("1")]),s("br"),s("span",{staticClass:"line-number"},[t._v("2")]),s("br"),s("span",{staticClass:"line-number"},[t._v("3")]),s("br"),s("span",{staticClass:"line-number"},[t._v("4")]),s("br"),s("span",{staticClass:"line-number"},[t._v("5")]),s("br"),s("span",{staticClass:"line-number"},[t._v("6")]),s("br")])]),s("blockquote",[s("p",[s("code",[t._v("__define_initcall")]),t._v(" æŒ‡ç¤ºç¼–è¯‘å™¨å°† "),s("code",[t._v("service_init(fn)")]),t._v(" çš„ "),s("code",[t._v("fn")]),t._v(" å‡½æ•°ä»£ç å­˜æ”¾åˆ° "),s("code",[t._v(".scattered_array_initcall_1_3")]),t._v(" æ®µï¼ˆç›®å‰è¿™ä¸ªå±äºä¸ªäººç†è§£ï¼‰")])]),t._v(" "),s("h2",{attrs:{id:"service-init"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#service-init"}},[t._v("#")]),t._v(" service_init")]),t._v(" "),s("p",[t._v("ç”±ç¼–è¯‘äº§å‡ºçš„ optee_os/out/arm/core/tee.map æ–‡ä»¶å¯çŸ¥ "),s("code",[t._v(".scattered_array_initcall_1_3")]),t._v(" æ®µå­˜çš„å†…å®¹å¦‚ä¸‹")]),t._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[t._v("// ...\n.scattered_array_initcall_1_1\n              0x000000000e15cc18       0x18 out/arm/core/arch/arm/mm/core_mmu.o\n.scattered_array_initcall_1_3\n              0x000000000e15cc30       0x30 out/arm/core/arch/arm/kernel/user_ta.o\n.scattered_array_initcall_1_3\n              0x000000000e15cc60       0x18 out/arm/core/arch/arm/kernel/pseudo_ta.o\n.scattered_array_initcall_1_3\n              0x000000000e15cc78       0x18 out/arm/core/arch/arm/mm/mobj_dyn_shm.o\n.scattered_array_initcall_1_3\n              0x000000000e15cc90       0x18 out/arm/core/tee/tee_cryp_utl.o\n.scattered_array_initcall_1_4\n// ...\n")])]),t._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[t._v("1")]),s("br"),s("span",{staticClass:"line-number"},[t._v("2")]),s("br"),s("span",{staticClass:"line-number"},[t._v("3")]),s("br"),s("span",{staticClass:"line-number"},[t._v("4")]),s("br"),s("span",{staticClass:"line-number"},[t._v("5")]),s("br"),s("span",{staticClass:"line-number"},[t._v("6")]),s("br"),s("span",{staticClass:"line-number"},[t._v("7")]),s("br"),s("span",{staticClass:"line-number"},[t._v("8")]),s("br"),s("span",{staticClass:"line-number"},[t._v("9")]),s("br"),s("span",{staticClass:"line-number"},[t._v("10")]),s("br"),s("span",{staticClass:"line-number"},[t._v("11")]),s("br"),s("span",{staticClass:"line-number"},[t._v("12")]),s("br"),s("span",{staticClass:"line-number"},[t._v("13")]),s("br")])]),s("p",[t._v("éå†æ•´ä¸ª OP-TEE ç›®å½•å¯çŸ¥ï¼Œä½¿ç”¨ "),s("code",[t._v("service_init")]),t._v(" å®å°†ä»£ç å­˜æ”¾åˆ° "),s("code",[t._v(".scattered_array_initcall_1_3")]),t._v(" æ®µçš„å‡½æ•°å¦‚ä¸‹ï¼š")]),t._v(" "),s("table",[s("thead",[s("tr",[s("th",{staticStyle:{"text-align":"right"}},[t._v("å‡½æ•°")]),t._v(" "),s("th",{staticStyle:{"text-align":"left"}},[t._v("ç›¸å…³æ–‡ä»¶")])])]),t._v(" "),s("tbody",[s("tr",[s("td",{staticStyle:{"text-align":"right"}},[s("a",{attrs:{href:"https://github.com/OP-TEE/optee_os/blob/3.12.0/core/arch/arm/kernel/user_ta.c#L422",target:"_blank",rel:"noopener noreferrer"}},[t._v("check_ta_store"),s("OutboundLink")],1),t._v(", "),s("a",{attrs:{href:"https://github.com/OP-TEE/optee_os/blob/3.12.0/core/arch/arm/kernel/user_ta.c#L401",target:"_blank",rel:"noopener noreferrer"}},[t._v("init_user_ta"),s("OutboundLink")],1)]),t._v(" "),s("td",{staticStyle:{"text-align":"left"}},[t._v("user_ta.c")])]),t._v(" "),s("tr",[s("td",{staticStyle:{"text-align":"right"}},[s("a",{attrs:{href:"https://github.com/OP-TEE/optee_os/blob/3.12.0/core/arch/arm/kernel/pseudo_ta.c#L286",target:"_blank",rel:"noopener noreferrer"}},[t._v("verify_pseudo_tas_conformance"),s("OutboundLink")],1)]),t._v(" "),s("td",{staticStyle:{"text-align":"left"}},[t._v("pseudo_ta.c")])]),t._v(" "),s("tr",[s("td",{staticStyle:{"text-align":"right"}},[s("a",{attrs:{href:"https://github.com/OP-TEE/optee_os/blob/3.12.0/core/arch/arm/mm/mobj_dyn_shm.c#L438",target:"_blank",rel:"noopener noreferrer"}},[t._v("mobj_mapped_shm_init"),s("OutboundLink")],1)]),t._v(" "),s("td",{staticStyle:{"text-align":"left"}},[t._v("mobj_dyn_shm.c")])]),t._v(" "),s("tr",[s("td",{staticStyle:{"text-align":"right"}},[s("a",{attrs:{href:"https://github.com/OP-TEE/optee_os/blob/3.12.0/core/tee/tee_cryp_utl.c#L211",target:"_blank",rel:"noopener noreferrer"}},[t._v("tee_cryp_init"),s("OutboundLink")],1)]),t._v(" "),s("td",{staticStyle:{"text-align":"left"}},[t._v("tee_cryp_utl.c")])])])]),t._v(" "),s("p",[t._v("ä¹Ÿå³æ‰§è¡Œ "),s("code",[t._v(".scattered_array_initcall_1_3")]),t._v(" æ®µå†…å®¹æ—¶ï¼Œå°†ä¼šä¾æ¬¡æ‰§è¡Œè¿™äº›å‡½æ•°ã€‚")]),t._v(" "),s("h3",{attrs:{id:"_1-check-ta-store-init-user-ta"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_1-check-ta-store-init-user-ta"}},[t._v("#")]),t._v(" 1. check_ta_store, init_user_ta")]),t._v(" "),s("p",[t._v("è¿™ä¸¤ä¸ªå‡½æ•°è´Ÿè´£æŠŠåŠ è½½ TA image çš„æ“ä½œç»“æ„ä½“èµ‹å€¼ç»™ "),s("code",[t._v("_user_ta_ops")]),t._v(" å˜é‡ï¼Œè¯¥å˜é‡ä¼šåœ¨åŠ è½½ TA image çš„æ—¶å€™è¢«ä½¿ç”¨åˆ°ï¼Œè¯¥å‡½æ•°çš„ä»£ç å¦‚ä¸‹ï¼š")]),t._v(" "),s("div",{staticClass:"language-c line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-c"}},[s("code",[s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// å®šä¹‰åŠ è½½ TA image ä¾èµ–çš„æ“ä½œå‡½æ•°æŒ‡é’ˆ")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("static")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("struct")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("ts_ops")]),t._v(" user_ta_ops __rodata_unpaged "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\t"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("enter_open_session "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" user_ta_enter_open_session"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n\t"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("enter_invoke_cmd "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" user_ta_enter_invoke_cmd"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n\t"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("enter_close_session "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" user_ta_enter_close_session"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n\t"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("dump_state "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" user_ta_dump_state"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token macro property"}},[s("span",{pre:!0,attrs:{class:"token directive-hash"}},[t._v("#")]),s("span",{pre:!0,attrs:{class:"token directive keyword"}},[t._v("ifdef")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token expression"}},[t._v("CFG_FTRACE_SUPPORT")])]),t._v("\n\t"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("dump_ftrace "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" user_ta_dump_ftrace"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token macro property"}},[s("span",{pre:!0,attrs:{class:"token directive-hash"}},[t._v("#")]),s("span",{pre:!0,attrs:{class:"token directive keyword"}},[t._v("endif")])]),t._v("\n\t"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("destroy "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" user_ta_ctx_destroy"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n\t"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("get_instance_id "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" user_ta_get_instance_id"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n\t"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("handle_svc "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" user_ta_handle_svc"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token macro property"}},[s("span",{pre:!0,attrs:{class:"token directive-hash"}},[t._v("#")]),s("span",{pre:!0,attrs:{class:"token directive keyword"}},[t._v("ifdef")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token expression"}},[t._v("CFG_TA_GPROF_SUPPORT")])]),t._v("\n\t"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("gprof_set_status "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" user_ta_gprof_set_status"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token macro property"}},[s("span",{pre:!0,attrs:{class:"token directive-hash"}},[t._v("#")]),s("span",{pre:!0,attrs:{class:"token directive keyword"}},[t._v("endif")])]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("/*\n * Break unpaged attribute dependency propagation to user_ta_ops structure\n * content thanks to a runtime initialization of the ops reference.\n */")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("static")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("struct")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("ts_ops")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v("_user_ta_ops"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("static")]),t._v(" TEE_Result "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("init_user_ta")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("void")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\t_user_ta_ops "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("&")]),t._v("user_ta_ops"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n\t"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" TEE_SUCCESS"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("service_init")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("init_user_ta"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// ...")]),t._v("\n\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("static")]),t._v(" TEE_Result "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("check_ta_store")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("void")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\t"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("struct")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("ts_store_ops")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v("op "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token constant"}},[t._v("NULL")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n\t"),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("SCATTERED_ARRAY_FOREACH")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("op"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" ta_stores"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("struct")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("ts_store_ops")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\t\t"),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("DMSG")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"TA store: \\"%s\\""')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" op"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("->")]),t._v("description"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n\t"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" TEE_SUCCESS"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("service_init")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("check_ta_store"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// ...")]),t._v("\n")])]),t._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[t._v("1")]),s("br"),s("span",{staticClass:"line-number"},[t._v("2")]),s("br"),s("span",{staticClass:"line-number"},[t._v("3")]),s("br"),s("span",{staticClass:"line-number"},[t._v("4")]),s("br"),s("span",{staticClass:"line-number"},[t._v("5")]),s("br"),s("span",{staticClass:"line-number"},[t._v("6")]),s("br"),s("span",{staticClass:"line-number"},[t._v("7")]),s("br"),s("span",{staticClass:"line-number"},[t._v("8")]),s("br"),s("span",{staticClass:"line-number"},[t._v("9")]),s("br"),s("span",{staticClass:"line-number"},[t._v("10")]),s("br"),s("span",{staticClass:"line-number"},[t._v("11")]),s("br"),s("span",{staticClass:"line-number"},[t._v("12")]),s("br"),s("span",{staticClass:"line-number"},[t._v("13")]),s("br"),s("span",{staticClass:"line-number"},[t._v("14")]),s("br"),s("span",{staticClass:"line-number"},[t._v("15")]),s("br"),s("span",{staticClass:"line-number"},[t._v("16")]),s("br"),s("span",{staticClass:"line-number"},[t._v("17")]),s("br"),s("span",{staticClass:"line-number"},[t._v("18")]),s("br"),s("span",{staticClass:"line-number"},[t._v("19")]),s("br"),s("span",{staticClass:"line-number"},[t._v("20")]),s("br"),s("span",{staticClass:"line-number"},[t._v("21")]),s("br"),s("span",{staticClass:"line-number"},[t._v("22")]),s("br"),s("span",{staticClass:"line-number"},[t._v("23")]),s("br"),s("span",{staticClass:"line-number"},[t._v("24")]),s("br"),s("span",{staticClass:"line-number"},[t._v("25")]),s("br"),s("span",{staticClass:"line-number"},[t._v("26")]),s("br"),s("span",{staticClass:"line-number"},[t._v("27")]),s("br"),s("span",{staticClass:"line-number"},[t._v("28")]),s("br"),s("span",{staticClass:"line-number"},[t._v("29")]),s("br"),s("span",{staticClass:"line-number"},[t._v("30")]),s("br"),s("span",{staticClass:"line-number"},[t._v("31")]),s("br"),s("span",{staticClass:"line-number"},[t._v("32")]),s("br"),s("span",{staticClass:"line-number"},[t._v("33")]),s("br"),s("span",{staticClass:"line-number"},[t._v("34")]),s("br"),s("span",{staticClass:"line-number"},[t._v("35")]),s("br"),s("span",{staticClass:"line-number"},[t._v("36")]),s("br"),s("span",{staticClass:"line-number"},[t._v("37")]),s("br"),s("span",{staticClass:"line-number"},[t._v("38")]),s("br"),s("span",{staticClass:"line-number"},[t._v("39")]),s("br"),s("span",{staticClass:"line-number"},[t._v("40")]),s("br"),s("span",{staticClass:"line-number"},[t._v("41")]),s("br"),s("span",{staticClass:"line-number"},[t._v("42")]),s("br"),s("span",{staticClass:"line-number"},[t._v("43")]),s("br"),s("span",{staticClass:"line-number"},[t._v("44")]),s("br"),s("span",{staticClass:"line-number"},[t._v("45")]),s("br")])]),s("h3",{attrs:{id:"_2-verify-pseudo-tas-conformance"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_2-verify-pseudo-tas-conformance"}},[t._v("#")]),t._v(" 2. verify_pseudo_tas_conformance")]),t._v(" "),s("p",[t._v("è¯¥å‡½æ•°æ ¡éªŒ OP-TEE OS é›†æˆçš„ TA åˆæ³•æ€§ï¼Œéœ€è¦æ£€æŸ¥ OP-TEE OS è‡ªæœ‰ TA çš„ UUIDã€å‡½æ•°æŒ‡é’ˆå’Œç›¸å…³æ ‡è¯†ç¬¦ã€‚ä»£ç å¦‚ä¸‹ï¼š")]),t._v(" "),s("div",{staticClass:"language-c line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-c"}},[s("code",[t._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("/* Insures declared pseudo TAs conforms with core expectations */")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("static")]),t._v(" TEE_Result "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("verify_pseudo_tas_conformance")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("void")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\t"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("struct")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("pseudo_ta_head")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v("start "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("\n\t\t"),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("SCATTERED_ARRAY_BEGIN")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("pseudo_tas"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("struct")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("pseudo_ta_head")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// è·å–å­˜æ”¾ pseudo TAs çš„ head info æ®µèµ·å§‹åœ°å€")]),t._v("\n\t"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("struct")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("pseudo_ta_head")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v("end "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("\n\t\t"),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("SCATTERED_ARRAY_END")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("pseudo_tas"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("struct")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("pseudo_ta_head")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// è·å–å­˜æ”¾ pseudo TAs çš„ head info æ®µæœ«å°¾åœ°å€")]),t._v("\n\t"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("struct")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("pseudo_ta_head")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v("pta"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n\t"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("for")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("pta "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" start"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" pta "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v(" end"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" pta"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("++")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\t\t"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("struct")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("pseudo_ta_head")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v("pta2"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n\t\t"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("/* PTAs must all have a specific UUID */")]),t._v("\n\t\t"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("for")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("pta2 "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" pta "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("+")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" pta2 "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v(" end"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" pta2"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("++")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// æ£€æŸ¥ psedo TAs çš„ head info åŒ…å«çš„ UUID ä¿¡æ¯æ˜¯å¦æœ‰ç›¸åŒçš„")]),t._v("\n\t\t\t"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("memcmp")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("&")]),t._v("pta"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("->")]),t._v("uuid"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("&")]),t._v("pta2"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("->")]),t._v("uuid"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("sizeof")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("TEE_UUID"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\t\t\t\t"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("goto")]),t._v(" err"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\t\t"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n    "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// æ£€æŸ¥ invoke å‡½æ•°æŒ‡é’ˆæ˜¯å¦ä¸ºç©ºå’Œç›¸å…³ flag æ˜¯å¦åˆæ³•")]),t._v("\n\t\t"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!")]),t._v("pta"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("->")]),t._v("name "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("||")]),t._v("\n\t\t    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("pta"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("->")]),t._v("flags "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("&")]),t._v(" PTA_MANDATORY_FLAGS"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!=")]),t._v(" PTA_MANDATORY_FLAGS "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("||")]),t._v("\n\t\t    pta"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("->")]),t._v("flags "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("&")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("~")]),t._v("PTA_ALLOWED_FLAGS "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("||")]),t._v("\n\t\t    "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!")]),t._v("pta"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("->")]),t._v("invoke_command_entry_point"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\t\t\t"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("goto")]),t._v(" err"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\t"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\t"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" TEE_SUCCESS"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\nerr"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v("\n\t"),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("DMSG")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"pseudo TA error at %p"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("void")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("pta"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\t"),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("panic")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"PTA"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n"),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("service_init")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("verify_pseudo_tas_conformance"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])]),t._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[t._v("1")]),s("br"),s("span",{staticClass:"line-number"},[t._v("2")]),s("br"),s("span",{staticClass:"line-number"},[t._v("3")]),s("br"),s("span",{staticClass:"line-number"},[t._v("4")]),s("br"),s("span",{staticClass:"line-number"},[t._v("5")]),s("br"),s("span",{staticClass:"line-number"},[t._v("6")]),s("br"),s("span",{staticClass:"line-number"},[t._v("7")]),s("br"),s("span",{staticClass:"line-number"},[t._v("8")]),s("br"),s("span",{staticClass:"line-number"},[t._v("9")]),s("br"),s("span",{staticClass:"line-number"},[t._v("10")]),s("br"),s("span",{staticClass:"line-number"},[t._v("11")]),s("br"),s("span",{staticClass:"line-number"},[t._v("12")]),s("br"),s("span",{staticClass:"line-number"},[t._v("13")]),s("br"),s("span",{staticClass:"line-number"},[t._v("14")]),s("br"),s("span",{staticClass:"line-number"},[t._v("15")]),s("br"),s("span",{staticClass:"line-number"},[t._v("16")]),s("br"),s("span",{staticClass:"line-number"},[t._v("17")]),s("br"),s("span",{staticClass:"line-number"},[t._v("18")]),s("br"),s("span",{staticClass:"line-number"},[t._v("19")]),s("br"),s("span",{staticClass:"line-number"},[t._v("20")]),s("br"),s("span",{staticClass:"line-number"},[t._v("21")]),s("br"),s("span",{staticClass:"line-number"},[t._v("22")]),s("br"),s("span",{staticClass:"line-number"},[t._v("23")]),s("br"),s("span",{staticClass:"line-number"},[t._v("24")]),s("br"),s("span",{staticClass:"line-number"},[t._v("25")]),s("br"),s("span",{staticClass:"line-number"},[t._v("26")]),s("br"),s("span",{staticClass:"line-number"},[t._v("27")]),s("br"),s("span",{staticClass:"line-number"},[t._v("28")]),s("br"),s("span",{staticClass:"line-number"},[t._v("29")]),s("br"),s("span",{staticClass:"line-number"},[t._v("30")]),s("br"),s("span",{staticClass:"line-number"},[t._v("31")]),s("br"),s("span",{staticClass:"line-number"},[t._v("32")]),s("br"),s("span",{staticClass:"line-number"},[t._v("33")]),s("br"),s("span",{staticClass:"line-number"},[t._v("34")]),s("br")])]),s("p",[t._v("åœ¨ç¼–è¯‘è¿‡ç¨‹ä¸­ï¼Œå“ªäº›éƒ¨åˆ†ä¼šè¢«æ·»åŠ åˆ°å­˜æ”¾ pseudo TAs çš„ head info çš„ "),s("code",[t._v(".scattered_array_pseudo_tas_0")]),t._v("ï¼ˆç”± "),s("code",[t._v("SCATTERED_ARRAY_BEGIN")]),t._v(" å®šä¹‰ï¼‰æ®µå‘¢ï¼Ÿè¯¥æ“ä½œé€šè¿‡ä½¿ç”¨ "),s("a",{attrs:{href:"https://github.com/OP-TEE/optee_os/blob/3.12.0/core/arch/arm/include/kernel/pseudo_ta.h#L43",target:"_blank",rel:"noopener noreferrer"}},[t._v("pseudo_ta_register"),s("OutboundLink")],1),t._v(" å®å®ç°ï¼Œå®šä¹‰åœ¨ core/arch/arm/include/kernel/pseudo_ta.h æ–‡ä»¶å¦‚ä¸‹ï¼š")]),t._v(" "),s("div",{staticClass:"language-c line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-c"}},[s("code",[s("span",{pre:!0,attrs:{class:"token macro property"}},[s("span",{pre:!0,attrs:{class:"token directive-hash"}},[t._v("#")]),s("span",{pre:!0,attrs:{class:"token directive keyword"}},[t._v("define")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token macro-name function"}},[t._v("pseudo_ta_register")]),s("span",{pre:!0,attrs:{class:"token expression"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\t")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("\n\t"),s("span",{pre:!0,attrs:{class:"token expression"}},[s("span",{pre:!0,attrs:{class:"token function"}},[t._v("SCATTERED_ARRAY_DEFINE_PG_ITEM")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("pseudo_tas"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("struct")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("pseudo_ta_head")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" ")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("\n\t\t"),s("span",{pre:!0,attrs:{class:"token expression"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v(" __VA_ARGS__ "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")])])]),t._v("\n")])]),t._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[t._v("1")]),s("br"),s("span",{staticClass:"line-number"},[t._v("2")]),s("br"),s("span",{staticClass:"line-number"},[t._v("3")]),s("br")])]),s("p",[t._v("è¯¥å®è§„å®š "),s("code",[t._v("pseudo_ta_register")]),t._v(" å‚æ•°çš„ "),s("code",[t._v("pseudo_ta_head")]),t._v(" ç»“æ„ä½“å˜é‡å°†ä¼šè¢«å­˜æ”¾ "),s("code",[t._v(".scattered_array_pseudo_tas_1_0")]),t._v(" æ®µï¼ˆæ ¸å®ï¼‰ã€‚åœ¨ OP-TEE æœ‰ 5 ä¸ª TA ä¼šè¢«æ‰“åŒ…è¿› OP-TEE imageï¼Œç›¸å…³æ–‡ä»¶å¦‚ä¸‹ï¼š")]),t._v(" "),s("blockquote",[s("p",[t._v("é™¤äº† socket TA å¤–ï¼Œæ‰€æœ‰æ–‡ä»¶å‡åœ¨ optee_os/core/arch/arm/pta ç›®å½•ä¸‹ã€‚")])]),t._v(" "),s("table",[s("thead",[s("tr",[s("th",{staticStyle:{"text-align":"right"}},[t._v("TA")]),t._v(" "),s("th",{staticStyle:{"text-align":"left"}},[t._v("æ–‡ä»¶")])])]),t._v(" "),s("tbody",[s("tr",[s("td",{staticStyle:{"text-align":"right"}},[s("a",{attrs:{href:"https://github.com/OP-TEE/optee_os/blob/3.12.0/core/pta/device.c#L95",target:"_blank",rel:"noopener noreferrer"}},[t._v("device.pta"),s("OutboundLink")],1)]),t._v(" "),s("td",{staticStyle:{"text-align":"left"}},[t._v("device.c")])]),t._v(" "),s("tr",[s("td",{staticStyle:{"text-align":"right"}},[s("a",{attrs:{href:"https://github.com/OP-TEE/optee_os/blob/3.12.0/core/pta/secstor_ta_mgmt.c#L179",target:"_blank",rel:"noopener noreferrer"}},[t._v("secstor_ta_mgmt"),s("OutboundLink")],1)]),t._v(" "),s("td",{staticStyle:{"text-align":"left"}},[t._v("secstor_ta_mgmt.c")])]),t._v(" "),s("tr",[s("td",{staticStyle:{"text-align":"right"}},[s("a",{attrs:{href:"https://github.com/OP-TEE/optee_os/blob/3.12.0/core/pta/gprof.c#L182",target:"_blank",rel:"noopener noreferrer"}},[t._v("gprof"),s("OutboundLink")],1)]),t._v(" "),s("td",{staticStyle:{"text-align":"left"}},[t._v("gprof.c")])]),t._v(" "),s("tr",[s("td",{staticStyle:{"text-align":"right"}},[s("a",{attrs:{href:"https://github.com/OP-TEE/optee_os/blob/3.12.0/core/pta/stats.c#L161",target:"_blank",rel:"noopener noreferrer"}},[t._v("stats.ta"),s("OutboundLink")],1)]),t._v(" "),s("td",{staticStyle:{"text-align":"left"}},[t._v("stats.c")])]),t._v(" "),s("tr",[s("td",{staticStyle:{"text-align":"right"}},[s("a",{attrs:{href:"https://github.com/OP-TEE/optee_os/blob/3.12.0/core/pta/system.c#L331",target:"_blank",rel:"noopener noreferrer"}},[t._v("system.pta"),s("OutboundLink")],1)]),t._v(" "),s("td",{staticStyle:{"text-align":"left"}},[t._v("system.c")])]),t._v(" "),s("tr",[s("td",{staticStyle:{"text-align":"right"}},[s("a",{attrs:{href:"https://github.com/OP-TEE/optee_os/blob/3.12.0/core/tee/socket.c#L262",target:"_blank",rel:"noopener noreferrer"}},[t._v("socket"),s("OutboundLink")],1)]),t._v(" "),s("td",{staticStyle:{"text-align":"left"}},[t._v("optee_os/core/tee/socket.c")])])])]),t._v(" "),s("blockquote",[s("p",[t._v("TODOï¼šæœªå®Œå…¨ç†è§£")])]),t._v(" "),s("h3",{attrs:{id:"_3-mobj-mapped-shm-init"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_3-mobj-mapped-shm-init"}},[t._v("#")]),t._v(" 3. mobj_mapped_shm_init")]),t._v(" "),s("p",[t._v("TODO")]),t._v(" "),s("h3",{attrs:{id:"_4-tee-cryp-init"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_4-tee-cryp-init"}},[t._v("#")]),t._v(" 4. tee_cryp_init")]),t._v(" "),s("p",[t._v("è¯¥å‡½æ•°åˆå§‹åŒ–åŠ è§£å¯†åŠŸèƒ½ï¼Œä¼šè°ƒç”¨ "),s("code",[t._v("crypto_init()")]),t._v(" å’Œ "),s("code",[t._v("plat_rng_init()")]),t._v(" è¿›è¡Œåˆå§‹åŒ–æ“ä½œï¼Œå‡½æ•°è°ƒç”¨æ ˆå¦‚ä¸‹")]),t._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[t._v("|-tee_cryp_init\n  |-crypto_init  // optee_os/lib/libmbedtls/core/tomcrypt.c#L10\n    |-tomcrypt_init // optee_os/core/lib/libtomcrypt/tomcrypt.c#141\n      |-ltc_init    // optee_os/core/lib/libtomcrypt/tomcrypt.c#125\n                    // å®Œæˆå„ç§ç®—æ³•è°ƒç”¨æ¥å£çš„å®šä¹‰å’Œåˆå§‹åŒ–\n  |-plat_rng_init // åˆå§‹åŒ–ä¼ªéšæœºæ•°å‘ç”Ÿå™¨çš„ç§å­\n")])]),t._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[t._v("1")]),s("br"),s("span",{staticClass:"line-number"},[t._v("2")]),s("br"),s("span",{staticClass:"line-number"},[t._v("3")]),s("br"),s("span",{staticClass:"line-number"},[t._v("4")]),s("br"),s("span",{staticClass:"line-number"},[t._v("5")]),s("br"),s("span",{staticClass:"line-number"},[t._v("6")]),s("br")])]),s("h2",{attrs:{id:"service-init-late"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#service-init-late"}},[t._v("#")]),t._v(" service_init_late")]),t._v(" "),s("p",[t._v("ç³»ç»Ÿæ‰§è¡Œå®Œ "),s("code",[t._v(".scattered_array_initcall_1_3")]),t._v(" æ®µçš„ä»£ç ï¼ˆç”± "),s("code",[t._v("service_init")]),t._v(" å‡½æ•°å®šä¹‰ï¼‰åï¼Œç»§ç»­æ‰§è¡Œ "),s("code",[t._v(".scattered_array_initcall_1_4")]),t._v(" æ®µçš„ä»£ç ã€‚ç›®å‰ï¼Œåªæœ‰ "),s("a",{attrs:{href:"https://github.com/OP-TEE/optee_os/blob/3.12.0/core/tee/tee_fs_key_manager.c#L277",target:"_blank",rel:"noopener noreferrer"}},[t._v("tee_fs_init_key_manager"),s("OutboundLink")],1),t._v(" å‡½æ•°çš„ç¼–è¯‘å€ŸåŠ©äº†è¿™ä¸ªå®ã€‚")]),t._v(" "),s("p",[t._v("å› æ­¤ï¼Œæ‰§è¡Œ "),s("code",[t._v(".scattered_array_initcall_1_4")]),t._v(" æ®µçš„ä»£ç æ—¶ï¼Œå°†ä¼šæ‰§è¡Œ "),s("code",[t._v("tee_fs_init_key_manager")]),t._v(" å‡½æ•°ï¼Œç”Ÿæˆ  secure storage keyï¼Œç”Ÿæˆçš„å¯†é’¥å°†ä¼šè¢«ä¿å­˜åˆ° "),s("code",[t._v("tee_fs_ssk")]),t._v(" å˜é‡çš„ "),s("code",[t._v("key")]),t._v(" å­—æ®µã€‚")]),t._v(" "),s("h2",{attrs:{id:"driver-init-å’Œ-driver-init-late"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#driver-init-å’Œ-driver-init-late"}},[t._v("#")]),t._v(" driver_init å’Œ driver_init_late")]),t._v(" "),s("p",[t._v("åˆå§‹åŒ–é˜¶æ®µå®Œæˆäº† "),s("code",[t._v(".scattered_array_initcall_1_3")]),t._v(" å’Œ "),s("code",[t._v(".scattered_array_initcall_1_4")]),t._v(" æ®µçš„ä»£ç æ‰§è¡Œä¹‹åï¼Œç³»ç»Ÿå°†æ‰§è¡Œ "),s("code",[t._v(".scattered_array_initcall_1_5")]),t._v(" å’Œ "),s("code",[t._v(".scattered_array_initcall_1_6")]),t._v(" æ®µçš„ä»£ç ã€‚è¯¥éƒ¨åˆ†è´Ÿè´£åˆå§‹åŒ–ä¸€äº›é©±åŠ¨ï¼ŒåŒ…æ‹¬ä¸²å£ã€å¤–å›´è®¾å¤‡ç­‰ã€‚åœ¨ OP-TEE ä¸­ï¼Œ"),s("a",{attrs:{href:"https://github.com/OP-TEE/optee_os/blob/3.12.0/core/include/initcall.h#L43",target:"_blank",rel:"noopener noreferrer"}},[t._v("driver_init"),s("OutboundLink")],1),t._v(" å’Œ "),s("a",{attrs:{href:"https://github.com/OP-TEE/optee_os/blob/3.12.0/core/include/initcall.h#L44",target:"_blank",rel:"noopener noreferrer"}},[t._v("driver_init_late"),s("OutboundLink")],1),t._v(" å®šä¹‰çš„ "),s("code",[t._v(".scattered_array_initcall_1_5")]),t._v(" å’Œ "),s("code",[t._v(".scattered_array_initcall_1_6")]),t._v(" æ®µçš„åŸºæœ¬å¦‚ä¸‹ï¼š")]),t._v(" "),s("div",{staticClass:"language-bash line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[t._v("root@cd8b134d882e:~/optee/builder/optee/optee_os/core"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v('# grep "driver_init(" -R .')]),t._v("\n./drivers/bnxt/bnxt.c:driver_init"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("bnxt_init"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n./drivers/crypto/caam/caam_ctrl.c:static TEE_Result crypto_driver_init"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("void"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n./drivers/crypto/se050/session.c:driver_init"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("se050_early_init"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n./drivers/stm32_bsec.c:driver_init"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("initialize_bsec"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n./drivers/dra7_rng.c:driver_init"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("dra7_rng_init"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n./drivers/bcm_sotp.c:driver_init"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("bcm_sotp_init"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n./drivers/bcm_gpio.c:driver_init"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("bcm_gpio_init"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n./drivers/imx_wdog.c:driver_init"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("imx_wdog_init"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n./drivers/stm32_rng.c:driver_init"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("stm32_rng_init"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n./drivers/bcm_hwrng.c:driver_init"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("bcm_hwrng_init"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n./drivers/hi16xx_rng.c:driver_init"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("hi16xx_rng_init"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n./arch/arm/plat-synquacer/main.c:driver_init"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("init_timer_itr"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n./arch/arm/plat-stm32mp1/drivers/stm32mp1_pmic.c:driver_init"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("initialize_pmic"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n./arch/arm/plat-stm32mp1/drivers/stm32mp1_syscfg.c:driver_init"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("stm32mp1_iocomp"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n./arch/arm/plat-stm32mp1/plat_tzc400.c:driver_init"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("init_stm32mp1_tzc"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n./arch/arm/plat-hikey/main.c:driver_init"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("peripherals_init"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n./arch/arm/plat-vexpress/main.c:driver_init"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("init_console_itr"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n./arch/arm/plat-sunxi/main.c:driver_init"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("smc_init"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n./arch/arm/plat-imx/drivers/tzc380.c:driver_init"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("imx_configure_tzasc"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n./arch/arm/plat-imx/drivers/imx_csu.c:driver_init"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("csu_init"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n./arch/arm/plat-imx/drivers/imx_scu.c:driver_init"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("scu_init"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n./arch/arm/plat-imx/drivers/imx_caam.c:driver_init"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("init_caam"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n./include/initcall.h:"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#define driver_init(fn)\t\t\t__define_initcall(init, 5, fn)")]),t._v("\n")])]),t._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[t._v("1")]),s("br"),s("span",{staticClass:"line-number"},[t._v("2")]),s("br"),s("span",{staticClass:"line-number"},[t._v("3")]),s("br"),s("span",{staticClass:"line-number"},[t._v("4")]),s("br"),s("span",{staticClass:"line-number"},[t._v("5")]),s("br"),s("span",{staticClass:"line-number"},[t._v("6")]),s("br"),s("span",{staticClass:"line-number"},[t._v("7")]),s("br"),s("span",{staticClass:"line-number"},[t._v("8")]),s("br"),s("span",{staticClass:"line-number"},[t._v("9")]),s("br"),s("span",{staticClass:"line-number"},[t._v("10")]),s("br"),s("span",{staticClass:"line-number"},[t._v("11")]),s("br"),s("span",{staticClass:"line-number"},[t._v("12")]),s("br"),s("span",{staticClass:"line-number"},[t._v("13")]),s("br"),s("span",{staticClass:"line-number"},[t._v("14")]),s("br"),s("span",{staticClass:"line-number"},[t._v("15")]),s("br"),s("span",{staticClass:"line-number"},[t._v("16")]),s("br"),s("span",{staticClass:"line-number"},[t._v("17")]),s("br"),s("span",{staticClass:"line-number"},[t._v("18")]),s("br"),s("span",{staticClass:"line-number"},[t._v("19")]),s("br"),s("span",{staticClass:"line-number"},[t._v("20")]),s("br"),s("span",{staticClass:"line-number"},[t._v("21")]),s("br"),s("span",{staticClass:"line-number"},[t._v("22")]),s("br"),s("span",{staticClass:"line-number"},[t._v("23")]),s("br"),s("span",{staticClass:"line-number"},[t._v("24")]),s("br")])]),s("p",[t._v("ä»¥ vexpress å¹³å°ä¸ºä¾‹ï¼Œ"),s("code",[t._v(".scattered_array_initcall_1_5")]),t._v("  æ®µçš„ä»£ç ä¼šåˆå§‹åŒ–æ§åˆ¶å°ï¼Œè€Œè¯¥æ“ä½œæ˜¯é€šè¿‡æ‰§è¡Œ "),s("a",{attrs:{href:"https://github.com/OP-TEE/optee_os/blob/3.12.0/core/arch/arm/plat-vexpress/main.c#L121",target:"_blank",rel:"noopener noreferrer"}},[t._v("init_console_itr"),s("OutboundLink")],1),t._v(" å‡½æ•°å®ç°ã€‚")]),t._v(" "),s("h2",{attrs:{id:"å‚è€ƒæ–‡çŒ®"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#å‚è€ƒæ–‡çŒ®"}},[t._v("#")]),t._v(" å‚è€ƒæ–‡çŒ®")]),t._v(" "),s("ul",[s("li",[s("a",{attrs:{href:"https://icyshuai.blog.csdn.net/article/details/72638193",target:"_blank",rel:"noopener noreferrer"}},[t._v("OP-TEE OSå¯åŠ¨ï¼ˆä¸€ï¼‰"),s("OutboundLink")],1)]),t._v(" "),s("li",[s("a",{attrs:{href:"https://blog.csdn.net/shuaifengyun/article/details/72638272",target:"_blank",rel:"noopener noreferrer"}},[t._v("OP-TEE OSå¯åŠ¨ï¼ˆäºŒï¼‰"),s("OutboundLink")],1)]),t._v(" "),s("li",[s("a",{attrs:{href:"https://icyshuai.blog.csdn.net/article/details/72655106",target:"_blank",rel:"noopener noreferrer"}},[t._v("OP-TEE OSå¯åŠ¨ï¼ˆä¸‰ï¼‰--service_init"),s("OutboundLink")],1)]),t._v(" "),s("li",[s("a",{attrs:{href:"https://icyshuai.blog.csdn.net/article/details/72657577",target:"_blank",rel:"noopener noreferrer"}},[t._v("OP-TEE OSå¯åŠ¨ï¼ˆå››ï¼‰--service_init_late"),s("OutboundLink")],1)]),t._v(" "),s("li",[s("a",{attrs:{href:"https://icyshuai.blog.csdn.net/article/details/72663758",target:"_blank",rel:"noopener noreferrer"}},[t._v("OP-TEE OSå¯åŠ¨ï¼ˆäº”ï¼‰--driver_initå’Œdriver_init_late"),s("OutboundLink")],1)])])])}),[],!1,null,null,null);s.default=e.exports}}]);