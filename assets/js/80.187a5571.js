(window.webpackJsonp=window.webpackJsonp||[]).push([[80],{815:function(t,s,a){"use strict";a.r(s);var n=a(6),e=Object(n.a)({},(function(){var t=this,s=t.$createElement,a=t._self._c||s;return a("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[a("h2",{attrs:{id:"启动流程"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#启动流程"}},[t._v("#")]),t._v(" 启动流程")]),t._v(" "),a("p",[t._v("如果系统有 ATF（ARM Trusted Frimware）（ATF 知识请参考 ATF 相关文档），OP-TEE OS 在 bl32 阶段启动，通过 bl31 阶段调用 "),a("a",{attrs:{href:"https://github.com/sammyne/trusted-firmware-a/blob/v2.3/services/spd/opteed/opteed_helpers.S#L21",target:"_blank",rel:"noopener noreferrer"}},[t._v("opteed_enter_sp"),a("OutboundLink")],1),t._v(" 函数跳转到 OP-TEE OS 执行启动操作。")]),t._v(" "),a("p",[t._v("以 QEMU+OP-TEE 的方式运行 TEE 时，OP-TEE image 的链接文件是 optee_os/core/arch/arm/kernel/kern.ld.S，由文件可知 TEE image 启动的入口函数是 "),a("a",{attrs:{href:"https://github.com/OP-TEE/optee_os/blob/3.12.0/core/arch/arm/kernel/kern.ld.S#L74",target:"_blank",rel:"noopener noreferrer"}},[t._v("_start"),a("OutboundLink")],1),t._v(" 函数。")]),t._v(" "),a("p",[a("code",[t._v("_start")]),t._v(" 函数定义在 optee_os/core/arch/arm 目录的不同文件，不同的板子拥有不同的 .S 文件。本文教程是用 QEMU 模拟 ARMv8，故使用 QEMU+OPTEE 运行 TEE 时，入口函数定义在 "),a("a",{attrs:{href:"https://github.com/OP-TEE/optee_os/blob/3.12.0/core/arch/arm/kernel/entry_a64.S#L57",target:"_blank",rel:"noopener noreferrer"}},[t._v("core/arch/arm/kernel/entry_a64.S"),a("OutboundLink")],1),t._v(" 文件。整个启动的大致流程图如下（只考虑主 CPU 的启动）：")]),t._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[t._v("+-------------------------------+               +-------------------------+\n|            _start             |               | thread_clr_boot_thread  |\n+---------------+---------------+               +-------------+-----------+\n                |                                             ^\n                |                                             |\n                v                                             |\n+---------------+---------------+               +-------------+-----------+\n|          set_sctlr_el1        |               |     boot_init_primary   |\n+---------------+---------------+               +-------------+-----------+\n                |                                             ^\n                |                                             |\n                v                                             |\n+---------------+---------------+               +-------------+-----------+\n|           copy_init           |               |        enable_mmu       |\n+---------------+---------------+               +-------------+-----------+\n                |                                             ^\n                |                                             |\n                v                                             |\n+---------------+---------------+               +-------------+-----------+\n|            set_sp             |               |     core_init_mmu_map   |\n+---------------+---------------+               +-------------+-----------+\n                |                                             ^\n                |                                             |\n                v                                             |\n+---------------+---------------+               +-------------+-----------+\n| thread_init_thread_core_local +--------------\x3e+ dcache_cleaninv_range   |\n+-------------------------------+               +-------------------------+\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br"),a("span",{staticClass:"line-number"},[t._v("2")]),a("br"),a("span",{staticClass:"line-number"},[t._v("3")]),a("br"),a("span",{staticClass:"line-number"},[t._v("4")]),a("br"),a("span",{staticClass:"line-number"},[t._v("5")]),a("br"),a("span",{staticClass:"line-number"},[t._v("6")]),a("br"),a("span",{staticClass:"line-number"},[t._v("7")]),a("br"),a("span",{staticClass:"line-number"},[t._v("8")]),a("br"),a("span",{staticClass:"line-number"},[t._v("9")]),a("br"),a("span",{staticClass:"line-number"},[t._v("10")]),a("br"),a("span",{staticClass:"line-number"},[t._v("11")]),a("br"),a("span",{staticClass:"line-number"},[t._v("12")]),a("br"),a("span",{staticClass:"line-number"},[t._v("13")]),a("br"),a("span",{staticClass:"line-number"},[t._v("14")]),a("br"),a("span",{staticClass:"line-number"},[t._v("15")]),a("br"),a("span",{staticClass:"line-number"},[t._v("16")]),a("br"),a("span",{staticClass:"line-number"},[t._v("17")]),a("br"),a("span",{staticClass:"line-number"},[t._v("18")]),a("br"),a("span",{staticClass:"line-number"},[t._v("19")]),a("br"),a("span",{staticClass:"line-number"},[t._v("20")]),a("br"),a("span",{staticClass:"line-number"},[t._v("21")]),a("br"),a("span",{staticClass:"line-number"},[t._v("22")]),a("br"),a("span",{staticClass:"line-number"},[t._v("23")]),a("br"),a("span",{staticClass:"line-number"},[t._v("24")]),a("br"),a("span",{staticClass:"line-number"},[t._v("25")]),a("br"),a("span",{staticClass:"line-number"},[t._v("26")]),a("br"),a("span",{staticClass:"line-number"},[t._v("27")]),a("br")])]),a("p",[t._v("如果系统有 ATF，"),a("a",{attrs:{href:"https://github.com/OP-TEE/optee_os/blob/3.12.0/core/arch/arm/kernel/boot.c#L1185",target:"_blank",rel:"noopener noreferrer"}},[t._v("boot_init_primary"),a("OutboundLink")],1),t._v(" 函数执行完成之后返回 OP-TEE 的向量表，否则不返回向量表。OP-TEE 启动过程中主体初始化操作都是在 "),a("code",[t._v("boot_init_primary")]),t._v(" 函数执行的。该函数的相关函数集中在 "),a("a",{attrs:{href:"https://github.com/OP-TEE/optee_os/blob/3.12.0/core/arch/arm/kernel/boot.c",target:"_blank",rel:"noopener noreferrer"}},[t._v("optee_os/core/arch/arm/kernel/boot.c"),a("OutboundLink")],1),t._v(" 文件，具体如下")]),t._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[t._v("|-boot_init_primary\n  |-init_primary\n    |-thread_set_exceptions // 设置异常处理函数\n    |-init_vfp_sec // 初始化 VFP--浮点数运算单元 \n    |-init_runtime  // 初始化和配置 TEE 运行时用到的各种内存，例如：清空 BSS，初始化线程内存，分配 TA 运行时所需内存等\n    |-thread_init_primary // 初始化 TEE 支持的线程栈空间、异常处理、页表等\n    |-thread_init_per_cpu // 如果没有 ATF，初始化每个 CPU 的 monitor 态的处理方式\n    |-init_sec_mon        // 如果不支持 ATF，配置内核态 CPU 的 Monitor 处理方式\n  |-paged_init_primary\n    |-init_external_dt    // 初始化设备树\n    |-main_init_gic       // 初始化中断控制器\n    |-init_vfp_nsec       // 初始化常规世界的 VFP--浮点数运算单元\n    |-init_tee_runtime    // 初始化共享内存等\n      |-call_initcalls    // 定义在 initcall.c \n    |-call_finalcalls\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br"),a("span",{staticClass:"line-number"},[t._v("2")]),a("br"),a("span",{staticClass:"line-number"},[t._v("3")]),a("br"),a("span",{staticClass:"line-number"},[t._v("4")]),a("br"),a("span",{staticClass:"line-number"},[t._v("5")]),a("br"),a("span",{staticClass:"line-number"},[t._v("6")]),a("br"),a("span",{staticClass:"line-number"},[t._v("7")]),a("br"),a("span",{staticClass:"line-number"},[t._v("8")]),a("br"),a("span",{staticClass:"line-number"},[t._v("9")]),a("br"),a("span",{staticClass:"line-number"},[t._v("10")]),a("br"),a("span",{staticClass:"line-number"},[t._v("11")]),a("br"),a("span",{staticClass:"line-number"},[t._v("12")]),a("br"),a("span",{staticClass:"line-number"},[t._v("13")]),a("br"),a("span",{staticClass:"line-number"},[t._v("14")]),a("br"),a("span",{staticClass:"line-number"},[t._v("15")]),a("br")])]),a("h3",{attrs:{id:"call-initcalls"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#call-initcalls"}},[t._v("#")]),t._v(" call_initcalls")]),t._v(" "),a("p",[t._v("初始化内存、CPU 相关设置、中断控制器、共享内存、线程堆栈、TA 执行内存分配等操作之后，"),a("code",[t._v("init_tee_runtime")]),t._v(" 函数调用 "),a("code",[t._v("call_initcalls")]),t._v(" 函数启动 OP-TEE OS 的各种 service。"),a("code",[t._v("call_initcalls")]),t._v(" 代码如下：")]),t._v(" "),a("div",{staticClass:"language-c line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-c"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// optee_os/core/kernel/initcall.c")]),t._v("\n\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("void")]),t._v(" __weak "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("call_initcalls")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("void")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\t"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("struct")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("initcall")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v("call "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token constant"}},[t._v("NULL")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\tTEE_Result ret "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" TEE_SUCCESS"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n\t"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("for")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("call "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" initcall_begin"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" call "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v(" initcall_end"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" call"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("++")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\t\t"),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("DMSG")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"level %d %s()"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" call"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("->")]),t._v("level"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" call"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("->")]),t._v("func_name"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\t\tret "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" call"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("->")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("func")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\t\t"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("ret "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!=")]),t._v(" TEE_SUCCESS"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\t\t\t"),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("EMSG")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"Initcall __text_start + 0x%08"')]),t._v(" PRIxVA\n\t\t\t     "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('" failed"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("vaddr_t")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("call "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v(" VCORE_START_VA"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\t\t"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\t"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br"),a("span",{staticClass:"line-number"},[t._v("2")]),a("br"),a("span",{staticClass:"line-number"},[t._v("3")]),a("br"),a("span",{staticClass:"line-number"},[t._v("4")]),a("br"),a("span",{staticClass:"line-number"},[t._v("5")]),a("br"),a("span",{staticClass:"line-number"},[t._v("6")]),a("br"),a("span",{staticClass:"line-number"},[t._v("7")]),a("br"),a("span",{staticClass:"line-number"},[t._v("8")]),a("br"),a("span",{staticClass:"line-number"},[t._v("9")]),a("br"),a("span",{staticClass:"line-number"},[t._v("10")]),a("br"),a("span",{staticClass:"line-number"},[t._v("11")]),a("br"),a("span",{staticClass:"line-number"},[t._v("12")]),a("br"),a("span",{staticClass:"line-number"},[t._v("13")]),a("br"),a("span",{staticClass:"line-number"},[t._v("14")]),a("br"),a("span",{staticClass:"line-number"},[t._v("15")]),a("br"),a("span",{staticClass:"line-number"},[t._v("16")]),a("br")])]),a("p",[t._v("该函数会依次执行 "),a("code",[t._v("initcall_begin")]),t._v(" 到 "),a("code",[t._v("initcall_end")]),t._v(" 之间的所有函数。（TODO："),a("code",[t._v("initcall_begin")]),t._v(" 和 "),a("code",[t._v("initcall_end")]),t._v(" 的具体定义尚未看懂 😦）")]),t._v(" "),a("p",[a("code",[t._v("initcall_begin")]),t._v(" 和 "),a("code",[t._v("initcall_end")]),t._v(" 之间的函数代码通过 "),a("a",{attrs:{href:"https://github.com/OP-TEE/optee_os/blob/3.12.0/core/include/initcall.h#L22",target:"_blank",rel:"noopener noreferrer"}},[t._v("__define_initcall"),a("OutboundLink")],1),t._v(" 宏放到对应段，具体内容如下")]),t._v(" "),a("div",{staticClass:"language-c line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-c"}},[a("code",[a("span",{pre:!0,attrs:{class:"token macro property"}},[a("span",{pre:!0,attrs:{class:"token directive-hash"}},[t._v("#")]),a("span",{pre:!0,attrs:{class:"token directive keyword"}},[t._v("define")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token macro-name function"}},[t._v("early_init")]),a("span",{pre:!0,attrs:{class:"token expression"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("fn"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\t\t\t"),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("__define_initcall")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("init"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" fn"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")])])]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token macro property"}},[a("span",{pre:!0,attrs:{class:"token directive-hash"}},[t._v("#")]),a("span",{pre:!0,attrs:{class:"token directive keyword"}},[t._v("define")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token macro-name function"}},[t._v("early_init_late")]),a("span",{pre:!0,attrs:{class:"token expression"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("fn"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\t\t"),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("__define_initcall")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("init"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("2")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" fn"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")])])]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token macro property"}},[a("span",{pre:!0,attrs:{class:"token directive-hash"}},[t._v("#")]),a("span",{pre:!0,attrs:{class:"token directive keyword"}},[t._v("define")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token macro-name function"}},[t._v("service_init")]),a("span",{pre:!0,attrs:{class:"token expression"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("fn"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\t\t"),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("__define_initcall")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("init"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("3")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" fn"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")])])]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token macro property"}},[a("span",{pre:!0,attrs:{class:"token directive-hash"}},[t._v("#")]),a("span",{pre:!0,attrs:{class:"token directive keyword"}},[t._v("define")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token macro-name function"}},[t._v("service_init_late")]),a("span",{pre:!0,attrs:{class:"token expression"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("fn"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\t\t"),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("__define_initcall")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("init"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("4")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" fn"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")])])]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token macro property"}},[a("span",{pre:!0,attrs:{class:"token directive-hash"}},[t._v("#")]),a("span",{pre:!0,attrs:{class:"token directive keyword"}},[t._v("define")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token macro-name function"}},[t._v("driver_init")]),a("span",{pre:!0,attrs:{class:"token expression"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("fn"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\t\t\t"),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("__define_initcall")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("init"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("5")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" fn"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")])])]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token macro property"}},[a("span",{pre:!0,attrs:{class:"token directive-hash"}},[t._v("#")]),a("span",{pre:!0,attrs:{class:"token directive keyword"}},[t._v("define")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token macro-name function"}},[t._v("driver_init_late")]),a("span",{pre:!0,attrs:{class:"token expression"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("fn"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\t\t"),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("__define_initcall")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("init"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("6")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" fn"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")])])]),t._v("\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br"),a("span",{staticClass:"line-number"},[t._v("2")]),a("br"),a("span",{staticClass:"line-number"},[t._v("3")]),a("br"),a("span",{staticClass:"line-number"},[t._v("4")]),a("br"),a("span",{staticClass:"line-number"},[t._v("5")]),a("br"),a("span",{staticClass:"line-number"},[t._v("6")]),a("br")])]),a("blockquote",[a("p",[a("code",[t._v("__define_initcall")]),t._v(" 指示编译器将 "),a("code",[t._v("service_init(fn)")]),t._v(" 的 "),a("code",[t._v("fn")]),t._v(" 函数代码存放到 "),a("code",[t._v(".scattered_array_initcall_1_3")]),t._v(" 段（目前这个属于个人理解）")])]),t._v(" "),a("h2",{attrs:{id:"service-init"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#service-init"}},[t._v("#")]),t._v(" service_init")]),t._v(" "),a("p",[t._v("由编译产出的 optee_os/out/arm/core/tee.map 文件可知 "),a("code",[t._v(".scattered_array_initcall_1_3")]),t._v(" 段存的内容如下")]),t._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[t._v("// ...\n.scattered_array_initcall_1_1\n              0x000000000e15cc18       0x18 out/arm/core/arch/arm/mm/core_mmu.o\n.scattered_array_initcall_1_3\n              0x000000000e15cc30       0x30 out/arm/core/arch/arm/kernel/user_ta.o\n.scattered_array_initcall_1_3\n              0x000000000e15cc60       0x18 out/arm/core/arch/arm/kernel/pseudo_ta.o\n.scattered_array_initcall_1_3\n              0x000000000e15cc78       0x18 out/arm/core/arch/arm/mm/mobj_dyn_shm.o\n.scattered_array_initcall_1_3\n              0x000000000e15cc90       0x18 out/arm/core/tee/tee_cryp_utl.o\n.scattered_array_initcall_1_4\n// ...\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br"),a("span",{staticClass:"line-number"},[t._v("2")]),a("br"),a("span",{staticClass:"line-number"},[t._v("3")]),a("br"),a("span",{staticClass:"line-number"},[t._v("4")]),a("br"),a("span",{staticClass:"line-number"},[t._v("5")]),a("br"),a("span",{staticClass:"line-number"},[t._v("6")]),a("br"),a("span",{staticClass:"line-number"},[t._v("7")]),a("br"),a("span",{staticClass:"line-number"},[t._v("8")]),a("br"),a("span",{staticClass:"line-number"},[t._v("9")]),a("br"),a("span",{staticClass:"line-number"},[t._v("10")]),a("br"),a("span",{staticClass:"line-number"},[t._v("11")]),a("br"),a("span",{staticClass:"line-number"},[t._v("12")]),a("br"),a("span",{staticClass:"line-number"},[t._v("13")]),a("br")])]),a("p",[t._v("遍历整个 OP-TEE 目录可知，使用 "),a("code",[t._v("service_init")]),t._v(" 宏将代码存放到 "),a("code",[t._v(".scattered_array_initcall_1_3")]),t._v(" 段的函数如下：")]),t._v(" "),a("table",[a("thead",[a("tr",[a("th",{staticStyle:{"text-align":"right"}},[t._v("函数")]),t._v(" "),a("th",{staticStyle:{"text-align":"left"}},[t._v("相关文件")])])]),t._v(" "),a("tbody",[a("tr",[a("td",{staticStyle:{"text-align":"right"}},[a("a",{attrs:{href:"https://github.com/OP-TEE/optee_os/blob/3.12.0/core/arch/arm/kernel/user_ta.c#L422",target:"_blank",rel:"noopener noreferrer"}},[t._v("check_ta_store"),a("OutboundLink")],1),t._v(", "),a("a",{attrs:{href:"https://github.com/OP-TEE/optee_os/blob/3.12.0/core/arch/arm/kernel/user_ta.c#L401",target:"_blank",rel:"noopener noreferrer"}},[t._v("init_user_ta"),a("OutboundLink")],1)]),t._v(" "),a("td",{staticStyle:{"text-align":"left"}},[t._v("user_ta.c")])]),t._v(" "),a("tr",[a("td",{staticStyle:{"text-align":"right"}},[a("a",{attrs:{href:"https://github.com/OP-TEE/optee_os/blob/3.12.0/core/arch/arm/kernel/pseudo_ta.c#L286",target:"_blank",rel:"noopener noreferrer"}},[t._v("verify_pseudo_tas_conformance"),a("OutboundLink")],1)]),t._v(" "),a("td",{staticStyle:{"text-align":"left"}},[t._v("pseudo_ta.c")])]),t._v(" "),a("tr",[a("td",{staticStyle:{"text-align":"right"}},[a("a",{attrs:{href:"https://github.com/OP-TEE/optee_os/blob/3.12.0/core/arch/arm/mm/mobj_dyn_shm.c#L438",target:"_blank",rel:"noopener noreferrer"}},[t._v("mobj_mapped_shm_init"),a("OutboundLink")],1)]),t._v(" "),a("td",{staticStyle:{"text-align":"left"}},[t._v("mobj_dyn_shm.c")])]),t._v(" "),a("tr",[a("td",{staticStyle:{"text-align":"right"}},[a("a",{attrs:{href:"https://github.com/OP-TEE/optee_os/blob/3.12.0/core/tee/tee_cryp_utl.c#L211",target:"_blank",rel:"noopener noreferrer"}},[t._v("tee_cryp_init"),a("OutboundLink")],1)]),t._v(" "),a("td",{staticStyle:{"text-align":"left"}},[t._v("tee_cryp_utl.c")])])])]),t._v(" "),a("p",[t._v("也即执行 "),a("code",[t._v(".scattered_array_initcall_1_3")]),t._v(" 段内容时，将会依次执行这些函数。")]),t._v(" "),a("h3",{attrs:{id:"_1-check-ta-store-init-user-ta"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_1-check-ta-store-init-user-ta"}},[t._v("#")]),t._v(" 1. check_ta_store, init_user_ta")]),t._v(" "),a("p",[t._v("这两个函数负责把加载 TA image 的操作结构体赋值给 "),a("code",[t._v("_user_ta_ops")]),t._v(" 变量，该变量会在加载 TA image 的时候被使用到，该函数的代码如下：")]),t._v(" "),a("div",{staticClass:"language-c line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-c"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 定义加载 TA image 依赖的操作函数指针")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("static")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("struct")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("ts_ops")]),t._v(" user_ta_ops __rodata_unpaged "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\t"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("enter_open_session "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" user_ta_enter_open_session"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n\t"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("enter_invoke_cmd "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" user_ta_enter_invoke_cmd"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n\t"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("enter_close_session "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" user_ta_enter_close_session"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n\t"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("dump_state "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" user_ta_dump_state"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token macro property"}},[a("span",{pre:!0,attrs:{class:"token directive-hash"}},[t._v("#")]),a("span",{pre:!0,attrs:{class:"token directive keyword"}},[t._v("ifdef")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token expression"}},[t._v("CFG_FTRACE_SUPPORT")])]),t._v("\n\t"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("dump_ftrace "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" user_ta_dump_ftrace"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token macro property"}},[a("span",{pre:!0,attrs:{class:"token directive-hash"}},[t._v("#")]),a("span",{pre:!0,attrs:{class:"token directive keyword"}},[t._v("endif")])]),t._v("\n\t"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("destroy "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" user_ta_ctx_destroy"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n\t"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("get_instance_id "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" user_ta_get_instance_id"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n\t"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("handle_svc "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" user_ta_handle_svc"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token macro property"}},[a("span",{pre:!0,attrs:{class:"token directive-hash"}},[t._v("#")]),a("span",{pre:!0,attrs:{class:"token directive keyword"}},[t._v("ifdef")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token expression"}},[t._v("CFG_TA_GPROF_SUPPORT")])]),t._v("\n\t"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("gprof_set_status "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" user_ta_gprof_set_status"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token macro property"}},[a("span",{pre:!0,attrs:{class:"token directive-hash"}},[t._v("#")]),a("span",{pre:!0,attrs:{class:"token directive keyword"}},[t._v("endif")])]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("/*\n * Break unpaged attribute dependency propagation to user_ta_ops structure\n * content thanks to a runtime initialization of the ops reference.\n */")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("static")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("struct")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("ts_ops")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v("_user_ta_ops"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("static")]),t._v(" TEE_Result "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("init_user_ta")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("void")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\t_user_ta_ops "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("&")]),t._v("user_ta_ops"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n\t"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" TEE_SUCCESS"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("service_init")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("init_user_ta"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// ...")]),t._v("\n\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("static")]),t._v(" TEE_Result "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("check_ta_store")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("void")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\t"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("struct")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("ts_store_ops")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v("op "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token constant"}},[t._v("NULL")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n\t"),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("SCATTERED_ARRAY_FOREACH")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("op"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" ta_stores"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("struct")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("ts_store_ops")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\t\t"),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("DMSG")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"TA store: \\"%s\\""')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" op"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("->")]),t._v("description"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n\t"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" TEE_SUCCESS"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("service_init")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("check_ta_store"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// ...")]),t._v("\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br"),a("span",{staticClass:"line-number"},[t._v("2")]),a("br"),a("span",{staticClass:"line-number"},[t._v("3")]),a("br"),a("span",{staticClass:"line-number"},[t._v("4")]),a("br"),a("span",{staticClass:"line-number"},[t._v("5")]),a("br"),a("span",{staticClass:"line-number"},[t._v("6")]),a("br"),a("span",{staticClass:"line-number"},[t._v("7")]),a("br"),a("span",{staticClass:"line-number"},[t._v("8")]),a("br"),a("span",{staticClass:"line-number"},[t._v("9")]),a("br"),a("span",{staticClass:"line-number"},[t._v("10")]),a("br"),a("span",{staticClass:"line-number"},[t._v("11")]),a("br"),a("span",{staticClass:"line-number"},[t._v("12")]),a("br"),a("span",{staticClass:"line-number"},[t._v("13")]),a("br"),a("span",{staticClass:"line-number"},[t._v("14")]),a("br"),a("span",{staticClass:"line-number"},[t._v("15")]),a("br"),a("span",{staticClass:"line-number"},[t._v("16")]),a("br"),a("span",{staticClass:"line-number"},[t._v("17")]),a("br"),a("span",{staticClass:"line-number"},[t._v("18")]),a("br"),a("span",{staticClass:"line-number"},[t._v("19")]),a("br"),a("span",{staticClass:"line-number"},[t._v("20")]),a("br"),a("span",{staticClass:"line-number"},[t._v("21")]),a("br"),a("span",{staticClass:"line-number"},[t._v("22")]),a("br"),a("span",{staticClass:"line-number"},[t._v("23")]),a("br"),a("span",{staticClass:"line-number"},[t._v("24")]),a("br"),a("span",{staticClass:"line-number"},[t._v("25")]),a("br"),a("span",{staticClass:"line-number"},[t._v("26")]),a("br"),a("span",{staticClass:"line-number"},[t._v("27")]),a("br"),a("span",{staticClass:"line-number"},[t._v("28")]),a("br"),a("span",{staticClass:"line-number"},[t._v("29")]),a("br"),a("span",{staticClass:"line-number"},[t._v("30")]),a("br"),a("span",{staticClass:"line-number"},[t._v("31")]),a("br"),a("span",{staticClass:"line-number"},[t._v("32")]),a("br"),a("span",{staticClass:"line-number"},[t._v("33")]),a("br"),a("span",{staticClass:"line-number"},[t._v("34")]),a("br"),a("span",{staticClass:"line-number"},[t._v("35")]),a("br"),a("span",{staticClass:"line-number"},[t._v("36")]),a("br"),a("span",{staticClass:"line-number"},[t._v("37")]),a("br"),a("span",{staticClass:"line-number"},[t._v("38")]),a("br"),a("span",{staticClass:"line-number"},[t._v("39")]),a("br"),a("span",{staticClass:"line-number"},[t._v("40")]),a("br"),a("span",{staticClass:"line-number"},[t._v("41")]),a("br"),a("span",{staticClass:"line-number"},[t._v("42")]),a("br"),a("span",{staticClass:"line-number"},[t._v("43")]),a("br"),a("span",{staticClass:"line-number"},[t._v("44")]),a("br"),a("span",{staticClass:"line-number"},[t._v("45")]),a("br")])]),a("h3",{attrs:{id:"_2-verify-pseudo-tas-conformance"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_2-verify-pseudo-tas-conformance"}},[t._v("#")]),t._v(" 2. verify_pseudo_tas_conformance")]),t._v(" "),a("p",[t._v("该函数校验 OP-TEE OS 集成的 TA 合法性，需要检查 OP-TEE OS 自有 TA 的 UUID、函数指针和相关标识符。代码如下：")]),t._v(" "),a("div",{staticClass:"language-c line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-c"}},[a("code",[t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("/* Insures declared pseudo TAs conforms with core expectations */")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("static")]),t._v(" TEE_Result "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("verify_pseudo_tas_conformance")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("void")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\t"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("struct")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("pseudo_ta_head")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v("start "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("\n\t\t"),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("SCATTERED_ARRAY_BEGIN")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("pseudo_tas"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("struct")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("pseudo_ta_head")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 获取存放 pseudo TAs 的 head info 段起始地址")]),t._v("\n\t"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("struct")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("pseudo_ta_head")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v("end "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("\n\t\t"),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("SCATTERED_ARRAY_END")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("pseudo_tas"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("struct")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("pseudo_ta_head")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 获取存放 pseudo TAs 的 head info 段末尾地址")]),t._v("\n\t"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("struct")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("pseudo_ta_head")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v("pta"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n\t"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("for")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("pta "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" start"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" pta "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v(" end"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" pta"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("++")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\t\t"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("struct")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("pseudo_ta_head")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v("pta2"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n\t\t"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("/* PTAs must all have a specific UUID */")]),t._v("\n\t\t"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("for")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("pta2 "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" pta "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("+")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" pta2 "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v(" end"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" pta2"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("++")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n      "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 检查 psedo TAs 的 head info 包含的 UUID 信息是否有相同的")]),t._v("\n\t\t\t"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("memcmp")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("&")]),t._v("pta"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("->")]),t._v("uuid"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("&")]),t._v("pta2"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("->")]),t._v("uuid"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("sizeof")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("TEE_UUID"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\t\t\t\t"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("goto")]),t._v(" err"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\t\t"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n    "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 检查 invoke 函数指针是否为空和相关 flag 是否合法")]),t._v("\n\t\t"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!")]),t._v("pta"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("->")]),t._v("name "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("||")]),t._v("\n\t\t    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("pta"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("->")]),t._v("flags "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("&")]),t._v(" PTA_MANDATORY_FLAGS"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!=")]),t._v(" PTA_MANDATORY_FLAGS "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("||")]),t._v("\n\t\t    pta"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("->")]),t._v("flags "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("&")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("~")]),t._v("PTA_ALLOWED_FLAGS "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("||")]),t._v("\n\t\t    "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!")]),t._v("pta"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("->")]),t._v("invoke_command_entry_point"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\t\t\t"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("goto")]),t._v(" err"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\t"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\t"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" TEE_SUCCESS"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\nerr"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v("\n\t"),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("DMSG")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"pseudo TA error at %p"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("void")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("pta"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\t"),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("panic")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"PTA"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n"),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("service_init")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("verify_pseudo_tas_conformance"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br"),a("span",{staticClass:"line-number"},[t._v("2")]),a("br"),a("span",{staticClass:"line-number"},[t._v("3")]),a("br"),a("span",{staticClass:"line-number"},[t._v("4")]),a("br"),a("span",{staticClass:"line-number"},[t._v("5")]),a("br"),a("span",{staticClass:"line-number"},[t._v("6")]),a("br"),a("span",{staticClass:"line-number"},[t._v("7")]),a("br"),a("span",{staticClass:"line-number"},[t._v("8")]),a("br"),a("span",{staticClass:"line-number"},[t._v("9")]),a("br"),a("span",{staticClass:"line-number"},[t._v("10")]),a("br"),a("span",{staticClass:"line-number"},[t._v("11")]),a("br"),a("span",{staticClass:"line-number"},[t._v("12")]),a("br"),a("span",{staticClass:"line-number"},[t._v("13")]),a("br"),a("span",{staticClass:"line-number"},[t._v("14")]),a("br"),a("span",{staticClass:"line-number"},[t._v("15")]),a("br"),a("span",{staticClass:"line-number"},[t._v("16")]),a("br"),a("span",{staticClass:"line-number"},[t._v("17")]),a("br"),a("span",{staticClass:"line-number"},[t._v("18")]),a("br"),a("span",{staticClass:"line-number"},[t._v("19")]),a("br"),a("span",{staticClass:"line-number"},[t._v("20")]),a("br"),a("span",{staticClass:"line-number"},[t._v("21")]),a("br"),a("span",{staticClass:"line-number"},[t._v("22")]),a("br"),a("span",{staticClass:"line-number"},[t._v("23")]),a("br"),a("span",{staticClass:"line-number"},[t._v("24")]),a("br"),a("span",{staticClass:"line-number"},[t._v("25")]),a("br"),a("span",{staticClass:"line-number"},[t._v("26")]),a("br"),a("span",{staticClass:"line-number"},[t._v("27")]),a("br"),a("span",{staticClass:"line-number"},[t._v("28")]),a("br"),a("span",{staticClass:"line-number"},[t._v("29")]),a("br"),a("span",{staticClass:"line-number"},[t._v("30")]),a("br"),a("span",{staticClass:"line-number"},[t._v("31")]),a("br"),a("span",{staticClass:"line-number"},[t._v("32")]),a("br"),a("span",{staticClass:"line-number"},[t._v("33")]),a("br"),a("span",{staticClass:"line-number"},[t._v("34")]),a("br")])]),a("p",[t._v("在编译过程中，哪些部分会被添加到存放 pseudo TAs 的 head info 的 "),a("code",[t._v(".scattered_array_pseudo_tas_0")]),t._v("（由 "),a("code",[t._v("SCATTERED_ARRAY_BEGIN")]),t._v(" 定义）段呢？该操作通过使用 "),a("a",{attrs:{href:"https://github.com/OP-TEE/optee_os/blob/3.12.0/core/arch/arm/include/kernel/pseudo_ta.h#L43",target:"_blank",rel:"noopener noreferrer"}},[t._v("pseudo_ta_register"),a("OutboundLink")],1),t._v(" 宏实现，定义在 core/arch/arm/include/kernel/pseudo_ta.h 文件如下：")]),t._v(" "),a("div",{staticClass:"language-c line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-c"}},[a("code",[a("span",{pre:!0,attrs:{class:"token macro property"}},[a("span",{pre:!0,attrs:{class:"token directive-hash"}},[t._v("#")]),a("span",{pre:!0,attrs:{class:"token directive keyword"}},[t._v("define")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token macro-name function"}},[t._v("pseudo_ta_register")]),a("span",{pre:!0,attrs:{class:"token expression"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\t")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("\n\t"),a("span",{pre:!0,attrs:{class:"token expression"}},[a("span",{pre:!0,attrs:{class:"token function"}},[t._v("SCATTERED_ARRAY_DEFINE_PG_ITEM")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("pseudo_tas"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("struct")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("pseudo_ta_head")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" ")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("\n\t\t"),a("span",{pre:!0,attrs:{class:"token expression"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v(" __VA_ARGS__ "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")])])]),t._v("\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br"),a("span",{staticClass:"line-number"},[t._v("2")]),a("br"),a("span",{staticClass:"line-number"},[t._v("3")]),a("br")])]),a("p",[t._v("该宏规定 "),a("code",[t._v("pseudo_ta_register")]),t._v(" 参数的 "),a("code",[t._v("pseudo_ta_head")]),t._v(" 结构体变量将会被存放 "),a("code",[t._v(".scattered_array_pseudo_tas_1_0")]),t._v(" 段（核实）。在 OP-TEE 有 5 个 TA 会被打包进 OP-TEE image，相关文件如下：")]),t._v(" "),a("blockquote",[a("p",[t._v("除了 socket TA 外，所有文件均在 optee_os/core/arch/arm/pta 目录下。")])]),t._v(" "),a("table",[a("thead",[a("tr",[a("th",{staticStyle:{"text-align":"right"}},[t._v("TA")]),t._v(" "),a("th",{staticStyle:{"text-align":"left"}},[t._v("文件")])])]),t._v(" "),a("tbody",[a("tr",[a("td",{staticStyle:{"text-align":"right"}},[a("a",{attrs:{href:"https://github.com/OP-TEE/optee_os/blob/3.12.0/core/pta/device.c#L95",target:"_blank",rel:"noopener noreferrer"}},[t._v("device.pta"),a("OutboundLink")],1)]),t._v(" "),a("td",{staticStyle:{"text-align":"left"}},[t._v("device.c")])]),t._v(" "),a("tr",[a("td",{staticStyle:{"text-align":"right"}},[a("a",{attrs:{href:"https://github.com/OP-TEE/optee_os/blob/3.12.0/core/pta/secstor_ta_mgmt.c#L179",target:"_blank",rel:"noopener noreferrer"}},[t._v("secstor_ta_mgmt"),a("OutboundLink")],1)]),t._v(" "),a("td",{staticStyle:{"text-align":"left"}},[t._v("secstor_ta_mgmt.c")])]),t._v(" "),a("tr",[a("td",{staticStyle:{"text-align":"right"}},[a("a",{attrs:{href:"https://github.com/OP-TEE/optee_os/blob/3.12.0/core/pta/gprof.c#L182",target:"_blank",rel:"noopener noreferrer"}},[t._v("gprof"),a("OutboundLink")],1)]),t._v(" "),a("td",{staticStyle:{"text-align":"left"}},[t._v("gprof.c")])]),t._v(" "),a("tr",[a("td",{staticStyle:{"text-align":"right"}},[a("a",{attrs:{href:"https://github.com/OP-TEE/optee_os/blob/3.12.0/core/pta/stats.c#L161",target:"_blank",rel:"noopener noreferrer"}},[t._v("stats.ta"),a("OutboundLink")],1)]),t._v(" "),a("td",{staticStyle:{"text-align":"left"}},[t._v("stats.c")])]),t._v(" "),a("tr",[a("td",{staticStyle:{"text-align":"right"}},[a("a",{attrs:{href:"https://github.com/OP-TEE/optee_os/blob/3.12.0/core/pta/system.c#L331",target:"_blank",rel:"noopener noreferrer"}},[t._v("system.pta"),a("OutboundLink")],1)]),t._v(" "),a("td",{staticStyle:{"text-align":"left"}},[t._v("system.c")])]),t._v(" "),a("tr",[a("td",{staticStyle:{"text-align":"right"}},[a("a",{attrs:{href:"https://github.com/OP-TEE/optee_os/blob/3.12.0/core/tee/socket.c#L262",target:"_blank",rel:"noopener noreferrer"}},[t._v("socket"),a("OutboundLink")],1)]),t._v(" "),a("td",{staticStyle:{"text-align":"left"}},[t._v("optee_os/core/tee/socket.c")])])])]),t._v(" "),a("blockquote",[a("p",[t._v("TODO：未完全理解")])]),t._v(" "),a("h3",{attrs:{id:"_3-mobj-mapped-shm-init"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_3-mobj-mapped-shm-init"}},[t._v("#")]),t._v(" 3. mobj_mapped_shm_init")]),t._v(" "),a("p",[t._v("TODO")]),t._v(" "),a("h3",{attrs:{id:"_4-tee-cryp-init"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_4-tee-cryp-init"}},[t._v("#")]),t._v(" 4. tee_cryp_init")]),t._v(" "),a("p",[t._v("该函数初始化加解密功能，会调用 "),a("code",[t._v("crypto_init()")]),t._v(" 和 "),a("code",[t._v("plat_rng_init()")]),t._v(" 进行初始化操作，函数调用栈如下")]),t._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[t._v("|-tee_cryp_init\n  |-crypto_init  // optee_os/lib/libmbedtls/core/tomcrypt.c#L10\n    |-tomcrypt_init // optee_os/core/lib/libtomcrypt/tomcrypt.c#141\n      |-ltc_init    // optee_os/core/lib/libtomcrypt/tomcrypt.c#125\n                    // 完成各种算法调用接口的定义和初始化\n  |-plat_rng_init // 初始化伪随机数发生器的种子\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br"),a("span",{staticClass:"line-number"},[t._v("2")]),a("br"),a("span",{staticClass:"line-number"},[t._v("3")]),a("br"),a("span",{staticClass:"line-number"},[t._v("4")]),a("br"),a("span",{staticClass:"line-number"},[t._v("5")]),a("br"),a("span",{staticClass:"line-number"},[t._v("6")]),a("br")])]),a("h2",{attrs:{id:"service-init-late"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#service-init-late"}},[t._v("#")]),t._v(" service_init_late")]),t._v(" "),a("p",[t._v("系统执行完 "),a("code",[t._v(".scattered_array_initcall_1_3")]),t._v(" 段的代码（由 "),a("code",[t._v("service_init")]),t._v(" 函数定义）后，继续执行 "),a("code",[t._v(".scattered_array_initcall_1_4")]),t._v(" 段的代码。目前，只有 "),a("a",{attrs:{href:"https://github.com/OP-TEE/optee_os/blob/3.12.0/core/tee/tee_fs_key_manager.c#L277",target:"_blank",rel:"noopener noreferrer"}},[t._v("tee_fs_init_key_manager"),a("OutboundLink")],1),t._v(" 函数的编译借助了这个宏。")]),t._v(" "),a("p",[t._v("因此，执行 "),a("code",[t._v(".scattered_array_initcall_1_4")]),t._v(" 段的代码时，将会执行 "),a("code",[t._v("tee_fs_init_key_manager")]),t._v(" 函数，生成  secure storage key，生成的密钥将会被保存到 "),a("code",[t._v("tee_fs_ssk")]),t._v(" 变量的 "),a("code",[t._v("key")]),t._v(" 字段。")]),t._v(" "),a("h2",{attrs:{id:"driver-init-和-driver-init-late"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#driver-init-和-driver-init-late"}},[t._v("#")]),t._v(" driver_init 和 driver_init_late")]),t._v(" "),a("p",[t._v("初始化阶段完成了 "),a("code",[t._v(".scattered_array_initcall_1_3")]),t._v(" 和 "),a("code",[t._v(".scattered_array_initcall_1_4")]),t._v(" 段的代码执行之后，系统将执行 "),a("code",[t._v(".scattered_array_initcall_1_5")]),t._v(" 和 "),a("code",[t._v(".scattered_array_initcall_1_6")]),t._v(" 段的代码。该部分负责初始化一些驱动，包括串口、外围设备等。在 OP-TEE 中，"),a("a",{attrs:{href:"https://github.com/OP-TEE/optee_os/blob/3.12.0/core/include/initcall.h#L43",target:"_blank",rel:"noopener noreferrer"}},[t._v("driver_init"),a("OutboundLink")],1),t._v(" 和 "),a("a",{attrs:{href:"https://github.com/OP-TEE/optee_os/blob/3.12.0/core/include/initcall.h#L44",target:"_blank",rel:"noopener noreferrer"}},[t._v("driver_init_late"),a("OutboundLink")],1),t._v(" 定义的 "),a("code",[t._v(".scattered_array_initcall_1_5")]),t._v(" 和 "),a("code",[t._v(".scattered_array_initcall_1_6")]),t._v(" 段的基本如下：")]),t._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[t._v("root@cd8b134d882e:~/optee/builder/optee/optee_os/core"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v('# grep "driver_init(" -R .')]),t._v("\n./drivers/bnxt/bnxt.c:driver_init"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("bnxt_init"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n./drivers/crypto/caam/caam_ctrl.c:static TEE_Result crypto_driver_init"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("void"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n./drivers/crypto/se050/session.c:driver_init"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("se050_early_init"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n./drivers/stm32_bsec.c:driver_init"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("initialize_bsec"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n./drivers/dra7_rng.c:driver_init"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("dra7_rng_init"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n./drivers/bcm_sotp.c:driver_init"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("bcm_sotp_init"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n./drivers/bcm_gpio.c:driver_init"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("bcm_gpio_init"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n./drivers/imx_wdog.c:driver_init"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("imx_wdog_init"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n./drivers/stm32_rng.c:driver_init"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("stm32_rng_init"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n./drivers/bcm_hwrng.c:driver_init"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("bcm_hwrng_init"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n./drivers/hi16xx_rng.c:driver_init"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("hi16xx_rng_init"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n./arch/arm/plat-synquacer/main.c:driver_init"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("init_timer_itr"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n./arch/arm/plat-stm32mp1/drivers/stm32mp1_pmic.c:driver_init"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("initialize_pmic"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n./arch/arm/plat-stm32mp1/drivers/stm32mp1_syscfg.c:driver_init"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("stm32mp1_iocomp"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n./arch/arm/plat-stm32mp1/plat_tzc400.c:driver_init"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("init_stm32mp1_tzc"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n./arch/arm/plat-hikey/main.c:driver_init"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("peripherals_init"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n./arch/arm/plat-vexpress/main.c:driver_init"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("init_console_itr"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n./arch/arm/plat-sunxi/main.c:driver_init"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("smc_init"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n./arch/arm/plat-imx/drivers/tzc380.c:driver_init"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("imx_configure_tzasc"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n./arch/arm/plat-imx/drivers/imx_csu.c:driver_init"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("csu_init"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n./arch/arm/plat-imx/drivers/imx_scu.c:driver_init"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("scu_init"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n./arch/arm/plat-imx/drivers/imx_caam.c:driver_init"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("init_caam"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n./include/initcall.h:"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#define driver_init(fn)\t\t\t__define_initcall(init, 5, fn)")]),t._v("\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br"),a("span",{staticClass:"line-number"},[t._v("2")]),a("br"),a("span",{staticClass:"line-number"},[t._v("3")]),a("br"),a("span",{staticClass:"line-number"},[t._v("4")]),a("br"),a("span",{staticClass:"line-number"},[t._v("5")]),a("br"),a("span",{staticClass:"line-number"},[t._v("6")]),a("br"),a("span",{staticClass:"line-number"},[t._v("7")]),a("br"),a("span",{staticClass:"line-number"},[t._v("8")]),a("br"),a("span",{staticClass:"line-number"},[t._v("9")]),a("br"),a("span",{staticClass:"line-number"},[t._v("10")]),a("br"),a("span",{staticClass:"line-number"},[t._v("11")]),a("br"),a("span",{staticClass:"line-number"},[t._v("12")]),a("br"),a("span",{staticClass:"line-number"},[t._v("13")]),a("br"),a("span",{staticClass:"line-number"},[t._v("14")]),a("br"),a("span",{staticClass:"line-number"},[t._v("15")]),a("br"),a("span",{staticClass:"line-number"},[t._v("16")]),a("br"),a("span",{staticClass:"line-number"},[t._v("17")]),a("br"),a("span",{staticClass:"line-number"},[t._v("18")]),a("br"),a("span",{staticClass:"line-number"},[t._v("19")]),a("br"),a("span",{staticClass:"line-number"},[t._v("20")]),a("br"),a("span",{staticClass:"line-number"},[t._v("21")]),a("br"),a("span",{staticClass:"line-number"},[t._v("22")]),a("br"),a("span",{staticClass:"line-number"},[t._v("23")]),a("br"),a("span",{staticClass:"line-number"},[t._v("24")]),a("br")])]),a("p",[t._v("以 vexpress 平台为例，"),a("code",[t._v(".scattered_array_initcall_1_5")]),t._v("  段的代码会初始化控制台，而该操作是通过执行 "),a("a",{attrs:{href:"https://github.com/OP-TEE/optee_os/blob/3.12.0/core/arch/arm/plat-vexpress/main.c#L121",target:"_blank",rel:"noopener noreferrer"}},[t._v("init_console_itr"),a("OutboundLink")],1),t._v(" 函数实现。")]),t._v(" "),a("h2",{attrs:{id:"参考文献"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#参考文献"}},[t._v("#")]),t._v(" 参考文献")]),t._v(" "),a("ul",[a("li",[a("a",{attrs:{href:"https://icyshuai.blog.csdn.net/article/details/72638193",target:"_blank",rel:"noopener noreferrer"}},[t._v("OP-TEE OS启动（一）"),a("OutboundLink")],1)]),t._v(" "),a("li",[a("a",{attrs:{href:"https://blog.csdn.net/shuaifengyun/article/details/72638272",target:"_blank",rel:"noopener noreferrer"}},[t._v("OP-TEE OS启动（二）"),a("OutboundLink")],1)]),t._v(" "),a("li",[a("a",{attrs:{href:"https://icyshuai.blog.csdn.net/article/details/72655106",target:"_blank",rel:"noopener noreferrer"}},[t._v("OP-TEE OS启动（三）--service_init"),a("OutboundLink")],1)]),t._v(" "),a("li",[a("a",{attrs:{href:"https://icyshuai.blog.csdn.net/article/details/72657577",target:"_blank",rel:"noopener noreferrer"}},[t._v("OP-TEE OS启动（四）--service_init_late"),a("OutboundLink")],1)]),t._v(" "),a("li",[a("a",{attrs:{href:"https://icyshuai.blog.csdn.net/article/details/72663758",target:"_blank",rel:"noopener noreferrer"}},[t._v("OP-TEE OS启动（五）--driver_init和driver_init_late"),a("OutboundLink")],1)])])])}),[],!1,null,null,null);s.default=e.exports}}]);