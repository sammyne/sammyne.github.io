(window.webpackJsonp=window.webpackJsonp||[]).push([[43],{674:function(s,t,a){s.exports=a.p+"assets/img/tcp-header.978468e3.png"},796:function(s,t,a){"use strict";a.r(t);var e=a(6),n=Object(e.a)({},(function(){var s=this,t=s.$createElement,e=s._self._c||t;return e("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[e("div",{staticClass:"custom-block tip"},[e("p",{staticClass:"title"},[s._v("温馨提示")]),e("p",[s._v("本文从理论到实践，系统地介绍 iptables。如果你想要从头开始了解 iptables，可以查看 "),e("RouterLink",{attrs:{to:"/tag/iptables/"}},[s._v("iptables 系列文章")]),s._v("。")],1)]),e("div",{staticClass:"custom-block danger"},[e("p",{staticClass:"title"},[s._v("高能预警")]),e("p",[s._v("在进行 iptables 实验时，请务必在测试机上进行。本文的实验操作环境为 VMware Fusion 12.0 下的 Ubuntu 20.04.1。")])]),e("p",[e("RouterLink",{attrs:{to:"/2021/01/07/iptables-05-rules-summary-02/"}},[s._v("前文")]),s._v(" 总结了 tcp 扩展模块的 "),e("code",[s._v("--sport")]),s._v(" 与 "),e("code",[s._v("--dport")]),s._v(" 选项，并没有总结 "),e("code",[s._v("--tcp-flags")]),s._v(" 选项。本文讲解一下 tcp 扩展模块的 "),e("code",[s._v("--tcp-flags")]),s._v("。")],1),s._v(" "),e("div",{staticClass:"custom-block tip"},[e("p",{staticClass:"title"},[s._v("温馨提示")]),e("p",[s._v("阅读这篇文章之前，需要对 TCP 协议的基础知识有一定的了解，比如：TCP 头的结构、TCP 三次握手的过程。")])]),e("h2",{attrs:{id:"tcp-flags"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#tcp-flags"}},[s._v("#")]),s._v(" "),e("code",[s._v("--tcp-flags")])]),s._v(" "),e("p",[e("code",[s._v("--tcp-flags")]),s._v(" 指的是 TCP 头的标志位。使用 iptables 时，可通过此扩展匹配条件去匹配 TCP 报文头部的标识位，然后根据标识位的实际情况实现访问控制。")]),s._v(" "),e("p",[s._v("TCP 头的结构如下图")]),s._v(" "),e("p",[e("img",{attrs:{src:a(674),alt:"TCP 头部"}})]),s._v(" "),e("p",[s._v("iptables 使用 TCP 扩展模块的 "),e("code",[s._v("--tcp-flags")]),s._v(' 选项，即可对上图的标志位进行匹配，判断指定标志位的值是否为"1"。TCP 的头部结构不是本文讨论的重点，TCP 的标识位才是。TCP 协议建立连接的过程需要先进行三次握手，而三次握手依靠 TCP 头的标志位进行。')]),s._v(" "),e("p",[s._v("为了更加具象化地描述这个过程，可以抓包查看 ssh 建立连接的过程。其中，")]),s._v(" "),e("ul",[e("li",[s._v("服务端 IP 为 "),e("code",[s._v("192.168.44.1")])]),s._v(" "),e("li",[s._v("客户端 IP 为 "),e("code",[s._v("192.168.44.2")])]),s._v(" "),e("li",[s._v("两者连接的网卡为 "),e("code",[s._v("bridge100")])])]),s._v(" "),e("ol",[e("li",[s._v("Ubuntu 服务端安装并启动 openssh-server（如已安装，则跳过）")])]),s._v(" "),e("div",{staticClass:"language-bash line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[s._v("root@ubuntu:~"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# apt install openssh-server")]),s._v("\nroot@ubuntu:~"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# sudo /etc/init.d/ssh restart")]),s._v("\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br")])]),e("ol",[e("li",[s._v("客户端启动 tcpdump 监听和服务端连接的网卡和端口 22 的 TCP 流量")])]),s._v(" "),e("div",{staticClass:"language-bash line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[e("span",{pre:!0,attrs:{class:"token function"}},[s._v("sudo")]),s._v(" tcpdump -i bridge100 port "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("22")]),s._v("\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br")])]),e("ol",{attrs:{start:"3"}},[e("li",[s._v("客户端 ssh 请求连接到服务端")])]),s._v(" "),e("div",{staticClass:"language-bash line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[e("span",{pre:!0,attrs:{class:"token function"}},[s._v("ssh")]),s._v(" sammyne@192.168.44.2\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br")])]),e("p",[s._v("tcpdump 的第一条报文如下")]),s._v(" "),e("div",{staticClass:"language-bash line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[e("span",{pre:!0,attrs:{class:"token number"}},[s._v("13")]),s._v(":11:49.327356 IP "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),s._v(".44.1.57520 "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),s._v(".44.2.ssh: Flags "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("SEW"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(", "),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("seq")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("2064361474")]),s._v(", win "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("65535")]),s._v(", options "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("mss "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("1460")]),s._v(",nop,wscale "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("6")]),s._v(",nop,nop,TS val "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("1368263741")]),s._v(" ecr "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(",sackOK,eol"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(", length "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br")])]),e("p",[s._v("以上为 TCP 三次握手中的第一次握手，客户端使用本地的随机端口 57520 向服务端发起连接请求。由 "),e("code",[s._v("Flags")]),s._v(" 字段可知，TCP 头设置的标志位为 "),e("code",[s._v("SEW")]),s._v("（其余标识位没有设置）")]),s._v(" "),e("ul",[e("li",[e("code",[s._v("S")]),s._v(" 是 "),e("code",[s._v("SYN")]),s._v(" 的简写，表示新建连接")]),s._v(" "),e("li",[e("code",[s._v("E")]),s._v(" 是 "),e("code",[s._v("ECE")]),s._v(" 的简写，表示 TCP 客户端三次握手过程能够进行 ECN")]),s._v(" "),e("li",[e("code",[s._v("W")]),s._v(" 是 "),e("code",[s._v("CWR")]),s._v("（Congestion Window Reduced） 的简写，表示客户端收到设置了 ECE 标识位的 TCP 端")])]),s._v(" "),e("p",[s._v("第二次握手的报文如下：服务端回应刚才的请求，将自己 TCP 头的 "),e("code",[s._v("S.E")]),s._v(" 标志位（分别对应 "),e("code",[s._v("SYN")]),s._v("、"),e("code",[s._v("ACK")]),s._v(" 和 "),e("code",[s._v("ECE")]),s._v("）都设置为 1。")]),s._v(" "),e("div",{staticClass:"language-bash line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[e("span",{pre:!0,attrs:{class:"token number"}},[s._v("13")]),s._v(":11:49.328094 IP "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),s._v(".44.2.ssh "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),s._v(".44.1.57520: Flags "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("S.E"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(", "),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("seq")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("2079983446")]),s._v(", ack "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("2064361475")]),s._v(", win "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("65160")]),s._v(", options "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("mss "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("1460")]),s._v(",sackOK,TS val "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("4283489136")]),s._v(" ecr "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("1368263741")]),s._v(",nop,wscale "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("7")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(", length "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br")])]),e("p",[s._v("第三次握手的报文如下")]),s._v(" "),e("div",{staticClass:"language-bash line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[e("span",{pre:!0,attrs:{class:"token number"}},[s._v("13")]),s._v(":11:49.328176 IP "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),s._v(".44.1.57520 "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),s._v(".44.2.ssh: Flags "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("."),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(", ack "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(", win "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("2058")]),s._v(", options "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("nop,nop,TS val "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("1368263741")]),s._v(" ecr "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("4283489136")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(", length "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br")])]),e("p",[s._v("说到这里就已经能够引出接下来的话题了 -- "),e("code",[s._v("--tcp-flags")]),s._v(' 选项。假设现在想要拒绝上文提到的"第一次握手"的报文，在服务端执行以下命令：')]),s._v(" "),e("div",{staticClass:"language-bash line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[s._v("root@ubuntu:~"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# iptables -F INPUT")]),s._v("\nroot@ubuntu:~"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# iptables -t filter -I INPUT -p tcp -m tcp --dport 22 --tcp-flags SYN,ACK,FIN,RST,URG,PSH SYN -j REJECT")]),s._v("\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br")])]),e("p",[s._v("客户端再次发起 ssh 连接请求就会发现连接被拒绝的错误。")]),s._v(" "),e("div",{staticClass:"language-bash line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[e("span",{pre:!0,attrs:{class:"token function"}},[s._v("ssh")]),s._v(" sammyne@192.168.44.2\nssh: connect to "),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("host")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),s._v(".44.2 port "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("22")]),s._v(": Connection refused\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br")])]),e("p",[s._v("相关选项说明如下")]),s._v(" "),e("ul",[e("li",[e("code",[s._v("-m tcp --dport 22")]),s._v(" 的含义在 "),e("RouterLink",{attrs:{to:"/2021/01/07/iptables-05-rules-summary-02/"}},[s._v("前文")]),s._v(" 已经总结过：表示使用 tcp 扩展模块，指定目标端口为 22 号端口(ssh 默认端口)")],1),s._v(" "),e("li",[e("code",[s._v("--tcp-flags")]),s._v(" 是重点讨论的扩展匹配条件，用于匹配报文 TCP 头部的标志位\n"),e("ul",[e("li",[e("code",[s._v("SYN,ACK,FIN,RST,URG,PSH SYN")]),s._v(" 这串字符就是用于配置要匹配的标志位，可以拆成为两部分理解\n"),e("ul",[e("li",[e("code",[s._v("SYN,ACK,FIN,RST,URG,PSH")]),s._v("：需要匹配报文 TCP 头的哪些标志位。上述配置表示匹配报文 TCP 头的 6 个标志位 -- "),e("code",[s._v("SYN")]),s._v("、"),e("code",[s._v("ACK")]),s._v("、"),e("code",[s._v("FIN")]),s._v("、"),e("code",[s._v("RST")]),s._v("、"),e("code",[s._v("URG")]),s._v(" 和 "),e("code",[s._v("PSH")]),s._v("，可以把这一部分理解成需要匹配的标志位列表")]),s._v(" "),e("li",[e("code",[s._v("SYN")]),s._v("：标记第一部分的标志位列表中哪些标志位必须为 1。当前场景的第二部分为 "),e("code",[s._v("SYN")]),s._v(" 表示第一部分需要匹配的标志位列表中 "),e("code",[s._v("SYN")]),s._v(" 标志位的值必须为 1，其他标志位必须为 0")])])]),s._v(" "),e("li",[s._v("因此，"),e("code",[s._v("SYN,ACK,FIN,RST,URG,PSH SYN")]),s._v(" 表示需要匹配报文 TCP 头的 "),e("code",[s._v("SYN")]),s._v("、"),e("code",[s._v("ACK")]),s._v("、"),e("code",[s._v("FIN")]),s._v("、"),e("code",[s._v("RST")]),s._v("、"),e("code",[s._v("URG")]),s._v(" 和 "),e("code",[s._v("PSH")]),s._v(" 这些标志位，其中 "),e("code",[s._v("SYN")]),s._v(" 标志位必须为 1，其他 5 个标志位必须为 0。")]),s._v(" "),e("li",[s._v("这与前面 tcpdump 抓包的情形相同，正是 TCP 三次握手时第一次握手的情况。第一次握手的报文 TCP 头的标志位如下："),e("div",{staticClass:"language-bash line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[s._v("Flags "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("SEW"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br")])])])])])]),s._v(" "),e("p",[e("code",[s._v("--tcp-flags")]),s._v(" 的表示方法与 tcpdump 的表示方法有异曲同工之妙。只不过，tcpdump 只把标志位为 1 的标识位的字母简写放到在 "),e("code",[s._v("Flags")]),s._v(" 列表。"),e("code",[s._v("--tcp-flags")]),s._v(" 需要先指明匹配哪些标志位，然后再指明其中哪些必须为 1，剩余都必须为 0。")]),s._v(" "),e("p",[s._v("依此类推，匹配 TCP 头第二次握手的标志位可借助以下命令（此处省略对源地址与目标地址的匹配，重点在于对 "),e("code",[s._v("tcp-flags")]),s._v(" 的示例）")]),s._v(" "),e("div",{staticClass:"language-bash line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[s._v("root@ubuntu:~"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# iptables -t filter -I INPUT -p tcp -m tcp --sport 22 --tcp-flags SYN,ACK,FIN,RST,URG,PSH, SYN,ACK -j REJECT")]),s._v("\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br")])]),e("p",[s._v("综上所述，灵活地配置标志位即可匹配到更多应用场景。")]),s._v(" "),e("p",[s._v("上述两条命令还可以简写为如下模样")]),s._v(" "),e("div",{staticClass:"language-bash line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[s._v("root@ubuntu:~"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# iptables -t filter -I INPUT -p tcp -m tcp --dport 22 --tcp-flags ALL SYN -j REJECT")]),s._v("\nroot@ubuntu:~"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# iptables -t filter -I OUTPUT -p tcp -m tcp --sport 22 --tcp-flags ALL SYN,ACK -j REJECT")]),s._v("\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br")])]),e("p",[s._v("可以用 "),e("code",[s._v("ALL")]),s._v(" 表示 "),e("code",[s._v("SYN,ACK,FIN,RST,URG,PSH")]),s._v("。")]),s._v(" "),e("p",[s._v("tcp 扩展模块还专门提供一个选项--"),e("code",[s._v("--syn")]),s._v('，用于匹配前面提到的"第一次握手"。')]),s._v(" "),e("p",[s._v("使用 "),e("code",[s._v("--syn")]),s._v(" 选项相当于使用 "),e("code",[s._v("--tcp-flags SYN,RST,ACK,FIN SYN")]),s._v("。也就是说，使用 "),e("code",[s._v("--syn")]),s._v(" 选项去匹配 TCP 新建连接的请求报文命令如下")]),s._v(" "),e("div",{staticClass:"language-bash line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[s._v("root@ubuntu:~"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# iptables -F INPUT")]),s._v("\nroot@ubuntu:~"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# iptables -t filter -I INPUT -p tcp -m tcp --dport 22 --syn -j REJECT")]),s._v("\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br")])]),e("h2",{attrs:{id:"小结"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#小结"}},[s._v("#")]),s._v(" 小结")]),s._v(" "),e("p",[s._v("结合之前的文章，tcp 模块的常用扩展匹配条件再次总结如下，以便于以后速查。")]),s._v(" "),e("h3",{attrs:{id:"sport"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#sport"}},[s._v("#")]),s._v(" "),e("code",[s._v("--sport")])]),s._v(" "),e("p",[s._v("用于匹配 tcp 协议报文的源端口，可以使用冒号指定一个连续的端口范围")]),s._v(" "),e("div",{staticClass:"language-bash line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#示例")]),s._v("\niptables -t filter -I OUTPUT -d "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),s._v(".1.146 -p tcp -m tcp --sport "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("22")]),s._v(" -j REJECT\niptables -t filter -I OUTPUT -d "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),s._v(".1.146 -p tcp -m tcp --sport "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("22")]),s._v(":25 -j REJECT\niptables -t filter -I OUTPUT -d "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),s._v(".1.146 -p tcp -m tcp "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("!")]),s._v(" --sport "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("22")]),s._v(" -j ACCEPT\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br")])]),e("h3",{attrs:{id:"dport"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#dport"}},[s._v("#")]),s._v(" "),e("code",[s._v("--dport")])]),s._v(" "),e("p",[s._v("用于匹配 tcp 协议报文的目标端口，可以使用冒号指定一个连续的端口范围")]),s._v(" "),e("div",{staticClass:"language-bash line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#示例")]),s._v("\niptables -t filter -I INPUT -s "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),s._v(".1.146 -p tcp -m tcp --dport "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("22")]),s._v(":25 -j REJECT\niptables -t filter -I INPUT -s "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),s._v(".1.146 -p tcp -m tcp --dport :22 -j REJECT\niptables -t filter -I INPUT -s "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),s._v(".1.146 -p tcp -m tcp --dport "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("80")]),s._v(": -j REJECT\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br")])]),e("h3",{attrs:{id:"tcp-flags-2"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#tcp-flags-2"}},[s._v("#")]),s._v(" "),e("code",[s._v("--tcp-flags")])]),s._v(" "),e("p",[s._v("用于匹配报文的 TCP 头的标志位")]),s._v(" "),e("div",{staticClass:"language-bash line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#示例")]),s._v("\niptables -t filter -I INPUT -p tcp -m tcp --dport "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("22")]),s._v(" --tcp-flags SYN,ACK,FIN,RST,URG,PSH SYN -j REJECT\niptables -t filter -I OUTPUT -p tcp -m tcp --sport "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("22")]),s._v(" --tcp-flags SYN,ACK,FIN,RST,URG,PSH SYN,ACK -j REJECT\niptables -t filter -I INPUT -p tcp -m tcp --dport "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("22")]),s._v(" --tcp-flags ALL SYN -j REJECT\niptables -t filter -I OUTPUT -p tcp -m tcp --sport "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("22")]),s._v(" --tcp-flags ALL SYN,ACK -j REJECT\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br")])]),e("h3",{attrs:{id:"syn"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#syn"}},[s._v("#")]),s._v(" "),e("code",[s._v("--syn")])]),s._v(" "),e("p",[s._v("用于匹配 tcp 新建连接的请求报文，相当于使用 "),e("code",[s._v("--tcp-flags SYN,RST,ACK,FIN SYN")]),s._v("。")]),s._v(" "),e("h2",{attrs:{id:"参考文献"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#参考文献"}},[s._v("#")]),s._v(" 参考文献")]),s._v(" "),e("ul",[e("li",[e("a",{attrs:{href:"http://www.zsythink.net/archives/1578",target:"_blank",rel:"noopener noreferrer"}},[s._v("iptables 详解（6）：iptables 扩展匹配条件之’–tcp-flags’"),e("OutboundLink")],1)])])])}),[],!1,null,null,null);t.default=n.exports}}]);