(window.webpackJsonp=window.webpackJsonp||[]).push([[62],{763:function(s,a,t){"use strict";t.r(a);var e=t(6),n=Object(e.a)({},(function(){var s=this,a=s.$createElement,t=s._self._c||a;return t("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[t("div",{staticClass:"custom-block tip"},[t("p",{staticClass:"title"},[s._v("温馨提示")]),t("p",[s._v("本文从理论到实践，系统地介绍 iptables。如果你想要从头开始了解 iptables，可以查看 "),t("RouterLink",{attrs:{to:"/tag/iptables/"}},[s._v("iptables 系列文章")]),s._v("。")],1)]),t("div",{staticClass:"custom-block danger"},[t("p",{staticClass:"title"},[s._v("高能预警")]),t("p",[s._v("在参照本文进行 iptables 实验时，请务必在个人的测试机进行。iptables 规则设置不当有可能使你无法连接到远程主机。本文的实验操作环境为 VMware Fusion Player 12.0 下的 Ubuntu 20.04.1。")])]),t("p",[s._v("前面的文章一直在介绍 iptables 的匹配条件，并没有对动作进行过总结。本文总结一下 iptables 的动作。")]),s._v(" "),t("p",[s._v("之前的举例已经用到了一些常用动作，比如 "),t("code",[s._v("ACCEPT")]),s._v("、"),t("code",[s._v("DROP")]),s._v(" 和"),t("code",[s._v("REJECT")]),s._v(" 等。")]),s._v(" "),t("p",[s._v('"动作"与"匹配条件"一样，也有"基础"与"扩展"之分。')]),s._v(" "),t("p",[s._v("使用扩展动作也需要借助扩展模块，但是扩展动作可以 "),t("strong",[s._v("直接使用")]),s._v('，不用像使用"扩展匹配条件"那样需要指定模块。')]),s._v(" "),t("p",[s._v("之前用到的 "),t("code",[s._v("ACCEPT")]),s._v(" 与 "),t("code",[s._v("DROP")]),s._v(" 都属于基础动作。"),t("code",[s._v("REJECT")]),s._v(" 则属于扩展动作。")]),s._v(" "),t("p",[s._v("很多例子告诉我们使用 "),t("code",[s._v("-j")]),s._v(" 可以指定动作，比如")]),s._v(" "),t("div",{staticClass:"language-bash line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[s._v("-j ACCEPT\n\n-j DROP\n\n-j REJECT\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br")])]),t("p",[s._v('"动作"也有自己的选项。可以在使用动作时，设置对应的选项。此处以 '),t("code",[s._v("REJECT")]),s._v(' 为例，展开与"动作"有关的话题。')]),s._v(" "),t("h2",{attrs:{id:"动作-reject"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#动作-reject"}},[s._v("#")]),s._v(" 动作 "),t("code",[s._v("REJECT")])]),s._v(" "),t("p",[t("code",[s._v("REJECT")]),s._v(" 动作的常用选项为 "),t("code",[s._v("--reject-with")]),s._v("。这个选项可以设置拒绝对方时反馈的提示信息。")]),s._v(" "),t("p",[s._v("可用值如下")]),s._v(" "),t("ul",[t("li",[t("code",[s._v("icmp-net-unreachable")])]),s._v(" "),t("li",[t("code",[s._v("icmp-host-unreachable")])]),s._v(" "),t("li",[t("code",[s._v("icmp-port-unreachable")])]),s._v(" "),t("li",[t("code",[s._v("icmp-proto-unreachable")])]),s._v(" "),t("li",[t("code",[s._v("icmp-net-prohibited")])]),s._v(" "),t("li",[t("code",[s._v("icmp-host-prohibited")])]),s._v(" "),t("li",[t("code",[s._v("icmp-admin-prohibited")])])]),s._v(" "),t("p",[s._v("当不设置任何值时，默认值为 "),t("code",[s._v("icmp-port-unreachable")]),s._v("。")]),s._v(" "),t("p",[s._v("我们来动手实践一下，为主机 "),t("code",[s._v("192.168.44.2")]),s._v(" 设置规则如下")]),s._v(" "),t("div",{staticClass:"language-bash line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[s._v("root@ubuntu:~"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# iptables -F")]),s._v("\nroot@ubuntu:~"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# iptables -I INPUT -p tcp --dport 22 -j ACCEPT")]),s._v("\nroot@ubuntu:~"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# iptables -A INPUT -j REJECT")]),s._v("\nroot@ubuntu:~"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# iptables -L INPUT")]),s._v("\nChain INPUT "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("policy ACCEPT"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\ntarget     prot opt "),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("source")]),s._v("               destination         \nACCEPT     tcp  --  anywhere             anywhere             tcp dpt:ssh\nREJECT     all  --  anywhere             anywhere             reject-with icmp-port-unreachable\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br")])]),t("p",[s._v("此时在另一台主机向主机 139 发起 "),t("code",[s._v("ping")]),s._v(" 请求。如下所示，提示目标端口不可达。")]),s._v(" "),t("div",{staticClass:"language-bash line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[t("span",{pre:!0,attrs:{class:"token function"}},[s._v("ping")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),s._v(".44.2\nPING "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),s._v(".44.2 "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),s._v(".44.2"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(": "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("56")]),s._v(" data bytes\n"),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("92")]),s._v(" bytes from "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),s._v(".44.2: Destination Port Unreachable\nVr HL TOS  Len   ID Flg  off TTL Pro  cks      Src      Dst\n "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("4")]),s._v("  "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("5")]),s._v("  00 "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("5400")]),s._v(" c1bb   "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" 0000  "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("40")]),s._v("  01 df99 "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),s._v(".44.1  "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),s._v(".44.2 \n\nRequest "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("timeout")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("for")]),s._v(" icmp_seq "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("92")]),s._v(" bytes from "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),s._v(".44.2: Destination Port Unreachable\nVr HL TOS  Len   ID Flg  off TTL Pro  cks      Src      Dst\n "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("4")]),s._v("  "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("5")]),s._v("  00 "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("5400")]),s._v(" 90b7   "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" 0000  "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("40")]),s._v("  01 109e "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),s._v(".44.1  "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),s._v(".44.2 \n\n^C\n--- "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),s._v(".44.2 "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("ping")]),s._v(" statistics ---\n"),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v(" packets transmitted, "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" packets received, "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("100.0")]),s._v("% packet loss\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br")])]),t("p",[s._v('再试试将拒绝报文的提示设置为"主机不可达"如下')]),s._v(" "),t("div",{staticClass:"language-bash line-numbers-mode"},[t("div",{staticClass:"highlight-lines"},[t("br"),t("br"),t("br"),t("br"),t("br"),t("div",{staticClass:"highlighted"},[s._v(" ")]),t("br"),t("br"),t("br"),t("br"),t("br"),t("br"),t("br")]),t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[s._v("root@ubuntu:~"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# iptables -L INPUT")]),s._v("\nChain INPUT "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("policy ACCEPT"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\ntarget     prot opt "),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("source")]),s._v("               destination         \nACCEPT     tcp  --  anywhere             anywhere             tcp dpt:ssh\nREJECT     all  --  anywhere             anywhere             reject-with icmp-port-unreachable\nroot@ubuntu:~"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# iptables -I INPUT 2 -j REJECT --reject-with icmp-host-unreachable")]),s._v("\nroot@ubuntu:~"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# iptables -L INPUT")]),s._v("\nChain INPUT "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("policy ACCEPT"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\ntarget     prot opt "),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("source")]),s._v("               destination         \nACCEPT     tcp  --  anywhere             anywhere             tcp dpt:ssh\nREJECT     all  --  anywhere             anywhere             reject-with icmp-host-unreachable\nREJECT     all  --  anywhere             anywhere             reject-with icmp-port-unreachable\n")])]),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br")])]),t("p",[s._v("如上所示，在设置拒绝的动作时，使用 "),t("code",[s._v("--reject-with")]),s._v(" 选项将提示信息设置为 "),t("code",[s._v("icmp-host-unreachable")]),s._v("。完成上述操作后，再次在在另一台主机上向主机 "),t("code",[s._v("192.168.44.2")]),s._v(" 发起 "),t("code",[s._v("ping")]),s._v(" 请求如下")]),s._v(" "),t("div",{staticClass:"language-bash line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[t("span",{pre:!0,attrs:{class:"token function"}},[s._v("ping")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),s._v(".44.2\nPING "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),s._v(".44.2 "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),s._v(".44.2"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(": "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("56")]),s._v(" data bytes\n"),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("92")]),s._v(" bytes from "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),s._v(".44.2: Destination Host Unreachable\nVr HL TOS  Len   ID Flg  off TTL Pro  cks      Src      Dst\n "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("4")]),s._v("  "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("5")]),s._v("  00 "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("5400")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("4740")]),s._v("   "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" 0000  "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("40")]),s._v("  01 5a15 "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),s._v(".44.1  "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),s._v(".44.2 \n\nRequest "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("timeout")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("for")]),s._v(" icmp_seq "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("92")]),s._v(" bytes from "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),s._v(".44.2: Destination Host Unreachable\nVr HL TOS  Len   ID Flg  off TTL Pro  cks      Src      Dst\n "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("4")]),s._v("  "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("5")]),s._v("  00 "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("5400")]),s._v(" bcbf   "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" 0000  "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("40")]),s._v("  01 e495 "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),s._v(".44.1  "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),s._v(".44.2 \n\n^C\n--- "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),s._v(".44.2 "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("ping")]),s._v(" statistics ---\n"),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v(" packets transmitted, "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" packets received, "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("100.0")]),s._v("% packet loss\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br")])]),t("p",[s._v("可以看到，"),t("code",[s._v("ping")]),s._v(' 请求被拒绝时，提示信息已经从"目标端口不可达"变成了"目标主机不可达"。')]),s._v(" "),t("h2",{attrs:{id:"动作-log"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#动作-log"}},[s._v("#")]),s._v(" 动作 "),t("code",[s._v("LOG")])]),s._v(" "),t("p",[s._v("接下来介绍之前没有提及过的 "),t("code",[s._v("LOG")]),s._v(" 动作。")]),s._v(" "),t("p",[s._v("使用 "),t("code",[s._v("LOG")]),s._v(' 动作，可以将符合条件的报文相关信息记录到日志，但当前报文具体是被"接受"，还是被"拒绝"，都由后面的规则控制。换句话说，'),t("code",[s._v("LOG")]),s._v(" 动作只负责记录匹配到的报文相关信息，不负责对报文的其他处理。如果想要对报文进行进一步处理，可以在之后设置具体规则。")]),s._v(" "),t("p",[s._v("下例表示将发往 22 号端口的报文相关信息记录到日志。")]),s._v(" "),t("div",{staticClass:"language-bash line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[s._v("root@ubuntu:~"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# iptables -F INPUT")]),s._v("\nroot@ubuntu:~"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v('# iptables -I INPUT -p tcp --dport 22 -j LOG --log-prefix "[sammyne]"')]),s._v("\nroot@ubuntu:~"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# iptables -l INPUT")]),s._v("\niptables v1.8.4 "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("legacy"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(": unknown option "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"-l"')]),s._v("\nTry `iptables -h"),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("' or '")]),s._v("iptables --help' "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("for")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("more")]),s._v(" information.\nroot@ubuntu:~"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# iptables -L INPUT")]),s._v("\nChain INPUT "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("policy ACCEPT"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\ntarget     prot opt "),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("source")]),s._v("               destination         \nLOG        tcp  --  anywhere             anywhere             tcp dpt:ssh LOG level warning prefix "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"[sammyne]"')]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br")])]),t("p",[s._v("上述规则表示所有发往 22 号端口的 TCP 报文都符合条件，所以都会被记录到日志。查看 "),t("code",[s._v("/var/log/kern.log")]),s._v(" 即可看到对应报文的相关信息。")]),s._v(" "),t("div",{staticClass:"language-bash line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[s._v("root@ubuntu:~"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v('# tail -f /var/log/kern.log | grep "\\[sammyne\\]"')]),s._v("\nJan  "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("9")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("15")]),s._v(":15:31 ubuntu kernel: "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1662.505100")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("sammyne"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("IN"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("ens33 "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("OUT")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("MAC")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("00:0c:29:61:9c:a1:8a:e9:fe:35:ee:64:08:00 "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("SRC")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),s._v(".44.1 "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("DST")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),s._v(".44.2 "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("LEN")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("64")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("TOS")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("0x00 "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("PREC")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("0x00 "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("TTL")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("64")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("ID")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("PROTO")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("TCP "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("SPT")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("56040")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("DPT")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("22")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("WINDOW")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("65535")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("RES")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("0x00 CWR ECE SYN "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("URGP")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" \nJan  "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("9")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("15")]),s._v(":15:31 ubuntu kernel: "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1662.505857")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("sammyne"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("IN"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("ens33 "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("OUT")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("MAC")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("00:0c:29:61:9c:a1:8a:e9:fe:35:ee:64:08:00 "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("SRC")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),s._v(".44.1 "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("DST")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),s._v(".44.2 "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("LEN")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("52")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("TOS")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("0x00 "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("PREC")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("0x00 "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("TTL")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("64")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("ID")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("PROTO")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("TCP "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("SPT")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("56040")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("DPT")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("22")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("WINDOW")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("2058")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("RES")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("0x00 ACK "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("URGP")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" \nJan  "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("9")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("15")]),s._v(":15:31 ubuntu kernel: "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1662.509127")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("sammyne"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("IN"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("ens33 "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("OUT")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("MAC")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("00:0c:29:61:9c:a1:8a:e9:fe:35:ee:64:08:00 "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("SRC")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),s._v(".44.1 "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("DST")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),s._v(".44.2 "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("LEN")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("73")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("TOS")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("0x02 "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("PREC")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("0x00 "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("TTL")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("64")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("ID")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("PROTO")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("TCP "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("SPT")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("56040")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("DPT")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("22")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("WINDOW")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("2058")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("RES")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("0x00 ACK PSH "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("URGP")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" \nJan  "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("9")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("15")]),s._v(":15:31 ubuntu kernel: "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1662.516111")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("sammyne"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("IN"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("ens33 "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("OUT")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("MAC")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("00:0c:29:61:9c:a1:8a:e9:fe:35:ee:64:08:00 "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("SRC")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),s._v(".44.1 "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("DST")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),s._v(".44.2 "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("LEN")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("52")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("TOS")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("0x00 "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("PREC")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("0x00 "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("TTL")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("64")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("ID")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("PROTO")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("TCP "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("SPT")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("56040")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("DPT")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("22")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("WINDOW")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("2058")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("RES")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("0x00 ACK "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("URGP")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br")])]),t("p",[s._v("但是上述规则只是用于示例。因为使用的匹配条件过于宽泛，所以匹配到的报文数量将会非常之多，记录到的信息也不利于分析，所以使用 "),t("code",[s._v("LOG")]),s._v(" 动作时，匹配条件应该尽量写得精确一些，匹配到的报文数量也会大幅度减少，从而冗余信息也会变少，日后分析日志时，日志的信息可用程度更高。")]),s._v(" "),t("blockquote",[t("p",[s._v("注：请把刚才用于示例的规则删除。")])]),s._v(" "),t("p",[s._v("示例告诉我们 "),t("code",[s._v("LOG")]),s._v(" 动作会将报文的相关信息记录在 "),t("code",[s._v("/var/log/kern.log")]),s._v(" 文件。当然也可以将相关信息记录到指定的文件，以防止 iptables 的相关信息与其他日志信息相混淆。修改 "),t("code",[s._v("/etc/rsyslog.conf")]),s._v(" 文件（或者 "),t("code",[s._v("/etc/syslog.conf")]),s._v("），在 "),t("code",[s._v("rsyslog")]),s._v(" 配置文件中添加如下配置即可。")]),s._v(" "),t("div",{staticClass:"language-bash line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[s._v("root@ubuntu:~"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v('# echo "kern.warning /var/log/iptables.log" >> /etc/rsyslog.conf ')]),s._v("\nroot@ubuntu:~"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# tail -n1 /etc/rsyslog.conf ")]),s._v("\nkern.warning /var/log/iptables.log\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br")])]),t("p",[s._v("加入上述配置后，报文的相关信息将会被记录到 "),t("code",[s._v("/var/log/iptables.log")]),s._v(" 文件。")]),s._v(" "),t("p",[s._v("完成上述配置后，重启 rsyslog 服务（或者 syslogd）。")]),s._v(" "),t("div",{staticClass:"language-bash line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#service rsyslog restart")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("p",[s._v("服务重启后，配置即可生效，匹配到的报文相关信息将被记录到指定的文件。")]),s._v(" "),t("p",[t("code",[s._v("LOG")]),s._v(" 动作也有自己的选项，常用选项如下（先列出概念，后面有示例）")]),s._v(" "),t("ul",[t("li",[t("code",[s._v("--log-level")]),s._v(" 选项指定记录日志的级别，可用级别有\n"),t("ul",[t("li",[s._v("emerg")]),s._v(" "),t("li",[s._v("alert")]),s._v(" "),t("li",[s._v("crit")]),s._v(" "),t("li",[s._v("error")]),s._v(" "),t("li",[s._v("warning")]),s._v(" "),t("li",[s._v("notice")]),s._v(" "),t("li",[s._v("info")]),s._v(" "),t("li",[s._v("debug")])])]),s._v(" "),t("li",[t("code",[s._v("--log-prefix")]),s._v(' 选项可以给记录到的相关信息添加"标签"之类的信息，以便区分信息，便于分析时进行过滤。')])]),s._v(" "),t("div",{staticClass:"custom-block warning"},[t("p",{staticClass:"title"},[s._v("注意")]),t("p",[t("code",[s._v("--log-prefix")]),s._v(" 对应的值不能超过 29 个字符。")])]),t("p",[s._v("比如，我想要将主动连接 22 号端口的报文相关信息都记录到日志，并且把这类记录命名为 "),t("code",[s._v("want-in-from-port-22")]),s._v("，可以使用如下命令")]),s._v(" "),t("div",{staticClass:"language-bash line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[s._v("root@ubuntu:~"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# iptables -F")]),s._v("\nroot@ubuntu:~"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v('# iptables -I INPUT -p tcp --dport 22 -m state NEW -j LOG --log-prefix "want-in-from-port-22"')]),s._v("\nBad argument "),t("span",{pre:!0,attrs:{class:"token variable"}},[t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("`")]),s._v("NEW'\nTry "),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("`")])]),s._v("iptables -h"),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("' or '")]),s._v("iptables --help' "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("for")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("more")]),s._v(" information.\nroot@ubuntu:~"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v('# iptables -I INPUT -p tcp --dport 22 -m state --state NEW -j LOG --log-prefix "want-in-from-port-22"')]),s._v("\nroot@ubuntu:~"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# iptables -L INPUT")]),s._v("\nChain INPUT "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("policy ACCEPT"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\ntarget     prot opt "),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("source")]),s._v("               destination         \nLOG        tcp  --  anywhere             anywhere             tcp dpt:ssh state NEW LOG level warning prefix "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"want-in-from-port-22"')]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br")])]),t("p",[s._v("完成上述配置后，在 IP 地址为 "),t("code",[s._v("192.168.1.98")]),s._v(" 的客户端机尝试使用 ssh 工具连接以上主机，然后查看对应的日志文件（已经将日志文件设置为 "),t("code",[s._v("/var/log/iptables.log")]),s._v("）。")]),s._v(" "),t("div",{staticClass:"language-bash line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[s._v("root@ubuntu:~"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# cat /var/log/iptables.log ")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# ...")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 省略之前的日志")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# ...")]),s._v("\nJan  "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("9")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("15")]),s._v(":34:05 ubuntu kernel: "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("2777.122815")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" want-in-from-port-22IN"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("ens33 "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("OUT")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("MAC")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("00:0c:29:61:9c:a1:8a:e9:fe:35:ee:64:08:00 "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("SRC")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),s._v(".44.1 "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("DST")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),s._v(".44.2 "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("LEN")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("52")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("TOS")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("0x00 "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("PREC")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("0x00 "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("TTL")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("64")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("ID")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("PROTO")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("TCP "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("SPT")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("56840")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("DPT")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("22")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("WINDOW")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("2048")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("RES")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("0x00 ACK "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("URGP")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" \nJan  "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("9")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("15")]),s._v(":34:25 ubuntu kernel: "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("2797.075648")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" want-in-from-port-22IN"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("ens33 "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("OUT")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("MAC")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("00:0c:29:61:9c:a1:8a:e9:fe:35:ee:64:08:00 "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("SRC")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),s._v(".44.1 "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("DST")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),s._v(".44.2 "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("LEN")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("64")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("TOS")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("0x00 "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("PREC")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("0x00 "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("TTL")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("64")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("ID")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("PROTO")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("TCP "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("SPT")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("57061")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("DPT")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("22")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("WINDOW")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("65535")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("RES")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("0x00 CWR ECE SYN "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("URGP")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br")])]),t("p",[s._v('如上所示，ssh 连接操作的报文相关信息已经被记录到 iptables.log 文件，而且这条日志包含"标签" '),t("code",[s._v("want-in-from-port-22")]),s._v('。如果有很多日志记录，我们就能通过这个"标签"进行筛选从而加快日志查看。同时从上述记录还能够得知报文的源 IP 与目标 IP、源端口与目标端口等信息：'),t("code",[s._v("192.168.44.1")]),s._v(" 这个 IP 想要在 15:34 连接到 "),t("code",[s._v("192.168.44.2")]),s._v("（当前主机的 IP）的 22 号端口，报文由 MAC 地址为 "),t("code",[s._v("00:0c:29:61:9c:a1")]),s._v(" 的 ens33 网卡进入，客户端网卡的 MAC 地址为 "),t("code",[s._v("8a:e9:fe:35:ee:64:08:00")]),s._v("。")]),s._v(" "),t("p",[s._v("除了 "),t("code",[s._v("ACCEPT")]),s._v("、"),t("code",[s._v("DROP")]),s._v("、"),t("code",[s._v("REJECT")]),s._v(" 和 "),t("code",[s._v("LOG")]),s._v(" 等动作，还有一些其他的常用动作，比如 "),t("code",[s._v("DNAT")]),s._v(" 和 "),t("code",[s._v("SNAT")]),s._v(" 等。之后的文章会对它们进行总结。")]),s._v(" "),t("h2",{attrs:{id:"参考文献"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#参考文献"}},[s._v("#")]),s._v(" 参考文献")]),s._v(" "),t("ul",[t("li",[t("a",{attrs:{href:"http://www.zsythink.net/archives/1684",target:"_blank",rel:"noopener noreferrer"}},[s._v("iptables详解（12）：iptables动作总结之一"),t("OutboundLink")],1)])])])}),[],!1,null,null,null);a.default=n.exports}}]);