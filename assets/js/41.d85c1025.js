(window.webpackJsonp=window.webpackJsonp||[]).push([[41],{673:function(s,t,a){s.exports=a.p+"assets/img/packets-flow.472c1e6b.png"},791:function(s,t,a){"use strict";a.r(t);var e=a(6),n=Object(e.a)({},(function(){var s=this,t=s.$createElement,e=s._self._c||t;return e("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[e("div",{staticClass:"custom-block tip"},[e("p",{staticClass:"title"},[s._v("温馨提示")]),e("p",[s._v("本文从理论到实践，系统地介绍 iptables。如果你想要从头开始了解 iptables，可以查看 "),e("RouterLink",{attrs:{to:"/tag/iptables/"}},[s._v("iptables 系列文章")]),s._v("。")],1)]),e("p",[s._v('经过前文的总结，我们已经能够熟练地管理规则，但是使用过的"匹配条件"少得可怜。之前的示例只使用过一种匹配条件，就是将"源地址"作为匹配条件。')]),s._v(" "),e("p",[s._v("本文学习一下更多匹配条件及其更多用法。")]),s._v(" "),e("div",{staticClass:"custom-block danger"},[e("p",{staticClass:"title"},[s._v("高能预警")]),e("p",[s._v("在参照本文进行 iptables 实验时，请务必在个人的测试机上进行，因为如果 iptables 规则设置不当，有可能使你无法连接到远程主机。")])]),e("h2",{attrs:{id:"匹配条件的更多用法"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#匹配条件的更多用法"}},[s._v("#")]),s._v(" 匹配条件的更多用法")]),s._v(" "),e("p",[s._v('还是从最常用的"源地址"说起。我们知道：以 '),e("code",[s._v("-s")]),s._v(" 选项作为匹配条件可以匹配报文的源地址。但是之前的示例每次指定的源地址都只是单个 IP，示例如下")]),s._v(" "),e("div",{staticClass:"language-bash line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[s._v("root@ubuntu:/home/sammy"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# iptables -I INPUT -s 172.16.39.1 -j DROP")]),s._v("\nroot@ubuntu:/home/sammy"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# iptables -vL INPUT")]),s._v("\nChain INPUT "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("policy ACCEPT "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v(" packets, "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("172")]),s._v(" bytes"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n pkts bytes target     prot opt "),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("in")]),s._v("     out     "),e("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("source")]),s._v("               destination\n    "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("     "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" DROP       all  --  any    any     "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("172.16")]),s._v(".39.1          anywhere\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br")])]),e("p",[s._v("其实也可以一次性指定多个源地址，用 "),e("code",[s._v(",")]),s._v(" 隔开即可，示例如下")]),s._v(" "),e("div",{staticClass:"language-bash line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[s._v("root@ubuntu:/home/sammy"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# iptables -F")]),s._v("\nroot@ubuntu:/home/sammy"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# iptables -I INPUT -s 172.16.39.1,172.16.39.3 -j DROP")]),s._v("\nroot@ubuntu:/home/sammy"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# iptables -vL INPUT")]),s._v("\nChain INPUT "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("policy ACCEPT "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" packets, "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" bytes"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n pkts bytes target     prot opt "),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("in")]),s._v("     out     "),e("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("source")]),s._v("               destination\n    "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("     "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" DROP       all  --  any    any     "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("172.16")]),s._v(".39.3          anywhere\n    "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("     "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" DROP       all  --  any    any     "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("172.16")]),s._v(".39.1          anywhere\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br")])]),e("p",[s._v("可以看到，上述命令一次性添加两条规则，规则之间只是源地址 IP 不同。"),e("strong",[s._v("注意")]),s._v("："),e("code",[s._v(",")]),s._v(" 两侧均不能包含空格，"),e("strong",[s._v("多个 IP 之间必须与 "),e("code",[s._v(",")]),s._v(" 相连")]),s._v("。")]),s._v(" "),e("p",[s._v("除了能指定具体的 IP 地址，还能指定某个网段，示例如下")]),s._v(" "),e("div",{staticClass:"language-bash line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[s._v("root@ubuntu:/home/sammy"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# iptables -F")]),s._v("\nroot@ubuntu:/home/sammy"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# iptables -I INPUT -s 172.16.39.0/24 -j DROP")]),s._v("\nroot@ubuntu:/home/sammy"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# iptables -vL INPUT")]),s._v("\nChain INPUT "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("policy ACCEPT "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" packets, "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" bytes"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n pkts bytes target     prot opt "),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("in")]),s._v("     out     "),e("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("source")]),s._v("               destination\n    "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("     "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" DROP       all  --  any    any     "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("172.16")]),s._v(".39.0/24       anywhere\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br")])]),e("p",[s._v("上述命令表示报文的源地址 IP 如果在 "),e("code",[s._v("172.16.39.0/24")]),s._v(" 网段内，经过 "),e("code",[s._v("INPUT")]),s._v("链时就会被"),e("code",[s._v("DROP")]),s._v(" 掉。")]),s._v(" "),e("p",[s._v("其实，我们还可以对匹配条件 "),e("strong",[s._v("取反")]),s._v(" 如下")]),s._v(" "),e("div",{staticClass:"language-bash line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[s._v("root@ubuntu:/home/sammy"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# iptables -F")]),s._v("\nroot@ubuntu:/home/sammy"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# iptables -I INPUT ! -s 172.16.39.1 -j DROP")]),s._v("\nroot@ubuntu:/home/sammy"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# iptables -vL INPUT")]),s._v("\nChain INPUT "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("policy ACCEPT "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" packets, "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" bytes"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n pkts bytes target     prot opt "),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("in")]),s._v("     out     "),e("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("source")]),s._v("               destination\n    "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("     "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" DROP       all  --  any    any    "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("!")]),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("172.16")]),s._v(".39.1          anywhere\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br")])]),e("p",[s._v("上述命令使用 "),e("code",[s._v("! -s 172.16.39.1")]),s._v(" 表示对 "),e("code",[s._v("-s 172.16.39.1")]),s._v(" 这个匹配条件取反。"),e("code",[s._v("-s 172.16.39.1")]),s._v(" 表示报文源 IP 地址为 "),e("code",[s._v("172.16.39.1")]),s._v(" 即可满足匹配条件。使用 "),e("code",[s._v("!")]),s._v(" 取反后则表示，报文源地址 IP 只要不为 "),e("code",[s._v("172.16.39.1")]),s._v(" 即满足条件。因此，规则的意思是：只要发往本机的报文的源地址不是 "),e("code",[s._v("172.16.39.1")]),s._v("，就接受报文。")]),s._v(" "),e("p",[s._v("按照上述配置，如果此时从 "),e("code",[s._v("172.16.39.1")]),s._v(" 主机上向防火墙所在的主机发送 "),e("code",[s._v("ping")]),s._v(" 请求，"),e("code",[s._v("172.16.39.1")]),s._v(" 主机能得到回应吗？（此处不考虑其他链，只考虑 filter 表的 "),e("code",[s._v("INPUT")]),s._v(" 链）")]),s._v(" "),e("details",{staticClass:"custom-block details"},[e("summary",[s._v("答案")]),s._v(" "),e("p",[s._v("能。也就是说，按照以上配置，"),e("code",[s._v("172.16.39.1")]),s._v(" 主机仍然能够 "),e("code",[s._v("ping")]),s._v(" 通当前主机，何解？")])]),s._v(" "),e("p",[s._v("原因分析如下。")]),s._v(" "),e("p",[s._v("上述配置中，filter 表的 "),e("code",[s._v("INPUT")]),s._v(" 链只有一条规则：只要报文的源 IP 不是 "),e("code",[s._v("172.16.39.1")]),s._v("，那么就接受此报文。但是，某些小伙伴可能会把规则误解为：只要报文的源 IP 是 "),e("code",[s._v("172.16.39.1")]),s._v("，那么就不接受此报文。两种理解看似差别不大，其实完全不一样。后者是错误的，前者才是正确的。")]),s._v(" "),e("p",[s._v("换句话说，报文的源 IP 不是 "),e("code",[s._v("172.16.39.1")]),s._v(" 时，会被接收，并不能代表报文的源 IP 是 "),e("code",[s._v("172.16.39.1")]),s._v(" 时，会被拒绝。")]),s._v(" "),e("p",[s._v("因为并没有任何一条规则指明源 IP 是 "),e("code",[s._v("172.16.39.1")]),s._v(" 时，该执行怎样的动作，所以来自 "),e("code",[s._v("172.16.39.1")]),s._v(" 的报文经过 "),e("code",[s._v("INPUT")]),s._v(" 链时，不能匹配以上规则，使得此报文就继续匹配后面的规则。可是在此只有一条规则，这条规则后面没有其他可以匹配的规则。因此，报文会去匹配当前链的默认动作(默认策略)。而 "),e("code",[s._v("INPUT")]),s._v(" 链的默认动作为 "),e("code",[s._v("ACCEPT")]),s._v("，所以来自 "),e("code",[s._v("172.16.39.1")]),s._v(" 的 "),e("code",[s._v("ping")]),s._v(" 报文就被接收了。如果把 "),e("code",[s._v("INPUT")]),s._v(" 链的默认策略改为 "),e("code",[s._v("DROP")]),s._v("，"),e("code",[s._v("172.16.39.1")]),s._v(" 的报文会被丢弃。"),e("code",[s._v("172.16.39.1")]),s._v(" 的 "),e("code",[s._v("ping")]),s._v(" 命令将得不到任何回应。但是如果将 "),e("code",[s._v("INPUT")]),s._v(" 链的默认策略设置为 "),e("code",[s._v("DROP")]),s._v("，且 "),e("code",[s._v("INPUT")]),s._v(" 链没有其他规则时，所有外来报文将会被丢弃，包括我们 ssh 远程连接。")]),s._v(" "),e("h3",{attrs:{id:"匹配条件-目标-ip-地址"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#匹配条件-目标-ip-地址"}},[s._v("#")]),s._v(" 匹配条件：目标 IP 地址")]),s._v(" "),e("p",[s._v("除了可以通过 "),e("code",[s._v("-s")]),s._v(" 选项指定源地址作为匹配条件，我们还可以使用 "),e("code",[s._v("-d")]),s._v(' 选项指定"目标地址"作为匹配条件。')]),s._v(" "),e("p",[s._v("源地址表示报文从哪里来，目标地址表示报文要到哪里去。")]),s._v(" "),e("p",[s._v("除了 127.0.0.1 回环地址以外，假设当前机器还有一个 IP 为 "),e("code",[s._v("172.16.39.101")]),s._v("。")]),s._v(" "),e("p",[s._v("如果要拒绝 "),e("code",[s._v("172.16.39.1")]),s._v(" 主机发来的报文，但是又只想拒绝 "),e("code",[s._v("172.16.39.1")]),s._v(" 向 "),e("code",[s._v("172.16.39.2")]),s._v(" 这个 IP 发送报文，并不想要防止 "),e("code",[s._v("172.16.39.1")]),s._v(" 向 "),e("code",[s._v("172.16.39.101")]),s._v(" 这个 IP 发送报文，我们就可以指定目标地址作为匹配条件如下")]),s._v(" "),e("div",{staticClass:"language-bash line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[s._v("root@ubuntu:/home/sammy"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# iptables -F INPUT")]),s._v("\nroot@ubuntu:/home/sammy"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# iptables -I INPUT -s 172.16.39.1 -d 172.16.39.2 -j DROP")]),s._v("\nroot@ubuntu:/home/sammy"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# iptables -vL INPUT")]),s._v("\nChain INPUT "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("policy ACCEPT "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" packets, "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" bytes"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n pkts bytes target     prot opt "),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("in")]),s._v("     out     "),e("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("source")]),s._v("               destination\n    "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("     "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" DROP       all  --  any    any     "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("172.16")]),s._v(".39.1          "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("172.16")]),s._v(".39.2\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br")])]),e("p",[s._v("上述命令表示只丢弃从 "),e("code",[s._v("172.16.39.1")]),s._v(" 发往 "),e("code",[s._v("172.16.39.2")]),s._v(" 这个 IP 的报文，但 "),e("code",[s._v("172.16.39.1")]),s._v(" 发往 "),e("code",[s._v("172.16.39.101")]),s._v(" 这个 IP 的报文并不会被丢弃。如果我们不指定任何目标地址，则目标地址默认为 "),e("code",[s._v("anywhere")]),s._v("。同理，如果我们不指定源地址，源地址默认为 "),e("code",[s._v("anywhere")]),s._v("，"),e("code",[s._v("anywhere")]),s._v(" 表示所有 IP，示例如下")]),s._v(" "),e("div",{staticClass:"language-bash line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[s._v("root@ubuntu:/home/sammy"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# iptables -F INPUT")]),s._v("\nroot@ubuntu:/home/sammy"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# iptables -I INPUT -d 172.16.39.2 -j DROP")]),s._v("\nroot@ubuntu:/home/sammy"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# iptables -vL INPUT")]),s._v("\nChain INPUT "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("policy ACCEPT "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" packets, "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" bytes"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n pkts bytes target     prot opt "),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("in")]),s._v("     out     "),e("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("source")]),s._v("               destination\n    "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("     "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" DROP       all  --  any    any     anywhere             "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("172.16")]),s._v(".39.2\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br")])]),e("p",[s._v("上述命令表示表示，所有 IP 发送往 "),e("code",[s._v("172.16.39.2")]),s._v(" 的报文都将被丢弃。")]),s._v(" "),e("p",[s._v("与 "),e("code",[s._v("-s")]),s._v(" 选项一样，"),e("code",[s._v("-d")]),s._v(" 选项也可以使用 "),e("code",[s._v("!")]),s._v(" 进行取反，也能够同时指定多个 IP 地址，使用 "),e("code",[s._v(",")]),s._v(" 隔开即可。")]),s._v(" "),e("div",{staticClass:"custom-block warning"},[e("p",{staticClass:"title"},[s._v("注意")]),e("p",[s._v("不管是 "),e("code",[s._v("-s")]),s._v(" 选项还是 "),e("code",[s._v("-d")]),s._v(" 选项，取反操作与同时指定多个 IP 的操作不能同时使用。")])]),e("p",[s._v("需要明确的一点是："),e("strong",[s._v('当一条规则有多个匹配条件时，这多个匹配条件之间默认存在"与"的关系')]),s._v("。")]),s._v(" "),e("p",[s._v("说白了就是：当一条规则存在多个匹配条件时，报文必须同时满足这些条件，才算做被规则匹配。")]),s._v(" "),e("p",[s._v("如下所示，规则包含有两个匹配条件--源地址与目标地址。报文必须同时能被这两个条件匹配，才算作被当前规则匹配。也就是说，报文来自 "),e("code",[s._v("172.16.39.1")]),s._v("，且目标地址为 "),e("code",[s._v("172.16.39.101")]),s._v("，才会被规则匹配，两个条件必须同时满足。")]),s._v(" "),e("div",{staticClass:"language-bash line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[s._v("root@ubuntu:/home/sammy"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# iptables -F INPUT")]),s._v("\nroot@ubuntu:/home/sammy"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# iptables -I INPUT -s 172.16.39.1 -d 172.16.39.101 -j ACCEPT")]),s._v("\nroot@ubuntu:/home/sammy"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# iptables -vL INPUT")]),s._v("\nChain INPUT "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("policy ACCEPT "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" packets, "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" bytes"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n pkts bytes target     prot opt "),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("in")]),s._v("     out     "),e("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("source")]),s._v("               destination\n    "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("     "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" ACCEPT     all  --  any    any     "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("172.16")]),s._v(".39.1          "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("172.16")]),s._v(".39.101\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br")])]),e("p",[s._v("除了能够使用 "),e("code",[s._v("-s")]),s._v(" 选项和 "),e("code",[s._v("-d")]),s._v(' 选项匹配源 IP 与目标 IP 以外，还能够匹配"源端口"与"目标端口"，但是在此之前先聊聊其他选项。')]),s._v(" "),e("h3",{attrs:{id:"匹配条件-协议类型"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#匹配条件-协议类型"}},[s._v("#")]),s._v(" 匹配条件：协议类型")]),s._v(" "),e("p",[s._v("使用 "),e("code",[s._v("-p")]),s._v(" 选项可以指定需要匹配的报文协议类型。")]),s._v(" "),e("p",[s._v("如果只想要拒绝来自 "),e("code",[s._v("172.16.39.1")]),s._v(" 的 tcp 类型的请求，可以进行如下设置")]),s._v(" "),e("div",{staticClass:"language-bash line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[s._v("root@ubuntu:/home/sammy"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# iptables -F INPUT")]),s._v("\nroot@ubuntu:/home/sammy"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# iptables -I INPUT -s 172.16.39.1 -d 172.16.39.2 -p tcp -j REJECT")]),s._v("\nroot@ubuntu:/home/sammy"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# iptables -vL INPUT")]),s._v("\nChain INPUT "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("policy ACCEPT "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" packets, "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" bytes"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n pkts bytes target     prot opt "),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("in")]),s._v("     out     "),e("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("source")]),s._v("               destination\n    "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("     "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" REJECT     tcp  --  any    any     "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("172.16")]),s._v(".39.1          "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("172.16")]),s._v(".39.2          reject-with icmp-port-unreachable\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br")])]),e("p",[s._v("上述命令设置防火墙拒绝来自 "),e("code",[s._v("172.16.39.1")]),s._v(" 的 tcp 报文发往 "),e("code",[s._v("172.16.39.2")]),s._v(" 这个 IP。测试一下：我们在 "),e("code",[s._v("172.16.39.1")]),s._v(" 上使用 ssh 连接 "),e("code",[s._v("172.16.39.2")]),s._v(" 这个 IP 试试（ssh 协议的传输层协议属于 tcp 协议类型）")]),s._v(" "),e("div",{staticClass:"language-bash line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[e("span",{pre:!0,attrs:{class:"token function"}},[s._v("ssh")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("172.16")]),s._v(".39.2\nssh: connect to "),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("host")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("172.16")]),s._v(".39.2 port "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("22")]),s._v(": Connection refused\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br")])]),e("p",[s._v("可见 ssh 连接被拒绝了。那么我们使用 "),e("code",[s._v("ping")]),s._v(" 命令试试 ("),e("code",[s._v("ping")]),s._v(" 命令使用 icmp 协议)，看看能不能 "),e("code",[s._v("ping")]),s._v(" 通 "),e("code",[s._v("172.16.39.2")]),s._v("。")]),s._v(" "),e("div",{staticClass:"language-bash line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[e("span",{pre:!0,attrs:{class:"token function"}},[s._v("ping")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("172.16")]),s._v(".39.2\nPING "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("172.16")]),s._v(".39.2 "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("172.16")]),s._v(".39.2"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(": "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("56")]),s._v(" data bytes\n"),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("64")]),s._v(" bytes from "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("172.16")]),s._v(".39.2: "),e("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("icmp_seq")]),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("ttl")]),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("64")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("time")]),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.531")]),s._v(" ms\n"),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("64")]),s._v(" bytes from "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("172.16")]),s._v(".39.2: "),e("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("icmp_seq")]),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("ttl")]),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("64")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("time")]),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.798")]),s._v(" ms\n"),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("64")]),s._v(" bytes from "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("172.16")]),s._v(".39.2: "),e("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("icmp_seq")]),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("ttl")]),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("64")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("time")]),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.796")]),s._v(" ms\n^C\n--- "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("172.16")]),s._v(".39.2 "),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("ping")]),s._v(" statistics ---\n"),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("3")]),s._v(" packets transmitted, "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("3")]),s._v(" packets received, "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.0")]),s._v("% packet loss\nround-trip min/avg/max/stddev "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.531")]),s._v("/0.708/0.798/0.125 ms\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br")])]),e("p",[s._v("可以 "),e("code",[s._v("ping")]),s._v(" 通 "),e("code",[s._v("172.16.39.2")]),s._v(" 证明 icmp 协议并没有被规则匹配到，只有 tcp 类型的报文被匹配到。")]),s._v(" "),e("p",[s._v("那么，"),e("code",[s._v("-p")]),s._v(" 选项都支持匹配哪些协议呢？我们总结一下")]),s._v(" "),e("table",[e("thead",[e("tr",[e("th",{staticStyle:{"text-align":"right"}},[s._v("操作系统")]),s._v(" "),e("th",{staticStyle:{"text-align":"left"}},[s._v("协议")])])]),s._v(" "),e("tbody",[e("tr",[e("td",{staticStyle:{"text-align":"right"}},[s._v("CentOS 7/Ubuntu 20.04.1")]),s._v(" "),e("td",{staticStyle:{"text-align":"left"}},[s._v("tcp, udp, udplite, icmp, icmpv6, esp, ah, sctp, mh")])]),s._v(" "),e("tr",[e("td",{staticStyle:{"text-align":"right"}},[s._v("CentOS 6")]),s._v(" "),e("td",{staticStyle:{"text-align":"left"}},[s._v("tcp, udp, udplite, icmp, esp, ah, sctp")])])])]),s._v(" "),e("p",[s._v("当不使用 "),e("code",[s._v("-p")]),s._v(" 指定协议类型时，默认表示所有类型的协议都会被匹配到，与使用 "),e("code",[s._v("-p all")]),s._v(" 的效果相同。")]),s._v(" "),e("h3",{attrs:{id:"匹配条件-网卡接口"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#匹配条件-网卡接口"}},[s._v("#")]),s._v(" 匹配条件：网卡接口")]),s._v(" "),e("p",[s._v("当本机有多个网卡时，我们可以使用 "),e("code",[s._v("-i")]),s._v(" 选项去匹配报文是通过哪块网卡流入本机的。")]),s._v(" "),e("p",[s._v("我们先动手做个小例子，对 "),e("code",[s._v("-i")]),s._v(" 选项有一个初步的了解以后，再结合理论去看。")]),s._v(" "),e("p",[s._v("当前主机的网卡名称为 ens33，如下图")]),s._v(" "),e("div",{staticClass:"language-bash line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[s._v("root@ubuntu:/home/sammy"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# ifconfig")]),s._v("\nens33: "),e("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("flags")]),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("416")]),e("span",{pre:!0,attrs:{class:"token operator"}},[e("span",{pre:!0,attrs:{class:"token file-descriptor important"}},[s._v("3")]),s._v("<")]),s._v("UP,BROADCAST,RUNNING,MULTICAST"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("  mtu "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("1500")]),s._v("\n        inet "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("172.16")]),s._v(".39.2  netmask "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("255.255")]),s._v(".255.0  broadcast "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("172.16")]),s._v(".39.255\n        inet6 fd15:4ba5:5a2b:1008:d949:b1:af3a:68e2  prefixlen "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("64")]),s._v("  scopeid 0x"),e("span",{pre:!0,attrs:{class:"token operator"}},[e("span",{pre:!0,attrs:{class:"token file-descriptor important"}},[s._v("0")]),s._v("<")]),s._v("global"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("\n        inet6 fe80::7d6e:652a:fa81:5ec1  prefixlen "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("64")]),s._v("  scopeid 0x2"),e("span",{pre:!0,attrs:{class:"token operator"}},[e("span",{pre:!0,attrs:{class:"token file-descriptor important"}},[s._v("0")]),s._v("<")]),s._v("link"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("\n        inet6 fd15:4ba5:5a2b:1008:c4ab:3160:80eb:c469  prefixlen "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("64")]),s._v("  scopeid 0x"),e("span",{pre:!0,attrs:{class:"token operator"}},[e("span",{pre:!0,attrs:{class:"token file-descriptor important"}},[s._v("0")]),s._v("<")]),s._v("global"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("\n        ether 00:0c:29:f2:51:6c  txqueuelen "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("1000")]),s._v("  "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("Ethernet"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n        RX packets "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("3468")]),s._v("  bytes "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("2042288")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("2.0")]),s._v(" MB"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n        RX errors "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("  dropped "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("  overruns "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("  frame "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("\n        TX packets "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("2844")]),s._v("  bytes "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("312109")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("312.1")]),s._v(" KB"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n        TX errors "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("  dropped "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" overruns "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("  carrier "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("  collisions "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br"),e("span",{staticClass:"line-number"},[s._v("11")]),e("br")])]),e("p",[s._v("假设想要拒绝由网卡 ens33 流入的 "),e("code",[s._v("ping")]),s._v(" 请求报文，则可以进行如下设置。")]),s._v(" "),e("div",{staticClass:"language-bash line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[s._v("root@ubuntu:/home/sammy"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# iptables -F INPUT")]),s._v("\nroot@ubuntu:/home/sammy"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# iptables -I INPUT -i ens33 -p icmp -j DROP")]),s._v("\nroot@ubuntu:/home/sammy"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# iptables -vL INPUT")]),s._v("\nChain INPUT "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("policy ACCEPT "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" packets, "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" bytes"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n pkts bytes target     prot opt "),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("in")]),s._v("     out     "),e("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("source")]),s._v("               destination\n    "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("     "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" DROP       icmp --  ens33  any     anywhere             anywhere\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br")])]),e("p",[s._v("上述命令使用 "),e("code",[s._v("-i")]),s._v(" 选项指定网卡名称，使用 "),e("code",[s._v("-p")]),s._v(" 选项指定需要匹配的报文协议类型，表示丢弃由 ens33 网卡流入的 icmp 类型的报文。")]),s._v(" "),e("p",[s._v("我们需要考虑一个问题，"),e("code",[s._v("-i")]),s._v(" 选项用于匹配报文流入的网卡。也就是说，从本机发出的报文是不可能会使用到 "),e("code",[s._v("-i")]),s._v(" 选项，因为这些由本机发出的报文压根不是从网卡流入的，而是要通过网卡发出的。从这个角度考虑，"),e("code",[s._v("-i")]),s._v(" 选项的使用是有限制的。")]),s._v(" "),e("p",[s._v("为了更好地解释 "),e("code",[s._v("-i")]),s._v(" 选项，回顾一下在理论总结中的一张 iptables 全局报文流向图如下")]),s._v(" "),e("p",[e("img",{attrs:{src:a(673),alt:"网络报文流向图"}})]),s._v(" "),e("blockquote",[e("p",[s._v("Ubuntu 应该和 CentOS 7 差不多。")])]),s._v(" "),e("p",[s._v("既然 "),e("code",[s._v("-i")]),s._v(" 选项是用于判断报文是从哪个网卡流入的，那么 "),e("code",[s._v("-i")]),s._v(" 选项只能用于上图中的 "),e("code",[s._v("PREROUTING")]),s._v(" 链、"),e("code",[s._v("INPUT")]),s._v(" 链和 "),e("code",[s._v("FORWARD")]),s._v(" 链。这是"),e("code",[s._v("-i")]),s._v(' 选项的特殊性，因为它只是用于判断报文是从哪个网卡流入的，所以只能在上图中"数据流入流向"的链与 '),e("code",[s._v("FORWARD")]),s._v(' 链存在，而上图的"数据发出流向"经过的链是不可能使用 '),e("code",[s._v("-i")]),s._v(" 选项的，比如上图的 "),e("code",[s._v("OUTPUT")]),s._v(" 链与 "),e("code",[s._v("POSTROUTING")]),s._v(" 链。")]),s._v(" "),e("p",[s._v("与 "),e("code",[s._v("-i")]),s._v(" 相对的是 "),e("code",[s._v("-o")]),s._v(" 选项。"),e("code",[s._v("-i")]),s._v(" 选项用于匹配报文从哪个网卡流入，"),e("code",[s._v("-o")]),s._v(" 选项用于匹配报文将从哪个网卡流出。当主机有多块网卡时，可以使用 "),e("code",[s._v("-o")]),s._v(" 选项，匹配报文将由哪块网卡流出。")]),s._v(" "),e("p",[s._v("因此，"),e("code",[s._v("-i")]),s._v(" 选项只能用于 "),e("code",[s._v("PREROUTING")]),s._v(" 链、"),e("code",[s._v("INPUT")]),s._v(" 链和 "),e("code",[s._v("FORWARD")]),s._v(" 链，而 "),e("code",[s._v("-o")]),s._v(" 选项只能用于 "),e("code",[s._v("FORWARD")]),s._v(" 链、"),e("code",[s._v("OUTPUT")]),s._v(" 链和 "),e("code",[s._v("POSTROUTING")]),s._v(" 链。")]),s._v(" "),e("p",[s._v("因为 "),e("code",[s._v("-o")]),s._v(' 选项是用于匹配报文将由哪个网卡"流出"的，所以与上图的"数据进入流向"的链没有任何缘分，只能用于 '),e("code",[s._v("FORWARD")]),s._v(" 链、"),e("code",[s._v("OUTPUT")]),s._v(" 链和 "),e("code",[s._v("POSTROUTING")]),s._v(" 链。")]),s._v(" "),e("p",[s._v("看来，"),e("code",[s._v("FORWARD")]),s._v(' 链属于"中立国"，它能同时使用 '),e("code",[s._v("-i")]),s._v(" 选项与 "),e("code",[s._v("-o")]),s._v(" 选项。")]),s._v(" "),e("h2",{attrs:{id:"扩展匹配条件"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#扩展匹配条件"}},[s._v("#")]),s._v(" 扩展匹配条件")]),s._v(" "),e("p",[s._v('接着聊聊怎样匹配报文的"源端口"与"目标端口"。')]),s._v(" "),e("p",[s._v('前面总结"源地址"与"目标地址"以后，就顺便提到"源端口"与"目标端口"。但是，为什么不继续介绍"源端口"与"目标端口"，非要等到现在呢？这是因为"源端口"与"目标端口"属于 '),e("strong",[s._v("扩展匹配条件")]),s._v('，"源地址"与"目标地址"属于 '),e("strong",[s._v("基本匹配条件")]),s._v('。前面介绍到的匹配条件，都属于基本匹配条件。所以我们单独把"源端口"与"目标端口"放在后面总结，是为了引出扩展匹配条件的概念。')]),s._v(" "),e("p",[s._v("先来了解一下什么是扩展匹配条件。")]),s._v(" "),e("p",[s._v("不是基本匹配条件的就是扩展匹配条件。这样说好像是句废话。我们可以这样理解，基本匹配条件可以直接使用，而如果想要"),e("strong",[s._v("使用扩展匹配条件，则需要依赖一些扩展模块")]),s._v("。或者说，在使用扩展匹配条件之前，需要指定相应的扩展模块才行。这样说不容易明白，我们举个例子演示一下。")]),s._v(" "),e("p",[s._v("我们知道 sshd 服务的默认端口为 22。当使用 ssh 工具远程连接主机时，默认会连接服务端的 22 号端口。假设现在想要使用 iptables 设置一条规则，拒绝来自 "),e("code",[s._v("172.16.39.1")]),s._v(" 的 ssh 请求，我们可以拒绝 "),e("code",[s._v("172.16.39.1")]),s._v(' 的报文能够发往本机的 22 号端口。这时就需要用到"目标端口"选项。')]),s._v(" "),e("h3",{attrs:{id:"dport"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#dport"}},[s._v("#")]),s._v(" "),e("code",[s._v("--dport")])]),s._v(" "),e("p",[s._v("使用选项 "),e("code",[s._v("--dport")]),s._v(" 可以匹配报文的目标端口，"),e("code",[s._v("--dport")]),s._v(" 意为 destination-port，即目标端口。")]),s._v(" "),e("p",[e("strong",[s._v("注意")]),s._v("：与之前的选项不同，"),e("code",[s._v("--dport")]),s._v(' 前有两条"横杠"，而且'),e("strong",[s._v("使用时，必须事先指定使用哪种协议，即必须先使用 "),e("code",[s._v("-p")]),s._v(" 选项")]),s._v("，示例如下")]),s._v(" "),e("div",{staticClass:"language-bash line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[s._v("root@ubuntu:/home/sammy"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# iptables -F INPUT")]),s._v("\nroot@ubuntu:/home/sammy"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# iptables -I INPUT -s 172.16.39.1 -p tcp -m tcp --dport 22 -j REJECT")]),s._v("\nroot@ubuntu:/home/sammy"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# iptables -vL INPUT")]),s._v("\nChain INPUT "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("policy ACCEPT "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" packets, "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" bytes"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n pkts bytes target     prot opt "),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("in")]),s._v("     out     "),e("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("source")]),s._v("               destination\n    "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("     "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" REJECT     tcp  --  any    any     "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("172.16")]),s._v(".39.1          anywhere             tcp dpt:ssh reject-with icmp-port-unreachable\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br")])]),e("p",[s._v("上述命令使用扩展匹配条件 "),e("code",[s._v("--dport")]),s._v("，指定匹配报文的目标端口：如果外来报文的目标端口为本机的 22 号端口（ssh 默认端口），则拒绝之。而在使用 "),e("code",[s._v("--dport")]),s._v(" 之前，借助 "),e("code",[s._v("-m")]),s._v(" 选项指定对应的扩展模块为 tcp。也就是说，如果想要使用 "),e("code",[s._v("--dport")]),s._v(" 这个扩展匹配条件，则必须依靠某个扩展模块完成。此处这个扩展模块就是 tcp 扩展模块。最终使用的是 tcp 扩展模块的 "),e("code",[s._v("dport")]),s._v(" 扩展匹配条件。")]),s._v(" "),e("p",[s._v("现在再回过头来看看扩展匹配条件的概念，就更加明白了。")]),s._v(" "),e("p",[s._v("扩展匹配条件被使用时，需要依赖一些扩展模块。或者说，在使用扩展匹配条件之前，需要指定相应的扩展模块才行。")]),s._v(" "),e("ul",[e("li",[e("code",[s._v("-m tcp")]),s._v(" 表示使用 tcp 扩展模块。")]),s._v(" "),e("li",[e("code",[s._v("--dport")]),s._v(" 表示 tcp 扩展模块中的一个扩展匹配条件，可用于匹配报文的目标端口。")])]),s._v(" "),e("p",[e("strong",[s._v("注意")]),s._v("："),e("code",[s._v("-p tcp")]),s._v(" 与 "),e("code",[s._v("-m tcp")]),s._v(" 并不冲突")]),s._v(" "),e("ul",[e("li",[e("code",[s._v("-p")]),s._v(" 用于匹配报文的协议。")]),s._v(" "),e("li",[e("code",[s._v("-m")]),s._v(" 用于指定扩展模块的名称，正好这个扩展模块也叫 tcp。")])]),s._v(" "),e("p",[s._v("其实上例可以省略 "),e("code",[s._v("-m")]),s._v(" 选项如下")]),s._v(" "),e("div",{staticClass:"language-bash line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[s._v("root@ubuntu:/home/sammy"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# iptables -F INPUT")]),s._v("\nroot@ubuntu:/home/sammy"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# iptables -I INPUT -s 172.16.39.1 -p tcp --dport 22 -j REJECT")]),s._v("\nroot@ubuntu:/home/sammy"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# iptables -vL INPUT")]),s._v("\nChain INPUT "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("policy ACCEPT "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" packets, "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" bytes"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n pkts bytes target     prot opt "),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("in")]),s._v("     out     "),e("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("source")]),s._v("               destination\n    "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("     "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" REJECT     tcp  --  any    any     "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("172.16")]),s._v(".39.1          anywhere             tcp dpt:ssh reject-with icmp-port-unreachable\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br")])]),e("p",[s._v("当使用 "),e("code",[s._v("-p")]),s._v(" 选项指定报文的协议时，如果没有使用 "),e("code",[s._v("-m")]),s._v(" 指定对应的扩展模块名称，直接使用扩展匹配条件，iptables 默认会调用与 "),e("code",[s._v("-p")]),s._v(" 选项对应的协议名称相同的模块。")]),s._v(" "),e("p",[s._v("上面使用 "),e("code",[s._v("-p")]),s._v(" 选项指定协议名称，使用扩展匹配条件 "),e("code",[s._v("--dport")]),s._v(" 指定目标端口。在使用扩展匹配条件的时候，如果没有使用 "),e("code",[s._v("-m")]),s._v(" 指定使用哪个扩展模块，iptables 会默认使用 "),e("code",[s._v("-m 协议名")]),s._v("，而协议名就是 "),e("code",[s._v("-p")]),s._v(" 选项对应的协议名。上例中，"),e("code",[s._v("-p")]),s._v(" 对应的值为 tcp，所以默认调用的扩展模块就为 "),e("code",[s._v("-m tcp")]),s._v("。如果 "),e("code",[s._v("-p")]),s._v(" 对应的值为 udp，那么默认调用的扩展模块就为 "),e("code",[s._v("-m udp")]),s._v("。")]),s._v(" "),e("p",[s._v('所以上例其实"隐式"地指定了扩展模块，只是没有表现出来罢了。')]),s._v(" "),e("p",[s._v("因此，在使用扩展匹配条件时，一定要注意：如果这个扩展匹配条件所依赖的扩展模块名正好与 "),e("code",[s._v("-p")]),s._v(" 对应的协议名称相同，则可省略 "),e("code",[s._v("-m")]),s._v(" 选项，否则不能省略 "),e("code",[s._v("-m")]),s._v(" 选项，必须使用 "),e("code",[s._v("-m")]),s._v(" 选项指定对应的扩展模块名称。这样说可能还是不是特别明了，后续的举例会让我们更加明了地理解这些概念。")]),s._v(" "),e("h3",{attrs:{id:"sport"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#sport"}},[s._v("#")]),s._v(" "),e("code",[s._v("--sport")])]),s._v(" "),e("p",[s._v('有"目标端口"，就有"源端口"，代表"源端口"的扩展匹配条件为 '),e("code",[s._v("--sport")]),s._v("。")]),s._v(" "),e("p",[s._v("使用 "),e("code",[s._v("--sport")]),s._v(" 可以判断报文是否从指定的端口发出，即匹配报文的源端口是否与指定的端口一致。"),e("code",[s._v("--sport")]),s._v(" 表示 source-port，表示源端口之意。")]),s._v(" "),e("p",[s._v("我们已经搞明白了 "),e("code",[s._v("dport")]),s._v("，"),e("code",[s._v("sport")]),s._v(" 类推即可，示例如下")]),s._v(" "),e("div",{staticClass:"language-bash line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[s._v("root@ubuntu:/home/sammy"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# iptables -F INPUT")]),s._v("\nroot@ubuntu:/home/sammy"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# iptables -I INPUT -s 172.16.39.1 -p tcp --sport 22 -j ACCEPT")]),s._v("\nroot@ubuntu:/home/sammy"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# iptables -vL INPUT")]),s._v("\nChain INPUT "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("policy ACCEPT "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" packets, "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" bytes"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n pkts bytes target     prot opt "),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("in")]),s._v("     out     "),e("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("source")]),s._v("               destination\n    "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("     "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" ACCEPT     tcp  --  any    any     "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("172.16")]),s._v(".39.1          anywhere             tcp spt:ssh\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br")])]),e("p",[s._v("上例隐含了 "),e("code",[s._v("-m tcp")]),s._v(" 之意，表示使用了 tcp 扩展模块的 "),e("code",[s._v("--sport")]),s._v(" 扩展匹配条件。")]),s._v(" "),e("p",[s._v("扩展匹配条件同样可以使用 "),e("code",[s._v("!")]),s._v(" 进行取反。比如 "),e("code",[s._v("! --dport 22")]),s._v(" 表示目标端口不是 22 的报文将会被匹配到。")]),s._v(" "),e("p",[e("code",[s._v("--sport")]),s._v(" 还是 "),e("code",[s._v("--dsport")]),s._v(" 都能够指定一个端口范围。比如，"),e("code",[s._v("--dport 22:25")]),s._v(" 表示目标端口为 22 到 25 之间的所有端口，即 22 端口、23 端口、24 端口和 25 端口，示例如下")]),s._v(" "),e("div",{staticClass:"language-bash line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[s._v("root@ubuntu:/home/sammy"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# iptables -F INPUT")]),s._v("\nroot@ubuntu:/home/sammy"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# iptables -I INPUT -s 172.16.39.1 -p tcp --dport 22:25 -j REJECT")]),s._v("\nroot@ubuntu:/home/sammy"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# iptables -vL INPUT")]),s._v("\nChain INPUT "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("policy ACCEPT "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" packets, "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" bytes"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n pkts bytes target     prot opt "),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("in")]),s._v("     out     "),e("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("source")]),s._v("               destination\n    "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("     "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" REJECT     tcp  --  any    any     "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("172.16")]),s._v(".39.1          anywhere             tcp dpts:ssh:smtp reject-with icmp-port-unreachable\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br")])]),e("p",[s._v("也可以写成如下模样：第一条规则表示匹配 0 号到 22 号之间的所有端口，第二条规则表示匹配 80 号端口以及其以后的所有端口（直到 65535）。")]),s._v(" "),e("div",{staticClass:"language-bash line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[s._v("root@ubuntu:/home/sammy"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# iptables -F INPUT")]),s._v("\nroot@ubuntu:/home/sammy"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# iptables -I INPUT -s 172.16.39.1 -p tcp -m tcp --dport :22 -j REJECT")]),s._v("\nroot@ubuntu:/home/sammy"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# iptables -I INPUT -s 172.16.39.1 -p tcp -m tcp --dport 80: -j REJECT")]),s._v("\nroot@ubuntu:/home/sammy"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# iptables -nvL INPUT")]),s._v("\nChain INPUT "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("policy ACCEPT "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("26")]),s._v(" packets, "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("2218")]),s._v(" bytes"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n pkts bytes target     prot opt "),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("in")]),s._v("     out     "),e("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("source")]),s._v("               destination\n    "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("     "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" REJECT     tcp  --  *      *       "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("172.16")]),s._v(".39.1          "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.0")]),s._v(".0.0/0            tcp dpts:80:65535 reject-with icmp-port-unreachable\n    "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("     "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" REJECT     tcp  --  *      *       "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("172.16")]),s._v(".39.1          "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.0")]),s._v(".0.0/0            tcp dpts:0:22 reject-with icmp-port-unreachable\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br")])]),e("p",[s._v("刚才聊到的两个扩展匹配条件都是 tcp 扩展模块的。tcp 扩展模块还有一个比较有用的扩展匹配条件叫做 "),e("code",[s._v("--tcp-flags")]),s._v("，但是由于篇幅原因，以后再对这个扩展匹配条件进行总结。")]),s._v(" "),e("h3",{attrs:{id:"multiport-模块"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#multiport-模块"}},[s._v("#")]),s._v(" multiport 模块")]),s._v(" "),e("p",[s._v("借助 tcp 扩展模块的 "),e("code",[s._v("--sport")]),s._v(" 或者 "),e("code",[s._v("--dport")]),s._v(" 都可以指定一个连续的端口范围，但是无法同时指定多个离散的、不连续的端口。同时指定多个离散的端口需要借助另一个扩展模块--multiport 模块。")]),s._v(" "),e("ul",[e("li",[s._v("multiport 模块的 "),e("code",[s._v("--sports")]),s._v(" 扩展条件可同时指定多个离散的源端口。")]),s._v(" "),e("li",[s._v("multiport 模块的 "),e("code",[s._v("--dports")]),s._v(" 扩展条件可同时指定多个离散的目标端口。")])]),s._v(" "),e("p",[s._v("示例如下")]),s._v(" "),e("div",{staticClass:"language-bash line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[s._v("root@ubuntu:/home/sammy"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# iptables -F INPUT")]),s._v("\nroot@ubuntu:/home/sammy"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# iptables -I INPUT -s 172.16.39.1 -p tcp -m multiport --dports 22,36,80 -j DROP")]),s._v("\nroot@ubuntu:/home/sammy"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# iptables -vL INPUT")]),s._v("\nChain INPUT "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("policy ACCEPT "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" packets, "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" bytes"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n pkts bytes target     prot opt "),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("in")]),s._v("     out     "),e("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("source")]),s._v("               destination\n    "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("     "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" DROP       tcp  --  any    any     "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("172.16")]),s._v(".39.1          anywhere             multiport dports ssh,36,http\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br")])]),e("p",[s._v("上述命令表示禁止来自 "),e("code",[s._v("172.16.39.1")]),s._v(" 的主机上的 tcp 报文访问本机的 22 号端口、36 号端口以及 80 号端口。")]),s._v(" "),e("p",[e("code",[s._v("-m multiport --dports 22,36,80")]),s._v(" 表示使用 multiport 扩展模块的 "),e("code",[s._v("--dports")]),s._v(" 扩展条件，同时指定多个离散的端口，每个端口之间用逗号隔开。")]),s._v(" "),e("p",[e("code",[s._v("-m multiport")]),s._v(" 是不能省略的。如果省略了 "),e("code",[s._v("-m multiport")]),s._v("，就相当于在没有指定扩展模块的情况下使用扩展条件（"),e("code",[s._v("--dports")]),s._v("）。此时 iptables 会默认调用 "),e("code",[s._v("-m tcp")]),s._v("，但是 "),e("code",[s._v("--dports")]),s._v(" 扩展条件并不属于 tcp 扩展模块，而是属于 multiport 扩展模块，这时就会报错。")]),s._v(" "),e("p",[s._v("综上所述，当使用 "),e("code",[s._v("--dports")]),s._v(" 或者 "),e("code",[s._v("--sports")]),s._v(" 这种扩展匹配条件时，必须使用 "),e("code",[s._v("-m")]),s._v(" 指定模块的名称。")]),s._v(" "),e("p",[s._v("其实，使用 multiport 模块的 "),e("code",[s._v("--sports")]),s._v(" 与 "),e("code",[s._v("--dports")]),s._v(" 时，也可以指定连续的端口范围，并且能够在指定连续端口范围的同时，指定离散的端口号，示例如下")]),s._v(" "),e("div",{staticClass:"language-bash line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[s._v("root@ubuntu:/home/sammy"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# iptables -F INPUT")]),s._v("\nroot@ubuntu:/home/sammy"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# iptables -I INPUT -s 172.16.39.1 -p tcp -m multiport --dports 22,80:88 -j REJECT")]),s._v("\nroot@ubuntu:/home/sammy"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# iptables -vL INPUT")]),s._v("\nChain INPUT "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("policy ACCEPT "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" packets, "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" bytes"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n pkts bytes target     prot opt "),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("in")]),s._v("     out     "),e("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("source")]),s._v("               destination\n    "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("     "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" REJECT     tcp  --  any    any     "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("172.16")]),s._v(".39.1          anywhere             multiport dports ssh,http:kerberos reject-with icmp-port-unreachable\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br")])]),e("p",[s._v("以上命令表示拒绝来自 "),e("code",[s._v("172.16.39.1")]),s._v(" 的 tcp 报文访问当前主机的 22 号端口以及 80 到 88 之间的所有端口号，是不是很方便？")]),s._v(" "),e("div",{staticClass:"custom-block warning"},[e("p",{staticClass:"title"},[s._v("注意")]),e("p",[s._v("multiport 扩展只能用于 tcp 协议与 udp 协议，即配合 "),e("code",[s._v("-p tcp")]),s._v(" 或者 "),e("code",[s._v("-p udp")]),s._v(" 使用。")])]),e("p",[s._v("再回过头看之前的概念，我们应该就更加明白了。")]),s._v(" "),e("p",[s._v("本文只是初步认识扩展模块以及扩展匹配条件，还有一些模块并没有总结。好饭不怕晚，后续会有对它们的总结。")]),s._v(" "),e("h2",{attrs:{id:"小结"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#小结"}},[s._v("#")]),s._v(" 小结")]),s._v(" "),e("p",[s._v('本文主要总结一些常用的"基础匹配条件"，并且初步认识两个"扩展模块"以及这两个扩展模块中一些常用的扩展条件。为了便于以后速查，总结如下。')]),s._v(" "),e("p",[s._v('首先要明确一点：当规则同时存在多个匹配条件时，多个条件之间默认存在"与"的关系，即报文必须同时满足所有条件，才能被规则匹配。')]),s._v(" "),e("h3",{attrs:{id:"基本匹配条件总结"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#基本匹配条件总结"}},[s._v("#")]),s._v(" 基本匹配条件总结")]),s._v(" "),e("ul",[e("li",[e("p",[e("code",[s._v("-s")]),s._v(" 用于匹配报文的源地址，可以同时指定多个源地址，每个 IP 之间用逗号隔开，也可以指定为一个网段。")]),s._v(" "),e("div",{staticClass:"language-bash line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#示例如下")]),s._v("\niptables -t filter -i INPUT -s "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("172.16")]),s._v(".39.111,172.16.39.118 -j DROP\niptables -t filter -i INPUT -s "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("172.16")]),s._v(".39.0/24 -j ACCEPT\niptables -t filter -i INPUT "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("!")]),s._v(" -s "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("172.16")]),s._v(".39.0/24 -j ACCEPT\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br")])])]),s._v(" "),e("li",[e("p",[e("code",[s._v("-d")]),s._v(" 用于匹配报文的目标地址，可以同时指定多个目标地址，每个 IP 之间用逗号隔开，也可以指定为一个网段。")]),s._v(" "),e("div",{staticClass:"language-bash line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#示例如下")]),s._v("\niptables -t filter -i OUTPUT -d "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("172.16")]),s._v(".39.111,172.16.39.118 -j DROP\niptables -t filter -i INPUT -d "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("172.16")]),s._v(".39.0/24 -j ACCEPT\niptables -t filter -i INPUT "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("!")]),s._v(" -d "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("172.16")]),s._v(".39.0/24 -j ACCEPT\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br")])])]),s._v(" "),e("li",[e("p",[e("code",[s._v("-p")]),s._v(" 用于匹配报文的协议类型，可以匹配的协议类型有 tcp、udp、 udplite、icmp、icmpv6、esp、ah、sctp 和 mh。")]),s._v(" "),e("div",{staticClass:"language-bash line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#示例如下")]),s._v("\niptables -t filter -i INPUT -p tcp -s "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("172.16")]),s._v(".39.1 -j ACCEPT\niptables -t filter -i INPUT "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("!")]),s._v(" -p udp -s "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("172.16")]),s._v(".39.1 -j ACCEPT\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br")])])]),s._v(" "),e("li",[e("p",[e("code",[s._v("-i")]),s._v(" 用于匹配报文是从哪个网卡接口流入本机的。由于匹配条件只是用于匹配报文流入的网卡，所以在 "),e("code",[s._v("OUTPUT")]),s._v(" 链与 "),e("code",[s._v("POSTROUTING")]),s._v(" 链不能使用此选项。")]),s._v(" "),e("div",{staticClass:"language-bash line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#示例如下")]),s._v("\niptables -t filter -i INPUT -p icmp -i eth4 -j DROP\niptables -t filter -i INPUT -p icmp "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("!")]),s._v(" -i eth4 -j DROP\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br")])])]),s._v(" "),e("li",[e("p",[e("code",[s._v("-o")]),s._v(" 用于匹配报文将要从哪个网卡接口流出本机。由于匹配条件只是用于匹配报文流出的网卡，所以在 "),e("code",[s._v("INPUT")]),s._v(" 链与 "),e("code",[s._v("PREROUTING")]),s._v(" 链不能使用此选项。")]),s._v(" "),e("div",{staticClass:"language-bash line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#示例如下")]),s._v("\niptables -t filter -i OUTPUT -p icmp -o eth4 -j DROP\niptables -t filter -i OUTPUT -p icmp "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("!")]),s._v(" -o eth4 -j DROP\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br")])])])]),s._v(" "),e("h3",{attrs:{id:"扩展匹配条件总结"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#扩展匹配条件总结"}},[s._v("#")]),s._v(" 扩展匹配条件总结")]),s._v(" "),e("p",[s._v("两个扩展模块，以及其中的扩展条件（并非全部，只是这篇文章介绍过的）总结如下")]),s._v(" "),e("h4",{attrs:{id:"tcp-扩展模块"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#tcp-扩展模块"}},[s._v("#")]),s._v(" tcp 扩展模块")]),s._v(" "),e("p",[s._v("常用的扩展匹配条件如下")]),s._v(" "),e("ul",[e("li",[e("p",[e("code",[s._v("-p tcp -m tcp --sport")]),s._v(" 用于匹配 tcp 协议报文的源端口，可以使用冒号指定一个连续的端口范围")])]),s._v(" "),e("li",[e("p",[e("code",[s._v("-p tcp -m tcp --dport")]),s._v(" 用于匹配 tcp 协议报文的目标端口，可以使用冒号指定一个连续的端口范围")]),s._v(" "),e("div",{staticClass:"language-bash line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#示例如下")]),s._v("\niptables -t filter -i OUTPUT -d "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("172.16")]),s._v(".39.1 -p tcp -m tcp --sport "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("22")]),s._v(" -j REJECT\niptables -t filter -i INPUT -s "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("172.16")]),s._v(".39.1 -p tcp -m tcp --dport "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("22")]),s._v(":25 -j REJECT\niptables -t filter -i INPUT -s "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("172.16")]),s._v(".39.1 -p tcp -m tcp --dport :22 -j REJECT\niptables -t filter -i INPUT -s "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("172.16")]),s._v(".39.1 -p tcp -m tcp --dport "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("80")]),s._v(": -j REJECT\niptables -t filter -i OUTPUT -d "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("172.16")]),s._v(".39.1 -p tcp -m tcp "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("!")]),s._v(" --sport "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("22")]),s._v(" -j ACCEPT\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br")])])])]),s._v(" "),e("h4",{attrs:{id:"multiport-扩展模块"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#multiport-扩展模块"}},[s._v("#")]),s._v(" multiport 扩展模块")]),s._v(" "),e("p",[s._v("常用的扩展匹配条件如下")]),s._v(" "),e("ul",[e("li",[e("code",[s._v("-p tcp -m multiport --sports")]),s._v(" 用于匹配报文的源端口，可以指定离散的多个端口号，端口之间用 "),e("code",[s._v(",")]),s._v(" 隔开")]),s._v(" "),e("li",[e("code",[s._v("-p udp -m multiport --dports")]),s._v(" 用于匹配报文的目标端口，可以指定离散的多个端口号，端口之间用 "),e("code",[s._v(",")]),s._v(" 隔开")])]),s._v(" "),e("h2",{attrs:{id:"参考文献"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#参考文献"}},[s._v("#")]),s._v(" 参考文献")]),s._v(" "),e("ul",[e("li",[e("a",{attrs:{href:"http://www.zsythink.net/archives/1544",target:"_blank",rel:"noopener noreferrer"}},[s._v("iptables 详解（4）：iptables 匹配条件总结之一"),e("OutboundLink")],1)])])])}),[],!1,null,null,null);t.default=n.exports}}]);