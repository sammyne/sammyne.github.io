(window.webpackJsonp=window.webpackJsonp||[]).push([[60],{677:function(s,n,a){"use strict";a.r(n);var t=a(6),e=Object(t.a)({},(function(){var s=this,n=s.$createElement,a=s._self._c||n;return a("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[a("blockquote",[a("p",[s._v("原文："),a("a",{attrs:{href:"https://blog.golang.org/using-go-modules",target:"_blank",rel:"noopener noreferrer"}},[s._v("Using Go Modules"),a("OutboundLink")],1),s._v("，发表于 2019-03-19。译者根据最新的 Go 1.13.4 版本进行了相应更新")])]),s._v(" "),a("h2",{attrs:{id:"简介"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#简介"}},[s._v("#")]),s._v(" 简介")]),s._v(" "),a("p",[s._v("这篇博文是以下系列的第一部分：")]),s._v(" "),a("ul",[a("li",[a("strong",[s._v("第 1 部 - 使用 Go Modules（本篇博文）")])]),s._v(" "),a("li",[a("a",{attrs:{href:"https://blog.golang.org/migrating-to-go-modules",target:"_blank",rel:"noopener noreferrer"}},[s._v("第 2 部 - 迁移到 Go Modules"),a("OutboundLink")],1)]),s._v(" "),a("li",[a("a",{attrs:{href:"https://blog.golang.org/publishing-go-modules",target:"_blank",rel:"noopener noreferrer"}},[s._v("第 3 部 - 发布 Go Modules"),a("OutboundLink")],1)]),s._v(" "),a("li",[a("a",{attrs:{href:"https://blog.golang.org/v2-go-modules",target:"_blank",rel:"noopener noreferrer"}},[s._v("第 4 部 - Go Modules：v2 及其未来"),a("OutboundLink")],1)])]),s._v(" "),a("p",[s._v("Go 1.11 和 1.12 开始纳入"),a("a",{attrs:{href:"https://golang.org/doc/go1.11#modules",target:"_blank",rel:"noopener noreferrer"}},[s._v("对 modules 的支持"),a("OutboundLink")],1),s._v("，这是 Go "),a("a",{attrs:{href:"https://blog.golang.org/versioning-proposal",target:"_blank",rel:"noopener noreferrer"}},[s._v("新的依赖管理系统"),a("OutboundLink")],1),s._v("，使得依赖版本信息明确且更加容易管理。这篇博文会介绍开始使用 modules 所需的基本操作知识。")]),s._v(" "),a("p",[s._v("一个 module 是一个 "),a("a",{attrs:{href:"https://golang.org/ref/spec#Packages",target:"_blank",rel:"noopener noreferrer"}},[s._v("Go 包"),a("OutboundLink")],1),s._v("的集合，保存在一个文件树中，这个文件树的根目录有一个 "),a("code",[s._v("go.mod")]),s._v(" 文件。"),a("code",[s._v("go.mod")]),s._v(" 文件定义了 module 的 "),a("em",[s._v("module path")]),s._v("（用作根目录的导入路径）和"),a("strong",[s._v("所需依赖")]),s._v("（其他 modules 的成功构建需要）。每个所需依赖都书写为一个 module path 和一个特定的"),a("a",{attrs:{href:"http://semver.org/",target:"_blank",rel:"noopener noreferrer"}},[s._v("语义化版本"),a("OutboundLink")],1),s._v("。")]),s._v(" "),a("p",[s._v("从 Go 1.11 开始，对于当前或其任何父目录具有 "),a("code",[s._v("go.mod")]),s._v(" 文件且"),a("em",[s._v("在 $GOPATH/src 之外")]),s._v("的目录，go 命令默认会启用 modules。（$GOPATH/src 内部的话，出于兼容性考虑，go 命令仍会以旧的 GOPATH 模式运行，即使能够找到一个 go.mod 文件。详情参见 "),a("a",{attrs:{href:"https://golang.org/cmd/go/#hdr-Preliminary_module_support",target:"_blank",rel:"noopener noreferrer"}},[s._v("go 命令文档"),a("OutboundLink")],1),s._v("）。从 Go 1.13 开始，module 模式成为所有开发的默认模式。")]),s._v(" "),a("p",[s._v("本篇博文逐步介绍使用 modules 开始 Go 代码时会遇到的一系列常用操作：")]),s._v(" "),a("ul",[a("li",[s._v("创建新 module")]),s._v(" "),a("li",[s._v("添加依赖")]),s._v(" "),a("li",[s._v("升级依赖")]),s._v(" "),a("li",[s._v("添加一个不同主要版本号的依赖")]),s._v(" "),a("li",[s._v("将依赖升级到一个新的主要版本")]),s._v(" "),a("li",[s._v("移除未被使用的依赖")])]),s._v(" "),a("h2",{attrs:{id:"创建新-module"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#创建新-module"}},[s._v("#")]),s._v(" 创建新 module")]),s._v(" "),a("p",[s._v("让我们创建一个新的 module 吧。")]),s._v(" "),a("p",[s._v("在 $GOPATH/src 之外的某处创建一个新的空目录，cd 进入这个目录，新建一个名为 "),a("code",[s._v("hello.go")]),s._v(" 的源文件：")]),s._v(" "),a("div",{staticClass:"language-go line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-go"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("package")]),s._v(" hello\n\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("func")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("Hello")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token builtin"}},[s._v("string")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("return")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"Hello, world."')]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br")])]),a("p",[s._v("并在 "),a("code",[s._v("hello_test.go")]),s._v(" 编写一个测试：")]),s._v(" "),a("div",{staticClass:"language-go line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-go"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("package")]),s._v(" hello\n\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("import")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"testing"')]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("func")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("TestHello")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("t "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v("testing"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("T"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    want "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"Hello, world."')]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" got "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("Hello")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v(" got "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("!=")]),s._v(" want "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n        t"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("Errorf")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"Hello() = %q, want %q"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" got"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" want"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br")])]),a("p",[s._v("到此为止，这个目录包含一个包，但不是一个 module，因为没有相应的 go.mod 文件。假设我们的工作目录为 "),a("code",[s._v("/home/gopher/hello")]),s._v("，立即执行 "),a("code",[s._v("go test")]),s._v("，我们会看到：")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[s._v("$ go "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("test")]),s._v("\nPASS\nok      _/home/gopher/hello    "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(".020s\n$\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br")])]),a("p",[s._v("最后一行总结了包的全部测试情况。由于我们既不在 $GOPATH 也不在任何 module 内，go 命令不知道当前目录的导入路径，而是基于目录名称虚构了一个假的："),a("code",[s._v("_/home/gopher/hello")]),s._v("。")]),s._v(" "),a("p",[s._v("使用 "),a("code",[s._v("go mod init")]),s._v(" 命令把当前目录转变为一个 module，重新执行 "),a("code",[s._v("go test")]),s._v("：")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[s._v("$ go mod init example.com/hello\ngo: creating new go.mod: module example.com/hello\n$ go "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("test")]),s._v("\nPASS\nok      example.com/hello    "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(".020s\n$\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br")])]),a("p",[s._v("恭喜你！你已经编写并测试了你的第一个 module。")]),s._v(" "),a("p",[a("code",[s._v("go mod init")]),s._v(" 命令创建的 "),a("code",[s._v("go.mod")]),s._v(" 文件如下：")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[s._v("$ "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("cat")]),s._v(" go.mod\nmodule example.com/hello\n\ngo "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1.13")]),s._v("\n$\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br")])]),a("p",[a("code",[s._v("go.mod")]),s._v(" 只会存在 module 的根目录。子目录的包导入路径由 module 路径拼接上子目录的路径。例如，如果我们新建一个子目录 "),a("code",[s._v("world")]),s._v("，我们不需要（也不想要）在那里执行 "),a("code",[s._v("go mod init")]),s._v("。这个包会被自动识别为 "),a("code",[s._v("example.com/hello")]),s._v(" module 的一部分，具有导入路径 "),a("code",[s._v("example.com/hello/world")]),s._v("。")]),s._v(" "),a("h2",{attrs:{id:"添加依赖"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#添加依赖"}},[s._v("#")]),s._v(" 添加依赖")]),s._v(" "),a("p",[s._v("Go modules 的主要动机是改善使用（也即，添加依赖于）其他开发者所写代码的体验。")]),s._v(" "),a("p",[s._v("让我们更新 "),a("code",[s._v("hello.go")]),s._v(" 文件，导入 "),a("code",[s._v("rsc.io/quote")]),s._v("，使用它来实现 "),a("code",[s._v("Hello")]),s._v("：")]),s._v(" "),a("div",{staticClass:"language-go line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-go"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("package")]),s._v(" hello\n\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("import")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"rsc.io/quote"')]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("func")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("Hello")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token builtin"}},[s._v("string")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("return")]),s._v(" quote"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("Hello")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br")])]),a("p",[s._v("现在再次执行测试：")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[s._v("$ go "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("test")]),s._v("\ngo: finding rsc.io/quote v1.5.2\ngo: downloading rsc.io/quote v1.5.2\ngo: extracting rsc.io/quote v1.5.2\ngo: finding rsc.io/sampler v1.3.0\ngo: finding golang.org/x/text v0.0.0-20170915032832-14c0d48ead0c\ngo: downloading rsc.io/sampler v1.3.0\ngo: extracting rsc.io/sampler v1.3.0\ngo: downloading golang.org/x/text v0.0.0-20170915032832-14c0d48ead0c\ngo: extracting golang.org/x/text v0.0.0-20170915032832-14c0d48ead0c\nPASS\nok      example.com/hello    "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(".023s\n$\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br")])]),a("p",[s._v("go 命令基于 "),a("code",[s._v("go.mod")]),s._v(" 列举的依赖 module 版本确定导入的包。遇到导入 "),a("code",[s._v("go.mod")]),s._v(" 所列举的所有 module 都不提供的包的情况时，go 命令会自动查找包含这个包的 module，并把其最新版本添加到 "),a("code",[s._v("go.mod")]),s._v("（此处的“最新”定义为最新的打标签的稳定（非"),a("a",{attrs:{href:"https://semver.org/#spec-item-9",target:"_blank",rel:"noopener noreferrer"}},[s._v("预发布"),a("OutboundLink")],1),s._v("）版本，没有的话就是最新打标签的预发布版本，再没有的话就选最新没打标签的版本）。在我们的示例里，"),a("code",[s._v("go test")]),s._v(" 将 "),a("code",[s._v("rsc.io/quote")]),s._v(" 定向到 "),a("code",[s._v("rsc.io/quote v1.5.2")]),s._v(" module。它还下载了 "),a("code",[s._v("rsc.io/quote")]),s._v(" 使用的两个依赖 "),a("code",[s._v("rsc.io/sampler")]),s._v(" 和 "),a("code",[s._v("golang.org/x/text")]),s._v("。"),a("code",[s._v("go.mod")]),s._v(" 只会记录直接依赖：")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[s._v("$ "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("cat")]),s._v(" go.mod\nmodule example.com/hello\n\ngo "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1.13")]),s._v("\n\nrequire rsc.io/quote v1.5.2\n$\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br")])]),a("p",[s._v("因为 "),a("code",[s._v("go.mod")]),s._v(" 已经最新且下载的 modules 会被缓存到本地（在 $GOPATH/pkg/mod），以后执行 "),a("code",[s._v("go test")]),s._v(" 不会重复此项工作:")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[s._v("$ go "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("test")]),s._v("\nPASS\nok      example.com/hello    "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(".020s\n$\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br")])]),a("p",[s._v("注意了：go 命令确实使得添加新依赖变得快速和容易，但是也不会没有代价的。我们的 module 现在诸如正确性、安全性和合适的证书等方面就显式地"),a("em",[s._v("依赖")]),s._v("语新的依赖。想要了解更多的话，参见 Russ Cox 的博文："),a("a",{attrs:{href:"https://research.swtch.com/deps",target:"_blank",rel:"noopener noreferrer"}},[s._v("Our Software Dependency Problem"),a("OutboundLink")],1)]),s._v(" "),a("p",[s._v("如上可见，添加一项直接依赖经常会引入其他间接依赖。"),a("code",[s._v("go list -m all")]),s._v(" 命令会列举出当前 module 和它的所有依赖：")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[s._v("$ go list -m all\nexample.com/hello\ngolang.org/x/text v0.0.0-20170915032832-14c0d48ead0c\nrsc.io/quote v1.5.2\nrsc.io/sampler v1.3.0\n$\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br")])]),a("p",[a("code",[s._v("go list")]),s._v(" 的输出中，当前 module，也被称为 "),a("code",[s._v("main module")]),s._v(" 总是在第一行，而后是根据 module path 排序的依赖。")]),s._v(" "),a("p",[a("code",[s._v("golang.org/x/text")]),s._v("的版本"),a("code",[s._v("v0.0.0-20170915032832-14c0d48ead0c")]),s._v("是"),a("a",{attrs:{href:"https://golang.org/cmd/go/#hdr-Pseudo_versions",target:"_blank",rel:"noopener noreferrer"}},[s._v("伪版本"),a("OutboundLink")],1),s._v("的示例，是 go 命令规定的特定没打标签的 commit 的版本语法。")]),s._v(" "),a("p",[s._v("除了 "),a("code",[s._v("go.mod")]),s._v(" 之外，go 命令还维护者一个称为 "),a("code",[s._v("go.sum")]),s._v(" 的文件，包含着特定版本 module 内容的"),a("a",{attrs:{href:"https://golang.org/cmd/go/#hdr-Pseudo_versions",target:"_blank",rel:"noopener noreferrer"}},[s._v("加密哈希"),a("OutboundLink")],1),s._v("：")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[s._v("$ "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("cat")]),s._v(" go.sum\ngolang.org/x/text v0.0.0-20170915032832-14c0d48ead0c h1:qgOY6WgZO"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),s._v(".\ngolang.org/x/text v0.0.0-20170915032832-14c0d48ead0c/go.mod h1:Nq"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),s._v(".\nrsc.io/quote v1.5.2 h1:w5fcysjrx7yqtD/aO+QwRjYZOKnaM9Uh2b40tElTs3"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),s._v(".\nrsc.io/quote v1.5.2/go.mod h1:LzX7hefJvL54yjefDEDHNONDjII0t9xZLPX"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),s._v(".\nrsc.io/sampler v1.3.0 h1:7uVkIFmeBqHfdjD+gZwtXXI+RODJ2Wc4O7MPEh/Q"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),s._v(".\nrsc.io/sampler v1.3.0/go.mod h1:T1hPZKmBbMNahiBKFy5HrXp6adAjACjK9"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),s._v(".\n$\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br")])]),a("p",[s._v("go 命令使用 "),a("code",[s._v("go.sum")]),s._v(" 文件确保将来下载的这些 modules 会和第一次下载的一致，保证我们项目依赖的 modules 不会非由于恶意、意外或其他理由发生非预期的变更。"),a("code",[s._v("go.mod")]),s._v("和"),a("code",[s._v("go.sum")]),s._v("都应该纳入版本管理系统。")]),s._v(" "),a("h2",{attrs:{id:"升级依赖"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#升级依赖"}},[s._v("#")]),s._v(" 升级依赖")]),s._v(" "),a("p",[s._v("Go modules 基于语义化版本标签来引用特定版本。一个语义化版本由 3 部分组成：major、minor 和 patch。以 v0.1.2 为例，主要版本为 0，小版本号为 1，补丁版本号为 2.让我们演示一些小版本更新。后面小节会描述主要版本升级。")]),s._v(" "),a("p",[s._v("从 "),a("code",[s._v("go list -m all")]),s._v(" 的输出可以看到我们使用的 "),a("code",[s._v("golang.org/x/text")]),s._v(" 的没打标签的版本。让我们升级到最新的打标签的版本，并测试一切安好：")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[s._v("$ go get golang.org/x/text\ngo: finding golang.org/x/text v0.3.0\ngo: downloading golang.org/x/text v0.3.0\ngo: extracting golang.org/x/text v0.3.0\n$ go "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("test")]),s._v("\nPASS\nok      example.com/hello    "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(".013s\n$\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br")])]),a("p",[s._v("哇！一切正常。再看看 "),a("code",[s._v("go list -m all")]),s._v("和"),a("code",[s._v("go.mod")]),s._v("文件：")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[s._v("$ go list -m all\nexample.com/hello\ngolang.org/x/text v0.3.0\nrsc.io/quote v1.5.2\nrsc.io/sampler v1.3.0\n$ "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("cat")]),s._v(" go.mod\nmodule example.com/hello\n\ngo "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1.12")]),s._v("\n\nrequire "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("\n    golang.org/x/text v0.3.0 // indirect\n    rsc.io/quote v1.5.2\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n$\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br")])]),a("p",[a("code",[s._v("golang.org/x/text")]),s._v("包升级到了最新打标签的版本（v0.3.0）。"),a("code",[s._v("go.mod")]),s._v("文件也被更新后指向 v0.3.0。"),a("code",[s._v("indirect")]),s._v("注释注明这不是当前 module 直接使用的依赖，只是被其他 module 依赖间接使用而已。详情请查看 "),a("code",[s._v("go help modules")]),s._v("。")]),s._v(" "),a("p",[s._v("现在，让我们尝试升级 "),a("code",[s._v("rsc.io/sampler")]),s._v(" 的小版本。同样的方式，执行 "),a("code",[s._v("go get")]),s._v(" 然后执行测试：")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[s._v("$ go get rsc.io/sampler\ngo: finding rsc.io/sampler v1.99.99\ngo: downloading rsc.io/sampler v1.99.99\ngo: extracting rsc.io/sampler v1.99.99\n$ go "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("test")]),s._v("\n--- FAIL: TestHello "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(".00s"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n    hello_test.go:8: Hello"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"99 bottles of beer on the wall, 99 bottles of beer, ..."')]),s._v(", want "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"Hello, world."')]),s._v("\nFAIL\n"),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("exit")]),s._v(" status "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("\nFAIL    example.com/hello    "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(".014s\n$\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br")])]),a("p",[s._v("噢哦！测试不通过表明 "),a("code",[s._v("rsc.io/sampler")]),s._v(" 的最新版本和我们的用法不兼容。让我们查看一下这个 module 的可用打标签的版本：")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[s._v("$ go list -m -versions rsc.io/sampler\nrsc.io/sampler v1.0.0 v1.2.0 v1.2.1 v1.3.0 v1.3.1 v1.99.99\n$\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br")])]),a("p",[s._v("我们一直用的是 v1.3.0；显然 v1.99.99 用不上。或许我们可以用 v1.3.1 试试：")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[s._v("$ go get rsc.io/sampler@v1.3.1\ngo: finding rsc.io/sampler v1.3.1\ngo: downloading rsc.io/sampler v1.3.1\ngo: extracting rsc.io/sampler v1.3.1\n$ go "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("test")]),s._v("\nPASS\nok      example.com/hello    "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(".022s\n$\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br")])]),a("p",[s._v("注意 "),a("code",[s._v("go get")]),s._v(" 的参数里面显式的 "),a("code",[s._v("@v1.3.1")]),s._v("。通常情况下，所有传给"),a("code",[s._v("go get")]),s._v("的参数都可以接受一个显式的版本号；默认值为"),a("code",[s._v("@latest")]),s._v("，指向之前描述的最新版本。")]),s._v(" "),a("h2",{attrs:{id:"添加一个不同主要版本号的依赖"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#添加一个不同主要版本号的依赖"}},[s._v("#")]),s._v(" 添加一个不同主要版本号的依赖")]),s._v(" "),a("p",[s._v("为我们的包添加一个新函数："),a("code",[s._v("func Proverb")]),s._v("返回一个 Go 的并发谚语，返回值由 "),a("code",[s._v("quote.Concurrency")]),s._v("（依赖 "),a("code",[s._v("rsc.io/quote/v3")]),s._v(" module）提供。首先，我们需要更新 "),a("code",[s._v("hello.go")]),s._v("，添加新函数：")]),s._v(" "),a("div",{staticClass:"language-go line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-go"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("package")]),s._v(" hello\n\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("import")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"rsc.io/quote"')]),s._v("\n    quoteV3 "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"rsc.io/quote/v3"')]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("func")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("Hello")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token builtin"}},[s._v("string")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("return")]),s._v(" quote"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("Hello")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("func")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("Proverb")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token builtin"}},[s._v("string")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("return")]),s._v(" quoteV3"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("Concurrency")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br")])]),a("p",[s._v("然后再 "),a("code",[s._v("hello_test.go")]),s._v(" 添加测试：")]),s._v(" "),a("div",{staticClass:"language-go line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-go"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("func")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("TestProverb")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("t "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v("testing"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("T"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    want "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"Concurrency is not parallelism."')]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" got "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("Proverb")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v(" got "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("!=")]),s._v(" want "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n        t"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("Errorf")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"Proverb() = %q, want %q"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" got"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" want"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br")])]),a("p",[s._v("接下来测试我们的代码：")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[s._v("$ go "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("test")]),s._v("\ngo: finding rsc.io/quote/v3 v3.1.0\ngo: downloading rsc.io/quote/v3 v3.1.0\ngo: extracting rsc.io/quote/v3 v3.1.0\nPASS\nok      example.com/hello    "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(".024s\n$\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br")])]),a("p",[s._v("注意了：我们的 module 现在依赖了 "),a("code",[s._v("rsc.io/quote")]),s._v(" 和 "),a("code",[s._v("rsc.io/quote/v3")]),s._v("：")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[s._v("$ go list -m rsc.io/q"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),s._v(".\nrsc.io/quote v1.5.2\nrsc.io/quote/v3 v3.1.0\n$\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br")])]),a("p",[s._v("Go module 的每个不同主要版本号（v1，v2，依次类推）都会使用不同的 module path：从 v2 开始，路径必须以主要版本结尾。在上面的例子中，"),a("code",[s._v("rsc.io/quote")]),s._v("的"),a("code",[s._v("v3")]),s._v("版本不再是"),a("code",[s._v("rsc.io/quote")]),s._v("，而是以 "),a("code",[s._v("rsc.io/quote/v3")]),s._v(" module 路径来标识自己。这个习惯用法被称为"),a("a",{attrs:{href:"https://research.swtch.com/vgo-import",target:"_blank",rel:"noopener noreferrer"}},[s._v("语义化导入版本管理"),a("OutboundLink")],1),s._v("，它赋予不兼容的包（具有不同的主要版本）不同名字。相反的是，"),a("code",[s._v("rsc.io/quote")]),s._v("的"),a("code",[s._v("v1.6.0")]),s._v("应该和"),a("code",[s._v("v1.5.2")]),s._v("后向兼容，因此，它重用了名字 "),a("code",[s._v("rsc.io/quote")]),s._v("（上一小节中，"),a("code",[s._v("rsc.io/sampler v1.99.99")]),a("em",[s._v("理应")]),s._v("和"),a("code",[s._v("rsc.io/sampler v1.3.0")]),s._v("后向兼容，可能原因是 bugs 和基于 module 行为的错误客户端假设）。")]),s._v(" "),a("p",[a("code",[s._v("go")]),s._v("命令只允许一次构建包含特定 module 路径的至多一个版本。，也即至多一个主要版本：一个"),a("code",[s._v("rsc.io/quote")]),s._v("，一个"),a("code",[s._v("rsc.io/quote/v2")]),s._v("，一个"),a("code",[s._v("rsc.io/quote/v3")]),s._v("，依次类推。这样可以明确告诉 module 作者一个 module 路径的可能重复规则：一个程序不可能在构建时同时包含"),a("code",[s._v("rsc.io/quote v1.5.2")]),s._v("和"),a("code",[s._v("rsc.io/quote v1.6.0")]),s._v("。同时，允许一个 module 具有不同主要版本（因为他们具有不同路径）使得 module 消费者能够逐步升级主要版本号。这个例子里面，我们想要使用"),a("code",[s._v("rsc.io/quote/v3 v3.1.0")]),s._v("提供的"),a("code",[s._v("quote.Concurrency")]),s._v("，但是又没准备好移除"),a("code",[s._v("rsc.io/quote v1.5.2")]),s._v("。逐步增量迁移的能力对于大程序或代码库尤为重要。")]),s._v(" "),a("h2",{attrs:{id:"将依赖升级到一个新的主要版本"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#将依赖升级到一个新的主要版本"}},[s._v("#")]),s._v(" 将依赖升级到一个新的主要版本")]),s._v(" "),a("p",[s._v("让我们完全从"),a("code",[s._v("rsc.io/quote")]),s._v("迁移到只使用"),a("code",[s._v("rsc.io/quote/v3")]),s._v("。由于主要版本变了，我们应该预料到一些 API 可能已被移除、重命名或者以其他不兼容的方式更改。查阅文档，我们发现"),a("code",[s._v("Hello")]),s._v("变成了"),a("code",[s._v("HelloV3")]),s._v("：")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[s._v("$ go doc rsc.io/quote/v3\npackage quote // "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("import")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"rsc.io/quote/v3"')]),s._v("\n\nPackage quote collects pithy sayings.\n\nfunc Concurrency"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" string\nfunc GlassV3"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" string\nfunc GoV3"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" string\nfunc HelloV3"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" string\nfunc OptV3"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" string\n$\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br")])]),a("p",[s._v("我们可以把"),a("code",[s._v("hello.go")]),s._v("的"),a("code",[s._v("quote.Hello()")]),s._v("为"),a("code",[s._v("quoteV3.HelloV3()")]),s._v("：")]),s._v(" "),a("div",{staticClass:"language-go line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-go"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("package")]),s._v(" hello\n\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("import")]),s._v(" quoteV3 "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"rsc.io/quote/v3"')]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("func")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("Hello")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token builtin"}},[s._v("string")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("return")]),s._v(" quoteV3"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("HelloV3")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("func")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("Proverb")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token builtin"}},[s._v("string")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("return")]),s._v(" quoteV3"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("Concurrency")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br")])]),a("p",[s._v("到此为止，导入路径重命名就不用了，我们可以撤销重命名如下：")]),s._v(" "),a("div",{staticClass:"language-go line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-go"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("package")]),s._v(" hello\n\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("import")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"rsc.io/quote/v3"')]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("func")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("Hello")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token builtin"}},[s._v("string")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("return")]),s._v(" quote"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("HelloV3")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("func")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("Proverb")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token builtin"}},[s._v("string")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("return")]),s._v(" quote"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("Concurrency")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br")])]),a("p",[s._v("让我们重新运行测试以确保一切正常：")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[s._v("$ go "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("test")]),s._v("\nPASS\nok      example.com/hello       "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(".014s\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br")])]),a("h2",{attrs:{id:"移除未被使用的依赖"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#移除未被使用的依赖"}},[s._v("#")]),s._v(" 移除未被使用的依赖")]),s._v(" "),a("p",[s._v("我们已经移除了对"),a("code",[s._v("rsc.io/quote")]),s._v("的所有依赖，但是它依然出现在"),a("code",[s._v("go list -m all")]),s._v("和"),a("code",[s._v("go.mod")]),s._v("文件中：")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[s._v("$ go list -m all\nexample.com/hello\ngolang.org/x/text v0.3.0\nrsc.io/quote v1.5.2\nrsc.io/quote/v3 v3.1.0\nrsc.io/sampler v1.3.1\n$ "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("cat")]),s._v(" go.mod\nmodule example.com/hello\n\ngo "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1.13")]),s._v("\n\nrequire "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("\n    golang.org/x/text v0.3.0 // indirect\n    rsc.io/quote v1.5.2\n    rsc.io/quote/v3 v3.0.0\n    rsc.io/sampler v1.3.1 // indirect\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n$\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br")])]),a("p",[s._v("为什么？因为构建一个包时（使用"),a("code",[s._v("go build")]),s._v("或"),a("code",[s._v("go test")]),s._v("等命令），可以很容易发现缺失而需要添加的东西，但是这时并不能安全地移除某些东西。只有在检查了 module 的所有包以及这些包所有可能的 build tag 组合之后，才能移除一个依赖。一个平常的构建命令没有加载这份信息，所以它不可以安全地移除依赖。")]),s._v(" "),a("p",[a("code",[s._v("go mod tidy")]),s._v("命令清除这些没用的依赖：")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[s._v("$ go mod tidy\n$ go list -m all\nexample.com/hello\ngolang.org/x/text v0.3.0\nrsc.io/quote/v3 v3.1.0\nrsc.io/sampler v1.3.1\n$ "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("cat")]),s._v(" go.mod\nmodule example.com/hello\n\ngo "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1.12")]),s._v("\n\nrequire "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("\n    golang.org/x/text v0.3.0 // indirect\n    rsc.io/quote/v3 v3.1.0\n    rsc.io/sampler v1.3.1 // indirect\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n\n$ go "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("test")]),s._v("\nPASS\nok      example.com/hello    "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(".020s\n$\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br")])]),a("h2",{attrs:{id:"结论"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#结论"}},[s._v("#")]),s._v(" 结论")]),s._v(" "),a("p",[s._v("Go modules 是 Go 未来的依赖管理系统。Module 功能已经在所有支持的 Go 版本（即 Go 1.11 和 Go 1.12）中可用。")]),s._v(" "),a("p",[s._v("这篇博文介绍了使用 Go modules 的以下流程：")]),s._v(" "),a("ul",[a("li",[a("code",[s._v("go mod init")]),s._v("新建一个新 module，初始化一份"),a("code",[s._v("go.mod")]),s._v("文件来描述这个 module")]),s._v(" "),a("li",[a("code",[s._v("go build")]),s._v("，"),a("code",[s._v("go test")]),s._v("和其他包构建命令根据需要向"),a("code",[s._v("go.mod")]),s._v("添加新依赖")]),s._v(" "),a("li",[a("code",[s._v("go list -m all")]),s._v("打印当前 module 的依赖")]),s._v(" "),a("li",[a("code",[s._v("go get")]),s._v("改变依赖的所需版本（或者添加新依赖）")]),s._v(" "),a("li",[a("code",[s._v("go mod tidy")]),s._v("移除部可用的依赖")])]),s._v(" "),a("p",[s._v("鼓励大家在本地开发时开始使用 module，添加"),a("code",[s._v("go.mod")]),s._v("和"),a("code",[s._v("go.sum")]),s._v("文件到你们的项目。如果想要提交反馈或帮助塑造 Go 未来的依赖管理系统的话，请给我们提交 "),a("a",{attrs:{href:"https://golang.org/issue/new",target:"_blank",rel:"noopener noreferrer"}},[s._v("bug 报告"),a("OutboundLink")],1),s._v("或"),a("a",{attrs:{href:"https://golang.org/wiki/ExperienceReports",target:"_blank",rel:"noopener noreferrer"}},[s._v("体验报告"),a("OutboundLink")],1),s._v("。")]),s._v(" "),a("p",[s._v("感谢大家的反馈和优化 modules 的帮助。")])])}),[],!1,null,null,null);n.default=e.exports}}]);