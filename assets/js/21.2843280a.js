(window.webpackJsonp=window.webpackJsonp||[]).push([[21],{610:function(s,t,a){s.exports=a.p+"assets/img/illustration.39095e94.jpg"},611:function(s,t,a){s.exports=a.p+"assets/img/json-benchstat-throttling.dd78ad2d.png"},612:function(s,t,a){s.exports=a.p+"assets/img/json-perflock.2b3000c6.png"},652:function(s,t,a){"use strict";a.r(t);var n=a(6),e=Object(n.a)({},(function(){var s=this,t=s.$createElement,n=s._self._c||t;return n("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[n("blockquote",[n("p",[s._v("原文："),n("a",{attrs:{href:"https://about.sourcegraph.com/go/gophercon-2019-optimizing-go-code-without-a-blindfold?utm_source=hs_email&utm_medium=email&utm_content=75138236&_hsenc=p2ANqtz--NgfSL80JgQDQ5zlr3v6AQmsSI149ot4H7UuBdOvbfawqznjkfU7-fXFNbZ3-aZabzoJ7VKB6tCG9BjG21uiDA5_1Kz1nhO5aUV5PiHggYz3MBTEg&_hsmi=75138236",target:"_blank",rel:"noopener noreferrer"}},[s._v("GopherCon 2019 - Optimizing Go Code without a blindfold"),n("OutboundLink")],1)])]),s._v(" "),n("img",{attrs:{src:a(610),width:"800px",alt:"Illustration by Sketch Post"}}),s._v(" "),n("blockquote",[n("p",[s._v("译者采用的go版本为1.12.5")])]),s._v(" "),n("h2",{attrs:{id:"概览"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#概览"}},[s._v("#")]),s._v(" 概览")]),s._v(" "),n("p",[s._v("人人都想程序跑得更快，而这个目标借助Go的性能测试是很容易实现的。优化程序可能会相当复杂，需要耗费精力仔细斟酌正确的姿势。本文将会展示业余的性能优化者所必须的技巧和工具。")]),s._v(" "),n("h2",{attrs:{id:"go性能测试"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#go性能测试"}},[s._v("#")]),s._v(" Go性能测试")]),s._v(" "),n("p",[s._v("你是否想知道怎么确定你的代码是否慢？它能否跑得更快？如果是的话，你上手的第一件工具应该是性能测试。")]),s._v(" "),n("p",[s._v("Go的标准库"),n("code",[s._v("testing")]),s._v("有用于测量代码的CPU和内存消耗的工具。看个简单例子")]),s._v(" "),n("div",{staticClass:"language-go line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-go"}},[n("code",[n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("func")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("copyList")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("in "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),n("span",{pre:!0,attrs:{class:"token builtin"}},[s._v("string")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),n("span",{pre:!0,attrs:{class:"token builtin"}},[s._v("string")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n\t"),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("var")]),s._v(" out "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),n("span",{pre:!0,attrs:{class:"token builtin"}},[s._v("string")]),s._v("\n\t"),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("for")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("_")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" s "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":=")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("range")]),s._v(" in "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n\t\tout "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("append")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("out"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" s"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n\t"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n\n\t"),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("return")]),s._v(" out\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br")])]),n("p",[s._v("性能测试代码如下")]),s._v(" "),n("div",{staticClass:"language-go line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-go"}},[n("code",[n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("func")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("BenchmarkCopyList")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("b "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v("testing"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("B"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n\tb"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("ReportAllocs")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n\t"),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("for")]),s._v(" i "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":=")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v(" i "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v(" b"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("N"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v(" i"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("++")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n\t\t"),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("copyList")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("input"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n\t"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br")])]),n("p",[s._v("启动测试得到如下输出，由输出可知：这个简单函数每次调用大约耗费244ns，附带不少内存分配。")]),s._v(" "),n("div",{staticClass:"language-bash line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-bash"}},[n("code",[s._v("go "),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("test")]),s._v(" -bench"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(".\nBenchmarkCopyList-4   \t "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("5000000")]),s._v("\t       "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("244")]),s._v(" ns/op\t     "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("240")]),s._v(" B/op\t       "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("4")]),s._v(" allocs/op\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br")])]),n("p",[s._v("能优化吗？可以借助"),n("a",{attrs:{href:"https://golang.org/pkg/runtime/pprof/",target:"_blank",rel:"noopener noreferrer"}},[s._v("pprof"),n("OutboundLink")],1),s._v("工具查看哪行代码比较耗时：")]),s._v(" "),n("div",{staticClass:"language-bash line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-bash"}},[n("code",[s._v("go "),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("test")]),s._v(" -cpuprofile"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("cpu.out -bench"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(".\n\ngo tool pprof cpu.out\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 输出")]),s._v("\nType: cpu\nTime: Aug "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("3")]),s._v(", "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("2019")]),s._v(" at "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("3")]),s._v(":50pm "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("CST"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\nDuration: "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(".63s, Total samples "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(".52s "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("93.09")]),s._v("%"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\nEntering interactive mode "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("type "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"help"')]),s._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("for")]),s._v(" commands, "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"o"')]),s._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("for")]),s._v(" options"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("pprof"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" list copyList\nTotal: "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(".52s\nROUTINE "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("==")]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("==")]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("==")]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("==")]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("==")]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("==")]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("==")]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("==")]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("==")]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("==")]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("==")]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("==")]),s._v(" code.copyList "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("in")]),s._v(" /xxxx/code/demo.go\n      60ms      560ms "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("flat, cum"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("36.84")]),s._v("% of Total\n         "),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(".")]),s._v("          "),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(".")]),s._v("      "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(":package code\n         "),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(".")]),s._v("          "),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(".")]),s._v("      "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v(":\n         "),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(".")]),s._v("          "),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(".")]),s._v("      "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("3")]),s._v(":func copyList"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("in "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("string"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("string "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n         "),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(".")]),s._v("          "),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(".")]),s._v("      "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("4")]),s._v(":\tvar out "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("string\n      10ms       10ms      "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("5")]),s._v(":\t"),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("for")]),s._v(" _, s :"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" range "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("in")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n      50ms      550ms      "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("6")]),s._v(":\t\tout "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" append"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("out, s"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n         "),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(".")]),s._v("          "),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(".")]),s._v("      "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("7")]),s._v(":\t"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n         "),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(".")]),s._v("          "),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(".")]),s._v("      "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("8")]),s._v(":\n         "),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(".")]),s._v("          "),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(".")]),s._v("      "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("9")]),s._v(":\t"),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("return")]),s._v(" out\n         "),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(".")]),s._v("          "),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(".")]),s._v("     "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("10")]),s._v(":"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br"),n("span",{staticClass:"line-number"},[s._v("20")]),n("br"),n("span",{staticClass:"line-number"},[s._v("21")]),n("br"),n("span",{staticClass:"line-number"},[s._v("22")]),n("br"),n("span",{staticClass:"line-number"},[s._v("23")]),n("br")])]),n("p",[s._v("由上可知，大部分时间都用在"),n("code",[s._v("append")]),s._v("操作上面了！好在通过预分配切片然后给每个元素赋值的方式来简单修正。")]),s._v(" "),n("div",{staticClass:"language-go line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-go"}},[n("code",[n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("func")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("copyList")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("in "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),n("span",{pre:!0,attrs:{class:"token builtin"}},[s._v("string")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),n("span",{pre:!0,attrs:{class:"token builtin"}},[s._v("string")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n\tout "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":=")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("make")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),n("span",{pre:!0,attrs:{class:"token builtin"}},[s._v("string")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("len")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("in"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n\t"),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("for")]),s._v(" i"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" s "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":=")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("range")]),s._v(" in "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n\t\tout"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("i"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" s\n\t"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n\n\t"),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("return")]),s._v(" out\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br")])]),n("p",[s._v("看一下性能提升程度，这时需要"),n("a",{attrs:{href:"https://github.com/golang/tools/tree/master/cmd/benchcmp",target:"_blank",rel:"noopener noreferrer"}},[s._v("benchcmp"),n("OutboundLink")],1),s._v("工具--展示同一个性能测试两次执行结果的性能变化：")]),s._v(" "),n("div",{staticClass:"language-bash line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-bash"}},[n("code",[s._v("go get -u -v golang.org/x/tools/cmd/benchcmp\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# with the copyList from code/demo.go")]),s._v("\ngo "),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("test")]),s._v(" -bench"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(". "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" old.txt\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# with the copyList from code/demo_optimized.go")]),s._v("\ngo "),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("test")]),s._v(" -bench"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(". "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" new.txt\n\nbenchcmp old.txt new.txt\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 对比结果如下")]),s._v("\nbenchmark               old ns/op     new ns/op     delta\nBenchmarkCopyList-4     "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("237")]),s._v("           "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("67.8")]),s._v("          -71.39%\n\nbenchmark               old allocs     new allocs     delta\nBenchmarkCopyList-4     "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("4")]),s._v("              "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("              -75.00%\n\nbenchmark               old bytes     new bytes     delta\nBenchmarkCopyList-4     "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("240")]),s._v("           "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("96")]),s._v("            -60.00%\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br")])]),n("p",[s._v("🎉 哇!!🎉 性能飙升不少呐。")]),s._v(" "),n("h2",{attrs:{id:"但是-性能测试信得过吗"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#但是-性能测试信得过吗"}},[s._v("#")]),s._v(" 但是，性能测试信得过吗？")]),s._v(" "),n("p",[s._v("上一节的例子简单了点，现实需要性能测试的生产级代码往往要复杂得多。让我们转到标准库的"),n("a",{attrs:{href:"https://golang.org/pkg/encoding/json/",target:"_blank",rel:"noopener noreferrer"}},[s._v("encoding/json"),n("OutboundLink")],1),s._v(" 包看个资源密集型的例子。范围确定一下，就是 "),n("a",{attrs:{href:"https://github.com/golang/go/blob/919594830f17f25c9e971934d825615463ad8a10/src/encoding/json/bench_test.go#L148-L171",target:"_blank",rel:"noopener noreferrer"}},[s._v("BenchmarkCodeDecoder"),n("OutboundLink")],1),s._v(" 测试.")]),s._v(" "),n("p",[s._v("稍微跑多几次的话，你会发现性能测度每次都有所不同：")]),s._v(" "),n("div",{staticClass:"language-bash line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-bash"}},[n("code",[n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("cd")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$GOROOT")]),s._v("/src/encoding/json\n\ngo "),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("test")]),s._v(" -bench"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("CodeDecoder\ngo "),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("test")]),s._v(" -bench"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("CodeDecoder\ngo "),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("test")]),s._v(" -bench"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("CodeDecoder\ngo "),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("test")]),s._v(" -bench"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("CodeDecoder\ngo "),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("test")]),s._v(" -bench"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("CodeDecoder\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 结果对比如下")]),s._v("\nBenchmarkCodeDecoder-4   \t     "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("100")]),s._v("\t  "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("19056070")]),s._v(" ns/op\t "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("101.83")]),s._v(" MB/s\nBenchmarkCodeDecoder-4   \t     "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("100")]),s._v("\t  "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("19120626")]),s._v(" ns/op\t "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("101.49")]),s._v(" MB/s\nBenchmarkCodeDecoder-4   \t     "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("100")]),s._v("\t  "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("18875387")]),s._v(" ns/op\t "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("102.80")]),s._v(" MB/s\nBenchmarkCodeDecoder-4   \t     "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("100")]),s._v("\t  "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("20058788")]),s._v(" ns/op\t  "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("96.74")]),s._v(" MB/s\nBenchmarkCodeDecoder-4   \t     "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("100")]),s._v("\t  "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("20389545")]),s._v(" ns/op\t  "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("95.17")]),s._v(" MB/s\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br")])]),n("p",[s._v("+/-3%的变动看起来不值得让我们失眠，像"),n("code",[s._v("encoding/json")]),s._v("这样的包通常会稍有加速--事实上，"),n("code",[s._v("encoding/json")]),s._v("的最新4次性能提升都小于4%。干扰因素纷繁复杂，我们该如何确定一次变动是否真正地影响了一个包的性能呢？")]),s._v(" "),n("p",[s._v("这时就得数据说话了。")]),s._v(" "),n("h2",{attrs:{id:"性能测试-的数据"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#性能测试-的数据"}},[s._v("#")]),s._v(" 性能测试 ❤️ 的数据")]),s._v(" "),n("p",[s._v("为了理解某个包的真正性能特征，我们通常会看性能测试多次运行的结果，然后计算中位数和方差。这时可以用到"),n("a",{attrs:{href:"https://godoc.org/golang.org/x/perf/cmd/benchstat",target:"_blank",rel:"noopener noreferrer"}},[s._v("benchstat"),n("OutboundLink")],1),s._v("命令：")]),s._v(" "),n("div",{staticClass:"language-bash line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-bash"}},[n("code",[s._v("go get -u -v golang.org/x/perf/cmd/benchstat\n\ngo "),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("test")]),s._v(" -bench"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("CodeDecoder -count"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("8")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" ~/old.txt\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#结果如下")]),s._v("\nname           time/op\nCodeDecoder-4    "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("21")]),s._v(".7ms ±18%\n\nname           speed\nCodeDecoder-4  "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("90")]),s._v(".5MB/s ±16%\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br")])]),n("p",[s._v("16%的方差仍然是相当高的。要降低它的话，我们得看看CPU还干了啥。理想情况下，性能测试会愉快地拼命占用CPU，因此CPU会尽可能地被它压榨到0%。但事实是，你可能手头打开了Slack、编辑器还有20多个Chrome标签页。（有趣事实："),n("a",{attrs:{href:"https://news.ycombinator.com/item?id=14087899",target:"_blank",rel:"noopener noreferrer"}},[s._v("Slack中的动态表情通常消耗大量CPU"),n("OutboundLink")],1),s._v("）")]),s._v(" "),n("p",[s._v("关掉这些资源贪心型应用足够把我们的方差降到+/-5%。")]),s._v(" "),n("div",{staticClass:"language-bash line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-bash"}},[n("code",[s._v("go "),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("test")]),s._v(" -bench"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("CodeDecoder -count"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("8")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" ~/new.txt\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 新结果如下")]),s._v("\nname           time/op\nCodeDecoder-4   "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("18")]),s._v(".7ms ± "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("5")]),s._v("%\n\nname           speed\nCodeDecoder-4  104MB/s ± "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("5")]),s._v("%\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br")])]),n("p",[s._v("然后，CPU\b的问题还不至于此。一次性运行多次性能测试，会发现性能因不明原因明显下降。")]),s._v(" "),n("img",{attrs:{src:a(611),width:"800px",alt:"json-benchstat-throttling"}}),s._v(" "),n("blockquote",[n("p",[s._v("译者注：上述现象在本人电脑上并不明显")])]),s._v(" "),n("p",[s._v("这种情况是因为上述性能测试100%占用CPU太久触发CPU降频了。好在有另一个工具--"),n("a",{attrs:{href:"https://github.com/aclements/perflock",target:"_blank",rel:"noopener noreferrer"}},[s._v("perflock"),n("OutboundLink")],1),s._v(" -- 用于防止性能测试一下子占用太多CPU：")]),s._v(" "),n("img",{attrs:{src:a(612),width:"800px",alt:"json-perflock"}}),s._v(" "),n("p",[s._v("上述例子中，我们限定性能测试的CPU利用率为不超过70%，足以防止电脑降低CPU的频率了。")]),s._v(" "),n("p",[n("code",[s._v("benchstat")]),s._v("可分析多次性能测试然后计算中位数和方差，还可以用于帮助理解某次代码变更对性能的影响。看个例子：")]),s._v(" "),n("div",{staticClass:"language-bash line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-bash"}},[n("code",[s._v("go "),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("test")]),s._v(" -bench"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("CodeDecoder -count"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("8")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" ~/old.txt  \ngo "),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("test")]),s._v(" -bench"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("CodeDecoder -count"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("8")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" ~/new.txt  \n\nbenchstat ~/old.txt ~/new.txt\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 输出")]),s._v("\nname           old time/op    new time/op    delta\nCodeDecoder-4    "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("21")]),s._v(".0ms ±16%    "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("21")]),s._v(".0ms ± "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("9")]),s._v("%   ~     "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("p"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.798")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("n")]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("8")]),s._v("+8"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n\nname           old speed      new speed      delta\nCodeDecoder-4  "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("92")]),s._v(".9MB/s ±14%  "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("92")]),s._v(".7MB/s ± "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("9")]),s._v("%   ~     "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("p"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.776")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("n")]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("8")]),s._v("+8"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br")])]),n("p",[s._v("可见，新代码平均情况下运行需要21.0ms vs 21.0ms... 嗯？\n好在"),n("code",[s._v("benchstat")]),s._v("在底部提供上下文数据帮助我们理解优化是否有明显的数据提升。对比两次性能测试，我们通常看到的是"),n("code",[s._v("+/-X.XX%")]),s._v("而不是"),n("code",[s._v("~")]),s._v("形式的变化。然后，当前情形的高"),n("code",[s._v("p")]),s._v("值（0.776）让"),n("code",[s._v("benchstat")]),s._v("裁定本次优化效果不明显。而什么是"),n("code",[s._v("p")]),s._v("值呢？假设变更对代码性能没影响，把"),n("code",[s._v("p")]),s._v("值看做"),n("code",[s._v("benchstat")]),s._v("报告至少如刚才所见般性能提升的概率。越低的"),n("code",[s._v("p")]),s._v("值意味着"),n("code",[s._v("benchstat")]),s._v("发现的性能提升在没有显著优化时的发生概率是越低的，因此"),n("code",[s._v("p")]),s._v("值越低越好。")]),s._v(" "),n("blockquote",[n("p",[s._v("译者注：这个测试在本人电脑上也不准")])]),s._v(" "),n("p",[s._v("再来个惊喜--其实上面是同一份代码的两次执行！"),n("code",[s._v("p=0.776")]),s._v("是相当糟糕的。通常"),n("code",[s._v("p<=0.05")]),s._v("才意味着一次优化是显著的。")]),s._v(" "),n("h2",{attrs:{id:"性能测试小结"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#性能测试小结"}},[s._v("#")]),s._v(" 性能测试小结")]),s._v(" "),n("p",[s._v("理解上述内容后，我们现在就可以编写性能测试，用"),n("code",[s._v("benchstat")]),s._v("来检测代码的性能，然后用"),n("code",[s._v("pprof")]),s._v("发掘潜在优化点，且基于"),n("code",[s._v("perlock")]),s._v("+"),n("code",[s._v("benchstat")]),s._v("测试它们。")]),s._v(" "),n("h2",{attrs:{id:"再看看-编译器优化"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#再看看-编译器优化"}},[s._v("#")]),s._v(" 再看看：编译器优化")]),s._v(" "),n("p",[s._v("我们可能都听说过"),n("a",{attrs:{href:"https://en.wikipedia.org/wiki/Moore%27s_law",target:"_blank",rel:"noopener noreferrer"}},[s._v("摩尔定律"),n("OutboundLink")],1),s._v("--计算能力（即集体管数目）每18个月会翻一番。但"),n("a",{attrs:{href:"http://proebsting.cs.arizona.edu/law.html",target:"_blank",rel:"noopener noreferrer"}},[s._v("Proebsting定律"),n("OutboundLink")],1),s._v("呢？它推测编译器的进步每18年会使得计算能力翻一番。听起来稀松平常，但是这暗示着编译器也是可以带来显著性能提升的哟！了解性能测试不少后，现在让我们也聊一聊Go编译器优化性能的一些方式。")]),s._v(" "),n("p",[s._v("学习编译器的骚操作前，建议读一下"),n("a",{attrs:{href:"https://github.com/golang/go/blob/master/src/cmd/compile/README.md",target:"_blank",rel:"noopener noreferrer"}},[s._v("cmd/compile"),n("OutboundLink")],1),s._v("的文档以对Golang的编译器有个宏观的了解。")]),s._v(" "),n("h2",{attrs:{id:"函数内联"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#函数内联"}},[s._v("#")]),s._v(" 函数内联")]),s._v(" "),n("p",[n("code",[s._v("go build")]),s._v("时，可通过"),n("code",[s._v("-gcflags")]),s._v("标识给编译器传参。例如，如果你传了两个"),n("code",[s._v("-m")]),s._v("标识，编译器会汇报它能够却没有内联的函数：")]),s._v(" "),n("div",{staticClass:"language-bash line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-bash"}},[n("code",[s._v("go build -gcflags"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"-m -m"')]),s._v(" io "),n("span",{pre:!0,attrs:{class:"token operator"}},[n("span",{pre:!0,attrs:{class:"token file-descriptor important"}},[s._v("2")]),s._v(">")]),s._v(" io.txt\n\n"),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("cat")]),s._v(" io.txt "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("grep")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'function too complex'")]),s._v("\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 部分输出")]),s._v("\nio.go:289:6: cannot inline WriteString: "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("function")]),s._v(" too complex: cost "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("136")]),s._v(" exceeds budget "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("80")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br")])]),n("p",[s._v("这项技巧有助于发现能够优化的函数，促使编译器内联它们。")]),s._v(" "),n("h2",{attrs:{id:"堆的内存分配"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#堆的内存分配"}},[s._v("#")]),s._v(" 堆的内存分配")]),s._v(" "),n("p",[n("code",[s._v("-m -m")]),s._v("标识也能用于发现表达式逃逸到堆而触发内存分配的情形。看到热函数请求大量内存分配时，这个技巧可以帮我们查原因：")]),s._v(" "),n("div",{staticClass:"language-bash line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-bash"}},[n("code",[s._v("go build -gcflags"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"-m -m"')]),s._v(" io "),n("span",{pre:!0,attrs:{class:"token operator"}},[n("span",{pre:!0,attrs:{class:"token file-descriptor important"}},[s._v("2")]),s._v(">")]),s._v(" io.txt\n\n"),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("cat")]),s._v(" io.txt "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("grep")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'escapes to heaear'")]),s._v("\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 部分输出")]),s._v("\nio.go:293:23: "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("byte"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("s"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" escapes to heap\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br")])]),n("h2",{attrs:{id:"边界检查"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#边界检查"}},[s._v("#")]),s._v(" 边界检查")]),s._v(" "),n("p",[s._v("每次索引切片时，golang编译器会对切片生成边界检查。golang编译会执行一轮优化（成为balance check elimination，简称"),n("code",[s._v("bce")]),s._v("），将认定为静态安全的索引操作的检查移除掉。通过设置不同级别的调试查看这些检查是否能够从你的代码移除：")]),s._v(" "),n("div",{staticClass:"language-bash line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-bash"}},[n("code",[s._v("go build -gcflags"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("-d"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("ssa/prove/debug"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" io "),n("span",{pre:!0,attrs:{class:"token operator"}},[n("span",{pre:!0,attrs:{class:"token file-descriptor important"}},[s._v("2")]),s._v(">")]),s._v(" io.txt\n"),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("cat")]),s._v(" io.txt\n\nio.go:446:8: Proved IsSliceInBounds\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br")])]),n("p",[s._v("另一个调试级别的结果如下")]),s._v(" "),n("div",{staticClass:"language-bash line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-bash"}},[n("code",[s._v("go build -gcflags"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("-d"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("ssa/prove/debug"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v(" io "),n("span",{pre:!0,attrs:{class:"token operator"}},[n("span",{pre:!0,attrs:{class:"token file-descriptor important"}},[s._v("2")]),s._v(">")]),s._v(" io.txt\n~ "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("cat")]),s._v(" io.txt\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 部分输出")]),s._v("\nmulti.go:59:14: x+d "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" w"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v(" x:v24 b6 delta:1 w:0 d:signed\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br")])]),n("h2",{attrs:{id:"清空maps"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#清空maps"}},[s._v("#")]),s._v(" 清空Maps")]),s._v(" "),n("p",[s._v("Go 1.11之前，清空map最高效的方式是用新分配的map覆写它。但是，这其实不是非常高效的。从Go 1.11起，我们可以遍历map的键，逐个删除它们，聪明的编译器会优化这项操作，免得你新分配一下map！")]),s._v(" "),n("div",{staticClass:"language-go line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-go"}},[n("code",[n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// replace a map")]),s._v("\nm "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("make")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("map")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),n("span",{pre:!0,attrs:{class:"token builtin"}},[s._v("string")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),n("span",{pre:!0,attrs:{class:"token builtin"}},[s._v("string")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// clear a map; faster since Go 1.11!")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("for")]),s._v(" k "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":=")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("range")]),s._v(" m "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n\t"),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("delete")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("m"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" k"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br")])]),n("h2",{attrs:{id:"检查字符串长度"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#检查字符串长度"}},[s._v("#")]),s._v(" 检查字符串长度")]),s._v(" "),n("p",[s._v("类似地，之前计算字符串长度的有效方式是遍历计算其中rune的个数。现在可以简化为检查rune切片的长度了：")]),s._v(" "),n("div",{staticClass:"language-go line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-go"}},[n("code",[n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// count manually")]),s._v("\nn "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":=")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("for")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("range")]),s._v(" str "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n\tn"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("++")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// simple, and fast since Go 1.11!")]),s._v("\nn "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":=")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("len")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("rune")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("str"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br")])]),n("p",[s._v("总而言之，可以考虑编写一些能够让编译器优化的代码。")]),s._v(" "),n("h2",{attrs:{id:"多说一句-ssa分析"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#多说一句-ssa分析"}},[s._v("#")]),s._v(" 多说一句：SSA分析")]),s._v(" "),n("p",[s._v("如果读过"),n("a",{attrs:{href:"https://github.com/golang/go/blob/master/src/cmd/compile/README.md",target:"_blank",rel:"noopener noreferrer"}},[s._v("上面的Go编译器文档"),n("OutboundLink")],1),s._v("，你应该了解到Go编译器基于源代码的SSA（Static Single Assignment）形式进行优化。用他们的话讲：“这个阶段，AST会被转换为Static Single Assignment (SSA)形式，一种具有特定属性的、更低层次的中间表示法，这种表示法使得优化更加容易实现，并用于最终机器码的生成。”")]),s._v(" "),n("p",[n("code",[s._v("go build")]),s._v("时设定一个特殊的环境变量--"),n("code",[s._v("GOSSAFUNC")]),s._v("，我们就可以查看相应包函数的SSA输出了：")]),s._v(" "),n("p",[s._v("给定代码如下")]),s._v(" "),n("div",{staticClass:"language-bash line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-bash"}},[n("code",[s._v("package code\n\nfunc "),n("span",{pre:!0,attrs:{class:"token function-name function"}},[s._v("HelloWorld")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n        println"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"hello, world!"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br")])]),n("p",[s._v("生成"),n("code",[s._v("HelloWorld")]),s._v("程序的SSA报表。")]),s._v(" "),n("div",{staticClass:"language-bash line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-bash"}},[n("code",[n("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("GOSSAFUNC")]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("HelloWorld go build\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 用浏览器打开生成的ssa.html即可看到SSA的形式")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# code")]),s._v("\ndumped SSA to ./ssa.html\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br")])]),n("p",[s._v("如有兴趣，可以通过"),n("a",{attrs:{href:"https://github.com/golang/go/blob/master/src/cmd/compile/internal/ssa/README.md",target:"_blank",rel:"noopener noreferrer"}},[s._v("Go的介绍文档"),n("OutboundLink")],1),s._v("了解其编译器的更多内部机理。")]),s._v(" "),n("p",[s._v("演讲的幻灯片参见"),n("a",{attrs:{href:"https://docs.google.com/presentation/d/e/2PACX-1vQ9aFgICdqCz5pjrVJ4zFZrWtTKbfGYFPCOKsScomkLoE1Kzk3DVd9-u4k_XgZekqJ7nl-YTy4lD8Uq/pub",target:"_blank",rel:"noopener noreferrer"}},[s._v("这里"),n("OutboundLink")],1),s._v("。")])])}),[],!1,null,null,null);t.default=e.exports}}]);