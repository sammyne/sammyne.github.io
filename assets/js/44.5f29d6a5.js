(window.webpackJsonp=window.webpackJsonp||[]).push([[44],{604:function(a,s,t){a.exports=t.p+"assets/img/tcp-header.978468e3.png"},730:function(a,s,t){"use strict";t.r(s);var e=t(2),r=Object(e.a)({},(function(){var a=this,s=a._self._c;return s("ContentSlotsDistributor",{attrs:{"slot-key":a.$parent.slotKey}},[s("div",{staticClass:"custom-block tip"},[s("p",{staticClass:"title"},[a._v("温馨提示")]),s("p",[a._v("本文从理论到实践，系统地介绍 iptables。如果你想要从头开始了解 iptables，可以查看 "),s("RouterLink",{attrs:{to:"/tag/iptables/"}},[a._v("iptables 系列文章")]),a._v("。")],1)]),s("div",{staticClass:"custom-block danger"},[s("p",{staticClass:"title"},[a._v("高能预警")]),s("p",[a._v("在进行 iptables 实验时，请务必在测试机上进行。本文的实验操作环境为 VMware Fusion 12.0 下的 Ubuntu 20.04.1。")])]),s("p",[s("RouterLink",{attrs:{to:"/2021/01/07/iptables-05-rules-summary-02/"}},[a._v("前文")]),a._v(" 总结了 tcp 扩展模块的 "),s("code",[a._v("--sport")]),a._v(" 与 "),s("code",[a._v("--dport")]),a._v(" 选项，并没有总结 "),s("code",[a._v("--tcp-flags")]),a._v(" 选项。本文讲解一下 tcp 扩展模块的 "),s("code",[a._v("--tcp-flags")]),a._v("。")],1),a._v(" "),s("div",{staticClass:"custom-block tip"},[s("p",{staticClass:"title"},[a._v("温馨提示")]),s("p",[a._v("阅读这篇文章之前，需要对 TCP 协议的基础知识有一定的了解，比如：TCP 头的结构、TCP 三次握手的过程。")])]),s("h2",{attrs:{id:"tcp-flags"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#tcp-flags"}},[a._v("#")]),a._v(" "),s("code",[a._v("--tcp-flags")])]),a._v(" "),s("p",[s("code",[a._v("--tcp-flags")]),a._v(" 指的是 TCP 头的标志位。使用 iptables 时，可通过此扩展匹配条件去匹配 TCP 报文头部的标识位，然后根据标识位的实际情况实现访问控制。")]),a._v(" "),s("p",[a._v("TCP 头的结构如下图")]),a._v(" "),s("p",[s("img",{attrs:{src:t(604),alt:"TCP 头部"}})]),a._v(" "),s("p",[a._v("iptables 使用 TCP 扩展模块的 "),s("code",[a._v("--tcp-flags")]),a._v(' 选项，即可对上图的标志位进行匹配，判断指定标志位的值是否为"1"。TCP 的头部结构不是本文讨论的重点，TCP 的标识位才是。TCP 协议建立连接的过程需要先进行三次握手，而三次握手依靠 TCP 头的标志位进行。')]),a._v(" "),s("p",[a._v("为了更加具象化地描述这个过程，可以抓包查看 ssh 建立连接的过程。其中，")]),a._v(" "),s("ul",[s("li",[a._v("服务端 IP 为 "),s("code",[a._v("192.168.44.1")])]),a._v(" "),s("li",[a._v("客户端 IP 为 "),s("code",[a._v("192.168.44.2")])]),a._v(" "),s("li",[a._v("两者连接的网卡为 "),s("code",[a._v("bridge100")])])]),a._v(" "),s("ol",[s("li",[a._v("Ubuntu 服务端安装并启动 openssh-server（如已安装，则跳过）")])]),a._v(" "),s("div",{staticClass:"language-bash line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[a._v("root@ubuntu:~"),s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# apt install openssh-server")]),a._v("\nroot@ubuntu:~"),s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# sudo /etc/init.d/ssh restart")]),a._v("\n")])]),a._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[a._v("1")]),s("br"),s("span",{staticClass:"line-number"},[a._v("2")]),s("br")])]),s("ol",[s("li",[a._v("客户端启动 tcpdump 监听和服务端连接的网卡和端口 22 的 TCP 流量")])]),a._v(" "),s("div",{staticClass:"language-bash line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[s("span",{pre:!0,attrs:{class:"token function"}},[a._v("sudo")]),a._v(" tcpdump "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-i")]),a._v(" bridge100 port "),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("22")]),a._v("\n")])]),a._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[a._v("1")]),s("br")])]),s("ol",{attrs:{start:"3"}},[s("li",[a._v("客户端 ssh 请求连接到服务端")])]),a._v(" "),s("div",{staticClass:"language-bash line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[s("span",{pre:!0,attrs:{class:"token function"}},[a._v("ssh")]),a._v(" sammyne@192.168.44.2\n")])]),a._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[a._v("1")]),s("br")])]),s("p",[a._v("tcpdump 的第一条报文如下")]),a._v(" "),s("div",{staticClass:"language-bash line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[s("span",{pre:!0,attrs:{class:"token number"}},[a._v("13")]),a._v(":11:49.327356 IP "),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("192.168")]),a._v(".44.1.57520 "),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v(">")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("192.168")]),a._v(".44.2.ssh: Flags "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("[")]),a._v("SEW"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("]")]),a._v(", "),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("seq")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("2064361474")]),a._v(", win "),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("65535")]),a._v(", options "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("[")]),a._v("mss "),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("1460")]),a._v(",nop,wscale "),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("6")]),a._v(",nop,nop,TS val "),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("1368263741")]),a._v(" ecr "),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("0")]),a._v(",sackOK,eol"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("]")]),a._v(", length "),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("0")]),a._v("\n")])]),a._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[a._v("1")]),s("br")])]),s("p",[a._v("以上为 TCP 三次握手中的第一次握手，客户端使用本地的随机端口 57520 向服务端发起连接请求。由 "),s("code",[a._v("Flags")]),a._v(" 字段可知，TCP 头设置的标志位为 "),s("code",[a._v("SEW")]),a._v("（其余标识位没有设置）")]),a._v(" "),s("ul",[s("li",[s("code",[a._v("S")]),a._v(" 是 "),s("code",[a._v("SYN")]),a._v(" 的简写，表示新建连接")]),a._v(" "),s("li",[s("code",[a._v("E")]),a._v(" 是 "),s("code",[a._v("ECE")]),a._v(" 的简写，表示 TCP 客户端三次握手过程能够进行 ECN")]),a._v(" "),s("li",[s("code",[a._v("W")]),a._v(" 是 "),s("code",[a._v("CWR")]),a._v("（Congestion Window Reduced） 的简写，表示客户端收到设置了 ECE 标识位的 TCP 端")])]),a._v(" "),s("p",[a._v("第二次握手的报文如下：服务端回应刚才的请求，将自己 TCP 头的 "),s("code",[a._v("S.E")]),a._v(" 标志位（分别对应 "),s("code",[a._v("SYN")]),a._v("、"),s("code",[a._v("ACK")]),a._v(" 和 "),s("code",[a._v("ECE")]),a._v("）都设置为 1。")]),a._v(" "),s("div",{staticClass:"language-bash line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[s("span",{pre:!0,attrs:{class:"token number"}},[a._v("13")]),a._v(":11:49.328094 IP "),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("192.168")]),a._v(".44.2.ssh "),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v(">")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("192.168")]),a._v(".44.1.57520: Flags "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("[")]),a._v("S.E"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("]")]),a._v(", "),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("seq")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("2079983446")]),a._v(", ack "),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("2064361475")]),a._v(", win "),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("65160")]),a._v(", options "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("[")]),a._v("mss "),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("1460")]),a._v(",sackOK,TS val "),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("4283489136")]),a._v(" ecr "),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("1368263741")]),a._v(",nop,wscale "),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("7")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("]")]),a._v(", length "),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("0")]),a._v("\n")])]),a._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[a._v("1")]),s("br")])]),s("p",[a._v("第三次握手的报文如下")]),a._v(" "),s("div",{staticClass:"language-bash line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[s("span",{pre:!0,attrs:{class:"token number"}},[a._v("13")]),a._v(":11:49.328176 IP "),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("192.168")]),a._v(".44.1.57520 "),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v(">")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("192.168")]),a._v(".44.2.ssh: Flags "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("[")]),a._v("."),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("]")]),a._v(", ack "),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("1")]),a._v(", win "),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("2058")]),a._v(", options "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("[")]),a._v("nop,nop,TS val "),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("1368263741")]),a._v(" ecr "),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("4283489136")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("]")]),a._v(", length "),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("0")]),a._v("\n")])]),a._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[a._v("1")]),s("br")])]),s("p",[a._v("说到这里就已经能够引出接下来的话题了 -- "),s("code",[a._v("--tcp-flags")]),a._v(' 选项。假设现在想要拒绝上文提到的"第一次握手"的报文，在服务端执行以下命令：')]),a._v(" "),s("div",{staticClass:"language-bash line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[a._v("root@ubuntu:~"),s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# iptables -F INPUT")]),a._v("\nroot@ubuntu:~"),s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# iptables -t filter -I INPUT -p tcp -m tcp --dport 22 --tcp-flags SYN,ACK,FIN,RST,URG,PSH SYN -j REJECT")]),a._v("\n")])]),a._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[a._v("1")]),s("br"),s("span",{staticClass:"line-number"},[a._v("2")]),s("br")])]),s("p",[a._v("客户端再次发起 ssh 连接请求就会发现连接被拒绝的错误。")]),a._v(" "),s("div",{staticClass:"language-bash line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[s("span",{pre:!0,attrs:{class:"token function"}},[a._v("ssh")]),a._v(" sammyne@192.168.44.2\nssh: connect to "),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("host")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("192.168")]),a._v(".44.2 port "),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("22")]),a._v(": Connection refused\n")])]),a._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[a._v("1")]),s("br"),s("span",{staticClass:"line-number"},[a._v("2")]),s("br")])]),s("p",[a._v("相关选项说明如下")]),a._v(" "),s("ul",[s("li",[s("code",[a._v("-m tcp --dport 22")]),a._v(" 的含义在 "),s("RouterLink",{attrs:{to:"/2021/01/07/iptables-05-rules-summary-02/"}},[a._v("前文")]),a._v(" 已经总结过：表示使用 tcp 扩展模块，指定目标端口为 22 号端口(ssh 默认端口)")],1),a._v(" "),s("li",[s("code",[a._v("--tcp-flags")]),a._v(" 是重点讨论的扩展匹配条件，用于匹配报文 TCP 头部的标志位\n"),s("ul",[s("li",[s("code",[a._v("SYN,ACK,FIN,RST,URG,PSH SYN")]),a._v(" 这串字符就是用于配置要匹配的标志位，可以拆成为两部分理解\n"),s("ul",[s("li",[s("code",[a._v("SYN,ACK,FIN,RST,URG,PSH")]),a._v("：需要匹配报文 TCP 头的哪些标志位。上述配置表示匹配报文 TCP 头的 6 个标志位 -- "),s("code",[a._v("SYN")]),a._v("、"),s("code",[a._v("ACK")]),a._v("、"),s("code",[a._v("FIN")]),a._v("、"),s("code",[a._v("RST")]),a._v("、"),s("code",[a._v("URG")]),a._v(" 和 "),s("code",[a._v("PSH")]),a._v("，可以把这一部分理解成需要匹配的标志位列表")]),a._v(" "),s("li",[s("code",[a._v("SYN")]),a._v("：标记第一部分的标志位列表中哪些标志位必须为 1。当前场景的第二部分为 "),s("code",[a._v("SYN")]),a._v(" 表示第一部分需要匹配的标志位列表中 "),s("code",[a._v("SYN")]),a._v(" 标志位的值必须为 1，其他标志位必须为 0")])])]),a._v(" "),s("li",[a._v("因此，"),s("code",[a._v("SYN,ACK,FIN,RST,URG,PSH SYN")]),a._v(" 表示需要匹配报文 TCP 头的 "),s("code",[a._v("SYN")]),a._v("、"),s("code",[a._v("ACK")]),a._v("、"),s("code",[a._v("FIN")]),a._v("、"),s("code",[a._v("RST")]),a._v("、"),s("code",[a._v("URG")]),a._v(" 和 "),s("code",[a._v("PSH")]),a._v(" 这些标志位，其中 "),s("code",[a._v("SYN")]),a._v(" 标志位必须为 1，其他 5 个标志位必须为 0。")]),a._v(" "),s("li",[a._v("这与前面 tcpdump 抓包的情形相同，正是 TCP 三次握手时第一次握手的情况。第一次握手的报文 TCP 头的标志位如下："),s("div",{staticClass:"language-bash line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[a._v("Flags "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("[")]),a._v("SEW"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("]")]),a._v("\n")])]),a._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[a._v("1")]),s("br")])])])])])]),a._v(" "),s("p",[s("code",[a._v("--tcp-flags")]),a._v(" 的表示方法与 tcpdump 的表示方法有异曲同工之妙。只不过，tcpdump 只把标志位为 1 的标识位的字母简写放到在 "),s("code",[a._v("Flags")]),a._v(" 列表。"),s("code",[a._v("--tcp-flags")]),a._v(" 需要先指明匹配哪些标志位，然后再指明其中哪些必须为 1，剩余都必须为 0。")]),a._v(" "),s("p",[a._v("依此类推，匹配 TCP 头第二次握手的标志位可借助以下命令（此处省略对源地址与目标地址的匹配，重点在于对 "),s("code",[a._v("tcp-flags")]),a._v(" 的示例）")]),a._v(" "),s("div",{staticClass:"language-bash line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[a._v("root@ubuntu:~"),s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# iptables -t filter -I INPUT -p tcp -m tcp --sport 22 --tcp-flags SYN,ACK,FIN,RST,URG,PSH, SYN,ACK -j REJECT")]),a._v("\n")])]),a._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[a._v("1")]),s("br")])]),s("p",[a._v("综上所述，灵活地配置标志位即可匹配到更多应用场景。")]),a._v(" "),s("p",[a._v("上述两条命令还可以简写为如下模样")]),a._v(" "),s("div",{staticClass:"language-bash line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[a._v("root@ubuntu:~"),s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# iptables -t filter -I INPUT -p tcp -m tcp --dport 22 --tcp-flags ALL SYN -j REJECT")]),a._v("\nroot@ubuntu:~"),s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# iptables -t filter -I OUTPUT -p tcp -m tcp --sport 22 --tcp-flags ALL SYN,ACK -j REJECT")]),a._v("\n")])]),a._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[a._v("1")]),s("br"),s("span",{staticClass:"line-number"},[a._v("2")]),s("br")])]),s("p",[a._v("可以用 "),s("code",[a._v("ALL")]),a._v(" 表示 "),s("code",[a._v("SYN,ACK,FIN,RST,URG,PSH")]),a._v("。")]),a._v(" "),s("p",[a._v("tcp 扩展模块还专门提供一个选项--"),s("code",[a._v("--syn")]),a._v('，用于匹配前面提到的"第一次握手"。')]),a._v(" "),s("p",[a._v("使用 "),s("code",[a._v("--syn")]),a._v(" 选项相当于使用 "),s("code",[a._v("--tcp-flags SYN,RST,ACK,FIN SYN")]),a._v("。也就是说，使用 "),s("code",[a._v("--syn")]),a._v(" 选项去匹配 TCP 新建连接的请求报文命令如下")]),a._v(" "),s("div",{staticClass:"language-bash line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[a._v("root@ubuntu:~"),s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# iptables -F INPUT")]),a._v("\nroot@ubuntu:~"),s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# iptables -t filter -I INPUT -p tcp -m tcp --dport 22 --syn -j REJECT")]),a._v("\n")])]),a._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[a._v("1")]),s("br"),s("span",{staticClass:"line-number"},[a._v("2")]),s("br")])]),s("h2",{attrs:{id:"小结"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#小结"}},[a._v("#")]),a._v(" 小结")]),a._v(" "),s("p",[a._v("结合之前的文章，tcp 模块的常用扩展匹配条件再次总结如下，以便于以后速查。")]),a._v(" "),s("h3",{attrs:{id:"sport"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#sport"}},[a._v("#")]),a._v(" "),s("code",[a._v("--sport")])]),a._v(" "),s("p",[a._v("用于匹配 tcp 协议报文的源端口，可以使用冒号指定一个连续的端口范围")]),a._v(" "),s("div",{staticClass:"language-bash line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("#示例")]),a._v("\niptables "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-t")]),a._v(" filter "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-I")]),a._v(" OUTPUT "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-d")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("192.168")]),a._v(".1.146 "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-p")]),a._v(" tcp "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-m")]),a._v(" tcp "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("--sport")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("22")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-j")]),a._v(" REJECT\niptables "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-t")]),a._v(" filter "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-I")]),a._v(" OUTPUT "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-d")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("192.168")]),a._v(".1.146 "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-p")]),a._v(" tcp "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-m")]),a._v(" tcp "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("--sport")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("22")]),a._v(":25 "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-j")]),a._v(" REJECT\niptables "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-t")]),a._v(" filter "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-I")]),a._v(" OUTPUT "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-d")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("192.168")]),a._v(".1.146 "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-p")]),a._v(" tcp "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-m")]),a._v(" tcp "),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("!")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("--sport")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("22")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-j")]),a._v(" ACCEPT\n")])]),a._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[a._v("1")]),s("br"),s("span",{staticClass:"line-number"},[a._v("2")]),s("br"),s("span",{staticClass:"line-number"},[a._v("3")]),s("br"),s("span",{staticClass:"line-number"},[a._v("4")]),s("br")])]),s("h3",{attrs:{id:"dport"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#dport"}},[a._v("#")]),a._v(" "),s("code",[a._v("--dport")])]),a._v(" "),s("p",[a._v("用于匹配 tcp 协议报文的目标端口，可以使用冒号指定一个连续的端口范围")]),a._v(" "),s("div",{staticClass:"language-bash line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("#示例")]),a._v("\niptables "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-t")]),a._v(" filter "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-I")]),a._v(" INPUT "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-s")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("192.168")]),a._v(".1.146 "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-p")]),a._v(" tcp "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-m")]),a._v(" tcp "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("--dport")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("22")]),a._v(":25 "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-j")]),a._v(" REJECT\niptables "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-t")]),a._v(" filter "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-I")]),a._v(" INPUT "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-s")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("192.168")]),a._v(".1.146 "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-p")]),a._v(" tcp "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-m")]),a._v(" tcp "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("--dport")]),a._v(" :22 "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-j")]),a._v(" REJECT\niptables "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-t")]),a._v(" filter "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-I")]),a._v(" INPUT "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-s")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("192.168")]),a._v(".1.146 "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-p")]),a._v(" tcp "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-m")]),a._v(" tcp "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("--dport")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("80")]),a._v(": "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-j")]),a._v(" REJECT\n")])]),a._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[a._v("1")]),s("br"),s("span",{staticClass:"line-number"},[a._v("2")]),s("br"),s("span",{staticClass:"line-number"},[a._v("3")]),s("br"),s("span",{staticClass:"line-number"},[a._v("4")]),s("br")])]),s("h3",{attrs:{id:"tcp-flags-2"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#tcp-flags-2"}},[a._v("#")]),a._v(" "),s("code",[a._v("--tcp-flags")])]),a._v(" "),s("p",[a._v("用于匹配报文的 TCP 头的标志位")]),a._v(" "),s("div",{staticClass:"language-bash line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("#示例")]),a._v("\niptables "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-t")]),a._v(" filter "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-I")]),a._v(" INPUT "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-p")]),a._v(" tcp "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-m")]),a._v(" tcp "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("--dport")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("22")]),a._v(" --tcp-flags SYN,ACK,FIN,RST,URG,PSH SYN "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-j")]),a._v(" REJECT\niptables "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-t")]),a._v(" filter "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-I")]),a._v(" OUTPUT "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-p")]),a._v(" tcp "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-m")]),a._v(" tcp "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("--sport")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("22")]),a._v(" --tcp-flags SYN,ACK,FIN,RST,URG,PSH SYN,ACK "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-j")]),a._v(" REJECT\niptables "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-t")]),a._v(" filter "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-I")]),a._v(" INPUT "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-p")]),a._v(" tcp "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-m")]),a._v(" tcp "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("--dport")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("22")]),a._v(" --tcp-flags ALL SYN "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-j")]),a._v(" REJECT\niptables "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-t")]),a._v(" filter "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-I")]),a._v(" OUTPUT "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-p")]),a._v(" tcp "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-m")]),a._v(" tcp "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("--sport")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("22")]),a._v(" --tcp-flags ALL SYN,ACK "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-j")]),a._v(" REJECT\n")])]),a._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[a._v("1")]),s("br"),s("span",{staticClass:"line-number"},[a._v("2")]),s("br"),s("span",{staticClass:"line-number"},[a._v("3")]),s("br"),s("span",{staticClass:"line-number"},[a._v("4")]),s("br"),s("span",{staticClass:"line-number"},[a._v("5")]),s("br")])]),s("h3",{attrs:{id:"syn"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#syn"}},[a._v("#")]),a._v(" "),s("code",[a._v("--syn")])]),a._v(" "),s("p",[a._v("用于匹配 tcp 新建连接的请求报文，相当于使用 "),s("code",[a._v("--tcp-flags SYN,RST,ACK,FIN SYN")]),a._v("。")]),a._v(" "),s("h2",{attrs:{id:"参考文献"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#参考文献"}},[a._v("#")]),a._v(" 参考文献")]),a._v(" "),s("ul",[s("li",[s("a",{attrs:{href:"http://www.zsythink.net/archives/1578",target:"_blank",rel:"noopener noreferrer"}},[a._v("iptables 详解（6）：iptables 扩展匹配条件之’–tcp-flags’"),s("OutboundLink")],1)])])])}),[],!1,null,null,null);s.default=r.exports}}]);