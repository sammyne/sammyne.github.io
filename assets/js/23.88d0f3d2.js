(window.webpackJsonp=window.webpackJsonp||[]).push([[23],{562:function(s,a,t){s.exports=t.p+"assets/img/1.1981b62c.png"},563:function(s,a,t){s.exports=t.p+"assets/img/2.2fbfb7ac.png"},564:function(s,a,t){s.exports=t.p+"assets/img/3.c0043866.png"},565:function(s,a,t){s.exports=t.p+"assets/img/4.bb7b2828.png"},566:function(s,a,t){s.exports=t.p+"assets/img/5.d63c8c87.png"},567:function(s,a,t){s.exports=t.p+"assets/img/6.7eed63e7.png"},719:function(s,a,t){"use strict";t.r(a);var n=t(2),e=Object(n.a)({},(function(){var s=this,a=s._self._c;return a("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[a("blockquote",[a("p",[s._v("原文："),a("a",{attrs:{href:"https://www.ardanlabs.com/blog/2019/05/garbage-collection-in-go-part2-gctraces.html",target:"_blank",rel:"noopener noreferrer"}},[s._v("Garbage Collection In Go : Part II - GC Traces"),a("OutboundLink")],1)])]),s._v(" "),a("h2",{attrs:{id:"序言"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#序言"}},[s._v("#")]),s._v(" 序言")]),s._v(" "),a("p",[s._v("这是讲解 Go 的垃圾回收背后的机制和语义的三部曲的第二部。本篇博文聚焦于如何生成并解读 GC 记录。")]),s._v(" "),a("p",[s._v("三部曲的索引如下：")]),s._v(" "),a("ol",[a("li",[a("RouterLink",{attrs:{to:"/_post/garbage-collection-in-go/part1-semantics/"}},[s._v("Go 的垃圾回收：第一节--语义")])],1),s._v(" "),a("li",[s._v("Go 的垃圾回收：第二节 -- GC 追溯")]),s._v(" "),a("li",[a("RouterLink",{attrs:{to:"/_post/garbage-collection-in-go/part3-gcpacing/"}},[s._v("Go 的垃圾回收：第三节 -- GC 的节奏控制")])],1)]),s._v(" "),a("h2",{attrs:{id:"简介"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#简介"}},[s._v("#")]),s._v(" 简介")]),s._v(" "),a("p",[a("RouterLink",{attrs:{to:"/_post/garbage-collection-in-go/part1-semantics/"}},[s._v("第一篇博文")]),s._v(" 花时间描述了垃圾回收器的行为和展示了回收器会给运行的程序带来的时延。我分享了如何生成并解读一条 GC 记录，展示堆上内存的变化情况，还解释了 GC 的不同阶段和这些阶段影响时延的方式。\n那篇博文的结论是：如果降低堆的压力，时延代价会减小，从而提高程序的性能。我也指出了一点：通过搜罗不同方法来增加任意两次回收之间的间隔来延迟启动回收节奏的行为不是一个好策略。一个连贯的节奏不仅快速（@TODO: 原文是 even if it's quick，暂时译不动），而且能够更好地保持程序的最高效运行。")],1),s._v(" "),a("p",[s._v("这篇博客将会带你体会一个真实的网页应用程序，向你展示如何生成 GC 的追溯记录和程序概述，然后演示如何解读这些工具的输出使得你能够找到提高自己程序性能的方法。")]),s._v(" "),a("h2",{attrs:{id:"运行程序"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#运行程序"}},[s._v("#")]),s._v(" 运行程序")]),s._v(" "),a("p",[s._v("以下是 Go 培训用的一个网页程序：")]),s._v(" "),a("p",[s._v("图 1\n"),a("img",{attrs:{src:t(562),alt:"searching for anything"}})]),s._v(" "),a("p",[s._v("https://github.com/ardanlabs/gotraining/tree/master/topics/go/profiling/project")]),s._v(" "),a("p",[s._v("图 1 展示了程序的样子。这个程序从不同的新闻提供商下载 3 种 rss 提要，且允许用户搜索。编译构建网页程序后，程序就可以启动起来了。")]),s._v(" "),a("p",[s._v("代码片段 1")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[s._v("$ go build\n$ "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("GOGC")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("off ./project "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" /dev/null\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br")])]),a("p",[s._v("代码片段 1 显示程序启动时 "),a("code",[s._v("GOGC")]),s._v(" 设为了 "),a("code",[s._v("off")]),s._v("，把垃圾回收器关闭了。日志被重定向到 "),a("code",[s._v("/dev/null")]),s._v(" 设备。程序运行时，可以向服务器发送请求。")]),s._v(" "),a("p",[s._v("代码片段 2")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[s._v("$ hey "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-m")]),s._v(" POST "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-c")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("100")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-n")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10000")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"http://localhost:5000/search?term=topic&cnn=on&bbc=on&nyt=on"')]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("p",[s._v("代码片段 2 显示了借助 "),a("code",[s._v("hey")]),s._v(" 工具用 100 条链接发送 10k 个请求给服务器的场景。所有请求被服务处理完后，统计结果如下。")]),s._v(" "),a("p",[s._v("图 2\n"),a("img",{attrs:{src:t(563),alt:"profile without GC"}})]),s._v(" "),a("p",[s._v("图 2 可视化地表示关闭垃圾回收后处理 10k 个请求的情形。10k 个请求共花费 4,188 ms，即服务器每秒大约处理 2387 个请求。")]),s._v(" "),a("h2",{attrs:{id:"打开垃圾回收器"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#打开垃圾回收器"}},[s._v("#")]),s._v(" 打开垃圾回收器")]),s._v(" "),a("p",[s._v("给这个程序打开垃圾回收器的情形又是怎样的呢？")]),s._v(" "),a("p",[s._v("代码片段 3")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[s._v("$ "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("GODEBUG")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("gctrace"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" ./project "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" /dev/null\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("p",[s._v("代码片段 3 显示了能够查看 GC 记录的程序启动方式。"),a("code",[s._v("GOGC")]),s._v(" 变量移除掉了，取而代之的是 "),a("code",[s._v("GODEBUG")]),s._v(" 变量。"),a("code",[s._v("GODEBUG")]),s._v("的设定使得运行时能够每次触发回收时生成一条 GC 记录。现在再次向服务器发送同样的 10k 个请求。一旦所有请求都经服务器处理，我们可以分析所得的 GC 记录和 "),a("code",[s._v("hey")]),s._v(" 工具提供的信息了。")]),s._v(" "),a("p",[s._v("代码片段 4")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[s._v("$ "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("GODEBUG")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("gctrace"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" ./project "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" /dev/null\ngc "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("3")]),s._v(" @3.182s "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("%: "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.015")]),s._v("+0.59+0.096 ms clock, "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.19")]),s._v("+0.10/1.3/3.0+1.1 ms cpu, "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("4")]),s._v("-"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("4")]),s._v("-"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v(" MB, "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("5")]),s._v(" MB goal, "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("12")]),s._v(" P\n"),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(".")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(".")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(".")]),s._v("\ngc "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2553")]),s._v(" @8.452s "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("14")]),s._v("%: "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.004")]),s._v("+0.33+0.051 ms clock, "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.056")]),s._v("+0.12/0.56/0.94+0.61 ms cpu, "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("4")]),s._v("-"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("4")]),s._v("-"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v(" MB, "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("5")]),s._v(" MB goal, "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("12")]),s._v(" P\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br")])]),a("p",[s._v("代码片段 4 显示的是上次运行中的第 3 和最后一次的回收。前两次回收没放出来是因为载荷到达服务器之前那些回收就触发了。最后一次回收显示 10k 个请求的处理共触发了 2551 次回收（减去前两次不算数的回收）。")]),s._v(" "),a("p",[s._v("以下是记录每部分的分解：")]),s._v(" "),a("p",[s._v("代码片段 5")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[s._v("gc "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2553")]),s._v(" @8.452s "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("14")]),s._v("%: "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.004")]),s._v("+0.33+0.051 ms clock, "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.056")]),s._v("+0.12/0.56/0.94+0.61 ms cpu, "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("4")]),s._v("-"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("4")]),s._v("-"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v(" MB, "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("5")]),s._v(" MB goal, "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("12")]),s._v(" P\n\ngc "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2553")]),s._v("     "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" The "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2553")]),s._v(" GC runs since the program started\n@8.452s     "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" Eight seconds since the program started\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("14")]),s._v("%         "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" Fourteen percent of the available CPU so far has been spent "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("in")]),s._v(" GC\n\n// wall-clock\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(".004ms     "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" STW        "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" Write-Barrier - Wait "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("for")]),s._v(" all Ps to reach a GC safe-point.\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(".33ms      "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" Concurrent "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" Marking\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(".051ms     "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" STW        "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" Mark Term     - Write Barrier off and clean up.\n\n// CPU "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("time")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(".056ms     "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" STW        "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" Write-Barrier\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(".12ms      "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" Concurrent "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" Mark - Assist Time "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("GC performed "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("in")]),s._v(" line with allocation"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(".56ms      "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" Concurrent "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" Mark - Background GC "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("time")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(".94ms      "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" Concurrent "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" Mark - Idle GC "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("time")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(".61ms      "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" STW        "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" Mark Term\n\n4MB         "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" Heap memory in-use before the Marking started\n4MB         "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" Heap memory in-use after the Marking finished\n2MB         "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" Heap memory marked as live after the Marking finished\n5MB         "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" Collection goal "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("for")]),s._v(" heap memory in-use after Marking finished\n\n// Threads\n12P         "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" Number of logical processors or threads used to run Goroutines.\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br"),a("span",{staticClass:"line-number"},[s._v("23")]),a("br"),a("span",{staticClass:"line-number"},[s._v("24")]),a("br"),a("span",{staticClass:"line-number"},[s._v("25")]),a("br")])]),a("p",[s._v("代码片段 5 显示了上次回收的实际次数。借助 "),a("code",[s._v("hey")]),s._v(" 可得以下性能统计结果。")]),s._v(" "),a("p",[s._v("代码片段 6")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[s._v("Requests            "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10,000")]),s._v("\n------------------------------------------------------\nRequests/sec        "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1,882")]),s._v(" r/s   - Hey\nTotal Duration      "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("5")]),s._v(",311ms     - Hey\nPercent Time "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("in")]),s._v(" GC  "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("14")]),s._v("%         - GC Trace\nTotal Collections   "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2,551")]),s._v("       - GC Trace\n------------------------------------------------------\nTotal GC Duration   "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("744")]),s._v(".54ms    - "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("5")]),s._v(",311ms * .14"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\nAverage Pace of GC  "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" ~2.08ms     - "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("5")]),s._v(",311ms / "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2,551")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\nRequests/Collection "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" ~3.98 r/gc  - "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10,000")]),s._v(" / "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2,511")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br")])]),a("p",[s._v("代码片段 6 显示了结果。以下图片还可视化地展示了发生的事情。")]),s._v(" "),a("p",[s._v("图 3\n"),a("img",{attrs:{src:t(564),alt:"profile with GC"}})]),s._v(" "),a("p",[s._v("图 3 可视化地展示了发生的一切。打开后，回收器必须运行约 2.5k 次才能处理掉 10k 个请求。每次回收的平均启动时间约 2.0 ms，执行所有这些回收额外引入了约 1.1 秒（ 5311 ms - 4188 ms）的延时。")]),s._v(" "),a("p",[s._v("图 4\n"),a("img",{attrs:{src:t(565),alt:"profile comparison for no-GC and GC"}})]),s._v(" "),a("p",[s._v("图 4 是比较到目前为止的两次程序运行的结果。")]),s._v(" "),a("h2",{attrs:{id:"减少内存分配"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#减少内存分配"}},[s._v("#")]),s._v(" 减少内存分配")]),s._v(" "),a("p",[s._v("获取堆的使用概况是非常有用的。它使得我们能够找出是否有能够移除的低效的内存分配操作。")]),s._v(" "),a("p",[s._v("代码片段 7")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[s._v("go tool pprof http://localhost:5000/debug/pprof/allocs\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("p",[s._v("代码片段 7 演示了使用 "),a("code",[s._v("pprof")]),s._v(" 工具从 "),a("code",[s._v("/debug/pprof/allocs")]),s._v(" 端点拉取一份运行中程序的内存概况描述文件。这个端点的存在源自以下代码。")]),s._v(" "),a("p",[s._v("代码片段 8")]),s._v(" "),a("div",{staticClass:"language-go line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-go"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("import")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("_")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"net/http/pprof"')]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("go")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("func")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    http"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("ListenAndServe")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"localhost:5000"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" http"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("DefaultServeMux"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br")])]),a("p",[s._v("代码片段 8 展示了如何将 "),a("code",[s._v("/debug/pprof/allocs")]),s._v(" 端点关联到任意程序。导入 "),a("code",[s._v("net/http/pprof")]),s._v(" 将这个端点关联到默认的服务器多路选择器。然后使用对 "),a("code",[s._v("http.DefaultServerMux")]),s._v(" 常量使用 "),a("code",[s._v("http.ListenAndServe")]),s._v(" 来开放这个端口。")]),s._v(" "),a("p",[s._v("代码片段 9")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("pprof"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("top")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("6")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-cum")]),s._v("\nShowing nodes accounting "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("for")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(".56GB, "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("5.84")]),s._v("% of "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("9")]),s._v(".56GB total\nDropped "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("80")]),s._v(" nodes "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("cum "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(".05GB"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\nShowing "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("top")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("6")]),s._v(" nodes out of "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("51")]),s._v("\n      flat  flat%   sum%        cum   cum%\n         "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("     "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("%     "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("%     "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("4")]),s._v(".96GB "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("51.90")]),s._v("%  net/http."),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("*conn"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(".serve\n    "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(".49GB  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("5.11")]),s._v("%  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("5.11")]),s._v("%     "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("4")]),s._v(".93GB "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("51.55")]),s._v("%  project/service.handler\n         "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("     "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("%  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("5.11")]),s._v("%     "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("4")]),s._v(".93GB "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("51.55")]),s._v("%  net/http."),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("*ServeMux"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(".ServeHTTP\n         "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("     "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("%  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("5.11")]),s._v("%     "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("4")]),s._v(".93GB "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("51.55")]),s._v("%  net/http.HandlerFunc.ServeHTTP\n         "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("     "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("%  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("5.11")]),s._v("%     "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("4")]),s._v(".93GB "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("51.55")]),s._v("%  net/http.serverHandler.ServeHTTP\n    "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(".07GB  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.73")]),s._v("%  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("5.84")]),s._v("%     "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("4")]),s._v(".55GB "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("47.63")]),s._v("%  project/search.rssSearch\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br")])]),a("p",[s._v("代码片段 9 显示列表最后出现了 "),a("code",[s._v("rssSearch")]),s._v(" 函数。这个函数申请了到目前为止总内存 4.96 GB （译者注：原文写错了 5.96 GB）中的 4.55 GB。接下来就得用 "),a("code",[s._v("list")]),s._v(" 命令看看 "),a("code",[s._v("rssSearch")]),s._v(" 函数的细节了。")]),s._v(" "),a("p",[s._v("代码片段 10")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("pprof"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" list rssSearch\nTotal: "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("9")]),s._v(".56GB\nROUTINE "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("==")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("==")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("==")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("==")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("==")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("==")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("==")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("==")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("==")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("==")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("==")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("==")]),s._v(" project/search.rssSearch "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("in")]),s._v(" project/search/rss.go\n   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("71")]),s._v(".53MB     "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("4")]),s._v(".55GB "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("flat, cum"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("47.63")]),s._v("% of Total\n\n\n         "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(".")]),s._v("          "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(".")]),s._v("    "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("117")]),s._v(":\t// Capture the data we need "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("for")]),s._v(" our results "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" we "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("find")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),s._v(".\n         "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(".")]),s._v("          "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(".")]),s._v("    "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("118")]),s._v(":\t"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("for")]),s._v(" _, item :"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" range d.Channel.Items "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n         "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(".")]),s._v("     "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("4")]),s._v(".48GB    "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("119")]),s._v(":\t\t"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" strings.Contains"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("strings.ToLower"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("item.Description"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(", strings.ToLower"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("term"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("))")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("48")]),s._v(".53MB    "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("48")]),s._v(".53MB    "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("120")]),s._v(":\t\t\tresults "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" append"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("results, Result"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n         "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(".")]),s._v("          "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(".")]),s._v("    "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("121")]),s._v(":\t\t\t\tEngine:  engine,\n         "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(".")]),s._v("          "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(".")]),s._v("    "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("122")]),s._v(":\t\t\t\tTitle:   item.Title,\n         "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(".")]),s._v("          "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(".")]),s._v("    "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("123")]),s._v(":\t\t\t\tLink:    item.Link,\n         "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(".")]),s._v("          "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(".")]),s._v("    "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("124")]),s._v(":\t\t\t\tContent: item.Description,\n         "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(".")]),s._v("          "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(".")]),s._v("    "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("125")]),s._v(":\t\t\t"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br")])]),a("p",[s._v("代码片段 10 展示了代码片段。第 199 行占据了大部分内存分配。")]),s._v(" "),a("p",[s._v("代码片段 11")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[s._v("        "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(".")]),s._v("     "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("4")]),s._v(".48GB    "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("119")]),s._v(":\t\t"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" strings.Contains"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("strings.ToLower"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("item.Description"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(", strings.ToLower"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("term"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("))")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("p",[s._v("代码片段展示了关键的这行代码。此行申请的这个函数目前申请总内存 4.55 GB 中的 4.48 GB。所以，是时候看看我们能够对这行代码做点啥了。")]),s._v(" "),a("p",[s._v("代码片段 12")]),s._v(" "),a("div",{staticClass:"language-go line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-go"}},[a("code",[a("span",{pre:!0,attrs:{class:"token number"}},[s._v("117")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// Capture the data we need for our results if we find the search term.")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("118")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("for")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("_")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" item "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("range")]),s._v(" d"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("Channel"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("Items "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("119")]),s._v("     "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" strings"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("Contains")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("strings"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("ToLower")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("item"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("Description"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" strings"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("ToLower")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("term"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("120")]),s._v("         results "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("append")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("results"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" Result"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("121")]),s._v("             Engine"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("  engine"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("122")]),s._v("             Title"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("   item"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("Title"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("123")]),s._v("             Link"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("    item"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("Link"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("124")]),s._v("             Content"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" item"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("Description"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("125")]),s._v("        "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("126")]),s._v("    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("127")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br")])]),a("p",[s._v("代码片段 12 显示这行代码身处一个难分难解的循环。"),a("code",[s._v("strings.ToLower")]),s._v(" 会创建需要在堆上开辟内存的新字符串，所以其调用触发了内存分配。这些 "),a("code",[s._v("strings.ToLower")]),s._v(" 的调用是非必要的，它们完全可以放在循环外面做。")]),s._v(" "),a("p",[s._v("我们可以改写第 119 行来移除这些内存分配。")]),s._v(" "),a("p",[s._v("代码片段 13")]),s._v(" "),a("div",{staticClass:"language-go line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-go"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// Before the code change.")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" strings"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("Contains")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("strings"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("ToLower")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("item"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("Description"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" strings"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("ToLower")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("term"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// After the code change.")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" strings"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("Contains")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("item"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("Description"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" term"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br")])]),a("blockquote",[a("p",[s._v("注意了：这里没放出来的其他变化是把提要（feed）放入缓存前将 "),a("code",[s._v("Description")]),s._v(" 字段变成小写。新闻提要每 15 分钟缓存一次。把 "),a("code",[s._v("term")]),s._v(" 变成小写的调用在循环外不远处执行。")])]),s._v(" "),a("p",[s._v("代码片段 13 移除了 "),a("code",[s._v("strings.ToLower")]),s._v("的调用。代码改写后，项目重新构建，10k 个请求再次扔给服务器。")]),s._v(" "),a("p",[s._v("代码片段 14")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[s._v("$ go build\n$ "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("GODEBUG")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("gctrace"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" ./project "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" /dev/null\ngc "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("3")]),s._v(" @6.156s "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("%: "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.011")]),s._v("+0.72+0.068 ms clock, "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.13")]),s._v("+0.21/1.5/3.2+0.82 ms cpu, "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("4")]),s._v("-"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("4")]),s._v("-"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v(" MB, "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("5")]),s._v(" MB goal, "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("12")]),s._v(" P\n"),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(".")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(".")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(".")]),s._v("\ngc "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1404")]),s._v(" @8.808s "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("7")]),s._v("%: "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.005")]),s._v("+0.54+0.059 ms clock, "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.060")]),s._v("+0.47/0.79/0.25+0.71 ms cpu, "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("4")]),s._v("-"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("5")]),s._v("-"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v(" MB, "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("5")]),s._v(" MB goal, "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("12")]),s._v(" P\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br")])]),a("p",[s._v("代码片段 14 显示了代码改写后，处理同样的 10k 个请求现在需要 1402 次垃圾回收。以下是两次运行的完整结果。")]),s._v(" "),a("p",[s._v("代码片段 15")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[s._v("With Extra Allocations              Without Extra Allocations\n"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("==")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("==")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("==")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("==")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("==")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("==")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("==")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("==")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("==")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("==")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("==")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("==")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("==")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("==")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("==")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("==")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("==")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("==")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("==")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("==")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("==")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("==")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("==")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("==")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("==")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("==")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("==")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("==")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("==")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("==")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("==")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("==")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("==")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("==")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("==")]),s._v("\nRequests            "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10,000")]),s._v("        Requests            "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10,000")]),s._v("\n----------------------------------------------------------------------\nRequests/sec        "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1,882")]),s._v(" r/s     Requests/sec        "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("3,631")]),s._v(" r/s\nTotal Duration      "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("5")]),s._v(",311ms       Total Duration      "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2,753")]),s._v(" ms\nPercent Time "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("in")]),s._v(" GC  "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("14")]),s._v("%           Percent Time "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("in")]),s._v(" GC  "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("7")]),s._v("%\nTotal Collections   "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2,551")]),s._v("         Total Collections   "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1,402")]),s._v("\n----------------------------------------------------------------------\nTotal GC Duration   "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("744")]),s._v(".54ms      Total GC Duration   "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.71")]),s._v(" ms\nAverage Pace of GC  "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" ~2.08ms       Average Pace of GC  "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" ~1.96ms\nRequests/Collection "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" ~3.98 r/gc    Requests/Collection "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("7.13")]),s._v(" r/gc\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br")])]),a("p",[s._v("代码片段 15 比较了这次运行和上次运行。以下图片更是可视化展示发生的事情。")]),s._v(" "),a("p",[s._v("图 5\n"),a("img",{attrs:{src:t(566),alt:"profile comparison for GC and optimized-GC"}})]),s._v(" "),a("p",[s._v("图 5 可视化地展示发生的一切。为了处理同样的 10k 个请求，这次回收器少跑了 1149 次（2551 - 1402）。这使得 GC 的时间占比从 14% 降到 7%。结果是程序快了 48%，在垃圾回收上节省了 74%的时间。")]),s._v(" "),a("p",[s._v("图 6\n"),a("img",{attrs:{src:t(567),alt:"profile comparison for all"}})]),s._v(" "),a("p",[s._v("图 6 对比了不同条件程序的运行结果。为了完整性，我还加入了关闭垃圾回收器后运行优化的代码的结果。")]),s._v(" "),a("h2",{attrs:{id:"心得"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#心得"}},[s._v("#")]),s._v(" 心得")]),s._v(" "),a("p",[s._v("如 "),a("RouterLink",{attrs:{to:"/_post/garbage-collection-in-go/part1-semantics/"}},[s._v("上一篇博文")]),s._v(" 所言，对回收器好一点就是少点给对压力。还记得吧：压力定义为给定时间内应用程序在堆上开辟内存的速度。压力降低时，回收器附带的时延也会降低。正是这些延时拖慢你的程序的。")],1),s._v(" "),a("p",[s._v("而不是减缓回收的节奏。真正有效的是在每次回收之间或过程中完成更多工作。我们可以通过减少每项工作在堆上开辟的内存大小次数来实施自己的影响。")]),s._v(" "),a("p",[s._v("代码片段 16")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[s._v("With Extra Allocations              Without Extra Allocations\n"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("==")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("==")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("==")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("==")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("==")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("==")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("==")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("==")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("==")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("==")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("==")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("==")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("==")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("==")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("==")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("==")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("==")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("==")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("==")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("==")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("==")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("==")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("==")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("==")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("==")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("==")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("==")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("==")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("==")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("==")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("==")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("==")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("==")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("==")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("==")]),s._v("\nRequests            "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10,000")]),s._v("        Requests            "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10,000")]),s._v("\n----------------------------------------------------------------------\nRequests/sec        "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1,882")]),s._v(" r/s     Requests/sec        "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("3,631")]),s._v(" r/s\nTotal Duration      "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("5")]),s._v(",311ms       Total Duration      "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2,753")]),s._v(" ms\nPercent Time "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("in")]),s._v(" GC  "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("14")]),s._v("%           Percent Time "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("in")]),s._v(" GC  "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("7")]),s._v("%\nTotal Collections   "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2,551")]),s._v("         Total Collections   "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1,402")]),s._v("\n----------------------------------------------------------------------\nTotal GC Duration   "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("744")]),s._v(".54ms      Total GC Duration   "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.71")]),s._v(" ms\nAverage Pace of GC  "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" ~2.08ms       Average Pace of GC  "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" ~1.96ms\nRequests/Collection "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" ~3.98 r/gc    Requests/Collection "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("7.13")]),s._v(" r/gc\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br")])]),a("p",[s._v("代码片段 16 对比了打开垃圾回收器的两版应用程序。移除了 4.48 GB 的内存分配操作后明显地加速了程序的运行。有趣的是，（两个版本）每次回收的平均节奏基本一致，都约为 2.0 ms。本质上变化的是两个版本在回收之间完成的任务量。程序的请求处理速度从 3.98 r/s 上升到 7.13 r/s，实现了 79.1% 的任务完成量增长。")]),s._v(" "),a("p",[s._v("在任意两次回收之间完成更多工作使得需要的回收次数从 2,551 降到 1,402，降幅高达 45%。启用垃圾回收的两版程序改写下来，我们见证了 GC 总时间从 745 ms 降到 193 ms，降幅 74%，占用总运行时间的比例也从 14% 降到 7%。如果关闭垃圾回收器来运行优化过的代码，性能差距只有 13%，程序的运行时间从 2,753 ms 降到 2,398 ms。")]),s._v(" "),a("h2",{attrs:{id:"结论"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#结论"}},[s._v("#")]),s._v(" 结论")]),s._v(" "),a("p",[s._v("如果能在减少内存分配花费心思，你做得正是一个 Go 开发者能够支持垃圾回收器的份内事。我们不可能写出不用分配内存的应用，因此，分辨出有效的（能够帮助应用程序的）和无效的（有损应用程序的）的内存分配是非常重要的。然后，对垃圾回收器保持堆内存健康和程序稳定运行抱有信心和信任即可。")]),s._v(" "),a("p",[s._v("引入垃圾回收器是一个很漂亮的折衷权衡。我会接受垃圾回收的代价，这样就不用困扰于内存管理的负担。Go 想要的是允许作为开发者的我们有效工作的同时写出足够快的应用程序。垃圾回收器是支撑这个现实的重要部分。"),a("RouterLink",{attrs:{to:"/_post/garbage-collection-in-go/part3-gcpacing/"}},[s._v("下一篇博文")]),s._v(" 会分享另一个程序，用来演示回收器如何分析 Go 应用程序并找到最优的回收路径。")],1)])}),[],!1,null,null,null);a.default=e.exports}}]);