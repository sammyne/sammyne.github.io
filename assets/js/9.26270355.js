(window.webpackJsonp=window.webpackJsonp||[]).push([[9],{579:function(s,a,t){s.exports=t.p+"assets/img/conventional.0a6a0ccd.png"},580:function(s,a,t){s.exports=t.p+"assets/img/beats.87a4815d.png"},581:function(s,a,t){s.exports=t.p+"assets/img/elk-with-beats.74b12524.png"},582:function(s,a,t){s.exports=t.p+"assets/img/kibana-overview.1e502e99.png"},583:function(s,a,t){s.exports=t.p+"assets/img/kibana-discover-without-filebeat.2ac8a1f6.png"},584:function(s,a,t){s.exports=t.p+"assets/img/kibana-index-pattern.18e34c0e.png"},585:function(s,a,t){s.exports=t.p+"assets/img/kibana-create-index-pattern.950a332c.png"},586:function(s,a,t){s.exports=t.p+"assets/img/kibana-define-index-pattern.d791c85f.png"},587:function(s,a,t){s.exports=t.p+"assets/img/kibana-set-time-field.d7681b1c.png"},588:function(s,a,t){s.exports=t.p+"assets/img/kibana-filebeat-log.10fa4b99.png"},589:function(s,a,t){s.exports=t.p+"assets/img/kibana-message-glimpse.b7d74e38.png"},590:function(s,a,t){s.exports=t.p+"assets/img/kibana-filter-message.f3ebe1b1.png"},591:function(s,a,t){s.exports=t.p+"assets/img/kibana-message-only.5c67f300.png"},592:function(s,a,t){s.exports=t.p+"assets/img/kibana-filter-using-lucene.1781ab22.png"},728:function(s,a,t){"use strict";t.r(a);var e=t(6),n=Object(e.a)({},(function(){var s=this,a=s.$createElement,e=s._self._c||a;return e("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[e("p",[e("a",{attrs:{href:"/2021/02/16/docker-logging-01-logs-cmd-and-drivers"}},[s._v("上一篇文章")]),s._v(" 介绍了 Docker 自带的 "),e("code",[s._v("logs")]),s._v(" 子命令以及其 "),e("code",[s._v("logging driver")]),s._v("。本文将会介绍一个流行的开源日志管理方案 ELK。")]),s._v(" "),e("h2",{attrs:{id:"关于-elk"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#关于-elk"}},[s._v("#")]),s._v(" 关于 ELK")]),s._v(" "),e("h3",{attrs:{id:"简介"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#简介"}},[s._v("#")]),s._v(" 简介")]),s._v(" "),e("p",[s._v("ELK 是 "),e("a",{attrs:{href:"https://www.elastic.co/cn/",target:"_blank",rel:"noopener noreferrer"}},[s._v("Elastic 公司"),e("OutboundLink")],1),s._v(" 提供的一套完整的日志收集以及展示的解决方案，名称由三个产品 ElasticSearch、Logstash 和 Kibana 的首字母缩写而成。")]),s._v(" "),e("ul",[e("li",[s._v("Elasticsearch 是实时全文搜索和分析引擎，提供搜集、分析、存储数据三大功能")]),s._v(" "),e("li",[s._v("Logstash 是一个用来搜集、分析、过滤日志的工具")]),s._v(" "),e("li",[s._v("Kibana 是一个基于 Web 的图形界面，用于搜索、分析和可视化存储在 Elasticsearch 指标中的日志数据")])]),s._v(" "),e("h3",{attrs:{id:"elk-日志处理流程"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#elk-日志处理流程"}},[s._v("#")]),s._v(" ELK 日志处理流程")]),s._v(" "),e("p",[e("img",{attrs:{src:t(579),alt:""}})]),s._v(" "),e("p",[s._v("上图展示了 Docker 环境下一个典型的 ELK 方案下的日志收集处理流程：")]),s._v(" "),e("ol",[e("li",[s._v("Logstash 从各个 Docker 容器提取日志信息")]),s._v(" "),e("li",[s._v("Logstash 将日志转发到 ElasticSearch 进行索引和保存")]),s._v(" "),e("li",[s._v("Kibana 负责分析和可视化日志信息")])]),s._v(" "),e("p",[s._v("由于 Logstash 在数据收集上并不出色，而且作为 Agent 时的性能并不达标。因此，Elastic 发布了 beats 系列轻量级采集组件。")]),s._v(" "),e("p",[e("img",{attrs:{src:t(580),alt:""}})]),s._v(" "),e("p",[s._v("这里我们要实验的 Beat 组件是 Filebeat。Filebeat 是构建于 beats 之上的，服务于日志收集场景，用来替代 Logstash Forwarder 的下一代 Logstash 收集器，可以更快速稳定、轻量低耗地进行收集工作，很方便地与 Logstash 还有直接与 Elasticsearch 进行对接。")]),s._v(" "),e("p",[s._v("本次实验直接使用 Filebeat 作为 Agent，它会收集 "),e("a",{attrs:{href:"/2021/02/16/docker-logging-01-logs-cmd-and-drivers"}},[s._v("上一篇文章")]),s._v(" 所介绍 json-file 格式 log 文件的记录变动，并直接将日志发给 ElasticSearch 进行索引和保存，其处理流程变为下图，也可以称之为 EFK。")]),s._v(" "),e("p",[e("img",{attrs:{src:t(581),alt:""}})]),s._v(" "),e("h2",{attrs:{id:"elk-套件的安装"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#elk-套件的安装"}},[s._v("#")]),s._v(" ELK 套件的安装")]),s._v(" "),e("p",[s._v("本次实验采用 Docker 方式部署一个最小规模的 ELK 运行环境。实际环境或许需要考虑高可用和负载均衡。")]),s._v(" "),e("p",[s._v("首先拉取镜像 "),e("a",{attrs:{href:"https://hub.docker.com/layers/sebp/elk/7.10.0/images/sha256-9fe89b0d9a5adf4cda32b9b88b176f3d8854c6311f8f49ab82d21432ee1391be?context=explore",target:"_blank",rel:"noopener noreferrer"}},[s._v("sebp/elk:7.10.0"),e("OutboundLink")],1),s._v("：")]),s._v(" "),e("blockquote",[e("p",[s._v("实验时能够找到的最新版本是 7.10.0。")])]),s._v(" "),e("div",{staticClass:"language-bash line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[s._v("docker pull sebp/elk:7.10.0\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br")])]),e("blockquote",[e("p",[s._v("注：由于包含整个 ELK 环境导致镜像较大，需要耐心等待。")])]),s._v(" "),e("p",[s._v("通过以下命令使用 "),e("a",{attrs:{href:"https://hub.docker.com/layers/sebp/elk/7.10.0/images/sha256-9fe89b0d9a5adf4cda32b9b88b176f3d8854c6311f8f49ab82d21432ee1391be?context=explore",target:"_blank",rel:"noopener noreferrer"}},[s._v("sebp/elk:7.10.0"),e("OutboundLink")],1),s._v(" 镜像启动运行 ELK：")]),s._v(" "),e("div",{staticClass:"language-bash line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 为了迎合本人的实验环境，端口作了重定向")]),s._v("\ndocker run -it -d --name elk  "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n  -p "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("8601")]),s._v(":5601                "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n  -p "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("8200")]),s._v(":9200                "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n  -p "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("8044")]),s._v(":5044                "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n  sebp/elk:7.10.0\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br")])]),e("p",[s._v("执行完成之后可以先访问一下 "),e("code",[s._v("http://[Your-HostIP]:8601")]),s._v(" 看看 Kibana 的效果如下")]),s._v(" "),e("blockquote",[e("p",[s._v("注：实验环境的 ES 服务所在机器 IP 为 "),e("code",[s._v("10.176.161.147")]),s._v("。")])]),s._v(" "),e("p",[e("img",{attrs:{src:t(582),alt:"Kibana 管理界面"}})]),s._v(" "),e("p",[s._v("可见目前没有任何可以显示的 ES 索引和数据，再访问一下 "),e("code",[s._v("http://[Your-HostIP]:8200")]),s._v(" 看看 ElasticSearch 的 API 接口是否可用：")]),s._v(" "),e("div",{staticClass:"language-bash line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[e("span",{pre:!0,attrs:{class:"token function"}},[s._v("curl")]),s._v(" http://10.176.161.147:8200/\n\n"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n  "),e("span",{pre:!0,attrs:{class:"token string"}},[s._v('"name"')]),s._v(" "),e("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[s._v('"elk"')]),s._v(",\n  "),e("span",{pre:!0,attrs:{class:"token string"}},[s._v('"cluster_name"')]),s._v(" "),e("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[s._v('"elasticsearch"')]),s._v(",\n  "),e("span",{pre:!0,attrs:{class:"token string"}},[s._v('"cluster_uuid"')]),s._v(" "),e("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[s._v('"v9PcHOThR1ikUgyweOOh3w"')]),s._v(",\n  "),e("span",{pre:!0,attrs:{class:"token string"}},[s._v('"version"')]),s._v(" "),e("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),e("span",{pre:!0,attrs:{class:"token string"}},[s._v('"number"')]),s._v(" "),e("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[s._v('"7.10.0"')]),s._v(",\n    "),e("span",{pre:!0,attrs:{class:"token string"}},[s._v('"build_flavor"')]),s._v(" "),e("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[s._v('"default"')]),s._v(",\n    "),e("span",{pre:!0,attrs:{class:"token string"}},[s._v('"build_type"')]),s._v(" "),e("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[s._v('"tar"')]),s._v(",\n    "),e("span",{pre:!0,attrs:{class:"token string"}},[s._v('"build_hash"')]),s._v(" "),e("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[s._v('"51e9d6f22758d0374a0f3f5c6e8f3a7997850f96"')]),s._v(",\n    "),e("span",{pre:!0,attrs:{class:"token string"}},[s._v('"build_date"')]),s._v(" "),e("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[s._v('"2020-11-09T21:30:33.964949Z"')]),s._v(",\n    "),e("span",{pre:!0,attrs:{class:"token string"}},[s._v('"build_snapshot"')]),s._v(" "),e("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" false,\n    "),e("span",{pre:!0,attrs:{class:"token string"}},[s._v('"lucene_version"')]),s._v(" "),e("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[s._v('"8.7.0"')]),s._v(",\n    "),e("span",{pre:!0,attrs:{class:"token string"}},[s._v('"minimum_wire_compatibility_version"')]),s._v(" "),e("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[s._v('"6.8.0"')]),s._v(",\n    "),e("span",{pre:!0,attrs:{class:"token string"}},[s._v('"minimum_index_compatibility_version"')]),s._v(" "),e("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[s._v('"6.0.0-beta1"')]),s._v("\n  "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v(",\n  "),e("span",{pre:!0,attrs:{class:"token string"}},[s._v('"tagline"')]),s._v(" "),e("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[s._v('"You Know, for Search"')]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br"),e("span",{staticClass:"line-number"},[s._v("11")]),e("br"),e("span",{staticClass:"line-number"},[s._v("12")]),e("br"),e("span",{staticClass:"line-number"},[s._v("13")]),e("br"),e("span",{staticClass:"line-number"},[s._v("14")]),e("br"),e("span",{staticClass:"line-number"},[s._v("15")]),e("br"),e("span",{staticClass:"line-number"},[s._v("16")]),e("br"),e("span",{staticClass:"line-number"},[s._v("17")]),e("br"),e("span",{staticClass:"line-number"},[s._v("18")]),e("br"),e("span",{staticClass:"line-number"},[s._v("19")]),e("br")])]),e("div",{staticClass:"custom-block tip"},[e("p",{staticClass:"title"},[s._v("温馨提示")]),e("p",[s._v("如果启动过程的一些错误导致 ELK 容器无法启动，可以参考 "),e("a",{attrs:{href:"https://www.cnblogs.com/zhi-leaf/p/8484337.html",target:"_blank",rel:"noopener noreferrer"}},[s._v("ElasticSearch启动常见错误"),e("OutboundLink")],1),s._v(" 和 "),e("a",{attrs:{href:"https://elk-docker.readthedocs.io/",target:"_blank",rel:"noopener noreferrer"}},[s._v("Elasticsearch, Logstash, Kibana (ELK) Docker image documentation"),e("OutboundLink")],1),s._v(" 等文章。主机内存低于 4G 的话，建议限制 ES 内存的使用大小，以免启动不了。例如下面增加的配置，限制 ES 内存使用最大为 1G：")]),s._v(" "),e("div",{staticClass:"language-bash line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[s._v("docker run -it -d --name elk  "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n  -p "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("8601")]),s._v(":5601                "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n  -p "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("8200")]),s._v(":9200                "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n  -p "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("8044")]),s._v(":5044                "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n　-e "),e("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("ES_MIN_MEM")]),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("512m          "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n  -e "),e("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("ES_MAX_MEM")]),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("1024m         "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n  sebp/elk:7.10.0\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br")])])]),e("h2",{attrs:{id:"filebeat"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#filebeat"}},[s._v("#")]),s._v(" Filebeat")]),s._v(" "),e("h3",{attrs:{id:"安装"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#安装"}},[s._v("#")]),s._v(" 安装")]),s._v(" "),e("p",[s._v("本实验以容器的方式运行和以上 ELK 版本一致的 Filebeat，所以拉取容器镜像如下：")]),s._v(" "),e("div",{staticClass:"language-bash line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[s._v("docker pull docker.elastic.co/beats/filebeat:7.10.0\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br")])]),e("h3",{attrs:{id:"配置"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#配置"}},[s._v("#")]),s._v(" 配置")]),s._v(" "),e("p",[s._v("配置的作用主要是告诉 Filebeat 要监控哪些日志文件以及将日志发送到哪里去。本实验的配置文件 "),e("code",[s._v("filebeat.docker.yml")]),s._v(" 如下，主要监控 docker 容器的日志。")]),s._v(" "),e("div",{staticClass:"language-yaml line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-yaml"}},[e("code",[e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("filebeat.config")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("modules")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("path")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" $"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("path.config"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("/modules.d/"),e("span",{pre:!0,attrs:{class:"token important"}},[s._v("*.yml")]),s._v("\n    "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("reload.enabled")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token boolean important"}},[s._v("false")]),s._v("\n\n"),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("filebeat.inputs")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("type")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" docker\n  "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("containers.ids")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[s._v("'*'")]),s._v("\n\n"),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("processors")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("add_cloud_metadata")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token null important"}},[s._v("~")]),s._v("\n  "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("add_docker_metadata")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token null important"}},[s._v("~")]),s._v("\n\n"),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("output.elasticsearch")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("hosts")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[s._v("'${ELASTICSEARCH_HOSTS:elasticsearch:9200}'")]),s._v("\n  "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("username")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[s._v("'${ELASTICSEARCH_USERNAME:}'")]),s._v("\n  "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("password")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[s._v("'${ELASTICSEARCH_PASSWORD:}'")]),s._v("\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br"),e("span",{staticClass:"line-number"},[s._v("11")]),e("br"),e("span",{staticClass:"line-number"},[s._v("12")]),e("br"),e("span",{staticClass:"line-number"},[s._v("13")]),e("br"),e("span",{staticClass:"line-number"},[s._v("14")]),e("br"),e("span",{staticClass:"line-number"},[s._v("15")]),e("br"),e("span",{staticClass:"line-number"},[s._v("16")]),e("br"),e("span",{staticClass:"line-number"},[s._v("17")]),e("br")])]),e("blockquote",[e("p",[s._v("详细的配置说明参见 "),e("a",{attrs:{href:"https://www.elastic.co/guide/en/beats/filebeat/7.10/filebeat-reference-yml.html",target:"_blank",rel:"noopener noreferrer"}},[s._v("filebeat.reference.yml"),e("OutboundLink")],1)])]),s._v(" "),e("ul",[e("li",[e("code",[s._v("${xxx}")]),s._v(" 分割的字符串会被默认值或者后续的命令行参数覆盖")])]),s._v(" "),e("h3",{attrs:{id:"启动"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#启动"}},[s._v("#")]),s._v(" 启动")]),s._v(" "),e("p",[s._v("启动前点击 Kibana 的 disocver 面板会发现看不到任何日志。")]),s._v(" "),e("p",[e("img",{attrs:{src:t(583),alt:""}})]),s._v(" "),e("p",[s._v("启动 filebeat 服务")]),s._v(" "),e("div",{staticClass:"language-bash line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[e("span",{pre:!0,attrs:{class:"token shebang important"}},[s._v("#!/bin/bash")]),s._v("\n\n"),e("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("elkIP")]),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),e("span",{pre:!0,attrs:{class:"token variable"}},[e("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$(")]),s._v("docker inspect elk -f "),e("span",{pre:!0,attrs:{class:"token string"}},[s._v("'{{range.NetworkSettings.Networks}}{{.IPAddress}}{{end}}'")]),s._v(" elk "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("tail")]),s._v(" -n1"),e("span",{pre:!0,attrs:{class:"token variable"}},[s._v(")")])]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#echo $elkIP")]),s._v("\n\n"),e("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("app")]),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("filebeat\n\ndocker "),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("rm")]),s._v(" -f "),e("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$app")]),s._v("\n\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# --user=root 指定默认用户为 root，否则会报无权限读取 /var/lib/docker/containers 目录")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# -E setup.kibana.host=$elkIP:8601 设置 kibana 的网络地址")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v('# -E output.elasticsearch.hosts=["$elkIP:9200"] 指定 ES 服务的网络地址')]),s._v("\ndocker run -d                                                     "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n  --name "),e("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$app")]),s._v("                                                     "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n  --user"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("root                                                     "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n  -v "),e("span",{pre:!0,attrs:{class:"token environment constant"}},[s._v("$PWD")]),s._v("/filebeat.docker.yml:/usr/share/filebeat/filebeat.yml:ro "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n  -v /var/lib/docker/containers:/var/lib/docker/containers:ro     "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n  docker.elastic.co/beats/filebeat:7.10.0                         "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n  --strict.perms"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("false                                            "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n  -E setup.kibana.host"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),e("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$elkIP")]),s._v(":8601                                "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n  -E output.elasticsearch.hosts"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),e("span",{pre:!0,attrs:{class:"token string"}},[s._v('"'),e("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$elkIP")]),s._v(':9200"')]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br"),e("span",{staticClass:"line-number"},[s._v("11")]),e("br"),e("span",{staticClass:"line-number"},[s._v("12")]),e("br"),e("span",{staticClass:"line-number"},[s._v("13")]),e("br"),e("span",{staticClass:"line-number"},[s._v("14")]),e("br"),e("span",{staticClass:"line-number"},[s._v("15")]),e("br"),e("span",{staticClass:"line-number"},[s._v("16")]),e("br"),e("span",{staticClass:"line-number"},[s._v("17")]),e("br"),e("span",{staticClass:"line-number"},[s._v("18")]),e("br"),e("span",{staticClass:"line-number"},[s._v("19")]),e("br"),e("span",{staticClass:"line-number"},[s._v("20")]),e("br"),e("span",{staticClass:"line-number"},[s._v("21")]),e("br")])]),e("blockquote",[e("p",[s._v("相关的官方文档参见："),e("a",{attrs:{href:"https://www.elastic.co/guide/en/beats/filebeat/7.10/running-on-docker.html",target:"_blank",rel:"noopener noreferrer"}},[s._v("Run Filebeat on Docker"),e("OutboundLink")],1),s._v(" 和 "),e("a",{attrs:{href:"https://www.elastic.co/guide/en/beats/filebeat/7.10/command-line-options.html",target:"_blank",rel:"noopener noreferrer"}},[s._v("Filebeat command reference"),e("OutboundLink")],1)])]),s._v(" "),e("h3",{attrs:{id:"验证"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#验证"}},[s._v("#")]),s._v(" 验证")]),s._v(" "),e("p",[s._v("重新打开 kibana 的 discover 面板，发现依然没看到日志 = =")]),s._v(" "),e("p",[e("img",{attrs:{src:t(584),alt:""}})]),s._v(" "),e("p",[s._v("咋回事嘞？其实 Kibana 还需要配置一个叫做 index pattern 的东西，用于显示匹配特定模式的日志。")]),s._v(" "),e("h3",{attrs:{id:"kibana-配置"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#kibana-配置"}},[s._v("#")]),s._v(" Kibana 配置")]),s._v(" "),e("p",[s._v("接下来告诉 Kibana 要查询和分析 ElasticSearch 的哪些日志，因此需要配置一个 index pattern。Filebeat 的日志索引格式是 filebeat-timestamp 这种格式，操作如下")]),s._v(" "),e("ol",[e("li",[s._v("点击 "),e("code",[s._v("Create index pattern")]),s._v(" 按钮，定义 index pattern 为 "),e("code",[s._v("filebeat-*")])])]),s._v(" "),e("p",[e("img",{attrs:{src:t(585),alt:"点击  按钮"}})]),s._v(" "),e("p",[e("img",{attrs:{src:t(586),alt:"定义 index pattern"}})]),s._v(" "),e("ol",{attrs:{start:"2"}},[e("li",[s._v("点击 "),e("code",[s._v("Next Step")]),s._v("，选择 "),e("code",[s._v("Time field")]),s._v(" 为 "),e("code",[s._v("@timestamp")]),s._v("，并单击 "),e("code",[s._v("Create index pattern")]),s._v(" 按钮完成配置")])]),s._v(" "),e("p",[e("img",{attrs:{src:t(587),alt:"设置  为 "}})]),s._v(" "),e("p",[s._v("这时再单击 Kibana 左侧的 Discover 面板，即可看到容器的日志信息啦~")]),s._v(" "),e("p",[e("img",{attrs:{src:t(588),alt:""}})]),s._v(" "),e("p",[s._v("我们仔细瞅一下 "),e("code",[s._v("message")]),s._v(" 字段：")]),s._v(" "),e("p",[e("img",{attrs:{src:t(589),alt:""}})]),s._v(" "),e("p",[s._v("筛选一下只看这个 "),e("code",[s._v("message")]),s._v(" 字段的信息：")]),s._v(" "),e("p",[e("img",{attrs:{src:t(590),alt:"选定要显示的字段为 message"}})]),s._v(" "),e("p",[e("img",{attrs:{src:t(591),alt:"只显示 message 字段"}})]),s._v(" "),e("p",[s._v("此外，Kibana 还提供搜索关键词的日志功能。例如将查询模式从 KQL 转成 Lucene，筛选出包含 "),e("code",[s._v('"2021-02-16T09:45:19Z"')]),s._v(" 的日志信息：")]),s._v(" "),e("p",[e("img",{attrs:{src:t(592),alt:"使用 Lucene 过滤包含特定子串的日志"}})]),s._v(" "),e("p",[s._v("这里只展示了导入 ELK 的日志信息，实际上 ELK 还有很多很丰富的玩法，例如分析聚合、炫酷 Dashboard 等等。感兴趣的话，自己动手试试吧~")]),s._v(" "),e("p",[s._v("日志格式可是普通的纯文本输出，也可以是 JSON 格式。")]),s._v(" "),e("h2",{attrs:{id:"小结"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#小结"}},[s._v("#")]),s._v(" 小结")]),s._v(" "),e("p",[s._v("本文从 ELK 的基本组成入手，介绍其基本处理流程，以及从零开始搭建一个 ELK 环境，演示基于 Filebeat 收集容器日志信息的案例。当然，ELK/EFK 有很多的知识点，本文只做抛砖引玉，希望未来能够分享更多的实践总结。")]),s._v(" "),e("h2",{attrs:{id:"参考文献"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#参考文献"}},[s._v("#")]),s._v(" 参考文献")]),s._v(" "),e("ul",[e("li",[e("a",{attrs:{href:"https://www.cnblogs.com/edisonchou/p/docker_logs_study_summary_part2.html",target:"_blank",rel:"noopener noreferrer"}},[s._v("你必须知道的容器日志 (2) 开源日志管理方案 ELK/EFK"),e("OutboundLink")],1)])])])}),[],!1,null,null,null);a.default=n.exports}}]);