(window.webpackJsonp=window.webpackJsonp||[]).push([[79],{815:function(t,e,a){"use strict";a.r(e);var r=a(6),s=Object(r.a)({},(function(){var t=this,e=t.$createElement,a=t._self._c||e;return a("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[a("blockquote",[a("p",[t._v("本教程是用的是 3.12.0 版本的 "),a("a",{attrs:{href:"https://github.com/OP-TEE/optee_os/tree/3.12.0",target:"_blank",rel:"noopener noreferrer"}},[t._v("optee"),a("OutboundLink")],1),t._v("，运行环境为 QEMU 虚拟的 ARMv8 架构。")])]),t._v(" "),a("p",[a("RouterLink",{attrs:{to:"/_post/optee/03-add-ca-and-ta/"}},[t._v("前一篇文章")]),t._v(" 成功添加 CA 和 TA 之后。我们还有一些问题没解决")],1),t._v(" "),a("ul",[a("li",[t._v("整个工程是如何编译出来的")]),t._v(" "),a("li",[t._v("linux 内核在什么时候被编译")]),t._v(" "),a("li",[t._v("OP-TEE OS image 是怎么编译出来的")]),t._v(" "),a("li",[t._v("TA 和 CA 是如何编译出来")]),t._v(" "),a("li",[t._v("...")])]),t._v(" "),a("p",[t._v("找到这些问题的答案需要我们理清工程的 Makefile 和相关的 mk 文件以及其他编译相关的文件。本文将大致讲述使用 QEMU+OP-TEE 的编译过程。")]),t._v(" "),a("h2",{attrs:{id:"显式编译目标"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#显式编译目标"}},[t._v("#")]),t._v(" 显式编译目标")]),t._v(" "),a("p",[t._v("OP-TEE 编译是从 build/Makefile （当前场景下本质是 build/qemu_v8.mk 文件的一个软链接）开始的，然后按照 target 的依赖关系进行编译。完整的 target 依赖关系如下：")]),t._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v("-all\n  "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v("-arm-tf\n    "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v("-optee-os\n    "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v("-edk2\n  "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v("-buildroot   "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# common.mk")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v("-optee-os\n  "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v("-edk2\n    "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v("-edk2-common "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# common.mk")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v("-linux\n    "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v("-linux-common "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# common.mk")]),t._v("\n      "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v("-linux-defconfig\n  "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v("-optee-os\n    "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v("-optee-os-common "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# common.mk")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v("-qemu\n  "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v("-soc-term\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br"),a("span",{staticClass:"line-number"},[t._v("2")]),a("br"),a("span",{staticClass:"line-number"},[t._v("3")]),a("br"),a("span",{staticClass:"line-number"},[t._v("4")]),a("br"),a("span",{staticClass:"line-number"},[t._v("5")]),a("br"),a("span",{staticClass:"line-number"},[t._v("6")]),a("br"),a("span",{staticClass:"line-number"},[t._v("7")]),a("br"),a("span",{staticClass:"line-number"},[t._v("8")]),a("br"),a("span",{staticClass:"line-number"},[t._v("9")]),a("br"),a("span",{staticClass:"line-number"},[t._v("10")]),a("br"),a("span",{staticClass:"line-number"},[t._v("11")]),a("br"),a("span",{staticClass:"line-number"},[t._v("12")]),a("br"),a("span",{staticClass:"line-number"},[t._v("13")]),a("br"),a("span",{staticClass:"line-number"},[t._v("14")]),a("br"),a("span",{staticClass:"line-number"},[t._v("15")]),a("br")])]),a("p",[t._v("整个工程的编译始于 build/Makefile 或者对应板子的 xxx.mk 文件。本文以 qemu_v8.mk 为例，说明主要目标的作用")]),t._v(" "),a("table",[a("thead",[a("tr",[a("th",{staticStyle:{"text-align":"right"}},[t._v("目标")]),t._v(" "),a("th",{staticStyle:{"text-align":"left"}},[t._v("作用")])])]),t._v(" "),a("tbody",[a("tr",[a("td",{staticStyle:{"text-align":"right"}},[t._v("qemu")]),t._v(" "),a("td",{staticStyle:{"text-align":"left"}},[t._v("切换到 qemu 目录，获取 qemu 的配置文件，然后执行 make 命令编译 qemu")])]),t._v(" "),a("tr",[a("td",{staticStyle:{"text-align":"right"}},[t._v("soce-term")]),t._v(" "),a("td",{staticStyle:{"text-align":"left"}},[t._v("编译 soc-term 目录，生成 soc-term 二进制文件")])]),t._v(" "),a("tr",[a("td",{staticStyle:{"text-align":"right"}},[t._v("optee-os-common")]),t._v(" "),a("td",{staticStyle:{"text-align":"left"}},[t._v("编译 optee_os 目录，编译生成 tee-*_v2.bin 以及其他的 lib 库文件")])]),t._v(" "),a("tr",[a("td",{staticStyle:{"text-align":"right"}},[t._v("buildroot")]),t._v(" "),a("td",{staticStyle:{"text-align":"left"}},[t._v("创建 out-br 暂存目录，生成 buildroot 编译的配置文件，涉及编译 "),a("a",{attrs:{href:"https://github.com/OP-TEE/build/blob/3.12.0/br-ext/package/optee_examples_ext/optee_examples_ext.mk",target:"_blank",rel:"noopener noreferrer"}},[t._v("optee_examples"),a("OutboundLink")],1),t._v("、"),a("a",{attrs:{href:"https://github.com/OP-TEE/build/blob/3.12.0/br-ext/package/optee_client_ext/optee_client_ext.mk",target:"_blank",rel:"noopener noreferrer"}},[t._v("optee_client"),a("OutboundLink")],1),t._v(" 等")])])])]),t._v(" "),a("h2",{attrs:{id:"buildroot-编译过程"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#buildroot-编译过程"}},[t._v("#")]),t._v(" buildroot 编译过程")]),t._v(" "),a("blockquote",[a("p",[t._v("假设当前目录为项目根目录。")])]),t._v(" "),a("p",[t._v("大致编译过程如下")]),t._v(" "),a("ol",[a("li",[t._v("创建 out-br 目录")]),t._v(" "),a("li",[t._v("生成定义变量的额外配置文件 out-br/extra.conf")]),t._v(" "),a("li",[t._v("运行 build/br-ext/scripts/make_def_config.py 脚本，脚本执行 buildroot/Makefile 的 "),a("code",[t._v("defconfig")]),t._v(" 目标，生成 out-br/Makefile 文件")]),t._v(" "),a("li",[t._v("转到 out-br 目录执行 "),a("code",[t._v("all")]),t._v(" 目标，涉及 "),a("a",{attrs:{href:"https://github.com/OP-TEE/build/blob/3.12.0/br-ext/package/optee_examples_ext/optee_examples_ext.mk",target:"_blank",rel:"noopener noreferrer"}},[t._v("optee_examples"),a("OutboundLink")],1),t._v("、"),a("a",{attrs:{href:"https://github.com/OP-TEE/build/blob/3.12.0/br-ext/package/optee_client_ext/optee_client_ext.mk",target:"_blank",rel:"noopener noreferrer"}},[t._v("optee_client"),a("OutboundLink")],1),t._v(" 等项目的编译")])]),t._v(" "),a("h3",{attrs:{id:"optee-client-编译"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#optee-client-编译"}},[t._v("#")]),t._v(" optee-client 编译")]),t._v(" "),a("p",[t._v("该项目基于 CMake 编译，产出一系列的库文件和二进制文件如下")]),t._v(" "),a("table",[a("thead",[a("tr",[a("th",{staticStyle:{"text-align":"right"}},[t._v("文件")]),t._v(" "),a("th",{staticStyle:{"text-align":"left"}},[t._v("说明")])])]),t._v(" "),a("tbody",[a("tr",[a("td",{staticStyle:{"text-align":"right"}},[t._v("libteec.so")]),t._v(" "),a("td",{staticStyle:{"text-align":"left"}},[t._v("TODO")])]),t._v(" "),a("tr",[a("td",{staticStyle:{"text-align":"right"}},[t._v("libckteec.so")]),t._v(" "),a("td",{staticStyle:{"text-align":"left"}},[t._v("TODO")])]),t._v(" "),a("tr",[a("td",{staticStyle:{"text-align":"right"}},[t._v("optee_client")]),t._v(" "),a("td",{staticStyle:{"text-align":"left"}},[t._v("TODO")])]),t._v(" "),a("tr",[a("td",{staticStyle:{"text-align":"right"}},[t._v("tee-supplicant")]),t._v(" "),a("td",{staticStyle:{"text-align":"left"}},[t._v("编译生成一个 tee_supplicant 的可执行文件，提供 optee_os 访问文件系统，加载具体的 TA image 的功能")])])])]),t._v(" "),a("h3",{attrs:{id:"optee-examples-编译"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#optee-examples-编译"}},[t._v("#")]),t._v(" optee-examples 编译")]),t._v(" "),a("p",[t._v("相关 buildroot 编译描述文件参见 "),a("a",{attrs:{href:"https://github.com/OP-TEE/build/blob/3.12.0/br-ext/package/optee_examples_ext/optee_examples_ext.mk",target:"_blank",rel:"noopener noreferrer"}},[t._v("optee_examples_ext.mk"),a("OutboundLink")],1),t._v("，主要功能为")]),t._v(" "),a("ul",[a("li",[t._v("借助 "),a("code",[t._v("OPTEE_EXAMPLES_EXT_BUILD_TAS")]),t._v(" 宏编译 TA，用宏 "),a("code",[t._v("OPTEE_EXAMPLES_EXT_INSTALL_TAS")]),t._v(" 将产出的 TA 安装到 out-br/lib/optee_armtz 目录")]),t._v(" "),a("li",[t._v("根据 "),a("a",{attrs:{href:"https://github.com/linaro-swg/optee_examples/blob/3.12.0/CMakeLists.txt",target:"_blank",rel:"noopener noreferrer"}},[t._v("optee_examples/CMakeLists.txt"),a("OutboundLink")],1),t._v(" 的规则编译 CA，并将编译产出安装到 out-br/staging/usr/bin 目录")])]),t._v(" "),a("h3",{attrs:{id:"optee-os-拓展部分的编译"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#optee-os-拓展部分的编译"}},[t._v("#")]),t._v(" optee-os 拓展部分的编译")]),t._v(" "),a("p",[t._v("该项目基于 CMake 编译，把 optee_os 项目为指定架构编译生成的 ta（预期目录为 optee_os/out/arm/export-ta_arm64/lib/）挪到 out-br/target/lib/optee_armtz 目录，但是目前看起来没用，因为 预期目录没有 *.ta 后缀的文件。")]),t._v(" "),a("h3",{attrs:{id:"todo"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#todo"}},[t._v("#")]),t._v(" TODO")]),t._v(" "),a("ul",[a("li",[t._v("optee_benchmark")]),t._v(" "),a("li",[t._v("optee_test")])]),t._v(" "),a("h2",{attrs:{id:"参考文献"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#参考文献"}},[t._v("#")]),t._v(" 参考文献")]),t._v(" "),a("ul",[a("li",[a("a",{attrs:{href:"https://icyshuai.blog.csdn.net/article/details/71518125",target:"_blank",rel:"noopener noreferrer"}},[t._v("OP-TEE+qemu的编译--工程编译target依赖关系"),a("OutboundLink")],1)])])])}),[],!1,null,null,null);e.default=s.exports}}]);